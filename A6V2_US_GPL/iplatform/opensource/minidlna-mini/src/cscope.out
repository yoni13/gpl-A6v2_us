cscope 15 $HOME/Documents/IPlatform/platform/iplatform/develop/opensource/minidlna/src -q 0000003009 0000479318
	@albumart.c

18 
	~"c⁄fig.h
"

20 
	~<°dio.h
>

21 
	~<°dlib.h
>

22 
	~<°rög.h
>

23 
	~<uni°d.h
>

24 
	~<dúít.h
>

25 
	~<sys/∑øm.h
>

26 
	~<sys/°©.h
>

27 
	~<sys/∑øm.h
>

28 
	~<libgí.h
>

29 
	~<£tjmp.h
>

30 
	~<î∫o.h
>

32 
	~<j≥glib.h
>

34 
	~"u≤pglobÆv¨s.h
"

35 
	~"Æbum¨t.h
"

36 
	~"sql.h
"

37 
	~"utûs.h
"

38 
	~"image_utûs.h
"

39 
	~"log.h
"

42 
	$¨t_ˇche_exi°s
(c⁄° *
‹ig_∑th
, **
ˇche_fûe
)

44 if–
	`a•rötf
(
ˇche_fûe
, "%s/¨t_ˇche%s", 
db_∑th
, 
‹ig_∑th
) < 0 )

46 *
ˇche_fûe
 = 
NULL
;

49 
	`°r˝y
(
	`°rchr
(*
ˇche_fûe
, '\0')-4, ".jpg");

51  (!
	`ac˚ss
(*
ˇche_fûe
, 
F_OK
));

52 
	}
}

55 
	$ßve_ªsized_Æbum_¨t
(
image_s
 *
im§c
, c⁄° *
∑th
)

57 
d°w
, 
d°h
;

58 
image_s
 *
imd°
;

59 *
ˇche_fûe
;

60 
ˇche_dú
[
MAXPATHLEN
];

62 if–!
im§c
 )

63  
NULL
;

65 if–
	`¨t_ˇche_exi°s
(
∑th
, &
ˇche_fûe
) )

66  
ˇche_fûe
;

68 
	`°∫˝yt
(
ˇche_dú
, 
ˇche_fûe
, (cache_dir));

69 
	`make_dú
(
	`dú«me
(
ˇche_dú
), 
S_IRWXU
|
S_IRGRP
|
S_IXGRP
|
S_IROTH
|
S_IXOTH
);

71 if–
im§c
->
width
 > im§c->
height
 )

73 
d°w
 = 160;

74 
d°h
 = (
im§c
->
height
<<8Ë/ ((im§c->
width
<<8)/160);

78 
d°w
 = (
im§c
->
width
<<8Ë/ ((im§c->
height
<<8)/160);

79 
d°h
 = 160;

81 
imd°
 = 
	`image_ªsize
(
im§c
, 
d°w
, 
d°h
);

82 if–!
imd°
 )

84 
	`‰ì
(
ˇche_fûe
);

85  
NULL
;

88 
ˇche_fûe
 = 
	`image_ßve_to_j≥g_fûe
(
imd°
, cache_file);

89 
	`image_‰ì
(
imd°
);

91  
ˇche_fûe
;

92 
	}
}

96 
	$upd©e_if_Æbum_¨t
(c⁄° *
∑th
)

98 *
dú
;

99 *
m©ch
;

100 
fûe
[
MAXPATHLEN
];

101 
Â©h
[
MAXPATHLEN
];

102 
d∑th
[
MAXPATHLEN
];

103 
ncmp
 = 0;

104 
Æbum_¨t
;

105 
DIR
 *
dh
;

106 
dúít
 *
dp
;

107 
fûe_ty≥s
 
ty≥
 = 
TYPE_UNKNOWN
;

108 
öt64_t
 
¨t_id
 = 0;

109 
ªt
;

111 
	`°∫˝yt
(
Â©h
, 
∑th
, (fpath));

112 
m©ch
 = 
	`ba£«me
(
Â©h
);

114 if–
	`íds_wôh
(
m©ch
, ".cover.jpg") )

116 
ncmp
 = 
	`°æí
(
m©ch
)-10;

120 
ncmp
 = 
	`°ºchr
(
m©ch
, '.') - match;

123 
Æbum_¨t
 = 
	`is_Æbum_¨t
(
m©ch
);

125 
	`°∫˝yt
(
d∑th
, 
∑th
, (dpath));

126 
dú
 = 
	`dú«me
(
d∑th
);

127 
dh
 = 
	`›ídú
(
dú
);

128 if–!
dh
 )

130 (
dp
 = 
	`ªaddú
(
dh
)Ë!
NULL
)

132  
dp
->
d_ty≥
 )

134 
DT_REG
:

135 
ty≥
 = 
TYPE_FILE
;

137 
DT_LNK
:

138 
DT_UNKNOWN
:

139 
	`¢¥ötf
(
fûe
, (fûe), "%s/%s", 
dú
, 
dp
->
d_«me
);

140 
ty≥
 = 
	`ªsﬁve_unknown_ty≥
(
fûe
, 
ALL_MEDIA
);

143 
ty≥
 = 
TYPE_UNKNOWN
;

146 if–
ty≥
 !
TYPE_FILE
 )

148 if–(*(
dp
->
d_«me
) != '.') &&

149 (
	`is_video
(
dp
->
d_«me
Ë|| 
	`is_audio
(dp->d_name)) &&

150 (
Æbum_¨t
 || 
	`°∫cmp
(
dp
->
d_«me
, 
m©ch
, 
ncmp
) == 0) )

152 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "New fûê%†look†likêcovîáπ f‹ %s\n", 
∑th
, 
dp
->
d_«me
);

153 
	`¢¥ötf
(
fûe
, (fûe), "%s/%s", 
dú
, 
dp
->
d_«me
);

154 
¨t_id
 = 
	`föd_Æbum_¨t
(
fûe
, 
NULL
, 0);

155 
ªt
 = 
	`sql_exec
(
db
, "UPDATE DETAILS së ALBUM_ART = %Œd whîêPATH = '%q'", ()
¨t_id
, 
fûe
);

156 if–
ªt
 !
SQLITE_OK
 )

157 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "Eº‹ sëtög %†a†covîáπ f‹ %s\n", 
m©ch
, 
dp
->
d_«me
);

160 
	`˛o£dú
(
dh
);

161 
	}
}

164 
	$check_embedded_¨t
(c⁄° *
∑th
, c⁄° *
image_d©a
, 
image_size
)

166 
width
 = 0, 
height
 = 0;

167 *
¨t_∑th
 = 
NULL
;

168 *
ˇche_dú
;

169 
FILE
 *
d°fûe
;

170 
image_s
 *
im§c
;

171 
œ°_∑th
[
PATH_MAX
];

172 
œ°_hash
 = 0;

173 
œ°_suc˚ss
 = 0;

174 
hash
;

176 if–!
image_d©a
 || !
image_size
 || !
∑th
 )

178  
NULL
;

182 
hash
 = 
	`DJBHash
(
image_d©a
, 
image_size
);

183 if–
hash
 =
œ°_hash
 )

185 if–!
œ°_suc˚ss
 )

186  
NULL
;

187 
	`¨t_ˇche_exi°s
(
∑th
, &
¨t_∑th
);

188 if–
	`lök
(
œ°_∑th
, 
¨t_∑th
) == 0 )

190 (
¨t_∑th
);

194 if–
î∫o
 =
ENOENT
 )

196 
ˇche_dú
 = 
	`°rdup
(
¨t_∑th
);

197 
	`make_dú
(
	`dú«me
(
ˇche_dú
), 
S_IRWXU
|
S_IRGRP
|
S_IXGRP
|
S_IROTH
|
S_IXOTH
);

198 
	`‰ì
(
ˇche_dú
);

199 if–
	`lök
(
œ°_∑th
, 
¨t_∑th
) == 0 )

200 (
¨t_∑th
);

202 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "Lökög %†tÿ%†Áûed [%s]\n", 
¨t_∑th
, 
œ°_∑th
, 
	`°ªº‹
(
î∫o
));

203 
	`‰ì
(
¨t_∑th
);

204 
¨t_∑th
 = 
NULL
;

207 
œ°_hash
 = 
hash
;

209 
im§c
 = 
	`image_√w_‰om_j≥g
(
NULL
, 0, 
image_d©a
, 
image_size
, 1, 
ROTATE_NONE
);

210 if–!
im§c
 )

212 
œ°_suc˚ss
 = 0;

213  
NULL
;

215 
width
 = 
im§c
->width;

216 
height
 = 
im§c
->height;

218 if–
width
 > 160 || 
height
 > 160 )

220 
¨t_∑th
 = 
	`ßve_ªsized_Æbum_¨t
(
im§c
, 
∑th
);

222 if–
width
 > 0 && 
height
 > 0 )

224 
size_t
 
nwrôãn
;

225 if–
	`¨t_ˇche_exi°s
(
∑th
, &
¨t_∑th
) )

226 
íd_¨t
;

227 
ˇche_dú
 = 
	`°rdup
(
¨t_∑th
);

228 
	`make_dú
(
	`dú«me
(
ˇche_dú
), 
S_IRWXU
|
S_IRGRP
|
S_IXGRP
|
S_IROTH
|
S_IXOTH
);

229 
	`‰ì
(
ˇche_dú
);

230 
d°fûe
 = 
	`f›í
(
¨t_∑th
, "w");

231 if–!
d°fûe
 )

233 
	`‰ì
(
¨t_∑th
);

234 
¨t_∑th
 = 
NULL
;

235 
íd_¨t
;

237 
nwrôãn
 = 
	`fwrôe
((*)
image_d©a
, 1, 
image_size
, 
d°fûe
);

238 
	`f˛o£
(
d°fûe
);

239 if–
nwrôãn
 !
image_size
 )

241 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "EmbeddedáπÉº‹: wrŸê%d/%d byãs\n", 
nwrôãn
, 
image_size
);

242 
	`ªmove
(
¨t_∑th
);

243 
	`‰ì
(
¨t_∑th
);

244 
¨t_∑th
 = 
NULL
;

245 
íd_¨t
;

248 
íd_¨t
:

249 
	`image_‰ì
(
im§c
);

250 if–!
¨t_∑th
 )

252 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "InvÆidÉmbeddedálbumáπ i¿%s\n", 
	`ba£«me
((*)
∑th
));

253 
œ°_suc˚ss
 = 0;

254  
NULL
;

256 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "FoundÇewÉmbeddedálbumáπ i¿%s\n", 
	`ba£«me
((*)
∑th
));

257 
œ°_suc˚ss
 = 1;

258 
	`°r˝y
(
œ°_∑th
, 
¨t_∑th
);

260 (
¨t_∑th
);

261 
	}
}

264 
	$check_f‹_Æbum_fûe
(c⁄° *
∑th
)

266 
fûe
[
MAXPATHLEN
];

267 
my∑th
[
MAXPATHLEN
];

268 
Æbum_¨t_«me_s
 *
Æbum_¨t_«me
;

269 
image_s
 *
im§c
 = 
NULL
;

270 
width
=0, 
height
=0;

271 *
¨t_fûe
;

272 c⁄° *
dú
;

273 
°©
 
°
;

274 
ªt
;

276 if–
	`°©
(
∑th
, &
°
) != 0 )

277  
NULL
;

279 if–
	`S_ISDIR
(
°
.
°_mode
) )

281 
dú
 = 
∑th
;

282 
check_dú
;

284 
	`°∫˝yt
(
my∑th
, 
∑th
, (mypath));

285 
dú
 = 
	`dú«me
(
my∑th
);

288 
	`¢¥ötf
(
fûe
, (fûe), "%s.covî.jpg", 
∑th
);

289 
ªt
 = 
	`ac˚ss
(
fûe
, 
R_OK
);

290 if–
ªt
 != 0 )

292 
	`°∫˝yt
(
fûe
, 
∑th
, (file));

293 
¨t_fûe
 = 
	`°ºchr
(
fûe
, '.');

294 if–
¨t_fûe
 )

296 
	`°r˝y
(
¨t_fûe
, ".jpg");

297 
ªt
 = 
	`ac˚ss
(
fûe
, 
R_OK
);

299 if–
ªt
 != 0 )

301 
¨t_fûe
 = 
	`°ºchr
(
fûe
, '/');

302 if–
¨t_fûe
 )

304 
	`memmove
(
¨t_fûe
+2,áπ_fûe+1, 
fûe
+
MAXPATHLEN
-art_file-2);

305 
¨t_fûe
[1] = '.';

306 
ªt
 = 
	`ac˚ss
(
fûe
, 
R_OK
);

310 if–
ªt
 == 0 )

312 if–
	`¨t_ˇche_exi°s
(
fûe
, &
¨t_fûe
) )

313 
exi°ög_fûe
;

314 
	`‰ì
(
¨t_fûe
);

315 
im§c
 = 
	`image_√w_‰om_j≥g
(
fûe
, 1, 
NULL
, 0, 1, 
ROTATE_NONE
);

316 if–
im§c
 )

317 
found_fûe
;

319 
check_dú
:

321  
Æbum_¨t_«me
 = 
Æbum_¨t_«mes
;álbum_¨t_«me;álbum_¨t_«mêÆbum_¨t_«me->
√xt
 )

323 
	`¢¥ötf
(
fûe
, (fûe), "%s/%s", 
dú
, 
Æbum_¨t_«me
->
«me
);

324 if–
	`ac˚ss
(
fûe
, 
R_OK
) == 0 )

326 if–
	`¨t_ˇche_exi°s
(
fûe
, &
¨t_fûe
) )

328 
exi°ög_fûe
:

329  
¨t_fûe
;

331 
	`‰ì
(
¨t_fûe
);

332 
im§c
 = 
	`image_√w_‰om_j≥g
(
fûe
, 1, 
NULL
, 0, 1, 
ROTATE_NONE
);

333 if–!
im§c
 )

335 
found_fûe
:

336 
width
 = 
im§c
->width;

337 
height
 = 
im§c
->height;

338 if–
width
 > 160 || 
height
 > 160 )

339 
¨t_fûe
 = 
	`ßve_ªsized_Æbum_¨t
(
im§c
, 
fûe
);

341 
¨t_fûe
 = 
	`°rdup
(
fûe
);

342 
	`image_‰ì
(
im§c
);

343 (
¨t_fûe
);

346  
NULL
;

347 
	}
}

349 
öt64_t


350 
	$föd_Æbum_¨t
(c⁄° *
∑th
, c⁄° *
image_d©a
, 
image_size
)

352 *
Æbum_¨t
 = 
NULL
;

353 *
sql
;

354 **
ªsu…
;

355 
cﬁs
, 
rows
;

356 
öt64_t
 
ªt
 = 0;

358 if–(
image_size
 && (
Æbum_¨t
 = 
	`check_embedded_¨t
(
∑th
, 
image_d©a
, image_size))) ||

359 (
Æbum_¨t
 = 
	`check_f‹_Æbum_fûe
(
∑th
)) )

361 
sql
 = 
	`sqlôe3_m¥ötf
("SELECT ID from ALBUM_ART whîêPATH = '%q'", 
Æbum_¨t
 ?álbum_¨à: 
∑th
);

362 if–(
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
rows
, &
cﬁs
Ë=
SQLITE_OK
) &&Ñows )

364 
ªt
 = 
	`°πﬁl
(
ªsu…
[1], 
NULL
, 10);

368 if–
	`sql_exec
(
db
, "INSERT i¡ÿALBUM_ART (PATHËVALUES ('%q')", 
Æbum_¨t
Ë=
SQLITE_OK
 )

369 
ªt
 = 
	`sqlôe3_œ°_ö£π_rowid
(
db
);

371 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

372 
	`sqlôe3_‰ì
(
sql
);

374 
	`‰ì
(
Æbum_¨t
);

376  
ªt
;

377 
	}
}

	@albumart.h

24 #i‚de‡
__ALBUMART_H__


25 
	#__ALBUMART_H__


	)

28 
upd©e_if_Æbum_¨t
(c⁄° *
∑th
);

30 
öt64_t


31 
föd_Æbum_¨t
(c⁄° *
∑th
, c⁄° *
image_d©a
, 
image_size
);

	@clients.c

18 
	~<°dio.h
>

19 
	~<°rög.h
>

20 
	~<time.h
>

22 
	~"˛õ¡s.h
"

23 
	~"gëiÁddr.h
"

24 
	~"log.h
"

26 
˛õ¡_ty≥_s
 
	g˛õ¡_ty≥s
[] =

31 
NULL
,

32 
EM©chN⁄e


35 { 
EXbox
,

36 
FLAG_MIME_AVI_AVI
 | 
FLAG_MS_PFS
,

39 
EU£rAgít


42 { 
EPS3
,

43 
FLAG_DLNA
 | 
FLAG_MIME_AVI_DIVX
,

46 
EU£rAgít


49 { 
EPS3
,

50 
FLAG_DLNA
 | 
FLAG_MIME_AVI_DIVX
,

53 
EXAVClõ¡Info


56 { 
ESamsungSîõsCDE
,

57 
FLAG_SAMSUNG
 | 
FLAG_DLNA
 | 
FLAG_NO_RESIZE
 | 
FLAG_SAMSUNG_TV
,

60 
EU£rAgít


63 { 
ESamsungSîõsA
,

64 
FLAG_SAMSUNG
 | 
FLAG_DLNA
 | 
FLAG_NO_RESIZE
,

67 
EU£rAgít


70 { 
ESamsungSîõsB
,

71 
FLAG_SAMSUNG
 | 
FLAG_DLNA
 | 
FLAG_NO_RESIZE
,

74 
EModñName


78 { 
EP™as⁄ic
,

79 
FLAG_DLNA
 | 
FLAG_FORCE_SORT
,

82 
EU£rAgít


85 { 
EDí⁄Re˚ivî
,

86 
FLAG_DLNA
,

89 
EU£rAgít


92 { 
EFªeBox
,

93 
FLAG_RESIZE_THUMBS
,

96 
EU£rAgít


99 { 
EP›c‹nHour
,

100 
FLAG_MIME_FLAC_FLAC
,

103 
EU£rAgít


110 { 
ES⁄yBDP
,

111 
FLAG_DLNA
,

114 
EXAVClõ¡Info


118 { 
ELGDevi˚
,

119 
FLAG_DLNA
,

122 
EU£rAgít


126 { 
ES⁄yBøvü
,

127 
FLAG_DLNA
,

130 
EXAVClõ¡Info


134 { 
ES⁄yI¡î√tTV
,

135 
FLAG_DLNA
,

138 
EXAVClõ¡Info


141 { 
ENëgórEVA2000
,

142 
FLAG_MS_PFS
 | 
FLAG_RESIZE_THUMBS
,

145 
EU£rAgít


148 { 
EDúecTV
,

149 
FLAG_RESIZE_THUMBS
,

152 
EU£rAgít


155 { 
EToshibaTV
,

156 
FLAG_DLNA
,

159 
EU£rAgít


162 { 
ERokuSoundBridge
,

163 
FLAG_MS_PFS
 | 
FLAG_AUDIO_ONLY
 | 
FLAG_MIME_WAV_WAV
 | 
FLAG_FORCE_SORT
,

166 
EModñName


169 { 
EM¨™tzDMP
,

170 
FLAG_DLNA
 | 
FLAG_MIME_WAV_WAV
,

173 
EFrõndlyNameSSDP


176 { 
EMedüRoom
,

177 
FLAG_MS_PFS
,

180 
EU£rAgít


183 { 
ELi„Tab
,

184 
FLAG_MS_PFS
,

187 
EFrõndlyName


190 { 
ESènd¨dDLNA150
,

191 
FLAG_DLNA
 | 
FLAG_MIME_AVI_AVI
,

194 
EU£rAgít


197 { 
ESènd¨dUPnP
,

201 
EU£rAgít


204 { 0, 0, 
NULL
, 0 }

207 
˛õ¡_ˇche_s
 
	g˛õ¡s
[
CLIENT_CACHE_SLOTS
];

210 
	$SórchClõ¡Cache
(
ö_addr
 
addr
, 
quõt
)

212 
i
;

214 
i
 = 0; i < 
CLIENT_CACHE_SLOTS
; i++)

216 i‡(
˛õ¡s
[
i
].
addr
.
s_addr
 ==áddr.s_addr)

219 i‡((
	`time
(
NULL
Ë- 
˛õ¡s
[
i
].
age
) > 3600)

221 
mac
[6];

222 i‡(
	`gë_ªmŸe_mac
(
addr
, 
mac
) == 0 &&

223 
	`memcmp
(
mac
, 
˛õ¡s
[
i
].mac, 6) == 0)

227 
˛õ¡s
[
i
].
age
 = 
	`time
(
NULL
);

231 
	`mem£t
(&
˛õ¡s
[
i
], 0, (
˛õ¡_ˇche_s
));

235 i‡(!
quõt
)

236 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Client found in cache. [%s/entry %d]\n",

237 
˛õ¡_ty≥s
[
˛õ¡s
[
i
].
ty≥
].
«me
, i);

238  
i
;

243 
	}
}

246 
	$AddClõ¡Cache
(
ö_addr
 
addr
, 
ty≥
)

248 
i
;

250 
i
 = 0; i < 
CLIENT_CACHE_SLOTS
; i++)

252 i‡(
˛õ¡s
[
i
].
addr
.
s_addr
)

254 
	`gë_ªmŸe_mac
(
addr
, 
˛õ¡s
[
i
].
mac
);

255 
˛õ¡s
[
i
].
addr
 =áddr;

256 
˛õ¡s
[
i
].
ty≥
 =Åype;

257 
˛õ¡s
[
i
].
age
 = 
	`time
(
NULL
);

258 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Added client [%s/%s/%02X:%02X:%02X:%02X:%02X:%02X]Åo cache slot %d.\n",

259 
˛õ¡_ty≥s
[
ty≥
].
«me
, 
	`öë_¡ﬂ
(
˛õ¡s
[
i
].
addr
),

260 
˛õ¡s
[
i
].
mac
[0], clients[i].mac[1], clients[i].mac[2],

261 
˛õ¡s
[
i
].
mac
[3], clients[i].mac[4], clients[i].mac[5], i);

266 
	}
}

	@clients.h

18 #i‚de‡
__CLIENTS_H__


19 
	#__CLIENTS_H__


	)

20 
	~<°döt.h
>

21 
	~<sys/time.h
>

22 
	~<√töë/ö.h
>

24 
	#CLIENT_CACHE_SLOTS
 25

	)

26 
	#FLAG_DLNA
 0x00000001

	)

27 
	#FLAG_MIME_AVI_DIVX
 0x00000002

	)

28 
	#FLAG_MIME_AVI_AVI
 0x00000004

	)

29 
	#FLAG_MIME_FLAC_FLAC
 0x00000008

	)

30 
	#FLAG_MIME_WAV_WAV
 0x00000010

	)

31 
	#FLAG_RESIZE_THUMBS
 0x00000020

	)

32 
	#FLAG_NO_RESIZE
 0x00000040

	)

33 
	#FLAG_MS_PFS
 0x00000080

34 
	#FLAG_SAMSUNG
 0x00000100

	)

35 
	#FLAG_SAMSUNG_TV
 0x00000200

	)

36 
	#FLAG_AUDIO_ONLY
 0x00000400

	)

37 
	#FLAG_FORCE_SORT
 0x00000800

	)

39 
	em©ch_ty≥s
 {

40 
	mEM©chN⁄e
,

41 
	mEU£rAgít
,

42 
	mEXAVClõ¡Info
,

43 
	mEFrõndlyName
,

44 
	mEModñName
,

45 
	mEFrõndlyNameSSDP


48 
	e˛õ¡_ty≥s
 {

49 
	mEXbox
 = 1,

50 
	mEPS3
,

51 
	mEDí⁄Re˚ivî
,

52 
	mEDúecTV
,

53 
	mEFªeBox
,

54 
	mELGDevi˚
,

55 
	mELi„Tab
,

56 
	mEM¨™tzDMP
,

57 
	mEMedüRoom
,

58 
	mENëgórEVA2000
,

59 
	mEP™as⁄ic
,

60 
	mEP›c‹nHour
,

61 
	mERokuSoundBridge
,

62 
	mESamsungSîõsA
,

63 
	mESamsungSîõsB
,

64 
	mESamsungSîõsCDE
,

65 
	mES⁄yBDP
,

66 
	mES⁄yBøvü
,

67 
	mES⁄yI¡î√tTV
,

68 
	mEToshibaTV
,

69 
	mESènd¨dDLNA150
,

70 
	mESènd¨dUPnP


73 
	s˛õ¡_ty≥_s
 {

74 
˛õ¡_ty≥s
 
	mty≥
;

75 
uöt32_t
 
	mÊags
;

76 c⁄° *
	m«me
;

77 c⁄° *
	mm©ch
;

78 
m©ch_ty≥s
 
	mm©ch_ty≥
;

81 
	s˛õ¡_ˇche_s
 {

82 
ö_addr
 
	maddr
;

83 
	mmac
[6];

84 
˛õ¡_ty≥s
 
	mty≥
;

85 
time_t
 
	mage
;

88 
˛õ¡_ty≥_s
 
˛õ¡_ty≥s
[];

89 
˛õ¡_ˇche_s
 
˛õ¡s
[
CLIENT_CACHE_SLOTS
];

91 
SórchClõ¡Cache
(
ö_addr
 
addr
, 
quõt
);

92 
AddClõ¡Cache
(
ö_addr
 
addr
, 
ty≥
);

	@codelength.h

6 #i‚de‡
__CODELENGTH_H__


7 
	#__CODELENGTH_H__


	)

12 
	#DECODELENGTH
(
n
, 
p
)Ç = 0; \

13 dÿ{ 
n
 = (¿<< 7Ë| (*
p
 & 0x7f); } \

14 *(
p
++)&0x80);

	)

16 
	#CODELENGTH
(
n
, 
p
) if(n>=268435456) *(p++) = (n >> 28) | 0x80; \

17 if(
n
>=2097152Ë*(
p
++) = (n >> 21) | 0x80; \

18 if(
n
>=16384Ë*(
p
++) = (n >> 14) | 0x80; \

19 if(
n
>=128Ë*(
p
++) = (n >> 7) | 0x80; \

20 *(
p
++Ë
n
 & 0x7f;

	)

	@getifaddr.c

29 
	~<°dio.h
>

30 
	~<°dlib.h
>

31 
	~<°rög.h
>

32 
	~<uni°d.h
>

33 
	~<sys/io˘l.h
>

34 
	~<sys/ty≥s.h
>

35 
	~<sys/sockë.h
>

36 
	~<√t/if.h
>

37 
	~<¨∑/öë.h
>

38 
	~<√töë/ö.h
>

39 
	~<√tdb.h
>

40 
	~<î∫o.h
>

41 #i‡
deföed
(
sun
)

42 
	~<sys/sockio.h
>

45 
	~"c⁄fig.h
"

46 #i‡
HAVE_GETIFADDRS


47 
	~<iÁddrs.h
>

48 #ifde‡
__löux__


49 #i‚de‡
AF_LINK


50 
	#AF_LINK
 
AF_INET


	)

53 
	~<√t/if_dl.h
>

55 #i‚de‡
IFF_SLAVE


56 
	#IFF_SLAVE
 0

	)

59 #ifde‡
HAVE_NETLINK


60 
	~<löux/π√éök.h
>

61 
	~<löux/√éök.h
>

63 
	~"u≤pglobÆv¨s.h
"

64 
	~"gëiÁddr.h
"

65 
	~"möissdp.h
"

66 
	~"möid a.h
"

67 
	~"log.h
"

70 
	$gëiÁddr
(c⁄° *
i‚ame
)

72 #i‡
HAVE_GETIFADDRS


73 
iÁddrs
 *
iÁp
, *
p
;

74 
sockaddr_ö
 *
addr_ö
;

76 i‡(
	`gëiÁddrs
(&
iÁp
) != 0)

78 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "gëiÁddrs(): %s\n", 
	`°ªº‹
(
î∫o
));

82 
p
 = 
iÁp
;Ö !
NULL
;Ö =Ö->
iÁ_√xt
)

84 i‡(!
p
->
iÁ_addr
 ||Ö->iÁ_addr->
ß_Ámûy
 !
AF_INET
)

86 i‡(
i‚ame
 && 
	`°rcmp
(
p
->
iÁ_«me
, ifname) != 0)

88 
addr_ö
 = (
sockaddr_ö
 *)
p
->
iÁ_addr
;

89 i‡(!
i‚ame
 && (
p
->
iÁ_Êags
 & (
IFF_LOOPBACK
 | 
IFF_SLAVE
)))

91 
	`mem˝y
(&
œn_addr
[
n_œn_addr
].
addr
, &
addr_ö
->
sö_addr
, (lan_addr[n_lan_addr].addr));

92 i‡(!
	`öë_¡›
(
AF_INET
, &
addr_ö
->
sö_addr
, 
œn_addr
[
n_œn_addr
].
°r
, (lan_addr[0].str)) )

94 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "öë_¡›(): %s\n", 
	`°ªº‹
(
î∫o
));

97 
addr_ö
 = (
sockaddr_ö
 *)
p
->
iÁ_√tmask
;

98 
	`mem˝y
(&
œn_addr
[
n_œn_addr
].
mask
, &
addr_ö
->
sö_addr
, (lan_addr[n_lan_addr].mask));

99 
œn_addr
[
n_œn_addr
].
ifödex
 = 
	`if_«mëoödex
(
p
->
iÁ_«me
);

100 
œn_addr
[
n_œn_addr
].
¢Ÿify
 = 
	`O≥nAndC⁄fSSDPNŸifySockë
(&lan_addr[n_lan_addr]);

101 i‡(
œn_addr
[
n_œn_addr
].
¢Ÿify
 >= 0)

102 
n_œn_addr
++;

103 i‡(
i‚ame
 || 
n_œn_addr
 >
MAX_LAN_ADDR
)

106 
	`‰ìiÁddrs
(
iÁp
);

107 i‡(
i‚ame
 && !
p
)

109 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Nëw‹k i¡îÁ˚ %†nŸ found\n", 
i‚ame
);

113 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

114 
sockaddr_ö
 
addr
;

115 
ifc⁄f
 
ifc
;

116 
i‰eq
 *
i‰
;

117 
buf
[8192];

118 
i
, 
n
;

120 
	`mem£t
(&
ifc
, '\0', (ifc));

121 
ifc
.
ifc_buf
 = 
buf
;

122 
ifc
.
ifc_Àn
 = (
buf
);

124 i‡(
	`io˘l
(
s
, 
SIOCGIFCONF
, &
ifc
) < 0)

126 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "SIOCGIFCONF: %s\n", 
	`°ªº‹
(
î∫o
));

127 
	`˛o£
(
s
);

131 
n
 = 
ifc
.
ifc_Àn
 / (
i‰eq
);

132 
i
 = 0; i < 
n
; i++)

134 
i‰
 = &
ifc
.
ifc_ªq
[
i
];

135 i‡(
i‚ame
 && 
	`°rcmp
(
i‰
->
i‰_«me
, ifname) != 0)

137 i‡(!
i‚ame
 &&

138 (
	`io˘l
(
s
, 
SIOCGIFFLAGS
, 
i‰
Ë< 0 || i‰->
i‰_i‰u
.
i‰u_Êags
 & 
IFF_LOOPBACK
))

140 i‡(
	`io˘l
(
s
, 
SIOCGIFADDR
, 
i‰
) < 0)

142 
	`mem˝y
(&
addr
, &(
i‰
->
i‰_addr
), (addr));

143 
	`mem˝y
(&
œn_addr
[
n_œn_addr
].
addr
, &addr.
sö_addr
, (lan_addr[n_lan_addr].addr));

144 i‡(!
	`öë_¡›
(
AF_INET
, &
addr
.
sö_addr
, 
œn_addr
[
n_œn_addr
].
°r
, (lan_addr[0].str)))

146 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "öë_¡›(): %s\n", 
	`°ªº‹
(
î∫o
));

147 
	`˛o£
(
s
);

150 i‡(
	`io˘l
(
s
, 
SIOCGIFNETMASK
, 
i‰
) < 0)

152 
	`mem˝y
(&
addr
, &(
i‰
->
i‰_addr
), (addr));

153 
	`mem˝y
(&
œn_addr
[
n_œn_addr
].
mask
, &
addr
.
sö_addr
, (addr));

154 
œn_addr
[
n_œn_addr
].
ifödex
 = 
	`if_«mëoödex
(
i‰
->
i‰_«me
);

155 
œn_addr
[
n_œn_addr
].
¢Ÿify
 = 
	`O≥nAndC⁄fSSDPNŸifySockë
(&lan_addr[n_lan_addr]);

156 i‡(
œn_addr
[
n_œn_addr
].
¢Ÿify
 >= 0)

157 
n_œn_addr
++;

158 i‡(
i‚ame
 || 
n_œn_addr
 >
MAX_LAN_ADDR
)

161 
	`˛o£
(
s
);

162 i‡(
i‚ame
 && 
i
 =
n
)

164 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Nëw‹k i¡îÁ˚ %†nŸ found\n", 
i‚ame
);

168  
n_œn_addr
;

169 
	}
}

172 
	$gësyshwaddr
(*
buf
, 
Àn
)

174 
mac
[6];

175 
ªt
 = -1;

176 #i‡
	`deföed
(
HAVE_GETIFADDRS
Ë&& !deföed (
__löux__
)

177 
iÁddrs
 *
iÁp
, *
p
;

178 
sockaddr_ö
 *
addr_ö
;

179 
uöt8_t
 
a
;

181 i‡(
	`gëiÁddrs
(&
iÁp
) != 0)

183 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "gëiÁddrs(): %s\n", 
	`°ªº‹
(
î∫o
));

186 
p
 = 
iÁp
;Ö !
NULL
;Ö =Ö->
iÁ_√xt
)

188 i‡(
p
->
iÁ_addr
 &&Ö->iÁ_addr->
ß_Ámûy
 =
AF_LINK
)

190 
addr_ö
 = (
sockaddr_ö
 *)
p
->
iÁ_addr
;

191 
a
 = (
	`ht⁄l
(
addr_ö
->
sö_addr
.
s_addr
) >> 0x18) & 0xFF;

192 i‡(
a
 == 127)

194 #ifde‡
__löux__


195 
i‰eq
 
i‰
;

196 
fd
;

197 
fd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0);

198 i‡(
fd
 < 0)

200 
	`°∫˝y
(
i‰
.
i‰_«me
, 
p
->
iÁ_«me
, 
IFNAMSIZ
);

201 
ªt
 = 
	`io˘l
(
fd
, 
SIOCGIFHWADDR
, &
i‰
);

202 
	`˛o£
(
fd
);

203 i‡(
ªt
 < 0)

205 
	`mem˝y
(
mac
, 
i‰
.
i‰_hwaddr
.
ß_d©a
, 6);

207 
sockaddr_dl
 *
sdl
;

208 
sdl
 = (
sockaddr_dl
*)
p
->
iÁ_addr
;

209 
	`mem˝y
(
mac
, 
	`LLADDR
(
sdl
), sdl->
sdl_Æí
);

211 i‡(
	`MACADDR_IS_ZERO
(
mac
))

213 
ªt
 = 0;

217 
	`‰ìiÁddrs
(
iÁp
);

219 
if_«meödex
 *
iÁ˚s
, *
if_idx
;

220 
i‰eq
 
i‰
;

221 
fd
;

223 
	`mem£t
(&
mac
, '\0', (mac));

225 
fd
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 0);

226 i‡(
fd
 < 0)

227  
ªt
;

229 
iÁ˚s
 = 
	`if_«meödex
();

230 i‡(!
iÁ˚s
)

231  
ªt
;

233 
if_idx
 = 
iÁ˚s
; if_idx->
if_ödex
; if_idx++)

235 
	`°∫˝y
(
i‰
.
i‰_«me
, 
if_idx
->
if_«me
, 
IFNAMSIZ
);

236 i‡(
	`io˘l
(
fd
, 
SIOCGIFFLAGS
, &
i‰
) < 0)

238 i‡(
i‰
.
i‰_i‰u
.
i‰u_Êags
 & 
IFF_LOOPBACK
)

240 i‡(
	`io˘l
(
fd
, 
SIOCGIFHWADDR
, &
i‰
) < 0)

242 i‡(
	`MACADDR_IS_ZERO
(
i‰
.
i‰_hwaddr
.
ß_d©a
))

244 
	`mem˝y
(
mac
, 
i‰
.
i‰_hwaddr
.
ß_d©a
, 6);

245 
ªt
 = 0;

248 
	`if_‰ì«meödex
(
iÁ˚s
);

249 
	`˛o£
(
fd
);

251 i‡(
ªt
 == 0)

253 i‡(
Àn
 > 12)

254 
	`•rötf
(
buf
, "%02x%02x%02x%02x%02x%02x",

255 
mac
[0]&0xFF, mac[1]&0xFF, mac[2]&0xFF,

256 
mac
[3]&0xFF, mac[4]&0xFF, mac[5]&0xFF);

257 i‡(
Àn
 == 6)

258 
	`memmove
(
buf
, 
mac
, 6);

260  
ªt
;

261 
	}
}

264 
	$gë_ªmŸe_mac
(
ö_addr
 
ù_addr
, *
mac
)

266 
ö_addr
 
¨p_ít
;

267 
FILE
 * 
¨p
;

268 
ªmŸe_ù
[16];

269 
m©ches
, 
hwty≥
, 
Êags
;

270 
	`mem£t
(
mac
, 0xFF, 6);

272 
¨p
 = 
	`f›í
("/proc/net/arp", "r");

273 i‡(!
¨p
)

275 !
	`„of
(
¨p
))

277 
m©ches
 = 
	`fsˇnf
(
¨p
, "%15s 0x%8X 0x%8X %2hhx:%2hhx:%2hhx:%2hhx:%2hhx:%2hhx",

278 
ªmŸe_ù
, &
hwty≥
, &
Êags
,

279 &
mac
[0], &mac[1], &mac[2], &mac[3], &mac[4], &mac[5]);

280 i‡(
m©ches
 != 9)

282 
	`öë_±⁄
(
AF_INET
, 
ªmŸe_ù
, &
¨p_ít
);

283 i‡(
ù_addr
.
s_addr
 =
¨p_ít
.s_addr)

285 
mac
[0] = 0xFF;

287 
	`f˛o£
(
¨p
);

289 i‡(
mac
[0] == 0xFF)

291 
	`mem£t
(
mac
, 0xFF, 6);

296 
	}
}

299 
	$ªlﬂd_iÁ˚s
(
f‹˚_nŸify
)

301 
ö_addr
 
ﬁd_addr
[
MAX_LAN_ADDR
];

302 
i
, 
j
;

304 
	`mem£t
(&
ﬁd_addr
, 0xFF, (old_addr));

305 
i
 = 0; i < 
n_œn_addr
; i++)

307 
	`mem˝y
(&
ﬁd_addr
[
i
], &
œn_addr
[i].
addr
, (
ö_addr
));

308 
	`˛o£
(
œn_addr
[
i
].
¢Ÿify
);

310 
n_œn_addr
 = 0;

312 
i
 = 0;

314 
	`gëiÁddr
(
ru¡ime_v¨s
.
iÁ˚s
[
i
]);

315 
i
++;

316 } 
ru¡ime_v¨s
.
iÁ˚s
[
i
]);

318 
i
 = 0; i < 
n_œn_addr
; i++)

320 
j
 = 0; j < 
MAX_LAN_ADDR
; j++)

322 i‡(
	`memcmp
(&
œn_addr
[
i
].
addr
, &
ﬁd_addr
[
j
], (
ö_addr
)) == 0)

326 i‡(
f‹˚_nŸify
 || 
j
 =
MAX_LAN_ADDR
)

328 
	`DPRINTF
(
E_INFO
, 
L_GENERAL
, "Enabling interface %s/%s\n",

329 
œn_addr
[
i
].
°r
, 
	`öë_¡ﬂ
÷™_addr[i].
mask
));

330 
	`SídSSDPGoodbyes
(
œn_addr
[
i
].
¢Ÿify
);

331 
	`SídSSDPNŸifõs
(
œn_addr
[
i
].
¢Ÿify
,Ü™_addr[i].
°r
,

332 
ru¡ime_v¨s
.
p‹t
,Ñu¡ime_v¨s.
nŸify_öãrvÆ
);

335 
	}
}

338 
	$O≥nAndC⁄fM⁄ô‹Sockë
()

340 #ifde‡
HAVE_NETLINK


341 
sockaddr_∆
 
addr
;

342 
s
;

343 
ªt
;

345 
s
 = 
	`sockë
(
PF_NETLINK
, 
SOCK_RAW
, 
NETLINK_ROUTE
);

346 i‡(
s
 < 0)

348 
	`≥º‹
("couldn't open NETLINK_ROUTE socket");

352 
	`mem£t
(&
addr
, 0, (addr));

353 
addr
.
∆_Ámûy
 = 
AF_NETLINK
;

354 
addr
.
∆_groups
 = 
RTMGRP_IPV4_IFADDR
;

356 
ªt
 = 
	`böd
(
s
, (
sockaddr
*)&
addr
, (addr));

357 i‡(
ªt
 < 0)

359 
	`≥º‹
("couldn't bind");

363  
s
;

367 
	}
}

370 
	$Pro˚ssM⁄ô‹Evít
(*
s
)

372 #ifde‡
HAVE_NETLINK


373 
sock
 = *
s
;

374 
Àn
;

375 
buf
[4096];

376 
∆msghdr
 *
∆h
;

377 
ch™ged
 = 0;

379 
∆h
 = (
∆msghdr
*)
buf
;

381 
Àn
 = 
	`ªcv
(
sock
, 
∆h
, (
buf
), 0);

382 i‡(
Àn
 <= 0)

384 (
	`NLMSG_OK
(
∆h
, 
Àn
)Ë&& (∆h->
∆msg_ty≥
 !
NLMSG_DONE
))

386 i‡(
∆h
->
∆msg_ty≥
 =
RTM_NEWADDR
 ||

387 
∆h
->
∆msg_ty≥
 =
RTM_DELADDR
)

389 
ch™ged
 = 1;

391 
∆h
 = 
	`NLMSG_NEXT
“lh, 
Àn
);

393 i‡(
ch™ged
)

394 
	`ªlﬂd_iÁ˚s
(0);

396 
	}
}

398 
	$m⁄ô‹_öô
()

400 
evít_°ru˘
 *
evt
;

401 
sm⁄ô‹
;

402 
ªt
 = 0;

404 
sm⁄ô‹
 = 
	`O≥nAndC⁄fM⁄ô‹Sockë
();

405 i‡(
sm⁄ô‹
 != -1)

407 
evt
 = 
	`evít_mÆloc
(
sm⁄ô‹
);

408 i‡(!
evt
)

410 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo mallocÉvent_struct. EXITING\n");

412 
evt
->
ªad
.
d©a
 = &evt->
sock
;

413 
evt
->
ªad
.
h™dÀr
 = (
EVENT_HANDLER
)
Pro˚ssM⁄ô‹Evít
;

414 
ªt
 = 
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLIN
);

415 i‡(
ªt
 != 0)

417 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅoÉvent_ctl smonitor. EXITING\n");

421  
ªt
;

422 
	}
}

	@getifaddr.h

29 #i‚de‡
__GETIFADDR_H__


30 
	#__GETIFADDR_H__


	)

31 
	~<¨∑/öë.h
>

33 
	#MACADDR_IS_ZERO
(
x
) \

34 ((
x
[0] == 0x00) && \

35 (
x
[1] == 0x00) && \

36 (
x
[2] == 0x00) && \

37 (
x
[3] == 0x00) && \

38 (
x
[4] == 0x00) && \

39 (
x
[5] =0x00))

	)

41 
gësyshwaddr
(*
buf
, 
Àn
);

42 
gë_ªmŸe_mac
(
ö_addr
 
ù_addr
, *
mac
);

43 
ªlﬂd_iÁ˚s
(
nŸify
);

45 
O≥nAndC⁄fM⁄ô‹Sockë
();

46 
Pro˚ssM⁄ô‹Evít
(*
s
);

47 
m⁄ô‹_öô
();

	@icons.c

20 
	#TPLINK


	)

22 #i‡
deföed
(
TPLINK
)

24 
	g≤g_sm
[] =

143 
	g≤g_Ãg
[] =

370 
	gj≥g_sm
[] =

460 
	gj≥g_Ãg
[] =

637 #ifde‡
NETGEAR


640 
	g≤g_sm
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x30\x00\x00\x00\x30"

757 
	g≤g_Ãg
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x78\x00\x00\x00\x78"

974 
	gj≥g_sm
[] = "\xff\xd8\xff\xe1\x00\x18\x45\x78\x69\x66\x00\x00\x49\x49\x2a\x00\x08\x00\x00\x00\x00\x00\x00\x00"

1181 
	gj≥g_Ãg
[] = "\xff\xd8\xff\xe1\x00\x18\x45\x78\x69\x66\x00\x00\x49\x49\x2a\x00\x08\x00\x00\x00\x00\x00\x00\x00"

1720 #ñi‡
__FªeBSD__


1723 
	g≤g_sm
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x29\x00\x00\x00\x30"

1883 
	g≤g_Ãg
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x66\x00\x00\x00\x78"

2551 
	gj≥g_sm
[] = "\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01\x01\x01\x00\x48\x00\x48\x00\x00\xff\xdb\x00\x43"

2603 
	gj≥g_Ãg
[] = "\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01\x01\x01\x00\x48\x00\x48\x00\x00\xff\xdb\x00\x43"

2746 
	g≤g_sm
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x29\x00\x00\x00\x30"

2848 
	g≤g_Ãg
[] = "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d\x49\x48\x44\x52\x00\x00\x00\x66\x00\x00\x00\x78"

3207 
	gj≥g_sm
[] = "\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01\x01\x01\x00\x5a\x00\x5a\x00\x00\xff\xdb\x00\x43"

3292 
	gj≥g_Ãg
[] = "\xff\xd8\xff\xe0\x00\x10\x4a\x46\x49\x46\x00\x01\x01\x01\x00\x5a\x00\x5a\x00\x00\xff\xdb\x00\x43"

	@image_utils.c

29 
	~"c⁄fig.h
"

30 
	~<°dio.h
>

31 
	~<°dlib.h
>

32 
	~<°rög.h
>

33 
	~<uni°d.h
>

34 
	~<£tjmp.h
>

35 
	~<j≥glib.h
>

36 #ifde‡
HAVE_MACHINE_ENDIAN_H


37 
	~<machöe/ídün.h
>

39 
	~<ídün.h
>

42 
	~"u≤¥ïly∑r£.h
"

43 
	~"image_utûs.h
"

44 
	~"log.h
"

46 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


47 
	#SWAP16
(
w
Ë–(((wË>> 8Ë& 0x00ffË| (((wË<< 8Ë& 0xff00Ë)

	)

49 
	#SWAP16
(
w
Ë(w)

	)

52 
	#JPEG_QUALITY
 96

	)

54 
	#COL
(
ªd
, 
gªí
, 
blue
Ë((‘edË<< 24Ë| ((gªíË<< 16Ë| ((blueË<< 8Ë| 0xFF)

	)

55 
	#COL_FULL
(
ªd
, 
gªí
, 
blue
, 
Æpha
Ë((‘edË<< 24Ë| ((gªíË<< 16Ë| ((blueË<< 8Ë| (Æpha))

	)

56 
	#COL_RED
(
cﬁ
Ë(cﬁ >> 24)

	)

57 
	#COL_GREEN
(
cﬁ
Ë((cﬁ >> 16Ë& 0xFF)

	)

58 
	#COL_BLUE
(
cﬁ
Ë((cﬁ >> 8Ë& 0xFF)

	)

59 
	#COL_ALPHA
(
cﬁ
Ë(cﬁ & 0xFF)

	)

60 
	#BLACK
 0x000000FF

	)

63 
	smy_d°_mgr
 {

64 
j≥g_de°ö©i⁄_mgr
 
	mjd°
;

65 
JOCTET
 *
	mbuf
;

66 
JOCTET
 *
	moff
;

67 
size_t
 
	msz
;

68 
size_t
 
	mu£d
;

73 
	$my_d°_mgr_öô
(
j_com¥ess_±r
 
cöfo
)

75 
my_d°_mgr
 *
d°
 = (*)
cöfo
->
de°
;

77 
d°
->
u£d
 = 0;

78 
d°
->
sz
 = 
cöfo
->
image_width


79 * 
cöfo
->
image_height


80 * 
cöfo
->
öput_comp⁄íts
;

81 
d°
->
buf
 = 
	`mÆloc
(d°->
sz
 *  *dst->buf);

82 
d°
->
off
 = d°->
buf
;

83 
d°
->
jd°
.
√xt_ouçut_byã
 = d°->
off
;

84 
d°
->
jd°
.
‰ì_ö_buf„r
 = d°->
sz
;

88 
	}
}

90 
boﬁón


91 
	$my_d°_mgr_em±y
(
j_com¥ess_±r
 
cöfo
)

93 
my_d°_mgr
 *
d°
 = (*)
cöfo
->
de°
;

95 
d°
->
sz
 *= 2;

96 
d°
->
u£d
 = d°->
off
 - d°->
buf
;

97 
d°
->
buf
 = 
	`ªÆloc
(d°->buf, d°->
sz
 *  *dst->buf);

98 
d°
->
off
 = d°->
buf
 + d°->
u£d
;

99 
d°
->
jd°
.
√xt_ouçut_byã
 = d°->
off
;

100 
d°
->
jd°
.
‰ì_ö_buf„r
 = d°->
sz
 - d°->
u£d
;

102  
TRUE
;

104 
	}
}

107 
	$my_d°_mgr_ãrm
(
j_com¥ess_±r
 
cöfo
)

109 
my_d°_mgr
 *
d°
 = (*)
cöfo
->
de°
;

111 
d°
->
u£d
 +d°->
sz
 - d°->
jd°
.
‰ì_ö_buf„r
;

112 
d°
->
off
 = d°->
buf
 + d°->
u£d
;

116 
	}
}

119 
	$j≥g_mem‹y_de°
(
j_com¥ess_±r
 
cöfo
, 
my_d°_mgr
 *
d°
)

121 
d°
->
jd°
.
öô_de°ö©i⁄
 = 
my_d°_mgr_öô
;

122 
d°
->
jd°
.
em±y_ouçut_buf„r
 = 
my_d°_mgr_em±y
;

123 
d°
->
jd°
.
ãrm_de°ö©i⁄
 = 
my_d°_mgr_ãrm
;

124 
cöfo
->
de°
 = (*)
d°
;

128 
	}
}

132 
	smy_§c_mgr


134 
j≥g_sour˚_mgr
 
	mpub
;

135 
JOCTET
 
	meoi_buf„r
[2];

139 
	$öô_sour˚
(
j_decom¥ess_±r
 
cöfo
)

142 
	}
}

145 
	$fûl_öput_buf„r
(
j_decom¥ess_±r
 
cöfo
)

147 
my_§c_mgr
 *
§c
 = (*)
cöfo
->src;

150 
§c
->
eoi_buf„r
[0] = (
JOCTET
) 0xFF;

151 
§c
->
eoi_buf„r
[1] = (
JOCTET
Ë
JPEG_EOI
;

152 
§c
->
pub
.
√xt_öput_byã
 = src->
eoi_buf„r
;

153 
§c
->
pub
.
byãs_ö_buf„r
 = 2;

155  
TRUE
;

156 
	}
}

159 
	$skù_öput_d©a
(
j_decom¥ess_±r
 
cöfo
, 
num_byãs
)

161 
my_§c_mgr
 *
§c
 = (*)
cöfo
->src;

162 i‡(
num_byãs
 > 0)

164 
num_byãs
 > ()
§c
->
pub
.
byãs_ö_buf„r
)

166 
num_byãs
 -()
§c
->
pub
.
byãs_ö_buf„r
;

167 
	`fûl_öput_buf„r
(
cöfo
);

170 
§c
->
pub
.
√xt_öput_byã
 +
num_byãs
;

171 
§c
->
pub
.
byãs_ö_buf„r
 -
num_byãs
;

172 
	}
}

175 
	$ãrm_sour˚
(
j_decom¥ess_±r
 
cöfo
)

178 
	}
}

181 
	$j≥g_mem‹y_§c
(
j_decom¥ess_±r
 
cöfo
, c⁄° * 
buf„r
, 
size_t
 
bufsize
)

183 
my_§c_mgr
 *
§c
;

185 i‡(! 
cöfo
->
§c
)

187 
cöfo
->
§c
 = (*cöfo->
mem
->
Æloc_smÆl
)((*)cöfo, 
JPOOL_PERMANENT
, (
my_§c_mgr
));;

189 
§c
 = (*)
cöfo
->src;

190 
§c
->
pub
.
öô_sour˚
 = init_source;

191 
§c
->
pub
.
fûl_öput_buf„r
 = fill_input_buffer;

192 
§c
->
pub
.
skù_öput_d©a
 = skip_input_data;

193 
§c
->
pub
.
ªsync_to_ª°¨t
 = 
j≥g_ªsync_to_ª°¨t
;

194 
§c
->
pub
.
ãrm_sour˚
 =Åerm_source;

195 
§c
->
pub
.
√xt_öput_byã
 = 
buf„r
;

196 
§c
->
pub
.
byãs_ö_buf„r
 = 
bufsize
;

197 
	}
}

199 
jmp_buf
 
	g£tjmp_buf„r
;

202 
	$libj≥g_îr‹_h™dÀr
(
j_comm⁄_±r
 
cöfo
)

204 
cöfo
->
îr
->
	`ouçut_mesßge
(cinfo);

205 
	`l⁄gjmp
(
£tjmp_buf„r
, 1);

207 
	}
}

210 
	$image_‰ì
(
image_s
 *
pimage
)

212 
	`‰ì
(
pimage
->
buf
);

213 
	`‰ì
(
pimage
);

214 
	}
}

216 
pix


217 
	$gë_pix
(
image_s
 *
pimage
, 
öt32_t
 
x
, i¡32_à
y
)

219 if((
x
 >0Ë&& (
y
 >0Ë&& (x < 
pimage
->
width
Ë&& (y <Öimage->
height
))

221 (
pimage
->
buf
[(
y
 *Öimage->
width
Ë+ 
x
]);

225 
pix
 
vpix
 = 
BLACK
;

226 (
vpix
);

228 
	}
}

231 
	$put_pix_Æpha_ª∂a˚
(
image_s
 *
pimage
, 
öt32_t
 
x
, i¡32_à
y
, 
pix
 
cﬁ
)

233 if((
x
 >0Ë&& (
y
 >0Ë&& (x < 
pimage
->
width
Ë&& (y <Öimage->
height
))

234 
pimage
->
buf
[(
y
 *Öimage->
width
Ë+ 
x
] = 
cﬁ
;

235 
	}
}

238 
	$image_gë_j≥g_ªsﬁuti⁄
(c⁄° * 
∑th
, * 
width
, * 
height
)

240 
FILE
 *
img
;

241 
buf
[8];

242 
uöt16_t
 
off£t
, 
h
, 
w
;

243 
ªt
 = 1;

244 
size_t
 
ƒód
;

245 
size
;

248 
img
 = 
	`f›í
(
∑th
, "r");

249 if–!
img
 )

252 
	`f£ek
(
img
, 0, 
SEEK_END
);

253 
size
 = 
	`·ñl
(
img
);

254 
	`ªwöd
(
img
);

256 
ƒód
 = 
	`‰ód
(&
buf
, 2, 1, 
img
);

257 if–(
ƒód
 < 1Ë|| (
buf
[0] != 0xFF) || (buf[1] != 0xD8) )

259 
	`f˛o£
(
img
);

262 
	`mem£t
(&
buf
, 0, (buf));

264  
	`·ñl
(
img
Ë< 
size
 )

266  
ƒód
 > 0 && 
buf
[0] !0xFF && !
	`„of
(
img
) )

267 
ƒód
 = 
	`‰ód
(&
buf
, 1, 1, 
img
);

269  
ƒód
 > 0 && 
buf
[0] =0xFF && !
	`„of
(
img
) )

270 
ƒód
 = 
	`‰ód
(&
buf
, 1, 1, 
img
);

272 if–(
buf
[0] >= 0xc0) && (buf[0] <= 0xc3) )

274 
ƒód
 = 
	`‰ód
(&
buf
, 7, 1, 
img
);

275 *
width
 = 0;

276 *
height
 = 0;

277 if–
ƒód
 < 1 )

279 
	`mem˝y
(&
h
, 
buf
+3, 2);

280 *
height
 = 
	`SWAP16
(
h
);

281 
	`mem˝y
(&
w
, 
buf
+5, 2);

282 *
width
 = 
	`SWAP16
(
w
);

283 
ªt
 = 0;

288 
off£t
 = 0;

289 
ƒód
 = 
	`‰ód
(&
buf
, 2, 1, 
img
);

290 if–
ƒód
 < 1 )

292 
	`mem˝y
(&
off£t
, 
buf
, 2);

293 
off£t
 = 
	`SWAP16
(offset) - 2;

294 if–
	`f£ek
(
img
, 
off£t
, 
SEEK_CUR
) == -1 )

298 
	`f˛o£
(
img
);

299  
ªt
;

300 
	}
}

303 
	$image_gë_j≥g_d©e_xmp
(c⁄° * 
∑th
, ** 
d©e
)

305 
FILE
 *
img
;

306 
buf
[8];

307 *
d©a
 = 
NULL
, *
√wd©a
;

308 
uöt16_t
 
off£t
;

309 
NameVÆueP¨£rD©a
 
xml
;

310 * 
exif
;

311 
ªt
 = 1;

312 
size_t
 
ƒód
;

314 
img
 = 
	`f›í
(
∑th
, "r");

315 if–!
img
 )

318 
ƒód
 = 
	`‰ód
(&
buf
, 2, 1, 
img
);

319 if–(
ƒód
 < 1Ë|| (
buf
[0] != 0xFF) || (buf[1] != 0xD8) )

321 
	`f˛o£
(
img
);

324 
	`mem£t
(&
buf
, 0, (buf));

326  !
	`„of
(
img
) )

328  
ƒód
 > 0 && 
buf
[0] !0xFF && !
	`„of
(
img
) )

329 
ƒód
 = 
	`‰ód
(&
buf
, 1, 1, 
img
);

331  
ƒód
 > 0 && 
buf
[0] =0xFF && !
	`„of
(
img
) )

332 
ƒód
 = 
	`‰ód
(&
buf
, 1, 1, 
img
);

334 if–
	`„of
(
img
) )

337 if–
buf
[0] == 0xE1 )

339 
off£t
 = 0;

340 
ƒód
 = 
	`‰ód
(&
buf
, 2, 1, 
img
);

341 if–
ƒód
 < 1 )

343 
	`mem˝y
(&
off£t
, 
buf
, 2);

344 
off£t
 = 
	`SWAP16
(offset) - 2;

346 if–
off£t
 < 30 )

348 
	`f£ek
(
img
, 
off£t
, 
SEEK_CUR
);

352 
√wd©a
 = 
	`ªÆloc
(
d©a
, 30);

353 if–!
√wd©a
 )

355 
d©a
 = 
√wd©a
;

357 
ƒód
 = 
	`‰ód
(
d©a
, 29, 1, 
img
);

358 if–
ƒód
 < 1 )

360 
off£t
 -= 29;

361 if–
	`°rcmp
(
d©a
, "http://ns.adobe.com/xap/1.0/") != 0 )

363 
	`f£ek
(
img
, 
off£t
, 
SEEK_CUR
);

367 
√wd©a
 = 
	`ªÆloc
(
d©a
, 
off£t
+1);

368 if–!
√wd©a
 )

370 
d©a
 = 
√wd©a
;

371 
ƒód
 = 
	`‰ód
(
d©a
, 
off£t
, 1, 
img
);

372 if–
ƒód
 < 1 )

375 
	`P¨£NameVÆue
(
d©a
, 
off£t
, &
xml
, 0);

376 
exif
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "DateTimeOriginal");

377 if–!
exif
 )

379 
	`CÀ¨NameVÆueLi°
(&
xml
);

382 *
d©e
 = 
	`ªÆloc
(*d©e, 
	`°æí
(
exif
)+1);

383 
	`°r˝y
(*
d©e
, 
exif
);

384 
	`CÀ¨NameVÆueLi°
(&
xml
);

386 
ªt
 = 0;

391 
off£t
 = 0;

392 
ƒód
 = 
	`‰ód
(&
buf
, 2, 1, 
img
);

393 if–
ƒód
 < 1 )

395 
	`mem˝y
(&
off£t
, 
buf
, 2);

396 
off£t
 = 
	`SWAP16
(offset) - 2;

397 
	`f£ek
(
img
, 
off£t
, 
SEEK_CUR
);

400 
	`f˛o£
(
img
);

401 
	`‰ì
(
d©a
);

402  
ªt
;

403 
	}
}

405 
image_s
 *

406 
	$image_√w
(
öt32_t
 
width
, i¡32_à
height
)

408 
image_s
 *
vimage
;

410 if((
vimage
 = (
image_s
 *)
	`mÆloc
((image_s))Ë=
NULL
)

412 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "malloc failed\n");

413  
NULL
;

415 
vimage
->
width
 = width; vimage->
height
 = height;

417 if((
vimage
->
buf
 = (
pix
 *)
	`mÆloc
(
width
 * 
height
 * ’ix))Ë=
NULL
)

419 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "malloc failed\n");

420 
	`‰ì
(
vimage
);

421  
NULL
;

423 (
vimage
);

424 
	}
}

426 
image_s
 *

427 
	$image_√w_‰om_j≥g
(c⁄° * 
∑th
, 
is_fûe
, c⁄° * 
buf
, 
size
, 
sˇÀ
, 
rŸ©e
)

429 
image_s
 *
vimage
;

430 
FILE
 *
fûe
 = 
NULL
;

431 
j≥g_decom¥ess_°ru˘
 
cöfo
;

432 *
löe
[16], *
±r
;

433 
x
, 
y
, 
i
, 
w
, 
h
, 
ofs
;

434 
maxbuf
;

435 
j≥g_îr‹_mgr
 
pub
;

437 
cöfo
.
îr
 = 
	`j≥g_°d_îr‹
(&
pub
);

438 
pub
.
îr‹_exô
 = 
libj≥g_îr‹_h™dÀr
;

439 
	`j≥g_¸óã_decom¥ess
(&
cöfo
);

440 if–
is_fûe
 )

442 if–(
fûe
 = 
	`f›í
(
∑th
, "r")Ë=
NULL
 )

444  
NULL
;

446 
	`j≥g_°dio_§c
(&
cöfo
, 
fûe
);

450 
	`j≥g_mem‹y_§c
(&
cöfo
, (c⁄° *)
buf
, 
size
);

452 if–
	`£tjmp
(
£tjmp_buf„r
) )

454 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

455 if–
is_fûe
 && 
fûe
 )

456 
	`f˛o£
(
fûe
);

457  
NULL
;

459 
	`j≥g_ªad_hódî
(&
cöfo
, 
TRUE
);

460 
cöfo
.
sˇÀ_díom
 = 
sˇÀ
;

461 
cöfo
.
do_Áncy_upßm∂ög
 = 
FALSE
;

462 
cöfo
.
do_block_smoŸhög
 = 
FALSE
;

463 
	`j≥g_°¨t_decom¥ess
(&
cöfo
);

464 
w
 = 
cöfo
.
ouçut_width
;

465 
h
 = 
cöfo
.
ouçut_height
;

466 
vimage
 = (
rŸ©e
 & (
ROTATE_90
|
ROTATE_270
)Ë? 
	`image_√w
(
h
, 
w
) : image_new(w, h);

467 if(!
vimage
)

469 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

470 if–
is_fûe
 )

471 
	`f˛o£
(
fûe
);

472  
NULL
;

475 if–
	`£tjmp
(
£tjmp_buf„r
) )

477 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

478 if–
is_fûe
 && 
fûe
 )

479 
	`f˛o£
(
fûe
);

480 if–
vimage
 )

482 
	`‰ì
(
vimage
->
buf
);

483 
	`‰ì
(
vimage
);

485  
NULL
;

488 if(
cöfo
.
ªc_outbuf_height
 > 16)

490 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "ERROR image_from_jpeg : (image_from_jpeg.c) JPEG usesÜine buffers > 16. CannotÜoad.\n");

491 
	`image_‰ì
(
vimage
);

492 if–
is_fûe
 )

493 
	`f˛o£
(
fûe
);

494  
NULL
;

496 
maxbuf
 = 
vimage
->
width
 * vimage->
height
;

497 if(
cöfo
.
ouçut_comp⁄íts
 == 3)

499 
rx
, 
ry
;

500 
ofs
 = 0;

501 if((
±r
 = 
	`mÆloc
(
w
 * 3 * 
cöfo
.
ªc_outbuf_height
 + 16)Ë=
NULL
)

503 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "malloc failed\n");

504 
	`image_‰ì
(
vimage
);

505 if–
is_fûe
 )

506 
	`f˛o£
(
fûe
);

507  
NULL
;

510 
y
 = 0; y < 
h
; y +
cöfo
.
ªc_outbuf_height
)

512 
ry
 = (
rŸ©e
 & (
ROTATE_90
|
ROTATE_180
)Ë? (
y
 - 
h
 + 1) * -1 : y;

513 
i
 = 0; i < 
cöfo
.
ªc_outbuf_height
; i++)

515 
löe
[
i
] = 
±r
 + (
w
 * 3 * i);

517 
	`j≥g_ªad_sˇ∆öes
(&
cöfo
, 
löe
, cöfo.
ªc_outbuf_height
);

518 
x
 = 0; x < 
w
 * 
cöfo
.
ªc_outbuf_height
; x++)

520 
rx
 = (
rŸ©e
 & (
ROTATE_180
|
ROTATE_270
)Ë? (
x
 - 
w
 + 1) * -1 : x;

521 
ofs
 = (
rŸ©e
 & (
ROTATE_90
|
ROTATE_270
)Ë? 
ry
 + (
rx
 * 
h
Ë:Ñx + (ry * 
w
);

522 if–
ofs
 >0 && of†< 
maxbuf
 )

524 
vimage
->
buf
[
ofs
] = 
	`COL
(
±r
[
x
 + x + x],Ötr[x + x + x + 1],Ötr[x + x + x + 2]);

528 
	`‰ì
(
±r
);

530 if(
cöfo
.
ouçut_comp⁄íts
 == 1)

532 
ofs
 = 0;

533 
i
 = 0; i < 
cöfo
.
ªc_outbuf_height
; i++)

535 if((
löe
[
i
] = 
	`mÆloc
(
w
)Ë=
NULL
)

537 
t
 = 0;

539 
t
 = 0;Å < 
i
;Å++Ë
	`‰ì
(
löe
[t]);

540 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

541 
	`image_‰ì
(
vimage
);

542 if–
is_fûe
 )

543 
	`f˛o£
(
fûe
);

544  
NULL
;

547 
y
 = 0; y < 
h
; y +
cöfo
.
ªc_outbuf_height
)

549 
	`j≥g_ªad_sˇ∆öes
(&
cöfo
, 
löe
, cöfo.
ªc_outbuf_height
);

550 
i
 = 0; i < 
cöfo
.
ªc_outbuf_height
; i++)

552 
x
 = 0; x < 
w
; x++)

554 
vimage
->
buf
[
ofs
++] = 
	`COL
(
löe
[
i
][
x
],Üine[i][x],Üine[i][x]);

558 
i
 = 0; i < 
cöfo
.
ªc_outbuf_height
; i++)

560 
	`‰ì
(
löe
[
i
]);

563 
	`j≥g_föish_decom¥ess
(&
cöfo
);

564 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

565 if–
is_fûe
 )

566 
	`f˛o£
(
fûe
);

568  
vimage
;

569 
	}
}

572 
	$image_upsize
(
image_s
 * 
pde°
, image_†* 
p§c
, 
öt32_t
 
width
, i¡32_à
height
)

574 
öt32_t
 
vx
, 
vy
;

575 #i‡!
deföed
 
__i386__
 && !deföed 
__x86_64__


576 
öt32_t
 
rx
, 
ry
;

577 
pix
 
vcﬁ
;

579 if((
pde°
 =
NULL
Ë|| (
p§c
 == NULL))

582 
vy
 = 0; vy < 
height
; vy++)

584 
vx
 = 0; vx < 
width
; vx++)

586 
rx
 = ((
vx
 * 
p§c
->
width
) / width);

587 
ry
 = ((
vy
 * 
p§c
->
height
) / height);

588 
vcﬁ
 = 
	`gë_pix
(
p§c
, 
rx
, 
ry
);

590 
pix
 
vcﬁ
,
vcﬁ1
,
vcﬁ2
,
vcﬁ3
,
vcﬁ4
;

591 
rx
,
ry
;

592 
width_sˇÀ
, 
height_sˇÀ
;

593 
x_di°
, 
y_di°
;

595 
width_sˇÀ
 = ()
p§c
->
width
 / ()width;

596 
height_sˇÀ
 = ()
p§c
->
height
 / ()height;

598 
vy
 = 0;vy < 
height
; vy++)

600 
vx
 = 0;vx < 
width
; vx++)

602 
rx
 = 
vx
 * 
width_sˇÀ
;

603 
ry
 = 
vy
 * 
height_sˇÀ
;

604 
vcﬁ1
 = 
	`gë_pix
(
p§c
, (
öt32_t
)
rx
, (öt32_t)
ry
);

605 
vcﬁ2
 = 
	`gë_pix
(
p§c
, ((
öt32_t
)
rx
)+1, (öt32_t)
ry
);

606 
vcﬁ3
 = 
	`gë_pix
(
p§c
, (
öt32_t
)
rx
, ((öt32_t)
ry
)+1);

607 
vcﬁ4
 = 
	`gë_pix
(
p§c
, ((
öt32_t
)
rx
)+1, ((öt32_t)
ry
)+1);

609 
x_di°
 = 
rx
 - (()((
öt32_t
)rx));

610 
y_di°
 = 
ry
 - (()((
öt32_t
)ry));

611 
vcﬁ
 = 
	`COL_FULL
–(
uöt8_t
)((
	`COL_RED
(
vcﬁ1
)*(1.0-
x_di°
)

612 + 
	`COL_RED
(
vcﬁ2
)*(
x_di°
))*(1.0-
y_di°
)

613 + (
	`COL_RED
(
vcﬁ3
)*(1.0-
x_di°
)

614 + 
	`COL_RED
(
vcﬁ4
)*(
x_di°
))*(
y_di°
)),

615 (
uöt8_t
)((
	`COL_GREEN
(
vcﬁ1
)*(1.0-
x_di°
)

616 + 
	`COL_GREEN
(
vcﬁ2
)*(
x_di°
))*(1.0-
y_di°
)

617 + (
	`COL_GREEN
(
vcﬁ3
)*(1.0-
x_di°
)

618 + 
	`COL_GREEN
(
vcﬁ4
)*(
x_di°
))*(
y_di°
)),

619 (
uöt8_t
)((
	`COL_BLUE
(
vcﬁ1
)*(1.0-
x_di°
)

620 + 
	`COL_BLUE
(
vcﬁ2
)*(
x_di°
))*(1.0-
y_di°
)

621 + (
	`COL_BLUE
(
vcﬁ3
)*(1.0-
x_di°
)

622 + 
	`COL_BLUE
(
vcﬁ4
)*(
x_di°
))*(
y_di°
)),

623 (
uöt8_t
)((
	`COL_ALPHA
(
vcﬁ1
)*(1.0-
x_di°
)

624 + 
	`COL_ALPHA
(
vcﬁ2
)*(
x_di°
))*(1.0-
y_di°
)

625 + (
	`COL_ALPHA
(
vcﬁ3
)*(1.0-
x_di°
)

626 + 
	`COL_ALPHA
(
vcﬁ4
)*(
x_di°
))*(
y_di°
))

629 
	`put_pix_Æpha_ª∂a˚
(
pde°
, 
vx
, 
vy
, 
vcﬁ
);

632 
	}
}

635 
	$image_downsize
(
image_s
 * 
pde°
, image_†* 
p§c
, 
öt32_t
 
width
, i¡32_à
height
)

637 
öt32_t
 
vx
, 
vy
;

638 
pix
 
vcﬁ
;

639 
öt32_t
 
i
, 
j
;

640 #i‡!
deföed
 
__i386__
 && !deföed 
__x86_64__


641 
öt32_t
 
rx
, 
ry
, 
rx_√xt
, 
ry_√xt
;

642 
ªd
, 
gªí
, 
blue
, 
Æpha
;

643 
Á˘‹
;

645 if((
pde°
 =
NULL
Ë|| (
p§c
 == NULL))

648 
vy
 = 0; vy < 
height
; vy++)

650 
vx
 = 0; vx < 
width
; vx++)

653 
rx
 = ((
vx
 * 
p§c
->
width
) / width);

654 
ry
 = ((
vy
 * 
p§c
->
height
) / height);

656 
ªd
 = 
gªí
 = 
blue
 = 
Æpha
 = 0;

658 
rx_√xt
 = 
rx
 + (
p§c
->
width
 / width);

659 
ry_√xt
 = 
ry
 + (
p§c
->
width
 / width);

660 
Á˘‹
 = 0;

662  
j
 = 
rx
; j < 
rx_√xt
; j++)

664  
i
 = 
ry
; i < 
ry_√xt
; i++)

666 
Á˘‹
 += 1;

667 
vcﬁ
 = 
	`gë_pix
(
p§c
, 
j
, 
i
);

669 
ªd
 +
	`COL_RED
(
vcﬁ
);

670 
gªí
 +
	`COL_GREEN
(
vcﬁ
);

671 
blue
 +
	`COL_BLUE
(
vcﬁ
);

672 
Æpha
 +
	`COL_ALPHA
(
vcﬁ
);

676 
ªd
 /
Á˘‹
;

677 
gªí
 /
Á˘‹
;

678 
blue
 /
Á˘‹
;

679 
Æpha
 /
Á˘‹
;

682 
ªd
 = (red > 255) ? 255 : ((red < 0) ? 0 :Ñed );

683 
gªí
 = (green > 255) ? 255 : ((green < 0) ? 0 : green);

684 
blue
 = (blue > 255) ? 255 : ((blue < 0) ? 0 : blue );

685 
Æpha
 = (alpha > 255) ? 255 : ((alpha < 0) ? 0 :álpha);

687 
rx
,
ry
;

688 
width_sˇÀ
, 
height_sˇÀ
;

689 
ªd
, 
gªí
, 
blue
, 
Æpha
;

690 
öt32_t
 
hÆf_squ¨e_width
, 
hÆf_squ¨e_height
;

691 
round_width
, 
round_height
;

693 if–(
pde°
 =
NULL
Ë|| (
p§c
 == NULL) )

696 
width_sˇÀ
 = ()
p§c
->
width
 / ()width;

697 
height_sˇÀ
 = ()
p§c
->
height
 / ()height;

699 
hÆf_squ¨e_width
 = (
öt32_t
)(
width_sˇÀ
 / 2.0);

700 
hÆf_squ¨e_height
 = (
öt32_t
)(
height_sˇÀ
 / 2.0);

701 
round_width
 = (
width_sˇÀ
 / 2.0Ë- ()
hÆf_squ¨e_width
;

702 
round_height
 = (
height_sˇÀ
 / 2.0Ë- ()
hÆf_squ¨e_height
;

703 if(
round_width
 > 0.0)

704 
hÆf_squ¨e_width
++;

706 
round_width
 = 1.0;

707 if(
round_height
 > 0.0)

708 
hÆf_squ¨e_height
++;

710 
round_height
 = 1.0;

712 
vy
 = 0;vy < 
height
; vy++)

714 
vx
 = 0;vx < 
width
; vx++)

716 
rx
 = 
vx
 * 
width_sˇÀ
;

717 
ry
 = 
vy
 * 
height_sˇÀ
;

718 
vcﬁ
 = 
	`gë_pix
(
p§c
, (
öt32_t
)
rx
, (öt32_t)
ry
);

720 
ªd
 = 
gªí
 = 
blue
 = 
Æpha
 = 0.0;

722 
j
=0;j<
hÆf_squ¨e_height
<<1;j++)

724 
i
=0;i<
hÆf_squ¨e_width
<<1;i++)

726 
vcﬁ
 = 
	`gë_pix
(
p§c
, ((
öt32_t
)
rx
)-
hÆf_squ¨e_width
+
i
,

727 ((
öt32_t
)
ry
)-
hÆf_squ¨e_height
+
j
);

729 if(((
j
 =0Ë|| (j =(
hÆf_squ¨e_height
<<1)-1)) &&

730 ((
i
 =0Ë|| (ò=(
hÆf_squ¨e_width
<<1)-1)))

732 
ªd
 +
round_width
*
round_height
*()
	`COL_RED
 (
vcﬁ
);

733 
gªí
 +
round_width
*
round_height
*()
	`COL_GREEN
(
vcﬁ
);

734 
blue
 +
round_width
*
round_height
*()
	`COL_BLUE
 (
vcﬁ
);

735 
Æpha
 +
round_width
*
round_height
*()
	`COL_ALPHA
(
vcﬁ
);

737 if((
j
 =0Ë|| (j =(
hÆf_squ¨e_height
<<1)-1))

739 
ªd
 +
round_height
*()
	`COL_RED
 (
vcﬁ
);

740 
gªí
 +
round_height
*()
	`COL_GREEN
(
vcﬁ
);

741 
blue
 +
round_height
*()
	`COL_BLUE
 (
vcﬁ
);

742 
Æpha
 +
round_height
*()
	`COL_ALPHA
(
vcﬁ
);

744 if((
i
 =0Ë|| (ò=(
hÆf_squ¨e_width
<<1)-1))

746 
ªd
 +
round_width
*()
	`COL_RED
 (
vcﬁ
);

747 
gªí
 +
round_width
*()
	`COL_GREEN
(
vcﬁ
);

748 
blue
 +
round_width
*()
	`COL_BLUE
 (
vcﬁ
);

749 
Æpha
 +
round_width
*()
	`COL_ALPHA
(
vcﬁ
);

753 
ªd
 +()
	`COL_RED
 (
vcﬁ
);

754 
gªí
 +()
	`COL_GREEN
(
vcﬁ
);

755 
blue
 +()
	`COL_BLUE
 (
vcﬁ
);

756 
Æpha
 +()
	`COL_ALPHA
(
vcﬁ
);

761 
ªd
 /
width_sˇÀ
*
height_sˇÀ
;

762 
gªí
 /
width_sˇÀ
*
height_sˇÀ
;

763 
blue
 /
width_sˇÀ
*
height_sˇÀ
;

764 
Æpha
 /
width_sˇÀ
*
height_sˇÀ
;

767 
ªd
 = (red > 255.0)? 255.0 : ((red < 0.0)? 0.0:red );

768 
gªí
 = (green > 255.0)? 255.0 : ((green < 0.0)? 0.0:green);

769 
blue
 = (blue > 255.0)? 255.0 : ((blue < 0.0)? 0.0:blue );

770 
Æpha
 = (alpha > 255.0)? 255.0 : ((alpha < 0.0)? 0.0:alpha);

772 
	`put_pix_Æpha_ª∂a˚
(
pde°
, 
vx
, 
vy
,

773 
	`COL_FULL
((
uöt8_t
)
ªd
, (uöt8_t)
gªí
, (uöt8_t)
blue
, (uöt8_t)
Æpha
));

776 
	}
}

778 
image_s
 *

779 
	$image_ªsize
(
image_s
 * 
§c_image
, 
öt32_t
 
width
, i¡32_à
height
)

781 
image_s
 * 
d°_image
;

783 
d°_image
 = 
	`image_√w
(
width
, 
height
);

784 if–!
d°_image
 )

785  
NULL
;

786 if–(
§c_image
->
width
 < widthË|| (§c_image->
height
 < height) )

787 
	`image_upsize
(
d°_image
, 
§c_image
, 
width
, 
height
);

789 
	`image_downsize
(
d°_image
, 
§c_image
, 
width
, 
height
);

791  
d°_image
;

792 
	}
}

797 
	$image_ßve_to_j≥g_buf
(
image_s
 * 
pimage
, * 
size
)

799 
j≥g_com¥ess_°ru˘
 
cöfo
;

800 
j≥g_îr‹_mgr
 
jîr
;

801 
JSAMPROW
 
row_poöãr
[1];

802 
row_°ride
;

803 *
d©a
;

804 
i
, 
x
;

805 
my_d°_mgr
 
d°
;

807 
cöfo
.
îr
 = 
	`j≥g_°d_îr‹
(&
jîr
);

808 
	`j≥g_¸óã_com¥ess
(&
cöfo
);

809 
	`j≥g_mem‹y_de°
(&
cöfo
, &
d°
);

810 
cöfo
.
image_width
 = 
pimage
->
width
;

811 
cöfo
.
image_height
 = 
pimage
->
height
;

812 
cöfo
.
öput_comp⁄íts
 = 3;

813 
cöfo
.
ö_cﬁ‹_•a˚
 = 
JCS_RGB
;

814 
	`j≥g_£t_deÁu…s
(&
cöfo
);

815 
	`j≥g_£t_quÆôy
(&
cöfo
, 
JPEG_QUALITY
, 
TRUE
);

816 
	`j≥g_°¨t_com¥ess
(&
cöfo
, 
TRUE
);

817 
row_°ride
 = 
cöfo
.
image_width
 * 3;

818 if((
d©a
 = 
	`mÆloc
(
row_°ride
)Ë=
NULL
)

820 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "malloc failed\n");

821  
NULL
;

823 
i
 = 0;

824 
cöfo
.
√xt_sˇ∆öe
 < cöfo.
image_height
)

826 
x
 = 0; x < 
pimage
->
width
; x++)

828 
d©a
[
x
 * 3] = 
	`COL_RED
(
pimage
->
buf
[
i
]);

829 
d©a
[
x
 * 3 + 1] = 
	`COL_GREEN
(
pimage
->
buf
[
i
]);

830 
d©a
[
x
 * 3 + 2] = 
	`COL_BLUE
(
pimage
->
buf
[
i
]);

831 
i
++;

833 
row_poöãr
[0] = (*)
d©a
;

834 
	`j≥g_wrôe_sˇ∆öes
(&
cöfo
, 
row_poöãr
, 1);

836 
	`j≥g_föish_com¥ess
(&
cöfo
);

837 *
size
 = 
d°
.
u£d
;

838 
	`‰ì
(
d©a
);

839 
	`j≥g_de°roy_com¥ess
(&
cöfo
);

841  
d°
.
buf
;

842 
	}
}

845 
	$image_ßve_to_j≥g_fûe
(
image_s
 * 
pimage
, * 
∑th
)

847 
nwrôãn
, 
size
 = 0;

848 * 
buf
;

849 
FILE
 * 
d°_fûe
;

851 
buf
 = 
	`image_ßve_to_j≥g_buf
(
pimage
, &
size
);

852 if–!
buf
 )

853  
NULL
;

854 
d°_fûe
 = 
	`f›í
(
∑th
, "w");

855 if–!
d°_fûe
 )

857 
	`‰ì
(
buf
);

858  
NULL
;

860 
nwrôãn
 = 
	`fwrôe
(
buf
, 1, 
size
, 
d°_fûe
);

861 
	`f˛o£
(
d°_fûe
);

862 
	`‰ì
(
buf
);

864  (
nwrôãn
 =
size
Ë? 
∑th
 : 
NULL
;

865 
	}
}

	@image_utils.h

24 
	~<öây≥s.h
>

26 
	#ROTATE_NONE
 0x0

	)

27 
	#ROTATE_90
 0x1

	)

28 
	#ROTATE_180
 0x2

	)

29 
	#ROTATE_270
 0x4

	)

31 
uöt32_t
 
	tpix
;

34 
öt32_t
 
	mwidth
;

35 
öt32_t
 
	mheight
;

36 
pix
 *
	mbuf
;

37 } 
	timage_s
;

40 
image_‰ì
(
image_s
 *
pimage
);

43 
image_gë_j≥g_d©e_xmp
(c⁄° * 
∑th
, ** 
d©e
);

46 
image_gë_j≥g_ªsﬁuti⁄
(c⁄° * 
∑th
, * 
width
, * 
height
);

48 
image_s
 *

49 
image_√w_‰om_j≥g
(c⁄° * 
∑th
, 
is_fûe
, c⁄° * 
±r
, 
size
, 
sˇÀ
, 
ªsize
);

51 
image_s
 *

52 
image_ªsize
(
image_s
 * 
§c_image
, 
öt32_t
 
width
, i¡32_à
height
);

55 
image_ßve_to_j≥g_buf
(
image_s
 * 
pimage
, * 
size
);

58 
image_ßve_to_j≥g_fûe
(
image_s
 * 
pimage
, * 
∑th
);

	@inotify.c

18 
	~"c⁄fig.h
"

20 #ifde‡
HAVE_INOTIFY


21 
	~<°dio.h
>

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

24 
	~<î∫o.h
>

25 
	~<uni°d.h
>

26 
	~<dúít.h
>

27 
	~<libgí.h
>

28 
	~<î∫o.h
>

29 
	~<sys/ty≥s.h
>

30 
	~<sys/°©.h
>

31 
	~<sys/time.h
>

32 
	~<sys/ªsour˚.h
>

33 
	~<pﬁl.h
>

34 #ifde‡
HAVE_SYS_INOTIFY_H


35 
	~<sys/öŸify.h
>

37 
	~"löux/öŸify.h
"

38 
	~"löux/öŸify-sysˇŒs.h
"

40 
	~"libav.h
"

42 
	~"u≤pglobÆv¨s.h
"

43 
	~"öŸify.h
"

44 
	~"utûs.h
"

45 
	~"sql.h
"

46 
	~"sˇ¬î.h
"

47 
	~"mëad©a.h
"

48 
	~"Æbum¨t.h
"

49 
	~"∂ayli°.h
"

50 
	~"log.h
"

52 
	#EVENT_SIZE
 (  (
öŸify_evít
Ë)

	)

53 
	#BUF_LEN
 ( 1024 * ( 
EVENT_SIZE
 + 16 ) )

	)

54 
	#DESIRED_WATCH_LIMIT
 65536

	)

56 
	#PATH_BUF_SIZE
 
PATH_MAX


	)

58 
	sw©ch


60 
	mwd
;

61 *
	m∑th
;

62 
w©ch
 *
	m√xt
;

65 
w©ch
 *
	gw©ches
;

66 
w©ch
 *
	gœ°w©ch
 = 
NULL
;

67 
time_t
 
	g√xt_∂_fûl
 = 0;

69 *
	$gë_∑th_‰om_wd
(
wd
)

71 
w©ch
 *
w
 = 
w©ches
;

73  
w
 !
NULL
 )

75 if–
w
->
wd
 == wd )

76  
w
->
∑th
;

77 
w
 = w->
√xt
;

80  
NULL
;

81 
	}
}

84 
	$add_w©ch
(
fd
, c⁄° * 
∑th
)

86 
w©ch
 *
nw
;

87 
wd
;

89 
wd
 = 
	`öŸify_add_w©ch
(
fd
, 
∑th
, 
IN_CREATE
|
IN_CLOSE_WRITE
|
IN_DELETE
|
IN_MOVE
);

90 if–
wd
 < 0 )

92 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "öŸify_add_w©ch(%sË[%s]\n", 
∑th
, 
	`°ªº‹
(
î∫o
));

96 
nw
 = 
	`mÆloc
((
w©ch
));

97 if–
nw
 =
NULL
 )

99 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "malloc()Érror\n");

102 
nw
->
wd
 = wd;

103 
nw
->
√xt
 = 
NULL
;

104 
nw
->
∑th
 = 
	`°rdup
(path);

106 if–
w©ches
 =
NULL
 )

108 
w©ches
 = 
nw
;

111 if–
œ°w©ch
 !
NULL
 )

113 
œ°w©ch
->
√xt
 = 
nw
;

115 
œ°w©ch
 = 
nw
;

117  
wd
;

118 
	}
}

121 
	$ªmove_w©ch
(
fd
, c⁄° * 
∑th
)

123 
w©ch
 *
w
;

125  
w
 = 
w©ches
; w; w = w->
√xt
 )

127 if–
	`°rcmp
(
∑th
, 
w
->path) == 0 )

128 (
	`öŸify_rm_w©ch
(
fd
, 
w
->
wd
));

132 
	}
}

135 
	$√xt_highe°
(
num
)

137 
num
 |=Çum >> 1;

138 
num
 |=Çum >> 2;

139 
num
 |=Çum >> 4;

140 
num
 |=Çum >> 8;

141 
num
 |=Çum >> 16;

142 (++
num
);

143 
	}
}

146 
	$öŸify_¸óã_w©ches
(
fd
)

148 
FILE
 * 
max_w©ches
;

149 
num_w©ches
 = 0, 
w©ch_limô
;

150 **
ªsu…
;

151 
i
, 
rows
 = 0;

152 
medü_dú_s
 * 
medü_∑th
;

154  
medü_∑th
 = 
medü_dús
; medü_∑th !
NULL
; medü_∑th = medü_∑th->
√xt
 )

156 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "Add w©chÅÿ%s\n", 
medü_∑th
->
∑th
);

157 
	`add_w©ch
(
fd
, 
medü_∑th
->
∑th
);

158 
num_w©ches
++;

160 
	`sql_gë_èbÀ
(
db
, "SELECT PATH from DETAILS whîêMIME i†NULLánd PATH i†nŸ NULL", &
ªsu…
, &
rows
, 
NULL
);

161  
i
=1; i <
rows
; i++ )

163 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "Add w©chÅÿ%s\n", 
ªsu…
[
i
]);

164 
	`add_w©ch
(
fd
, 
ªsu…
[
i
]);

165 
num_w©ches
++;

167 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

169 
max_w©ches
 = 
	`f›í
("/proc/sys/fs/inotify/max_user_watches", "r");

170 if–
max_w©ches
 )

172 if–
	`fsˇnf
(
max_w©ches
, "%10u", &
w©ch_limô
) < 1 )

173 
w©ch_limô
 = 8192;

174 
	`f˛o£
(
max_w©ches
);

175 if–(
w©ch_limô
 < 
DESIRED_WATCH_LIMIT
Ë|| (w©ch_limô < (
num_w©ches
*4/3)) )

177 
max_w©ches
 = 
	`f›í
("/proc/sys/fs/inotify/max_user_watches", "w");

178 if–
max_w©ches
 )

180 if–
DESIRED_WATCH_LIMIT
 >(
num_w©ches
*3/4) )

182 
	`Ârötf
(
max_w©ches
, "%u", 
DESIRED_WATCH_LIMIT
);

184 if–
	`√xt_highe°
(
num_w©ches
) >= (num_watches*3/4) )

186 
	`Ârötf
(
max_w©ches
, "%u", 
	`√xt_highe°
(
num_w©ches
));

190 
	`Ârötf
(
max_w©ches
, "%u", 
	`√xt_highe°
“ext_highe°(
num_w©ches
)));

192 
	`f˛o£
(
max_w©ches
);

196 
	`DPRINTF
(
E_WARN
, 
L_INOTIFY
, "WARNING: Inotify max_user_watches [%u] isÜow or closeÅoÅheÇumber of used watches [%u] "

198 "wrôögá highî vÆuêötÿ/¥oc/sys/fs/öŸify/max_u£r_w©ches.\n", 
w©ch_limô
, 
num_w©ches
);

204 
	`DPRINTF
(
E_WARN
, 
L_INOTIFY
, "WARNING: CouldÇotÑead inotify max_user_watches! "

205 "H›efuŒy iài†íoughÅÿcovî %u cuºíàdúe˘‹õ†∂u†™yÇew o√†added.\n", 
num_w©ches
);

208  
rows
;

209 
	}
}

212 
	$öŸify_ªmove_w©ches
(
fd
)

214 
w©ch
 *
w
 = 
w©ches
;

215 
w©ch
 *
œ°_w
;

216 
rm_w©ches
 = 0;

218  
w
 )

220 
œ°_w
 = 
w
;

221 
	`öŸify_rm_w©ch
(
fd
, 
w
->
wd
);

222 
	`‰ì
(
w
->
∑th
);

223 
rm_w©ches
++;

224 
w
 = w->
√xt
;

225 
	`‰ì
(
œ°_w
);

228  
rm_w©ches
;

229 
	}
}

231 
	$add_dú_w©ch
(
fd
, * 
∑th
, * 
fûíame
)

233 
DIR
 *
ds
;

234 
dúít
 *
e
;

235 *
dú
;

236 
buf
[
PATH_MAX
];

237 
wd
;

238 
i
 = 0;

240 if–
fûíame
 )

242 
	`¢¥ötf
(
buf
, (buf), "%s/%s", 
∑th
, 
fûíame
);

243 
dú
 = 
buf
;

246 
dú
 = 
∑th
;

248 
wd
 = 
	`add_w©ch
(
fd
, 
dú
);

249 if–
wd
 == -1 )

251 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "add_w©ch(Ë[%s]\n", 
	`°ªº‹
(
î∫o
));

255 
	`DPRINTF
(
E_INFO
, 
L_INOTIFY
, "Added w©chÅÿ%†[%d]\n", 
dú
, 
wd
);

258 
ds
 = 
	`›ídú
(
dú
);

259 if–
ds
 !
NULL
 )

261  (
e
 = 
	`ªaddú
(
ds
)) )

263 if–
	`°rcmp
(
e
->
d_«me
, ".") == 0 ||

264 
	`°rcmp
(
e
->
d_«me
, "..") == 0 )

266 if–(
e
->
d_ty≥
 =
DT_DIR
) ||

267 (
e
->
d_ty≥
 =
DT_UNKNOWN
 && 
	`ªsﬁve_unknown_ty≥
(
dú
, 
NO_MEDIA
Ë=
TYPE_DIR
) )

268 
i
 +
	`add_dú_w©ch
(
fd
, 
dú
, 
e
->
d_«me
);

273 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "O≥ndúÉº‹! [%s]\n", 
	`°ªº‹
(
î∫o
));

275 
	`˛o£dú
(
ds
);

276 
i
++;

278 (
i
);

279 
	}
}

282 
	$öŸify_ö£π_fûe
(* 
«me
, c⁄° * 
∑th
)

284 
Àn
;

285 * 
œ°_dú
;

286 * 
∑th_buf
;

287 * 
ba£_«me
;

288 * 
ba£_c›y
;

289 * 
∑ª¡_buf
 = 
NULL
;

290 * 
id
 = 
NULL
;

291 
dïth
 = 1;

292 
ts
;

293 
medü_ty≥s
 
ty≥s
 = 
ALL_MEDIA
;

294 
medü_dú_s
 * 
medü_∑th
 = 
medü_dús
;

295 
°©
 
°
;

298 if–
	`is_image
(
∑th
) )

299 
	`upd©e_if_Æbum_¨t
(
∑th
);

300 if–
	`íds_wôh
(
∑th
, ".srt") )

301 
	`check_f‹_ˇ±i⁄s
(
∑th
, 0);

304  
medü_∑th
 )

306 if–
	`°∫cmp
(
∑th
, 
medü_∑th
->∑th, 
	`°æí
(media_path->path)) == 0 )

308 
ty≥s
 = 
medü_∑th
->types;

311 
medü_∑th
 = medü_∑th->
√xt
;

313  
ty≥s
 )

315 
ALL_MEDIA
:

316 if–!
	`is_image
(
∑th
) &&

317 !
	`is_audio
(
∑th
) &&

318 !
	`is_video
(
∑th
) &&

319 !
	`is_∂ayli°
(
∑th
) )

322 
TYPE_AUDIO
:

323 if–!
	`is_audio
(
∑th
) &&

324 !
	`is_∂ayli°
(
∑th
) )

327 
TYPE_AUDIO
|
TYPE_VIDEO
:

328 if–!
	`is_audio
(
∑th
) &&

329 !
	`is_video
(
∑th
) &&

330 !
	`is_∂ayli°
(
∑th
) )

332 
TYPE_AUDIO
|
TYPE_IMAGES
:

333 if–!
	`is_image
(
∑th
) &&

334 !
	`is_audio
(
∑th
) &&

335 !
	`is_∂ayli°
(
∑th
) )

338 
TYPE_VIDEO
:

339 if–!
	`is_video
(
∑th
) )

342 
TYPE_VIDEO
|
TYPE_IMAGES
:

343 if–!
	`is_image
(
∑th
) &&

344 !
	`is_video
(
∑th
) )

347 
TYPE_IMAGES
:

348 if–!
	`is_image
(
∑th
) )

357 if–
	`°©
(
∑th
, &
°
) != 0 )

360 
ts
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT TIMESTAMP from DETAILS whîêPATH = '%q'", 
∑th
);

361 if–!
ts
 && 
	`is_∂ayli°
(
∑th
Ë&& (
	`sql_gë_öt_fõld
(
db
, "SELECT ID from PLAYLISTS where PATH = '%q'",Öath) > 0) )

363 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "Re-ªadög modifõdÖœyli°.\n", 
∑th
);

364 
	`öŸify_ªmove_fûe
(
∑th
);

365 
√xt_∂_fûl
 = 1;

367 if–
ts
 < 
°
.
°_mtime
 )

369 if–
ts
 > 0 )

370 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "%†i†√wîÅh™Åhêœ° dbÉ¡ry.\n", 
∑th
);

371 
	`öŸify_ªmove_fûe
(
∑th
);

375 
Àn
 = 
	`°æí
(
∑th
)+1;

376 if–!(
∑th_buf
 = 
	`mÆloc
(
Àn
)) ||

377 !(
œ°_dú
 = 
	`mÆloc
(
Àn
)) ||

378 !(
ba£_«me
 = 
	`mÆloc
(
Àn
)) )

380 
ba£_c›y
 = 
ba£_«me
;

381  
dïth
 )

383 
dïth
 = 0;

384 
	`°r˝y
(
∑th_buf
, 
∑th
);

385 
∑ª¡_buf
 = 
	`dú«me
(
∑th_buf
);

390 
id
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from OBJECTS oÜeft join DETAILS d on (d.ID = o.DETAIL_ID)"

391 " whîêd.PATH = '%q'ánd REF_ID i†NULL", 
∑ª¡_buf
);

392 if–
id
 )

394 if–!
dïth
 )

396 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "Found fú° know¿∑ª¡ID: %†[%s]\n", 
id
, 
∑ª¡_buf
);

398 
	`°r˝y
(
ba£_«me
, 
œ°_dú
);

399 
ba£_c›y
 = 
	`ba£«me
(
ba£_«me
);

400 
	`ö£π_dúe˘‹y
(
ba£_c›y
, 
œ°_dú
, 
BROWSEDIR_ID
, 
id
+2, 
	`gë_√xt_avaûabÀ_id
("OBJECTS", id));

401 
	`sqlôe3_‰ì
(
id
);

404 
dïth
++;

405 
	`°r˝y
(
œ°_dú
, 
∑ª¡_buf
);

406 
∑ª¡_buf
 = 
	`dú«me
(parent_buf);

408  
	`°rcmp
(
∑ª¡_buf
, "/") != 0 );

410 if–
	`°rcmp
(
∑ª¡_buf
, "/") == 0 )

412 
id
 = 
	`sqlôe3_m¥ötf
("%s", 
BROWSEDIR_ID
);

413 
dïth
 = 0;

416 
	`°r˝y
(
∑th_buf
, 
∑th
);

418 
	`‰ì
(
œ°_dú
);

419 
	`‰ì
(
∑th_buf
);

420 
	`‰ì
(
ba£_«me
);

422 if–!
dïth
 )

425 
	`ö£π_fûe
(
«me
, 
∑th
, 
id
+2, 
	`gë_√xt_avaûabÀ_id
("OBJECTS", id));

426 
	`sqlôe3_‰ì
(
id
);

427 if–(
	`is_audio
(
∑th
Ë|| 
	`is_∂ayli°
’©h)Ë&& 
√xt_∂_fûl
 != 1 )

429 
√xt_∂_fûl
 = 
	`time
(
NULL
) + 120;

433  
dïth
;

434 
	}
}

437 
	$öŸify_ö£π_dúe˘‹y
(
fd
, *
«me
, c⁄° * 
∑th
)

439 
DIR
 * 
ds
;

440 
dúít
 * 
e
;

441 *
id
, *
∑ª¡_buf
, *
esc_«me
;

442 
∑th_buf
[
PATH_MAX
];

443 
wd
;

444 
fûe_ty≥s
 
ty≥
 = 
TYPE_UNKNOWN
;

445 
medü_ty≥s
 
dú_ty≥s
 = 
ALL_MEDIA
;

446 
medü_dú_s
* 
medü_∑th
;

447 
°©
 
°
;

449 if–
	`ac˚ss
(
∑th
, 
R_OK
|
X_OK
) != 0 )

451 
	`DPRINTF
(
E_WARN
, 
L_INOTIFY
, "CouldÇŸác˚s†%†[%s]\n", 
∑th
, 
	`°ªº‹
(
î∫o
));

454 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from DETAILS whîêPATH = '%q'", 
∑th
) > 0 )

456 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "%†ÆªadyÉxi°s\n", 
∑th
);

460 
∑ª¡_buf
 = 
	`°rdup
(
∑th
);

461 
id
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from OBJECTS oÜeft join DETAILS d on (d.ID = o.DETAIL_ID)"

462 " whîêd.PATH = '%q'ánd REF_ID i†NULL", 
	`dú«me
(
∑ª¡_buf
));

463 if–!
id
 )

464 
id
 = 
	`sqlôe3_m¥ötf
("%s", 
BROWSEDIR_ID
);

465 
	`ö£π_dúe˘‹y
(
«me
, 
∑th
, 
BROWSEDIR_ID
, 
id
+2, 
	`gë_√xt_avaûabÀ_id
("OBJECTS", id));

466 
	`sqlôe3_‰ì
(
id
);

467 
	`‰ì
(
∑ª¡_buf
);

469 
wd
 = 
	`add_w©ch
(
fd
, 
∑th
);

470 if–
wd
 == -1 )

472 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "add_watch() failed\n");

476 
	`DPRINTF
(
E_INFO
, 
L_INOTIFY
, "Added w©chÅÿ%†[%d]\n", 
∑th
, 
wd
);

479 
medü_∑th
 = 
medü_dús
;

480  
medü_∑th
 )

482 if–
	`°∫cmp
(
∑th
, 
medü_∑th
->∑th, 
	`°æí
(media_path->path)) == 0 )

484 
dú_ty≥s
 = 
medü_∑th
->
ty≥s
;

487 
medü_∑th
 = medü_∑th->
√xt
;

490 
ds
 = 
	`›ídú
(
∑th
);

491 if–!
ds
 )

493 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "›ídú faûed! [%s]\n", 
	`°ªº‹
(
î∫o
));

496  (
e
 = 
	`ªaddú
(
ds
)) )

498 if–
e
->
d_«me
[0] == '.' )

500 
esc_«me
 = 
	`esˇ≥_èg
(
e
->
d_«me
, 1);

501 
	`¢¥ötf
(
∑th_buf
, ’©h_buf), "%s/%s", 
∑th
, 
e
->
d_«me
);

502  
e
->
d_ty≥
 )

504 
DT_DIR
:

505 
DT_REG
:

506 
DT_LNK
:

507 
DT_UNKNOWN
:

508 
ty≥
 = 
	`ªsﬁve_unknown_ty≥
(
∑th_buf
, 
dú_ty≥s
);

512 if–
ty≥
 =
TYPE_DIR
 )

514 
	`öŸify_ö£π_dúe˘‹y
(
fd
, 
esc_«me
, 
∑th_buf
);

516 if–
ty≥
 =
TYPE_FILE
 )

518 if–(
	`°©
(
∑th_buf
, &
°
Ë=0Ë&& (°.
°_blocks
<<9 >°.
°_size
) )

520 
	`öŸify_ö£π_fûe
(
esc_«me
, 
∑th_buf
);

523 
	`‰ì
(
esc_«me
);

525 
	`˛o£dú
(
ds
);

528 
	}
}

531 
	$öŸify_ªmove_fûe
(c⁄° * 
∑th
)

533 
sql
[128];

534 
¨t_ˇche
[
PATH_MAX
];

535 *
id
;

536 *
±r
;

537 **
ªsu…
;

538 
öt64_t
 
dëaûID
;

539 
rows
, 
∂ayli°
;

541 if–
	`íds_wôh
(
∑th
, ".srt") )

543  
	`sql_exec
(
db
, "DELETE from CAPTIONS whîêPATH = '%q'", 
∑th
);

546 
vÆid_ˇche
 = 0;

547 
∂ayli°
 = 
	`is_∂ayli°
(
∑th
);

548 
id
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT ID from %†whîêPATH = '%q'", 
∂ayli°
?"PLAYLISTS":"DETAILS", 
∑th
);

549 if–!
id
 )

551 
dëaûID
 = 
	`°πﬁl
(
id
, 
NULL
, 10);

552 
	`sqlôe3_‰ì
(
id
);

553 if–
∂ayli°
 )

555 
	`sql_exec
(
db
, "DELETE from PLAYLISTS whîêID = %Œd", 
dëaûID
);

556 
	`sql_exec
(
db
, "DELETE from DETAILS where ID ="

558 
MUSIC_PLIST_ID
, 
dëaûID
);

559 
	`sql_exec
(
db
, "DELETE from OBJECTS where OBJECT_ID = '%s$%llX' or PARENT_ID = '%s$%llX'",

560 
MUSIC_PLIST_ID
, 
dëaûID
, MUSIC_PLIST_ID, detailID);

565 
	`¢¥ötf
(
sql
, (sql), "SELECT PARENT_ID from OBJECTS where DETAIL_ID = %lld"

567 ()
dëaûID
);

568 if–(
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
rows
, 
NULL
Ë=
SQLITE_OK
) )

570 
i
, 
chûdªn
;

571  
i
 = 1; i <
rows
; i++ )

574 if–
	`°∫cmp
(
ªsu…
[
i
], 
MUSIC_PLIST_ID
, 
	`°æí
(MUSIC_PLIST_ID)) == 0 )

576 
	`sql_exec
(
db
, "UPDATE PLAYLISTS set FOUND = (FOUND-1) where ID = %d",

577 
	`©oi
(
	`°ºchr
(
ªsu…
[
i
], '$') + 1));

580 
chûdªn
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêPARENT_ID = '%s'", 
ªsu…
[
i
]);

581 if–
chûdªn
 < 0 )

583 if–
chûdªn
 < 2 )

585 
	`sql_exec
(
db
, "DELETE from OBJECTS whîêOBJECT_ID = '%s'", 
ªsu…
[
i
]);

587 
±r
 = 
	`°ºchr
(
ªsu…
[
i
], '$');

588 if–
±r
 )

589 *
±r
 = '\0';

590 if–
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêPARENT_ID = '%s'", 
ªsu…
[
i
]) == 0 )

592 
	`sql_exec
(
db
, "DELETE from OBJECTS whîêOBJECT_ID = '%s'", 
ªsu…
[
i
]);

596 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

599 
	`sql_exec
(
db
, "DELETE from DETAILS whîêID = %Œd", 
dëaûID
);

600 
	`sql_exec
(
db
, "DELETE from OBJECTS whîêDETAIL_ID = %Œd", 
dëaûID
);

602 
	`¢¥ötf
(
¨t_ˇche
, ◊π_ˇche), "%s/¨t_ˇche%s", 
db_∑th
, 
∑th
);

603 
	`ªmove
(
¨t_ˇche
);

606 
	}
}

609 
	$öŸify_ªmove_dúe˘‹y
(
fd
, c⁄° * 
∑th
)

611 * 
sql
;

612 **
ªsu…
;

613 
öt64_t
 
dëaûID
 = 0;

614 
rows
, 
i
, 
ªt
 = 1;

617 
vÆid_ˇche
 = 0;

618 
	`ªmove_w©ch
(
fd
, 
∑th
);

619 
sql
 = 
	`sqlôe3_m¥ötf
("SELECT ID from DETAILS where (PATH > '%q/'ánd PATH <= '%q/%c')"

620 " o∏PATH = '%q'", 
∑th
,Öath, 0xFF,Öath);

621 if–(
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
rows
, 
NULL
Ë=
SQLITE_OK
) )

623 if–
rows
 )

625  
i
=1; i <
rows
; i++ )

627 
dëaûID
 = 
	`°πﬁl
(
ªsu…
[
i
], 
NULL
, 10);

628 
	`sql_exec
(
db
, "DELETE from DETAILS whîêID = %Œd", 
dëaûID
);

629 
	`sql_exec
(
db
, "DELETE from OBJECTS whîêDETAIL_ID = %Œd", 
dëaûID
);

631 
ªt
 = 0;

633 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

635 
	`sqlôe3_‰ì
(
sql
);

637 
	`sql_exec
(
db
, "DELETE from ALBUM_ART whîê(PATH > '%q/'ánd PATH <'%q/%c')", 
∑th
,Öath, 0xFF);

639  
ªt
;

640 
	}
}

643 
	$°¨t_öŸify
()

645 
pﬁlfd
 
pﬁlfds
[1];

646 
timeout
 = 1000;

647 
buf„r
[
BUF_LEN
];

648 
∑th_buf
[
PATH_MAX
];

649 
Àngth
, 
i
 = 0;

650 * 
esc_«me
 = 
NULL
;

651 
°©
 
°
;

653 
pﬁlfds
[0].
fd
 = 
	`öŸify_öô
();

654 
pﬁlfds
[0].
evíts
 = 
POLLIN
;

656 i‡–
pﬁlfds
[0].
fd
 < 0 )

657 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "inotify_init() failed!\n");

659  
sˇ¬ög
 )

661 if–
quôtög
 )

662 
quôtög
;

663 
	`¶ìp
(1);

665 
	`öŸify_¸óã_w©ches
(
pﬁlfds
[0].
fd
);

666 i‡(
	`£çri‹ôy
(
PRIO_PROCESS
, 0, 19) == -1)

667 
	`DPRINTF
(
E_WARN
, 
L_INOTIFY
, "FailedÅoÑeduce inotifyÅhreadÖriority\n");

668 
	`sqlôe3_ªÀa£_mem‹y
(1<<31);

669 
	`av_ªgi°î_Æl
();

671  !
quôtög
 )

673 
Àngth
 = 
	`pﬁl
(
pﬁlfds
, 1, 
timeout
);

674 if–!
Àngth
 )

676 if–
√xt_∂_fûl
 && (
	`time
(
NULL
) >=Çext_pl_fill) )

678 
	`fûl_∂ayli°s
();

679 
√xt_∂_fûl
 = 0;

683 if–
Àngth
 < 0 )

685 if–(
î∫o
 =
EINTR
Ë|| (î∫ÿ=
EAGAIN
) )

688 
	`DPRINTF
(
E_ERROR
, 
L_INOTIFY
, "read failed!\n");

692 
Àngth
 = 
	`ªad
(
pﬁlfds
[0].
fd
, 
buf„r
, 
BUF_LEN
);

695 
i
 = 0;

696  
i
 < 
Àngth
 )

698 
öŸify_evít
 * 
evít
 = (öŸify_evíà*Ë&
buf„r
[
i
];

699 if–
evít
->
Àn
 )

701 if–*(
evít
->
«me
) == '.' )

703 
i
 +
EVENT_SIZE
 + 
evít
->
Àn
;

706 
esc_«me
 = 
	`modifySåög
(
	`°rdup
(
evít
->
«me
), "&", "&amp;amp;");

707 
	`•rötf
(
∑th_buf
, "%s/%s", 
	`gë_∑th_‰om_wd
(
evít
->
wd
),Évít->
«me
);

708 i‡–
evít
->
mask
 & 
IN_ISDIR
 && (evít->mask & (
IN_CREATE
|
IN_MOVED_TO
)) )

710 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "The directory %s was %s.\n",

711 
∑th_buf
, (
evít
->
mask
 & 
IN_MOVED_TO
 ? "moved here" : "created"));

712 
	`öŸify_ö£π_dúe˘‹y
(
pﬁlfds
[0].
fd
, 
esc_«me
, 
∑th_buf
);

714 i‡–(
evít
->
mask
 & (
IN_CLOSE_WRITE
|
IN_MOVED_TO
|
IN_CREATE
)) &&

715 (
	`l°©
(
∑th_buf
, &
°
) == 0) )

717 if–
	`S_ISLNK
(
°
.
°_mode
) )

719 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "The symbolicÜink %s was %s.\n",

720 
∑th_buf
, (
evít
->
mask
 & 
IN_MOVED_TO
 ? "moved here" : "created"));

721 if–
	`°©
(
∑th_buf
, &
°
Ë=0 && 
	`S_ISDIR
(°.
°_mode
) )

722 
	`öŸify_ö£π_dúe˘‹y
(
pﬁlfds
[0].
fd
, 
esc_«me
, 
∑th_buf
);

724 
	`öŸify_ö£π_fûe
(
esc_«me
, 
∑th_buf
);

726 if–
evít
->
mask
 & (
IN_CLOSE_WRITE
|
IN_MOVED_TO
Ë&& 
°
.
°_size
 > 0 )

728 if–(
evít
->
mask
 & 
IN_MOVED_TO
) ||

729 (
	`sql_gë_öt_fõld
(
db
, "SELECT TIMESTAMP from DETAILS whîêPATH = '%q'", 
∑th_buf
Ë!
°
.
°_mtime
) )

731 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "The file %s was %s.\n",

732 
∑th_buf
, (
evít
->
mask
 & 
IN_MOVED_TO
 ? "moved here" : "changed"));

733 
	`öŸify_ö£π_fûe
(
esc_«me
, 
∑th_buf
);

737 i‡–
evít
->
mask
 & (
IN_DELETE
|
IN_MOVED_FROM
) )

739 
	`DPRINTF
(
E_DEBUG
, 
L_INOTIFY
, "The %s %s was %s.\n",

740 (
evít
->
mask
 & 
IN_ISDIR
 ? "directory" : "file"),

741 
∑th_buf
, (
evít
->
mask
 & 
IN_MOVED_FROM
 ? "movedáway" : "deleted"));

742 i‡–
evít
->
mask
 & 
IN_ISDIR
 )

743 
	`öŸify_ªmove_dúe˘‹y
(
pﬁlfds
[0].
fd
, 
∑th_buf
);

745 
	`öŸify_ªmove_fûe
(
∑th_buf
);

747 
	`‰ì
(
esc_«me
);

749 
i
 +
EVENT_SIZE
 + 
evít
->
Àn
;

752 
	`öŸify_ªmove_w©ches
(
pﬁlfds
[0].
fd
);

753 
quôtög
:

754 
	`˛o£
(
pﬁlfds
[0].
fd
);

757 
	}
}

	@inotify.h

1 #ifde‡
HAVE_INOTIFY


3 
öŸify_ªmove_fûe
(c⁄° * 
∑th
);

6 
°¨t_öŸify
();

	@libav.h

18 #i‡
HAVE_FFMPEG_LIBAVUTIL_AVUTIL_H


19 
	~<ffm≥g/libavutû/avutû.h
>

20 #ñi‡
HAVE_LIBAV_LIBAVUTIL_AVUTIL_H


21 
	~<libav/libavutû/avutû.h
>

22 #ñi‡
HAVE_LIBAVUTIL_AVUTIL_H


23 
	~<libavutû/avutû.h
>

24 #ñi‡
HAVE_FFMPEG_AVUTIL_H


25 
	~<ffm≥g/avutû.h
>

26 #ñi‡
HAVE_LIBAV_AVUTIL_H


27 
	~<libav/avutû.h
>

28 #ñi‡
HAVE_AVUTIL_H


29 
	~<avutû.h
>

32 #i‡
HAVE_FFMPEG_LIBAVCODEC_AVCODEC_H


33 
	~<ffm≥g/libavcodec/avcodec.h
>

34 #ñi‡
HAVE_LIBAV_LIBAVCODEC_AVCODEC_H


35 
	~<libav/libavcodec/avcodec.h
>

36 #ñi‡
HAVE_LIBAVCODEC_AVCODEC_H


37 
	~<libavcodec/avcodec.h
>

38 #ñi‡
HAVE_FFMPEG_AVCODEC_H


39 
	~<ffm≥g/avcodec.h
>

40 #ñi‡
HAVE_LIBAV_AVCODEC_H


41 
	~<libav/avcodec.h
>

42 #ñi‡
HAVE_AVCODEC_H


43 
	~<avcodec.h
>

46 #i‡
HAVE_FFMPEG_LIBAVFORMAT_AVFORMAT_H


47 
	~<ffm≥g/libavf‹m©/avf‹m©.h
>

48 #ñi‡
HAVE_LIBAV_LIBAVFORMAT_AVFORMAT_H


49 
	~<libav/libavf‹m©/avf‹m©.h
>

50 #ñi‡
HAVE_LIBAVFORMAT_AVFORMAT_H


51 
	~<libavf‹m©/avf‹m©.h
>

52 #ñi‡
HAVE_FFMPEG_AVFORMAT_H


53 
	~<ffm≥g/avf‹m©.h
>

54 #ñi‡
HAVE_LIBAV_LIBAVFORMAT_H


55 
	~<libav/avf‹m©.h
>

56 #ñi‡
HAVE_AVFORMAT_H


57 
	~<avf‹m©.h
>

60 #i‚de‡
FF_PROFILE_H264_BASELINE


61 
	#FF_PROFILE_H264_BASELINE
 66

	)

63 #i‚de‡
FF_PROFILE_H264_CONSTRAINED_BASELINE


64 
	#FF_PROFILE_H264_CONSTRAINED_BASELINE
 578

	)

66 #i‚de‡
FF_PROFILE_H264_MAIN


67 
	#FF_PROFILE_H264_MAIN
 77

	)

69 #i‚de‡
FF_PROFILE_H264_HIGH


70 
	#FF_PROFILE_H264_HIGH
 100

	)

72 #i‚de‡
FF_PROFILE_SKIP


73 
	#FF_PROFILE_SKIP
 -100

	)

76 #i‡
LIBAVCODEC_VERSION_MAJOR
 < 53

77 
	#AVMEDIA_TYPE_AUDIO
 
CODEC_TYPE_AUDIO


	)

78 
	#AVMEDIA_TYPE_VIDEO
 
CODEC_TYPE_VIDEO


	)

81 #i‡
LIBAVUTIL_VERSION_INT
 < ((50<<16)+(13<<8)+0)

82 
	#av_°ªº‹
(
x
, 
y
, 
z
Ë
	`¢¥ötf
(y, z, "%d", x)

	)

	@linux/inotify-syscalls.h

1 #i‚de‡
_LINUX_INOTIFY_SYSCALLS_H


2 
	#_LINUX_INOTIFY_SYSCALLS_H


	)

4 
	~<sys/sysˇŒ.h
>

6 #i‡
deföed
(
__i386__
)

7 
	#__NR_öŸify_öô
 291

	)

8 
	#__NR_öŸify_add_w©ch
 292

	)

9 
	#__NR_öŸify_rm_w©ch
 293

	)

10 #ñi‡
deföed
(
__x86_64__
)

11 
	#__NR_öŸify_öô
 253

	)

12 
	#__NR_öŸify_add_w©ch
 254

	)

13 
	#__NR_öŸify_rm_w©ch
 255

	)

14 #ñi‡
deföed
(
__powîpc__
Ë|| deföed(
__powîpc64__
)

15 
	#__NR_öŸify_öô
 275

	)

16 
	#__NR_öŸify_add_w©ch
 276

	)

17 
	#__NR_öŸify_rm_w©ch
 277

	)

18 #ñi‡
deföed
 (
__mùs__
)

19 #i‡
_MIPS_SIM
 =
_MIPS_SIM_ABI32


20 
	#__NR_öŸify_öô
 (
__NR_Löux
 + 284)

	)

21 
	#__NR_öŸify_add_w©ch
 (
__NR_Löux
 + 285)

	)

22 
	#__NR_öŸify_rm_w©ch
 (
__NR_Löux
 + 286)

	)

24 #i‡
_MIPS_SIM
 =
_MIPS_SIM_ABI64


25 
	#__NR_öŸify_öô
 (
__NR_Löux
 + 243)

	)

26 
	#__NR_öŸify_add_w©ch
 (
__NR_Löux
 + 243)

	)

27 
	#__NR_öŸify_rm_w©ch
 (
__NR_Löux
 + 243)

	)

29 #i‡
_MIPS_SIM
 =
_MIPS_SIM_NABI32


30 
	#__NR_öŸify_öô
 (
__NR_Löux
 + 247)

	)

31 
	#__NR_öŸify_add_w©ch
 (
__NR_Löux
 + 248)

	)

32 
	#__NR_öŸify_rm_w©ch
 (
__NR_Löux
 + 249)

	)

34 #ñi‡
deföed
 (
__ü64__
)

35 
	#__NR_öŸify_öô
 1277

	)

36 
	#__NR_öŸify_add_w©ch
 1278

	)

37 
	#__NR_öŸify_rm_w©ch
 1279

	)

38 #ñi‡
deföed
 (
__s390__
)

39 
	#__NR_öŸify_öô
 284

	)

40 
	#__NR_öŸify_add_w©ch
 285

	)

41 
	#__NR_öŸify_rm_w©ch
 286

	)

42 #ñi‡
deföed
 (
__Æpha__
)

43 
	#__NR_öŸify_öô
 444

	)

44 
	#__NR_öŸify_add_w©ch
 445

	)

45 
	#__NR_öŸify_rm_w©ch
 446

	)

46 #ñi‡
deföed
 (
__•¨c__
Ë|| deföed (
__•¨c64__
)

47 
	#__NR_öŸify_öô
 151

	)

48 
	#__NR_öŸify_add_w©ch
 152

	)

49 
	#__NR_öŸify_rm_w©ch
 156

	)

50 #ñi‡
deföed
 (
__¨m__
)

51 
	#__NR_öŸify_öô
 (
__NR_SYSCALL_BASE
+316)

	)

52 
	#__NR_öŸify_add_w©ch
 (
__NR_SYSCALL_BASE
+317)

	)

53 
	#__NR_öŸify_rm_w©ch
 (
__NR_SYSCALL_BASE
+318)

	)

54 #ñi‡
deföed
 (
__sh__
)

55 
	#__NR_öŸify_öô
 290

	)

56 
	#__NR_öŸify_add_w©ch
 291

	)

57 
	#__NR_öŸify_rm_w©ch
 292

	)

62 
ölöe
 
	$öŸify_öô
 ()

64  
	`sysˇŒ
 (
__NR_öŸify_öô
);

65 
	}
}

67 
ölöe
 
	$öŸify_add_w©ch
 (
fd
, c⁄° *
«me
, 
__u32
 
mask
)

69  
	`sysˇŒ
 (
__NR_öŸify_add_w©ch
, 
fd
, 
«me
, 
mask
);

70 
	}
}

72 
ölöe
 
	$öŸify_rm_w©ch
 (
fd
, 
__u32
 
wd
)

74  
	`sysˇŒ
 (
__NR_öŸify_rm_w©ch
, 
fd
, 
wd
);

75 
	}
}

	@linux/inotify.h

7 #i‚de‡
_LINUX_INOTIFY_H


8 
	#_LINUX_INOTIFY_H


	)

10 
	~<löux/ty≥s.h
>

18 
	söŸify_evít
 {

19 
__s32
 
	mwd
;

20 
__u32
 
	mmask
;

21 
__u32
 
	mcookõ
;

22 
__u32
 
	mÀn
;

23 
	m«me
[0];

27 
	#IN_ACCESS
 0x00000001

	)

28 
	#IN_MODIFY
 0x00000002

	)

29 
	#IN_ATTRIB
 0x00000004

	)

30 
	#IN_CLOSE_WRITE
 0x00000008

	)

31 
	#IN_CLOSE_NOWRITE
 0x00000010

	)

32 
	#IN_OPEN
 0x00000020

	)

33 
	#IN_MOVED_FROM
 0x00000040

	)

34 
	#IN_MOVED_TO
 0x00000080

	)

35 
	#IN_CREATE
 0x00000100

	)

36 
	#IN_DELETE
 0x00000200

	)

37 
	#IN_DELETE_SELF
 0x00000400

	)

40 
	#IN_UNMOUNT
 0x00002000

	)

41 
	#IN_Q_OVERFLOW
 0x00004000

	)

42 
	#IN_IGNORED
 0x00008000

	)

45 
	#IN_CLOSE
 (
IN_CLOSE_WRITE
 | 
IN_CLOSE_NOWRITE
Ë

	)

46 
	#IN_MOVE
 (
IN_MOVED_FROM
 | 
IN_MOVED_TO
Ë

	)

49 
	#IN_ISDIR
 0x40000000

	)

50 
	#IN_ONESHOT
 0x80000000

	)

57 
	#IN_ALL_EVENTS
 (
IN_ACCESS
 | 
IN_MODIFY
 | 
IN_ATTRIB
 | 
IN_CLOSE_WRITE
 | \

58 
IN_CLOSE_NOWRITE
 | 
IN_OPEN
 | 
IN_MOVED_FROM
 | \

59 
IN_MOVED_TO
 | 
IN_DELETE
 | 
IN_CREATE
 | 
IN_DELETE_SELF
)

	)

61 #ifde‡
__KERNEL__


63 
	~<löux/dˇche.h
>

64 
	~<löux/fs.h
>

65 
	~<löux/c⁄fig.h
>

67 #ifde‡
CONFIG_INOTIFY


69 
öŸify_öode_queue_evít
(
öode
 *, 
__u32
, __u32,

71 
öŸify_díåy_∑ª¡_queue_evít
(
díåy
 *, 
__u32
, __u32,

73 
öŸify_unmou¡_öodes
(
li°_hód
 *);

74 
öŸify_öode_is_dód
(
öode
 *);

75 
u32
 
öŸify_gë_cookõ
();

79 
ölöe
 
	$öŸify_öode_queue_evít
(
öode
 *inode,

80 
__u32
 
mask
, __u32 
cookõ
,

81 c⁄° *
fûíame
)

83 
	}
}

85 
ölöe
 
	$öŸify_díåy_∑ª¡_queue_evít
(
díåy
 *dentry,

86 
__u32
 
mask
, __u32 
cookõ
,

87 c⁄° *
fûíame
)

89 
	}
}

91 
ölöe
 
	$öŸify_unmou¡_öodes
(
li°_hód
 *
li°
)

93 
	}
}

95 
ölöe
 
	$öŸify_öode_is_dód
(
öode
 *inode)

97 
	}
}

99 
ölöe
 
u32
 
	$öŸify_gë_cookõ
()

102 
	}
}

	@log.c

20 
	~"c⁄fig.h
"

22 
	~<°dlib.h
>

23 
	~<°dio.h
>

24 
	~<°d¨g.h
>

25 
	~<°rög.h
>

26 
	~<time.h
>

28 
	~"u≤pglobÆv¨s.h
"

29 
	~"log.h
"

31 
FILE
 *
	glog_Â
 = 
NULL
;

32 
	gdeÁu…_log_Àvñ
 = 
E_WARN
;

33 
	glog_Àvñ
[
L_MAX
];

35 *
	gÁcûôy_«me
[] = {

48 *
	gÀvñ_«me
[] = {

60 
	$log_˛o£
()

62 i‡(
log_Â
)

63 
	`f˛o£
(
log_Â
);

64 
	}
}

67 
	$log_öô
(c⁄° *
‚ame
, c⁄° *
debug
)

69 
i
;

70 
FILE
 *
Â
;

71 
log_Àvñ_£t
[
L_MAX
];

73 i‡(
debug
)

75 c⁄° *
rhs
, *
lhs
, *
∆hs
, *
p
;

76 
n
;

77 
Àvñ
, 
Ácûôy
;

78 
	`mem£t
(&
log_Àvñ_£t
, 0, (log_level_set));

79 
rhs
 = 
∆hs
 = 
debug
;

80 
rhs
 && (rh†
	`°rchr
(rhs, '='))) {

81 
rhs
++;

82 
p
 = 
	`°rchr
(
rhs
, ',');

83 
n
 = 
p
 ?Ö - 
rhs
 : 
	`°æí
(rhs);

84 
Àvñ
=0; 
Àvñ_«me
[level];Üevel++) {

85 i‡(!(
	`°∫ˇ£cmp
(
Àvñ_«me
[
Àvñ
], 
rhs
, 
n
)))

88 
lhs
 = 
∆hs
;

89 
rhs
 = 
∆hs
 = 
p
;

90 i‡(!(
Àvñ_«me
[
Àvñ
])) {

95 i‡(*
lhs
==',')Ühs++;

96 
p
 = 
	`°Ωbrk
(
lhs
, ",=");

97 
n
 = 
p
 ?Ö - 
lhs
 : 
	`°æí
(lhs);

98 
Ácûôy
=0; 
Ácûôy_«me
[facility]; facility++) {

99 i‡(!(
	`°∫ˇ£cmp
(
Ácûôy_«me
[
Ácûôy
], 
lhs
, 
n
)))

102 i‡((
Ácûôy_«me
[
Ácûôy
])) {

103 
log_Àvñ
[
Ácûôy
] = 
Àvñ
;

104 
log_Àvñ_£t
[
Ácûôy
] = 1;

106 
lhs
 = 
p
;

107 } *
lhs
 && *lhs==',');

109 
i
=0; i<
L_MAX
; i++)

111 if–!
log_Àvñ_£t
[
i
] )

113 
log_Àvñ
[
i
] = 
deÁu…_log_Àvñ
;

118 
i
=0; i<
L_MAX
; i++)

119 
log_Àvñ
[
i
] = 
deÁu…_log_Àvñ
;

122 i‡(!
‚ame
)

125 i‡(!(
Â
 = 
	`f›í
(
‚ame
, "a")))

127 
log_Â
 = 
Â
;

129 
	}
}

132 
	$log_îr
(
Àvñ
, 
_log_Ácûôy
 
Ácûôy
, *
‚ame
, 
löío
, *
fmt
, ...)

134 
va_li°
 
≠
;

136 i‡(
Àvñ
 &&Üevñ>
log_Àvñ
[
Ácûôy
] &&Üevñ>
E_FATAL
)

139 i‡(!
log_Â
)

140 
log_Â
 = 
°dout
;

143 i‡(!
	`GETFLAG
(
SYSTEMD_MASK
))

145 
time_t
 
t
;

146 
tm
 *tm;

147 
t
 = 
	`time
(
NULL
);

148 
tm
 = 
	`loˇ…ime
(&
t
);

149 
	`Ârötf
(
log_Â
, "[%04d/%02d/%02d %02d:%02d:%02d] ",

150 
tm
->
tm_yór
+1900,Åm->
tm_m⁄
+1,Åm->
tm_mday
,

151 
tm
->
tm_hour
,Åm->
tm_mö
,Åm->
tm_£c
);

154 i‡(
Àvñ
)

155 
	`Ârötf
(
log_Â
, "%s:%d: %s: ", 
‚ame
, 
löío
, 
Àvñ_«me
[
Àvñ
]);

157 
	`Ârötf
(
log_Â
, "%s:%d: ", 
‚ame
, 
löío
);

160 
	`va_°¨t
(
≠
, 
fmt
);

161 i‡(
	`vÂrötf
(
log_Â
, 
fmt
, 
≠
) == -1)

163 
	`va_íd
(
≠
);

166 
	`va_íd
(
≠
);

168 
	`fÊush
(
log_Â
);

170 i‡(
Àvñ
==
E_FATAL
)

171 
	`exô
(-1);

174 
	}
}

	@log.h

21 #i‚de‡
__ERR_H__


22 
	#__ERR_H__


	)

24 
	#E_OFF
 0

	)

25 
	#E_FATAL
 1

	)

26 
	#E_ERROR
 2

	)

27 
	#E_WARN
 3

	)

28 
	#E_INFO
 4

	)

29 
	#E_DEBUG
 5

	)

30 
	#E_MAXDEBUG
 6

	)

32 
	e_log_Ácûôy


34 
	mL_GENERAL
=0,

35 
	mL_ARTWORK
,

36 
	mL_DB_SQL
,

37 
	mL_INOTIFY
,

38 
	mL_SCANNER
,

39 
	mL_METADATA
,

40 
	mL_HTTP
,

41 
	mL_SSDP
,

42 
	mL_TIVO
,

43 
	mL_MAX


46 
log_Àvñ
[
L_MAX
];

47 
log_öô
(c⁄° *
‚ame
, c⁄° *
debug
);

48 
log_˛o£
();

49 
log_îr
(
Àvñ
, 
_log_Ácûôy
 
Ácûôy
, *
‚ame
, 
löío
, *
fmt
, ...);

51 
	#DPRINTF
(
Àvñ
, 
Ácûôy
, 
fmt
, 
¨g
...Ëdÿ{ 
	`log_îr
÷evñ, facûôy, 
__FILE__
, 
__LINE__
, fmt, ##¨g); } 0)

	)

	@metadata.c

18 
	~"c⁄fig.h
"

20 
	~<°dio.h
>

21 
	~<˘y≥.h
>

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

24 
	~<libgí.h
>

25 
	~<uni°d.h
>

26 
	~<sys/°©.h
>

27 
	~<sys/ty≥s.h
>

28 
	~<sys/∑øm.h
>

29 
	~<f˙é.h
>

31 
	~<libexif/exif-lﬂdî.h
>

32 
	~<j≥glib.h
>

33 
	~<tiffio.h
>

34 
	~<£tjmp.h
>

35 
	~"libav.h
"

37 
	~"u≤pglobÆv¨s.h
"

38 
	~"ègutûs/ègutûs.h
"

39 
	~"image_utûs.h
"

40 
	~"u≤¥ïly∑r£.h
"

41 
	~"tivo_utûs.h
"

42 
	~"mëad©a.h
"

43 
	~"Æbum¨t.h
"

44 
	~"utûs.h
"

45 
	~"sql.h
"

46 
	~"log.h
"

48 
	#FLAG_TITLE
 0x00000001

	)

49 
	#FLAG_ARTIST
 0x00000002

	)

50 
	#FLAG_ALBUM
 0x00000004

	)

51 
	#FLAG_GENRE
 0x00000008

	)

52 
	#FLAG_COMMENT
 0x00000010

	)

53 
	#FLAG_CREATOR
 0x00000020

	)

54 
	#FLAG_DATE
 0x00000040

	)

55 
	#FLAG_DLNA_PN
 0x00000080

	)

56 
	#FLAG_MIME
 0x00000100

	)

57 
	#FLAG_DURATION
 0x00000200

	)

58 
	#FLAG_RESOLUTION
 0x00000400

	)

59 
	#FLAG_BITRATE
 0x00000800

	)

60 
	#FLAG_FREQUENCY
 0x00001000

	)

61 
	#FLAG_BPS
 0x00002000

	)

62 
	#FLAG_CHANNELS
 0x00004000

	)

63 
	#FLAG_ROTATION
 0x00008000

	)

66 
	eaudio_¥ofûes
 {

67 
	mPROFILE_AUDIO_UNKNOWN
,

68 
	mPROFILE_AUDIO_MP3
,

69 
	mPROFILE_AUDIO_AC3
,

70 
	mPROFILE_AUDIO_WMA_BASE
,

71 
	mPROFILE_AUDIO_WMA_FULL
,

72 
	mPROFILE_AUDIO_WMA_PRO
,

73 
	mPROFILE_AUDIO_MP2
,

74 
	mPROFILE_AUDIO_PCM
,

75 
	mPROFILE_AUDIO_AAC
,

76 
	mPROFILE_AUDIO_AAC_MULT5
,

77 
	mPROFILE_AUDIO_AMR


80 
ölöe
 

81 
	$œv_›í
(
AVF‹m©C⁄ãxt
 **
˘x
, c⁄° *
fûíame
)

83 
ªt
;

85 #i‡
LIBAVFORMAT_VERSION_INT
 >= ((53<<16)+(17<<8)+0)

86 
ªt
 = 
	`avf‹m©_›í_öput
(
˘x
, 
fûíame
, 
NULL
, NULL);

87 i‡(
ªt
 == 0)

89 
ªt
 = 
	`avf‹m©_föd_°ªam_öfo
(*
˘x
, 
NULL
);

90 
ªt
 = (ret >= 0 ? 0 :Ñet);

93 
ªt
 = 
	`av_›í_öput_fûe
(
˘x
, 
fûíame
, 
NULL
, 0, NULL);

94 i‡(
ªt
 == 0)

96 
ªt
 = 
	`av_föd_°ªam_öfo
(*
˘x
);

97 
ªt
 = (ret >= 0 ? 0 :Ñet);

100  
ªt
;

101 
	}
}

103 
ölöe
 

104 
	$œv_˛o£
(
AVF‹m©C⁄ãxt
 *
˘x
)

106 i‡(
˘x
)

108 #i‡
LIBAVFORMAT_VERSION_INT
 >= ((53<<16)+(17<<8)+0)

109 
	`avf‹m©_˛o£_öput
(&
˘x
);

111 
	`av_˛o£_öput_fûe
(
˘x
);

114 
	}
}

116 #i‡
LIBAVFORMAT_VERSION_INT
 >= ((52<<16)+(31<<8)+0)

117 #i‡
LIBAVUTIL_VERSION_INT
 < ((51<<16)+(5<<8)+0Ë&& !
deföed
(
FF_API_OLD_METADATA2
)

118 
	#AV_DICT_IGNORE_SUFFIX
 
AV_METADATA_IGNORE_SUFFIX


	)

119 
	#av_di˘_gë
 
av_mëad©a_gë


	)

120 
AVMëad©aTag
 
	tAVDi˘i⁄¨yE¡ry
;

125 
	#MPEG_TS_SYNC_CODE
 0x47

	)

126 
	#MPEG_TS_PACKET_LENGTH
 188

	)

127 
	#MPEG_TS_PACKET_LENGTH_DLNA
 192

	)

129 
	$d a_time°amp_is_¥e£¡
(c⁄° *
fûíame
, *
øw_∑ckë_size
)

131 
buf„r
[3*
MPEG_TS_PACKET_LENGTH_DLNA
];

132 
fd
, 
i
;

135 
fd
 = 
	`›í
(
fûíame
, 
O_RDONLY
);

136 if–
fd
 < 0 )

138 
i
 = 
	`ªad
(
fd
, 
buf„r
, 
MPEG_TS_PACKET_LENGTH_DLNA
*3);

139 
	`˛o£
(
fd
);

140 if–
i
 < 0 )

142  
i
 = 0; i < 
MPEG_TS_PACKET_LENGTH_DLNA
; i++ )

144 if–
buf„r
[
i
] =
MPEG_TS_SYNC_CODE
 )

146 i‡(
buf„r
[
i
 + 
MPEG_TS_PACKET_LENGTH_DLNA
] =
MPEG_TS_SYNC_CODE
 &&

147 
buf„r
[
i
 + 
MPEG_TS_PACKET_LENGTH_DLNA
*2] =
MPEG_TS_SYNC_CODE
)

149 *
øw_∑ckë_size
 = 
MPEG_TS_PACKET_LENGTH_DLNA
;

150 i‡(
buf„r
[
i
+
MPEG_TS_PACKET_LENGTH
] == 0x00 &&

151 
buf„r
[
i
+
MPEG_TS_PACKET_LENGTH
+1] == 0x00 &&

152 
buf„r
[
i
+
MPEG_TS_PACKET_LENGTH
+2] == 0x00 &&

153 
buf„r
[
i
+
MPEG_TS_PACKET_LENGTH
+3] == 0x00)

157 } i‡(
buf„r
[
i
 + 
MPEG_TS_PACKET_LENGTH
] =
MPEG_TS_SYNC_CODE
 &&

158 
buf„r
[
i
 + 
MPEG_TS_PACKET_LENGTH
*2] =
MPEG_TS_SYNC_CODE
) {

159 *
øw_∑ckë_size
 = 
MPEG_TS_PACKET_LENGTH
;

164 *
øw_∑ckë_size
 = 0;

166 
	}
}

169 
	$check_f‹_ˇ±i⁄s
(c⁄° *
∑th
, 
öt64_t
 
dëaûID
)

171 *
fûe
 = 
	`mÆloc
(
MAXPATHLEN
);

172 *
id
 = 
NULL
;

174 
	`•rötf
(
fûe
, "%s", 
∑th
);

175 
	`°rù_ext
(
fûe
);

178 if–!
dëaûID
 )

180 
id
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT ID from DETAILS where (PATH > '%q.'ánd PATH <= '%q.z')"

181 "ánd MIME glob 'video/*'Üimô 1", 
fûe
, file);

182 if–
id
 )

185 
dëaûID
 = 
	`°πﬁl
(
id
, 
NULL
, 10);

190 
no_sour˚_video
;

194 
	`°rˇt
(
fûe
, ".srt");

195 if–
	`ac˚ss
(
fûe
, 
R_OK
) == 0 )

197 
	`sql_exec
(
db
, "INSERT into CAPTIONS"

200 " (%Œd, %Q)", 
dëaûID
, 
fûe
);

202 
no_sour˚_video
:

203 if–
id
 )

204 
	`sqlôe3_‰ì
(
id
);

205 
	`‰ì
(
fûe
);

206 
	}
}

209 
	$∑r£_nfo
(c⁄° *
∑th
, 
mëad©a_t
 *
m
)

211 
FILE
 *
nfo
;

212 
buf
[65536];

213 
NameVÆueP¨£rD©a
 
xml
;

214 
°©
 
fûe
;

215 
size_t
 
ƒód
;

216 *
vÆ
, *
vÆ2
;

218 if–
	`°©
(
∑th
, &
fûe
) != 0 ||

219 
fûe
.
°_size
 > 65536 )

221 
	`DPRINTF
(
E_INFO
, 
L_METADATA
, "NŸÖ¨sög vîyÜ¨gê.nfÿfûê%s\n", 
∑th
);

224 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "P¨sög .nfÿfûe: %s\n", 
∑th
);

225 
nfo
 = 
	`f›í
(
∑th
, "r");

226 if–!
nfo
 )

228 
ƒód
 = 
	`‰ód
(&
buf
, 1, (buf), 
nfo
);

230 
	`P¨£NameVÆue
(
buf
, 
ƒód
, &
xml
, 0);

233 
vÆ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "title");

234 if–
vÆ
 )

236 *
esc_èg
 = 
	`u√sˇ≥_èg
(
vÆ
, 1);

237 
vÆ2
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "episodetitle");

238 if–
vÆ2
 ) {

239 *
esc_èg2
 = 
	`u√sˇ≥_èg
(
vÆ2
, 1);

240 
	`xa•rötf
(&
m
->
tôÀ
, "%†- %s", 
esc_èg
, 
esc_èg2
);

241 
	`‰ì
(
esc_èg2
);

243 
m
->
tôÀ
 = 
	`esˇ≥_èg
(
esc_èg
, 1);

245 
	`‰ì
(
esc_èg
);

248 
vÆ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "plot");

249 if–
vÆ
 ) {

250 *
esc_èg
 = 
	`u√sˇ≥_èg
(
vÆ
, 1);

251 
m
->
commít
 = 
	`esˇ≥_èg
(
esc_èg
, 1);

252 
	`‰ì
(
esc_èg
);

255 
vÆ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "capturedate");

256 if–
vÆ
 ) {

257 *
esc_èg
 = 
	`u√sˇ≥_èg
(
vÆ
, 1);

258 
m
->
d©e
 = 
	`esˇ≥_èg
(
esc_èg
, 1);

259 
	`‰ì
(
esc_èg
);

262 
vÆ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "genre");

263 if–
vÆ
 )

265 
	`‰ì
(
m
->
gíª
);

266 *
esc_èg
 = 
	`u√sˇ≥_èg
(
vÆ
, 1);

267 
m
->
gíª
 = 
	`esˇ≥_èg
(
esc_èg
, 1);

268 
	`‰ì
(
esc_èg
);

271 
vÆ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "mime");

272 if–
vÆ
 )

274 
	`‰ì
(
m
->
mime
);

275 *
esc_èg
 = 
	`u√sˇ≥_èg
(
vÆ
, 1);

276 
m
->
mime
 = 
	`esˇ≥_èg
(
esc_èg
, 1);

277 
	`‰ì
(
esc_èg
);

280 
	`CÀ¨NameVÆueLi°
(&
xml
);

281 
	`f˛o£
(
nfo
);

282 
	}
}

285 
	$‰ì_mëad©a
(
mëad©a_t
 *
m
, 
uöt32_t
 
Êags
)

287 if–
Êags
 & 
FLAG_TITLE
 )

288 
	`‰ì
(
m
->
tôÀ
);

289 if–
Êags
 & 
FLAG_ARTIST
 )

290 
	`‰ì
(
m
->
¨ti°
);

291 if–
Êags
 & 
FLAG_ALBUM
 )

292 
	`‰ì
(
m
->
Æbum
);

293 if–
Êags
 & 
FLAG_GENRE
 )

294 
	`‰ì
(
m
->
gíª
);

295 if–
Êags
 & 
FLAG_CREATOR
 )

296 
	`‰ì
(
m
->
¸ót‹
);

297 if–
Êags
 & 
FLAG_DATE
 )

298 
	`‰ì
(
m
->
d©e
);

299 if–
Êags
 & 
FLAG_COMMENT
 )

300 
	`‰ì
(
m
->
commít
);

301 if–
Êags
 & 
FLAG_DLNA_PN
 )

302 
	`‰ì
(
m
->
d a_≤
);

303 if–
Êags
 & 
FLAG_MIME
 )

304 
	`‰ì
(
m
->
mime
);

305 if–
Êags
 & 
FLAG_DURATION
 )

306 
	`‰ì
(
m
->
duøti⁄
);

307 if–
Êags
 & 
FLAG_RESOLUTION
 )

308 
	`‰ì
(
m
->
ªsﬁuti⁄
);

309 if–
Êags
 & 
FLAG_BITRATE
 )

310 
	`‰ì
(
m
->
bôøã
);

311 if–
Êags
 & 
FLAG_FREQUENCY
 )

312 
	`‰ì
(
m
->
‰equícy
);

313 if–
Êags
 & 
FLAG_BPS
 )

314 
	`‰ì
(
m
->
bps
);

315 if–
Êags
 & 
FLAG_CHANNELS
 )

316 
	`‰ì
(
m
->
ch™√ls
);

317 if–
Êags
 & 
FLAG_ROTATION
 )

318 
	`‰ì
(
m
->
rŸ©i⁄
);

319 
	}
}

321 
öt64_t


322 
	$GëFﬁdîMëad©a
(c⁄° *
«me
, c⁄° *
∑th
, c⁄° *
¨ti°
, c⁄° *
gíª
, 
öt64_t
 
Æbum_¨t
)

324 
ªt
;

326 
ªt
 = 
	`sql_exec
(
db
, "INSERT into DETAILS"

330 
«me
, 
∑th
, 
¨ti°
,áπi°, 
gíª
, 
Æbum_¨t
);

331 if–
ªt
 !
SQLITE_OK
 )

332 
ªt
 = 0;

334 
ªt
 = 
	`sqlôe3_œ°_ö£π_rowid
(
db
);

336  
ªt
;

337 
	}
}

339 
öt64_t


340 
	$GëAudioMëad©a
(c⁄° *
∑th
, *
«me
)

342 
ty≥
[4];

343 
œng
[6] = { '\0' };

344 
°©
 
fûe
;

345 
öt64_t
 
ªt
;

346 *
esc_èg
;

347 
i
;

348 
öt64_t
 
Æbum_¨t
 = 0;

349 
s⁄g_mëad©a
 
s⁄g
;

350 
mëad©a_t
 
m
;

351 
uöt32_t
 
‰ì_Êags
 = 
FLAG_MIME
|
FLAG_DURATION
|
FLAG_DLNA_PN
|
FLAG_DATE
;

352 
	`mem£t
(&
m
, '\0', (
mëad©a_t
));

354 i‡–
	`°©
(
∑th
, &
fûe
) != 0 )

356 
	`°rù_ext
(
«me
);

358 if–
	`íds_wôh
(
∑th
, ".mp3") )

360 
	`°r˝y
(
ty≥
, "mp3");

361 
m
.
mime
 = 
	`°rdup
("audio/mpeg");

363 if–
	`íds_wôh
(
∑th
, ".m4a") ||Énds_with(path, ".mp4") ||

364 
	`íds_wôh
(
∑th
, ".aac") ||Énds_with(path, ".m4p") )

366 
	`°r˝y
(
ty≥
, "aac");

367 
m
.
mime
 = 
	`°rdup
("audio/mp4");

369 if–
	`íds_wôh
(
∑th
, ".3gp") )

371 
	`°r˝y
(
ty≥
, "aac");

372 
m
.
mime
 = 
	`°rdup
("audio/3gpp");

374 if–
	`íds_wôh
(
∑th
, ".wma") ||Énds_with(path, ".asf") )

376 
	`°r˝y
(
ty≥
, "asf");

377 
m
.
mime
 = 
	`°rdup
("audio/x-ms-wma");

379 if–
	`íds_wôh
(
∑th
, ".flac") ||Énds_with(path, ".fla") ||Énds_with(path, ".flc") )

381 
	`°r˝y
(
ty≥
, "flc");

382 
m
.
mime
 = 
	`°rdup
("audio/x-flac");

384 if–
	`íds_wôh
(
∑th
, ".wav") )

386 
	`°r˝y
(
ty≥
, "wav");

387 
m
.
mime
 = 
	`°rdup
("audio/x-wav");

389 if–
	`íds_wôh
(
∑th
, ".ogg") ||Énds_with(path, ".oga") )

391 
	`°r˝y
(
ty≥
, "ogg");

392 
m
.
mime
 = 
	`°rdup
("audio/ogg");

394 if–
	`íds_wôh
(
∑th
, ".pcm") )

396 
	`°r˝y
(
ty≥
, "pcm");

397 
m
.
mime
 = 
	`°rdup
("audio/L16");

401 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Unh™dÀd fûêexãnsi⁄ o¿%s\n", 
∑th
);

405 if–!(*
œng
) )

407 if–!
	`gëív
("LANG") )

408 
	`°r˝y
(
œng
, "en_US");

410 
	`°∫˝yt
(
œng
, 
	`gëív
("LANG"), (lang));

413 if–
	`ªadègs
((*)
∑th
, &
s⁄g
, &
fûe
, 
œng
, 
ty≥
) != 0 )

415 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "C™nŸÉxåa˘Åag†‰om %s!\n", 
∑th
);

416 
	`‰ìègs
(&
s⁄g
);

417 
	`‰ì_mëad©a
(&
m
, 
‰ì_Êags
);

421 if–
s⁄g
.
d a_≤
 )

422 
m
.
d a_≤
 = 
	`°rdup
(
s⁄g
.dlna_pn);

423 if–
s⁄g
.
yór
 )

424 
	`xa•rötf
(&
m
.
d©e
, "%04d-01-01", 
s⁄g
.
yór
);

425 
	`xa•rötf
(&
m
.
duøti⁄
, "%d:%02d:%02d.%03d",

426 (
s⁄g
.
s⁄g_Àngth
/3600000),

427 (
s⁄g
.
s⁄g_Àngth
/60000%60),

428 (
s⁄g
.
s⁄g_Àngth
/1000%60),

429 (
s⁄g
.
s⁄g_Àngth
%1000));

430 if–
s⁄g
.
tôÀ
 && *song.title )

432 
m
.
tôÀ
 = 
	`åim
(
s⁄g
.title);

433 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
tôÀ
, 0)) )

435 
‰ì_Êags
 |
FLAG_TITLE
;

436 
m
.
tôÀ
 = 
esc_èg
;

441 
m
.
tôÀ
 = 
«me
;

443  
i
=
ROLE_START
; i<
N_ROLE
; i++ )

445 if–
s⁄g
.
c⁄åibut‹
[
i
] && *song.contributor[i] )

447 
m
.
¸ót‹
 = 
	`åim
(
s⁄g
.
c⁄åibut‹
[
i
]);

448 if–
	`°æí
(
m
.
¸ót‹
) > 48 )

450 
m
.
¸ót‹
 = 
	`°rdup
("Various Artists");

451 
‰ì_Êags
 |
FLAG_CREATOR
;

453 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
¸ót‹
, 0)) )

455 
m
.
¸ót‹
 = 
esc_èg
;

456 
‰ì_Êags
 |
FLAG_CREATOR
;

458 
m
.
¨ti°
 = m.
¸ót‹
;

463 if–(
i
 !
ROLE_BAND
Ë&& (ò!
ROLE_ALBUMARTIST
) )

465 if–
s⁄g
.
c⁄åibut‹
[
ROLE_BAND
] && *song.contributor[ROLE_BAND] )

467 
i
 = 
ROLE_BAND
;

468 
m
.
¨ti°
 = 
	`åim
(
s⁄g
.
c⁄åibut‹
[
i
]);

469 if–
	`°æí
(
m
.
¨ti°
) > 48 )

471 
m
.
¨ti°
 = 
	`°rdup
("Various Artists");

472 
‰ì_Êags
 |
FLAG_ARTIST
;

474 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
¨ti°
, 0)) )

476 
m
.
¨ti°
 = 
esc_èg
;

477 
‰ì_Êags
 |
FLAG_ARTIST
;

481 if–
s⁄g
.
Æbum
 && *song.album )

483 
m
.
Æbum
 = 
	`åim
(
s⁄g
.album);

484 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
Æbum
, 0)) )

486 
‰ì_Êags
 |
FLAG_ALBUM
;

487 
m
.
Æbum
 = 
esc_èg
;

490 if–
s⁄g
.
gíª
 && *song.genre )

492 
m
.
gíª
 = 
	`åim
(
s⁄g
.genre);

493 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
gíª
, 0)) )

495 
‰ì_Êags
 |
FLAG_GENRE
;

496 
m
.
gíª
 = 
esc_èg
;

499 if–
s⁄g
.
commít
 && *song.comment )

501 
m
.
commít
 = 
	`åim
(
s⁄g
.comment);

502 if–(
esc_èg
 = 
	`esˇ≥_èg
(
m
.
commít
, 0)) )

504 
‰ì_Êags
 |
FLAG_COMMENT
;

505 
m
.
commít
 = 
esc_èg
;

509 
Æbum_¨t
 = 
	`föd_Æbum_¨t
(
∑th
, 
s⁄g
.
image
, s⁄g.
image_size
);

511 
ªt
 = 
	`sql_exec
(
db
, "INSERT into DETAILS"

516 
∑th
, ()
fûe
.
°_size
, fûe.
°_mtime
, 
m
.
duøti⁄
, 
s⁄g
.
ch™√ls
, s⁄g.
bôøã
, s⁄g.
ßm∂î©e
, m.
d©e
,

517 
m
.
tôÀ
, m.
¸ót‹
, m.
¨ti°
, m.
Æbum
, m.
gíª
, m.
commít
, 
s⁄g
.
disc
, s⁄g.
åack
,

518 
m
.
d a_≤
, 
s⁄g
.
mime
?s⁄g.mime:m.mime, 
Æbum_¨t
);

519 if–
ªt
 !
SQLITE_OK
 )

521 
	`Ârötf
(
°dîr
, "Eº‹ in£πög dëaû†f‹ '%s'!\n", 
∑th
);

522 
ªt
 = 0;

526 
ªt
 = 
	`sqlôe3_œ°_ö£π_rowid
(
db
);

528 
	`‰ìègs
(&
s⁄g
);

529 
	`‰ì_mëad©a
(&
m
, 
‰ì_Êags
);

531  
ªt
;

532 
	}
}

535 
jmp_buf
 
	g£tjmp_buf„r
;

537 
	$libj≥g_îr‹_h™dÀr
(
j_comm⁄_±r
 
cöfo
)

539 
cöfo
->
îr
->
	`ouçut_mesßge
 (cinfo);

540 
	`l⁄gjmp
(
£tjmp_buf„r
, 1);

542 
	}
}

544 
öt64_t


545 
	$GëImageMëad©a
(c⁄° *
∑th
, *
«me
)

547 
ExifD©a
 *
ed
;

548 
ExifE¡ry
 *
e
 = 
NULL
;

549 
ExifLﬂdî
 *
l
;

550 
j≥g_decom¥ess_°ru˘
 
cöfo
;

551 
j≥g_îr‹_mgr
 
jîr
;

552 
FILE
 *
öfûe
;

553 
width
=0, 
height
=0, 
thumb
=0;

554 
make
[32], 
modñ
[64] = {'\0'};

555 
b
[1024];

556 
°©
 
fûe
;

557 
tm
 *
modtime
;

558 
öt64_t
 
ªt
;

559 
image_s
 *
im§c
;

560 
mëad©a_t
 
m
;

561 
uöt32_t
 
‰ì_Êags
 = 0xFFFFFFFF;

564 
IMAGE_TYPE_UNKOWN
,

565 
IMAGE_TYPE_JPG
,

566 
IMAGE_TYPE_PNG
,

567 
IMAGE_TYPE_BMP
,

568 
IMAGE_TYPE_GIF
,

569 
IMAGE_TYPE_TIF


570 } 
image_ty≥
 = 
IMAGE_TYPE_UNKOWN
;

572 
	`mem£t
(&
m
, '\0', (
mëad©a_t
));

575 i‡–
	`°©
(
∑th
, &
fûe
) != 0 )

579 i‡(
fûe
.
°_size
 > (10 * 1024 * 1024))

582 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Imagêfûêsizêovî 10M: %s\n", 
∑th
);

586 
	`°rù_ext
(
«me
);

590 if(
	`íds_wôh
(
∑th
, ".jpg") ||Énds_with(path, ".jpeg"))

592 
image_ty≥
 = 
IMAGE_TYPE_JPG
;

593 
m
.
mime
 = 
	`°rdup
("image/jpeg");

595 i‡(
	`íds_wôh
(
∑th
, ".png"))

597 
image_ty≥
 = 
IMAGE_TYPE_PNG
;

598 
m
.
mime
 = 
	`°rdup
("image/png");

600 i‡(
	`íds_wôh
(
∑th
, ".bmp"))

602 
image_ty≥
 = 
IMAGE_TYPE_BMP
;

603 
m
.
mime
 = 
	`°rdup
("image/bmp");

605 i‡(
	`íds_wôh
(
∑th
, ".gif"))

607 
image_ty≥
 = 
IMAGE_TYPE_GIF
;

608 
m
.
mime
 = 
	`°rdup
("image/gif");

610 i‡(
	`íds_wôh
(
∑th
, ".tiff") ||Énds_with(path, ".tif"))

612 
image_ty≥
 = 
IMAGE_TYPE_TIF
;

613 
m
.
mime
 = 
	`°rdup
("image/tif");

617 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Unh™dÀd fûêexãnsi⁄ o¿%s\n", 
∑th
);

622 
no_exifd©a
;

624 
l
 = 
	`exif_lﬂdî_√w
();

625 
	`exif_lﬂdî_wrôe_fûe
(
l
, 
∑th
);

626 
ed
 = 
	`exif_lﬂdî_gë_d©a
(
l
);

627 
	`exif_lﬂdî_uƒef
(
l
);

628 if–!
ed
 )

630 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "gŸÿno_exifd©®⁄ %s\n", 
∑th
);

631 
no_exifd©a
;

634 
e
 = 
	`exif_c⁄ã¡_gë_íåy
 (
ed
->
ifd
[
EXIF_IFD_EXIF
], 
EXIF_TAG_DATE_TIME_ORIGINAL
);

635 if–
e
 || (ê
	`exif_c⁄ã¡_gë_íåy
(
ed
->
ifd
[
EXIF_IFD_EXIF
], 
EXIF_TAG_DATE_TIME_DIGITIZED
)) )

637 
m
.
d©e
 = 
	`°rdup
(
	`exif_íåy_gë_vÆue
(
e
, 
b
, (b)));

638 if–
	`°æí
(
m
.
d©e
) > 10 )

640 
m
.
d©e
[4] = '-';

641 
m
.
d©e
[7] = '-';

642 
m
.
d©e
[10] = 'T';

645 
	`‰ì
(
m
.
d©e
);

646 
m
.
d©e
 = 
NULL
;

651 
	`image_gë_j≥g_d©e_xmp
(
∑th
, &
m
.
d©e
);

655 
e
 = 
	`exif_c⁄ã¡_gë_íåy
(
ed
->
ifd
[
EXIF_IFD_0
], 
EXIF_TAG_MAKE
);

656 if–
e
 )

658 
	`°∫˝yt
(
make
, 
	`exif_íåy_gë_vÆue
(
e
, 
b
, (b)), (make));

659 
e
 = 
	`exif_c⁄ã¡_gë_íåy
(
ed
->
ifd
[
EXIF_IFD_0
], 
EXIF_TAG_MODEL
);

660 if–
e
 )

662 
	`°∫˝yt
(
modñ
, 
	`exif_íåy_gë_vÆue
(
e
, 
b
, (b)), (model));

663 if–!
	`°rˇ£°r
(
modñ
, 
make
) )

664 
	`¢¥ötf
(
modñ
, (modñ), "%†%s", 
make
, 
	`exif_íåy_gë_vÆue
(
e
, 
b
, (b)));

665 
m
.
¸ót‹
 = 
	`esˇ≥_èg
(
	`åim
(
modñ
), 1);

670 
e
 = 
	`exif_c⁄ã¡_gë_íåy
(
ed
->
ifd
[
EXIF_IFD_0
], 
EXIF_TAG_ORIENTATION
);

671 if–
e
 )

673 
rŸ©e
;

674  
	`exif_gë_sh‹t
(
e
->
d©a
, 
	`exif_d©a_gë_byã_‹dî
(
ed
)) )

677 
rŸ©e
 = 180;

680 
rŸ©e
 = 90;

683 
rŸ©e
 = 270;

686 
rŸ©e
 = 0;

689 if–
rŸ©e
 )

690 
	`xa•rötf
(&
m
.
rŸ©i⁄
, "%d", 
rŸ©e
);

693 if–
ed
->
size
 )

696 if–
ed
->
size
 > 12000 )

698 
im§c
 = 
	`image_√w_‰om_j≥g
(
NULL
, 0, (*)
ed
->
d©a
,Éd->
size
, 1, 
ROTATE_NONE
);

699 if–
im§c
 )

701 if–(
im§c
->
width
 <160Ë&& (im§c->
height
 <= 160) )

702 
thumb
 = 1;

703 
	`image_‰ì
(
im§c
);

707 
thumb
 = 1;

711 
	`exif_d©a_uƒef
(
ed
);

713 
no_exifd©a
:

715 
image_ty≥
)

717 
IMAGE_TYPE_JPG
:

719 i‡–
	`image_gë_j≥g_ªsﬁuti⁄
(
∑th
, &
width
, &
height
) != 0 || !width || !height )

721 
öfûe
 = 
	`f›í
(
∑th
, "r");

722 if–
öfûe
 )

724 
cöfo
.
îr
 = 
	`j≥g_°d_îr‹
(&
jîr
);

725 
jîr
.
îr‹_exô
 = 
libj≥g_îr‹_h™dÀr
;

726 
	`j≥g_¸óã_decom¥ess
(&
cöfo
);

727 if–
	`£tjmp
(
£tjmp_buf„r
) )

729 
îr‹
;

731 
	`j≥g_°dio_§c
(&
cöfo
, 
öfûe
);

732 
	`j≥g_ªad_hódî
(&
cöfo
, 
TRUE
);

733 
	`j≥g_°¨t_decom¥ess
(&
cöfo
);

734 
width
 = 
cöfo
.
ouçut_width
;

735 
height
 = 
cöfo
.
ouçut_height
;

736 
îr‹
:

737 
	`j≥g_de°roy_decom¥ess
(&
cöfo
);

738 
	`f˛o£
(
öfûe
);

741 i‡(
width
 > 0 && 
height
 > 0)

743 i‡(
width
 <48 && 
height
 <= 48)

744 
m
.
d a_≤
 = 
	`°rdup
("JPEG_SM_ICO");

745 i‡(
width
 <120 && 
height
 <= 120)

746 
m
.
d a_≤
 = 
	`°rdup
("JPEG_LRG_ICO");

747 i‡(
width
 <160 && 
height
 <= 160)

748 
m
.
d a_≤
 = 
	`°rdup
("JPEG_TN");

749 if–
width
 <640 && 
height
 <= 480 )

750 
m
.
d a_≤
 = 
	`°rdup
("JPEG_SM");

751 if–
width
 <1024 && 
height
 <= 768 )

752 
m
.
d a_≤
 = 
	`°rdup
("JPEG_MED");

753 if–(
width
 <4096 && 
height
 <4096Ë|| !
	`GETFLAG
(
DLNA_STRICT_MASK
) )

754 
m
.
d a_≤
 = 
	`°rdup
("JPEG_LRG");

760 
IMAGE_TYPE_TIF
:

762 
TIFF
 *
tif
 = 
NULL
;

764 
tif
 = 
	`TIFFO≥n
(
∑th
, "r");

765 i‡(!
tif
)

767 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "TIFFO≥¿%†Áûed!\n", 
∑th
);

768 
out
;

771 i‡(!
	`TIFFGëFõld
(
tif
, 
TIFFTAG_IMAGEWIDTH
, &
width
) ||

772 !
	`TIFFGëFõld
(
tif
, 
TIFFTAG_IMAGELENGTH
, &
height
))

774 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "TIFFGëFõld(WIDTH, HEIGHTË%†Áûed!\n", 
∑th
);

775 
	`TIFFClo£
(
tif
);

776 
out
;

779 
	`TIFFClo£
(
tif
);

783 
IMAGE_TYPE_PNG
:

784 
IMAGE_TYPE_BMP
:

785 
IMAGE_TYPE_GIF
:

787 
AVF‹m©C⁄ãxt
 *
˘x
 = 
NULL
;

788 
AVCodecC⁄ãxt
 *
vc
 = 
NULL
;

789 
video_°ªam
 = -1;

790 
i
;

792 
ªt
 = 
	`œv_›í
(&
˘x
, 
∑th
);

793 if–
ªt
 != 0 )

795 
îr
[128];

797 
	`av_°ªº‹
(
ªt
, 
îr
, (err));

798 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "O≥nög %†Áûed! [%s]\n", 
∑th
, 
îr
);

799 
out
;

802 
i
 = 0; i < 
˘x
->
nb_°ªams
; i++)

804 i‡(
video_°ªam
 =-1 && 
˘x
->
°ªams
[
i
]->
codec
->
codec_ty≥
 =
AVMEDIA_TYPE_VIDEO
)

806 
video_°ªam
 = 
i
;

807 
vc
 = 
˘x
->
°ªams
[
video_°ªam
]->
codec
;

813 i‡(!
vc
)

815 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "%s\n", 
∑th
);

816 
	`œv_˛o£
(
˘x
);

817 
out
;

820 i‡(
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "image2") != 0)

822 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "%s\n", 
∑th
);

823 
	`œv_˛o£
(
˘x
);

824 
out
;

827 
width
 = 
vc
->width;

828 
height
 = 
vc
->height;

829 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "width: %d, height: %d\n", 
width
, 
height
);

830 i‡(
vc
->
codec_id
 =
CODEC_ID_PNG
)

832 i‡(
width
 <48 && 
height
 <= 48)

834 
m
.
d a_≤
 = 
	`°rdup
("PNG_SM_ICO");

836 i‡(
width
 <120 && 
height
 <= 120)

838 
m
.
d a_≤
 = 
	`°rdup
("PNG_LRG_ICO");

840 i‡(
width
 <160 && 
height
 <= 160)

842 
m
.
d a_≤
 = 
	`°rdup
("PNG_TN");

844 i‡(
width
 <4096 && 
height
 <= 4096)

846 
m
.
d a_≤
 = 
	`°rdup
("PNG_LRG");

849 i‡(
vc
->
codec_id
 =
CODEC_ID_GIF
)

851 i‡(
width
 <1600 && 
height
 <= 1200)

853 
m
.
d a_≤
 = 
	`°rdup
("GIF_LRG");

857 
	`œv_˛o£
(
˘x
);

869 
out
:

870 if–!
width
 || !
height
 )

872 
	`‰ì_mëad©a
(&
m
, 
‰ì_Êags
);

875 
	`xa•rötf
(&
m
.
ªsﬁuti⁄
, "%dx%d", 
width
, 
height
);

877 i‡(
m
.
d a_≤
 =
NULL
)

879 
m
.
d a_≤
 = 
	`°rdup
(
	`mime_to_ext
(m.
mime
));

881 if–!
m
.
d©e
 )

883 
m
.
d©e
 = 
	`mÆloc
(20);

884 
modtime
 = 
	`loˇ…ime
(&
fûe
.
°_mtime
);

885 
	`°r·ime
(
m
.
d©e
, 20, "%FT%T", 
modtime
);

888 
ªt
 = 
	`sql_exec
(
db
, "INSERT into DETAILS "

893 
∑th
, 
«me
, ()
fûe
.
°_size
, fûe.
°_mtime
, 
m
.
d©e
, m.
ªsﬁuti⁄
,

894 
m
.
rŸ©i⁄
, 
thumb
, m.
¸ót‹
, m.
d a_≤
, m.
mime
);

895 if–
ªt
 !
SQLITE_OK
 )

897 
	`Ârötf
(
°dîr
, "Eº‹ in£πög dëaû†f‹ '%s'!\n", 
∑th
);

898 
ªt
 = 0;

902 
ªt
 = 
	`sqlôe3_œ°_ö£π_rowid
(
db
);

904 
	`‰ì_mëad©a
(&
m
, 
‰ì_Êags
);

906  
ªt
;

907 
	}
}

909 
öt64_t


910 
	$GëVideoMëad©a
(c⁄° *
∑th
, *
«me
)

912 
°©
 
fûe
;

913 
ªt
, 
i
;

914 
tm
 *
modtime
;

915 
AVF‹m©C⁄ãxt
 *
˘x
 = 
NULL
;

916 
AVCodecC⁄ãxt
 *
ac
 = 
NULL
, *
vc
 = NULL;

917 
audio_°ªam
 = -1, 
video_°ªam
 = -1;

918 
audio_¥ofûes
 
audio_¥ofûe
 = 
PROFILE_AUDIO_UNKNOWN
;

919 
fourcc
[4];

920 
öt64_t
 
Æbum_¨t
 = 0;

921 
nfo
[
MAXPATHLEN
], *
ext
;

922 
s⁄g_mëad©a
 
video
;

923 
mëad©a_t
 
m
;

924 
uöt32_t
 
‰ì_Êags
 = 0xFFFFFFFF;

925 *
∑th_˝y
 = 
NULL
;

926 *
ba£∑th
 = 
NULL
;

928 
	`mem£t
(&
m
, '\0', (m));

929 
	`mem£t
(&
video
, '\0', (video));

932 i‡–
	`°©
(
∑th
, &
fûe
) != 0 )

934 
	`°rù_ext
(
«me
);

937 
ªt
 = 
	`œv_›í
(&
˘x
, 
∑th
);

938 if–
ªt
 != 0 )

940 
îr
[128];

941 
	`av_°ªº‹
(
ªt
, 
îr
, (err));

942 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "O≥nög %†Áûed! [%s]\n", 
∑th
, 
îr
);

946  
i
=0; i<
˘x
->
nb_°ªams
; i++)

948 if–
audio_°ªam
 == -1 &&

949 
˘x
->
°ªams
[
i
]->
codec
->
codec_ty≥
 =
AVMEDIA_TYPE_AUDIO
 )

951 
audio_°ªam
 = 
i
;

952 
ac
 = 
˘x
->
°ªams
[
audio_°ªam
]->
codec
;

955 if–
video_°ªam
 == -1 &&

956 
˘x
->
°ªams
[
i
]->
codec
->
codec_ty≥
 =
AVMEDIA_TYPE_VIDEO
 )

958 
video_°ªam
 = 
i
;

959 
vc
 = 
˘x
->
°ªams
[
video_°ªam
]->
codec
;

963 
∑th_˝y
 = 
	`°rdup
(
∑th
);

964 
ba£∑th
 = 
	`ba£«me
(
∑th_˝y
);

965 if–!
vc
 )

968 
	`œv_˛o£
(
˘x
);

969 if–!
	`is_audio
(
∑th
) )

970 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Fûê%†d€†nŸ c⁄èöá videÿ°ªam.\n", 
ba£∑th
);

971 
	`‰ì
(
∑th_˝y
);

975 if–
ac
 )

977 
Øc_obje˘_ty≥_t
 
Øc_ty≥
 = 
AAC_INVALID
;

978  
ac
->
codec_id
 )

980 
CODEC_ID_MP3
:

981 
audio_¥ofûe
 = 
PROFILE_AUDIO_MP3
;

983 
CODEC_ID_AAC
:

984 if–!
ac
->
exåad©a_size
 ||

985 !
ac
->
exåad©a
 )

987 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No AACÅype\n");

991 
uöt8_t
 
d©a
;

992 
	`mem˝y
(&
d©a
, 
ac
->
exåad©a
, 1);

993 
Øc_ty≥
 = 
d©a
 >> 3;

995  
Øc_ty≥
 )

998 
AAC_LC
:

999 
AAC_LC_ER
:

1000 if–
ac
->
ßm∂e_øã
 < 8000 ||

1001 
ac
->
ßm∂e_øã
 > 48000 )

1003 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported AAC: sampleÑate isÇot 8000 < %d < 48000\n",

1004 
ac
->
ßm∂e_øã
);

1008 if–
ac
->
ch™√ls
 <= 2 &&

1009 
ac
->
bô_øã
 <= 576000 )

1010 
audio_¥ofûe
 = 
PROFILE_AUDIO_AAC
;

1011 if–
ac
->
ch™√ls
 <= 6 &&

1012 
ac
->
bô_øã
 <= 1440000 )

1013 
audio_¥ofûe
 = 
PROFILE_AUDIO_AAC_MULT5
;

1015 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unhandled AAC: %d channels, %d bitrate\n",

1016 
ac
->
ch™√ls
,

1017 
ac
->
bô_øã
);

1020 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unh™dÀd AACÅy≥ [%d]\n", 
Øc_ty≥
);

1024 
CODEC_ID_AC3
:

1025 
CODEC_ID_DTS
:

1026 
audio_¥ofûe
 = 
PROFILE_AUDIO_AC3
;

1028 
CODEC_ID_WMAV1
:

1029 
CODEC_ID_WMAV2
:

1031 i‡–
ac
->
bô_øã
 <= 193000 )

1032 
audio_¥ofûe
 = 
PROFILE_AUDIO_WMA_BASE
;

1034 i‡–
ac
->
bô_øã
 <= 385000 )

1035 
audio_¥ofûe
 = 
PROFILE_AUDIO_WMA_FULL
;

1037 #i‡
LIBAVCODEC_VERSION_INT
 > ((51<<16)+(50<<8)+1)

1038 
CODEC_ID_WMAPRO
:

1039 
audio_¥ofûe
 = 
PROFILE_AUDIO_WMA_PRO
;

1042 
CODEC_ID_MP2
:

1043 
audio_¥ofûe
 = 
PROFILE_AUDIO_MP2
;

1045 
CODEC_ID_AMR_NB
:

1046 
audio_¥ofûe
 = 
PROFILE_AUDIO_AMR
;

1049 if–(
ac
->
codec_id
 >
CODEC_ID_PCM_S16LE
) &&

1050 (
ac
->
codec_id
 < 
CODEC_ID_ADPCM_IMA_QT
) )

1051 
audio_¥ofûe
 = 
PROFILE_AUDIO_PCM
;

1053 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unh™dÀdáudiÿcode¯[0x%X]\n", 
ac
->
codec_id
);

1056 
	`xa•rötf
(&
m
.
‰equícy
, "%u", 
ac
->
ßm∂e_øã
);

1057 #i‡
LIBAVCODEC_VERSION_INT
 < (52<<16)

1058 
	`xa•rötf
(&
m
.
bps
, "%u", 
ac
->
bôs_≥r_ßm∂e
);

1060 
	`xa•rötf
(&
m
.
bps
, "%u", 
ac
->
bôs_≥r_coded_ßm∂e
);

1062 
	`xa•rötf
(&
m
.
ch™√ls
, "%u", 
ac
->channels);

1065 if–
vc
 )

1067 
off
;

1068 
duøti⁄
, 
hours
, 
mö
, 
£c
, 
ms
;

1069 
ts_time°amp_t
 
ts_time°amp
 = 
NONE
;

1070 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "C⁄èöî: '%s' [%s]\n", 
˘x
->
if‹m©
->
«me
, 
ba£∑th
);

1071 
	`xa•rötf
(&
m
.
ªsﬁuti⁄
, "%dx%d", 
vc
->
width
, vc->
height
);

1072 if–
˘x
->
bô_øã
 > 8 )

1073 
	`xa•rötf
(&
m
.
bôøã
, "%u", 
˘x
->
bô_øã
 / 8);

1074 if–
˘x
->
duøti⁄
 > 0 ) {

1075 
duøti⁄
 = ()(
˘x
->duøti⁄ / 
AV_TIME_BASE
);

1076 
hours
 = ()(
duøti⁄
 / 3600);

1077 
mö
 = ()(
duøti⁄
 / 60 % 60);

1078 
£c
 = ()(
duøti⁄
 % 60);

1079 
ms
 = ()(
˘x
->
duøti⁄
 / (
AV_TIME_BASE
/1000) % 1000);

1080 
	`xa•rötf
(&
m
.
duøti⁄
, "%d:%02d:%02d.%03d", 
hours
, 
mö
, 
£c
, 
ms
);

1085 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "avi") == 0 )

1087 
	`xa•rötf
(&
m
.
mime
, "video/x-msvideo");

1088 if–
vc
->
codec_id
 =
CODEC_ID_MPEG4
 )

1090 
fourcc
[0] = 
vc
->
codec_èg
 & 0xff;

1091 
fourcc
[1] = 
vc
->
codec_èg
>>8 & 0xff;

1092 
fourcc
[2] = 
vc
->
codec_èg
>>16 & 0xff;

1093 
fourcc
[3] = 
vc
->
codec_èg
>>24 & 0xff;

1094 if–
	`memcmp
(
fourcc
, "XVID", 4) == 0 ||

1095 
	`memcmp
(
fourcc
, "DX50", 4) == 0 ||

1096 
	`memcmp
(
fourcc
, "DIVX", 4) == 0 )

1097 
	`xa•rötf
(&
m
.
¸ót‹
, "DiVX");

1100 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mov,mp4,m4a,3gp,3g2,mj2") == 0 &&

1101 
	`íds_wôh
(
∑th
, ".mov") )

1102 
	`xa•rötf
(&
m
.
mime
, "video/quicktime");

1103 if–
	`°∫cmp
(
˘x
->
if‹m©
->
«me
, "matroska", 8) == 0 )

1104 
	`xa•rötf
(&
m
.
mime
, "video/x-matroska");

1105 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "flv") == 0 )

1106 
	`xa•rötf
(&
m
.
mime
, "video/x-flv");

1107 i‡(
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "rm") == 0)

1108 
	`xa•rötf
(&
m
.
mime
, "video/x-rmvb");

1110 if–
m
.
mime
 )

1112 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "C⁄èöî: %†[%s]\n", 
m
.
mime
, 
ba£∑th
);

1113 
video_no_d a
;

1116  
vc
->
codec_id
 )

1118 
CODEC_ID_MPEG1VIDEO
:

1119 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mpeg") == 0 )

1121 if–(
vc
->
width
 == 352) &&

1122 (
vc
->
height
 <= 288) )

1124 
m
.
d a_≤
 = 
	`°rdup
("MPEG1");

1126 
	`xa•rötf
(&
m
.
mime
, "video/mpeg");

1129 
CODEC_ID_MPEG2VIDEO
:

1130 
m
.
d a_≤
 = 
	`mÆloc
(64);

1131 
off
 = 
	`•rötf
(
m
.
d a_≤
, "MPEG_");

1132 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mpegts") == 0 )

1134 
øw_∑ckë_size
;

1135 
d a_ts_¥e£¡
 = 
	`d a_time°amp_is_¥e£¡
(
∑th
, &
øw_∑ckë_size
);

1136 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Stream %d of %s is %s MPEG2 TSÖacket size %d\n",

1137 
video_°ªam
, 
ba£∑th
, 
m
.
ªsﬁuti⁄
, 
øw_∑ckë_size
);

1138 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "TS_");

1139 if–(
vc
->
width
 >= 1280) &&

1140 (
vc
->
height
 >= 720) )

1142 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_NA");

1146 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "SD_");

1147 if–(
vc
->
height
 == 576) ||

1148 (
vc
->
height
 == 288) )

1149 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "EU");

1151 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "NA");

1153 if–
øw_∑ckë_size
 =
MPEG_TS_PACKET_LENGTH_DLNA
 )

1155 i‡(
d a_ts_¥e£¡
)

1156 
ts_time°amp
 = 
VALID
;

1158 
ts_time°amp
 = 
EMPTY
;

1160 if–
øw_∑ckë_size
 !
MPEG_TS_PACKET_LENGTH
 )

1162 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported DLNA TSÖacket size [%d] (%s)\n",

1163 
øw_∑ckë_size
, 
ba£∑th
);

1164 
	`‰ì
(
m
.
d a_≤
);

1165 
m
.
d a_≤
 = 
NULL
;

1167  
ts_time°amp
 )

1169 
NONE
:

1170 
	`xa•rötf
(&
m
.
mime
, "video/mpeg");

1171 if–
m
.
d a_≤
 )

1172 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "_ISO");

1174 
VALID
:

1175 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "_T");

1176 
EMPTY
:

1177 
	`xa•rötf
(&
m
.
mime
, "video/vnd.dlna.mpeg-tts");

1182 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mpeg") == 0 )

1184 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Stream %d of %s is %s MPEG2 PS\n",

1185 
video_°ªam
, 
ba£∑th
, 
m
.
ªsﬁuti⁄
);

1186 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "PS_");

1187 if–(
vc
->
height
 == 576) ||

1188 (
vc
->
height
 == 288) )

1189 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "PAL");

1191 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "NTSC");

1192 
	`xa•rötf
(&
m
.
mime
, "video/mpeg");

1196 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Stream %d of %s [%s] is %sÇon-DLNA MPEG2\n",

1197 
video_°ªam
, 
ba£∑th
, 
˘x
->
if‹m©
->
«me
, 
m
.
ªsﬁuti⁄
);

1198 
	`‰ì
(
m
.
d a_≤
);

1199 
m
.
d a_≤
 = 
NULL
;

1202 
CODEC_ID_H264
:

1203 
m
.
d a_≤
 = 
	`mÆloc
(128);

1204 
off
 = 
	`•rötf
(
m
.
d a_≤
, "AVC_");

1206 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mpegts") == 0 )

1208 
AVR©i⁄Æ
 
di•œy_a•e˘_øtio
;

1209 
Âs
, 
öãæa˚d
;

1210 
øw_∑ckë_size
;

1211 
d a_ts_¥e£¡
 = 
	`d a_time°amp_is_¥e£¡
(
∑th
, &
øw_∑ckë_size
);

1213 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "TS_");

1214 i‡(
vc
->
ßm∂e_a•e˘_øtio
.
num
) {

1215 
	`av_ªdu˚
(&
di•œy_a•e˘_øtio
.
num
, &di•œy_a•e˘_øtio.
dí
,

1216 
vc
->
width
 * vc->
ßm∂e_a•e˘_øtio
.
num
,

1217 
vc
->
height
 * vc->
ßm∂e_a•e˘_øtio
.
dí
,

1220 i‡(
˘x
->
°ªams
[
video_°ªam
]->
r_‰ame_øã
.
dí
)

1221 
Âs
 = 
˘x
->
°ªams
[
video_°ªam
]->
r_‰ame_øã
.
num
 / ctx->°ªams[video_°ªam]->r_‰ame_øã.
dí
;

1223 
Âs
 = 0;

1224 
öãæa˚d
 = 
vc
->
time_ba£
.
dí
 ? (
˘x
->
°ªams
[
video_°ªam
]->
r_‰ame_øã
.
num
 / vc->time_base.den) : 0;

1225 if–((((
vc
->
width
 =1920 || vc->width =1440Ë&& vc->
height
 == 1080) ||

1226 (
vc
->
width
 =720 && vc->
height
 =480)Ë&& 
Âs
 =59 && 
öãæa˚d
) ||

1227 ((
vc
->
width
 =1280 && vc->
height
 =720Ë&& 
Âs
 =59 && !
öãæa˚d
) )

1229 if–(
vc
->
¥ofûe
 =
FF_PROFILE_H264_MAIN
 || vc->¥ofûê=
FF_PROFILE_H264_HIGH
) &&

1230 
audio_¥ofûe
 =
PROFILE_AUDIO_AC3
 )

1232 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_60_");

1233 
vc
->
¥ofûe
 = 
FF_PROFILE_SKIP
;

1236 if–((
vc
->
width
 =1920 && vc->
height
 == 1080) ||

1237 (
vc
->
width
 =1440 && vc->
height
 == 1080) ||

1238 (
vc
->
width
 =1280 && vc->
height
 == 720) ||

1239 (
vc
->
width
 =720 && vc->
height
 == 576)) &&

1240 
öãæa˚d
 && 
Âs
 == 50 )

1242 if–(
vc
->
¥ofûe
 =
FF_PROFILE_H264_MAIN
 || vc->¥ofûê=
FF_PROFILE_H264_HIGH
) &&

1243 
audio_¥ofûe
 =
PROFILE_AUDIO_AC3
 )

1245 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_50_");

1246 
vc
->
¥ofûe
 = 
FF_PROFILE_SKIP
;

1249  
vc
->
¥ofûe
 )

1251 
FF_PROFILE_H264_BASELINE
:

1252 
FF_PROFILE_H264_CONSTRAINED_BASELINE
:

1253 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_");

1254 if–
vc
->
width
 <= 352 &&

1255 
vc
->
height
 <= 288 &&

1256 
vc
->
bô_øã
 <= 384000 )

1258 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "CIF15_");

1261 if–
vc
->
width
 <= 352 &&

1262 
vc
->
height
 <= 288 &&

1263 
vc
->
bô_øã
 <= 3000000 )

1265 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "CIF30_");

1270 
off
 -= 3;

1272 
FF_PROFILE_H264_MAIN
:

1273 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP_");

1274 if–
vc
->
¥ofûe
 !
FF_PROFILE_H264_BASELINE
 &&

1275 
vc
->
¥ofûe
 !
FF_PROFILE_H264_CONSTRAINED_BASELINE
 &&

1276 
vc
->
¥ofûe
 !
FF_PROFILE_H264_MAIN
 )

1278 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unknown AVCÖrofile %d;ássuming MP. [%s]\n",

1279 
vc
->
¥ofûe
, 
ba£∑th
);

1281 if–
vc
->
width
 <= 720 &&

1282 
vc
->
height
 <= 576 &&

1283 
vc
->
bô_øã
 <= 10000000 )

1285 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "SD_");

1287 if–
vc
->
width
 <= 1920 &&

1288 
vc
->
height
 <= 1152 &&

1289 
vc
->
bô_øã
 <= 20000000 )

1291 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_");

1295 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported h.264 videoÖrofile! [%s, %dx%d, %dbps : %s]\n",

1296 
m
.
d a_≤
, 
vc
->
width
, vc->
height
, vc->
bô_øã
, 
ba£∑th
);

1297 
	`‰ì
(
m
.
d a_≤
);

1298 
m
.
d a_≤
 = 
NULL
;

1301 
FF_PROFILE_H264_HIGH
:

1302 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HP_");

1303 if–
vc
->
width
 <= 1920 &&

1304 
vc
->
height
 <= 1152 &&

1305 
vc
->
bô_øã
 <= 30000000 &&

1306 
audio_¥ofûe
 =
PROFILE_AUDIO_AC3
 )

1308 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_");

1312 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported h.264 HP videoÖrofile! [%dbps, %dáudio : %s]\n",

1313 
vc
->
bô_øã
, 
audio_¥ofûe
, 
ba£∑th
);

1314 
	`‰ì
(
m
.
d a_≤
);

1315 
m
.
d a_≤
 = 
NULL
;

1318 
FF_PROFILE_SKIP
:

1321 if–!
m
.
d a_≤
 )

1323  
audio_¥ofûe
 )

1325 
PROFILE_AUDIO_MP3
:

1326 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MPEG1_L3");

1328 
PROFILE_AUDIO_AC3
:

1329 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AC3");

1331 
PROFILE_AUDIO_AAC
:

1332 
PROFILE_AUDIO_AAC_MULT5
:

1333 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AAC_MULT5");

1336 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for %s file [%s]\n",

1337 
m
.
d a_≤
, 
ba£∑th
);

1338 
	`‰ì
(
m
.
d a_≤
);

1339 
m
.
d a_≤
 = 
NULL
;

1342 if–!
m
.
d a_≤
 )

1344 if–
øw_∑ckë_size
 =
MPEG_TS_PACKET_LENGTH_DLNA
 )

1346 if–
vc
->
¥ofûe
 =
FF_PROFILE_H264_HIGH
 ||

1347 
d a_ts_¥e£¡
 )

1348 
ts_time°amp
 = 
VALID
;

1350 
ts_time°amp
 = 
EMPTY
;

1352 if–
øw_∑ckë_size
 !
MPEG_TS_PACKET_LENGTH
 )

1354 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported DLNA TSÖacket size [%d] (%s)\n",

1355 
øw_∑ckë_size
, 
ba£∑th
);

1356 
	`‰ì
(
m
.
d a_≤
);

1357 
m
.
d a_≤
 = 
NULL
;

1359  
ts_time°amp
 )

1361 
NONE
:

1362 if–
m
.
d a_≤
 )

1363 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "_ISO");

1365 
VALID
:

1366 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "_T");

1367 
EMPTY
:

1368 
	`xa•rötf
(&
m
.
mime
, "video/vnd.dlna.mpeg-tts");

1373 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mov,mp4,m4a,3gp,3g2,mj2") == 0 )

1375 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP4_");

1377  
vc
->
¥ofûe
 ) {

1378 
FF_PROFILE_H264_BASELINE
:

1379 
FF_PROFILE_H264_CONSTRAINED_BASELINE
:

1380 if–
vc
->
width
 <= 352 &&

1381 
vc
->
height
 <= 288 )

1383 if–
˘x
->
bô_øã
 < 600000 )

1384 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_CIF15_");

1385 if–
˘x
->
bô_øã
 < 5000000 )

1386 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_CIF30_");

1388 
mp4_mp_ÁŒback
;

1390 if–
audio_¥ofûe
 =
PROFILE_AUDIO_AMR
 )

1392 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AMR");

1394 if–
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1396 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AAC_");

1397 if–
˘x
->
bô_øã
 < 520000 )

1399 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "520");

1401 if–
˘x
->
bô_øã
 < 940000 )

1403 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "940");

1407 
off
 -= 13;

1408 
mp4_mp_ÁŒback
;

1413 
off
 -= 9;

1414 
mp4_mp_ÁŒback
;

1417 if–
vc
->
width
 <= 720 &&

1418 
vc
->
height
 <= 576 )

1420 if–
vc
->
Àvñ
 == 30 &&

1421 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 &&

1422 
˘x
->
bô_øã
 <= 5000000 )

1423 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_L3L_SD_AAC");

1424 if–
vc
->
Àvñ
 <= 31 &&

1425 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 &&

1426 
˘x
->
bô_øã
 <= 15000000 )

1427 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_L31_HD_AAC");

1429 
mp4_mp_ÁŒback
;

1431 if–
vc
->
width
 <= 1280 &&

1432 
vc
->
height
 <= 720 )

1434 if–
vc
->
Àvñ
 <= 31 &&

1435 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 &&

1436 
˘x
->
bô_øã
 <= 15000000 )

1437 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_L31_HD_AAC");

1438 if–
vc
->
Àvñ
 <= 32 &&

1439 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 &&

1440 
˘x
->
bô_øã
 <= 21000000 )

1441 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BL_L32_HD_AAC");

1443 
mp4_mp_ÁŒback
;

1446 
mp4_mp_ÁŒback
;

1448 
FF_PROFILE_H264_MAIN
:

1449 
mp4_mp_ÁŒback
:

1450 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP_");

1452 if–
vc
->
width
 <= 720 &&

1453 
vc
->
height
 <= 576 &&

1454 
vc
->
bô_øã
 <= 10000000 )

1456 
	`•rötf
(
m
.
d a_≤
+
off
, "SD_");

1457 if–
audio_¥ofûe
 =
PROFILE_AUDIO_AC3
 )

1458 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AC3");

1459 if–
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 ||

1460 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC_MULT5
 )

1461 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "AAC_MULT5");

1462 if–
audio_¥ofûe
 =
PROFILE_AUDIO_MP3
 )

1463 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MPEG1_L3");

1465 
m
.
d a_≤
[10] = '\0';

1467 if–
vc
->
width
 <= 1280 &&

1468 
vc
->
height
 <= 720 &&

1469 
vc
->
bô_øã
 <= 15000000 &&

1470 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1472 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_720p_AAC");

1474 if–
vc
->
width
 <= 1920 &&

1475 
vc
->
height
 <= 1080 &&

1476 
vc
->
bô_øã
 <= 21000000 &&

1477 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1479 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HD_1080i_AAC");

1481 if–
	`°æí
(
m
.
d a_≤
) <= 11 )

1483 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for %s file %s\n",

1484 
m
.
d a_≤
, 
ba£∑th
);

1485 
	`‰ì
(
m
.
d a_≤
);

1486 
m
.
d a_≤
 = 
NULL
;

1489 
FF_PROFILE_H264_HIGH
:

1490 if–
vc
->
width
 <= 1920 &&

1491 
vc
->
height
 <= 1080 &&

1492 
vc
->
bô_øã
 <= 25000000 &&

1493 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1495 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HP_HD_AAC");

1499 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "AVCÖrofile [%d]ÇotÑecognized for file %s\n",

1500 
vc
->
¥ofûe
, 
ba£∑th
);

1501 
	`‰ì
(
m
.
d a_≤
);

1502 
m
.
d a_≤
 = 
NULL
;

1508 
	`‰ì
(
m
.
d a_≤
);

1509 
m
.
d a_≤
 = 
NULL
;

1511 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Såóm %d o‡%†i†h.264\n", 
video_°ªam
, 
ba£∑th
);

1513 
CODEC_ID_MPEG4
:

1514 
fourcc
[0] = 
vc
->
codec_èg
 & 0xff;

1515 
fourcc
[1] = 
vc
->
codec_èg
>>8 & 0xff;

1516 
fourcc
[2] = 
vc
->
codec_èg
>>16 & 0xff;

1517 
fourcc
[3] = 
vc
->
codec_èg
>>24 & 0xff;

1518 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Stream %d of %s is MPEG4 [%c%c%c%c/0x%X]\n",

1519 
video_°ªam
, 
ba£∑th
,

1520 
	`i•röt
(
fourcc
[0]) ? fourcc[0] : '_',

1521 
	`i•röt
(
fourcc
[1]) ? fourcc[1] : '_',

1522 
	`i•röt
(
fourcc
[2]) ? fourcc[2] : '_',

1523 
	`i•röt
(
fourcc
[3]) ? fourcc[3] : '_',

1524 
vc
->
codec_èg
);

1526 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mov,mp4,m4a,3gp,3g2,mj2") == 0 )

1528 
m
.
d a_≤
 = 
	`mÆloc
(128);

1529 
off
 = 
	`•rötf
(
m
.
d a_≤
, "MPEG4_P2_");

1531 if–
	`íds_wôh
(
∑th
, ".3gp") )

1533 
	`xa•rötf
(&
m
.
mime
, "video/3gpp");

1534  
audio_¥ofûe
 )

1536 
PROFILE_AUDIO_AAC
:

1537 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "3GPP_SP_L0B_AAC");

1539 
PROFILE_AUDIO_AMR
:

1540 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "3GPP_SP_L0B_AMR");

1543 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for MPEG4-P2 3GP/0x%X file %s\n",

1544 
ac
->
codec_id
, 
ba£∑th
);

1545 
	`‰ì
(
m
.
d a_≤
);

1546 
m
.
d a_≤
 = 
NULL
;

1552 if–
˘x
->
bô_øã
 <= 1000000 &&

1553 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1555 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP4_ASP_AAC");

1557 if–
˘x
->
bô_øã
 <= 4000000 &&

1558 
vc
->
width
 <= 640 &&

1559 
vc
->
height
 <= 480 &&

1560 
audio_¥ofûe
 =
PROFILE_AUDIO_AAC
 )

1562 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP4_SP_VGA_AAC");

1566 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported h.264 videoÖrofile! [%dx%d, %dbps]\n",

1567 
vc
->
width
,

1568 
vc
->
height
,

1569 
˘x
->
bô_øã
);

1570 
	`‰ì
(
m
.
d a_≤
);

1571 
m
.
d a_≤
 = 
NULL
;

1576 
CODEC_ID_WMV3
:

1578 if–
vc
->
exåad©a_size
 > 0 )

1580 if–!((
vc
->
exåad©a
[0] >> 3) & 1) )

1581 
vc
->
Àvñ
 = 0;

1582 if–!((
vc
->
exåad©a
[0] >> 6) & 1) )

1583 
vc
->
¥ofûe
 = 0;

1585 
CODEC_ID_VC1
:

1586 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "asf") != 0 )

1588 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Skùpög DLNAÖ¨sög f‹Ç⁄-ASF VC1 fûê%s\n", 
∑th
);

1591 
m
.
d a_≤
 = 
	`mÆloc
(64);

1592 
off
 = 
	`•rötf
(
m
.
d a_≤
, "WMV");

1593 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Såóm %d o‡%†i†VC1\n", 
video_°ªam
, 
ba£∑th
);

1594 
	`xa•rötf
(&
m
.
mime
, "video/x-ms-wmv");

1595 if–(
vc
->
width
 <= 176) &&

1596 (
vc
->
height
 <= 144) &&

1597 (
vc
->
Àvñ
 == 0) )

1599 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "SPLL_");

1600  
audio_¥ofûe
 )

1602 
PROFILE_AUDIO_MP3
:

1603 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP3");

1605 
PROFILE_AUDIO_WMA_BASE
:

1606 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BASE");

1609 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for WMVSPLL/0x%X file %s\n",

1610 
audio_¥ofûe
, 
ba£∑th
);

1611 
	`‰ì
(
m
.
d a_≤
);

1612 
m
.
d a_≤
 = 
NULL
;

1616 if–(
vc
->
width
 <= 352) &&

1617 (
vc
->
height
 <= 288) &&

1618 (
vc
->
¥ofûe
 == 0) &&

1619 (
˘x
->
bô_øã
/8 <= 384000) )

1621 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "SPML_");

1622  
audio_¥ofûe
 )

1624 
PROFILE_AUDIO_MP3
:

1625 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MP3");

1627 
PROFILE_AUDIO_WMA_BASE
:

1628 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BASE");

1631 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for WMVSPML/0x%X file %s\n",

1632 
audio_¥ofûe
, 
ba£∑th
);

1633 
	`‰ì
(
m
.
d a_≤
);

1634 
m
.
d a_≤
 = 
NULL
;

1638 if–(
vc
->
width
 <= 720) &&

1639 (
vc
->
height
 <= 576) &&

1640 (
˘x
->
bô_øã
/8 <= 10000000) )

1642 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "MED_");

1643  
audio_¥ofûe
 )

1645 
PROFILE_AUDIO_WMA_PRO
:

1646 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "PRO");

1648 
PROFILE_AUDIO_WMA_FULL
:

1649 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "FULL");

1651 
PROFILE_AUDIO_WMA_BASE
:

1652 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "BASE");

1655 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for WMVMED/0x%X file %s\n",

1656 
audio_¥ofûe
, 
ba£∑th
);

1657 
	`‰ì
(
m
.
d a_≤
);

1658 
m
.
d a_≤
 = 
NULL
;

1662 if–(
vc
->
width
 <= 1920) &&

1663 (
vc
->
height
 <= 1080) &&

1664 (
˘x
->
bô_øã
/8 <= 20000000) )

1666 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "HIGH_");

1667  
audio_¥ofûe
 )

1669 
PROFILE_AUDIO_WMA_PRO
:

1670 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "PRO");

1672 
PROFILE_AUDIO_WMA_FULL
:

1673 
off
 +
	`•rötf
(
m
.
d a_≤
+off, "FULL");

1676 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "No DLNAÖrofile found for WMVHIGH/0x%X file %s\n",

1677 
audio_¥ofûe
, 
ba£∑th
);

1678 
	`‰ì
(
m
.
d a_≤
);

1679 
m
.
d a_≤
 = 
NULL
;

1684 
CODEC_ID_MSMPEG4V3
:

1685 
	`xa•rötf
(&
m
.
mime
, "video/x-msvideo");

1687 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Stream %d of %s is %s [type %d]\n",

1688 
video_°ªam
, 
ba£∑th
, 
m
.
ªsﬁuti⁄
, 
vc
->
codec_id
);

1693 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "asf") == 0 )

1695 if–
	`ªadègs
((*)
∑th
, &
video
, &
fûe
, "en_US", "asf") == 0 )

1697 if–
video
.
tôÀ
 && *video.title )

1699 
m
.
tôÀ
 = 
	`esˇ≥_èg
(
	`åim
(
video
.title), 1);

1701 if–
video
.
gíª
 && *video.genre )

1703 
m
.
gíª
 = 
	`esˇ≥_èg
(
	`åim
(
video
.genre), 1);

1705 if–
video
.
c⁄åibut‹
[
ROLE_TRACKARTIST
] && *video.contributor[ROLE_TRACKARTIST] )

1707 
m
.
¨ti°
 = 
	`esˇ≥_èg
(
	`åim
(
video
.
c⁄åibut‹
[
ROLE_TRACKARTIST
]), 1);

1709 if–
video
.
c⁄åibut‹
[
ROLE_ALBUMARTIST
] && *video.contributor[ROLE_ALBUMARTIST] )

1711 
m
.
¸ót‹
 = 
	`esˇ≥_èg
(
	`åim
(
video
.
c⁄åibut‹
[
ROLE_ALBUMARTIST
]), 1);

1715 
m
.
¸ót‹
 = m.
¨ti°
;

1716 
‰ì_Êags
 &~
FLAG_CREATOR
;

1720 #i‚de‡
NETGEAR


1721 #i‡
LIBAVFORMAT_VERSION_INT
 >= ((52<<16)+(31<<8)+0)

1722 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mov,mp4,m4a,3gp,3g2,mj2") == 0 )

1724 if–
˘x
->
mëad©a
 )

1726 
AVDi˘i⁄¨yE¡ry
 *
èg
 = 
NULL
;

1729  (
èg
 = 
	`av_di˘_gë
(
˘x
->
mëad©a
, "",Åag, 
AV_DICT_IGNORE_SUFFIX
)) )

1732 if–
	`°rcmp
(
èg
->
key
, "title") == 0 )

1733 
m
.
tôÀ
 = 
	`esˇ≥_èg
(
	`åim
(
èg
->
vÆue
), 1);

1734 if–
	`°rcmp
(
èg
->
key
, "genre") == 0 )

1735 
m
.
gíª
 = 
	`esˇ≥_èg
(
	`åim
(
èg
->
vÆue
), 1);

1736 if–
	`°rcmp
(
èg
->
key
, "artist") == 0 )

1737 
m
.
¨ti°
 = 
	`esˇ≥_èg
(
	`åim
(
èg
->
vÆue
), 1);

1738 if–
	`°rcmp
(
èg
->
key
, "comment") == 0 )

1739 
m
.
commít
 = 
	`esˇ≥_èg
(
	`åim
(
èg
->
vÆue
), 1);

1746 
video_no_d a
:

1748 #ifde‡
TIVO_SUPPORT


1749 if–
	`íds_wôh
(
∑th
, ".TiVo"Ë&& 
	`is_tivo_fûe
(path) )

1751 if–
m
.
d a_≤
 )

1753 
	`‰ì
(
m
.
d a_≤
);

1754 
m
.
d a_≤
 = 
NULL
;

1756 
m
.
mime
 = 
	`ªÆloc
(m.mime, 21);

1757 
	`°r˝y
(
m
.
mime
, "video/x-tivo-mpeg");

1761 
	`°r˝y
(
nfo
, 
∑th
);

1762 
ext
 = 
	`°ºchr
(
nfo
, '.');

1763 if–
ext
 )

1765 
	`°r˝y
(
ext
+1, "nfo");

1766 if–
	`ac˚ss
(
nfo
, 
F_OK
) == 0 )

1768 
	`∑r£_nfo
(
nfo
, &
m
);

1772 if–!
m
.
mime
 )

1774 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "avi") == 0 )

1775 
	`xa•rötf
(&
m
.
mime
, "video/x-msvideo");

1776 if–
	`°∫cmp
(
˘x
->
if‹m©
->
«me
, "mpeg", 4) == 0 )

1777 
	`xa•rötf
(&
m
.
mime
, "video/mpeg");

1778 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "asf") == 0 )

1779 
	`xa•rötf
(&
m
.
mime
, "video/x-ms-wmv");

1780 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "mov,mp4,m4a,3gp,3g2,mj2") == 0 )

1781 if–
	`íds_wôh
(
∑th
, ".mov") )

1782 
	`xa•rötf
(&
m
.
mime
, "video/quicktime");

1784 
	`xa•rötf
(&
m
.
mime
, "video/mp4");

1785 if–
	`°∫cmp
(
˘x
->
if‹m©
->
«me
, "matroska", 8) == 0 )

1786 
	`xa•rötf
(&
m
.
mime
, "video/x-matroska");

1787 if–
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "flv") == 0 )

1788 
	`xa•rötf
(&
m
.
mime
, "video/x-flv");

1789 i‡(
	`°rcmp
(
˘x
->
if‹m©
->
«me
, "rm") == 0)

1790 
	`xa•rötf
(&
m
.
mime
, "video/x-rmvb");

1792 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "%s: Unh™dÀd f‹m©: %s\n", 
∑th
, 
˘x
->
if‹m©
->
«me
);

1794 
	`œv_˛o£
(
˘x
);

1796 if–!
m
.
d©e
 )

1798 
m
.
d©e
 = 
	`mÆloc
(20);

1799 
modtime
 = 
	`loˇ…ime
(&
fûe
.
°_mtime
);

1800 
	`°r·ime
(
m
.
d©e
, 20, "%FT%T", 
modtime
);

1803 if–!
m
.
tôÀ
 )

1804 
m
.
tôÀ
 = 
	`°rdup
(
«me
);

1806 
Æbum_¨t
 = 
	`föd_Æbum_¨t
(
∑th
, 
video
.
image
, video.
image_size
);

1807 
	`‰ìègs
(&
video
);

1809 
ªt
 = 
	`sql_exec
(
db
, "INSERT into DETAILS"

1814 
∑th
, ()
fûe
.
°_size
, fûe.
°_mtime
, 
m
.
duøti⁄
,

1815 
m
.
d©e
, m.
ch™√ls
, m.
bôøã
, m.
‰equícy
, m.
ªsﬁuti⁄
,

1816 
m
.
tôÀ
, m.
¸ót‹
, m.
¨ti°
, m.
gíª
, m.
commít
, m.
d a_≤
,

1817 
m
.
mime
, 
Æbum_¨t
);

1818 if–
ªt
 !
SQLITE_OK
 )

1820 
	`Ârötf
(
°dîr
, "Eº‹ in£πög dëaû†f‹ '%s'!\n", 
∑th
);

1821 
ªt
 = 0;

1825 
ªt
 = 
	`sqlôe3_œ°_ö£π_rowid
(
db
);

1826 
	`check_f‹_ˇ±i⁄s
(
∑th
, 
ªt
);

1828 
	`‰ì_mëad©a
(&
m
, 
‰ì_Êags
);

1829 i‡(
∑th_˝y
)

1831 
	`‰ì
(
∑th_˝y
);

1834  
ªt
;

1835 
	}
}

	@metadata.h

24 #i‚de‡
__METADATA_H__


25 
	#__METADATA_H__


	)

27 
	smëad©a_s
 {

28 *
	mtôÀ
;

29 *
	m¨ti°
;

30 *
	m¸ót‹
;

31 *
	mÆbum
;

32 *
	mgíª
;

33 *
	mcommít
;

34 *
	mch™√ls
;

35 *
	mbôøã
;

36 *
	m‰equícy
;

37 *
	mbps
;

38 *
	mªsﬁuti⁄
;

39 *
	mrŸ©i⁄
;

40 *
	mduøti⁄
;

41 *
	md©e
;

42 *
	mmime
;

43 *
	md a_≤
;

44 } 
	tmëad©a_t
;

47 
	mAAC_INVALID
 = 0,

48 
	mAAC_MAIN
 = 1,

49 
	mAAC_LC
 = 2,

50 
	mAAC_SSR
 = 3,

51 
	mAAC_LTP
 = 4,

52 
	mAAC_HE
 = 5,

53 
	mAAC_SCALE
 = 6,

54 
	mAAC_TWINVQ
 = 7,

55 
	mAAC_CELP
 = 8,

56 
	mAAC_HVXC
 = 9,

57 
	mAAC_TTSI
 = 12,

58 
	mAAC_MS
 = 13,

59 
	mAAC_WAVE
 = 14,

60 
	mAAC_MIDI
 = 15,

61 
	mAAC_FX
 = 16,

62 
	mAAC_LC_ER
 = 17,

63 
	mAAC_LTP_ER
 = 19,

64 
	mAAC_SCALE_ER
 = 20,

65 
	mAAC_TWINVQ_ER
 = 21,

66 
	mAAC_BSAC_ER
 = 22,

67 
	mAAC_LD_ER
 = 23,

68 
	mAAC_CELP_ER
 = 24,

69 
	mAAC_HXVC_ER
 = 25,

70 
	mAAC_HILN_ER
 = 26,

71 
	mAAC_PARAM_ER
 = 27,

72 
	mAAC_SSC
 = 28,

73 
	mAAC_HE_L3
 = 31,

74 } 
	tØc_obje˘_ty≥_t
;

77 
	mNONE
,

78 
	mEMPTY
,

79 
	mVALID


80 } 
	tts_time°amp_t
;

83 
íds_wôh
(c⁄° *
hay°ack
, c⁄° *
√edÀ
);

86 
check_f‹_ˇ±i⁄s
(c⁄° *
∑th
, 
öt64_t
 
dëaûID
);

88 
öt64_t


89 
GëFﬁdîMëad©a
(c⁄° *
«me
, c⁄° *
∑th
, c⁄° *
¨ti°
, c⁄° *
gíª
, 
öt64_t
 
Æbum_¨t
);

91 
öt64_t


92 
GëAudioMëad©a
(c⁄° *
∑th
, *
«me
);

94 
öt64_t


95 
GëImageMëad©a
(c⁄° *
∑th
, *
«me
);

97 
öt64_t


98 
GëVideoMëad©a
(c⁄° *
∑th
, *
«me
);

	@minidlna.c

49 
	~<°dlib.h
>

50 
	~<uni°d.h
>

51 
	~<°rög.h
>

52 
	~<°dio.h
>

53 
	~<˘y≥.h
>

54 
	~<sys/ty≥s.h
>

55 
	~<sys/sockë.h
>

56 
	~<sys/waô.h
>

57 
	~<sys/fûe.h
>

58 
	~<sys/time.h
>

59 
	~<sys/∑øm.h
>

60 
	~<sys/°©.h
>

61 
	~<sys/ªsour˚.h
>

62 
	~<√töë/ö.h
>

63 
	~<¨∑/öë.h
>

64 
	~<f˙é.h
>

65 
	~<time.h
>

66 
	~<sig«l.h
>

67 
	~<î∫o.h
>

68 
	~<±hªad.h
>

69 
	~<libgí.h
>

70 
	~<pwd.h
>

71 
	~<uc⁄ãxt.h
>

73 
	~"c⁄fig.h
"

75 #ifde‡
ENABLE_NLS


76 
	~<loˇÀ.h
>

77 
	~<liböé.h
>

80 
	~"u≤pglobÆv¨s.h
"

81 
	~"sql.h
"

82 
	~"u≤phâp.h
"

83 
	~"u≤pdescgí.h
"

84 
	~"möid ≠©h.h
"

85 
	~"gëiÁddr.h
"

86 
	~"u≤psﬂp.h
"

87 
	~"›ti⁄s.h
"

88 
	~"utûs.h
"

89 
	~"möissdp.h
"

90 
	~"möid ©y≥s.h
"

91 
	~"¥o˚ss.h
"

92 
	~"u≤≥víts.h
"

93 
	~"sˇ¬î.h
"

94 
	~"öŸify.h
"

95 
	~"log.h
"

96 
	~"tivo_bóc⁄.h
"

97 
	~"tivo_utûs.h
"

98 
	~"möid a.h
"

100 #i‡
SQLITE_VERSION_NUMBER
 < 3005001

102 
	#sqlôe3_thªadß„
(Ë0

	)

105 
	#MAX_EVENTS
 (10)

	)

106 
	#__ARM__


	)

108 
	ssig«l_°ru˘


110 
	msignum
;

111 *
	msig«me
;

112 (*
	ma˘i⁄
)(
	msignum
);

115 
g√t_ubus_öô
();

116 
g√t_ubus_exô
();

118 
sigãrm
(
signum
);

119 
sighup
(
signum
);

120 
sigu§1
(
signum
);

121 
sigexô
(
signum
);

122 
sig«l_h™dÀr
(
signum
, 
sigöfo_t
 *
sigöfo
, *
c⁄ãxt
);

123 
ªgi°î_dump
(
sigc⁄ãxt
 *
sig˘x
);

125 
sig«l_°ru˘
 
	gsig«ls
[] =

127 {
SIGINT
, "I¡îru±", 
sigãrm
},

128 {
SIGSEGV
, "Segmíèti⁄ viﬁ©i⁄", 
sigexô
},

129 {
SIGFPE
, "Flﬂtög-poöàex˚±i⁄", 
sigexô
},

130 {
SIGILL
, "IŒegÆ in°ru˘i⁄", 
sigexô
},

131 {
SIGTERM
, "Tîmö©i⁄", 
sigãrm
},

132 {
SIGABRT
, "Ab‹t", 
sigexô
},

133 {
SIGBUS
, "BUSÉº‹", 
sigexô
},

134 {
SIGHUP
, "H™gup", 
sighup
},

135 {
SIGUSR1
, "SIGUSR1", 
sigu§1
},

136 {
SIGCHLD
, "Chûd st›≥d o∏ãrmö©ed", 
¥o˚ss_h™dÀ_chûd_ãrmö©i⁄
},

137 {
SIGPIPE
, "BrokíÖùe", 
SIG_IGN
},

138 {0, 
NULL
, NULL}

141 
	gïﬁlfd
;

143 
evít_°ru˘
 *

144 
	$evít_mÆloc
(
sock
)

146 
evít_°ru˘
 *
evt
;

148 
evt
 = 
	`ˇŒoc
(1, (
evít_°ru˘
));

149 i‡(!
evt
)

151  
NULL
;

154 
evt
->
sock
 = sock;

155  
evt
;

156 
	}
}

159 
	$evít_‰ì
(
evít_°ru˘
 *
evt
)

161 i‡(!
evt
)

167 i‡(
evt
->
sock
 > -1)

169 
	`˛o£
(
evt
->
sock
);

170 
evt
->
sock
 = -1;

174 
	`‰ì
(
evt
);

175 
	}
}

177 
	$evít_˘l
(
evít_°ru˘
 *
evt
, 
›t
, 
evts
)

179 
ïﬁl_evít
 
ïevt
;

181 
ïevt
.
evíts
 = 
evts
;

182 
ïevt
.
d©a
.
±r
 = 
evt
;

183  
	`ïﬁl_˘l
(
ïﬁlfd
, 
›t
, 
evt
->
sock
, &
ïevt
);

184 
	}
}

186 
	$evít_dñ
(
evít_°ru˘
 *
evt
)

188  
	`ïﬁl_˘l
(
ïﬁlfd
, 
EPOLL_CTL_DEL
, 
evt
->
sock
, 
NULL
);

189 
	}
}

194 
	$sigãrm
(
sig
)

196 
	`sig«l
(
sig
, 
SIG_IGN
);

198 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "ª˚ived sig«»%d, good-bye\n", 
sig
);

200 
quôtög
 = 1;

201 
	}
}

204 
	$sigu§1
(
sig
)

206 
	`sig«l
(
sig
, 
sigu§1
);

207 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "ª˚ived sig«»%d, cÀ¨ cache\n", 
sig
);

209 
	`mem£t
(&
˛õ¡s
, '\0', (clients));

210 
	}
}

213 
	$sighup
(
sig
)

215 
	`sig«l
(
sig
, 
sighup
);

216 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "ª˚ived sig«»%d,Ñe-ªad\n", 
sig
);

218 
	`ªlﬂd_iÁ˚s
(1);

219 
	}
}

222 
	$sigexô
(
signum
)

224 
sig«l_°ru˘
 *
sig
;

226 
sig
 = 
sig«ls
; sig->
signum
 != 0; sig++)

228 i‡(
sig
->
signum
 == signum)

230 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "-------------- Exception --------------\n");

231 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Sig«l(%d): %s\n", 
signum
, 
sig
->
sig«me
);

236 
	`exô
(0);

237 
	}
}

240 
	$sig«l_h™dÀr
(
signum
, 
sigöfo_t
 *
sigöfo
, *
c⁄ãxt
)

242 
uc⁄ãxt
 *
˘x
 = (uc⁄ãxà*)
c⁄ãxt
;

243 
sig«l_°ru˘
 *
sig
;

245 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Re˚ivêSig«l(%d)\n", 
signum
);

248 
signum
)

250 
SIGINT
:

251 
SIGSEGV
:

252 
SIGFPE
:

253 
SIGILL
:

254 
SIGTERM
:

255 
SIGABRT
:

256 
SIGBUS
:

257 
SIGHUP
:

258 
	`ªgi°î_dump
((
sigc⁄ãxt
 *)&
˘x
->
uc_mc⁄ãxt
);

265 
sig
 = 
sig«ls
; sig->
signum
 != 0; sig++)

267 i‡(
sig
->
signum
 == signum)

269 
sig
->
	`a˘i⁄
(
signum
);

272 
	}
}

274 #i‡
deföed
(
__ARM__
)

277 
	$ªgi°î_dump
(
sigc⁄ãxt
 *
sig˘x
)

279 *
¨m_ªg_«mes
[] =

287 *
±r
 = &
sig˘x
->
¨m_r0
;

288 
buf
[512];

289 *
°r
 = 
buf
;

290 
size
;

291 
ödex
;

292 
i
;

294 
size
 = 512;

295 
ödex
 = 
	`¢¥ötf
(
°r
, 
size
, "\n-------------- Register --------------\n");

296 
i
 = 0; i < 17; i++)

298 i‡(
i
 > 0 && (i % 2) == 0)

300 
ödex
 +
	`¢¥ötf
(
°r
 + index, 
size
 - index, "\n");

302 
ödex
 +
	`¢¥ötf
(
°r
 + index, 
size
 - index, "%-4s: %08lx ",

303 
¨m_ªg_«mes
[
i
], *
±r
);

304 
±r
++;

307 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "%s\n", 
buf
);

308 
	}
}

313 
	$ªgi°î_dump
(
sigc⁄ãxt
 *
sig˘x
)

316 
	}
}

321 
	$£t_°¨tup_time
()

323 
°¨tup_time
 = 
	`time
(
NULL
);

324 
	}
}

327 
	$gë‰õndly«me
(*
buf
, 
Àn
)

329 *
p
 = 
NULL
;

330 
hn
[256];

331 
off
;

333 i‡(
	`gëho°«me
(
hn
, (hn)) == 0)

335 
	`°∫˝yt
(
buf
, 
hn
, 
Àn
);

336 
p
 = 
	`°rchr
(
buf
, '.');

337 i‡(
p
)

338 *
p
 = '\0';

341 
	`°r˝y
(
buf
, "Unknown");

343 
off
 = 
	`°æí
(
buf
);

344 
off
 +
	`¢¥ötf
(
buf
+off, 
Àn
-off, ": ");

345 #ifde‡
READYNAS


346 
FILE
 *
öfo
;

347 
ibuf
[64], *
key
, *
vÆ
;

348 
	`¢¥ötf
(
buf
+
off
, 
Àn
-off, "ReadyNAS");

349 
öfo
 = 
	`f›í
("/proc/sys/dev/boot/info", "r");

350 i‡(!
öfo
)

352 (
vÆ
 = 
	`fgës
(
ibuf
, 64, 
öfo
)Ë!
NULL
)

354 
key
 = 
	`°r£p
(&
vÆ
, ": \t");

355 
vÆ
 = 
	`åim
(val);

356 i‡(
	`°rcmp
(
key
, "model") == 0)

358 
	`¢¥ötf
(
buf
+
off
, 
Àn
-off, "%s", 
vÆ
);

359 
key
 = 
	`°rchr
(
vÆ
, ' ');

360 i‡(
key
)

362 
	`°∫˝yt
(
modñnumbî
, 
key
+1, 
MODELNUMBER_MAX_LEN
);

363 *
key
 = '\0';

365 
	`¢¥ötf
(
modñ«me
, 
MODELNAME_MAX_LEN
,

366 "Wödow†Medü C⁄√˘ com∑tibÀ (%s)", 
vÆ
);

368 i‡(
	`°rcmp
(
key
, "serial") == 0)

370 
	`°∫˝yt
(
£rü umbî
, 
vÆ
, 
SERIALNUMBER_MAX_LEN
);

371 i‡(
£rü umbî
[0] == '\0')

373 
mac_°r
[13];

374 i‡(
	`gësyshwaddr
(
mac_°r
, (mac_str)) == 0)

375 
	`°r˝y
(
£rü umbî
, 
mac_°r
);

377 
	`°r˝y
(
£rü umbî
, "0");

382 
	`f˛o£
(
öfo
);

383 #i‡
PNPX


384 
	`mem˝y
(
≤px_hwid
+4, "01F2", 4);

385 i‡(
	`°rcmp
(
modñnumbî
, "NVX") == 0)

386 
	`mem˝y
(
≤px_hwid
+17, "0101", 4);

387 i‡(
	`°rcmp
(
modñnumbî
, "Pro") == 0 ||

388 
	`°rcmp
(
modñnumbî
, "Pro 6") == 0 ||

389 
	`°∫cmp
(
modñnumbî
, "Ultra 6", 7) == 0)

390 
	`mem˝y
(
≤px_hwid
+17, "0102", 4);

391 i‡(
	`°rcmp
(
modñnumbî
, "Pro 2") == 0 ||

392 
	`°∫cmp
(
modñnumbî
, "Ultra 2", 7) == 0)

393 
	`mem˝y
(
≤px_hwid
+17, "0103", 4);

394 i‡(
	`°rcmp
(
modñnumbî
, "Pro 4") == 0 ||

395 
	`°∫cmp
(
modñnumbî
, "Ultra 4", 7) == 0)

396 
	`mem˝y
(
≤px_hwid
+17, "0104", 4);

397 i‡(
	`°rcmp
(
modñnumbî
+1, "100") == 0)

398 
	`mem˝y
(
≤px_hwid
+17, "0105", 4);

399 i‡(
	`°rcmp
(
modñnumbî
+1, "200") == 0)

400 
	`mem˝y
(
≤px_hwid
+17, "0106", 4);

402 i‡(
	`°rcmp
(
modñnumbî
, "Duo v2") == 0)

403 
	`mem˝y
(
≤px_hwid
+17, "0108", 4);

404 i‡(
	`°rcmp
(
modñnumbî
, "NV+ v2") == 0)

405 
	`mem˝y
(
≤px_hwid
+17, "0109", 4);

408 * 
log«me
;

409 
log«me
 = 
	`gëív
("LOGNAME");

410 #i‚de‡
STATIC


411 i‡(!
log«me
)

413 
∑sswd
 * 
pwít
;

414 
pwít
 = 
	`gëpwuid
(
	`gëuid
());

415 i‡(
pwít
)

416 
log«me
 = 
pwít
->
pw_«me
;

419 
	`¢¥ötf
(
buf
+
off
, 
Àn
-off, "%s", 
log«me
?logname:"Unknown");

421 
	}
}

424 
	$›í_db
(
sqlôe3
 **
sq3
)

426 
∑th
[
PATH_MAX
];

427 
√w_db
 = 0;

429 
	`¢¥ötf
(
∑th
, ’©h), "%s/fûes.db", 
db_∑th
);

430 i‡(
	`ac˚ss
(
∑th
, 
F_OK
) != 0)

432 
√w_db
 = 1;

433 
	`make_dú
(
db_∑th
, 
S_ISVTX
|
S_IRWXU
|
S_IRWXG
|
S_IRWXO
);

435 i‡(
	`sqlôe3_›í
(
∑th
, &
db
Ë!
SQLITE_OK
)

436 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "ERROR: FailedÅo open sqlite database! Exiting...\n");

437 i‡(
sq3
)

438 *
sq3
 = 
db
;

439 
	`sqlôe3_busy_timeout
(
db
, 5000);

440 
	`sqlôe3_so·_hóp_limô64
(1 * 1024 * 1024);

441 
	`sql_exec
(
db
, "pragmaÖage_size = 4096");

442 
	`sql_exec
(
db
, "pragma journal_mode = OFF");

443 
	`sql_exec
(
db
, "pragma synchronous = OFF;");

444 
	`sql_exec
(
db
, "pragma default_cache_size = 8192;");

449  
√w_db
;

450 
	}
}

453 
	$check_db
(
sqlôe3
 *
db
, 
√w_db
, 
pid_t
 *
sˇ¬î_pid
)

455 
medü_dú_s
 *
medü_∑th
 = 
NULL
;

456 
cmd
[
PATH_MAX
*2];

457 **
ªsu…
;

458 
i
, 
rows
 = 0;

459 
ªt
;

461 i‡(!
√w_db
)

464 
medü_∑th
 = 
medü_dús
;

465 
medü_∑th
)

467 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT TIMESTAMP from DETAILS whîêPATH = %Q", 
medü_∑th
->
∑th
);

468 i‡(
ªt
 !
medü_∑th
->
ty≥s
)

470 
ªt
 = 1;

471 
ªsˇn
;

473 
medü_∑th
 = medü_∑th->
√xt
;

476 
	`sql_gë_èbÀ
(
db
, "SELECT VALUE from SETTINGS whîêKEY = 'medü_dú'", &
ªsu…
, &
rows
, 
NULL
);

477 
i
=1; i <
rows
; i++)

479 
medü_∑th
 = 
medü_dús
;

480 
medü_∑th
)

482 i‡(
	`°rcmp
(
ªsu…
[
i
], 
medü_∑th
->
∑th
) == 0)

484 
medü_∑th
 = medü_∑th->
√xt
;

486 i‡(!
medü_∑th
)

488 
ªt
 = 2;

489 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

490 
ªsˇn
;

493 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

496 
ªt
 = 
	`db_upgøde
(
db
);

497 i‡(
ªt
 != 0)

499 
ªsˇn
:

500 i‡(
ªt
 < 0)

501 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Cª©ögÇew d©aba£áà%s/fûes.db\n", 
db_∑th
);

502 i‡(
ªt
 == 1)

503 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "New media_dir detected;Ñescanning...\n");

504 i‡(
ªt
 == 2)

505 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Removed media_dir detected;Ñescanning...\n");

507 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Database version mismatch;ÇeedÅoÑecreate...\n");

508 
	`sqlôe3_˛o£
(
db
);

510 
	`¢¥ötf
(
cmd
, (cmd), "rm -r‡%s/fûes.db %s/¨t_ˇche", 
db_∑th
, db_path);

511 i‡(
	`sy°em
(
cmd
) != 0)

512 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo clean old file cache! Exiting...\n");

514 
	`›í_db
(&
db
);

515 i‡(
	`Cª©eD©aba£
() != 0)

516 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "ERROR: FailedÅo create sqlite database! Exiting...\n");

517 #i‡
USE_FORK


518 
sˇ¬ög
 = 1;

519 
	`sqlôe3_˛o£
(
db
);

520 *
sˇ¬î_pid
 = 
	`¥o˚ss_f‹k
();

521 
	`›í_db
(&
db
);

522 i‡(*
sˇ¬î_pid
 == 0)

524 
	`°¨t_sˇ¬î
();

525 
	`sqlôe3_˛o£
(
db
);

526 
	`log_˛o£
();

527 
	`‰ì›ti⁄s
();

528 
	`exô
(
EXIT_SUCCESS
);

530 i‡(*
sˇ¬î_pid
 < 0)

532 
	`°¨t_sˇ¬î
();

535 
	`°¨t_sˇ¬î
();

538 
	}
}

541 
	$wrôïidfûe
(c⁄° *
‚ame
, 
pid
, 
uid_t
 
uid
)

543 
FILE
 *
pidfûe
;

544 
°©
 
°
;

545 
∑th
[
PATH_MAX
], *
dú
;

546 
ªt
 = 0;

548 if(!
‚ame
 || *fname == '\0')

552 
	`°∫˝yt
(
∑th
, 
‚ame
, (path));

553 
dú
 = 
	`dú«me
(
∑th
);

554 i‡(
	`°©
(
dú
, &
°
) == 0)

556 i‡(!
	`S_ISDIR
(
°
.
°_mode
))

558 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "PidfileÖath isÇotá directory: %s\n",

559 
‚ame
);

565 i‡(
	`make_dú
(
dú
, 
S_IRWXU
|
S_IRGRP
|
S_IXGRP
|
S_IROTH
|
S_IXOTH
) != 0)

567 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "UnableÅo createÖidfile directory: %s\n",

568 
‚ame
);

571 i‡(
uid
 >= 0)

573 i‡(
	`chown
(
dú
, 
uid
, -1) != 0)

574 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "UnableÅo changeÖidfile ownership: %s\n",

575 
dú
, 
	`°ªº‹
(
î∫o
));

579 
pidfûe
 = 
	`f›í
(
‚ame
, "w");

580 i‡(!
pidfûe
)

582 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "UnableÅo openÖidfile for writing %s: %s\n",

583 
‚ame
, 
	`°ªº‹
(
î∫o
));

587 i‡(
	`Ârötf
(
pidfûe
, "%d\n", 
pid
) <= 0)

589 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
,

590 "U«bÀÅÿwrôêtÿpidfûê%s: %s\n", 
‚ame
);

591 
ªt
 = -1;

593 i‡(
uid
 >= 0)

595 i‡(
	`fchown
(
	`fûío
(
pidfûe
), 
uid
, -1) != 0)

596 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "UnableÅo changeÖidfile ownership: %s\n",

597 
pidfûe
, 
	`°ªº‹
(
î∫o
));

600 
	`f˛o£
(
pidfûe
);

602  
ªt
;

603 
	}
}

605 
	$æimô_öô
()

607 
æimô
 
æim
;

608 
ªt
;

611 
ªt
 = 
	`gëæimô
(
RLIMIT_NOFILE
, &
æim
);

612 i‡(
ªt
 != 0)

617 
æim
.
æim_cur
 += 1024;

618 
æim
.
æim_max
 += 1024;

620 
æim
.
æim_cur
 = 
RLIM_INFINITY
;

621 
æim
.
æim_max
 = 
RLIM_INFINITY
;

623 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "NOFILE: cu∏%lu, max = %lu\n", 
æim
.
æim_cur
,Ñlim.
æim_max
);

624 
ªt
 = 
	`£ålimô
(
RLIMIT_NOFILE
, &
æim
);

626  
ªt
;

627 
	}
}

638 
	$öô
(
¨gc
, **
¨gv
)

640 
i
;

641 
pid
;

642 
debug_Êag
 = 0;

643 
vîbo£_Êag
 = 0;

644 
›ti⁄s_Êag
 = 0;

645 
siga˘i⁄
 
ß
;

646 c⁄° * 
¥esuæ
 = 
NULL
;

647 c⁄° * 
›ti⁄sfûe
 = "/etc/minidlna.conf";

648 
mac_°r
[13];

649 *
°rög
, *
w‹d
;

650 *
∑th
;

651 
buf
[
PATH_MAX
];

652 
log_°r
[75] = "general,artwork,database,inotify,scanner,metadata,http,ssdp,tivo=warn";

653 *
log_Àvñ
 = 
NULL
;

654 
medü_dú_s
 *
medü_dú
;

655 
iÁ˚s
 = 0;

656 
medü_ty≥s
 
ty≥s
;

657 
uid_t
 
uid
 = -1;

658 
cou¡
;

659 
gíabÀ
;

660 
sig«l_°ru˘
 *
sig
;

663 
i
=2; i<
¨gc
; i++)

665 i‡(
	`°rcmp
(
¨gv
[
i
-1], "-f") == 0)

667 
›ti⁄sfûe
 = 
¨gv
[
i
];

668 
›ti⁄s_Êag
 = 1;

674 i‡(
	`gësyshwaddr
(
mac_°r
, (mac_str)) < 0)

676 
	`DPRINTF
(
E_OFF
, 
L_GENERAL
, "No MACáddress found. Falling backÅo generic UUID.\n");

677 
	`°r˝y
(
mac_°r
, "554e4b4e4f57");

679 
	`°r˝y
(
uuidvÆue
+5, "4d696e69-444c-164e-9d41-");

680 
	`°∫ˇt
(
uuidvÆue
, 
mac_°r
, 12);

682 
	`gë‰õndly«me
(
‰õndly_«me
, 
FRIENDLYNAME_MAX_LEN
);

684 
ru¡ime_v¨s
.
p‹t
 = 8200;

685 
ru¡ime_v¨s
.
nŸify_öãrvÆ
 = 895;

686 
ru¡ime_v¨s
.
max_c⁄√˘i⁄s
 = 50;

687 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
NULL
;

688 
ru¡ime_v¨s
.
iÁ˚s
[0] = 
NULL
;

692 i‡(
	`ªad›ti⁄sfûe
(
›ti⁄sfûe
) < 0)

695 if(
	`ac˚ss
(
›ti⁄sfûe
, 
F_OK
Ë=0 || 
›ti⁄s_Êag
)

696 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "Eº‹Ñódög c⁄figuøti⁄ fûê%s\n", 
›ti⁄sfûe
);

699 
i
=0; i<
num_›ti⁄s
; i++)

701 
¨y_›ti⁄s
[
i
].
id
)

703 
UPNPIFNAME
:

704 
°rög
 = 
¨y_›ti⁄s
[
i
].
vÆue
; (
w‹d
 = 
	`°πok
(°rög, ",")); såög = 
NULL
)

706 i‡(
iÁ˚s
 >
MAX_LAN_ADDR
)

708 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Too many interfaces (max: %d), ignoring %s\n",

709 
MAX_LAN_ADDR
, 
w‹d
);

712 
ru¡ime_v¨s
.
iÁ˚s
[iÁ˚s++] = 
w‹d
;

715 
UPNPPORT
:

716 
ru¡ime_v¨s
.
p‹t
 = 
	`©oi
(
¨y_›ti⁄s
[
i
].
vÆue
);

718 
UPNPPRESENTATIONURL
:

719 
¥esuæ
 = 
¨y_›ti⁄s
[
i
].
vÆue
;

721 
UPNPNOTIFY_INTERVAL
:

722 
ru¡ime_v¨s
.
nŸify_öãrvÆ
 = 
	`©oi
(
¨y_›ti⁄s
[
i
].
vÆue
);

724 
UPNPSERIAL
:

725 
	`°∫˝yt
(
£rü umbî
, 
¨y_›ti⁄s
[
i
].
vÆue
, 
SERIALNUMBER_MAX_LEN
);

727 
UPNPMODEL_NAME
:

728 
	`°∫˝yt
(
modñ«me
, 
¨y_›ti⁄s
[
i
].
vÆue
, 
MODELNAME_MAX_LEN
);

730 
UPNPMODEL_NUMBER
:

731 
	`°∫˝yt
(
modñnumbî
, 
¨y_›ti⁄s
[
i
].
vÆue
, 
MODELNUMBER_MAX_LEN
);

733 
UPNPFRIENDLYNAME
:

734 
	`°∫˝yt
(
‰õndly_«me
, 
¨y_›ti⁄s
[
i
].
vÆue
, 
FRIENDLYNAME_MAX_LEN
);

736 
UPNPMEDIADIR
:

737 
ty≥s
 = 
NO_MEDIA
;

738 
gíabÀ
 = 0;

739 
∑th
 = 
¨y_›ti⁄s
[
i
].
vÆue
;

740 
w‹d
 = 
	`°rchr
(
∑th
, ',');

741 i‡(
w‹d
 && (
	`ac˚ss
(
∑th
, 
F_OK
) != 0))

744 
cou¡
 = 0;

745 *
∑th
)

747 i‡(*
∑th
 == ',')

749 
cou¡
++;

750 i‡(
cou¡
 >= 2)

752 
∑th
++;

756 i‡(*
∑th
 == 'A' || *path == 'a')

757 
ty≥s
 |
TYPE_AUDIO
;

758 i‡(*
∑th
 == 'V' || *path == 'v')

759 
ty≥s
 |
TYPE_VIDEO
;

760 i‡(*
∑th
 == 'P' || *path == 'p')

761 
ty≥s
 |
TYPE_IMAGES
;

762 i‡(*
∑th
 == 'G' || *path == 'g')

763 
gíabÀ
 = 1;

764 i‡(*
∑th
 == '/')

767 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "Media directoryÉntryÇot understood [%s]\n",

768 
¨y_›ti⁄s
[
i
].
vÆue
);

769 
∑th
++;

772 i‡(
ty≥s
 =
NO_MEDIA
)

774 
ty≥s
 = 
ALL_MEDIA
;

776 
∑th
 = 
	`ªÆ∑th
’©h, 
buf
);

777 i‡(!
∑th
 || 
	`ac˚ss
’©h, 
F_OK
) != 0)

779 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Media directory \"%s\"Çotáccessible [%s]\n",

780 
¨y_›ti⁄s
[
i
].
vÆue
, 
	`°ªº‹
(
î∫o
));

783 
medü_dú
 = 
	`ˇŒoc
(1, (
medü_dú_s
));

784 
medü_dú
->
∑th
 = 
	`°rdup
(path);

785 
medü_dú
->
ty≥s
 =Åypes;

786 
medü_dú
->
gíabÀ
 = genable;

787 i‡(
medü_dús
)

789 
medü_dú_s
 *
Æl_dús
 = 
medü_dús
;

790  
Æl_dús
->
√xt
 )

791 
Æl_dús
 =áŒ_dús->
√xt
;

792 
Æl_dús
->
√xt
 = 
medü_dú
;

795 
medü_dús
 = 
medü_dú
;

797 
UPNPALBUMART_NAMES
:

798 
°rög
 = 
¨y_›ti⁄s
[
i
].
vÆue
; (
w‹d
 = 
	`°πok
(°rög, "/")); såög = 
NULL
)

800 
Æbum_¨t_«me_s
 * 
this_«me
 = 
	`ˇŒoc
(1, (album_art_name_s));

801 
Àn
 = 
	`°æí
(
w‹d
);

802 i‡(
w‹d
[
Àn
-1] == '*')

804 
w‹d
[
Àn
-1] = '\0';

805 
this_«me
->
wûdˇrd
 = 1;

807 
this_«me
->
«me
 = 
	`°rdup
(
w‹d
);

808 i‡(
Æbum_¨t_«mes
)

810 
Æbum_¨t_«me_s
 * 
Æl_«mes
 = 
Æbum_¨t_«mes
;

811  
Æl_«mes
->
√xt
 )

812 
Æl_«mes
 =áŒ_«mes->
√xt
;

813 
Æl_«mes
->
√xt
 = 
this_«me
;

816 
Æbum_¨t_«mes
 = 
this_«me
;

819 
UPNPDBDIR
:

820 
∑th
 = 
	`ªÆ∑th
(
¨y_›ti⁄s
[
i
].
vÆue
, 
buf
);

821 i‡(!
∑th
)

822 
∑th
 = (
¨y_›ti⁄s
[
i
].
vÆue
);

823 
	`make_dú
(
∑th
, 
S_ISVTX
|
S_IRWXU
|
S_IRWXG
|
S_IRWXO
);

824 i‡(
	`ac˚ss
(
∑th
, 
F_OK
) != 0)

825 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "D©aba£Ö©hÇŸác˚ssibÀ! [%s]\n", 
∑th
);

826 
	`°∫˝yt
(
db_∑th
, 
∑th
, 
PATH_MAX
);

828 
UPNPLOGDIR
:

829 
∑th
 = 
	`ªÆ∑th
(
¨y_›ti⁄s
[
i
].
vÆue
, 
buf
);

830 i‡(!
∑th
)

831 
∑th
 = (
¨y_›ti⁄s
[
i
].
vÆue
);

832 
	`make_dú
(
∑th
, 
S_ISVTX
|
S_IRWXU
|
S_IRWXG
|
S_IRWXO
);

833 i‡(
	`ac˚ss
(
∑th
, 
F_OK
) != 0)

834 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "LogÖ©hÇŸác˚ssibÀ! [%s]\n", 
∑th
);

835 
	`°∫˝yt
(
log_∑th
, 
∑th
, 
PATH_MAX
);

837 
UPNPLOGLEVEL
:

838 
log_Àvñ
 = 
¨y_›ti⁄s
[
i
].
vÆue
;

840 
UPNPINOTIFY
:

841 i‡((
	`°rcmp
(
¨y_›ti⁄s
[
i
].
vÆue
, "yes"Ë!0Ë&& !
	`©oi
(ary_options[i].value))

842 
	`CLEARFLAG
(
INOTIFY_MASK
);

844 
ENABLE_TIVO
:

845 i‡((
	`°rcmp
(
¨y_›ti⁄s
[
i
].
vÆue
, "yes"Ë=0Ë|| 
	`©oi
(ary_options[i].value))

846 
	`SETFLAG
(
TIVO_MASK
);

848 
ENABLE_DLNA_STRICT
:

849 i‡((
	`°rcmp
(
¨y_›ti⁄s
[
i
].
vÆue
, "yes"Ë=0Ë|| 
	`©oi
(ary_options[i].value))

850 
	`SETFLAG
(
DLNA_STRICT_MASK
);

852 
ROOT_CONTAINER
:

853 
¨y_›ti⁄s
[
i
].
vÆue
[0]) {

855 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
NULL
;

859 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
BROWSEDIR_ID
;

863 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
MUSIC_ID
;

867 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
VIDEO_ID
;

871 
ru¡ime_v¨s
.
roŸ_c⁄èöî
 = 
IMAGE_ID
;

874 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "InvalidÑoot container! [%s]\n",

875 
¨y_›ti⁄s
[
i
].
vÆue
);

879 
UPNPMINISSDPDSOCKET
:

880 
möissdpdsockë∑th
 = 
¨y_›ti⁄s
[
i
].
vÆue
;

882 
UPNPUUID
:

883 
	`°r˝y
(
uuidvÆue
+5, 
¨y_›ti⁄s
[
i
].
vÆue
);

885 
USER_ACCOUNT
:

886 
uid
 = 
	`°πﬁ
(
¨y_›ti⁄s
[
i
].
vÆue
, &
°rög
, 0);

887 i‡(*
°rög
)

890 
∑sswd
 *
íåy
 = 
	`gëpw«m
(
¨y_›ti⁄s
[
i
].
vÆue
);

891 i‡(!
íåy
)

892 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "Bad u£∏'%s'.\n", 
¨gv
[
i
]);

893 
uid
 = 
íåy
->
pw_uid
;

896 
FORCE_SORT_CRITERIA
:

897 
f‹˚_s‹t_¸ôîü
 = 
¨y_›ti⁄s
[
i
].
vÆue
;

899 
MAX_CONNECTIONS
:

900 
ru¡ime_v¨s
.
max_c⁄√˘i⁄s
 = 
	`©oi
(
¨y_›ti⁄s
[
i
].
vÆue
);

903 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Unknown option in file %s\n",

904 
›ti⁄sfûe
);

907 i‡(
log_∑th
[0] == '\0')

909 i‡(
db_∑th
[0] == '\0')

910 
	`°∫˝yt
(
log_∑th
, 
DEFAULT_LOG_PATH
, 
PATH_MAX
);

912 
	`°∫˝yt
(
log_∑th
, 
db_∑th
, 
PATH_MAX
);

914 i‡(
db_∑th
[0] == '\0')

915 
	`°∫˝yt
(
db_∑th
, 
DEFAULT_DB_PATH
, 
PATH_MAX
);

918 
i
=1; i<
¨gc
; i++)

920 i‡(
¨gv
[
i
][0] != '-')

922 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "Unknow¿›ti⁄: %s\n", 
¨gv
[
i
]);

924 i‡(
	`°rcmp
(
¨gv
[
i
], "--help") == 0)

926 
ru¡ime_v¨s
.
p‹t
 = -1;

929 
¨gv
[
i
][1])

932 i‡(
i
+1 < 
¨gc
)

933 
ru¡ime_v¨s
.
nŸify_öãrvÆ
 = 
	`©oi
(
¨gv
[++
i
]);

935 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

938 i‡(
i
+1 < 
¨gc
)

939 
	`°∫˝yt
(
£rü umbî
, 
¨gv
[++
i
], 
SERIALNUMBER_MAX_LEN
);

941 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

944 i‡(
i
+1 < 
¨gc
)

945 
	`°∫˝yt
(
modñnumbî
, 
¨gv
[++
i
], 
MODELNUMBER_MAX_LEN
);

947 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

950 i‡(
i
+1 < 
¨gc
)

951 
ru¡ime_v¨s
.
p‹t
 = 
	`©oi
(
¨gv
[++
i
]);

953 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

956 i‡(
i
+1 < 
¨gc
)

958 i‡(
¨gv
[++
i
][0] != '/')

959 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯ªquúe†™ábsﬁuã fûíame.\n", 
¨gv
[
i
-1][1]);

961 
pidfûíame
 = 
¨gv
[
i
];

964 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

967 
debug_Êag
 = 1;

969 
vîbo£_Êag
 = 1;

972 
	`SETFLAG
(
NO_PLAYLIST_MASK
);

975 i‡(
i
+1 < 
¨gc
)

976 
¥esuæ
 = 
¨gv
[++
i
];

978 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

981 i‡(
i
+1 < 
¨gc
)

983 
i
++;

984 i‡(
iÁ˚s
 >
MAX_LAN_ADDR
)

986 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Too many interfaces (max: %d), ignoring %s\n",

987 
MAX_LAN_ADDR
, 
¨gv
[
i
]);

990 
ru¡ime_v¨s
.
iÁ˚s
[iÁ˚s++] = 
¨gv
[
i
];

993 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

996 
i
++;

999 
ru¡ime_v¨s
.
p‹t
 = -1;

1002 
	`¢¥ötf
(
buf
, (buf), "rm -r‡%s/fûes.db %s/¨t_ˇche", 
db_∑th
, db_path);

1003 i‡(
	`sy°em
(
buf
) != 0)

1004 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo clean old file cache. EXITING\n");

1007 i‡(
i
+1 !
¨gc
)

1009 
i
++;

1010 
uid
 = 
	`°πﬁ
(
¨gv
[
i
], &
°rög
, 0);

1011 i‡(*
°rög
)

1014 
∑sswd
 *
íåy
 = 
	`gëpw«m
(
¨gv
[
i
]);

1015 i‡(!
íåy
)

1016 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "Bad u£∏'%s'.\n", 
¨gv
[
i
]);

1017 
uid
 = 
íåy
->
pw_uid
;

1021 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "O±i⁄ -%¯èke†⁄ê¨gumít.\n", 
¨gv
[
i
][1]);

1024 #ifde‡
__löux__


1026 
	`SETFLAG
(
SYSTEMD_MASK
);

1030 
	`¥ötf
("Vîsi⁄ " 
MINIDLNA_VERSION
 "\n");

1031 
	`exô
(0);

1034 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "Unknow¿›ti⁄: %s\n", 
¨gv
[
i
]);

1035 
ru¡ime_v¨s
.
p‹t
 = -1;

1039 i‡(
ru¡ime_v¨s
.
p‹t
 <= 0)

1041 
	`¥ötf
("Usage:\n\t"

1046 #ifde‡
__löux__


1059 #ifde‡
__löux__


1063 
¨gv
[0], 
pidfûíame
);

1067 i‡(
vîbo£_Êag
)

1069 
	`°r˝y
(
log_°r
+65, "debug");

1070 
log_Àvñ
 = 
log_°r
;

1072 i‡(!
log_Àvñ
)

1073 
log_Àvñ
 = 
log_°r
;

1076 
∑th
 = 
NULL
;

1077 i‡(
debug_Êag
)

1079 
pid
 = 
	`gëpid
();

1080 
	`°r˝y
(
log_°r
+65, "maxdebug");

1081 
log_Àvñ
 = 
log_°r
;

1083 i‡(
	`GETFLAG
(
SYSTEMD_MASK
))

1085 
pid
 = 
	`gëpid
();

1089 
pid
 = 
	`¥o˚ss_d´m⁄ize
();

1090 #ifde‡
READYNAS


1091 
	`u∆ök
("/ramfs/.upnp-av_scan");

1092 
∑th
 = "/var/log/upnp-av.log";

1094 i‡(
	`ac˚ss
(
db_∑th
, 
F_OK
) != 0)

1095 
	`make_dú
(
db_∑th
, 
S_ISVTX
|
S_IRWXU
|
S_IRWXG
|
S_IRWXO
);

1096 
	`¢¥ötf
(
buf
, (buf), "%s/möid a.log", 
log_∑th
);

1097 
∑th
 = 
buf
;

1100 
	`log_öô
(
∑th
, 
log_Àvñ
);

1102 i‡(
	`¥o˚ss_check_if_ru¬ög
(
pidfûíame
) < 0)

1104 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "MiniDLNA isálreadyÑunning. EXITING.\n");

1108 
	`£t_°¨tup_time
();

1111 i‡(
¥esuæ
)

1112 
	`°∫˝yt
(
¥e£¡©i⁄uæ
, 
¥esuæ
, 
PRESENTATIONURL_MAX_LEN
);

1114 
	`°r˝y
(
¥e£¡©i⁄uæ
, "/");

1117 
	`mem£t
(&
ß
, 0, (
siga˘i⁄
));

1118 
sig
 = 
sig«ls
; sig->
signum
 != 0; sig++)

1120 i‡(
sig
->
a˘i⁄
 =
SIG_IGN
)

1122 ()
	`sig«l
(
sig
->
signum
, 
SIG_IGN
);

1126 
	`mem£t
(&
ß
, 0, (
siga˘i⁄
));

1127 
	`sigem±y£t
(&
ß
.
ß_mask
);

1128 
ß
.
ß_Êags
 = 
SA_SIGINFO
;

1129 
ß
.
ß_siga˘i⁄
 = 
sig«l_h™dÀr
;

1130 i‡(
	`siga˘i⁄
(
sig
->
signum
, &
ß
, 
NULL
) == -1)

1132 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FaûedÅÿ£à%d h™dÀr. EXITING.\n", 
sig
->
signum
);

1137 
ß
.
ß_h™dÀr
 = 
sigãrm
;

1138 i‡(
	`siga˘i⁄
(
SIGTERM
, &
ß
, 
NULL
))

1139 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo set %s handler. EXITING.\n", "SIGTERM");

1140 i‡(
	`siga˘i⁄
(
SIGINT
, &
ß
, 
NULL
))

1141 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo set %s handler. EXITING.\n", "SIGINT");

1142 i‡(
	`sig«l
(
SIGPIPE
, 
SIG_IGN
Ë=
SIG_ERR
)

1143 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo set %s handler. EXITING.\n", "SIGPIPE");

1144 i‡(
	`sig«l
(
SIGHUP
, &
sighup
Ë=
SIG_ERR
)

1145 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo set %s handler. EXITING.\n", "SIGHUP");

1146 
	`sig«l
(
SIGUSR1
, &
sigu§1
);

1147 
ß
.
ß_h™dÀr
 = 
¥o˚ss_h™dÀ_chûd_ãrmö©i⁄
;

1148 i‡(
	`siga˘i⁄
(
SIGCHLD
, &
ß
, 
NULL
))

1149 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo set %s handler. EXITING.\n", "SIGCHLD");

1152 i‡(
	`wrôïidfûe
(
pidfûíame
, 
pid
, 
uid
) != 0)

1153 
pidfûíame
 = 
NULL
;

1155 i‡(
uid
 >= 0)

1157 
°©
 
°
;

1158 i‡(
	`°©
(
db_∑th
, &
°
Ë=0 && st.
°_uid
 !
uid
 && 
	`chown
(db_path, uid, -1) != 0)

1159 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "UnableÅo set db_path [%s] ownershipÅo %d: %s\n",

1160 
db_∑th
, 
uid
, 
	`°ªº‹
(
î∫o
));

1163 i‡(
uid
 !-1 && 
	`£tuid
(uid) == -1)

1164 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo switchÅo uid '%d'. [%s] EXITING.\n",

1165 
uid
, 
	`°ªº‹
(
î∫o
));

1168 
	}
}

1173 
	$maö
(
¨gc
, **
¨gv
)

1175 
ªt
, 
i
;

1176 
timevÆ
 
timeofday
;

1177 
time_t
 
timeout
;

1178 
time_t
 
œ°nŸifytime
;

1179 
time_t
 
œ°upd©ëime
 = 0;

1180 
œ°_ch™ge˙t
 = 0;

1181 
pid_t
 
sˇ¬î_pid
 = 0;

1182 
±hªad_t
 
öŸify_thªad
 = 0;

1183 #ifde‡
TIVO_SUPPORT


1184 
uöt8_t
 
bóc⁄_öãrvÆ
 = 5;

1185 
sockaddr_ö
 
tivo_bˇ°
;

1186 
timevÆ
 
œ°bóc⁄time
 = {0, 0};

1188 
size
 = 10;

1189 
n
, 
nfds
;

1190 
ïﬁl_evít
 
evíts
[
MAX_EVENTS
];

1191 
evít_°ru˘
 *
evt
;

1193 
i
 = 0; i < 
L_MAX
; i++)

1194 
log_Àvñ
[
i
] = 
E_WARN
;

1195 #ifde‡
ENABLE_NLS


1196 
	`£éoˇÀ
(
LC_MESSAGES
, "");

1197 
	`£éoˇÀ
(
LC_CTYPE
, "en_US.utf8");

1198 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "UsögÜoˇÀ dú %s\n", 
	`bödãxtdomaö
("möid a", 
	`gëív
("TEXTDOMAINDIR")));

1199 
	`ãxtdomaö
("minidlna");

1202 
ªt
 = 
	`öô
(
¨gc
, 
¨gv
);

1203 i‡(
ªt
 != 0)

1206 ()
	`æimô_öô
();

1208 
ªt
 = 
	`g√t_ubus_öô
();

1209 i‡(
ªt
 != 0)

1211 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "ConnectÅo UBus failed\n");

1215 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Sèπög " 
SERVER_NAME
 " vîsi⁄ " 
MINIDLNA_VERSION
 ".\n");

1216 i‡(
	`sqlôe3_libvîsi⁄_numbî
() < 3005001)

1218 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "SQLiteÜibrary is old. Please use version 3.5.1 orÇewer.\n");

1221 
ªt
 = 
	`›í_db
(
NULL
);

1222 i‡(
ªt
 == 0)

1224 
upd©eID
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT VALUE from SETTINGS where KEY = 'UPDATE_ID'");

1225 i‡(
upd©eID
 == -1)

1226 
ªt
 = -1;

1228 
	`check_db
(
db
, 
ªt
, &
sˇ¬î_pid
);

1230 #ifde‡
HAVE_INOTIFY


1231 if–
	`GETFLAG
(
INOTIFY_MASK
) )

1233 i‡(!
	`sqlôe3_thªadß„
(Ë|| 
	`sqlôe3_libvîsi⁄_numbî
() < 3005001)

1234 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "SQLiteÜibrary isÇotÅhreadsafe! "

1236 i‡(
	`±hªad_¸óã
(&
öŸify_thªad
, 
NULL
, 
°¨t_öŸify
, NULL) != 0)

1237 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "ERROR:Öthread_create() failed for start_inotify. EXITING\n");

1242 
ïﬁlfd
 = 
	`ïﬁl_¸óã
(
size
);

1243 i‡(
ïﬁlfd
 == -1)

1245 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo open socket forÉpoll. EXITING\n");

1248 
ªt
 = 
	`m⁄ô‹_öô
();

1249 i‡(
ªt
 != 0)

1251 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo init monitor. EXITING\n");

1254 
ªt
 = 
	`ssdp_öô
(
ru¡ime_v¨s
.
p‹t
);

1255 i‡(
ªt
 != 0)

1257 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo init ssdp. EXITING\n");

1260 
ªt
 = 
	`u≤phâp_öô
(
ru¡ime_v¨s
.
p‹t
);

1261 i‡(
ªt
 != 0)

1263 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailtedÅo init upnphttp. EXITING\n");

1266 #ifde‡
TIVO_SUPPORT


1267 i‡(
	`GETFLAG
(
TIVO_MASK
))

1269 
ªt
 = 
	`tivo_öô
();

1270 i‡(
ªt
 != 0)

1272 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo initÅivo. EXITING\n");

1275 
tivo_bˇ°
.
sö_Ámûy
 = 
AF_INET
;

1276 
tivo_bˇ°
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
	`gëBˇ°Addªss
());

1277 
tivo_bˇ°
.
sö_p‹t
 = 
	`ht⁄s
(2190);

1281 
	`ªlﬂd_iÁ˚s
(0);

1282 
œ°nŸifytime
 = 
	`time
(
NULL
Ë+ 
ru¡ime_v¨s
.
nŸify_öãrvÆ
;

1285 !
quôtög
)

1289 i‡(
	`gëtimeofday
(&
timeofday
, 0) < 0)

1291 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "gëtimeofday(): %s\n", 
	`°ªº‹
(
î∫o
));

1292 
timeout
 = 
ru¡ime_v¨s
.
nŸify_öãrvÆ
;

1297 i‡(
timeofday
.
tv_£c
 >(
œ°nŸifytime
 + 
ru¡ime_v¨s
.
nŸify_öãrvÆ
))

1299 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "Sending SSDPÇotifies\n");

1300 
i
 = 0; i < 
n_œn_addr
; i++)

1302 
	`SídSSDPNŸifõs
(
œn_addr
[
i
].
¢Ÿify
,Ü™_addr[i].
°r
,

1303 
ru¡ime_v¨s
.
p‹t
,Ñu¡ime_v¨s.
nŸify_öãrvÆ
);

1305 
œ°nŸifytime
 = 
timeofday
.
tv_£c
;

1306 
timeout
 = 
ru¡ime_v¨s
.
nŸify_öãrvÆ
;

1310 
timeout
 = 
œ°nŸifytime
 + 
ru¡ime_v¨s
.
nŸify_öãrvÆ
 - 
timeofday
.
tv_£c
;

1312 #ifde‡
TIVO_SUPPORT


1313 i‡(
	`GETFLAG
(
TIVO_MASK
))

1315 i‡(
timeofday
.
tv_£c
 >(
œ°bóc⁄time
.tv_£¯+ 
bóc⁄_öãrvÆ
))

1317 
	`£ndBóc⁄Mesßge
(&
tivo_bˇ°
, (
sockaddr_ö
), 1);

1318 
	`mem˝y
(&
œ°bóc⁄time
, &
timeofday
, (
timevÆ
));

1319 i‡(
timeout
 > 
bóc⁄_öãrvÆ
)

1321 
timeout
 = 
bóc⁄_öãrvÆ
;

1325 i‡(
bóc⁄_öãrvÆ
 =5 && (
timeofday
.
tv_£c
 - 
°¨tup_time
) > 60)

1327 
bóc⁄_öãrvÆ
 = 60;

1330 i‡(
timeout
 > (
œ°bóc⁄time
.
tv_£c
 + 
bóc⁄_öãrvÆ
 + 1 - 
timeofday
.tv_sec))

1332 
timeout
 = 
œ°bóc⁄time
.
tv_£c
 + 
bóc⁄_öãrvÆ
 - 
timeofday
.tv_sec;

1338 i‡(
sˇ¬ög
)

1340 i‡(!
sˇ¬î_pid
 || 
	`kûl
(scanner_pid, 0) != 0)

1342 
sˇ¬ög
 = 0;

1343 
upd©eID
++;

1348 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "epoll_wait start\n");

1349 
nfds
 = 
	`ïﬁl_waô
(
ïﬁlfd
, 
evíts
, 
MAX_EVENTS
, 
timeout
);

1350 i‡(
nfds
 < 0)

1352 if(
quôtög
)

1354 
shutdown
;

1356 if(
î∫o
 =
EINTR
)

1360 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "£À˘◊Œ): %s\n", 
	`°ªº‹
(
î∫o
));

1361 
	`DPRINTF
(
E_FATAL
, 
L_GENERAL
, "FailedÅo select open sockets. EXITING\n");

1365 i‡(
nfds
 == 0)

1367 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "ïﬁl_waôÑëu∫ %d\n", 
nfds
);

1371 
n
 = 0;Ç < 
nfds
;Ç++)

1373 
evt
 = (
evít_°ru˘
 *)
evíts
[
n
].
d©a
.
±r
;

1374 i‡(
evíts
[
n
].evít†& 
EPOLLIN
)

1377 i‡(
evt
->
ªad
.
h™dÀr
)

1379 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "ªad sèπ: %∞%p\n", 
evt
->
ªad
.
h™dÀr
,Évt->ªad.
d©a
);

1380 
evt
->
ªad
.
	`h™dÀr
”vt->ªad.
d©a
);

1381 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "readÉnd\n");

1384 i‡(
evíts
[
n
].evít†& 
EPOLLOUT
)

1387 i‡(
evt
->
wrôe
.
h™dÀr
)

1389 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "write start\n");

1390 
evt
->
wrôe
.
	`h™dÀr
”vt->wrôe.
d©a
);

1391 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "writeÉnd\n");

1397 
i
 = 
	`u≤phâp_c⁄nCou¡
();

1400 i‡(
i
 > 1)

1402 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "%dá˘ivêöcomög HTTP c⁄√˘i⁄s\n", 
i
);

1407 i‡(
i
 && (
timeofday
.
tv_£c
 >(
œ°upd©ëime
 + 2)))

1409 i‡(
sˇ¬ög
 || 
	`sqlôe3_tŸÆ_ch™ges
(
db
Ë!
œ°_ch™ge˙t
)

1411 
upd©eID
++;

1412 
œ°_ch™ge˙t
 = 
	`sqlôe3_tŸÆ_ch™ges
(
db
);

1413 
	`u≤p_evít_v¨_ch™ge_nŸify
(
EC⁄ã¡Dúe˘‹y
);

1414 
œ°upd©ëime
 = 
timeofday
.
tv_£c
;

1419 
shutdown
:

1421 i‡(
sˇ¬ög
 && 
sˇ¬î_pid
)

1422 
	`kûl
(
sˇ¬î_pid
, 9);

1424 
	`u≤phâp_exô
();

1425 
	`ssdp_exô
();

1427 #ifde‡
TIVO_SUPPORT


1428 
	`tivo_exô
();

1431 
i
 = 0; i < 
n_œn_addr
; i++)

1433 
	`SídSSDPGoodbyes
(
œn_addr
[
i
].
¢Ÿify
);

1434 
	`˛o£
(
œn_addr
[
i
].
¢Ÿify
);

1437 i‡(
öŸify_thªad
)

1438 
	`±hªad_joö
(
öŸify_thªad
, 
NULL
);

1440 
	`sql_exec
(
db
, "UPDATE SETTINGS së VALUE = '%u' whîêKEY = 'UPDATE_ID'", 
upd©eID
);

1441 
	`sqlôe3_˛o£
(
db
);

1443 
	`u≤≥víts_ªmoveSubs¸ibîs
();

1445 i‡(
pidfûíame
 && 
	`u∆ök
(pidfilename) < 0)

1446 
	`DPRINTF
(
E_ERROR
, 
L_GENERAL
, "FaûedÅÿªmovêpidfûê%s: %s\n", 
pidfûíame
, 
	`°ªº‹
(
î∫o
));

1448 
	`log_˛o£
();

1449 
	`‰ì›ti⁄s
();

1450 
	`g√t_ubus_exô
();

1452 
	`exô
(
EXIT_SUCCESS
);

1453 
	}
}

	@minidlna.h

18 #i‚de‡
__MINIDLNA_H__


19 
	#__MINIDLNA_H__


	)

21 
	~<sys/ïﬁl.h
>

23 (*
	tEVENT_HANDLER
)(*
	td©a
);

25 
	sevít_h™dÀr


27 *
d©a
;

28 
EVENT_HANDLER
 
h™dÀr
;

31 
	sevít_°ru˘


33 
sock
;

34 
evít_h™dÀr
 
ªad
;

35 
evít_h™dÀr
 
wrôe
;

38 
evít_°ru˘
 *
	`evít_mÆloc
(
sock
);

39 
	`evít_‰ì
(
evít_°ru˘
 *
evt
);

40 
	`evít_˘l
(
evít_°ru˘
 *
evt
, 
›t
, 
evts
);

41 
	`evít_dñ
(
evít_°ru˘
 *
evt
);

	@minidlnapath.h

29 #i‚de‡
__MINIDLNAPATH_H__


30 
	#__MINIDLNAPATH_H__


	)

32 
	~"c⁄fig.h
"

36 
	#ROOTDESC_PATH
 "/roŸDesc.xml"

	)

38 
	#CONTENTDIRECTORY_PATH
 "/C⁄ã¡Dú.xml"

	)

39 
	#CONTENTDIRECTORY_CONTROLURL
 "/˘l/C⁄ã¡Dú"

	)

40 
	#CONTENTDIRECTORY_EVENTURL
 "/evt/C⁄ã¡Dú"

	)

42 
	#CONNECTIONMGR_PATH
 "/C⁄√˘i⁄Mgr.xml"

	)

43 
	#CONNECTIONMGR_CONTROLURL
 "/˘l/C⁄√˘i⁄Mgr"

	)

44 
	#CONNECTIONMGR_EVENTURL
 "/evt/C⁄√˘i⁄Mgr"

	)

46 
	#X_MS_MEDIARECEIVERREGISTRAR_PATH
 "/X_MS_MedüRe˚ivîRegi°ør.xml"

	)

47 
	#X_MS_MEDIARECEIVERREGISTRAR_CONTROLURL
 "/˘l/X_MS_MedüRe˚ivîRegi°ør"

	)

48 
	#X_MS_MEDIARECEIVERREGISTRAR_EVENTURL
 "/evt/X_MS_MedüRe˚ivîRegi°ør"

	)

	@minidlnatypes.h

29 #i‚de‡
__MINIDLNATYPES_H__


30 
	#__MINIDLNATYPES_H__


	)

32 
	~"c⁄fig.h
"

33 
	~"˛õ¡s.h
"

34 
	~<time.h
>

35 
	~<f˙é.h
>

37 
	#MAX_LAN_ADDR
 4

	)

40 
	sœn_addr_s
 {

41 
	m°r
[16];

42 
ö_addr
 
	maddr
;

43 
ö_addr
 
	mmask
;

44 
	m¢Ÿify
;

45 
	mifödex
;

48 
	sru¡ime_v¨s_s
 {

49 
	mp‹t
;

50 
	mnŸify_öãrvÆ
;

51 
	mmax_c⁄√˘i⁄s
;

52 *
	mroŸ_c⁄èöî
;

53 *
	miÁ˚s
[
MAX_LAN_ADDR
];

56 
	s°rög_s
 {

57 *
	md©a
;

58 
size_t
 
	moff
;

59 
size_t
 
	msize
;

62 
uöt8_t
 
	tmedü_ty≥s
;

63 
	#NO_MEDIA
 0x00

	)

64 
	#TYPE_AUDIO
 0x01

	)

65 
	#TYPE_VIDEO
 0x02

	)

66 
	#TYPE_IMAGES
 0x04

	)

67 
	#ALL_MEDIA
 
TYPE_AUDIO
|
TYPE_VIDEO
|
TYPE_IMAGES


	)

69 
	efûe_ty≥s
 {

70 
	mTYPE_UNKNOWN
,

71 
	mTYPE_DIR
,

72 
	mTYPE_FILE


75 
	smedü_dú_s
 {

76 *
	m∑th
;

77 
medü_ty≥s
 
	mty≥s
;

78 
uöt8_t
 
	mgíabÀ
;

79 
medü_dú_s
 *
	m√xt
;

82 
	sÆbum_¨t_«me_s
 {

83 *
	m«me
;

84 
uöt8_t
 
	mwûdˇrd
;

85 
Æbum_¨t_«me_s
 *
	m√xt
;

	@minissdp.c

32 
	~"c⁄fig.h
"

34 
	~<°dio.h
>

35 
	~<°dlib.h
>

36 
	~<°rög.h
>

37 
	~<˘y≥.h
>

38 
	~<uni°d.h
>

39 
	~<sys/sockë.h
>

40 
	~<sys/un.h
>

41 
	~<√töë/ö.h
>

42 
	~<¨∑/öë.h
>

43 
	~<î∫o.h
>

45 
	~"möid ≠©h.h
"

46 
	~"möid a.h
"

47 
	~"u≤phâp.h
"

48 
	~"u≤pglobÆv¨s.h
"

49 
	~"u≤¥ïly∑r£.h
"

50 
	~"gëiÁddr.h
"

51 
	~"möissdp.h
"

52 
	~"codñígth.h
"

53 
	~"utûs.h
"

54 
	~"log.h
"

57 
	#SSDP_PORT
 (1900)

	)

58 
	#SSDP_MCAST_ADDR
 ("239.255.255.250")

	)

60 
ssdp_ªque°
 
	gssd¥eq
;

61 
	gsssdp
 = -1;

64 
	$AddMu…iˇ°Membîshù
(
s
, 
œn_addr_s
 *
iÁ˚
)

66 
ªt
;

67 #ifde‡
HAVE_STRUCT_IP_MREQN


68 
ù_mªqn
 
imr
;

70 
imr
.
imr_mu…üddr
.
s_addr
 = 
	`öë_addr
(
SSDP_MCAST_ADDR
);

71 
imr
.
imr_ifödex
 = 
iÁ˚
->
ifödex
;

73 
ù_mªq
 
imr
;

75 
imr
.
imr_mu…üddr
.
s_addr
 = 
	`öë_addr
(
SSDP_MCAST_ADDR
);

76 
imr
.
imr_öãrÁ˚
.
s_addr
 = 
iÁ˚
->
addr
.s_addr;

78 
ªt
 = 
	`£tsock›t
(
s
, 
IPPROTO_IP
, 
IP_ADD_MEMBERSHIP
, (*)&
imr
, (imr));

79 i‡(
ªt
 < 0 && 
î∫o
 !
EADDRINUSE
)

81 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "setsockopt(udp, IP_ADD_MEMBERSHIP): %s\n",

82 
	`°ªº‹
(
î∫o
));

87 
	}
}

92 
	$O≥nAndC⁄fSSDPRe˚iveSockë
()

94 
s
;

95 
i
 = 1;

96 
sockaddr_ö
 
sock«me
;

98 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_DGRAM
, 0);

99 i‡(
s
 < 0)

101 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "sockë(udp): %s\n", 
	`°ªº‹
(
î∫o
));

105 i‡(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
i
, (i)) < 0)

106 
	`DPRINTF
(
E_WARN
, 
L_SSDP
, "£tsock›t(udp, SO_REUSEADDR): %s\n", 
	`°ªº‹
(
î∫o
));

108 
	`mem£t
(&
sock«me
, 0, (
sockaddr_ö
));

109 
sock«me
.
sö_Ámûy
 = 
AF_INET
;

110 
sock«me
.
sö_p‹t
 = 
	`ht⁄s
(
SSDP_PORT
);

112 
sock«me
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_ANY
);

114 i‡(
	`böd
(
s
, (
sockaddr
 *)&
sock«me
, (
sockaddr_ö
)) < 0)

116 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "böd(udp): %s\n", 
	`°ªº‹
(
î∫o
));

117 
	`˛o£
(
s
);

121  
s
;

122 
	}
}

127 
	$O≥nAndC⁄fSSDPNŸifySockë
(
œn_addr_s
 *
iÁ˚
)

129 
s
;

130 
lo›ch¨
 = 0;

131 
bˇ°
 = 1;

132 
uöt8_t
 
âl
 = 4;

133 
ö_addr
 
mc_if
;

134 
sockaddr_ö
 
sock«me
;

136 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_DGRAM
, 0);

137 i‡(
s
 < 0)

139 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "sockë(udp_nŸify): %s\n", 
	`°ªº‹
(
î∫o
));

143 
mc_if
.
s_addr
 = 
iÁ˚
->
addr
.s_addr;

145 i‡(
	`£tsock›t
(
s
, 
IPPROTO_IP
, 
IP_MULTICAST_LOOP
, (*)&
lo›ch¨
, (loopchar)) < 0)

147 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£tsock›t(udp_nŸify, IP_MULTICAST_LOOP): %s\n", 
	`°ªº‹
(
î∫o
));

148 
	`˛o£
(
s
);

152 i‡(
	`£tsock›t
(
s
, 
IPPROTO_IP
, 
IP_MULTICAST_IF
, (*)&
mc_if
, (mc_if)) < 0)

154 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£tsock›t(udp_nŸify, IP_MULTICAST_IF): %s\n", 
	`°ªº‹
(
î∫o
));

155 
	`˛o£
(
s
);

159 
	`£tsock›t
(
s
, 
IPPROTO_IP
, 
IP_MULTICAST_TTL
, &
âl
, (ttl));

161 i‡(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_BROADCAST
, &
bˇ°
, (bcast)) < 0)

163 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£tsock›t(udp_nŸify, SO_BROADCAST): %s\n", 
	`°ªº‹
(
î∫o
));

164 
	`˛o£
(
s
);

168 
	`mem£t
(&
sock«me
, 0, (
sockaddr_ö
));

169 
sock«me
.
sö_Ámûy
 = 
AF_INET
;

170 
sock«me
.
sö_addr
.
s_addr
 = 
iÁ˚
->
addr
.s_addr;

172 i‡(
	`böd
(
s
, (
sockaddr
 *)&
sock«me
, (
sockaddr_ö
)) < 0)

174 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "böd(udp_nŸify): %s\n", 
	`°ªº‹
(
î∫o
));

175 
	`˛o£
(
s
);

179 i‡(
	`AddMu…iˇ°Membîshù
(
sssdp
, 
iÁ˚
) < 0)

181 
	`DPRINTF
(
E_WARN
, 
L_SSDP
, "FailedÅoádd multicast membership foráddress %s\n",

182 
iÁ˚
->
°r
);

185  
s
;

186 
	}
}

188 c⁄° * c⁄° 
	gknown_£rvi˚_ty≥s
[] =

190 
uuidvÆue
,

200 
	$_u¶ìp
(
u£cs
)

202 
time•ec
 
¶ìp_time
;

204 
¶ìp_time
.
tv_£c
 = 0;

205 
¶ìp_time
.
tv_n£c
 = 
u£cs
 * 1000;

206 
	`«no¶ìp
(&
¶ìp_time
, 
NULL
);

207 
	}
}

212 
	$SídSSDPRe•⁄£
(
s
, 
sockaddr_ö
 
sock«me
, 
°_no
,

213 c⁄° *
ho°
, 
p‹t
)

215 
l
, 
n
;

216 
buf
[512];

217 
tm°r
[30];

218 
time_t
 
tm
 = 
	`time
(
NULL
);

227 
	`°r·ime
(
tm°r
, —m°r), "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(&
tm
));

228 
l
 = 
	`¢¥ötf
(
buf
, (buf), "HTTP/1.1 200 OK\r\n"

234 "SERVER: " 
MINIDLNA_SERVER_STRING
 "\r\n"

235 "LOCATION: hâp://%s:%u" 
ROOTDESC_PATH
 "\r\n"

238 (
ru¡ime_v¨s
.
nŸify_öãrvÆ
<<1)+10,

239 
tm°r
,

240 
known_£rvi˚_ty≥s
[
°_no
],

241 (
°_no
>1?"1":""),

242 
uuidvÆue
,

243 (
°_no
 > 0 ? "::" : ""),

244 (
°_no
 > 0 ? 
known_£rvi˚_ty≥s
[st_no] : ""),

245 (
°_no
 > 1 ? "1" : ""),

246 
ho°
, ()
p‹t
);

247 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "Sending M-SEARCHÑesponseÅo %s:%d ST: %s\n",

248 
	`öë_¡ﬂ
(
sock«me
.
sö_addr
), 
	`¡ohs
(sock«me.
sö_p‹t
),

249 
known_£rvi˚_ty≥s
[
°_no
]);

250 
n
 = 
	`£ndto
(
s
, 
buf
, 
l
, 0,

251 (
sockaddr
 *)&
sock«me
, (
sockaddr_ö
) );

252 i‡(
n
 < 0)

253 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£ndto(udp): %s\n", 
	`°ªº‹
(
î∫o
));

254 
	}
}

257 
	$SídSSDPNŸifõs
(
s
, c⁄° *
ho°
, 
p‹t
,

258 
öãrvÆ
)

260 
sockaddr_ö
 
sock«me
;

261 
l
, 
n
, 
dup
, 
i
=0;

262 
li„time
;

263 
bu‰
[512];

265 
	`mem£t
(&
sock«me
, 0, (
sockaddr_ö
));

266 
sock«me
.
sö_Ámûy
 = 
AF_INET
;

267 
sock«me
.
sö_p‹t
 = 
	`ht⁄s
(
SSDP_PORT
);

268 
sock«me
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
SSDP_MCAST_ADDR
);

269 
li„time
 = (
öãrvÆ
 << 1) + 10;

271 
dup
 = 0; dup < 2; dup++)

273 i‡(
dup
)

274 
	`_u¶ìp
(200000);

275 
i
 = 0;

276 
known_£rvi˚_ty≥s
[
i
])

278 
l
 = 
	`¢¥ötf
(
bu‰
, (bufr),

282 "LOCATION:hâp://%s:%d" 
ROOTDESC_PATH
"\r\n"

283 "SERVER: " 
MINIDLNA_SERVER_STRING
 "\r\n"

288 
SSDP_MCAST_ADDR
, 
SSDP_PORT
,

289 
li„time
,

290 
ho°
, 
p‹t
,

291 
known_£rvi˚_ty≥s
[
i
],

292 (
i
 > 1 ? "1" : ""),

293 
uuidvÆue
,

294 (
i
 > 0 ? "::" : ""),

295 (
i
 > 0 ? 
known_£rvi˚_ty≥s
[i] : ""),

296 (
i
 > 1 ? "1" : ""));

297 i‡(
l
 >(
bu‰
))

299 
	`DPRINTF
(
E_WARN
, 
L_SSDP
, "SendSSDPNotifies():Åruncated output\n");

300 
l
 = (
bu‰
);

302 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SSDP
, "Sídög ssdp:Æivê[%d]\n", 
s
);

303 
n
 = 
	`£ndto
(
s
, 
bu‰
, 
l
, 0,

304 (
sockaddr
 *)&
sock«me
, (
sockaddr_ö
));

305 i‡(
n
 < 0)

306 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£ndto(udp_nŸify=%d, %s): %s\n", 
s
, 
ho°
, 
	`°ªº‹
(
î∫o
));

307 
i
++;

310 
	}
}

313 
	$P¨£UPnPClõ¡
(*
loˇti⁄
)

315 
buf
[8192];

316 
sockaddr_ö
 
de°
;

317 
s
, 
n
, 
do_hódîs
 = 0, 
ƒód
 = 0;

318 
timevÆ
 
tv
;

319 *
addr
, *
∑th
, *
p‹t_°r
;

320 
p‹t
 = 80;

321 *
off
 = 
NULL
, *
p
;

322 
c⁄ã¡_Àn
 = (
buf
);

323 
NameVÆueP¨£rD©a
 
xml
;

324 
˛õ¡
;

325 
ty≥
 = 0;

326 *
modñ
, *
£rül
, *
«me
;

328 i‡(
	`°∫cmp
(
loˇti⁄
, "http://", 7) != 0)

330 
∑th
 = 
loˇti⁄
 + 7;

331 
p‹t_°r
 = 
	`°r£p
(&
∑th
, "/");

332 i‡(!
∑th
)

334 
addr
 = 
	`°r£p
(&
p‹t_°r
, ":");

335 i‡(
p‹t_°r
)

337 
p‹t
 = 
	`°πﬁ
(
p‹t_°r
, 
NULL
, 10);

338 i‡(!
p‹t
)

339 
p‹t
 = 80;

342 
	`mem£t
(&
de°
, '\0', (dest));

343 i‡(!
	`öë_©⁄
(
addr
, &
de°
.
sö_addr
))

346 
de°
.
sö_Ámûy
 = 
AF_INET
;

347 
de°
.
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

349 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

350 i‡(
s
 < 0)

353 
tv
.
tv_£c
 = 0;

354 
tv
.
tv_u£c
 = 500000;

355 
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_RCVTIMEO
, &
tv
, (tv));

356 
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_SNDTIMEO
, &
tv
, (tv));

358 i‡(
	`c⁄√˘
(
s
, (
sockaddr
*)&
de°
, (
sockaddr_ö
)) < 0)

359 
˛o£
;

361 
n
 = 
	`¢¥ötf
(
buf
, (buf), "GET /%s HTTP/1.0\r\n"

363 
∑th
, 
addr
, 
p‹t
);

364 i‡(
	`wrôe
(
s
, 
buf
, 
n
) < 1)

365 
˛o£
;

367 (
n
 = 
	`ªad
(
s
, 
buf
+
ƒód
, (buf)-nread-1)) > 0)

369 
ƒód
 +
n
;

370 
buf
[
ƒód
] = '\0';

371 
n
 = 
ƒód
;

372 
p
 = 
buf
;

374 !
off
 && (
n
-- > 0))

376 i‡(
p
[0] == '\r' &&Ö[1] == '\n' &&Ö[2] == '\r' &&Ö[3] == '\n')

378 
off
 = 
p
 + 4;

379 
do_hódîs
 = 1;

381 
p
++;

383 i‡(!
off
)

386 i‡(
do_hódîs
)

388 
p
 = 
buf
;

389 i‡(
	`°∫cmp
(
p
, "HTTP/", 5) != 0)

390 
˛o£
;

391 *
p
 != ' ' && *p != '\t')

392 
p
++;

394 i‡(
	`°πﬁ
(
p
, 
NULL
, 10) != 200)

395 
˛o£
;

396 
p
 = 
	`°rˇ£°r
(p, "Content-Length:");

397 i‡(
p
)

398 
c⁄ã¡_Àn
 = 
	`°πﬁ
(
p
+15, 
NULL
, 10);

399 
do_hódîs
 = 0;

401 i‡((
buf
 + 
ƒód
 - 
off
Ë>
c⁄ã¡_Àn
)

404 
˛o£
:

405 
	`˛o£
(
s
);

406 i‡(!
off
)

408 
ƒód
 -
off
 - 
buf
;

409 
	`P¨£NameVÆue
(
off
, 
ƒód
, &
xml
, 0);

410 
modñ
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "modelName");

411 
£rül
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "serialNumber");

412 
«me
 = 
	`GëVÆueFromNameVÆueLi°
(&
xml
, "friendlyName");

413 i‡(
modñ
)

415 
i
;

416 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "Modñ: %s\n", 
modñ
);

417 
i
 = 0; 
˛õ¡_ty≥s
[i].
«me
; i++)

419 i‡(
˛õ¡_ty≥s
[
i
].
m©ch_ty≥
 !
EModñName
)

421 i‡(
	`°r°r
(
modñ
, 
˛õ¡_ty≥s
[
i
].
m©ch
Ë!
NULL
)

423 
ty≥
 = 
i
;

429 i‡(
ty≥
 > 0 && 
˛õ¡_ty≥s
[ty≥].ty≥ =
ESamsungSîõsB
)

431 i‡(
£rül
)

433 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "Sîül: %s\n", 
£rül
);

435 i‡(
	`©oi
(
£rül
) < 20081201)

436 
ty≥
 = 0;

440 
ty≥
 = 0;

444 i‡(
ty≥
 =0 && 
«me
 !
NULL
)

446 
i
 = 0; 
˛õ¡_ty≥s
[i].
«me
; i++)

448 i‡(
˛õ¡_ty≥s
[
i
].
m©ch_ty≥
 !
EFrõndlyNameSSDP
)

450 i‡(
	`°rcmp
(
«me
, 
˛õ¡_ty≥s
[
i
].
m©ch
) == 0)

452 
ty≥
 = 
i
;

458 
	`CÀ¨NameVÆueLi°
(&
xml
);

459 i‡(!
ty≥
)

462 
˛õ¡
 = 
	`SórchClõ¡Cache
(
de°
.
sö_addr
, 1);

463 i‡(
˛õ¡
 < 0)

465 
	`AddClõ¡Cache
(
de°
.
sö_addr
, 
ty≥
);

469 
˛õ¡s
[
˛õ¡
].
ty≥
 =Åype;

470 
˛õ¡s
[
˛õ¡
].
age
 = 
	`time
(
NULL
);

472 
	}
}

477 
	$Pro˚ssSSDPReque°
(
ssdp_ªque°
 *
ªque°
)

479 
s
 = 
ªque°
->
sock
;

480 
p‹t
 = 
ªque°
->port;

481 
n
;

482 
bu‰
[1500];

483 
sockÀn_t
 
Àn_r
;

484 
sockaddr_ö
 
£ndî«me
;

485 
i
;

486 *
°
 = 
NULL
, *
mx
 = NULL, *
m™
 = NULL, *
mx_íd
 = NULL;

487 
m™_Àn
 = 0;

488 
Àn_r
 = (
sockaddr_ö
);

490 
n
 = 
	`ªcv‰om
(
s
, 
bu‰
, (bufr)-1, 0,

491 (
sockaddr
 *)&
£ndî«me
, &
Àn_r
);

492 i‡(
n
 < 0)

494 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "ªcv‰om(udp): %s\n", 
	`°ªº‹
(
î∫o
));

497 
bu‰
[
n
] = '\0';

498 
n
 -= 2;

500 i‡(
	`memcmp
(
bu‰
, "NOTIFY", 6) == 0)

502 *
loc
 = 
NULL
, *
§v
 = NULL, *
¡s
 = NULL, *
¡
 = NULL;

503 
loc_Àn
 = 0;

505 
i
 = 0; i < 
n
; i++)

507 if–
bu‰
[
i
] == '*' )

510 i‡(
	`°rˇ£°rc
(
bu‰
+
i
, "HTTP/1.1", '\r'Ë=
NULL
)

512 
i
 < 
n
)

514 (
i
 < 
n
Ë&& (
bu‰
[i] != '\r' || bufr[i+1] != '\n'))

515 
i
++;

516 
i
 += 2;

517 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "SERVER:", 7) == 0)

519 
§v
 = 
bu‰
+
i
+7;

520 *
§v
 == ' ' || *srv == '\t')

521 
§v
++;

523 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "LOCATION:", 9) == 0)

525 
loc
 = 
bu‰
+
i
+9;

526 *
loc
 == ' ' || *loc == '\t')

527 
loc
++;

528 
loc
[
loc_Àn
]!='\r' &&Üoc[loc_len]!='\n')

529 
loc_Àn
++;

531 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "NTS:", 4) == 0)

533 
¡s
 = 
bu‰
+
i
+4;

534 *
¡s
 == ' ' || *nts == '\t')

535 
¡s
++;

537 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "NT:", 3) == 0)

539 
¡
 = 
bu‰
+
i
+3;

540 *
¡
 == ' ' || *nt == '\t')

541 
¡
++;

544 i‡(!
loc
 || !
§v
 || !
¡
 || !
¡s
 || (
	`°∫cmp
(nts, "ssdp:alive", 10) != 0) ||

545 (
	`°∫cmp
(
¡
, "urn:schemas-upnp-org:device:MediaRenderer", 41) != 0))

547 
loc
[
loc_Àn
] = '\0';

548 i‡((
	`°∫cmp
(
§v
, "Allegro-Software-RomPlug", 24) == 0) ||

549 (
	`°r°r
(
loc
, "SamsungMRDesc.xml"Ë!
NULL
) ||

550 (
	`°r°rc
(
§v
, "DigiO¿DiXiM", '\r'Ë!
NULL
))

553 
i
 = 
	`SórchClõ¡Cache
(
£ndî«me
.
sö_addr
, 1);

554 i‡(
i
 >= 0)

556 i‡(
˛õ¡s
[
i
].
ty≥
 < 
ESènd¨dDLNA150
 &&

557 
˛õ¡s
[
i
].
ty≥
 !
ESamsungSîõsA
)

559 
˛õ¡s
[
i
].
age
 = 
	`time
(
NULL
);

563 
	`P¨£UPnPClõ¡
(
loc
);

566 i‡(
	`memcmp
(
bu‰
, "M-SEARCH", 8) == 0)

568 
°_Àn
 = 0, 
mx_Àn
 = 0, 
mx_vÆ
 = 0;

570 
i
 = 0; i < 
n
; i++)

572 i‡(
bu‰
[
i
] == '*')

575 i‡(
	`°rˇ£°rc
(
bu‰
+
i
, "HTTP/1.1", '\r'Ë=
NULL
)

577 
i
 < 
n
)

579 (
i
 < 
n
Ë&& (
bu‰
[i] != '\r' || bufr[i+1] != '\n'))

580 
i
++;

581 
i
 += 2;

582 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "ST:", 3) == 0)

584 
°
 = 
bu‰
+
i
+3;

585 
°_Àn
 = 0;

586 *
°
 == ' ' || *st == '\t')

587 
°
++;

588 
°
[
°_Àn
]!='\r' && st[st_len]!='\n')

589 
°_Àn
++;

591 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "MX:", 3) == 0)

593 
mx
 = 
bu‰
+
i
+3;

594 
mx_Àn
 = 0;

595 *
mx
 == ' ' || *mx == '\t')

596 
mx
++;

597 
mx
[
mx_Àn
]!='\r' && mx[mx_len]!='\n')

598 
mx_Àn
++;

599 
mx_vÆ
 = 
	`°πﬁ
(
mx
, &
mx_íd
, 10);

601 i‡(
	`°∫ˇ£cmp
(
bu‰
+
i
, "MAN:", 4) == 0)

603 
m™
 = 
bu‰
+
i
+4;

604 
m™_Àn
 = 0;

605 *
m™
 == ' ' || *man == '\t')

606 
m™
++;

607 
m™
[
m™_Àn
]!='\r' && man[man_len]!='\n')

608 
m™_Àn
++;

613 i‡(
	`GETFLAG
(
DLNA_STRICT_MASK
Ë&& (
	`¡ohs
(
£ndî«me
.
sö_p‹t
) <= 1024 ||Çtohs(sendername.sin_port) == 1900))

615 
	`DPRINTF
(
E_INFO
, 
L_SSDP
, "WARNING: Ignoring invalid SSDP M-SEARCH from %s [bad sourceÖort %d]\n",

616 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
), 
	`¡ohs
(£ndî«me.
sö_p‹t
));

618 i‡(!
m™
 || (
	`°∫cmp
(man, "\"ssdp:discover\"", 15) != 0))

620 
	`DPRINTF
(
E_INFO
, 
L_SSDP
, "WARNING: Ignoring invalid SSDP M-SEARCH from %s [bad %s header '%.*s']\n",

621 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
), "MAN", 
m™_Àn
, 
m™
);

623 i‡(!
mx
 || mx =
mx_íd
 || 
mx_vÆ
 < 0)

625 
	`DPRINTF
(
E_INFO
, 
L_SSDP
, "WARNING: Ignoring invalid SSDP M-SEARCH from %s [bad %s header '%.*s']\n",

626 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
), "MX", 
mx_Àn
, 
mx
);

628 i‡(
°
 && (
°_Àn
 > 0))

630 
l
;

631 
iÁ˚
 = 0;

633 
i
 = 0; i < 
n_œn_addr
; i++)

635 if((
£ndî«me
.
sö_addr
.
s_addr
 & 
œn_addr
[
i
].
mask
.s_addr) ==

636 (
œn_addr
[
i
].
addr
.
s_addr
 &Ü™_addr[i].
mask
.s_addr))

638 
iÁ˚
 = 
i
;

642 i‡(
n_œn_addr
 =
i
)

644 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "Ignoring SSDP M-SEARCH on other interface [%s]\n",

645 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
));

648 
	`DPRINTF
(
E_DEBUG
, 
L_SSDP
, "SSDP M-SEARCH from %s:%d ST: %.*s, MX: %.*s, MAN: %.*s\n",

649 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
),

650 
	`¡ohs
(
£ndî«me
.
sö_p‹t
),

651 
°_Àn
, 
°
, 
mx_Àn
, 
mx
, 
m™_Àn
, 
m™
);

653 
i
 = 0; 
known_£rvi˚_ty≥s
[i]; i++)

655 
l
 = 
	`°æí
(
known_£rvi˚_ty≥s
[
i
]);

656 i‡((
l
 > 
°_Àn
Ë|| (
	`memcmp
(
°
, 
known_£rvi˚_ty≥s
[
i
],Ü) != 0))

658 i‡(
°_Àn
 !
l
)

661 i‡((
°
[
l
-1] == ':') && (st[l] == '1'))

662 
l
++;

663 
l
 < 
°_Àn
)

665 i‡(
	`isdigô
(
°
[
l
]))

667 i‡(
	`is•a˚
(
°
[
l
]))

669 
l
++;

672 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SSDP
,

674 
°
[
l
], 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
));

677 i‡(
l
 !
°_Àn
)

680 
	`_u¶ìp
(
	`øndom
()>>20);

681 
	`SídSSDPRe•⁄£
(
s
, 
£ndî«me
, 
i
,

682 
œn_addr
[
iÁ˚
].
°r
, 
p‹t
);

687 i‡((
°_Àn
 =8Ë&& (
	`memcmp
(
°
, "ssdp:all", 8) == 0))

689 
i
=0; 
known_£rvi˚_ty≥s
[i]; i++)

691 
l
 = 
	`°æí
(
known_£rvi˚_ty≥s
[
i
]);

692 
	`SídSSDPRe•⁄£
(
s
, 
£ndî«me
, 
i
,

693 
œn_addr
[
iÁ˚
].
°r
, 
p‹t
);

699 
	`DPRINTF
(
E_INFO
, 
L_SSDP
, "Invalid SSDP M-SEARCH from %s:%d\n",

700 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
), 
	`¡ohs
(£ndî«me.
sö_p‹t
));

703 i‡(
	`memcmp
(
bu‰
, "YOUKU-NOTIFY", 12) == 0)

709 
	`DPRINTF
(
E_WARN
, 
L_SSDP
, "Unknown udpÖacketÑeceived from %s:%d\n",

710 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
), 
	`¡ohs
(£ndî«me.
sö_p‹t
));

712 
	}
}

717 
	$SídSSDPGoodbyes
(
s
)

719 
sockaddr_ö
 
sock«me
;

720 
n
, 
l
;

721 
i
;

722 
dup
, 
ªt
 = 0;

723 
bu‰
[512];

725 
	`mem£t
(&
sock«me
, 0, (
sockaddr_ö
));

726 
sock«me
.
sö_Ámûy
 = 
AF_INET
;

727 
sock«me
.
sö_p‹t
 = 
	`ht⁄s
(
SSDP_PORT
);

728 
sock«me
.
sö_addr
.
s_addr
 = 
	`öë_addr
(
SSDP_MCAST_ADDR
);

730 
dup
 = 0; dup < 2; dup++)

732 
i
 = 0; 
known_£rvi˚_ty≥s
[i]; i++)

734 
l
 = 
	`¢¥ötf
(
bu‰
, (bufr),

741 
SSDP_MCAST_ADDR
, 
SSDP_PORT
,

742 
known_£rvi˚_ty≥s
[
i
],

743 (
i
 > 1 ? "1" : ""), 
uuidvÆue
,

744 (
i
 > 0 ? "::" : ""),

745 (
i
 > 0 ? 
known_£rvi˚_ty≥s
[i] : ""),

746 (
i
 > 1 ? "1" : ""));

747 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SSDP
, "Sídög ssdp:byebyê[%d]\n", 
s
);

748 
n
 = 
	`£ndto
(
s
, 
bu‰
, 
l
, 0,

749 (
sockaddr
 *)&
sock«me
, (
sockaddr_ö
) );

750 i‡(
n
 < 0)

752 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "£ndto(udp_shutdown=%d): %s\n", 
s
, 
	`°ªº‹
(
î∫o
));

753 
ªt
 = -1;

758  
ªt
;

759 
	}
}

765 
	$SubmôSîvi˚sToMöiSSDPD
(c⁄° *
ho°
, 
p‹t
)

767 
sockaddr_un
 
addr
;

768 
s
;

769 
buf„r
[2048];

770 
°rbuf
[256];

771 *
p
;

772 
i
, 
l
;

774 
s
 = 
	`sockë
(
AF_UNIX
, 
SOCK_STREAM
, 0);

775 i‡(
s
 < 0)

777 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "sockë(unix): %s", 
	`°ªº‹
(
î∫o
));

780 
addr
.
sun_Ámûy
 = 
AF_UNIX
;

781 
	`°∫˝y
(
addr
.
sun_∑th
, 
möissdpdsockë∑th
, (addr.sun_path));

782 i‡(
	`c⁄√˘
(
s
, (
sockaddr
 *)&
addr
, (
sockaddr_un
)) < 0)

784 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "connect(\"%s\"): %s",

785 
möissdpdsockë∑th
, 
	`°ªº‹
(
î∫o
));

786 
	`˛o£
(
s
);

789 
i
 = 0; 
known_£rvi˚_ty≥s
[i]; i++)

791 
buf„r
[0] = 4;

792 
p
 = 
buf„r
 + 1;

793 
l
 = 
	`°æí
(
known_£rvi˚_ty≥s
[
i
]);

794 i‡(
i
 > 0)

795 
l
++;

796 
	`CODELENGTH
(
l
, 
p
);

797 
	`mem˝y
(
p
, 
known_£rvi˚_ty≥s
[
i
], 
l
);

798 i‡(
i
 > 0)

799 
p
[
l
-1] = '1';

800 
p
 +
l
;

801 
l
 = 
	`¢¥ötf
(
°rbuf
, (strbuf), "%s::%s%s",

802 
uuidvÆue
, 
known_£rvi˚_ty≥s
[
i
], (i==0)?"":"1");

803 
	`CODELENGTH
(
l
, 
p
);

804 
	`mem˝y
(
p
, 
°rbuf
, 
l
);

805 
p
 +
l
;

806 
l
 = 
	`°æí
(
MINIDLNA_SERVER_STRING
);

807 
	`CODELENGTH
(
l
, 
p
);

808 
	`mem˝y
(
p
, 
MINIDLNA_SERVER_STRING
, 
l
);

809 
p
 +
l
;

810 
l
 = 
	`¢¥ötf
(
°rbuf
, (°rbuf), "hâp://%s:%u" 
ROOTDESC_PATH
,

811 
ho°
, ()
p‹t
);

812 
	`CODELENGTH
(
l
, 
p
);

813 
	`mem˝y
(
p
, 
°rbuf
, 
l
);

814 
p
 +
l
;

815 if(
	`wrôe
(
s
, 
buf„r
, 
p
 - buffer) < 0)

817 
	`DPRINTF
(
E_ERROR
, 
L_SSDP
, "wrôe(): %s", 
	`°ªº‹
(
î∫o
));

818 
	`˛o£
(
s
);

822 
	`˛o£
(
s
);

824 
	}
}

826 
	$ssdp_öô
(
p‹t
)

828 
evít_°ru˘
 *
evt
;

829 
ªt
;

831 
sssdp
 = 
	`O≥nAndC⁄fSSDPRe˚iveSockë
();

832 i‡(
sssdp
 < 0)

834 
	`DPRINTF
(
E_INFO
, 
L_SSDP
, "FailedÅo open socket forÑeceiving SSDP. TryingÅo use MiniSSDPd\n");

835 i‡(
	`SubmôSîvi˚sToMöiSSDPD
(
œn_addr
[0].
°r
, 
ru¡ime_v¨s
.
p‹t
) < 0)

836 
	`DPRINTF
(
E_FATAL
, 
L_SSDP
, "FailedÅo connectÅo MiniSSDPd. EXITING");

838 
evt
 = 
	`evít_mÆloc
(
sssdp
);

839 i‡(!
evt
)

841 
	`DPRINTF
(
E_FATAL
, 
L_SSDP
, "FailedÅo mallocÉvent_struct. EXITING\n");

843 
evt
->
ªad
.
d©a
 = &
ssd¥eq
;

844 
evt
->
ªad
.
h™dÀr
 = (
EVENT_HANDLER
)
Pro˚ssSSDPReque°
;

845 
ssd¥eq
.
sock
 = 
sssdp
;

846 
ssd¥eq
.
p‹t
 = ()port;

847 
ªt
 = 
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLIN
);

848 i‡(
ªt
 != 0)

850 
	`DPRINTF
(
E_FATAL
, 
L_SSDP
, "FailedÅoÉvent_ctl sssdp. EXITING\n");

853  
ªt
;

854 
	}
}

856 
	$ssdp_exô
()

858 i‡(
sssdp
 >= 0)

860 
	`˛o£
(
sssdp
);

861 
sssdp
 = -1;

863 
	}
}

	@minissdp.h

29 #i‚de‡
__MINISSDP_H__


30 
	#__MINISSDP_H__


	)

32 
	sssdp_ªque°


34 
	msock
;

35 
	mp‹t
;

38 
O≥nAndC⁄fSSDPRe˚iveSockë
();

40 
O≥nAndC⁄fSSDPNŸifySockë
(
œn_addr_s
 *
iÁ˚
);

42 
SídSSDPNŸifõs
(
s
, c⁄° *
ho°
, 
p‹t
, 
li„time
);

44 
Pro˚ssSSDPReque°
(
ssdp_ªque°
 *
ªque°
);

46 
SídSSDPGoodbyes
(
s
);

48 
SubmôSîvi˚sToMöiSSDPD
(c⁄° *
ho°
, 
p‹t
);

50 
ssdp_öô
(
p‹t
);

51 
ssdp_exô
();

	@minixml.c

32 
	~"möixml.h
"

33 
	~"u≤¥ïly∑r£.h
"

38 
	$∑r£©t
(
xmÕ¨£r
 * 
p
)

40 c⁄° * 
©äame
;

41 
©äamñí
;

42 c⁄° * 
©tvÆue
;

43 
©tvÆuñí
;

44 
p
->
xml
 <Ö->
xmÀnd
)

46 if(*
p
->
xml
=='/' || *p->xml=='>')

48 if–!
	`IS_WHITE_SPACE
(*
p
->
xml
) )

50 
£p
;

51 
©äame
 = 
p
->
xml
;

52 
©äamñí
 = 0;

53 *
p
->
xml
!='=' && !
	`IS_WHITE_SPACE
(*p->xml) )

55 
©äamñí
++; 
p
->
xml
++;

56 if(
p
->
xml
 >p->
xmÀnd
)

59 *(
p
->
xml
++) != '=')

61 if(
p
->
xml
 >p->
xmÀnd
)

64 
	`IS_WHITE_SPACE
(*
p
->
xml
))

66 
p
->
xml
++;

67 if(
p
->
xml
 >p->
xmÀnd
)

70 
£p
 = *
p
->
xml
;

71 if(
£p
=='\'' || sep=='\"')

73 
p
->
xml
++;

74 if(
p
->
xml
 >p->
xmÀnd
)

76 
©tvÆue
 = 
p
->
xml
;

77 
©tvÆuñí
 = 0;

78 *
p
->
xml
 !
£p
)

80 
©tvÆuñí
++; 
p
->
xml
++;

81 if(
p
->
xml
 >p->
xmÀnd
)

87 
©tvÆue
 = 
p
->
xml
;

88 
©tvÆuñí
 = 0;

89  !
	`IS_WHITE_SPACE
(*
p
->
xml
)

90 && *
p
->
xml
 != '>' && *p->xml != '/')

92 
©tvÆuñí
++; 
p
->
xml
++;

93 if(
p
->
xml
 >p->
xmÀnd
)

99 if(
p
->
©tfunc
)

100 
p
->
	`©tfunc
’->
d©a
, 
©äame
, 
©äamñí
, 
©tvÆue
, 
©tvÆuñí
);

102 
p
->
xml
++;

105 
	}
}

109 
	$∑r£ñt
(
xmÕ¨£r
 * 
p
)

111 
i
;

112 c⁄° * 
ñemíäame
;

113 
p
->
xml
 < (p->
xmÀnd
 - 1))

115 if((
p
->
xml
)[0]=='<' && (p->xml)[1]!='?')

117 
i
 = 0; 
ñemíäame
 = ++
p
->
xml
;

118  !
	`IS_WHITE_SPACE
(*
p
->
xml
)

119 && (*
p
->
xml
!='>') && (*p->xml!='/')

122 
i
++; 
p
->
xml
++;

123 i‡(
p
->
xml
 >p->
xmÀnd
)

126 if(*
p
->
xml
==':')

128 
i
 = 0;

129 
ñemíäame
 = ++
p
->
xml
;

132 if(
i
>0)

134 if(
p
->
°¨ã…func
)

135 
p
->
	`°¨ã…func
’->
d©a
, 
ñemíäame
, 
i
);

136 if(
	`∑r£©t
(
p
))

138 if(*
p
->
xml
!='/')

140 c⁄° * 
d©a
;

141 
i
 = 0; 
d©a
 = ++
p
->
xml
;

142 i‡(
p
->
xml
 >p->
xmÀnd
)

144  
	`IS_WHITE_SPACE
(*
p
->
xml
) )

146 
p
->
xml
++;

147 i‡(
p
->
xml
 >p->
xmÀnd
)

150 *
p
->
xml
!='<')

152 
i
++; 
p
->
xml
++;

153 i‡(
p
->
xml
 >p->
xmÀnd
)

156 i‡(
p
->
d©afunc
)

158 i‡(
i
 > 0 || (
p
->
Êags
 & 
XML_STORE_EMPTY_FL
))

159 
p
->
	`d©afunc
’->
d©a
, d©a, 
i
);

163 if(*
p
->
xml
 == '/')

165 
i
 = 0; 
ñemíäame
 = ++
p
->
xml
;

166 i‡(
p
->
xml
 >p->
xmÀnd
)

168 (*
p
->
xml
 != '>'))

170 
i
++; 
p
->
xml
++;

171 i‡(
p
->
xml
 >p->
xmÀnd
)

174 if(
p
->
ídñtfunc
)

175 
p
->
	`ídñtfunc
’->
d©a
, 
ñemíäame
, 
i
);

176 
p
->
xml
++;

181 
p
->
xml
++;

184 
	}
}

187 
	$∑r£xml
(
xmÕ¨£r
 * 
∑r£r
)

189 
∑r£r
->
xml
 =Ö¨£r->
xml°¨t
;

190 
∑r£r
->
xmÀnd
 =Ö¨£r->
xml°¨t
 +Ö¨£r->
xmlsize
;

191 
	`∑r£ñt
(
∑r£r
);

192 
	}
}

	@minixml.h

32 #i‚de‡
__MINIXML_H__


33 
	#__MINIXML_H__


	)

34 
	~<°döt.h
>

35 
	#IS_WHITE_SPACE
(
c
Ë((c==' 'Ë|| (c=='\t'Ë|| (c=='\r'Ë|| (c=='\n'))

	)

39 
	sxmÕ¨£r
 {

40 c⁄° *
	mxml°¨t
;

41 c⁄° *
	mxmÀnd
;

42 c⁄° *
	mxml
;

43 
	mxmlsize
;

44 
uöt32_t
 
	mÊags
;

45 * 
	md©a
;

46 (*
	m°¨ã…func
) (*, const *, );

47 (*
	mídñtfunc
) (*, const *, );

48 (*
	md©afunc
) (*, const *, );

49 (*
	m©tfunc
) (*, const *, , const *, );

57 
∑r£xml
(
xmÕ¨£r
 *);

	@options.c

30 
	~<°dio.h
>

31 
	~<°rög.h
>

32 
	~<°dlib.h
>

33 
	~<˘y≥.h
>

34 
	~"›ti⁄s.h
"

35 
	~"utûs.h
"

36 
	~"u≤pglobÆv¨s.h
"

38 
›ti⁄
 * 
	g¨y_›ti⁄s
 = 
NULL
;

39 
	gnum_›ti⁄s
 = 0;

42 
u≤pc⁄fig›ti⁄s
 
	mid
;

43 c⁄° * 
	m«me
;

44 } 
	g›ti⁄ids
[] = {

45 { 
UPNPIFNAME
, "network_interface" },

46 { 
UPNPPORT
, "port" },

47 { 
UPNPPRESENTATIONURL
, "presentation_url" },

48 { 
UPNPNOTIFY_INTERVAL
, "notify_interval" },

49 { 
UPNPUUID
, "uuid"},

50 { 
UPNPSERIAL
, "serial"},

51 { 
UPNPMODEL_NAME
, "model_name"},

52 { 
UPNPMODEL_NUMBER
, "model_number"},

53 { 
UPNPFRIENDLYNAME
, "friendly_name"},

54 { 
UPNPMEDIADIR
, "media_dir"},

55 { 
UPNPALBUMART_NAMES
, "album_art_names"},

56 { 
UPNPINOTIFY
, "inotify" },

57 { 
UPNPDBDIR
, "db_dir" },

58 { 
UPNPLOGDIR
, "log_dir" },

59 { 
UPNPLOGLEVEL
, "log_level" },

60 { 
UPNPMINISSDPDSOCKET
, "minissdpdsocket"},

61 { 
ENABLE_TIVO
, "enable_tivo" },

62 { 
ENABLE_DLNA_STRICT
, "strict_dlna" },

63 { 
ROOT_CONTAINER
, "root_container" },

64 { 
USER_ACCOUNT
, "user" },

65 { 
FORCE_SORT_CRITERIA
, "force_sort_criteria" },

66 { 
MAX_CONNECTIONS
, "max_connections" }

70 
	$ªad›ti⁄sfûe
(c⁄° * 
‚ame
)

72 
FILE
 *
hfûe
 = 
NULL
;

73 
buf„r
[1024];

74 *
equÆs
;

75 *
«me
;

76 *
vÆue
;

77 *
t
;

78 
löíum
 = 0;

79 
i
;

80 
u≤pc⁄fig›ti⁄s
 
id
;

82 if(!
‚ame
 || *fname == '\0')

85 
	`mem£t
(
buf„r
, 0, (buffer));

87 #ifde‡
DEBUG


88 
	`¥ötf
("Ródög c⁄figuøti⁄ from fûê%s\n", 
‚ame
);

91 if(!(
hfûe
 = 
	`f›í
(
‚ame
, "r")))

94 
	`fgës
(
buf„r
, (buf„r), 
hfûe
))

96 
löíum
++;

97 
t
 = 
	`°rchr
(
buf„r
, '\n');

98 if(
t
)

100 *
t
 = '\0';

101 
t
--;

102 (
t
 >
buf„r
Ë&& 
	`is•a˚
(*t))

104 *
t
 = '\0';

105 
t
--;

110 
«me
 = 
buf„r
;

111 
	`is•a˚
(*
«me
))

112 
«me
++;

115 if(
«me
[0] == '#' ||Çame[0] == '\0') ;

117 if(!(
equÆs
 = 
	`°rchr
(
«me
, '=')))

119 
	`Ârötf
(
°dîr
, "parsingÉrror file %sÜine %d : %s\n",

120 
‚ame
, 
löíum
, 
«me
);

125 
t
=
equÆs
-1;Å>
«me
 && 
	`is•a˚
(*t);Å--)

126 *
t
 = '\0';

128 *
equÆs
 = '\0';

129 
vÆue
 = 
equÆs
+1;

132 
	`is•a˚
(*
vÆue
))

133 
vÆue
++;

135 
id
 = 
UPNP_INVALID
;

136 
i
=0; i<(
›ti⁄ids
)/(optionids[0]); i++)

141 if(0 =
	`°rcmp
(
«me
, 
›ti⁄ids
[
i
].name))

143 
id
 = 
›ti⁄ids
[
i
].id;

148 if(
id
 =
UPNP_INVALID
)

150 i‡(
	`°rcmp
(
«me
, "include") == 0)

151 
	`ªad›ti⁄sfûe
(
vÆue
);

153 
	`Ârötf
(
°dîr
, "parsingÉrror file %sÜine %d : %s=%s\n",

154 
‚ame
, 
löíum
, 
«me
, 
vÆue
);

158 
num_›ti⁄s
++;

159 
t
 = 
	`ªÆloc
(
¨y_›ti⁄s
, 
num_›ti⁄s
 * (
›ti⁄
));

160 if(!
t
)

162 
	`Ârötf
(
°dîr
, "memoryállocationÉrror: %s=%s\n",

163 
«me
, 
vÆue
);

164 
num_›ti⁄s
--;

168 
¨y_›ti⁄s
 = (
›ti⁄
 *)
t
;

170 
¨y_›ti⁄s
[
num_›ti⁄s
-1].
id
 = id;

171 
	`°∫˝yt
(
¨y_›ti⁄s
[
num_›ti⁄s
-1].
vÆue
, vÆue, 
MAX_OPTION_VALUE_LEN
);

176 
	`f˛o£
(
hfûe
);

179 
	}
}

182 
	$‰ì›ti⁄s
()

184 
medü_dú_s
 *
medü_∑th
, *
œ°_∑th
;

185 
Æbum_¨t_«me_s
 *
¨t_«mes
, *
œ°_«me
;

187 
medü_∑th
 = 
medü_dús
;

188 
medü_∑th
)

190 
	`‰ì
(
medü_∑th
->
∑th
);

191 
œ°_∑th
 = 
medü_∑th
;

192 
medü_∑th
 = medü_∑th->
√xt
;

193 
	`‰ì
(
œ°_∑th
);

196 
¨t_«mes
 = 
Æbum_¨t_«mes
;

197 
¨t_«mes
)

199 
	`‰ì
(
¨t_«mes
->
«me
);

200 
œ°_«me
 = 
¨t_«mes
;

201 
¨t_«mes
 =áπ_«mes->
√xt
;

202 
	`‰ì
(
œ°_«me
);

205 if(
¨y_›ti⁄s
)

207 
	`‰ì
(
¨y_›ti⁄s
);

208 
¨y_›ti⁄s
 = 
NULL
;

209 
num_›ti⁄s
 = 0;

211 
	}
}

	@options.h

30 #i‚de‡
__OPTIONS_H__


31 
	#__OPTIONS_H__


	)

33 
	~"c⁄fig.h
"

36 
	eu≤pc⁄fig›ti⁄s
 {

37 
	mUPNP_INVALID
 = 0,

38 
	mUPNPIFNAME
 = 1,

39 
	mUPNPLISTENING_IP
,

40 
	mUPNPPORT
,

41 
	mUPNPPRESENTATIONURL
,

42 
	mUPNPNOTIFY_INTERVAL
,

43 
	mUPNPUUID
,

44 
	mUPNPSERIAL
,

45 
	mUPNPMODEL_NAME
,

46 
	mUPNPMODEL_NUMBER
,

47 
	mUPNPFRIENDLYNAME
,

48 
	mUPNPMEDIADIR
,

49 
	mUPNPALBUMART_NAMES
,

50 
	mUPNPINOTIFY
,

51 
	mUPNPDBDIR
,

52 
	mUPNPLOGDIR
,

53 
	mUPNPLOGLEVEL
,

54 
	mUPNPMINISSDPDSOCKET
,

55 
	mENABLE_TIVO
,

56 
	mENABLE_DLNA_STRICT
,

57 
	mROOT_CONTAINER
,

58 
	mUSER_ACCOUNT
,

59 
	mFORCE_SORT_CRITERIA
,

60 
	mMAX_CONNECTIONS


67 
ªad›ti⁄sfûe
(c⁄° * 
‚ame
);

72 
‰ì›ti⁄s
();

74 
	#MAX_OPTION_VALUE_LEN
 (200)

	)

75 
	s›ti⁄


77 
u≤pc⁄fig›ti⁄s
 
	mid
;

78 
	mvÆue
[
MAX_OPTION_VALUE_LEN
];

81 
›ti⁄
 * 
¨y_›ti⁄s
;

82 
num_›ti⁄s
;

	@playlist.c

18 
	~<°dio.h
>

19 
	~<°rög.h
>

20 
	~<°dlib.h
>

21 
	~<sys/°©.h
>

22 
	~<libgí.h
>

23 
	~<limôs.h
>

25 
	~<uni°d.h
>

26 
	~<sys/ty≥s.h
>

27 
	~<sys/°©.h
>

28 
	~<f˙é.h
>

30 
	~"ègutûs/ègutûs.h
"

32 
	~"u≤pglobÆv¨s.h
"

33 
	~"sˇ¬î.h
"

34 
	~"mëad©a.h
"

35 
	~"utûs.h
"

36 
	~"sql.h
"

37 
	~"log.h
"

40 
	$ö£π_∂ayli°
(c⁄° * 
∑th
, * 
«me
)

42 
s⁄g_mëad©a
 
∂i°
;

43 
°©
 
fûe
;

44 
ôems
 = 0, 
m©ches
, 
ªt
;

45 
ty≥
[4];

47 
	`°∫˝y
(
ty≥
, 
	`°ºchr
(
«me
, '.')+1, 4);

49 if–
	`°¨t_∂i°
(
∑th
, 
NULL
, &
fûe
, NULL, 
ty≥
) != 0 )

51 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "BadÖœyli° [%s]\n", 
∑th
);

54  (
ªt
 = 
	`√xt_∂i°_åack
(&
∂i°
, &
fûe
, 
NULL
, 
ty≥
)) == 0 )

56 
ôems
++;

57 
	`‰ìègs
(&
∂i°
);

59 if–
ªt
 == 2 )

61 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "BadÖœyli° [%s]\n", 
∑th
);

64 
	`°rù_ext
(
«me
);

66 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "Pœyli° %†c⁄èö†%d iãms\n", 
«me
, 
ôems
);

68 
m©ches
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om PLAYLISTS whîêNAME = '%q'", 
«me
);

69 if–
m©ches
 > 0 )

71 
	`sql_exec
(
db
, "INSERT into PLAYLISTS"

75 
«me
, 
m©ches
, 
∑th
, 
ôems
);

79 
	`sql_exec
(
db
, "INSERT into PLAYLISTS"

83 
«me
, 
∑th
, 
ôems
);

86 
	}
}

89 
	$gí_dú_hash
(c⁄° *
∑th
)

91 
dú
[
PATH_MAX
], *
ba£
;

92 
Àn
;

94 
	`°∫˝y
(
dú
, 
∑th
, (dir));

95 
dú
[(dir)-1] = '\0';

96 
ba£
 = 
	`°ºchr
(
dú
, '/');

97 if–!
ba£
 )

98 
ba£
 = 
	`°ºchr
(
dú
, '\\');

99 if–
ba£
 )

101 *
ba£
 = '\0';

102 
Àn
 = 
ba£
 - 
dú
;

108  
	`DJBHash
(
dú
, 
Àn
);

109 
	}
}

112 
	$fûl_∂ayli°s
()

114 
rows
, 
i
, 
found
, 
Àn
;

115 **
ªsu…
;

116 *
∂∑th
, *
∂«me
, *
‚ame
, *
œ°_dú
;

117 
hash
, 
œ°_hash
 = 0;

118 
˛ass
[] = "playlistContainer";

119 
s⁄g_mëad©a
 
∂i°
;

120 
°©
 
fûe
;

121 
ty≥
[4];

122 
öt64_t
 
∂ID
, 
dëaûID
;

123 
sql_buf
[] = "SELECT ID, NAME, PATH from PLAYLISTS where ITEMS > FOUND";

125 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "ParsingÖlaylists...\n");

127 if–
	`sql_gë_èbÀ
(
db
, 
sql_buf
, &
ªsu…
, &
rows
, 
NULL
Ë!
SQLITE_OK
 )

129 if–!
rows
 )

130 
d⁄e
;

132 
rows
++;

133  
i
=3; i<
rows
*3; i++ )

135 
∂ID
 = 
	`°πﬁl
(
ªsu…
[
i
], 
NULL
, 10);

136 
∂«me
 = 
ªsu…
[++
i
];

137 
∂∑th
 = 
ªsu…
[++
i
];

138 
œ°_dú
 = 
NULL
;

139 
œ°_hash
 = 0;

141 
	`°∫˝y
(
ty≥
, 
	`°ºchr
(
∂∑th
, '.')+1, 4);

143 if–
	`°¨t_∂i°
(
∂∑th
, 
NULL
, &
fûe
, NULL, 
ty≥
) != 0 )

146 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "Sˇ¬ögÖœyli° \"%s\" [%s]\n", 
∂«me
, 
∂∑th
);

147 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from OBJECTS whîêPARENT_ID = '"
MUSIC_PLIST_ID
"'"

148 "ánd NAME = '%q'", 
∂«me
) <= 0 )

150 
dëaûID
 = 
	`GëFﬁdîMëad©a
(
∂«me
, 
NULL
, NULL, NULL, 0);

151 
	`sql_exec
(
db
, "INSERT into OBJECTS"

155 
MUSIC_PLIST_ID
, 
∂ID
, MUSIC_PLIST_ID, 
dëaûID
, 
˛ass
, 
∂«me
);

158 
∂∑th
 = 
	`dú«me
(plpath);

159 
found
 = 0;

160  
	`√xt_∂i°_åack
(&
∂i°
, &
fûe
, 
NULL
, 
ty≥
) == 0 )

162 
hash
 = 
	`gí_dú_hash
(
∂i°
.
∑th
);

163 if–
	`sql_gë_öt_fõld
(
db
, "SELECT 1 from OBJECTS where OBJECT_ID = '%s$%llX$%d'",

164 
MUSIC_PLIST_ID
, 
∂ID
, 
∂i°
.
åack
) == 1 )

167 
found
++;

168 
	`‰ìègs
(&
∂i°
);

171 if–
œ°_dú
 )

173 if–
hash
 =
œ°_hash
 )

175 
‚ame
 = 
	`ba£«me
(
∂i°
.
∑th
);

176 
dëaûID
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT ID from DETAILS whîêPATH = '%q/%q'", 
œ°_dú
, 
‚ame
);

179 
dëaûID
 = -1;

180 if–
dëaûID
 <= 0 )

182 
	`sqlôe3_‰ì
(
œ°_dú
);

183 
œ°_dú
 = 
NULL
;

186 
found
;

189 
‚ame
 = 
∂i°
.
∑th
;

190 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "%d: checkög d©aba£ f‹ %s\n", 
∂i°
.
åack
,Öli°.
∑th
);

191 if–!
	`°Ωbrk
(
‚ame
, "\\/") )

193 
Àn
 = 
	`°æí
(
‚ame
Ë+ såÀn(
∂∑th
) + 2;

194 
∂i°
.
∑th
 = 
	`mÆloc
(
Àn
);

195 
	`¢¥ötf
(
∂i°
.
∑th
, 
Àn
, "%s/%s", 
∂∑th
, 
‚ame
);

196 
	`‰ì
(
‚ame
);

197 
‚ame
 = 
∂i°
.
∑th
;

201  *
‚ame
 == '\\' )

203 
‚ame
++;

206 
ªåy
:

208 
dëaûID
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT ID from DETAILS whîêPATHÜikê'%%%q'", 
‚ame
);

209 if–
dëaûID
 > 0 )

211 
found
:

212 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "+ %†found i¿db\n", 
‚ame
);

213 
	`sql_exec
(
db
, "INSERT into OBJECTS"

217 " whîêDETAIL_ID = %Œdánd OBJECT_ID glob '" 
BROWSEDIR_ID
 "$*'",

218 
MUSIC_PLIST_ID
, 
∂ID
, 
∂i°
.
åack
,

219 
MUSIC_PLIST_ID
, 
∂ID
,

220 
dëaûID
);

221 if–!
œ°_dú
 )

223 
œ°_dú
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT PATH from DETAILS whîêID = %Œd", 
dëaûID
);

224 
‚ame
 = 
	`°ºchr
(
œ°_dú
, '/');

225 if–
‚ame
 )

226 *
‚ame
 = '\0';

227 
œ°_hash
 = 
hash
;

229 
found
++;

233 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "- %†nŸ found i¿db\n", 
‚ame
);

234 if–
	`°rchr
(
‚ame
, '\\') )

236 
‚ame
 = 
	`modifySåög
(fname, "\\", "/");

237 
ªåy
;

239 if–(
‚ame
 = 
	`°rchr
(fname, '/')) )

241 
‚ame
++;

242 
ªåy
;

245 
	`‰ìègs
(&
∂i°
);

247 if–
œ°_dú
 )

249 
	`sqlôe3_‰ì
(
œ°_dú
);

250 
œ°_dú
 = 
NULL
;

252 
	`sql_exec
(
db
, "UPDATE PLAYLISTS së FOUND = %d whîêID = %Œd", 
found
, 
∂ID
);

254 
d⁄e
:

255 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

256 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "FinishedÖarsingÖlaylists.\n");

259 
	}
}

	@playlist.h

24 #i‚de‡
__PLAYLIST_H__


25 
	#__PLAYLIST_H__


	)

28 
ö£π_∂ayli°
(c⁄° * 
∑th
, * 
«me
);

31 
fûl_∂ayli°s
();

	@process.c

30 
	~<sys/ty≥s.h
>

31 
	~<sys/°©.h
>

32 
	~<uni°d.h
>

33 
	~<f˙é.h
>

34 
	~<°dio.h
>

35 
	~<°dlib.h
>

36 
	~<î∫o.h
>

37 
	~<°rög.h
>

38 
	~<sig«l.h
>

39 
	~<sys/waô.h
>

41 
	~"u≤pglobÆv¨s.h
"

42 
	~"¥o˚ss.h
"

43 
	~"c⁄fig.h
"

44 
	~"log.h
"

46 
	gnumbî_of_chûdªn
 = 0;

48 
pid_t


49 
	$¥o˚ss_f‹k
()

51 i‡(
numbî_of_chûdªn
 >
ru¡ime_v¨s
.
max_c⁄√˘i⁄s
)

53 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "Exceeded max connections [%d],Çot forking\n",

54 
ru¡ime_v¨s
.
max_c⁄√˘i⁄s
);

55 
î∫o
 = 
EAGAIN
;

59 
pid_t
 
pid
 = 
	`f‹k
();

60 i‡(
pid
 > 0)

61 ++
numbî_of_chûdªn
;

62  
pid
;

63 
	}
}

66 
	$¥o˚ss_h™dÀ_chûd_ãrmö©i⁄
(
sig«l
)

68 
pid_t
 
pid
;

70 (
pid
 = 
	`waôpid
(-1, 
NULL
, 
WNOHANG
)))

72 i‡(
pid
 == -1)

74 i‡(
î∫o
 =
EINTR
)

79 i‡(
pid
 == 0)

81 --
numbî_of_chûdªn
;

83 
	}
}

86 
	$¥o˚ss_d´m⁄ize
()

88 
pid
;

89 #i‚de‡
USE_DAEMON


90 
i
;

92 
	`¥o˚ss_f‹k
())

96 
	`≥º‹
("fork()");

97 
	`exô
(1);

102 if–(
pid
 = 
	`£tsid
()) < 0)

104 
	`≥º‹
("setsid()");

105 
	`exô
(1);

109 
i
=
	`gëdèbÀsize
();i>=0;--iË
	`˛o£
(i);

111 
i
 = 
	`›í
("/dev/nuŒ",
O_RDWR
);

112 
	`dup
(
i
);

113 
	`dup
(
i
);

115 
	`umask
(027);

116 
	`chdú
("/");

121 
	`exô
(0);

124 if–
	`d´m⁄
(0, 0) < 0 )

125 
	`≥º‹
("daemon()");

126 
pid
 = 
	`gëpid
();

128  
pid
;

129 
	}
}

132 
	$¥o˚ss_check_if_ru¬ög
(c⁄° *
‚ame
)

134 
buf„r
[64];

135 
pidfûe
;

136 
pid_t
 
pid
;

138 if(!
‚ame
 || *fname == '\0')

141 if–(
pidfûe
 = 
	`›í
(
‚ame
, 
O_RDONLY
)) < 0)

144 
	`mem£t
(
buf„r
, 0, 64);

146 if(
	`ªad
(
pidfûe
, 
buf„r
, 63))

148 if–(
pid
 = 
	`©ﬁ
(
buf„r
)) > 0)

150 if(!
	`kûl
(
pid
, 0))

152 
	`˛o£
(
pidfûe
);

158 
	`˛o£
(
pidfûe
);

161 
	}
}

	@process.h

29 #i‚de‡
__PROCESS_H__


30 
	#__PROCESS_H__


	)

32 
	~<uni°d.h
>

40 
pid_t
 
¥o˚ss_f‹k
();

48 
¥o˚ss_h™dÀ_chûd_ãrmö©i⁄
(
sig«l
);

55 
¥o˚ss_d´m⁄ize
();

64 
¥o˚ss_check_if_ru¬ög
(c⁄° *
‚ame
);

	@scanner.c

18 
	~<°dio.h
>

19 
	~<°rög.h
>

20 
	~<°dlib.h
>

21 
	~<uni°d.h
>

22 
	~<dúít.h
>

23 
	~<loˇÀ.h
>

24 
	~<libgí.h
>

25 
	~<öây≥s.h
>

26 
	~<sys/∑øm.h
>

27 
	~<sys/°©.h
>

28 
	~<sys/time.h
>

29 
	~<sys/ªsour˚.h
>

31 
	~"c⁄fig.h
"

33 #ifde‡
ENABLE_NLS


34 
	~<liböé.h
>

36 
	~<sqlôe3.h
>

37 
	~"libav.h
"

39 
	~"sˇ¬î_sqlôe.h
"

40 
	~"u≤pglobÆv¨s.h
"

41 
	~"mëad©a.h
"

42 
	~"∂ayli°.h
"

43 
	~"utûs.h
"

44 
	~"sql.h
"

45 
	~"sˇ¬î.h
"

46 
	~"Æbum¨t.h
"

47 
	~"log.h
"

49 #i‡
SCANDIR_CONST


50 c⁄° 
	tdúít
 
	tsˇn_fûãr
;

52 
dúít
 
	tsˇn_fûãr
;

54 #i‚de‡
AV_LOG_PANIC


55 
	#AV_LOG_PANIC
 
AV_LOG_FATAL


	)

58 
	gvÆid_ˇche
 = 0;

60 
	svútuÆ_ôem


62 
öt64_t
 
	mobje˘ID
;

63 
	m∑ª¡ID
[64];

64 
	m«me
[256];

67 
öt64_t


68 
	$gë_√xt_avaûabÀ_id
(c⁄° *
èbÀ
, c⁄° *
∑ª¡ID
)

70 *
ªt
, *
ba£
;

71 
öt64_t
 
obje˘ID
 = 0;

73 
ªt
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from %s where ID = "

75 
èbÀ
,ÅabÀ, 
∑ª¡ID
);

76 if–
ªt
 )

78 
ba£
 = 
	`°ºchr
(
ªt
, '$');

79 if–
ba£
 )

80 
obje˘ID
 = 
	`°πﬁl
(
ba£
+1, 
NULL
, 16) + 1;

81 
	`sqlôe3_‰ì
(
ªt
);

84  
obje˘ID
;

85 
	}
}

88 
	$ö£π_c⁄èöî
(c⁄° *
ôem
, c⁄° *
roŸP¨ít
, c⁄° *
ªfID
, c⁄° *
˛ass
,

89 c⁄° *
¨ti°
, c⁄° *
gíª
, c⁄° *
Æbum_¨t
, 
öt64_t
 *
obje˘ID
, i¡64_à*
∑ª¡ID
)

91 *
ªsu…
;

92 *
ba£
;

93 
ªt
 = 0;

95 
ªsu…
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from OBJECTS o "

101 
roŸP¨ít
, 
ôem
, 
¨ti°
?"like":"is",áπi°, 
˛ass
);

102 if–
ªsu…
 )

104 
ba£
 = 
	`°ºchr
(
ªsu…
, '$');

105 if–
ba£
 )

106 *
∑ª¡ID
 = 
	`°πﬁl
(
ba£
+1, 
NULL
, 16);

108 *
∑ª¡ID
 = 0;

109 *
obje˘ID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
ªsu…
);

113 
öt64_t
 
dëaûID
 = 0;

114 *
obje˘ID
 = 0;

115 *
∑ª¡ID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
roŸP¨ít
);

116 if–
ªfID
 )

118 
ªsu…
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT DETAIL_ID from OBJECTS whîêOBJECT_ID = %Q", 
ªfID
);

119 if–
ªsu…
 )

120 
dëaûID
 = 
	`°πﬁl
(
ªsu…
, 
NULL
, 10);

122 if–!
dëaûID
 )

124 
dëaûID
 = 
	`GëFﬁdîMëad©a
(
ôem
, 
NULL
, 
¨ti°
, 
gíª
, (
Æbum_¨t
 ? 
	`°πﬁl
(album_art, NULL, 10) : 0));

126 
ªt
 = 
	`sql_exec
(
db
, "INSERT into OBJECTS"

130 
roŸP¨ít
, ()*
∑ª¡ID
,ÑootParent,

131 
ªfID
, ()
dëaûID
, 
˛ass
, 
ôem
);

133 
	`sqlôe3_‰ì
(
ªsu…
);

135  
ªt
;

136 
	}
}

139 
	$ö£π_c⁄èöîs
(c⁄° *
«me
, c⁄° *
∑th
, c⁄° *
ªfID
, c⁄° *
˛ass
, 
öt64_t
 
dëaûID
)

141 
sql
[128];

142 **
ªsu…
;

143 
ªt
;

144 
cﬁs
, 
row
;

145 
öt64_t
 
obje˘ID
, 
∑ª¡ID
;

147 if–
	`°r°r
(
˛ass
, "imageItem") )

149 *
d©e_èkí
 = 
NULL
, *
ˇmîa
 = NULL;

150 
vútuÆ_ôem
 
œ°_d©e
;

151 
vútuÆ_ôem
 
œ°_ˇm
;

152 
vútuÆ_ôem
 
œ°_ˇmd©e
;

153 
œ°_Æl_obje˘ID
 = 0;

155 
	`¢¥ötf
(
sql
, (sql), "SELECT DATE, CREATOR from DETAILS whîêID = %Œd", ()
dëaûID
);

156 
ªt
 = 
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
row
, &
cﬁs
);

157 if–
ªt
 =
SQLITE_OK
 )

159 
d©e_èkí
 = 
ªsu…
[2];

160 
ˇmîa
 = 
ªsu…
[3];

162 if–
d©e_èkí
 )

163 
d©e_èkí
[10] = '\0';

165 
d©e_èkí
 = 
	`_
("Unknown Date");

166 if–!
ˇmîa
 )

167 
ˇmîa
 = 
	`_
("Unknown Camera");

169 if–
vÆid_ˇche
 && 
	`°rcmp
(
œ°_d©e
.
«me
, 
d©e_èkí
) == 0 )

171 
œ°_d©e
.
obje˘ID
++;

176 
	`ö£π_c⁄èöî
(
d©e_èkí
, 
IMAGE_DATE_ID
, 
NULL
, "Æbum.phŸoAlbum", NULL, NULL, NULL, &
obje˘ID
, &
∑ª¡ID
);

177 
	`•rötf
(
œ°_d©e
.
∑ª¡ID
, 
IMAGE_DATE_ID
"$%llX", ()parentID);

178 
œ°_d©e
.
obje˘ID
 = objectID;

179 
	`°∫˝yt
(
œ°_d©e
.
«me
, 
d©e_èkí
, (last_date.name));

182 
	`sql_exec
(
db
, "INSERT into OBJECTS"

186 
œ°_d©e
.
∑ª¡ID
, (Óa°_d©e.
obje˘ID
,Üa°_d©e.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

188 if–!
vÆid_ˇche
 || 
	`°rcmp
(
ˇmîa
, 
œ°_ˇm
.
«me
) != 0 )

190 
	`ö£π_c⁄èöî
(
ˇmîa
, 
IMAGE_CAMERA_ID
, 
NULL
, "°‹ageFﬁdî", NULL, NULL, NULL, &
obje˘ID
, &
∑ª¡ID
);

191 
	`•rötf
(
œ°_ˇm
.
∑ª¡ID
, 
IMAGE_CAMERA_ID
"$%llX", ()parentID);

192 
	`°∫˝yt
(
œ°_ˇm
.
«me
, 
ˇmîa
, (last_cam.name));

194 
œ°_ˇmd©e
.
«me
[0] = '\0';

196 if–
vÆid_ˇche
 && 
	`°rcmp
(
œ°_ˇmd©e
.
«me
, 
d©e_èkí
) == 0 )

198 
œ°_ˇmd©e
.
obje˘ID
++;

203 
	`ö£π_c⁄èöî
(
d©e_èkí
, 
œ°_ˇm
.
∑ª¡ID
, 
NULL
, "Æbum.phŸoAlbum", NULL, NULL, NULL, &
obje˘ID
, &parentID);

204 
	`•rötf
(
œ°_ˇmd©e
.
∑ª¡ID
, "%s$%ŒX", 
œ°_ˇm
.parentID, ()parentID);

205 
œ°_ˇmd©e
.
obje˘ID
 = objectID;

206 
	`°∫˝yt
(
œ°_ˇmd©e
.
«me
, 
d©e_èkí
, (last_camdate.name));

209 
	`sql_exec
(
db
, "INSERT into OBJECTS"

213 
œ°_ˇmd©e
.
∑ª¡ID
,Üa°_ˇmd©e.
obje˘ID
,Üa°_ˇmd©e.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

215 if–!
œ°_Æl_obje˘ID
 )

217 
œ°_Æl_obje˘ID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
IMAGE_ALL_ID
);

219 
	`sql_exec
(
db
, "INSERT into OBJECTS"

222 " ('"
IMAGE_ALL_ID
"$%llX', '"IMAGE_ALL_ID"', '%s', '%s', %lld, %Q)",

223 
œ°_Æl_obje˘ID
++, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

225 if–
	`°r°r
(
˛ass
, "audioItem") )

227 
	`¢¥ötf
(
sql
, (sql), "SELECT ALBUM, ARTIST, GENRE, ALBUM_ART from DETAILS whîêID = %Œd", ()
dëaûID
);

228 
ªt
 = 
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
row
, &
cﬁs
);

229 if–
ªt
 !
SQLITE_OK
 )

231 if–!
row
 )

233 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

236 *
Æbum
 = 
ªsu…
[4], *
¨ti°
 =Ñesu…[5], *
gíª
 =Ñesult[6];

237 *
Æbum_¨t
 = 
ªsu…
[7];

238 
vútuÆ_ôem
 
œ°_Æbum
;

239 
vútuÆ_ôem
 
œ°_¨ti°
;

240 
vútuÆ_ôem
 
œ°_¨ti°Album
;

241 
vútuÆ_ôem
 
œ°_¨ti°AlbumAŒ
;

242 
vútuÆ_ôem
 
œ°_gíª
;

243 
vútuÆ_ôem
 
œ°_gíªAπi°
;

244 
vútuÆ_ôem
 
œ°_gíªAπi°AŒ
;

245 
œ°_Æl_obje˘ID
 = 0;

247 if–
Æbum
 )

249 if–
vÆid_ˇche
 && 
	`°rcmp
(
Æbum
, 
œ°_Æbum
.
«me
) == 0 )

251 
œ°_Æbum
.
obje˘ID
++;

256 
	`°∫˝yt
(
œ°_Æbum
.
«me
, 
Æbum
, (last_album.name));

257 
	`ö£π_c⁄èöî
(
Æbum
, 
MUSIC_ALBUM_ID
, 
NULL
, "Æbum.musicAlbum", 
¨ti°
, 
gíª
, 
Æbum_¨t
, &
obje˘ID
, &
∑ª¡ID
);

258 
	`•rötf
(
œ°_Æbum
.
∑ª¡ID
, 
MUSIC_ALBUM_ID
"$%llX", ()parentID);

259 
œ°_Æbum
.
obje˘ID
 = objectID;

262 
	`sql_exec
(
db
, "INSERT into OBJECTS"

266 
œ°_Æbum
.
∑ª¡ID
,Üa°_Æbum.
obje˘ID
,Üa°_Æbum.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

268 if–
¨ti°
 )

270 if–!
vÆid_ˇche
 || 
	`°rcmp
(
¨ti°
, 
œ°_¨ti°
.
«me
) != 0 )

272 
	`ö£π_c⁄èöî
(
¨ti°
, 
MUSIC_ARTIST_ID
, 
NULL
, "≥rs⁄.musicAπi°", NULL, 
gíª
, NULL, &
obje˘ID
, &
∑ª¡ID
);

273 
	`•rötf
(
œ°_¨ti°
.
∑ª¡ID
, 
MUSIC_ARTIST_ID
"$%llX", ()parentID);

274 
	`°∫˝yt
(
œ°_¨ti°
.
«me
, 
¨ti°
, (last_artist.name));

275 
œ°_¨ti°Album
.
«me
[0] = '\0';

277 
	`ö£π_c⁄èöî
(
	`_
("- AŒ Album†-"), 
œ°_¨ti°
.
∑ª¡ID
, 
NULL
, "Æbum", 
¨ti°
, 
gíª
, NULL, &
obje˘ID
, &parentID);

278 
	`•rötf
(
œ°_¨ti°AlbumAŒ
.
∑ª¡ID
, "%s$%ŒX", 
œ°_¨ti°
.parentID, ()parentID);

279 
œ°_¨ti°AlbumAŒ
.
obje˘ID
 = objectID;

283 
œ°_¨ti°AlbumAŒ
.
obje˘ID
++;

285 if–
vÆid_ˇche
 && 
	`°rcmp
(
Æbum
?Æbum:
	`_
("Unknow¿Album"), 
œ°_¨ti°Album
.
«me
) == 0 )

287 
œ°_¨ti°Album
.
obje˘ID
++;

292 
	`ö£π_c⁄èöî
(
Æbum
?Æbum:
	`_
("Unknow¿Album"), 
œ°_¨ti°
.
∑ª¡ID
,álbum?
œ°_Æbum
.∑ª¡ID:
NULL
,

293 "Æbum.musicAlbum", 
¨ti°
, 
gíª
, 
Æbum_¨t
, &
obje˘ID
, &
∑ª¡ID
);

294 
	`•rötf
(
œ°_¨ti°Album
.
∑ª¡ID
, "%s$%ŒX", 
œ°_¨ti°
.parentID, ()parentID);

295 
œ°_¨ti°Album
.
obje˘ID
 = objectID;

296 
	`°∫˝yt
(
œ°_¨ti°Album
.
«me
, 
Æbum
 ?álbum : 
	`_
("Unknown Album"), (last_artistAlbum.name));

299 
	`sql_exec
(
db
, "INSERT into OBJECTS"

303 
œ°_¨ti°Album
.
∑ª¡ID
,Üa°_¨ti°Album.
obje˘ID
,Üa°_¨ti°Album.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

304 
	`sql_exec
(
db
, "INSERT into OBJECTS"

308 
œ°_¨ti°AlbumAŒ
.
∑ª¡ID
,Üa°_¨ti°AlbumAŒ.
obje˘ID
,Üa°_¨ti°AlbumAŒ.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

310 if–
gíª
 )

312 if–!
vÆid_ˇche
 || 
	`°rcmp
(
gíª
, 
œ°_gíª
.
«me
) != 0 )

314 
	`ö£π_c⁄èöî
(
gíª
, 
MUSIC_GENRE_ID
, 
NULL
, "gíª.musicGíª", NULL, NULL, NULL, &
obje˘ID
, &
∑ª¡ID
);

315 
	`•rötf
(
œ°_gíª
.
∑ª¡ID
, 
MUSIC_GENRE_ID
"$%llX", ()parentID);

316 
	`°∫˝yt
(
œ°_gíª
.
«me
, 
gíª
, (last_genre.name));

318 
	`ö£π_c⁄èöî
(
	`_
("- AŒ Aπi°†-"), 
œ°_gíª
.
∑ª¡ID
, 
NULL
, "≥rs⁄", NULL, 
gíª
, NULL, &
obje˘ID
, &parentID);

319 
	`•rötf
(
œ°_gíªAπi°AŒ
.
∑ª¡ID
, "%s$%ŒX", 
œ°_gíª
.parentID, ()parentID);

320 
œ°_gíªAπi°AŒ
.
obje˘ID
 = objectID;

324 
œ°_gíªAπi°AŒ
.
obje˘ID
++;

326 if–
vÆid_ˇche
 && 
	`°rcmp
(
¨ti°
?¨ti°:
	`_
("Unknow¿Aπi°"), 
œ°_gíªAπi°
.
«me
) == 0 )

328 
œ°_gíªAπi°
.
obje˘ID
++;

332 
	`ö£π_c⁄èöî
(
¨ti°
?¨ti°:
	`_
("Unknow¿Aπi°"), 
œ°_gíª
.
∑ª¡ID
,áπi°?
œ°_¨ti°
.∑ª¡ID:
NULL
,

333 "≥rs⁄.musicAπi°", 
NULL
, 
gíª
, NULL, &
obje˘ID
, &
∑ª¡ID
);

334 
	`•rötf
(
œ°_gíªAπi°
.
∑ª¡ID
, "%s$%ŒX", 
œ°_gíª
.parentID, ()parentID);

335 
œ°_gíªAπi°
.
obje˘ID
 = objectID;

336 
	`°∫˝yt
(
œ°_gíªAπi°
.
«me
, 
¨ti°
 ?áπi° : 
	`_
("Unknown Artist"), (last_genreArtist.name));

339 
	`sql_exec
(
db
, "INSERT into OBJECTS"

343 
œ°_gíªAπi°
.
∑ª¡ID
,Üa°_gíªAπi°.
obje˘ID
,Üa°_gíªAπi°.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

344 
	`sql_exec
(
db
, "INSERT into OBJECTS"

348 
œ°_gíªAπi°AŒ
.
∑ª¡ID
,Üa°_gíªAπi°AŒ.
obje˘ID
,Üa°_gíªAπi°AŒ.∑ª¡ID, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

351 if–!
œ°_Æl_obje˘ID
 )

353 
œ°_Æl_obje˘ID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
MUSIC_ALL_ID
);

355 
	`sql_exec
(
db
, "INSERT into OBJECTS"

358 " ('"
MUSIC_ALL_ID
"$%llX', '"MUSIC_ALL_ID"', '%s', '%s', %lld, %Q)",

359 
œ°_Æl_obje˘ID
++, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

361 if–
	`°r°r
(
˛ass
, "videoItem") )

363 
œ°_Æl_obje˘ID
 = 0;

366 if–!
œ°_Æl_obje˘ID
 )

368 
œ°_Æl_obje˘ID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
VIDEO_ALL_ID
);

370 
	`sql_exec
(
db
, "INSERT into OBJECTS"

373 " ('"
VIDEO_ALL_ID
"$%llX', '"VIDEO_ALL_ID"', '%s', '%s', %lld, %Q)",

374 
œ°_Æl_obje˘ID
++, 
ªfID
, 
˛ass
, ()
dëaûID
, 
«me
);

381 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

382 
vÆid_ˇche
 = 1;

383 
	}
}

385 
öt64_t


386 
	$ö£π_dúe˘‹y
(c⁄° *
«me
, c⁄° *
∑th
, c⁄° *
ba£
, c⁄° *
∑ª¡ID
, 
obje˘ID
)

388 
öt64_t
 
dëaûID
 = 0;

389 
˛ass
[] = "container.storageFolder";

390 *
ªsu…
, *
p
;

391 
œ°_found
[256] = "-1";

393 if–
	`°rcmp
(
ba£
, 
BROWSEDIR_ID
) != 0 )

395 
found
 = 0;

396 
id_buf
[64], 
∑ª¡_buf
[64], 
ªfID
[64];

397 *
dú_buf
, *
dú
;

399 
dú_buf
 = 
	`°rdup
(
∑th
);

400 
dú
 = 
	`dú«me
(
dú_buf
);

401 
	`¢¥ötf
(
ªfID
, ‘efID), "%s%s$%X", 
BROWSEDIR_ID
, 
∑ª¡ID
, 
obje˘ID
);

402 
	`¢¥ötf
(
id_buf
, (id_buf), "%s%s$%X", 
ba£
, 
∑ª¡ID
, 
obje˘ID
);

403 
	`¢¥ötf
(
∑ª¡_buf
, ’¨ít_buf), "%s%s", 
ba£
, 
∑ª¡ID
);

404  !
found
 )

406 if–
vÆid_ˇche
 && 
	`°rcmp
(
id_buf
, 
œ°_found
) == 0 )

408 if–
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêOBJECT_ID = '%s'", 
id_buf
) > 0 )

410 
	`°r˝y
(
œ°_found
, 
id_buf
);

414 
ªsu…
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT DETAIL_ID from OBJECTS whîêOBJECT_ID = '%s'", 
ªfID
);

415 if–
ªsu…
 )

417 
dëaûID
 = 
	`°πﬁl
(
ªsu…
, 
NULL
, 10);

418 
	`sqlôe3_‰ì
(
ªsu…
);

420 
	`sql_exec
(
db
, "INSERT into OBJECTS"

424 
id_buf
, 
∑ª¡_buf
, 
ªfID
, 
dëaûID
, 
˛ass
, 
	`°ºchr
(
dú
, '/')+1);

425 if–(
p
 = 
	`°ºchr
(
id_buf
, '$')) )

426 *
p
 = '\0';

427 if–(
p
 = 
	`°ºchr
(
∑ª¡_buf
, '$')) )

428 *
p
 = '\0';

429 if–(
p
 = 
	`°ºchr
(
ªfID
, '$')) )

430 *
p
 = '\0';

431 
dú
 = 
	`dú«me
(dir);

433 
	`‰ì
(
dú_buf
);

437 
dëaûID
 = 
	`GëFﬁdîMëad©a
(
«me
, 
∑th
, 
NULL
, NULL, 
	`föd_Æbum_¨t
(path, NULL, 0));

438 
	`sql_exec
(
db
, "INSERT into OBJECTS"

442 
ba£
, 
∑ª¡ID
, 
obje˘ID
, ba£,Ö¨ítID, 
dëaûID
, 
˛ass
, 
«me
);

444  
dëaûID
;

445 
	}
}

448 
	$ö£π_fûe
(*
«me
, c⁄° *
∑th
, c⁄° *
∑ª¡ID
, 
obje˘
)

450 
˛ass
[32];

451 
obje˘ID
[64];

452 
öt64_t
 
dëaûID
 = 0;

453 
ba£
[8];

454 *
ty≥dú_∑ª¡ID
;

455 *
ba£id
;

456 *
‹ig_«me
 = 
NULL
;

458 if–
	`is_image
(
«me
) )

460 if–
	`is_Æbum_¨t
(
«me
) )

462 
	`°r˝y
(
ba£
, 
IMAGE_DIR_ID
);

463 
	`°r˝y
(
˛ass
, "item.imageItem.photo");

464 
dëaûID
 = 
	`GëImageMëad©a
(
∑th
, 
«me
);

466 if–
	`is_video
(
«me
) )

468 
‹ig_«me
 = 
	`°rdup
(
«me
);

469 
	`°r˝y
(
ba£
, 
VIDEO_DIR_ID
);

470 
	`°r˝y
(
˛ass
, "item.videoItem");

471 
dëaûID
 = 
	`GëVideoMëad©a
(
∑th
, 
«me
);

472 if–!
dëaûID
 )

473 
	`°r˝y
(
«me
, 
‹ig_«me
);

475 if–
	`is_∂ayli°
(
«me
) )

477 if–
	`ö£π_∂ayli°
(
∑th
, 
«me
) == 0 )

480 if–!
dëaûID
 && 
	`is_audio
(
«me
) )

482 
	`°r˝y
(
ba£
, 
MUSIC_DIR_ID
);

483 
	`°r˝y
(
˛ass
, "item.audioItem.musicTrack");

484 
dëaûID
 = 
	`GëAudioMëad©a
(
∑th
, 
«me
);

486 
	`‰ì
(
‹ig_«me
);

487 if–!
dëaûID
 )

489 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Unsuc˚ssfu»gëtög dëaû†f‹ %s!\n", 
∑th
);

493 
	`•rötf
(
obje˘ID
, "%s%s$%X", 
BROWSEDIR_ID
, 
∑ª¡ID
, 
obje˘
);

495 
	`sql_exec
(
db
, "INSERT into OBJECTS"

499 
obje˘ID
, 
BROWSEDIR_ID
, 
∑ª¡ID
, 
˛ass
, 
dëaûID
, 
«me
);

501 if–*
∑ª¡ID
 )

503 
ty≥dú_obje˘ID
 = 0;

504 
ty≥dú_∑ª¡ID
 = 
	`°rdup
(
∑ª¡ID
);

505 
ba£id
 = 
	`°ºchr
(
ty≥dú_∑ª¡ID
, '$');

506 if–
ba£id
 )

508 
ty≥dú_obje˘ID
 = 
	`°πﬁ
(
ba£id
+1, 
NULL
, 16);

509 *
ba£id
 = '\0';

511 
	`ö£π_dúe˘‹y
(
«me
, 
∑th
, 
ba£
, 
ty≥dú_∑ª¡ID
, 
ty≥dú_obje˘ID
);

512 
	`‰ì
(
ty≥dú_∑ª¡ID
);

514 
	`sql_exec
(
db
, "INSERT into OBJECTS"

518 
ba£
, 
∑ª¡ID
, 
obje˘
, ba£,Ö¨ítID, 
obje˘ID
, 
˛ass
, 
dëaûID
, 
«me
);

520 
	`ö£π_c⁄èöîs
(
«me
, 
∑th
, 
obje˘ID
, 
˛ass
, 
dëaûID
);

522 
	}
}

525 
	$Cª©eD©aba£
()

527 
ªt
, 
i
;

528 c⁄° *
c⁄èöîs
[] = { "0","-1", "root",

529 
MUSIC_ID
, "0", 
	`_
("Music"),

530 
MUSIC_ALL_ID
, 
MUSIC_ID
, 
	`_
("All Music"),

531 
MUSIC_GENRE_ID
, 
MUSIC_ID
, 
	`_
("Genre"),

532 
MUSIC_ARTIST_ID
, 
MUSIC_ID
, 
	`_
("Artist"),

533 
MUSIC_ALBUM_ID
, 
MUSIC_ID
, 
	`_
("Album"),

534 
MUSIC_DIR_ID
, 
MUSIC_ID
, 
	`_
("Folders"),

535 
MUSIC_PLIST_ID
, 
MUSIC_ID
, 
	`_
("Playlists"),

537 
VIDEO_ID
, "0", 
	`_
("Video"),

538 
VIDEO_ALL_ID
, 
VIDEO_ID
, 
	`_
("All Video"),

539 
VIDEO_DIR_ID
, 
VIDEO_ID
, 
	`_
("Folders"),

541 
IMAGE_ID
, "0", 
	`_
("Pictures"),

542 
IMAGE_ALL_ID
, 
IMAGE_ID
, 
	`_
("All Pictures"),

543 
IMAGE_DATE_ID
, 
IMAGE_ID
, 
	`_
("Date Taken"),

544 
IMAGE_CAMERA_ID
, 
IMAGE_ID
, 
	`_
("Camera"),

545 
IMAGE_DIR_ID
, 
IMAGE_ID
, 
	`_
("Folders"),

547 
BROWSEDIR_ID
, "0", 
	`_
("Browse Folders"),

550 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_obje˘TabÀ_sqlôe
);

551 if–
ªt
 !
SQLITE_OK
 )

552 
sql_Áûed
;

553 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_dëaûTabÀ_sqlôe
);

554 if–
ªt
 !
SQLITE_OK
 )

555 
sql_Áûed
;

556 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_ÆbumAπTabÀ_sqlôe
);

557 if–
ªt
 !
SQLITE_OK
 )

558 
sql_Áûed
;

559 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_ˇ±i⁄TabÀ_sqlôe
);

560 if–
ªt
 !
SQLITE_OK
 )

561 
sql_Áûed
;

562 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_bookm¨kTabÀ_sqlôe
);

563 if–
ªt
 !
SQLITE_OK
 )

564 
sql_Áûed
;

565 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_∂ayli°TabÀ_sqlôe
);

566 if–
ªt
 !
SQLITE_OK
 )

567 
sql_Áûed
;

568 
ªt
 = 
	`sql_exec
(
db
, 
¸óã_£âögsTabÀ_sqlôe
);

569 if–
ªt
 !
SQLITE_OK
 )

570 
sql_Áûed
;

571 
ªt
 = 
	`sql_exec
(
db
, "INSERT into SETTINGS values ('UPDATE_ID', '0')");

572 if–
ªt
 !
SQLITE_OK
 )

573 
sql_Áûed
;

574  
i
=0; 
c⁄èöîs
[i]; i=i+3 )

576 
ªt
 = 
	`sql_exec
(
db
, "INSERT into OBJECTS (OBJECT_ID, PARENT_ID, DETAIL_ID, CLASS, NAME)"

579 
c⁄èöîs
[
i
], c⁄èöîs[i+1], 
	`GëFﬁdîMëad©a
(c⁄èöîs[i+2], 
NULL
, NULL, NULL, 0), containers[i+2]);

580 if–
ªt
 !
SQLITE_OK
 )

581 
sql_Áûed
;

583 
	`sql_exec
(
db
, "create INDEX IDX_OBJECTS_OBJECT_ID ON OBJECTS(OBJECT_ID);");

584 
	`sql_exec
(
db
, "create INDEX IDX_OBJECTS_PARENT_ID ON OBJECTS(PARENT_ID);");

585 
	`sql_exec
(
db
, "create INDEX IDX_OBJECTS_DETAIL_ID ON OBJECTS(DETAIL_ID);");

586 
	`sql_exec
(
db
, "create INDEX IDX_OBJECTS_CLASS ON OBJECTS(CLASS);");

587 
	`sql_exec
(
db
, "create INDEX IDX_DETAILS_PATH ON DETAILS(PATH);");

588 
	`sql_exec
(
db
, "create INDEX IDX_DETAILS_ID ON DETAILS(ID);");

589 
	`sql_exec
(
db
, "create INDEX IDX_ALBUM_ART ON ALBUM_ART(ID);");

590 
	`sql_exec
(
db
, "create INDEX IDX_SCANNER_OPT ON OBJECTS(PARENT_ID, NAME, OBJECT_ID);");

592 
sql_Áûed
:

593 if–
ªt
 !
SQLITE_OK
 )

594 
	`Ârötf
(
°dîr
, "Error creating SQLite3 database!\n");

595  (
ªt
 !
SQLITE_OK
);

596 
	}
}

598 
ölöe
 

599 
	$fûãr_hiddí
(
sˇn_fûãr
 *
d
)

601  (
d
->
d_«me
[0] != '.');

602 
	}
}

605 
	$fûãr_ty≥
(
sˇn_fûãr
 *
d
)

607  ( (
d
->
d_ty≥
 =
DT_DIR
) ||

608 (
d
->
d_ty≥
 =
DT_LNK
) ||

609 (
d
->
d_ty≥
 =
DT_UNKNOWN
)

611 
	}
}

614 
	$fûãr_a
(
sˇn_fûãr
 *
d
)

616  ( 
	`fûãr_hiddí
(
d
) &&

617 (
	`fûãr_ty≥
(
d
) ||

618 ((
d
->
d_ty≥
 =
DT_REG
) &&

619 (
	`is_audio
(
d
->
d_«me
) ||

620 
	`is_∂ayli°
(
d
->
d_«me
))))

622 
	}
}

625 
	$fûãr_av
(
sˇn_fûãr
 *
d
)

627  ( 
	`fûãr_hiddí
(
d
) &&

628 (
	`fûãr_ty≥
(
d
) ||

629 ((
d
->
d_ty≥
 =
DT_REG
) &&

630 (
	`is_audio
(
d
->
d_«me
) ||

631 
	`is_video
(
d
->
d_«me
) ||

632 
	`is_∂ayli°
(
d
->
d_«me
))))

634 
	}
}

637 
	$fûãr_≠
(
sˇn_fûãr
 *
d
)

639  ( 
	`fûãr_hiddí
(
d
) &&

640 (
	`fûãr_ty≥
(
d
) ||

641 ((
d
->
d_ty≥
 =
DT_REG
) &&

642 (
	`is_audio
(
d
->
d_«me
) ||

643 
	`is_image
(
d
->
d_«me
) ||

644 
	`is_∂ayli°
(
d
->
d_«me
))))

646 
	}
}

649 
	$fûãr_v
(
sˇn_fûãr
 *
d
)

651  ( 
	`fûãr_hiddí
(
d
) &&

652 (
	`fûãr_ty≥
(
d
) ||

653 (
d
->
d_ty≥
 =
DT_REG
 &&

654 
	`is_video
(
d
->
d_«me
)))

656 
	}
}

659 
	$fûãr_vp
(
sˇn_fûãr
 *
d
)

661  ( 
	`fûãr_hiddí
(
d
) &&

662 (
	`fûãr_ty≥
(
d
) ||

663 ((
d
->
d_ty≥
 =
DT_REG
) &&

664 (
	`is_video
(
d
->
d_«me
) ||

665 
	`is_image
(
d
->
d_«me
))))

667 
	}
}

670 
	$fûãr_p
(
sˇn_fûãr
 *
d
)

672  ( 
	`fûãr_hiddí
(
d
) &&

673 (
	`fûãr_ty≥
(
d
) ||

674 (
d
->
d_ty≥
 =
DT_REG
 &&

675 
	`is_image
(
d
->
d_«me
)))

677 
	}
}

680 
	$fûãr_avp
(
sˇn_fûãr
 *
d
)

682  ( 
	`fûãr_hiddí
(
d
) &&

683 (
	`fûãr_ty≥
(
d
) ||

684 ((
d
->
d_ty≥
 =
DT_REG
) &&

685 (
	`is_audio
(
d
->
d_«me
) ||

686 
	`is_image
(
d
->
d_«me
) ||

687 
	`is_video
(
d
->
d_«me
) ||

688 
	`is_∂ayli°
(
d
->
d_«me
))))

690 
	}
}

693 
	$SˇnDúe˘‹y
(c⁄° *
dú
, c⁄° *
∑ª¡
, 
medü_ty≥s
 
dú_ty≥s
)

695 
dúít
 **
«mñi°
;

696 
i
, 
n
, 
°¨tID
 = 0;

697 *
fuŒ_∑th
;

698 *
«me
 = 
NULL
;

699 
fûío
 = 0;

700 
fûe_ty≥s
 
ty≥
;

702 
	`DPRINTF
(
∑ª¡
?
E_INFO
:
E_WARN
, 
L_SCANNER
, 
	`_
("Sˇ¬ög %s\n"), 
dú
);

703  
dú_ty≥s
 )

705 
ALL_MEDIA
:

706 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_avp
, 
Æphas‹t
);

708 
TYPE_AUDIO
:

709 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_a
, 
Æphas‹t
);

711 
TYPE_AUDIO
|
TYPE_VIDEO
:

712 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_av
, 
Æphas‹t
);

714 
TYPE_AUDIO
|
TYPE_IMAGES
:

715 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_≠
, 
Æphas‹t
);

717 
TYPE_VIDEO
:

718 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_v
, 
Æphas‹t
);

720 
TYPE_VIDEO
|
TYPE_IMAGES
:

721 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_vp
, 
Æphas‹t
);

723 
TYPE_IMAGES
:

724 
n
 = 
	`sˇndú
(
dú
, &
«mñi°
, 
fûãr_p
, 
Æphas‹t
);

727 
n
 = -1;

730 if–
n
 < 0 )

732 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Eº‹ sˇ¬ög %s\n", 
dú
);

736 
fuŒ_∑th
 = 
	`mÆloc
(
PATH_MAX
);

737 i‡(!
fuŒ_∑th
)

739 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Mem‹yáŒoˇti⁄ faûed sˇ¬ög %s\n", 
dú
);

743 if–!
∑ª¡
 )

745 
°¨tID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
BROWSEDIR_ID
);

748 
i
=0; i < 
n
; i++)

750 #i‡!
USE_FORK


751 if–
quôtög
 )

754 
ty≥
 = 
TYPE_UNKNOWN
;

755 
	`¢¥ötf
(
fuŒ_∑th
, 
PATH_MAX
, "%s/%s", 
dú
, 
«mñi°
[
i
]->
d_«me
);

756 
«me
 = 
	`esˇ≥_èg
(
«mñi°
[
i
]->
d_«me
, 1);

757 if–
«mñi°
[
i
]->
d_ty≥
 =
DT_DIR
 )

759 
ty≥
 = 
TYPE_DIR
;

761 if–
«mñi°
[
i
]->
d_ty≥
 =
DT_REG
 )

763 
ty≥
 = 
TYPE_FILE
;

767 
ty≥
 = 
	`ªsﬁve_unknown_ty≥
(
fuŒ_∑th
, 
dú_ty≥s
);

769 if–(
ty≥
 =
TYPE_DIR
Ë&& (
	`ac˚ss
(
fuŒ_∑th
, 
R_OK
|
X_OK
) == 0) )

771 *
∑ª¡_id
;

772 
	`ö£π_dúe˘‹y
(
«me
, 
fuŒ_∑th
, 
BROWSEDIR_ID
, (
∑ª¡
 ?Ö¨ít:""), 
i
+
°¨tID
);

773 
	`xa•rötf
(&
∑ª¡_id
, "%s$%X", (
∑ª¡
 ?Ö¨ít:""), 
i
+
°¨tID
);

774 
	`SˇnDúe˘‹y
(
fuŒ_∑th
, 
∑ª¡_id
, 
dú_ty≥s
);

775 
	`‰ì
(
∑ª¡_id
);

777 if–
ty≥
 =
TYPE_FILE
 && (
	`ac˚ss
(
fuŒ_∑th
, 
R_OK
) == 0) )

779 if–
	`ö£π_fûe
(
«me
, 
fuŒ_∑th
, (
∑ª¡
 ?Ö¨ít:""), 
i
+
°¨tID
) == 0 )

780 
fûío
++;

782 
	`‰ì
(
«me
);

783 
	`‰ì
(
«mñi°
[
i
]);

785 
	`‰ì
(
«mñi°
);

786 
	`‰ì
(
fuŒ_∑th
);

787 if–!
∑ª¡
 )

789 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, 
	`_
("Sˇ¬ög %†föished (%Œu fûes)!\n"), 
dú
, 
fûío
);

791 
	}
}

794 
	$_nŸify_°¨t
()

796 #ifde‡
READYNAS


797 
FILE
 *
Êag
 = 
	`f›í
("/ramfs/.upnp-av_scan", "w");

798 if–
Êag
 )

799 
	`f˛o£
(
Êag
);

801 
	}
}

804 
	$_nŸify_°›
()

806 #ifde‡
READYNAS


807 if–
	`ac˚ss
("/ømfs/.ªsˇn_d⁄e", 
F_OK
) == 0 )

808 
	`sy°em
("/bin/sh /ramfs/.rescan_done");

809 
	`u∆ök
("/ramfs/.upnp-av_scan");

811 
	}
}

814 
	$°¨t_sˇ¬î
()

816 
medü_dú_s
 *
medü_∑th
;

817 
∑th
[
MAXPATHLEN
];

819 i‡(
	`£çri‹ôy
(
PRIO_PROCESS
, 0, 15) == -1)

820 
	`DPRINTF
(
E_WARN
, 
L_INOTIFY
, "FailedÅoÑeduce scannerÅhreadÖriority\n");

821 
	`_nŸify_°¨t
();

823 
	`£éoˇÀ
(
LC_COLLATE
, "");

825 
	`av_ªgi°î_Æl
();

826 
	`av_log_£t_Àvñ
(
AV_LOG_PANIC
);

827  
medü_∑th
 = 
medü_dús
; medü_∑th !
NULL
; medü_∑th = medü_∑th->
√xt
 )

829 
öt64_t
 
id
;

830 *
b«me
, *
∑ª¡
 = 
NULL
;

831 
buf
[8];

832 
	`°∫˝yt
(
∑th
, 
medü_∑th
->path, (path));

833 
b«me
 = 
	`ba£«me
(
∑th
);

835 if–
medü_dús
 && medü_dús->
√xt
 )

837 
°¨tID
 = 
	`gë_√xt_avaûabÀ_id
("OBJECTS", 
BROWSEDIR_ID
);

838 
id
 = 
	`ö£π_dúe˘‹y
(
b«me
, 
∑th
, 
BROWSEDIR_ID
, "", 
°¨tID
);

839 
	`•rötf
(
buf
, "$%X", 
°¨tID
);

840 
∑ª¡
 = 
buf
;

843 
id
 = 
	`GëFﬁdîMëad©a
(
b«me
, 
medü_∑th
->
∑th
, 
NULL
, NULL, 0);

845 
	`sql_exec
(
db
, "UPDATE DETAILS së TIMESTAMP = %d whîêID = %Œd", 
medü_∑th
->
ty≥s
, ()
id
);

846 
	`SˇnDúe˘‹y
(
medü_∑th
->
∑th
, 
∑ª¡
, medü_∑th->
ty≥s
);

847 
	`sql_exec
(
db
, "INSERT i¡ÿSETTINGS vÆue†(%Q, %Q)", "medü_dú", 
medü_∑th
->
∑th
);

849 
	`_nŸify_°›
();

853 
	`sql_exec
(
db
, "create INDEX IDX_SEARCH_OPT ON OBJECTS(OBJECT_ID, CLASS, DETAIL_ID);");

855 if–
	`GETFLAG
(
NO_PLAYLIST_MASK
) )

857 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Playlist creation disabled\n");

861 
	`fûl_∂ayli°s
();

864 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "Inôü»fûêsˇ¿com∂ëed\n", 
DB_VERSION
);

866 
	`sql_exec
(
db
, "¥agm®u£r_vîsi⁄ = %d;", 
DB_VERSION
);

867 
	}
}

	@scanner.h

24 #i‚de‡
__SCANNER_H__


25 
	#__SCANNER_H__


	)

28 
	#BROWSEDIR_ID
 "64"

	)

30 
	#MUSIC_ID
 "1"

	)

31 
	#MUSIC_ALL_ID
 "1$4"

	)

32 
	#MUSIC_GENRE_ID
 "1$5"

	)

33 
	#MUSIC_ARTIST_ID
 "1$6"

	)

34 
	#MUSIC_ALBUM_ID
 "1$7"

	)

35 
	#MUSIC_PLIST_ID
 "1$F"

	)

36 
	#MUSIC_DIR_ID
 "1$14"

	)

37 
	#MUSIC_CONTRIB_ARTIST_ID
 "1$100"

	)

38 
	#MUSIC_ALBUM_ARTIST_ID
 "1$107"

	)

39 
	#MUSIC_COMPOSER_ID
 "1$108"

	)

40 
	#MUSIC_RATING_ID
 "1$101"

	)

42 
	#VIDEO_ID
 "2"

	)

43 
	#VIDEO_ALL_ID
 "2$8"

	)

44 
	#VIDEO_GENRE_ID
 "2$9"

	)

45 
	#VIDEO_ACTOR_ID
 "2$A"

	)

46 
	#VIDEO_SERIES_ID
 "2$E"

	)

47 
	#VIDEO_PLIST_ID
 "2$10"

	)

48 
	#VIDEO_DIR_ID
 "2$15"

	)

49 
	#VIDEO_RATING_ID
 "2$200"

	)

51 
	#IMAGE_ID
 "3"

	)

52 
	#IMAGE_ALL_ID
 "3$B"

	)

53 
	#IMAGE_DATE_ID
 "3$C"

	)

54 
	#IMAGE_ALBUM_ID
 "3$D"

	)

55 
	#IMAGE_CAMERA_ID
 "3$D2"

56 
	#IMAGE_PLIST_ID
 "3$11"

	)

57 
	#IMAGE_DIR_ID
 "3$16"

	)

58 
	#IMAGE_RATING_ID
 "3$300"

	)

60 
vÆid_ˇche
;

63 
is_video
(c⁄° *
fûe
);

66 
is_audio
(c⁄° *
fûe
);

69 
is_image
(c⁄° *
fûe
);

71 
öt64_t


72 
gë_√xt_avaûabÀ_id
(c⁄° *
èbÀ
, c⁄° *
∑ª¡ID
);

74 
öt64_t


75 
ö£π_dúe˘‹y
(c⁄° *
«me
, c⁄° *
∑th
, c⁄° *
ba£
, c⁄° *
∑ª¡ID
, 
obje˘ID
);

78 
ö£π_fûe
(*
«me
, c⁄° *
∑th
, c⁄° *
∑ª¡ID
, 
obje˘
);

81 
Cª©eD©aba£
();

84 
°¨t_sˇ¬î
();

	@scanner_sqlite.h

25 
	g¸óã_obje˘TabÀ_sqlôe
[] = "CREATE TABLE OBJECTS ("

34 
	g¸óã_dëaûTabÀ_sqlôe
[] = "CREATE TABLE DETAILS ("

59 
	g¸óã_ÆbumAπTabÀ_sqlôe
[] = "CREATE TABLE ALBUM_ART ("

64 
	g¸óã_ˇ±i⁄TabÀ_sqlôe
[] = "CREATE TABLE CAPTIONS ("

69 
	g¸óã_bookm¨kTabÀ_sqlôe
[] = "CREATE TABLE BOOKMARKS ("

74 
	g¸óã_∂ayli°TabÀ_sqlôe
[] = "CREATE TABLE PLAYLISTS ("

82 
	g¸óã_£âögsTabÀ_sqlôe
[] = "CREATE TABLE SETTINGS ("

	@sendfile.h

18 #i‡
deföed
(
HAVE_LINUX_SENDFILE_API
)

20 
	~<sys/£ndfûe.h
>

22 
	$sys_£ndfûe
(
sock
, 
£ndfd
, 
off_t
 *
off£t
, off_à
Àn
)

24  
	`£ndfûe
(
sock
, 
£ndfd
, 
off£t
, 
Àn
);

25 
	}
}

27 #ñi‡
deföed
(
HAVE_DARWIN_SENDFILE_API
)

29 
	~<sys/ty≥s.h
>

30 
	~<sys/sockë.h
>

31 
	~<sys/uio.h
>

33 
	$sys_£ndfûe
(
sock
, 
£ndfd
, 
off_t
 *
off£t
, off_à
Àn
)

35 
ªt
;

37 
ªt
 = 
	`£ndfûe
(
£ndfd
, 
sock
, *
off£t
, &
Àn
, 
NULL
, 0);

38 *
off£t
 +
Àn
;

40  
ªt
;

41 
	}
}

43 #ñi‡
deföed
(
HAVE_FREEBSD_SENDFILE_API
)

45 
	~<sys/ty≥s.h
>

46 
	~<sys/sockë.h
>

47 
	~<sys/uio.h
>

49 
	$sys_£ndfûe
(
sock
, 
£ndfd
, 
off_t
 *
off£t
, off_à
Àn
)

51 
ªt
;

52 
size_t
 
nbyãs
 = 
Àn
;

54 
ªt
 = 
	`£ndfûe
(
£ndfd
, 
sock
, *
off£t
, 
nbyãs
, 
NULL
, &
Àn
, 
SF_MNOWAIT
);

55 *
off£t
 +
Àn
;

57  
ªt
;

58 
	}
}

62 
	~<î∫o.h
>

64 
	$sys_£ndfûe
(
sock
, 
£ndfd
, 
off_t
 *
off£t
, off_à
Àn
)

66 
î∫o
 = 
EINVAL
;

68 
	}
}

	@sql.c

18 
	~<°dio.h
>

19 
	~<°rög.h
>

20 
	~<uni°d.h
>

22 
	~"sql.h
"

23 
	~"u≤pglobÆv¨s.h
"

24 
	~"log.h
"

27 
	$sql_exec
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...)

29 
ªt
;

30 *
îrMsg
 = 
NULL
;

31 *
sql
;

32 
va_li°
 
≠
;

35 
	`va_°¨t
(
≠
, 
fmt
);

37 
sql
 = 
	`sqlôe3_vm¥ötf
(
fmt
, 
≠
);

38 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 0, 0, &
îrMsg
);

39 if–
ªt
 !
SQLITE_OK
 )

41 
	`DPRINTF
(
E_ERROR
, 
L_DB_SQL
, "SQL ERROR %d [%s]\n%s\n", 
ªt
, 
îrMsg
, 
sql
);

42 i‡(
îrMsg
)

43 
	`sqlôe3_‰ì
(
îrMsg
);

45 
	`sqlôe3_‰ì
(
sql
);

47  
ªt
;

48 
	}
}

51 
	$sql_gë_èbÀ
(
sqlôe3
 *
db
, c⁄° *
sql
, ***
∑zResu…
, *
≤Row
, *
≤Cﬁumn
)

53 
ªt
;

54 *
îrMsg
 = 
NULL
;

57 
ªt
 = 
	`sqlôe3_gë_èbÀ
(
db
, 
sql
, 
∑zResu…
, 
≤Row
, 
≤Cﬁumn
, &
îrMsg
);

58 if–
ªt
 !
SQLITE_OK
 )

60 
	`DPRINTF
(
E_ERROR
, 
L_DB_SQL
, "SQL ERROR %d [%s]\n%s\n", 
ªt
, 
îrMsg
, 
sql
);

61 i‡(
îrMsg
)

62 
	`sqlôe3_‰ì
(
îrMsg
);

65  
ªt
;

66 
	}
}

69 
	$sql_gë_öt_fõld
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...)

71 
va_li°
 
≠
;

72 
cou¡î
, 
ªsu…
;

73 *
sql
;

74 
ªt
;

75 
sqlôe3_°mt
 *
°mt
;

77 
	`va_°¨t
(
≠
, 
fmt
);

79 
sql
 = 
	`sqlôe3_vm¥ötf
(
fmt
, 
≠
);

83 
	`sqlôe3_¥ï¨e_v2
(
db
, 
sql
, -1, &
°mt
, 
NULL
))

85 
SQLITE_OK
:

88 
	`DPRINTF
(
E_ERROR
, 
L_DB_SQL
, "¥ï¨êÁûed: %s\n%s\n", 
	`sqlôe3_îrmsg
(
db
), 
sql
);

89 
	`sqlôe3_‰ì
(
sql
);

93 
cou¡î
 = 0;

94 ((
ªsu…
 = 
	`sqlôe3_°ï
(
°mt
)Ë=
SQLITE_BUSY
 ||Ñesu… =
SQLITE_LOCKED
Ë&& 
cou¡î
 < 2;

95 
cou¡î
++) {

98 i‡(
ªsu…
 =
SQLITE_LOCKED
)

99 
	`¶ìp
(1);

102 
ªsu…
)

104 
SQLITE_DONE
:

106 
ªt
 = 0;

108 
SQLITE_ROW
:

109 i‡(
	`sqlôe3_cﬁumn_ty≥
(
°mt
, 0Ë=
SQLITE_NULL
)

111 
ªt
 = 0;

114 
ªt
 = 
	`sqlôe3_cﬁumn_öt
(
°mt
, 0);

117 
	`DPRINTF
(
E_WARN
, 
L_DB_SQL
, "%s: sã∞Áûed: %s\n%s\n", 
__func__
, 
	`sqlôe3_îrmsg
(
db
), 
sql
);

118 
ªt
 = -1;

122 
	`sqlôe3_‰ì
(
sql
);

123 
	`sqlôe3_föÆize
(
°mt
);

124  
ªt
;

125 
	}
}

128 
	$sql_gë_ãxt_fõld
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...)

130 
va_li°
 
≠
;

131 
cou¡î
, 
ªsu…
, 
Àn
;

132 *
sql
;

133 *
°r
;

134 
sqlôe3_°mt
 *
°mt
;

136 
	`va_°¨t
(
≠
, 
fmt
);

138 i‡(
db
 =
NULL
)

140 
	`DPRINTF
(
E_WARN
, 
L_DB_SQL
, "db is NULL\n");

141  
NULL
;

144 
sql
 = 
	`sqlôe3_vm¥ötf
(
fmt
, 
≠
);

148 
	`sqlôe3_¥ï¨e_v2
(
db
, 
sql
, -1, &
°mt
, 
NULL
))

150 
SQLITE_OK
:

153 
	`DPRINTF
(
E_ERROR
, 
L_DB_SQL
, "¥ï¨êÁûed: %s\n%s\n", 
	`sqlôe3_îrmsg
(
db
), 
sql
);

154 
	`sqlôe3_‰ì
(
sql
);

155  
NULL
;

157 
	`sqlôe3_‰ì
(
sql
);

159 
cou¡î
 = 0;

160 ((
ªsu…
 = 
	`sqlôe3_°ï
(
°mt
)Ë=
SQLITE_BUSY
 ||Ñesu… =
SQLITE_LOCKED
Ë&& 
cou¡î
 < 2;

161 
cou¡î
++)

165 i‡(
ªsu…
 =
SQLITE_LOCKED
)

166 
	`¶ìp
(1);

169 
ªsu…
)

171 
SQLITE_DONE
:

173 
°r
 = 
NULL
;

176 
SQLITE_ROW
:

177 i‡(
	`sqlôe3_cﬁumn_ty≥
(
°mt
, 0Ë=
SQLITE_NULL
)

179 
°r
 = 
NULL
;

183 
Àn
 = 
	`sqlôe3_cﬁumn_byãs
(
°mt
, 0);

184 i‡((
°r
 = 
	`sqlôe3_mÆloc
(
Àn
 + 1)Ë=
NULL
)

186 
	`DPRINTF
(
E_ERROR
, 
L_DB_SQL
, "malloc failed\n");

190 
	`°∫˝y
(
°r
, (*)
	`sqlôe3_cﬁumn_ãxt
(
°mt
, 0), 
Àn
 + 1);

194 
	`DPRINTF
(
E_WARN
, 
L_DB_SQL
, "SQL sã∞Áûed: %s\n", 
	`sqlôe3_îrmsg
(
db
));

195 
°r
 = 
NULL
;

199 
	`sqlôe3_föÆize
(
°mt
);

200  
°r
;

201 
	}
}

204 
	$db_upgøde
(
sqlôe3
 *
db
)

206 
db_vîs
;

208 
db_vîs
 = 
	`sql_gë_öt_fõld
(
db
, "PRAGMA user_version");

210 i‡(
db_vîs
 =
DB_VERSION
)

212 i‡(
db_vîs
 > 
DB_VERSION
)

214 i‡(
db_vîs
 < 1)

216 i‡(
db_vîs
 < 9)

218 
	`sql_exec
(
db
, "PRAGMA u£r_vîsi⁄ = %d", 
DB_VERSION
);

221 
	}
}

	@sql.h

24 #i‚de‡
__SQL_H__


25 
	#__SQL_H__


	)

27 
	~<sqlôe3.h
>

29 #i‚de‡
HAVE_SQLITE3_MALLOC


30 
	#sqlôe3_mÆloc
(
size
Ë
	`sqlôe3_m¥ötf
("%*s", size, "")

	)

32 #i‚de‡
HAVE_SQLITE3_PREPARE_V2


33 
	#sqlôe3_¥ï¨e_v2
 
sqlôe3_¥ï¨e


	)

37 
sql_exec
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...);

40 
sql_gë_èbÀ
(
sqlôe3
 *
db
, c⁄° *
zSql
, ***
∑zResu…
, *
≤Row
, *
≤Cﬁumn
);

43 
sql_gë_öt_fõld
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...);

46 
sql_gë_ãxt_fõld
(
sqlôe3
 *
db
, c⁄° *
fmt
, ...);

49 
db_upgøde
(
sqlôe3
 *
db
);

	@tagutils/misc.c

22 
	~"c⁄fig.h
"

23 
	~<°dio.h
>

24 
	~<°rög.h
>

25 #ifde‡
HAVE_MACHINE_ENDIAN_H


26 
	~<machöe/ídün.h
>

28 
	~<ídün.h
>

31 
	~"misc.h
"

33 
ölöe
 
__u16


34 
	$À16_to_˝u
(
__u16
 
À16
)

36 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


37  
À16
;

39 
__u16
 
be16
 = ((
À16
 << 8) & 0xff00) | ((le16 >> 8) & 0x00ff);

40  
be16
;

42 
	}
}

44 
ölöe
 
__u32


45 
	$À32_to_˝u
(
__u32
 
À32
)

47 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


48  
À32
;

50 
__u32
 
be32
 =

51 ((
À32
 << 24) & 0xff000000) |

52 ((
À32
 << 8) & 0x00ff0000) |

53 ((
À32
 >> 8) & 0x0000ff00) |

54 ((
À32
 >> 24) & 0x000000ff);

55  
be32
;

57 
	}
}

59 
ölöe
 
__u64


60 
	$À64_to_˝u
(
__u64
 
À64
)

62 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


63  
À64
;

65 
__u64
 
be64
;

66 
__u8
 *
À64p
 = (__u8*)&
À64
;

67 
__u8
 *
be64p
 = (__u8*)&
be64
;

68 
be64p
[0] = 
À64p
[7];

69 
be64p
[1] = 
À64p
[6];

70 
be64p
[2] = 
À64p
[5];

71 
be64p
[3] = 
À64p
[4];

72 
be64p
[4] = 
À64p
[3];

73 
be64p
[5] = 
À64p
[2];

74 
be64p
[6] = 
À64p
[1];

75 
be64p
[7] = 
À64p
[0];

76  
be64
;

78 
	}
}

80 
ölöe
 
__u8


81 
	$fgë_byã
(
FILE
 *
Â
)

83 
__u8
 
d
;

85 i‡(!
	`‰ód
(&
d
, (d), 1, 
Â
))

87  
d
;

88 
	}
}

90 
ölöe
 
__u16


91 
	$fgë_À16
(
FILE
 *
Â
)

93 
__u16
 
d
;

95 i‡(!
	`‰ód
(&
d
, (d), 1, 
Â
))

97 
d
 = 
	`À16_to_˝u
(d);

98  
d
;

99 
	}
}

101 
ölöe
 
__u32


102 
	$fgë_À32
(
FILE
 *
Â
)

104 
__u32
 
d
;

106 i‡(!
	`‰ód
(&
d
, (d), 1, 
Â
))

108 
d
 = 
	`À32_to_˝u
(d);

109  
d
;

110 
	}
}

112 
ölöe
 
__u32


113 
	$˝u_to_be32
(
__u32
 
˝u32
)

115 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


116 
__u32
 
be32
 =

117 ((
˝u32
 << 24) & 0xff000000) |

118 ((
˝u32
 << 8) & 0x00ff0000) |

119 ((
˝u32
 >> 8) & 0x0000ff00) |

120 ((
˝u32
 >> 24) & 0x000000ff);

121  
be32
;

123  
˝u32
;

125 
	}
}

	@tagutils/misc.h

22 #i‚de‡
_SCANNER_MISC_H


23 
	#_SCANNER_MISC_H


	)

25 
	t__u8
;

26 sig√d 
	t__s8
;

27 
	t__u16
;

28 sig√d 
	t__s16
;

29 
	t__u32
;

30 sig√d 
	t__s32
;

31 #i‡
__WORDSIZE
 == 64

32 
	t__u64
;

33 sig√d 
	t__s64
;

35 
	t__u64
;

36 sig√d 
	t__s64
;

40 
ölöe
 
__u16
 
À16_to_˝u
(__u16 
À16
);

41 
ölöe
 
__u32
 
À32_to_˝u
(__u32 
À32
);

42 
ölöe
 
__u64
 
À64_to_˝u
(__u64 
À64
);

43 
ölöe
 
__u8
 
fgë_byã
(
FILE
 *
Â
);

44 
ölöe
 
__u16
 
fgë_À16
(
FILE
 *
Â
);

45 
ölöe
 
__u32
 
fgë_À32
(
FILE
 *
Â
);

47 
ölöe
 
__u32
 
˝u_to_be32
(__u32 
˝u32
);

49 * 
sha1_hex
(*
key
);

	@tagutils/tagutils-aac.c

30 
	$_Øc_föd©om
(
FILE
 *
fö
, 
max_off£t
, *
which_©om
, *
©om_size
)

32 
cuºít_off£t
 = 0;

33 
size
;

34 
©om
[4];

36 
cuºít_off£t
 < 
max_off£t
)

38 if(
	`‰ód
((*)&
size
, 1, (), 
fö
) != ())

41 
size
 = 
	`¡ohl
(size);

43 if(
size
 <= 7)

46 if(
	`‰ód
(
©om
, 1, 4, 
fö
) != 4)

49 if(
	`°∫ˇ£cmp
(
©om
, 
which_©om
, 4) == 0)

51 *
©om_size
 = 
size
;

52  
cuºít_off£t
;

55 
	`f£ek
(
fö
, 
size
 - 8, 
SEEK_CUR
);

56 
cuºít_off£t
 +
size
;

60 
	}
}

64 
	$_gë_Ø˘ags
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

66 
FILE
 *
fö
;

67 
©om_off£t
;

68 
©om_Àngth
;

70 
cuºít_off£t
 = 0;

71 
cuºít_size
;

72 
cuºít_©om
[4];

73 *
cuºít_d©a
 = 
NULL
;

74 
gíª
;

75 
Àn
;

77 if(!(
fö
 = 
	`f›í
(
fûe
, "rb")))

79 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸ o≥¿fûê%†f‹Ñódög\n", 
fûe
);

83 
	`f£ek
(
fö
, 0, 
SEEK_SET
);

85 
©om_off£t
 = 
	`_Øc_lookf‹©om
(
fö
, "moov:udè:mëa:û°", &
©om_Àngth
);

86 if(
©om_off£t
 != -1)

88 
cuºít_off£t
 < 
©om_Àngth
)

90 if(
	`‰ód
((*)&
cuºít_size
, 1, (), 
fö
) != ())

93 
cuºít_size
 = 
	`¡ohl
(current_size);

95 if(
cuºít_size
 <= 7 || current_size > 1<<24)

98 if(
	`‰ód
(
cuºít_©om
, 1, 4, 
fö
) != 4)

101 
Àn
 = 
cuºít_size
 - 7;

102 if(
Àn
 < 22)

103 
Àn
 = 22;

105 
cuºít_d©a
 = (*)
	`mÆloc
(
Àn
);

106 
	`mem£t
(
cuºít_d©a
, 0x00, 
Àn
);

108 if(
	`‰ód
(
cuºít_d©a
, 1, 
cuºít_size
 - 8, 
fö
) != current_size - 8)

111 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "nam", 4))

112 
ps⁄g
->
tôÀ
 = 
	`°rdup
((*)&
cuºít_d©a
[16]);

113 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "ART", 4) ||

114 !
	`memcmp
(
cuºít_©om
, "\xA9" "art", 4))

115 
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
] = 
	`°rdup
((*)&
cuºít_d©a
[16]);

116 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "alb", 4))

117 
ps⁄g
->
Æbum
 = 
	`°rdup
((*)&
cuºít_d©a
[16]);

118 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "cmt", 4))

119 
ps⁄g
->
commít
 = 
	`°rdup
((*)&
cuºít_d©a
[16]);

120 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "dir", 4))

121 
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
] = 
	`°rdup
((*)&
cuºít_d©a
[16]);

122 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "wrt", 4))

123 
ps⁄g
->
c⁄åibut‹
[
ROLE_COMPOSER
] = 
	`°rdup
((*)&
cuºít_d©a
[16]);

124 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "grp", 4))

125 
ps⁄g
->
groupög
 = 
	`°rdup
((*)&
cuºít_d©a
[16]);

126 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "gen", 4))

127 
ps⁄g
->
gíª
 = 
	`°rdup
((*)&
cuºít_d©a
[16]);

128 if(!
	`memcmp
(
cuºít_©om
, "\xA9" "day", 4))

129 
ps⁄g
->
yór
 = 
	`©oi
((*)&
cuºít_d©a
[16]);

130 if(!
	`memcmp
(
cuºít_©om
, "tmpo", 4))

131 
ps⁄g
->
bpm
 = (
cuºít_d©a
[16] << 8) | current_data[17];

132 if(!
	`memcmp
(
cuºít_©om
, "trkn", 4))

134 
ps⁄g
->
åack
 = (
cuºít_d©a
[18] << 8) | current_data[19];

135 
ps⁄g
->
tŸÆ_åacks
 = (
cuºít_d©a
[20] << 8) | current_data[21];

137 if(!
	`memcmp
(
cuºít_©om
, "disk", 4))

139 
ps⁄g
->
disc
 = (
cuºít_d©a
[18] << 8) | current_data[19];

140 
ps⁄g
->
tŸÆ_discs
 = (
cuºít_d©a
[20] << 8) | current_data[21];

142 if(!
	`memcmp
(
cuºít_©om
, "gnre", 4))

144 
gíª
 = 
cuºít_d©a
[17] - 1;

145 if((
gíª
 < 0Ë|| (gíª > 
WINAMP_GENRE_UNKNOWN
))

146 
gíª
 = 
WINAMP_GENRE_UNKNOWN
;

147 
ps⁄g
->
gíª
 = 
	`°rdup
(
wöamp_gíª
[genre]);

149 if(!
	`memcmp
(
cuºít_©om
, "cpil", 4))

151 
ps⁄g
->
compû©i⁄
 = 
cuºít_d©a
[16];

153 if(!
	`memcmp
(
cuºít_©om
, "covr", 4))

155 
ps⁄g
->
image_size
 = 
cuºít_size
 - 8 - 16;

156 if((
ps⁄g
->
image
 = 
	`mÆloc
’s⁄g->
image_size
)))

157 
	`mem˝y
(
ps⁄g
->
image
, 
cuºít_d©a
+16,Ös⁄g->
image_size
);

159 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Ouào‡mem‹y [%s]\n", 
fûe
);

162 
	`‰ì
(
cuºít_d©a
);

163 
cuºít_d©a
 = 
NULL
;

164 
cuºít_off£t
 +
cuºít_size
;

167 
	`f˛o£
(
fö
);

168 
	`‰ì
(
cuºít_d©a
);

170 if(
©om_off£t
 == -1)

174 
	}
}

177 
off_t


178 
	$_Øc_lookf‹©om
(
FILE
 *
Øc_Â
, *
©om_∑th
, *
©om_Àngth
)

180 
©om_off£t
;

181 
off_t
 
fûe_size
;

182 *
cur_p
, *
íd_p
;

183 
©om_«me
[5];

185 
	`f£ek
(
Øc_Â
, 0, 
SEEK_END
);

186 
fûe_size
 = 
	`·ñl
(
Øc_Â
);

187 
	`ªwöd
(
Øc_Â
);

189 
íd_p
 = 
©om_∑th
;

190 *
íd_p
 != '\0')

192 
íd_p
++;

194 
©om_«me
[4] = '\0';

195 
cur_p
 = 
©om_∑th
;

197 
cur_p
)

199 if((
íd_p
 - 
cur_p
) < 4)

203 
	`°∫˝y
(
©om_«me
, 
cur_p
, 4);

204 
©om_off£t
 = 
	`_Øc_föd©om
(
Øc_Â
, 
fûe_size
, 
©om_«me
, (*)
©om_Àngth
);

205 if(
©om_off£t
 == -1)

209 
cur_p
 = 
	`°rchr
(cur_p, ':');

210 if(
cur_p
 !
NULL
)

212 
cur_p
++;

214 if(!
	`°rcmp
(
©om_«me
, "meta"))

216 
	`f£ek
(
Øc_Â
, 4, 
SEEK_CUR
);

218 if(!
	`°rcmp
(
©om_«me
, "stsd"))

220 
	`f£ek
(
Øc_Â
, 8, 
SEEK_CUR
);

222 if(!
	`°rcmp
(
©om_«me
, "mp4a"))

224 
	`f£ek
(
Øc_Â
, 28, 
SEEK_CUR
);

230  
	`·ñl
(
Øc_Â
) - 8;

231 
	}
}

234 
	$_Øc_check_exãnded_des¸ùt‹
(
FILE
 *
öfûe
)

236 
i
;

237 
buf
[3];

239 if–!
	`‰ód
((*)&
buf
, 3, 1, 
öfûe
) )

241  
i
=0; i<3; i++ )

243 if–(
buf
[
i
] != 0x80) &&

244 (
buf
[
i
] != 0x81) &&

245 (
buf
[
i
] != 0xFE) )

247 
	`f£ek
(
öfûe
, -3, 
SEEK_CUR
);

253 
	}
}

257 
	$_gë_Øcfûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

259 
FILE
 *
öfûe
;

260 
©om_off£t
;

261 
©om_Àngth
;

262 
ßm∂e_size
;

263 
ßm∂es
;

264 
bôøã
;

265 
off_t
 
fûe_size
;

266 
ms
;

267 
buf„r
[2];

268 
Øc_obje˘_ty≥_t
 
¥ofûe_id
 = 0;

270 
ps⁄g
->
vbr_sˇÀ
 = -1;

271 
ps⁄g
->
ch™√ls
 = 2;

273 
öfûe
 = 
	`f›í
(
fûe
, "rb");

274 if(!
öfûe
)

276 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "CouldÇŸ o≥¿%†f‹Ñódög\n", 
fûe
);

280 
	`f£ek
(
öfûe
, 0, 
SEEK_END
);

281 
fûe_size
 = 
	`·ñl
(
öfûe
);

282 
	`f£ek
(
öfûe
, 0, 
SEEK_SET
);

285 
©om_off£t
 = 
	`_Øc_lookf‹©om
(
öfûe
, "moov:mvhd", (*)&
©om_Àngth
);

286 if(
©om_off£t
 != -1)

288 
	`f£ek
(
öfûe
, 12, 
SEEK_CUR
);

289 if(!
	`‰ód
((*)&
ßm∂e_size
, 1, (), 
öfûe
) ||

290 !
	`‰ód
((*)&
ßm∂es
, 1, (), 
öfûe
))

292 
	`f˛o£
(
öfûe
);

296 
ßm∂e_size
 = 
	`¡ohl
(sample_size);

297 
ßm∂es
 = 
	`¡ohl
(samples);

300 
ms
 = 1000;

301 (
ms
 > 9Ë&& (!(
ßm∂e_size
 % 10)))

303 
ßm∂e_size
 /= 10;

304 
ms
 /= 10;

308 
ps⁄g
->
s⁄g_Àngth
 = ()((
ßm∂es
 * 
ms
Ë/ 
ßm∂e_size
);

311 
ps⁄g
->
bôøã
 = 0;

314 
©om_off£t
 = 
	`_Øc_lookf‹©om
(
öfûe
, "moov:åak:mdü:möf:°bl:°sd:Æac", (*)&
©om_Àngth
);

315 if(
©om_off£t
 != -1) {

316 
	`f£ek
(
öfûe
, 
©om_off£t
 + 32, 
SEEK_SET
);

317 i‡(
	`‰ód
(
buf„r
, (), 2, 
öfûe
) == 2)

318 
ps⁄g
->
ßm∂î©e
 = (
buf„r
[0] << 8) | (buffer[1]);

319 
bad_esds
;

323 
©om_off£t
 = 
	`_Øc_lookf‹©om
(
öfûe
, "moov:åak:mdü:möf:°bl:°sd:mp4a", (*)&
©om_Àngth
);

324 if(
©om_off£t
 != -1)

326 
	`f£ek
(
öfûe
, 
©om_off£t
 + 32, 
SEEK_SET
);

327 if(
	`‰ód
(
buf„r
, (), 2, 
öfûe
) == 2)

328 
ps⁄g
->
ßm∂î©e
 = (
buf„r
[0] << 8) | (buffer[1]);

330 
	`f£ek
(
öfûe
, 2, 
SEEK_CUR
);

333 
©om_off£t
 = 
	`_Øc_föd©om
(
öfûe
, 
©om_Àngth
 - (
	`·ñl
(infile) -átom_offset), "esds", &atom_length);

335 if(
©om_off£t
 != -1)

338 
	`f£ek
(
öfûe
, 
©om_off£t
 + 4, 
SEEK_CUR
);

340 if–!
	`‰ód
((*)&
buf„r
, 1, 1, 
öfûe
Ë|| (buf„r[0] !0x03Ë|| (
	`_Øc_check_exãnded_des¸ùt‹
(infile) != 0) )

341 
bad_esds
;

342 
	`f£ek
(
öfûe
, 4, 
SEEK_CUR
);

343 if–!
	`‰ód
((*)&
buf„r
, 1, 1, 
öfûe
Ë|| (buf„r[0] !0x04Ë|| (
	`_Øc_check_exãnded_des¸ùt‹
(infile) != 0) )

344 
bad_esds
;

345 
	`f£ek
(
öfûe
, 10, 
SEEK_CUR
);

346 if(
	`‰ód
((*)&
bôøã
, (), 1, 
öfûe
))

347 
ps⁄g
->
bôøã
 = 
	`¡ohl
(bitrate);

348 if–!
	`‰ód
((*)&
buf„r
, 1, 1, 
öfûe
Ë|| (buf„r[0] !0x05Ë|| (
	`_Øc_check_exãnded_des¸ùt‹
(infile) != 0) )

349 
bad_esds
;

350 
	`f£ek
(
öfûe
, 1, 
SEEK_CUR
);

351 if(
	`‰ód
((*)&
buf„r
, 2, 1, 
öfûe
))

353 
¥ofûe_id
 = (
buf„r
[0] >> 3);

355 
ßm∂es
 = ((
buf„r
[1] >> 3) & 0xF);

356 
ps⁄g
->
ch™√ls
 = (
ßm∂es
 == 7 ? 8 : samples);

360 
bad_esds
:

362 
©om_off£t
 = 
	`_Øc_lookf‹©om
(
öfûe
, "md©", (*)&
©om_Àngth
);

363 
ps⁄g
->
audio_size
 = 
©om_Àngth
 - 8;

364 
ps⁄g
->
audio_off£t
 = 
©om_off£t
;

366 if(!
ps⁄g
->
bôøã
)

370 if((
©om_off£t
 !-1Ë&& (
ps⁄g
->
s⁄g_Àngth
))

372 
ps⁄g
->
bôøã
 = 
©om_Àngth
 * 1000 /Ös⁄g->
s⁄g_Àngth
 / 128;

375 if((
ps⁄g
->
bôøã
 < 16000Ë&& (ps⁄g->
s⁄g_Àngth
 > 1000))

377 
ps⁄g
->
bôøã
 = (
fûe_size
 * 8Ë/ (ps⁄g->
s⁄g_Àngth
 / 1000);

382  
¥ofûe_id
 )

384 
AAC_LC
:

385 
AAC_LC_ER
:

386 if–
ps⁄g
->
ßm∂î©e
 < 8000 ||Ösong->samplerate > 48000 )

388 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unsupported AAC: sampleÑate isÇot 8000 < %d < 48000\n",

389 
ps⁄g
->
ßm∂î©e
);

393 if–
ps⁄g
->
ch™√ls
 <2 &&Ös⁄g->
bôøã
 <= 320000 )

394 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "AAC_ISO_320");

395 if–
ps⁄g
->
ch™√ls
 <2 &&Ös⁄g->
bôøã
 <= 576000 )

396 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "AAC_ISO");

397 if–
ps⁄g
->
ch™√ls
 <6 &&Ös⁄g->
bôøã
 <= 1440000 )

398 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "AAC_MULT5_ISO");

400 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unhandled AAC: %d channels, %d bitrate\n",

401 
ps⁄g
->
ch™√ls
,Ös⁄g->
bôøã
);

404 
	`DPRINTF
(
E_DEBUG
, 
L_METADATA
, "Unh™dÀd AACÅy≥ %d [%s]\n", 
¥ofûe_id
, 
	`ba£«me
(
fûe
));

408 
	`f˛o£
(
öfûe
);

410 
	}
}

	@tagutils/tagutils-aac.h

23 
_gë_Ø˘ags
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

24 
_gë_Øcfûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

25 
off_t
 
_Øc_lookf‹©om
(
FILE
 *
Øc_Â
, *
©om_∑th
, *
©om_Àngth
);

	@tagutils/tagutils-asf.c

24 
	$_asf_ªad_fûe_¥›îtõs
(
FILE
 *
Â
, 
asf_fûe_¥›îtõs_t
 *
p
, 
__u32
 
size
)

26 
Àn
;

28 
Àn
 = (*
p
Ë- 
	`off£tof
(
asf_fûe_¥›îtõs_t
, 
FûeID
);

29 if(
size
 < 
Àn
)

32 
	`mem£t
(
p
, 0, (*p));

33 
p
->
ID
 = 
ASF_FûePr›îtõs
;

34 
p
->
Size
 = 
size
;

36 if(
Àn
 !
	`‰ód
(&
p
->
FûeID
, 1,Üí, 
Â
))

40 
	}
}

43 
	$_pick_d a_¥ofûe
(
s⁄g_mëad©a
 *
ps⁄g
, 
uöt16_t
 
f‹m©
)

46  
	`À16_to_˝u
(
f‹m©
) )

48 
WMA
:

49 if–
ps⁄g
->
max_bôøã
 < 193000 )

50 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "WMABASE");

51 if–
ps⁄g
->
max_bôøã
 < 385000 )

52 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "WMAFULL");

54 
WMAPRO
:

55 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "WMAPRO");

57 
WMALSL
:

58 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "WMALSL%s",

59 
ps⁄g
->
ch™√ls
 > 2 ? "_MULT5" : "");

63 
	}
}

66 
	$_asf_ªad_audio_°ªam
(
FILE
 *
Â
, 
s⁄g_mëad©a
 *
ps⁄g
, 
size
)

68 
asf_audio_°ªam_t
 
s
;

69 
Àn
;

71 
Àn
 = (
s
Ë- (s.
Hdr
);

72 if(
Àn
 > 
size
)

73 
Àn
 = 
size
;

75 if(
Àn
 !
	`‰ód
(&
s
.
wfx
, 1,Üí, 
Â
))

78 
ps⁄g
->
ch™√ls
 = 
	`À16_to_˝u
(
s
.
wfx
.
nCh™√ls
);

79 
ps⁄g
->
bôøã
 = 
	`À32_to_˝u
(
s
.
wfx
.
nAvgByãsPîSec
) * 8;

80 
ps⁄g
->
ßm∂î©e
 = 
	`À32_to_˝u
(
s
.
wfx
.
nSam∂esPîSec
);

81 i‡(!
ps⁄g
->
max_bôøã
)

82 
ps⁄g
->
max_bôøã
 =Ös⁄g->
bôøã
;

83 
	`_pick_d a_¥ofûe
(
ps⁄g
, 
s
.
wfx
.
wF‹m©Tag
);

86 
	}
}

89 
	$_asf_ªad_medü_°ªam
(
FILE
 *
Â
, 
s⁄g_mëad©a
 *
ps⁄g
, 
__u32
 
size
)

91 
asf_medü_°ªam_t
 
s
;

92 
avi_audio_f‹m©_t
 
wfx
;

93 
Àn
;

95 
Àn
 = (
s
Ë- (s.
Hdr
);

96 if(
Àn
 > 
size
)

97 
Àn
 = 
size
;

99 if(
Àn
 !
	`‰ód
(&
s
.
Maj‹Ty≥
, 1,Üí, 
Â
))

102 if(
	`IsEquÆGUID
(&
s
.
Maj‹Ty≥
, &
ASF_MedüTy≥Audio
) &&

103 
	`IsEquÆGUID
(&
s
.
F‹m©Ty≥
, &
ASF_F‹m©Ty≥Wave
Ë&& s.
F‹m©Size
 >(
wfx
))

106 if((
wfx
Ë!
	`‰ód
(&wfx, 1, (wfx), 
Â
))

109 
ps⁄g
->
ch™√ls
 = 
	`À16_to_˝u
(
wfx
.
nCh™√ls
);

110 
ps⁄g
->
bôøã
 = 
	`À32_to_˝u
(
wfx
.
nAvgByãsPîSec
) * 8;

111 
ps⁄g
->
ßm∂î©e
 = 
	`À32_to_˝u
(
wfx
.
nSam∂esPîSec
);

112 i‡(!
ps⁄g
->
max_bôøã
)

113 
ps⁄g
->
max_bôøã
 =Ös⁄g->
bôøã
;

114 
	`_pick_d a_¥ofûe
(
ps⁄g
, 
wfx
.
wF‹m©Tag
);

118 
	}
}

121 
	$_asf_ªad_°ªam_obje˘
(
FILE
 *
Â
, 
s⁄g_mëad©a
 *
ps⁄g
, 
__u32
 
size
)

123 
asf_°ªam_obje˘_t
 
s
;

124 
Àn
;

126 
Àn
 = (
s
Ë- (
asf_obje˘_t
);

127 if(
size
 < 
Àn
)

130 if(
Àn
 !
	`‰ód
(&
s
.
SåómTy≥
, 1,Üí, 
Â
))

133 if(
	`IsEquÆGUID
(&
s
.
SåómTy≥
, &
ASF_AudioSåóm
))

134 
	`_asf_ªad_audio_°ªam
(
Â
, 
ps⁄g
, 
s
.
Ty≥S≥cificSize
);

135 if(
	`IsEquÆGUID
(&
s
.
SåómTy≥
, &
ASF_SåómBuf„rSåóm
))

136 
	`_asf_ªad_medü_°ªam
(
Â
, 
ps⁄g
, 
s
.
Ty≥S≥cificSize
);

137 if(!
	`IsEquÆGUID
(&
s
.
SåómTy≥
, &
ASF_VideoSåóm
))

139 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Unknownásf streamÅype.\n");

143 
	}
}

146 
	$_asf_ªad_exãnded_°ªam_obje˘
(
FILE
 *
Â
, 
s⁄g_mëad©a
 *
ps⁄g
, 
__u32
 
size
)

148 
i
, 
Àn
;

149 
off
;

150 
asf_obje˘_t
 
tmp
;

151 
asf_exãnded_°ªam_obje˘_t
 
xs
;

152 
asf_°ªam_«me_t
 
nm
;

153 
asf_∑ylﬂd_exãnsi⁄_t
 
≥
;

155 if(
size
 < (
asf_exãnded_°ªam_obje˘_t
))

158 
Àn
 = (
xs
Ë- 
	`off£tof
(
asf_exãnded_°ªam_obje˘_t
, 
SèπTime
);

159 if(
Àn
 !
	`‰ód
(&
xs
.
SèπTime
, 1,Üí, 
Â
))

161 
off
 = (
xs
);

163 
i
 = 0; i < 
xs
.
SåómNameCou¡
; i++)

165 if(
off
 + (
nm
Ë> 
size
)

167 if((
nm
Ë!
	`‰ód
(&nm, 1, “m), 
Â
))

169 
off
 +(
nm
);

170 if(
off
 + 
nm
.
Lígth
 > (
asf_exãnded_°ªam_obje˘_t
))

172 if(
nm
.
Lígth
 > 0)

173 
	`f£ek
(
Â
, 
nm
.
Lígth
, 
SEEK_CUR
);

174 
off
 +
nm
.
Lígth
;

177 
i
 = 0; i < 
xs
.
PaylﬂdExãnsi⁄Sy°emCou¡
; i++)

179 if(
off
 + (
≥
Ë> 
size
)

181 if((
≥
Ë!
	`‰ód
(&≥, 1, ’e), 
Â
))

183 
off
 +(
≥
);

184 if(
≥
.
InfoLígth
 > 0)

185 
	`f£ek
(
Â
, 
≥
.
InfoLígth
, 
SEEK_CUR
);

186 
off
 +
≥
.
InfoLígth
;

189 if(
off
 < 
size
)

191 if((
tmp
Ë!
	`‰ód
(&tmp, 1, —mp), 
Â
))

193 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_SåómHódî
))

194 
	`_asf_ªad_°ªam_obje˘
(
Â
, 
ps⁄g
, 
tmp
.
Size
);

198 
	}
}

201 
	$_asf_ªad_hódî_exãnsi⁄
(
FILE
 *
Â
, 
s⁄g_mëad©a
 *
ps⁄g
, 
__u32
 
size
)

203 
off_t
 
pos
;

204 
off
;

205 
asf_hódî_exãnsi⁄_t
 
ext
;

206 
asf_obje˘_t
 
tmp
;

208 if(
size
 < (
asf_hódî_exãnsi⁄_t
))

211 if((
ext
.
Re£rved1
Ë!
	`‰ód
(&ext.Re£rved1, 1, ”xt.Re£rved1), 
Â
))

213 
ext
.
Re£rved2
 = 
	`fgë_À16
(
Â
);

214 
ext
.
D©aSize
 = 
	`fgë_À32
(
Â
);

216 
pos
 = 
	`·ñl
(
Â
);

217 
off
 = 0;

218 
off
 < 
ext
.
D©aSize
)

220 if((
asf_hódî_exãnsi⁄_t
Ë+ 
off
 > 
size
)

222 if((
tmp
Ë!
	`‰ód
(&tmp, 1, —mp), 
Â
))

224 if(
off
 + 
tmp
.
Size
 > 
ext
.
D©aSize
)

226 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_ExãndedSåómPr›îtõsObje˘
))

227 
	`_asf_ªad_exãnded_°ªam_obje˘
(
Â
, 
ps⁄g
, 
tmp
.
Size
);

229 
off
 +
tmp
.
Size
;

230 
	`f£ek
(
Â
, 
pos
 + 
off
, 
SEEK_SET
);

234 
	}
}

237 
	$_asf_lﬂd_°rög
(
FILE
 *
Â
, 
ty≥
, 
size
, *
buf
, 
Àn
)

239 
d©a
[2048];

240 
__u16
 
wc
;

241 
i
, 
j
;

242 
__s32
 *
wd32
;

243 
__s64
 *
wd64
;

244 
__s16
 *
wd16
;

246 
i
 = 0;

247 if(
size
 && (sizê<(
d©a
)Ë&& (sizê=
	`‰ód
(d©a, 1, size, 
Â
)))

250 
ty≥
)

252 
ASF_VT_UNICODE
:

253 
j
 = 0; j < 
size
; j += 2)

255 
wd16
 = (
__s16
 *Ë&
d©a
[
j
];

256 
wc
 = (
__u16
)*
wd16
;

257 
i
 +
	`utf16À_to_utf8
(&
buf
[i], 
Àn
 - i, 
wc
);

260 
ASF_VT_BYTEARRAY
:

261 
i
 = 0; i < 
size
; i++)

263 if(
i
 + 1 >
Àn
)

265 
buf
[
i
] = 
d©a
[i];

268 
ASF_VT_BOOL
:

269 
ASF_VT_DWORD
:

270 if(
size
 >= 4)

272 
wd32
 = (
__s32
 *Ë&
d©a
[0];

273 
i
 = 
	`¢¥ötf
(
buf
, 
Àn
, "%d", 
	`À32_to_˝u
(*
wd32
));

276 
ASF_VT_QWORD
:

277 if(
size
 >= 8)

279 
wd64
 = (
__s64
 *Ë&
d©a
[0];

280 #i‡
__WORDSIZE
 == 64

281 
i
 = 
	`¢¥ötf
(
buf
, 
Àn
, "%ld", 
	`À64_to_˝u
(*
wd64
));

283 
i
 = 
	`¢¥ötf
(
buf
, 
Àn
, "%Œd", 
	`À64_to_˝u
(*
wd64
));

287 
ASF_VT_WORD
:

288 if(
size
 >= 2)

290 
wd16
 = (
__s16
 *Ë&
d©a
[0];

291 
i
 = 
	`¢¥ötf
(
buf
, 
Àn
, "%d", 
	`À16_to_˝u
(*
wd16
));

296 
size
 = 0;

298 
	`f£ek
(
Â
, 
size
, 
SEEK_CUR
);

300 
buf
[
i
] = 0;

301  
i
;

302 
	}
}

305 
	$_asf_lﬂd_pi˘uª
(
FILE
 *
Â
, 
size
, *
bm
, *
bm_size
)

307 
i
;

308 
buf
[256];

317 
pic_ty≥
;

318 
pic_size
;

320 
pic_ty≥
 = 
	`fgë_byã
(
Â
); 
size
 -= 1;

321 
pic_size
 = 
	`fgë_À32
(
Â
); 
size
 -= 4;

323 
	`f£ek
(
Â
, 5, 
SEEK_CUR
);

324 
size
 -= 5;

326 
i
 = 0; i < (
buf
) - 1; i++)

328 
buf
[
i
] = 
	`fgë_À16
(
Â
); 
size
 -= 2;

329 if(!
buf
[
i
])

332 
buf
[
i
] = '\0';

333 if(
i
 =(
buf
) - 1)

335 
	`fgë_À16
(
Â
))

336 
size
 -= 2;

339 if(!
	`°rˇ£cmp
(
buf
, "image/jpeg") ||

340 !
	`°rˇ£cmp
(
buf
, "image/jpg") ||

341 !
	`°rˇ£cmp
(
buf
, "image/peg"))

344 0 !
	`fgë_À16
(
Â
))

345 
size
 -= 2;

347 if(
size
 > 0)

349 if(!(
bm
 = 
	`mÆloc
(
size
)))

351 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Couldn'àÆloˇã %d byãs\n", 
size
);

355 *
bm_size
 = 
size
;

356 if(
size
 > *
bm_size
 || 
	`‰ód
(
bm
, 1, size, 
Â
) != size)

358 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Ovîru¿%d byã†ªquúed\n", 
size
);

359 
	`‰ì
(
bm
);

360 
bm
 = 
NULL
;

366 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "No binary data\n");

367 
size
 = 0;

368 
bm
 = 
NULL
;

373 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "InvÆid mimêty≥ %s\n", 
buf
);

376 *
bm_size
 = 
size
;

377  
bm
;

378 
	}
}

381 
	$_gë_asffûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

383 
FILE
 *
Â
;

384 
asf_obje˘_t
 
hdr
;

385 
asf_obje˘_t
 
tmp
;

386 
NumObje˘s
;

387 
TôÀLígth
;

388 
Auth‹Lígth
;

389 
C›yrightLígth
;

390 
Des¸ùti⁄Lígth
;

391 
R©ögLígth
;

392 
NumE¡rõs
;

393 
NameLígth
;

394 
VÆueTy≥
;

395 
VÆueLígth
;

396 
off_t
 
pos
;

397 
buf
[2048];

398 
asf_fûe_¥›îtõs_t
 
FûePr›îtõs
;

400 
ps⁄g
->
vbr_sˇÀ
 = -1;

402 if(!(
Â
 = 
	`f›í
(
fûe
, "rb")))

404 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "CouldÇŸ o≥¿%†f‹Ñódög\n", 
fûe
);

408 if((
hdr
Ë!
	`‰ód
(&hdr, 1, (hdr), 
Â
))

410 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Eº‹Ñódög %s\n", 
fûe
);

411 
	`f˛o£
(
Â
);

414 
hdr
.
Size
 = 
	`À64_to_˝u
(hdr.Size);

416 if(!
	`IsEquÆGUID
(&
hdr
.
ID
, &
ASF_HódîObje˘
))

418 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Notá valid header\n");

419 
	`f˛o£
(
Â
);

422 
NumObje˘s
 = 
	`fgë_À32
(
Â
);

423 
	`f£ek
(
Â
, 2, 
SEEK_CUR
);

425 
pos
 = 
	`·ñl
(
Â
);

426 
NumObje˘s
 > 0)

428 if((
tmp
Ë!
	`‰ód
(&tmp, 1, —mp), 
Â
))

430 
tmp
.
Size
 = 
	`À64_to_˝u
(tmp.Size);

432 if(
pos
 + 
tmp
.
Size
 > 
hdr
.Size)

434 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Sizêovîru¿ªadög hódî obje˘ %I64x\n", 
tmp
.
Size
);

438 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_FûePr›îtõs
))

440 
	`_asf_ªad_fûe_¥›îtõs
(
Â
, &
FûePr›îtõs
, 
tmp
.
Size
);

441 
ps⁄g
->
s⁄g_Àngth
 = 
	`À64_to_˝u
(
FûePr›îtõs
.
PœyDuøti⁄
) / 10000;

442 
ps⁄g
->
bôøã
 = 
	`À64_to_˝u
(
FûePr›îtõs
.
MaxBôøã
);

443 
ps⁄g
->
max_bôøã
 =Ös⁄g->
bôøã
;

445 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_C⁄ã¡Des¸ùti⁄
))

447 
TôÀLígth
 = 
	`fgë_À16
(
Â
);

448 
Auth‹Lígth
 = 
	`fgë_À16
(
Â
);

449 
C›yrightLígth
 = 
	`fgë_À16
(
Â
);

450 
Des¸ùti⁄Lígth
 = 
	`fgë_À16
(
Â
);

451 
R©ögLígth
 = 
	`fgë_À16
(
Â
);

453 if(
	`_asf_lﬂd_°rög
(
Â
, 
ASF_VT_UNICODE
, 
TôÀLígth
, 
buf
, (buf)))

455 if(
buf
[0])

456 
ps⁄g
->
tôÀ
 = 
	`°rdup
(
buf
);

458 if(
	`_asf_lﬂd_°rög
(
Â
, 
ASF_VT_UNICODE
, 
Auth‹Lígth
, 
buf
, (buf)))

460 if(
buf
[0])

461 
ps⁄g
->
c⁄åibut‹
[
ROLE_TRACKARTIST
] = 
	`°rdup
(
buf
);

463 if(
C›yrightLígth
)

464 
	`f£ek
(
Â
, 
C›yrightLígth
, 
SEEK_CUR
);

465 if(
Des¸ùti⁄Lígth
)

466 
	`f£ek
(
Â
, 
Des¸ùti⁄Lígth
, 
SEEK_CUR
);

467 if(
R©ögLígth
)

468 
	`f£ek
(
Â
, 
R©ögLígth
, 
SEEK_CUR
);

470 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_ExãndedC⁄ã¡Des¸ùti⁄
))

472 
NumE¡rõs
 = 
	`fgë_À16
(
Â
);

473 
NumE¡rõs
 > 0)

475 
NameLígth
 = 
	`fgë_À16
(
Â
);

476 
	`_asf_lﬂd_°rög
(
Â
, 
ASF_VT_UNICODE
, 
NameLígth
, 
buf
, (buf));

477 
VÆueTy≥
 = 
	`fgë_À16
(
Â
);

478 
VÆueLígth
 = 
	`fgë_À16
(
Â
);

480 if(!
	`°rˇ£cmp
(
buf
, "AlbumTitle") || !strcasecmp(buf, "WM/AlbumTitle"))

482 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

483 if(
buf
[0])

484 
ps⁄g
->
Æbum
 = 
	`°rdup
(
buf
);

486 if(!
	`°rˇ£cmp
(
buf
, "AlbumArtist") || !strcasecmp(buf, "WM/AlbumArtist"))

488 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

490 if(
buf
[0])

491 
ps⁄g
->
c⁄åibut‹
[
ROLE_ALBUMARTIST
] = 
	`°rdup
(
buf
);

494 if(!
	`°rˇ£cmp
(
buf
, "Description") || !strcasecmp(buf, "WM/Track"))

496 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

497 if(
buf
[0])

498 
ps⁄g
->
åack
 = 
	`©oi
(
buf
);

500 if(!
	`°rˇ£cmp
(
buf
, "Genre") || !strcasecmp(buf, "WM/Genre"))

502 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

503 if(
buf
[0])

504 
ps⁄g
->
gíª
 = 
	`°rdup
(
buf
);

506 if(!
	`°rˇ£cmp
(
buf
, "Year") || !strcasecmp(buf, "WM/Year"))

508 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

509 if(
buf
[0])

510 
ps⁄g
->
yór
 = 
	`©oi
(
buf
);

512 if(!
	`°rˇ£cmp
(
buf
, "WM/Director"))

514 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

515 if(
buf
[0])

516 
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
] = 
	`°rdup
(
buf
);

518 if(!
	`°rˇ£cmp
(
buf
, "WM/Composer"))

520 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

521 if(
buf
[0])

522 
ps⁄g
->
c⁄åibut‹
[
ROLE_COMPOSER
] = 
	`°rdup
(
buf
);

524 if(!
	`°rˇ£cmp
(
buf
, "WM/Pi˘uª"Ë&& (
VÆueTy≥
 =
ASF_VT_BYTEARRAY
))

526 
ps⁄g
->
image
 = 
	`_asf_lﬂd_pi˘uª
(
Â
, 
VÆueLígth
,Ös⁄g->image, &ps⁄g->
image_size
);

528 if(!
	`°rˇ£cmp
(
buf
, "TrackNumber") || !strcasecmp(buf, "WM/TrackNumber"))

530 if(
	`_asf_lﬂd_°rög
(
Â
, 
VÆueTy≥
, 
VÆueLígth
, 
buf
, (buf)))

531 if(
buf
[0])

532 
ps⁄g
->
åack
 = 
	`©oi
(
buf
);

534 if(!
	`°rˇ£cmp
(
buf
, "isVBR"))

536 
	`f£ek
(
Â
, 
VÆueLígth
, 
SEEK_CUR
);

537 
ps⁄g
->
vbr_sˇÀ
 = 0;

539 if(
VÆueLígth
)

541 
	`f£ek
(
Â
, 
VÆueLígth
, 
SEEK_CUR
);

543 
NumE¡rõs
--;

546 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_SåómHódî
))

548 
	`_asf_ªad_°ªam_obje˘
(
Â
, 
ps⁄g
, 
tmp
.
Size
);

550 if(
	`IsEquÆGUID
(&
tmp
.
ID
, &
ASF_HódîExãnsi⁄
))

552 
	`_asf_ªad_hódî_exãnsi⁄
(
Â
, 
ps⁄g
, 
tmp
.
Size
);

554 
pos
 +
tmp
.
Size
;

555 
	`f£ek
(
Â
, 
pos
, 
SEEK_SET
);

556 
NumObje˘s
--;

560 if((
hdr
Ë=
	`‰ód
(&hdr, 1, (hdr), 
Â
Ë&& 
	`IsEquÆGUID
(&hdr.
ID
, &
ASF_D©aObje˘
))

562 if(
ps⁄g
->
s⁄g_Àngth
)

564 
ps⁄g
->
bôøã
 = (
hdr
.
Size
 * 8000Ë/Ös⁄g->
s⁄g_Àngth
;

569 
	`f˛o£
(
Â
);

571 
	}
}

	@tagutils/tagutils-asf.h

24 
	#__PACKED__
 
	`__©åibuã__
((
∑cked
))

	)

26 #ifde‡
HAVE_MACHINE_ENDIAN_H


27 
	~<machöe/ídün.h
>

29 
	~<ídün.h
>

32 
	s_GUID
 {

33 
__u32
 
	ml
;

34 
__u16
 
	mw
[2];

35 
__u8
 
	mb
[8];

36 } 
	t__PACKED__
 
	tGUID
;

38 
	#DEFINE_GUID
(
«me
, 
l
, 
w1
, 
w2
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
) \

39 
GUID
 
«me
 = { 
l
, { 
w1
, 
w2
 }, { 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
 } }

	)

40 
	#IsEquÆGUID
(
rguid1
, 
rguid2
Ë(!
	`memcmp
‘guid1,Ñguid2, (
GUID
)))

	)

42 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


43 
	#SWAP32
(
l
Ë÷)

	)

44 
	#SWAP16
(
w
Ë(w)

	)

46 
	#SWAP32
(
l
Ë–((÷Ë>> 24Ë& 0x000000ffË| ((÷Ë>> 8Ë& 0x0000ff00Ë| ((÷Ë<< 8Ë& 0x00ff0000Ë| ((÷Ë<< 24Ë& 0xff000000Ë)

	)

47 
	#SWAP16
(
w
Ë–(((wË>> 8Ë& 0x00ffË| (((wË<< 8Ë& 0xff00Ë)

	)

50 
DEFINE_GUID
(
ASF_SåómHódî
, 
SWAP32
(0xb7dc0791), 
SWAP16
(0xa9b7), SWAP16(0x11cf),

53 
DEFINE_GUID
(
ASF_VideoSåóm
, 
SWAP32
(0xbc19efc0), 
SWAP16
(0x5b4d), SWAP16(0x11cf),

56 
DEFINE_GUID
(
ASF_AudioSåóm
, 
SWAP32
(0xf8699e40), 
SWAP16
(0x5b4d), SWAP16(0x11cf),

59 
DEFINE_GUID
(
ASF_HódîObje˘
, 
SWAP32
(0x75b22630), 
SWAP16
(0x668e), SWAP16(0x11cf),

62 
DEFINE_GUID
(
ASF_FûePr›îtõs
, 
SWAP32
(0x8ˇbdˇ1), 
SWAP16
(0xa947), SWAP16(0x11cf),

65 
DEFINE_GUID
(
ASF_C⁄ã¡Des¸ùti⁄
, 
SWAP32
(0x75b22633), 
SWAP16
(0x668e), SWAP16(0x11cf),

68 
DEFINE_GUID
(
ASF_ExãndedC⁄ã¡Des¸ùti⁄
, 
SWAP32
(0xd2d0a440), 
SWAP16
(0xe307), SWAP16(0x11d2),

71 
DEFINE_GUID
(
ASF_Clõ¡Guid
, 
SWAP32
(0x8d262e32), 
SWAP16
(0xfc28), SWAP16(0x11d7),

74 
DEFINE_GUID
(
ASF_HódîExãnsi⁄
, 
SWAP32
(0x5fbf03b5), 
SWAP16
(0xa92e), SWAP16(0x11cf),

77 
DEFINE_GUID
(
ASF_CodecLi°
, 
SWAP32
(0x86d15240), 
SWAP16
(0x311d), SWAP16(0x11d0),

80 
DEFINE_GUID
(
ASF_D©aObje˘
, 
SWAP32
(0x75b22636), 
SWAP16
(0x668e), SWAP16(0x11cf),

83 
DEFINE_GUID
(
ASF_PaddögObje˘
, 
SWAP32
(0x1806d474), 
SWAP16
(0xcadf), SWAP16(0x4509),

86 
DEFINE_GUID
(
ASF_Sim∂eIndexObje˘
, 
SWAP32
(0x33000890), 
SWAP16
(0xe5b1), SWAP16(0x11cf),

89 
DEFINE_GUID
(
ASF_NoEº‹C‹ª˘i⁄
, 
SWAP32
(0x20fb5700), 
SWAP16
(0x5b55), SWAP16(0x11cf),

92 
DEFINE_GUID
(
ASF_AudioS¥ód
, 
SWAP32
(0xbfc3cd50), 
SWAP16
(0x618f), SWAP16(0x11cf),

95 
DEFINE_GUID
(
ASF_Re£rved1
, 
SWAP32
(0xabd3d211), 
SWAP16
(0xa9ba), SWAP16(0x11cf),

98 
DEFINE_GUID
(
ASF_Re£rved2
, 
SWAP32
(0x86d15241), 
SWAP16
(0x311d), SWAP16(0x11d0),

101 
DEFINE_GUID
(
ASF_C⁄ã¡En¸y±i⁄Obje˘
, 
SWAP32
(0x2211B3FB), 
SWAP16
(0xBD23), SWAP16(0x11D2),

104 
DEFINE_GUID
(
ASF_ExãndedC⁄ã¡En¸y±i⁄Obje˘
, 
SWAP32
(0x298AE614), 
SWAP16
(0x2622), SWAP16(0x4C17),

107 
DEFINE_GUID
(
ASF_ExãndedSåómPr›îtõsObje˘
, 
SWAP32
(0x14E6A5CB), 
SWAP16
(0xC672), SWAP16(0x4332),

110 
DEFINE_GUID
(
ASF_MedüTy≥Audio
, 
SWAP32
(0x31178C9D), 
SWAP16
(0x03E1), SWAP16(0x4528),

113 
DEFINE_GUID
(
ASF_F‹m©Ty≥Wave
, 
SWAP32
(0xC4C4C4D1), 
SWAP16
(0x0049), SWAP16(0x4E2B),

116 
DEFINE_GUID
(
ASF_SåómBuf„rSåóm
, 
SWAP32
(0x3AFB65E2), 
SWAP16
(0x47EF), SWAP16(0x40F2),

119 
	s_BITMAPINFOHEADER
 {

120 
__u32
 
	mbiSize
;

121 
__s32
 
	mbiWidth
;

122 
__s32
 
	mbiHeight
;

123 
__u16
 
	mbiPœ√s
;

124 
__u16
 
	mbiBôCou¡
;

125 
__u32
 
	mbiCom¥essi⁄
;

126 
__u32
 
	mbiSizeImage
;

127 
__s32
 
	mbiXPñsPîMëî
;

128 
__s32
 
	mbiYPñsPîMëî
;

129 
__u32
 
	mbiCÃU£d
;

130 
__u32
 
	mbiCÃImp‹è¡
;

131 } 
	t__PACKED__
 
	tBITMAPINFOHEADER
;

133 
	s_WAVEFORMATEX
 {

134 
__u16
 
	mwF‹m©Tag
;

135 
__u16
 
	mnCh™√ls
;

136 
__u32
 
	mnSam∂esPîSec
;

137 
__u32
 
	mnAvgByãsPîSec
;

138 
__u16
 
	mnBlockAlign
;

139 
__u16
 
	mwBôsPîSam∂e
;

140 
__u16
 
	mcbSize
;

141 } 
	t__PACKED__
 
	tWAVEFORMATEX
;

143 
	s_asf_°ªam_obje˘_t
 {

144 
GUID
 
	mID
;

145 
__u64
 
	mSize
;

146 
GUID
 
	mSåómTy≥
;

147 
GUID
 
	mEº‹C‹ª˘i⁄Ty≥
;

148 
__u64
 
	mTimeOff£t
;

149 
__u32
 
	mTy≥S≥cificSize
;

150 
__u32
 
	mEº‹C‹ª˘i⁄Size
;

151 
__u16
 
	mSåómNumbî
;

152 
__u32
 
	mRe£rved
;

153 } 
	t__PACKED__
 
	tasf_°ªam_obje˘_t
;

155 
	s_asf_medü_°ªam_t
 {

156 
asf_°ªam_obje˘_t
 
	mHdr
;

157 
GUID
 
	mMaj‹Ty≥
;

158 
GUID
 
	mSubTy≥
;

159 
__u32
 
	mFixedSizeSam∂es
;

160 
__u32
 
	mTemp‹ÆCom¥essi⁄
;

161 
__u32
 
	mSam∂eSize
;

162 
GUID
 
	mF‹m©Ty≥
;

163 
__u32
 
	mF‹m©Size
;

164 } 
	t__PACKED__
 
	tasf_medü_°ªam_t
;

166 
	s_avi_audio_f‹m©_t
 {

167 
__u16
 
	mwF‹m©Tag
;

168 
__u16
 
	mnCh™√ls
;

169 
__u32
 
	mnSam∂esPîSec
;

170 
__u32
 
	mnAvgByãsPîSec
;

171 
__u16
 
	mnBlockAlign
;

172 
__u16
 
	mwBôsPîSam∂e
;

173 
__u16
 
	mcbSize
;

174 } 
	t__PACKED__
 
	tavi_audio_f‹m©_t
;

176 
	s_asf_exãnded_°ªam_obje˘_t
 {

177 
GUID
 
	mID
;

178 
__u64
 
	mSize
;

179 
__u64
 
	mSèπTime
;

180 
__u64
 
	mEndTime
;

181 
__u32
 
	mD©aBôøã
;

182 
__u32
 
	mBuf„rSize
;

183 
__u32
 
	mInôülBuf„rFuŒ√ss
;

184 
__u32
 
	mA…D©aBôøã
;

185 
__u32
 
	mA…Buf„rSize
;

186 
__u32
 
	mA…InôülBuf„rFuŒ√ss
;

187 
__u32
 
	mMaximumObje˘Size
;

188 
__u32
 
	mFœgs
;

189 
__u16
 
	mSåómNumbî
;

190 
__u16
 
	mL™guageIDIndex
;

191 
__u64
 
	mAvgTimePîFøme
;

192 
__u16
 
	mSåómNameCou¡
;

193 
__u16
 
	mPaylﬂdExãnsi⁄Sy°emCou¡
;

194 } 
	t__PACKED__
 
	tasf_exãnded_°ªam_obje˘_t
;

196 
	s_asf_°ªam_«me_t
 {

197 
__u16
 
	mID
;

198 
__u16
 
	mLígth
;

199 } 
	t__PACKED__
 
	tasf_°ªam_«me_t
;

201 
	s_asf_∑ylﬂd_exãnsi⁄_t
 {

202 
GUID
 
	mID
;

203 
__u16
 
	mSize
;

204 
__u32
 
	mInfoLígth
;

205 } 
	t__PACKED__
 
	tasf_∑ylﬂd_exãnsi⁄_t
;

209 
	s_asf_obje˘_t
 {

210 
GUID
 
	mID
;

211 
__u64
 
	mSize
;

212 } 
	t__PACKED__
 
	tasf_obje˘_t
;

214 
	s_asf_codec_íåy_t
 {

215 
__u16
 
	mTy≥
;

216 
__u16
 
	mNameLí
;

217 
__u32
 
	mName
;

218 
__u16
 
	mDescLí
;

219 
__u32
 
	mDesc
;

220 
__u16
 
	mInfoLí
;

221 
__u32
 
	mInfo
;

222 } 
	t__PACKED__
 
	tasf_codec_íåy_t
;

224 
	s_asf_codec_li°_t
 {

225 
GUID
 
	mID
;

226 
__u64
 
	mSize
;

227 
GUID
 
	mRe£rved
;

228 
__u64
 
	mNumE¡rõs
;

229 
asf_codec_íåy_t
 
	mE¡rõs
[2];

230 
asf_codec_íåy_t
 
	mVideoCodec
;

231 } 
	t__PACKED__
 
	tasf_codec_li°_t
;

233 
	s_asf_c⁄ã¡_des¸ùti⁄_t
 {

234 
GUID
 
	mID
;

235 
__u64
 
	mSize
;

236 
__u16
 
	mTôÀLígth
;

237 
__u16
 
	mAuth‹Lígth
;

238 
__u16
 
	mC›yrightLígth
;

239 
__u16
 
	mDes¸ùti⁄Lígth
;

240 
__u16
 
	mR©ögLígth
;

241 
__u32
 
	mTôÀ
;

242 
__u32
 
	mAuth‹
;

243 
__u32
 
	mC›yright
;

244 
__u32
 
	mDes¸ùti⁄
;

245 
__u32
 
	mR©ög
;

246 } 
	t__PACKED__
 
	tasf_c⁄ã¡_des¸ùti⁄_t
;

248 
	s_asf_fûe_¥›îtõs_t
 {

249 
GUID
 
	mID
;

250 
__u64
 
	mSize
;

251 
GUID
 
	mFûeID
;

252 
__u64
 
	mFûeSize
;

253 
__u64
 
	mCª©i⁄Time
;

254 
__u64
 
	mTŸÆPackës
;

255 
__u64
 
	mPœyDuøti⁄
;

256 
__u64
 
	mSídDuøti⁄
;

257 
__u64
 
	mPªrﬁl
;

258 
__u32
 
	mFœgs
;

259 
__u32
 
	mMöPackëSize
;

260 
__u32
 
	mMaxPackëSize
;

261 
__u32
 
	mMaxBôøã
;

262 } 
	t__PACKED__
 
	tasf_fûe_¥›îtõs_t
;

264 
	s_asf_hódî_exãnsi⁄_t
 {

265 
GUID
 
	mID
;

266 
__u64
 
	mSize
;

267 
GUID
 
	mRe£rved1
;

268 
__u16
 
	mRe£rved2
;

269 
__u32
 
	mD©aSize
;

270 } 
	t__PACKED__
 
	tasf_hódî_exãnsi⁄_t
;

272 
	s_asf_video_°ªam_t
 {

273 
asf_°ªam_obje˘_t
 
	mHdr
;

274 
__u32
 
	mWidth
;

275 
__u32
 
	mHeight
;

276 
__u8
 
	mRe£rvedFœgs
;

277 
__u16
 
	mF‹m©Size
;

278 
BITMAPINFOHEADER
 
	mbmi
;

279 
__u8
 
	mebih
[1];

280 } 
	t__PACKED__
 
	tasf_video_°ªam_t
;

282 
	s_asf_audio_°ªam_t
 {

283 
asf_°ªam_obje˘_t
 
	mHdr
;

284 
WAVEFORMATEX
 
	mwfx
;

285 } 
	t__PACKED__
 
	tasf_audio_°ªam_t
;

287 
	s_asf_∑ylﬂd_t
 {

288 
__u8
 
	mSåómNumbî
;

289 
__u8
 
	mMedüObje˘Numbî
;

290 
__u32
 
	mMedüObje˘Off£t
;

291 
__u8
 
	mRïliˇãdD©aLígth
;

292 
__u32
 
	mRïliˇãdD©a
[2];

293 
__u32
 
	mPaylﬂdLígth
;

294 } 
	t__PACKED__
 
	tasf_∑ylﬂd_t
;

296 
	s_asf_∑ckë_t
 {

297 
__u8
 
	mTy≥Fœgs
;

298 
__u8
 
	mECFœgs
;

299 
__u8
 
	mECTy≥
;

300 
__u8
 
	mECCy˛e
;

301 
__u8
 
	mPr›îtyFœgs
;

302 
__u32
 
	mPackëLígth
;

303 
__u32
 
	mSequí˚
;

304 
__u32
 
	mPaddögLígth
;

305 
__u32
 
	mSídTime
;

306 
__u16
 
	mDuøti⁄
;

307 
__u8
 
	mPaylﬂdFœgs
;

308 
asf_∑ylﬂd_t
 
	mPaylﬂd
;

309 } 
	t__PACKED__
 
	tasf_∑ckë_t
;

311 
	s_asf_d©a_obje˘_t
 {

312 
GUID
 
	mID
;

313 
__u64
 
	mSize
;

314 
GUID
 
	mFûeID
;

315 
__u64
 
	mTŸÆPackës
;

316 
	mRe£rved
;

317 } 
	t__PACKED__
 
	tasf_d©a_obje˘_t
;

319 
	s_asf_∑ddög_obje˘_t
 {

320 
GUID
 
	mID
;

321 
__u64
 
	mSize
;

322 } 
	t__PACKED__
 
	tasf_∑ddög_obje˘_t
;

324 
	s_asf_sim∂e_ödex_obje˘_t
 {

325 
GUID
 
	mID
;

326 
__u64
 
	mSize
;

327 
GUID
 
	mFûeID
;

328 
__u32
 
	mIndexE¡ryTimeI¡îvÆ
;

329 
__u32
 
	mMaximumPackëCou¡
;

330 
__u32
 
	mIndexE¡rõsCou¡
;

331 } 
	t__PACKED__
 
	tasf_sim∂e_ödex_obje˘_t
;

333 
	s_asf_hódî_obje˘_t
 {

334 
GUID
 
	mID
;

335 
__u64
 
	mSize
;

336 
__u32
 
	mNumObje˘s
;

337 
__u16
 
	mRe£rved
;

338 
asf_hódî_exãnsi⁄_t
 
	mHódîExãnsi⁄
;

339 
asf_c⁄ã¡_des¸ùti⁄_t
 
	mC⁄ã¡Des¸ùti⁄
;

340 
asf_fûe_¥›îtõs_t
 
	mFûePr›îtõs
;

341 
asf_video_°ªam_t
 * 
	mVideoSåóm
;

342 
asf_audio_°ªam_t
 * 
	mAudioSåóm
;

343 
asf_codec_li°_t
 
	mCodecLi°
;

344 
asf_∑ddög_obje˘_t
 
	mPaddögObje˘
;

345 } 
	t__PACKED__
 
	tasf_hódî_obje˘_t
;

348 
	#ASF_VT_UNICODE
 (0)

	)

349 
	#ASF_VT_BYTEARRAY
 (1)

	)

350 
	#ASF_VT_BOOL
 (2)

	)

351 
	#ASF_VT_DWORD
 (3)

	)

352 
	#ASF_VT_QWORD
 (4)

	)

353 
	#ASF_VT_WORD
 (5)

	)

355 
_gë_asffûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

	@tagutils/tagutils-flc.c

24 
	$_gë_Ê˘ags
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

26 
FLAC__Mëad©a_Sim∂eIãøt‹
 *
ôî©‹
 = 0;

27 
FLAC__SåómMëad©a
 *
block
;

28 
£c
, 
ms
;

29 
i
;

30 
îr
 = 0;

32 if(!(
ôî©‹
 = 
	`FLAC__mëad©a_sim∂e_ôî©‹_√w
()))

34 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
, "Out of memory while FLAC__metadata_simple_iterator_new()\n");

38 if(!
	`FLAC__mëad©a_sim∂e_ôî©‹_öô
(
ôî©‹
, 
fûíame
, 
åue
,Årue))

40 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸÉxåa˘Åag from %s\n", 
fûíame
);

45 if(!(
block
 = 
	`FLAC__mëad©a_sim∂e_ôî©‹_gë_block
(
ôî©‹
)))

47 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸÉxåa˘Åag from %s\n", 
fûíame
);

48 
îr
 = -1;

49 
_exô
;

52 
block
->
ty≥
)

54 
FLAC__METADATA_TYPE_STREAMINFO
:

55 
£c
 = ()(
block
->
d©a
.
°ªam_öfo
.
tŸÆ_ßm∂es
 /

56 
block
->
d©a
.
°ªam_öfo
.
ßm∂e_øã
);

57 
ms
 = ()(((
block
->
d©a
.
°ªam_öfo
.
tŸÆ_ßm∂es
 %

58 
block
->
d©a
.
°ªam_öfo
.
ßm∂e_øã
) * 1000) /

59 
block
->
d©a
.
°ªam_öfo
.
ßm∂e_øã
);

60 i‡((
£c
 =0Ë&& (
ms
 == 0))

62 
ps⁄g
->
s⁄g_Àngth
 = (
£c
 * 1000Ë+ 
ms
;

63 
ps⁄g
->
bôøã
 = (((
uöt64_t
)’s⁄g->
fûe_size
Ë* 1000Ë/ (ps⁄g->
s⁄g_Àngth
 / 8));

64 
ps⁄g
->
ßm∂î©e
 = 
block
->
d©a
.
°ªam_öfo
.
ßm∂e_øã
;

65 
ps⁄g
->
ch™√ls
 = 
block
->
d©a
.
°ªam_öfo
.channels;

68 
FLAC__METADATA_TYPE_VORBIS_COMMENT
:

69 
i
 = 0; i < 
block
->
d©a
.
v‹bis_commít
.
num_commíts
; i++)

71 
	`vc_sˇn
(
ps⁄g
,

72 (*)
block
->
d©a
.
v‹bis_commít
.
commíts
[
i
].
íåy
,

73 
block
->
d©a
.
v‹bis_commít
.
commíts
[
i
].
Àngth
);

76 #i‡
FLAC_API_VERSION_CURRENT
 >= 10

77 
FLAC__METADATA_TYPE_PICTURE
:

78 
ps⁄g
->
image_size
 = 
block
->
d©a
.
pi˘uª
.
d©a_Àngth
;

79 if((
ps⁄g
->
image
 = 
	`mÆloc
’s⁄g->
image_size
)))

80 
	`mem˝y
(
ps⁄g
->
image
, 
block
->
d©a
.
pi˘uª
.d©a,Ös⁄g->
image_size
);

82 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Ouào‡mem‹y [%s]\n", 
fûíame
);

88 
	`FLAC__mëad©a_obje˘_dñëe
(
block
);

90 
	`FLAC__mëad©a_sim∂e_ôî©‹_√xt
(
ôî©‹
));

92 
_exô
:

93 if(
ôî©‹
)

94 
	`FLAC__mëad©a_sim∂e_ôî©‹_dñëe
(
ôî©‹
);

96  
îr
;

97 
	}
}

100 
	$_gë_Êcfûeöfo
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

102 
ps⁄g
->
los¶ess
 = 1;

103 
ps⁄g
->
vbr_sˇÀ
 = 1;

106 
	}
}

	@tagutils/tagutils-flc.h

22 
_gë_Êcfûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

23 
_gë_Ê˘ags
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

	@tagutils/tagutils-misc.c

26 
	#MAX_ICONV_BUF
 1024

	)

29 
	mICONV_OK
,

30 
	mICONV_TRYNEXT
,

31 
	mICONV_FATAL


32 } 
	tic⁄v_ªsu…
;

34 
ic⁄v_ªsu…


35 
	$do_ic⁄v
(c⁄° * 
to_˚s
, c⁄° * 
‰om_˚s
,

36 
ICONV_CONST
 *
öbuf
, 
size_t
 
öbyã¶e·
,

37 *
outbuf_‹ig
, 
size_t
 
outbyã¶e·_‹ig
)

39 #ifde‡
HAVE_ICONV


40 
size_t
 
rc
;

41 
ic⁄v_ªsu…
 
ªt
 = 
ICONV_OK
;

43 
size_t
 
outbyã¶e·
 = 
outbyã¶e·_‹ig
 - 1;

44 * 
outbuf
 = 
outbuf_‹ig
;

46 
ic⁄v_t
 
cd
 = 
	`ic⁄v_›í
(
to_˚s
, 
‰om_˚s
);

48 if(
cd
 =(
ic⁄v_t
)-1)

50  
ICONV_FATAL
;

52 
rc
 = 
	`ic⁄v
(
cd
, &
öbuf
, &
öbyã¶e·
, &
outbuf
, &
outbyã¶e·
);

53 if(
rc
 =(
size_t
)-1)

55 if(
î∫o
 =
E2BIG
)

57 
ªt
 = 
ICONV_FATAL
;

61 
ªt
 = 
ICONV_TRYNEXT
;

62 
	`mem£t
(
outbuf_‹ig
, '\0', 
outbyã¶e·_‹ig
);

65 
	`ic⁄v_˛o£
(
cd
);

67  
ªt
;

69  
ICONV_FATAL
;

71 
	}
}

73 
	#N_LANG_ALT
 8

	)

75 *
	mœng
;

76 *
	m˝«mes
[
N_LANG_ALT
];

77 } 
	gic⁄v_m≠
[] = {

84 
	gœng_ödex
 = -1;

87 
	$_œng2˝
(*
œng
)

89 
˝
;

91 if(!
œng
 ||Üang[0] == '\0')

93 
˝
 = 0; 
ic⁄v_m≠
[˝].
œng
; cp++)

95 if(!
	`°rˇ£cmp
(
ic⁄v_m≠
[
˝
].
œng
,Üang))

96  
˝
;

99 
	}
}

102 
	$_gë_utf8_ãxt
(c⁄° 
id3_ucs4_t
* 
«tive_ãxt
)

104 *
utf8_ãxt
 = 
NULL
;

105 *
ö
, *
ö8
, *
ic⁄v_buf
;

106 
ic⁄v_ªsu…
 
rc
;

107 
i
, 
n
;

109 
ö
 = (*)
	`id3_ucs4_œtö1du∂iˇã
(
«tive_ãxt
);

110 if(!
ö
)

112 
out
;

115 
ö8
 = (*)
	`id3_ucs4_utf8du∂iˇã
(
«tive_ãxt
);

116 if(!
ö8
)

118 
	`‰ì
(
ö
);

119 
out
;

122 
ic⁄v_buf
 = (*)
	`ˇŒoc
(
MAX_ICONV_BUF
, ());

123 if(!
ic⁄v_buf
)

125 
	`‰ì
(
ö
); fªe(
ö8
);

126 
out
;

129 
i
 = 
œng_ödex
;

131 
rc
 = 
	`do_ic⁄v
(
ic⁄v_m≠
[
i
].
˝«mes
[0], "UTF-8", 
ö8
, 
	`°æí
(ö8), 
ic⁄v_buf
, 
MAX_ICONV_BUF
);

132 if(
rc
 =
ICONV_OK
)

134 
utf8_ãxt
 = (*)
ö8
;

135 
	`‰ì
(
ic⁄v_buf
);

137 if(
rc
 =
ICONV_TRYNEXT
)

140 
rc
 = 
	`do_ic⁄v
("UTF-8", 
ic⁄v_m≠
[
i
].
˝«mes
[0], 
ö
, 
	`°æí
(ö), 
ic⁄v_buf
, 
MAX_ICONV_BUF
);

141 if(
rc
 =
ICONV_OK
)

143 
utf8_ãxt
 = (*)
ic⁄v_buf
;

145 if(
rc
 =
ICONV_TRYNEXT
)

148 
n
 = 1;Ç < 
N_LANG_ALT
 && 
ic⁄v_m≠
[
i
].
˝«mes
[n];Ç++)

150 
rc
 = 
	`do_ic⁄v
("UTF-8", 
ic⁄v_m≠
[
i
].
˝«mes
[
n
], 
ö
, 
	`°æí
(ö), 
ic⁄v_buf
, 
MAX_ICONV_BUF
);

151 if(
rc
 =
ICONV_OK
)

153 
utf8_ãxt
 = (*)
ic⁄v_buf
;

157 if(!
utf8_ãxt
)

160 
utf8_ãxt
 = (*)
	`id3_ucs4_utf8du∂iˇã
(
«tive_ãxt
);

161 
	`‰ì
(
ic⁄v_buf
);

164 
	`‰ì
(
ö8
);

166 
	`‰ì
(
ö
);

168 
out
:

169 if(!
utf8_ãxt
)

171 
utf8_ãxt
 = (*)
	`°rdup
("UNKNOWN");

174  
utf8_ãxt
;

175 
	}
}

179 
	$vc_sˇn
(
s⁄g_mëad©a
 *
ps⁄g
, c⁄° *
commít
, c⁄° 
size_t
 
Àngth
)

181 
°rbuf
[1024];

183 if(
Àngth
 > ((
°rbuf
) - 1))

185 if–
	`°∫ˇ£cmp
(
commít
, "LYRICS=", 7) != 0 )

187 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "V‹bi†%.*†toÿl⁄g [%s]\n", (
	`ödex
(
commít
, '=')-commít), commít, 
ps⁄g
->
∑th
);

191 
	`°∫˝y
(
°rbuf
, 
commít
, 
Àngth
);

192 
°rbuf
[
Àngth
] = '\0';

199 if(!
	`°∫ˇ£cmp
(
°rbuf
, "ALBUM=", 6))

201 if–*(
°rbuf
+6) )

202 
ps⁄g
->
Æbum
 = 
	`°rdup
(
°rbuf
 + 6);

204 if(!
	`°∫ˇ£cmp
(
°rbuf
, "ARTIST=", 7))

206 if–*(
°rbuf
+7) )

207 
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
] = 
	`°rdup
(
°rbuf
 + 7);

209 if(!
	`°∫ˇ£cmp
(
°rbuf
, "ARTISTSORT=", 11))

211 
ps⁄g
->
c⁄åibut‹_s‹t
[
ROLE_ARTIST
] = 
	`°rdup
(
°rbuf
 + 11);

213 if(!
	`°∫ˇ£cmp
(
°rbuf
, "ALBUMARTIST=", 12))

215 if–*(
°rbuf
+12) )

216 
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
] = 
	`°rdup
(
°rbuf
 + 12);

218 if(!
	`°∫ˇ£cmp
(
°rbuf
, "ALBUMARTISTSORT=", 16))

220 
ps⁄g
->
c⁄åibut‹_s‹t
[
ROLE_BAND
] = 
	`°rdup
(
°rbuf
 + 16);

222 if(!
	`°∫ˇ£cmp
(
°rbuf
, "TITLE=", 6))

224 if–*(
°rbuf
+6) )

225 
ps⁄g
->
tôÀ
 = 
	`°rdup
(
°rbuf
 + 6);

227 if(!
	`°∫ˇ£cmp
(
°rbuf
, "TRACKNUMBER=", 12))

229 
ps⁄g
->
åack
 = 
	`©oi
(
°rbuf
 + 12);

231 if(!
	`°∫ˇ£cmp
(
°rbuf
, "DISCNUMBER=", 11))

233 
ps⁄g
->
disc
 = 
	`©oi
(
°rbuf
 + 11);

235 if(!
	`°∫ˇ£cmp
(
°rbuf
, "GENRE=", 6))

237 if–*(
°rbuf
+6) )

238 
ps⁄g
->
gíª
 = 
	`°rdup
(
°rbuf
 + 6);

240 if(!
	`°∫ˇ£cmp
(
°rbuf
, "DATE=", 5))

242 if(
Àngth
 >= (5 + 10) &&

243 
	`isdigô
(
°rbuf
[5 + 0]Ë&& isdigô(°rbuf[5 + 1]Ë&& 
	`i•un˘
(strbuf[5 + 2]) &&

244 
	`isdigô
(
°rbuf
[5 + 3]Ë&& isdigô(°rbuf[5 + 4]Ë&& 
	`i•un˘
(strbuf[5 + 5]) &&

245 
	`isdigô
(
°rbuf
[5 + 6]) && isdigit(strbuf[5 + 7]) && isdigit(strbuf[5 + 8]) && isdigit(strbuf[5 + 9]))

248 
°rbuf
[5 + 10] = '\0';

249 
ps⁄g
->
yór
 = 
	`©oi
(
°rbuf
 + 5 + 6);

254 
°rbuf
[5 + 4] = '\0';

255 
ps⁄g
->
yór
 = 
	`©oi
(
°rbuf
 + 5);

258 if(!
	`°∫ˇ£cmp
(
°rbuf
, "COMMENT=", 8))

260 if–*(
°rbuf
+8) )

261 
ps⁄g
->
commít
 = 
	`°rdup
(
°rbuf
 + 8);

263 if(!
	`°∫ˇ£cmp
(
°rbuf
, "MUSICBRAINZ_ALBUMID=", 20))

265 
ps⁄g
->
musicbøöz_Æbumid
 = 
	`°rdup
(
°rbuf
 + 20);

267 if(!
	`°∫ˇ£cmp
(
°rbuf
, "MUSICBRAINZ_TRACKID=", 20))

269 
ps⁄g
->
musicbøöz_åackid
 = 
	`°rdup
(
°rbuf
 + 20);

271 if(!
	`°∫ˇ£cmp
(
°rbuf
, "MUSICBRAINZ_TRACKID=", 20))

273 
ps⁄g
->
musicbøöz_åackid
 = 
	`°rdup
(
°rbuf
 + 20);

275 if(!
	`°∫ˇ£cmp
(
°rbuf
, "MUSICBRAINZ_ARTISTID=", 21))

277 
ps⁄g
->
musicbøöz_¨ti°id
 = 
	`°rdup
(
°rbuf
 + 21);

279 if(!
	`°∫ˇ£cmp
(
°rbuf
, "MUSICBRAINZ_ALBUMARTISTID=", 26))

281 
ps⁄g
->
musicbøöz_Æbum¨ti°id
 = 
	`°rdup
(
°rbuf
 + 26);

283 
	}
}

	@tagutils/tagutils-mp3.c

28 
	$_gë_mp3ègs
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

30 
id3_fûe
 *
pid3fûe
;

31 
id3_èg
 *
pid3èg
;

32 
id3_‰ame
 *
pid3‰ame
;

33 
îr
;

34 
ödex
;

35 
u£d
;

36 *
utf8_ãxt
;

37 
gíª
 = 
WINAMP_GENRE_UNKNOWN
;

38 
have_utf8
;

39 
have_ãxt
;

40 
id3_ucs4_t
 c⁄° *
«tive_ãxt
;

41 *
tmp
;

42 
gŸ_numîic_gíª
;

43 
id3_byã_t
 c⁄° *
image
;

44 
id3_Àngth_t
 
image_size
 = 0;

46 
pid3fûe
 = 
	`id3_fûe_›í
(
fûe
, 
ID3_FILE_MODE_READONLY
);

47 if(!
pid3fûe
)

49 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸ o≥¿%s\n", 
fûe
);

53 
pid3èg
 = 
	`id3_fûe_èg
(
pid3fûe
);

55 if(!
pid3èg
)

57 
îr
 = 
î∫o
;

58 
	`id3_fûe_˛o£
(
pid3fûe
);

59 
î∫o
 = 
îr
;

60 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "C™nŸ gë ID3Åag f‹ %s\n", 
fûe
);

64 
ödex
 = 0;

65 (
pid3‰ame
 = 
	`id3_èg_föd‰ame
(
pid3èg
, "", 
ödex
)))

67 
u£d
 = 0;

68 
utf8_ãxt
 = 
NULL
;

69 
«tive_ãxt
 = 
NULL
;

70 
have_utf8
 = 0;

71 
have_ãxt
 = 0;

73 if(!
	`°rcmp
(
pid3‰ame
->
id
, "YTCP"))

75 
ps⁄g
->
compû©i⁄
 = 1;

76 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "Compû©i⁄: %d [%s]\n", 
ps⁄g
->
compû©i⁄
, 
	`ba£«me
(
fûe
));

78 if(!
	`°rcmp
(
pid3‰ame
->
id
, "APIC"Ë&& !
image_size
)

80 if–(
	`°rcmp
((*)
	`id3_fõld_gëœtö1
(&
pid3‰ame
->
fõlds
[1]), "image/jpeg") == 0) ||

81 (
	`°rcmp
((*)
	`id3_fõld_gëœtö1
(&
pid3‰ame
->
fõlds
[1]), "image/jpg") == 0) ||

82 (
	`°rcmp
((*)
	`id3_fõld_gëœtö1
(&
pid3‰ame
->
fõlds
[1]), "jpeg") == 0) )

84 
image
 = 
	`id3_fõld_gëbö¨yd©a
(&
pid3‰ame
->
fõlds
[4], &
image_size
);

85 if–
image_size
 )

87 
ps⁄g
->
image
 = 
	`mÆloc
(
image_size
);

88 
	`mem˝y
(
ps⁄g
->
image
, image, 
image_size
);

89 
ps⁄g
->
image_size
 = image_size;

95 if(((
pid3‰ame
->
id
[0] ='T'Ë|| (
	`°rcmp
(pid3frame->id, "COMM") == 0)) &&

96 (
	`id3_fõld_gën°rögs
(&
pid3‰ame
->
fõlds
[1])))

97 
have_ãxt
 = 1;

99 if(
have_ãxt
)

101 
«tive_ãxt
 = 
	`id3_fõld_gë°rögs
(&
pid3‰ame
->
fõlds
[1], 0);

103 if(
«tive_ãxt
)

105 
have_utf8
 = 1;

106 if(
œng_ödex
 >= 0)

107 
utf8_ãxt
 = 
	`_gë_utf8_ãxt
(
«tive_ãxt
);

109 
utf8_ãxt
 = (*)
	`id3_ucs4_utf8du∂iˇã
(
«tive_ãxt
);

111 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TIT2"))

113 
u£d
 = 1;

114 
ps⁄g
->
tôÀ
 = (*)
utf8_ãxt
;

116 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TPE1"))

118 
u£d
 = 1;

119 
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
] = (*)
utf8_ãxt
;

121 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TALB"))

123 
u£d
 = 1;

124 
ps⁄g
->
Æbum
 = (*)
utf8_ãxt
;

126 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TCOM"))

128 
u£d
 = 1;

129 
ps⁄g
->
c⁄åibut‹
[
ROLE_COMPOSER
] = (*)
utf8_ãxt
;

131 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TIT1"))

133 
u£d
 = 1;

134 
ps⁄g
->
groupög
 = (*)
utf8_ãxt
;

136 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TPE2"))

138 
u£d
 = 1;

139 
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
] = (*)
utf8_ãxt
;

141 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TPE3"))

143 
u£d
 = 1;

144 
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
] = (*)
utf8_ãxt
;

146 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TCON"))

148 
u£d
 = 1;

149 
ps⁄g
->
gíª
 = (*)
utf8_ãxt
;

150 
gŸ_numîic_gíª
 = 0;

151 if(
ps⁄g
->
gíª
)

153 if(!
	`°æí
(
ps⁄g
->
gíª
))

155 
gíª
 = 
WINAMP_GENRE_UNKNOWN
;

156 
gŸ_numîic_gíª
 = 1;

158 if(
	`isdigô
(
ps⁄g
->
gíª
[0]))

160 
gíª
 = 
	`©oi
(
ps⁄g
->genre);

161 
gŸ_numîic_gíª
 = 1;

163 if((
ps⁄g
->
gíª
[0] ='('Ë&& (
	`isdigô
(psong->genre[1])))

165 
gíª
 = 
	`©oi
((*)&
ps⁄g
->genre[1]);

166 
gŸ_numîic_gíª
 = 1;

169 if(
gŸ_numîic_gíª
)

171 if((
gíª
 < 0Ë|| (gíª > 
WINAMP_GENRE_UNKNOWN
))

172 
gíª
 = 
WINAMP_GENRE_UNKNOWN
;

173 
	`‰ì
(
ps⁄g
->
gíª
);

174 
ps⁄g
->
gíª
 = 
	`°rdup
(
wöamp_gíª
[genre]);

178 if(!
	`°rcmp
(
pid3‰ame
->
id
, "COMM"))

180 
u£d
 = 1;

181 
ps⁄g
->
commít
 = (*)
utf8_ãxt
;

183 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TPOS"))

185 
tmp
 = (*)
utf8_ãxt
;

186 
	`°r£p
(&
tmp
, "/");

187 if(
tmp
)

189 
ps⁄g
->
tŸÆ_discs
 = 
	`©oi
(
tmp
);

191 
ps⁄g
->
disc
 = 
	`©oi
((*)
utf8_ãxt
);

193 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TRCK"))

195 
tmp
 = (*)
utf8_ãxt
;

196 
	`°r£p
(&
tmp
, "/");

197 if(
tmp
)

199 
ps⁄g
->
tŸÆ_åacks
 = 
	`©oi
(
tmp
);

201 
ps⁄g
->
åack
 = 
	`©oi
((*)
utf8_ãxt
);

203 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TDRC"))

205 
ps⁄g
->
yór
 = 
	`©oi
((*)
utf8_ãxt
);

207 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TLEN"))

209 
ps⁄g
->
s⁄g_Àngth
 = 
	`©oi
((*)
utf8_ãxt
);

211 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TBPM"))

213 
ps⁄g
->
bpm
 = 
	`©oi
((*)
utf8_ãxt
);

215 if(!
	`°rcmp
(
pid3‰ame
->
id
, "TCMP"))

217 
ps⁄g
->
compû©i⁄
 = ()
	`©oi
((*)
utf8_ãxt
);

223 if((!
u£d
Ë&& (
have_utf8
Ë&& (
utf8_ãxt
))

224 
	`‰ì
(
utf8_ãxt
);

227 if((!
	`°rcmp
(
pid3‰ame
->
id
, "COMM")Ë&& (pid3‰ame->
nfõlds
 == 4))

229 
«tive_ãxt
 = 
	`id3_fõld_gë°rög
(&
pid3‰ame
->
fõlds
[2]);

230 if(
«tive_ãxt
)

232 
utf8_ãxt
 = (*)
	`id3_ucs4_utf8du∂iˇã
(
«tive_ãxt
);

233 if((
utf8_ãxt
Ë&& (
	`°∫ˇ£cmp
((*)utf8_text, "iTun", 4) != 0))

236 
	`‰ì
(
utf8_ãxt
);

238 
«tive_ãxt
 = 
	`id3_fõld_gëfuŒ°rög
(&
pid3‰ame
->
fõlds
[3]);

239 if(
«tive_ãxt
)

241 
utf8_ãxt
 = (*)
	`id3_ucs4_utf8du∂iˇã
(
«tive_ãxt
);

242 if(
utf8_ãxt
)

244 
	`‰ì
(
ps⁄g
->
commít
);

245 
ps⁄g
->
commít
 = (*)
utf8_ãxt
;

251 
	`‰ì
(
utf8_ãxt
);

256 
ödex
++;

259 
	`id3_fûe_˛o£
(
pid3fûe
);

262 
	}
}

266 
	$_decode_mp3_‰ame
(*
‰ame
, 
mp3_‰ameöfo
 *
pfi
)

268 
vî
;

269 
œyî_ödex
;

270 
ßm∂e_ödex
;

271 
bôøã_ödex
;

272 
ßm∂î©e_ödex
;

274 if((
‰ame
[0] != 0xFF) || (frame[1] < 224))

276 
pfi
->
is_vÆid
 = 0;

280 
vî
 = (
‰ame
[1] & 0x18) >> 3;

281 
pfi
->
œyî
 = 4 - ((
‰ame
[1] & 0x6) >> 1);

283 
œyî_ödex
 = 
ßm∂e_ödex
 = -1;

285 
vî
)

288 
pfi
->
m≥g_vîsi⁄
 = 0x25;

289 
ßm∂e_ödex
 = 2;

290 if(
pfi
->
œyî
 == 1)

291 
œyî_ödex
 = 3;

292 if((
pfi
->
œyî
 == 2) || (pfi->layer == 3))

293 
œyî_ödex
 = 4;

296 
pfi
->
m≥g_vîsi⁄
 = 0x20;

297 
ßm∂e_ödex
 = 1;

298 if(
pfi
->
œyî
 == 1)

299 
œyî_ödex
 = 3;

300 if((
pfi
->
œyî
 == 2) || (pfi->layer == 3))

301 
œyî_ödex
 = 4;

304 
pfi
->
m≥g_vîsi⁄
 = 0x10;

305 
ßm∂e_ödex
 = 0;

306 if(
pfi
->
œyî
 == 1)

307 
œyî_ödex
 = 0;

308 if(
pfi
->
œyî
 == 2)

309 
œyî_ödex
 = 1;

310 if(
pfi
->
œyî
 == 3)

311 
œyî_ödex
 = 2;

315 if((
œyî_ödex
 < 0) || (layer_index > 4))

317 
pfi
->
is_vÆid
 = 0;

321 if((
ßm∂e_ödex
 < 0) || (sample_index >= 2))

323 
pfi
->
is_vÆid
 = 0;

327 if(
pfi
->
œyî
 =1Ëpfi->
ßm∂es_≥r_‰ame
 = 384;

328 if(
pfi
->
œyî
 =2Ëpfi->
ßm∂es_≥r_‰ame
 = 1152;

329 if(
pfi
->
œyî
 == 3)

331 if(
pfi
->
m≥g_vîsi⁄
 == 0x10)

332 
pfi
->
ßm∂es_≥r_‰ame
 = 1152;

334 
pfi
->
ßm∂es_≥r_‰ame
 = 576;

337 
bôøã_ödex
 = (
‰ame
[2] & 0xF0) >> 4;

338 
ßm∂î©e_ödex
 = (
‰ame
[2] & 0x0C) >> 2;

340 if((
bôøã_ödex
 == 0xF) || (bitrate_index == 0x0))

342 
pfi
->
is_vÆid
 = 0;

346 if(
ßm∂î©e_ödex
 == 3)

348 
pfi
->
is_vÆid
 = 0;

353 
pfi
->
bôøã
 = 
bôøã_tbl
[
œyî_ödex
][
bôøã_ödex
];

354 
pfi
->
ßm∂î©e
 = 
ßm∂e_øã_tbl
[
ßm∂e_ödex
][
ßm∂î©e_ödex
];

356 if((
‰ame
[3] & 0xC0 >> 6) == 3)

357 
pfi
->
°îeo
 = 0;

359 
pfi
->
°îeo
 = 1;

361 if(
‰ame
[2] & 0x02)

362 
pfi
->
∑ddög
 = 1;

364 
pfi
->
∑ddög
 = 0;

366 if(
pfi
->
m≥g_vîsi⁄
 == 0x10)

368 if(
pfi
->
°îeo
)

369 
pfi
->
xög_off£t
 = 32;

371 
pfi
->
xög_off£t
 = 17;

375 if(
pfi
->
°îeo
)

376 
pfi
->
xög_off£t
 = 17;

378 
pfi
->
xög_off£t
 = 9;

381 
pfi
->
¸c_¥Ÿe˘ed
 = 
‰ame
[1] & 0xFE;

383 if(
pfi
->
œyî
 == 1)

384 
pfi
->
‰ame_Àngth
 = (12 *Öfi->
bôøã
 * 1000 /Öfi->
ßm∂î©e
 +Öfi->
∑ddög
) * 4;

386 
pfi
->
‰ame_Àngth
 = 144 *Öfi->
bôøã
 * 1000 /Öfi->
ßm∂î©e
 +Öfi->
∑ddög
;

388 if((
pfi
->
‰ame_Àngth
 > 2880) || (pfi->frame_length <= 0))

390 
pfi
->
is_vÆid
 = 0;

394 
pfi
->
is_vÆid
 = 1;

396 
	}
}

400 
	$_mp3_gë_avîage_bôøã
(
FILE
 *
öfûe
, 
mp3_‰ameöfo
 *
pfi
, c⁄° *
‚ame
)

402 
off_t
 
fûe_size
;

403 
‰ame_buf„r
[2900];

404 
hódî
[4];

405 
ödex
 = 0;

406 
found
 = 0;

407 
off_t
 
pos
;

408 
mp3_‰ameöfo
 
fi
;

409 
‰ame_cou¡
 = 0;

410 
bôøã_tŸÆ
 = 0;

412 
	`f£ek
(
öfûe
, 0, 
SEEK_END
);

413 
fûe_size
 = 
	`·ñl
(
öfûe
);

415 
pos
 = 
fûe_size
 >> 1;

418 
	`f£ek
(
öfûe
, 
pos
, 
SEEK_SET
);

419 if(
	`‰ód
(
‰ame_buf„r
, 1, (‰ame_buf„r), 
öfûe
) != (frame_buffer))

422 !
found
)

424 (
‰ame_buf„r
[
ödex
] != 0xFF) && (index < ((frame_buffer) - 4)))

425 
ödex
++;

427 if(
ödex
 >((
‰ame_buf„r
) - 4))

429 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "CouldÇŸ föd fømêf‹ %s\n", 
	`ba£«me
((*)
‚ame
));

433 if(!
	`_decode_mp3_‰ame
(&
‰ame_buf„r
[
ödex
], &
fi
))

436 
	`f£ek
(
öfûe
, 
pos
 + 
ödex
 + 
fi
.
‰ame_Àngth
, 
SEEK_SET
);

437 if(
	`‰ód
(
hódî
, 1, (hódî), 
öfûe
) != (header))

439 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "CouldÇŸÑód fømêhódî f‹ %s\n", 
	`ba£«me
((*)
‚ame
));

443 if(!
	`_decode_mp3_‰ame
(
hódî
, &
fi
))

444 
found
 = 1;

447 if(!
found
)

448 
ödex
++;

451 
pos
 +
ödex
;

454 
‰ame_cou¡
 < 10)

456 
	`f£ek
(
öfûe
, 
pos
, 
SEEK_SET
);

457 if(
	`‰ód
(
hódî
, 1, (hódî), 
öfûe
) != (header))

459 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "CouldÇŸÑód fømêhódî f‹ %s\n", 
	`ba£«me
((*)
‚ame
));

462 if(
	`_decode_mp3_‰ame
(
hódî
, &
fi
))

464 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "InvÆid fømêhódî whûêavîagög %s\n", 
	`ba£«me
((*)
‚ame
));

468 
bôøã_tŸÆ
 +
fi
.
bôøã
;

469 
‰ame_cou¡
++;

470 
pos
 +
fi
.
‰ame_Àngth
;

473 
pfi
->
bôøã
 = 
bôøã_tŸÆ
 / 
‰ame_cou¡
;

476 
	}
}

480 
__©åibuã__
((
unu£d
))

481 
	$_mp3_gë_‰ame_cou¡
(
FILE
 *
öfûe
, 
mp3_‰ameöfo
 *
pfi
)

483 
pos
;

484 
‰ames
 = 0;

485 
‰ame_buf„r
[4];

486 
mp3_‰ameöfo
 
fi
;

487 
off_t
 
fûe_size
;

488 
îr
 = 0;

489 
cbr
 = 1;

490 
œ°_bôøã
 = 0;

492 
	`f£ek
(
öfûe
, 0, 
SEEK_END
);

493 
fûe_size
 = 
	`·ñl
(
öfûe
);

495 
pos
 = 
pfi
->
‰ame_off£t
;

499 
îr
 = 1;

501 
	`f£ek
(
öfûe
, 
pos
, 
SEEK_SET
);

502 if(
	`‰ód
(
‰ame_buf„r
, 1, (‰ame_buf„r), 
öfûe
) == (frame_buffer))

505 if(!
	`_decode_mp3_‰ame
(
‰ame_buf„r
, &
fi
))

507 
‰ames
++;

508 
pos
 +
fi
.
‰ame_Àngth
;

509 
îr
 = 0;

511 if((
œ°_bôøã
Ë&& (
fi
.
bôøã
 !=Üast_bitrate))

512 
cbr
 = 0;

513 
œ°_bôøã
 = 
fi
.
bôøã
;

516 if(
cbr
 && (
‰ames
 > 100))

518 
	`DPRINTF
(
E_DEBUG
, 
L_SCANNER
, "FileáppearsÅo be CBR... quitting frame _mp3_get_frame_count()\n");

524 if(
îr
)

526 if(
pos
 > (
fûe_size
 - 4096))

528 
pfi
->
numbî_of_‰ames
 = 
‰ames
;

533 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Frame countáborted onÉrror. Pos=%d, Count=%d\n",

534 
pos
, 
‰ames
);

539 
	}
}

543 
	$_gë_mp3fûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

545 
FILE
 *
öfûe
;

546 
id3hódî
 *
pid3
;

547 
mp3_‰ameöfo
 
fi
;

548 
size
 = 0;

549 
n_ªad
;

550 
off_t
 
Â_size
 = 0;

551 
off_t
 
fûe_size
;

552 
buf„r
[1024];

553 
ödex
;

555 
xög_Êags
;

556 
found
;

558 
fú°_check
 = 0;

559 
‰ame_buf„r
[4];

561 
id3v1èghdr
[4];

563 if(!(
öfûe
 = 
	`f›í
(
fûe
, "rb")))

565 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "CouldÇŸ o≥¿%†f‹Ñódög\n", 
fûe
);

569 
	`mem£t
((*)&
fi
, 0, (fi));

571 
	`f£ek
(
öfûe
, 0, 
SEEK_END
);

572 
fûe_size
 = 
	`·ñl
(
öfûe
);

573 
	`f£ek
(
öfûe
, 0, 
SEEK_SET
);

575 if(
	`‰ód
(
buf„r
, 1, (buf„r), 
öfûe
) != (buffer))

577 if(
	`„º‹
(
öfûe
))

579 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Eº‹Ñódög: %†[%s]\n", 
	`°ªº‹
(
î∫o
), 
fûe
);

583 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "FûêtoÿsmÆl. Probably c‹ru±ed. [%s]\n", 
fûe
);

585 
	`f˛o£
(
öfûe
);

589 
pid3
 = (
id3hódî
*)
buf„r
;

591 
found
 = 0;

592 
Â_size
 = 0;

594 if(
	`°∫cmp
((*)
pid3
->
id
, "ID3", 3) == 0)

596 
ègvîsi⁄
[16];

599 
size
 = (
pid3
->size[0] << 21 |Öid3->size[1] << 14 |

600 
pid3
->
size
[2] << 7 |Öid3->size[3]);

601 
Â_size
 = 
size
 + (
id3hódî
);

602 
fú°_check
 = 1;

604 
	`¢¥ötf
(
ègvîsi⁄
, (tagversion), "ID3v2.%d.%d",

605 
pid3
->
vîsi⁄
[0],Öid3->version[1]);

606 
ps⁄g
->
ègvîsi⁄
 = 
	`°rdup
(tagversion);

609 
ödex
 = 0;

615 !
found
)

617 
	`f£ek
(
öfûe
, 
Â_size
, 
SEEK_SET
);

618 if((
n_ªad
 = 
	`‰ód
(
buf„r
, 1, (buf„r), 
öfûe
)) < 4)

620 
	`f˛o£
(
öfûe
);

624 
ödex
 = 0;

625 !
found
)

627 (
buf„r
[
ödex
] !0xFFË&& (ödex < (
n_ªad
 - 50)))

628 
ödex
++;

630 if((
fú°_check
Ë&& (
ödex
))

632 
Â_size
 = 0;

633 
fú°_check
 = 0;

634 if(
n_ªad
 < (
buf„r
))

636 
	`f˛o£
(
öfûe
);

642 if(
ödex
 > (
n_ªad
 - 50))

644 
Â_size
 +
ödex
;

645 if(
n_ªad
 < (
buf„r
))

647 
	`f˛o£
(
öfûe
);

653 if(!
	`_decode_mp3_‰ame
(&
buf„r
[
ödex
], &
fi
))

655 if(!
	`°∫ˇ£cmp
((*)&
buf„r
[
ödex
 + 
fi
.
xög_off£t
 + 4], "XING", 4))

659 
found
 = 1;

660 
Â_size
 +
ödex
;

665 
	`f£ek
(
öfûe
, 
Â_size
 + 
ödex
 + 
fi
.
‰ame_Àngth
, 
SEEK_SET
);

666 if(
	`‰ód
(
‰ame_buf„r
, 1, (‰ame_buf„r), 
öfûe
) == (frame_buffer))

668 if(!
	`_decode_mp3_‰ame
((*)
‰ame_buf„r
, &
fi
))

670 
found
 = 1;

671 
Â_size
 +
ödex
;

676 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "CouldÇŸÑód fømêhódî: %s\n", 
fûe
);

677 
	`f˛o£
(
öfûe
);

681 if(!
found
)

684 
found
 = 1;

685 
Â_size
 +
ödex
;

690 if(!
found
)

692 
ödex
++;

693 if(
fú°_check
)

695 
	`DPRINTF
(
E_INFO
, 
L_SCANNER
, "Bad hódî... dr›pög back f‹ fuŒ fømê£¨ch [%s]\n", 
ps⁄g
->
∑th
);

696 
fú°_check
 = 0;

697 
Â_size
 = 0;

704 
fi
.
‰ame_off£t
 = 
Â_size
;

706 
ps⁄g
->
audio_off£t
 = 
Â_size
;

707 
ps⁄g
->
audio_size
 = 
fûe_size
 - 
Â_size
;

709 
	`f£ek
(
öfûe
, 
fûe_size
 - 128, 
SEEK_SET
);

710 if(
	`‰ód
(
id3v1èghdr
, 1, 4, 
öfûe
) == 4)

712 if(
id3v1èghdr
[0] == 'T' && id3v1taghdr[1] == 'A' && id3v1taghdr[2] == 'G')

714 
ps⁄g
->
audio_size
 -= 128;

718 if(
	`_decode_mp3_‰ame
(&
buf„r
[
ödex
], &
fi
))

720 
	`f˛o£
(
öfûe
);

721 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "CouldÇŸ föd syn¯‰ame: %s\n", 
fûe
);

726 
ps⁄g
->
vbr_sˇÀ
 = -1;

727 if(!
	`°∫ˇ£cmp
((*)&
buf„r
[
ödex
 + 
fi
.
xög_off£t
 + 4], "XING", 4))

729 
xög_Êags
 = 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+4] << 24 |

730 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+5] << 16 |

731 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+6] << 8 |

732 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+7];

733 
ps⁄g
->
vbr_sˇÀ
 = 78;

735 if(
xög_Êags
 & 0x1)

738 
fi
.
numbî_of_‰ames
 = 
buf„r
[
ödex
+fi.
xög_off£t
+4+8] << 24 |

739 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+9] << 16 |

740 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+10] << 8 |

741 
buf„r
[
ödex
+
fi
.
xög_off£t
+4+11];

745 if((
fi
.
numbî_of_‰ames
 =0Ë&& (!
ps⁄g
->
s⁄g_Àngth
))

747 
	`_mp3_gë_avîage_bôøã
(
öfûe
, &
fi
, 
fûe
);

750 
ps⁄g
->
bôøã
 = 
fi
.bitrate * 1000;

751 
ps⁄g
->
ßm∂î©e
 = 
fi
.samplerate;

753 if(!
ps⁄g
->
s⁄g_Àngth
)

755 if(
fi
.
numbî_of_‰ames
)

757 
ps⁄g
->
s⁄g_Àngth
 = ()(()(
fi
.
numbî_of_‰ames
 * fi.
ßm∂es_≥r_‰ame
 * 1000.) /

758 ()
fi
.
ßm∂î©e
);

759 
ps⁄g
->
vbr_sˇÀ
 = 78;

763 
ps⁄g
->
s⁄g_Àngth
 = ()(()(
fûe_size
 - 
Â_size
) * 8. /

764 ()
fi
.
bôøã
);

767 
ps⁄g
->
ch™√ls
 = 
fi
.
°îeo
 ? 2 : 1;

769 
	`f˛o£
(
öfûe
);

772 
ps⁄g
->
blockÆignmít
 = 1;

773 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "MP3");

776 
	}
}

	@tagutils/tagutils-mp3.h

24 
	smp3_‰ameöfo
 {

25 
	mœyî
;

26 
	mbôøã
;

27 
	mßm∂î©e
;

28 
	m°îeo
;

30 
	m‰ame_Àngth
;

31 
	m¸c_¥Ÿe˘ed
;

32 
	mßm∂es_≥r_‰ame
;

33 
	m∑ddög
;

34 
	mxög_off£t
;

35 
	mnumbî_of_‰ames
;

37 
	m‰ame_off£t
;

39 
	mm≥g_vîsi⁄
;

40 
	mid3_vîsi⁄
;

42 
	mis_vÆid
;

45 
_gë_mp3ègs
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

46 
_gë_mp3fûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

47 
_decode_mp3_‰ame
(*
‰ame
, 
mp3_‰ameöfo
 *
pfi
);

50 
	gbôøã_tbl
[5][16] = {

59 
	gßm∂e_øã_tbl
[3][4] = {

	@tagutils/tagutils-ogg.c

27 
	s_ogg_°ªam_¥o˚ss‹
 {

28 (*
	m¥o˚ss_∑ge
)(
	m_ogg_°ªam_¥o˚ss‹
 *, 
	mogg_∑ge
 *, 
	ms⁄g_mëad©a
 *);

29 (*
	m¥o˚ss_íd
)(
	m_ogg_°ªam_¥o˚ss‹
 *, 
	ms⁄g_mëad©a
 *);

30 
	misûÀgÆ
;

31 
	mc⁄°øöt_viﬁ©ed
;

32 
	mshownûÀgÆ
;

33 
	mi¢ew
;

34 
	m£qno
;

35 
	mlo°£q
;

37 
	m°¨t
;

38 
	míd
;

40 
	mnum
;

41 *
	mty≥
;

43 
ogg_uöt32_t
 
	m£rül
;

44 
ogg_°ªam_°©e
 
	mos
;

45 *
	md©a
;

46 } 
	togg_°ªam_¥o˚ss‹
;

49 
ogg_°ªam_¥o˚ss‹
 *
	m°ªams
;

50 
	mÆloˇãd
;

51 
	mu£d
;

53 
	mö_hódîs
;

54 } 
	togg_°ªam_£t
;

57 
v‹bis_öfo
 
	mvi
;

58 
v‹bis_commít
 
	mvc
;

60 
ogg_öt64_t
 
	mbyãs
;

61 
ogg_öt64_t
 
	mœ°gønuÀpos
;

62 
ogg_öt64_t
 
	mfú°gønuÀpos
;

64 
	md⁄ehódîs
;

65 } 
	togg_misc_v‹bis_öfo
;

67 
	#CONSTRAINT_PAGE_AFTER_EOS
 1

	)

68 
	#CONSTRAINT_MUXING_VIOLATED
 2

	)

70 
ogg_°ªam_£t
 *

71 
	$_ogg_¸óã_°ªam_£t
()

73 
ogg_°ªam_£t
 *
£t
 = 
	`ˇŒoc
(1, (ogg_stream_set));

75 
£t
->
°ªams
 = 
	`ˇŒoc
(5, (
ogg_°ªam_¥o˚ss‹
));

76 
£t
->
Æloˇãd
 = 5;

77 
£t
->
u£d
 = 0;

79  
£t
;

80 
	}
}

83 
	$_ogg_v‹bis_¥o˚ss
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
, 
ogg_∑ge
 *
∑ge
,

84 
s⁄g_mëad©a
 *
ps⁄g
)

86 
ogg_∑ckë
 
∑ckë
;

87 
ogg_misc_v‹bis_öfo
 *
öf
 = 
°ªam
->
d©a
;

88 
i
, 
hódî
 = 0;

90 
	`ogg_°ªam_∑geö
(&
°ªam
->
os
, 
∑ge
);

91 if(
öf
->
d⁄ehódîs
 < 3)

92 
hódî
 = 1;

94 
	`ogg_°ªam_∑ckëout
(&
°ªam
->
os
, &
∑ckë
) > 0)

96 if(
öf
->
d⁄ehódîs
 < 3)

98 if(
	`v‹bis_sy¡hesis_hódîö
(&
öf
->
vi
, &öf->
vc
, &
∑ckë
) < 0)

100 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "CouldÇot decode vorbis header "

101 "∑ckë - invÆid v‹bi†°ªam (%d)\n", 
°ªam
->
num
);

104 
öf
->
d⁄ehódîs
++;

105 if(
öf
->
d⁄ehódîs
 == 3)

107 if(
	`ogg_∑ge_gønuÀpos
(
∑ge
Ë!0 || 
	`ogg_°ªam_∑ckë≥ek
(&
°ªam
->
os
, 
NULL
) == 1)

108 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Nÿhódî i¿v‹bi†°ªam %d\n", 
°ªam
->
num
);

109 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Vorbis headersÖarsed for stream %d, "

110 "öf‹m©i⁄ fﬁlows...\n", 
°ªam
->
num
);

111 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Ch™√ls: %d\n", 
öf
->
vi
.
ch™√ls
);

112 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "R©e: %ld\n\n", 
öf
->
vi
.
øã
);

114 
ps⁄g
->
ßm∂î©e
 = 
öf
->
vi
.
øã
;

115 
ps⁄g
->
ch™√ls
 = 
öf
->
vi
.channels;

117 if(
öf
->
vi
.
bôøã_nomöÆ
 > 0)

119 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Nominal bitrate: %f kb/s\n",

120 ()
öf
->
vi
.
bôøã_nomöÆ
 / 1000.0);

121 
ps⁄g
->
bôøã
 = 
öf
->
vi
.
bôøã_nomöÆ
 / 1000;

125 
uµî_øã
, 
lowî_øã
;

127 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Nominal bitrateÇot set\n");

130 
uµî_øã
 = 0;

131 
lowî_øã
 = 0;

133 if(
öf
->
vi
.
bôøã_uµî
 > 0)

135 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Upper bitrate: %f kb/s\n",

136 ()
öf
->
vi
.
bôøã_uµî
 / 1000.0);

137 
uµî_øã
 = 
öf
->
vi
.
bôøã_uµî
;

141 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Upper bitrateÇot set\n");

144 if(
öf
->
vi
.
bôøã_lowî
 > 0)

146 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Lower bitrate: %f kb/s\n",

147 ()
öf
->
vi
.
bôøã_lowî
 / 1000.0);

148 
lowî_øã
 = 
öf
->
vi
.
bôøã_lowî
;;

152 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Lower bitrateÇot set\n");

155 if(
uµî_øã
 && 
lowî_øã
)

157 
ps⁄g
->
bôøã
 = (
uµî_øã
 + 
lowî_øã
) / 2;

161 
ps⁄g
->
bôøã
 = 
uµî_øã
 + 
lowî_øã
;

165 if(
öf
->
vc
.
commíts
 > 0)

166 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
,

169 
i
 = 0; i < 
öf
->
vc
.
commíts
; i++)

171 
	`vc_sˇn
(
ps⁄g
, 
öf
->
vc
.
u£r_commíts
[
i
], inf->vc.
commít_Àngths
[i]);

177 if(!
hódî
)

179 
ogg_öt64_t
 
gp
 = 
	`ogg_∑ge_gønuÀpos
(
∑ge
);

180 if(
gp
 > 0)

182 if(
gp
 < 
öf
->
œ°gønuÀpos
)

183 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "granulepos in stream %d decreases from %lldÅo %lld",

184 
°ªam
->
num
, 
öf
->
œ°gønuÀpos
, 
gp
);

185 
öf
->
œ°gønuÀpos
 = 
gp
;

189 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Malformed vorbis strem.\n");

191 
öf
->
byãs
 +
∑ge
->
hódî_Àn
 +Öage->
body_Àn
;

193 
	}
}

196 
	$_ogg_v‹bis_íd
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
, 
s⁄g_mëad©a
 *
ps⁄g
)

198 
ogg_misc_v‹bis_öfo
 *
öf
 = 
°ªam
->
d©a
;

199 
bôøã
, 
time
;

201 
time
 = ()
öf
->
œ°gønuÀpos
 / inf->
vi
.
øã
;

202 
bôøã
 = 
öf
->
byãs
 * 8 / 
time
 / 1000;

204 if(
ps⁄g
 !
NULL
)

206 if(
ps⁄g
->
bôøã
 <= 0)

208 
ps⁄g
->
bôøã
 = bitrate * 1000;

210 
ps⁄g
->
s⁄g_Àngth
 = 
time
 * 1000;

213 
	`v‹bis_commít_˛ór
(&
öf
->
vc
);

214 
	`v‹bis_öfo_˛ór
(&
öf
->
vi
);

216 
	`‰ì
(
°ªam
->
d©a
);

217 
	}
}

220 
	$_ogg_¥o˚ss_nuŒ
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
, 
ogg_∑ge
 *
∑ge
, 
s⁄g_mëad©a
 *
ps⁄g
)

223 
	}
}

226 
	$_ogg_¥o˚ss_Ÿhî
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
, 
ogg_∑ge
 *
∑ge
, 
s⁄g_mëad©a
 *
ps⁄g
)

228 
	`ogg_°ªam_∑geö
(&
°ªam
->
os
, 
∑ge
);

229 
	}
}

232 
	$_ogg_‰ì_°ªam_£t
(
ogg_°ªam_£t
 *
£t
)

234 
i
;

236 
i
 = 0; i < 
£t
->
u£d
; i++)

238 if(!
£t
->
°ªams
[
i
].
íd
)

241 if(
£t
->
°ªams
[
i
].
¥o˚ss_íd
)

242 
£t
->
°ªams
[
i
].
	`¥o˚ss_íd
(&£t->°ªams[i], 
NULL
);

244 
	`ogg_°ªam_˛ór
(&
£t
->
°ªams
[
i
].
os
);

247 
	`‰ì
(
£t
->
°ªams
);

248 
	`‰ì
(
£t
);

249 
	}
}

252 
	$_ogg_°ªams_›í
(
ogg_°ªam_£t
 *
£t
)

254 
i
;

255 
ªs
 = 0;

257 
i
 = 0; i < 
£t
->
u£d
; i++)

259 if(!
£t
->
°ªams
[
i
].
íd
)

260 
ªs
++;

263  
ªs
;

264 
	}
}

267 
	$_ogg_nuŒ_°¨t
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
)

269 
°ªam
->
¥o˚ss_íd
 = 
NULL
;

270 
°ªam
->
ty≥
 = "invalid";

271 
°ªam
->
¥o˚ss_∑ge
 = 
_ogg_¥o˚ss_nuŒ
;

272 
	}
}

275 
	$_ogg_Ÿhî_°¨t
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
, *
ty≥
)

277 if(
ty≥
)

278 
°ªam
->
ty≥
 =Åype;

280 
°ªam
->
ty≥
 = "unknown";

281 
°ªam
->
¥o˚ss_∑ge
 = 
_ogg_¥o˚ss_Ÿhî
;

282 
°ªam
->
¥o˚ss_íd
 = 
NULL
;

283 
	}
}

286 
	$_ogg_v‹bis_°¨t
(
ogg_°ªam_¥o˚ss‹
 *
°ªam
)

288 
ogg_misc_v‹bis_öfo
 *
öfo
;

290 
°ªam
->
ty≥
 = "vorbis";

291 
°ªam
->
¥o˚ss_∑ge
 = 
_ogg_v‹bis_¥o˚ss
;

292 
°ªam
->
¥o˚ss_íd
 = 
_ogg_v‹bis_íd
;

294 
°ªam
->
d©a
 = 
	`ˇŒoc
(1, (
ogg_misc_v‹bis_öfo
));

296 
öfo
 = 
°ªam
->
d©a
;

298 
	`v‹bis_commít_öô
(&
öfo
->
vc
);

299 
	`v‹bis_öfo_öô
(&
öfo
->
vi
);

300 
	}
}

302 
ogg_°ªam_¥o˚ss‹
 *

303 
	$_ogg_föd_°ªam_¥o˚ss‹
(
ogg_°ªam_£t
 *
£t
, 
ogg_∑ge
 *
∑ge
)

305 
ogg_uöt32_t
 
£rül
 = 
	`ogg_∑ge_£rü o
(
∑ge
);

306 
i
;

307 
övÆid
 = 0;

308 
c⁄°øöt
 = 0;

309 
ogg_°ªam_¥o˚ss‹
 *
°ªam
;

311 
i
 = 0; i < 
£t
->
u£d
; i++)

313 if(
£rül
 =
£t
->
°ªams
[
i
].serial)

315 
°ªam
 = &(
£t
->
°ªams
[
i
]);

317 
£t
->
ö_hódîs
 = 0;

319 if(
°ªam
->
íd
)

321 
°ªam
->
isûÀgÆ
 = 1;

322 
°ªam
->
c⁄°øöt_viﬁ©ed
 = 
CONSTRAINT_PAGE_AFTER_EOS
;

323  
°ªam
;

326 
°ªam
->
i¢ew
 = 0;

327 
°ªam
->
°¨t
 = 
	`ogg_∑ge_bos
(
∑ge
);

328 
°ªam
->
íd
 = 
	`ogg_∑ge_eos
(
∑ge
);

329 
°ªam
->
£rül
 = serial;

330  
°ªam
;

333 if(
	`_ogg_°ªams_›í
(
£t
Ë&& !£t->
ö_hódîs
)

335 
c⁄°øöt
 = 
CONSTRAINT_MUXING_VIOLATED
;

336 
övÆid
 = 1;

339 
£t
->
ö_hódîs
 = 1;

341 if(
£t
->
Æloˇãd
 < së->
u£d
)

342 
°ªam
 = &
£t
->
°ªams
[£t->
u£d
];

345 
£t
->
Æloˇãd
 += 5;

346 
£t
->
°ªams
 = 
	`ªÆloc
(£t->°ªams, (
ogg_°ªam_¥o˚ss‹
Ë* së->
Æloˇãd
);

347 
°ªam
 = &
£t
->
°ªams
[£t->
u£d
];

349 
£t
->
u£d
++;

350 
°ªam
->
num
 = 
£t
->
u£d
;

352 
°ªam
->
i¢ew
 = 1;

353 
°ªam
->
isûÀgÆ
 = 
övÆid
;

354 
°ªam
->
c⁄°øöt_viﬁ©ed
 = 
c⁄°øöt
;

357 
ªs
;

358 
ogg_∑ckë
 
∑ckë
;

360 
	`ogg_°ªam_öô
(&
°ªam
->
os
, 
£rül
);

361 
	`ogg_°ªam_∑geö
(&
°ªam
->
os
, 
∑ge
);

362 
ªs
 = 
	`ogg_°ªam_∑ckëout
(&
°ªam
->
os
, &
∑ckë
);

363 if(
ªs
 <= 0)

365 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Invalid headerÖage,ÇoÖacket found\n");

366 
	`_ogg_nuŒ_°¨t
(
°ªam
);

368 if(
∑ckë
.
byãs
 >7 && 
	`memcmp
(packet.packet, "\001vorbis", 7) == 0)

369 
	`_ogg_v‹bis_°¨t
(
°ªam
);

370 if(
∑ckë
.
byãs
 >8 && 
	`memcmp
(packet.packet, "OggMIDI\0", 8) == 0)

371 
	`_ogg_Ÿhî_°¨t
(
°ªam
, "MIDI");

373 
	`_ogg_Ÿhî_°¨t
(
°ªam
, 
NULL
);

375 
ªs
 = 
	`ogg_°ªam_∑ckëout
(&
°ªam
->
os
, &
∑ckë
);

376 if(
ªs
 > 0)

378 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Invalid headerÖage in stream %d, "

379 "c⁄èö†mu…ùÀÖackës\n", 
°ªam
->
num
);

383 
	`ogg_°ªam_˛ór
(&
°ªam
->
os
);

384 
	`ogg_°ªam_öô
(&
°ªam
->
os
, 
£rül
);

387 
°ªam
->
°¨t
 = 
	`ogg_∑ge_bos
(
∑ge
);

388 
°ªam
->
íd
 = 
	`ogg_∑ge_eos
(
∑ge
);

389 
°ªam
->
£rül
 = serial;

391  
°ªam
;

392 
	}
}

395 
	$_ogg_gë_√xt_∑ge
(
FILE
 *
f
, 
ogg_sync_°©e
 *
sync
, 
ogg_∑ge
 *
∑ge
,

396 
ogg_öt64_t
 *
wrôãn
)

398 
ªt
;

399 *
buf„r
;

400 
byãs
;

402 (
ªt
 = 
	`ogg_sync_∑geout
(
sync
, 
∑ge
)) <= 0)

404 if(
ªt
 < 0)

405 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Hﬁêö d©®foundáà≠¥oxim©êoff£à%Œd byãs. C‹ru±ed ogg.\n", *
wrôãn
);

407 
buf„r
 = 
	`ogg_sync_buf„r
(
sync
, 4500);

408 
byãs
 = 
	`‰ód
(
buf„r
, 1, 4500, 
f
);

409 if(
byãs
 <= 0)

411 
	`ogg_sync_wrŸe
(
sync
, 0);

414 
	`ogg_sync_wrŸe
(
sync
, 
byãs
);

415 *
wrôãn
 +
byãs
;

419 
	}
}

423 
	$_gë_oggfûeöfo
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

425 
FILE
 *
fûe
 = 
	`f›í
(
fûíame
, "rb");

426 
ogg_sync_°©e
 
sync
;

427 
ogg_∑ge
 
∑ge
;

428 
ogg_°ªam_£t
 *
¥o˚ss‹s
 = 
	`_ogg_¸óã_°ªam_£t
();

429 
gŸ∑ge
 = 0;

430 
ogg_öt64_t
 
wrôãn
 = 0;

432 if(!
fûe
)

434 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
,

435 "Eº‹ o≥nög i≈uàfûê\"%s\": %s\n", 
fûíame
, 
	`°ªº‹
(
î∫o
));

436 
	`_ogg_‰ì_°ªam_£t
(
¥o˚ss‹s
);

440 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Pro˚ssög fûê\"%s\"...\n\n", 
fûíame
);

442 
	`ogg_sync_öô
(&
sync
);

444 
	`_ogg_gë_√xt_∑ge
(
fûe
, &
sync
, &
∑ge
, &
wrôãn
))

446 
ogg_°ªam_¥o˚ss‹
 *
p
 = 
	`_ogg_föd_°ªam_¥o˚ss‹
(
¥o˚ss‹s
, &
∑ge
);

447 
gŸ∑ge
 = 1;

449 if(!
p
)

451 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
, "CouldÇot findáÖrocessor for stream, bailing\n");

452 
	`_ogg_‰ì_°ªam_£t
(
¥o˚ss‹s
);

453 
	`f˛o£
(
fûe
);

457 if(
p
->
isûÀgÆ
 && !p->
shownûÀgÆ
)

459 *
c⁄°øöt
;

460 
p
->
c⁄°øöt_viﬁ©ed
)

462 
CONSTRAINT_PAGE_AFTER_EOS
:

463 
c⁄°øöt
 = "Page found for streamáfter EOS flag";

465 
CONSTRAINT_MUXING_VIOLATED
:

466 
c⁄°øöt
 = "Ogg muxing constraints violated,Çew "

470 
c⁄°øöt
 = "Error unknown.";

473 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
,

476 
p
->
num
, 
c⁄°øöt
);

477 
p
->
shownûÀgÆ
 = 1;

479 if(!
p
->
i¢ew
)

483 if(
p
->
i¢ew
)

485 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "NewÜogical stream (#%d, serial: %08x):Åype %s\n",

486 
p
->
num
,Ö->
£rül
,Ö->
ty≥
);

487 if(!
p
->
°¨t
)

488 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
,

490 
p
->
num
);

492 if(
p
->
°¨t
)

493 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "stream start flag found in mid-stream "

494 "⁄ såóm %d\n", 
p
->
num
);

496 if(
p
->
£qno
++ !
	`ogg_∑ge_∑gío
(&
∑ge
))

498 if(!
p
->
lo°£q
)

499 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
,

502 
p
->
num
, 
	`ogg_∑ge_∑gío
(&
∑ge
),Ö->
£qno
 - 1);

503 
p
->
£qno
 = 
	`ogg_∑ge_∑gío
(&
∑ge
);

504 
p
->
lo°£q
 = 1;

507 
p
->
lo°£q
 = 0;

509 if(!
p
->
isûÀgÆ
)

511 
p
->
	`¥o˚ss_∑ge
’, &
∑ge
, 
ps⁄g
);

513 if(
p
->
íd
)

515 if(
p
->
¥o˚ss_íd
)

516 
p
->
	`¥o˚ss_íd
’, 
ps⁄g
);

517 
	`DPRINTF
(
E_MAXDEBUG
, 
L_SCANNER
, "Logiˇ»°ªam %dÉnded\n", 
p
->
num
);

518 
p
->
isûÀgÆ
 = 1;

519 
p
->
c⁄°øöt_viﬁ©ed
 = 
CONSTRAINT_PAGE_AFTER_EOS
;

524 
	`_ogg_‰ì_°ªam_£t
(
¥o˚ss‹s
);

526 
	`ogg_sync_˛ór
(&
sync
);

528 
	`f˛o£
(
fûe
);

530 if(!
gŸ∑ge
)

532 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Nÿogg d©®found i¿fûê\"%s\".\n", 
fûíame
);

537 
	}
}

	@tagutils/tagutils-ogg.h

23 
_gë_oggfûeöfo
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
);

	@tagutils/tagutils-pcm.c

25 
	$_gë_pcmfûeöfo
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

27 
°©
 
fûe
;

28 
uöt32_t
 
£c
, 
ms
;

30 if–
	`°©
(
fûíame
, &
fûe
) != 0 )

32 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "CouldÇŸ sèà%s\n", 
fûíame
);

36 
ps⁄g
->
fûe_size
 = 
fûe
.
°_size
;

37 
ps⁄g
->
bôøã
 = 1411200;

38 
ps⁄g
->
ßm∂î©e
 = 44100;

39 
ps⁄g
->
ch™√ls
 = 2;

40 
£c
 = 
ps⁄g
->
fûe_size
 / (ps⁄g->
bôøã
 / 8);

41 
ms
 = ((
ps⁄g
->
fûe_size
 % (ps⁄g->
bôøã
 / 8)) * 1000) / (psong->bitrate / 8);

42 
ps⁄g
->
s⁄g_Àngth
 = (
£c
 * 1000Ë+ 
ms
;

43 
ps⁄g
->
los¶ess
 = 1;

45 
	`xa•rötf
(&(
ps⁄g
->
mime
), "audio/L16;øã=%d;ch™√ls=%d",Ös⁄g->
ßm∂î©e
,Ös⁄g->
ch™√ls
);

46 
	`xa•rötf
(&(
ps⁄g
->
d a_≤
), "LPCM");

49 
	}
}

	@tagutils/tagutils-pcm.h

21 
_gë_pcmfûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

	@tagutils/tagutils-plist.c

23 
	~<°dio.h
>

24 
	~<°rög.h
>

25 
	~<˘y≥.h
>

27 
	~"misc.h
"

28 
	~"ègutûs.h
"

29 
	~"ãxtutûs.h
"

30 
	~"log.h
"

33 
	#MAX_BUF
 4096

	)

35 
FILE
 *
	gÂ
 = 0;

36 
	g_utf8bom
 = 0;

37 
	g_åackno
;

39 (*
_√xt_åack
)(
s⁄g_mëad©a
*, 
°©
*, *, *);

40 
	`_m3u_∂s_√xt_åack
(
s⁄g_mëad©a
*, 
°©
*, *, *);

43 
	$°¨t_∂i°
(c⁄° *
∑th
, 
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
)

45 *
‚ame
, *
suffix
;

47 
_√xt_åack
 = 0;

48 
_utf8bom
 = 0;

49 
_åackno
 = 0;

51 if(
	`°rˇ£cmp
(
ty≥
, "m3u") == 0)

52 
_√xt_åack
 = 
_m3u_∂s_√xt_åack
;

53 if(
	`°rˇ£cmp
(
ty≥
, "pls") == 0)

54 
_√xt_åack
 = 
_m3u_∂s_√xt_åack
;

56 if(!
_√xt_åack
)

58 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "Unsuµ‹ãdÖœyli°Åy≥ <%s> (%s)\n", 
ty≥
, 
∑th
);

62 if(!(
Â
 = 
	`f›í
(
∑th
, "rb")))

64 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸ o≥¿%s\n", 
∑th
);

68 if(!
ps⁄g
)

71 
	`mem£t
((*)
ps⁄g
, 0, (
s⁄g_mëad©a
));

72 
ps⁄g
->
is_∂i°
 = 1;

73 
ps⁄g
->
∑th
 = 
	`°rdup
(path);

74 
ps⁄g
->
ty≥
 =Åype;

76 
‚ame
 = 
	`°ºchr
(
ps⁄g
->
∑th
, '/');

77 
ps⁄g
->
ba£«me
 = 
‚ame
 ? f«mê+ 1 :Ös⁄g->
∑th
;

79 
ps⁄g
->
tôÀ
 = 
	`°rdup
’s⁄g->
ba£«me
);

80 
suffix
 = 
	`°ºchr
(
ps⁄g
->
tôÀ
, '.');

81 if(
suffix
) *suffix = '\0';

83 if(
°©
)

85 if(!
ps⁄g
->
time_modifõd
)

86 
ps⁄g
->
time_modifõd
 = 
°©
->
°_mtime
;

87 
ps⁄g
->
fûe_size
 = 
°©
->
°_size
;

91 
	}
}

94 
	$_m3u_∂s_√xt_åack
(
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
)

96 
buf
[
MAX_BUF
], *
p
;

97 
Àn
;

99 
	`mem£t
((*)
ps⁄g
, 0, (
s⁄g_mëad©a
));

102 
p
 = 
	`fgës
(
buf
, 
MAX_BUF
, 
Â
);

103 if(!
p
)

105 
	`f˛o£
(
Â
);

109 if(
	`°rˇ£cmp
(
ty≥
, "m3u") == 0)

112 if(!
_utf8bom
 && 
p
[0] == '\xef' &&Ö[1] == '\xbb' &&Ö[2] == '\xbf')

114 
_utf8bom
 = 1;

115 
p
 += 3;

119 
p
)

121 
	`is•a˚
(*
p
))Ö++;

123 if(!(*
p
) || *p == '#')

124 
√xt_löe
;

126 if(!
	`i•röt
(*
p
))

128 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "PlaylistÜooks bad (unprintable characters)\n");

129 
	`f˛o£
(
Â
);

133 if(
	`°rˇ£cmp
(
ty≥
, "pls") == 0)

136 if(!
_åackno
)

138 if(
	`°∫cmp
(
p
, "[playlist]", 10))

140 
_åackno
++;

141 
√xt_löe
;

144 if(
	`°∫cmp
(
p
, "File", 4) != 0)

145 
√xt_löe
;

147 
ps⁄g
->
åack
 = 
	`°πﬁ
(
p
+4, &p, 10);

148 if(!
ps⁄g
->
åack
 || !
p
++)

149 
√xt_löe
;

150 
_åackno
 = 
ps⁄g
->
åack
;

152 if(
	`°rˇ£cmp
(
ty≥
, "m3u") == 0)

153 
ps⁄g
->
åack
 = ++
_åackno
;

155 
Àn
 = 
	`°æí
(
p
);

156 
p
[
Àn
-1] == '\r' ||Ö[len-1] == '\n')

157 
p
[--
Àn
] = '\0';

158 
ps⁄g
->
∑th
 = 
	`°rdup
(
p
);

160 
√xt_löe
:

161 
p
 = 
	`fgës
(
buf
, 
MAX_BUF
, 
Â
);

164 
	`f˛o£
(
Â
);

166 
	}
}

169 
	$√xt_∂i°_åack
(
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
)

171 if(
_√xt_åack
)

172  
	`_√xt_åack
(
ps⁄g
, 
°©
, 
œng
, 
ty≥
);

174 
	}
}

	@tagutils/tagutils-wav.c

24 
	#GET_WAV_INT32
(
p
Ë((((
uöt8_t
)((p)[3])) << 24) | \

25 (((
uöt8_t
)((
p
)[2])) << 16) | \

26 (((
uöt8_t
)((
p
)[1])) << 8) | \

27 (((
uöt8_t
)((
p
)[0]))))

	)

29 
	#GET_WAV_INT16
(
p
Ë((((
uöt8_t
)((p)[1])) << 8) | \

30 (((
uöt8_t
)((
p
)[0]))))

	)

33 
	$_gë_wavègs
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

35 
fd
;

36 
uöt32_t
 
Àn
;

37 
hdr
[12];

38 
fmt
[16];

40 
uöt32_t
 
f‹m©_d©a_Àngth
 = 0;

41 
uöt32_t
 
com¥essi⁄_code
 = 0;

42 
uöt32_t
 
ch™√l_cou¡
 = 0;

43 
uöt32_t
 
ßm∂e_øã
 = 0;

44 
uöt32_t
 
ßm∂e_bô_Àngth
 = 0;

45 
uöt32_t
 
bô_øã
;

46 
uöt32_t
 
d©a_Àngth
 = 0;

47 
uöt32_t
 
£c
, 
ms
;

49 
uöt32_t
 
cuºít_off£t
;

50 
uöt32_t
 
block_Àn
;

54 if(!(
fd
 = 
	`›í
(
fûíame
, 
O_RDONLY
)))

56 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "CouldÇot create file handle\n");

60 
Àn
 = 12;

61 if(!(
Àn
 = 
	`ªad
(
fd
, 
hdr
,Üen)) || (len != 12))

63 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "CouldÇŸÑód wav hódî from %s\n", 
fûíame
);

64 
	`˛o£
(
fd
);

70 if(
	`°∫cmp
((*)
hdr
 + 0, "RIFF", 4) ||

71 
	`°∫cmp
((*)
hdr
 + 8, "WAVE", 4))

73 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "InvÆid wav hódî i¿%s\n", 
fûíame
);

74 
	`˛o£
(
fd
);

81 
cuºít_off£t
 = 12;

82 
cuºít_off£t
 + 8 < 
ps⁄g
->
fûe_size
)

84 
Àn
 = 8;

85 if(!(
Àn
 = 
	`ªad
(
fd
, 
hdr
,Üen)) || (len != 8))

87 
	`˛o£
(
fd
);

88 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Eº‹Ñódög block: %s\n", 
fûíame
);

92 
cuºít_off£t
 += 8;

93 
block_Àn
 = 
	`GET_WAV_INT32
(
hdr
 + 4);

103 if(
block_Àn
 < 0)

105 
	`˛o£
(
fd
);

106 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Bad blockÜí: %s\n", 
fûíame
);

110 if(
	`°∫cmp
((*)&
hdr
, "fmt ", 4) == 0)

113 
Àn
 = 16;

114 if(!
	`ªad
(
fd
, 
fmt
, 
Àn
) || (len != 16))

116 
	`˛o£
(
fd
);

117 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "Bad .wav file: can'tÑead fmt: %s\n",

118 
fûíame
);

122 
f‹m©_d©a_Àngth
 = 
block_Àn
;

123 
com¥essi⁄_code
 = 
	`GET_WAV_INT16
(
fmt
);

124 
ch™√l_cou¡
 = 
	`GET_WAV_INT16
(
fmt
 + 2);

125 
ßm∂e_øã
 = 
	`GET_WAV_INT32
(
fmt
 + 4);

126 
ßm∂e_bô_Àngth
 = 
	`GET_WAV_INT16
(
fmt
 + 14);

133 if(
	`°∫cmp
((*)&
hdr
, "data", 4) == 0)

136 
d©a_Àngth
 = 
block_Àn
;

137 
√xt_block
;

139 if(
	`°∫cmp
((*)&
hdr
, "LIST", 4) == 0)

141 *
ègs
;

142 *
p
;

143 
off
;

144 
uöt32_t
 
ègÀn
;

145 **
m
;

147 
Àn
 = 
	`GET_WAV_INT32
(
hdr
 + 4);

148 if(
Àn
 > 65536 ||Üen < 9)

149 
√xt_block
;

151 
ègs
 = 
	`mÆloc
(
Àn
+1);

152 if(!
ègs
)

153 
√xt_block
;

155 if(
	`ªad
(
fd
, 
ègs
, 
Àn
) <Üen ||

156 
	`°∫cmp
(
ègs
, "INFO", 4) != 0)

158 
	`‰ì
(
ègs
);

159 
√xt_block
;

161 
ègs
[
Àn
] = '\0';

163 
off
 = 4;

164 
p
 = 
ègs
 + 
off
;

165 
off
 < 
Àn
 - 8)

167 
ègÀn
 = 
	`GET_WAV_INT32
(
p
 + 4);

170 
m
 = 
NULL
;

171 i‡(
ègÀn
 > 2048) {

172 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "IgnoringÜongÅag [%.*s] in %s\n",

173 4, 
p
+8, 
fûíame
);

175 if(
	`°∫cmp
(
p
, "INAM", 4) == 0)

176 
m
 = &(
ps⁄g
->
tôÀ
);

177 if(
	`°∫cmp
(
p
, "IALB", 4) == 0 ||

178 
	`°∫cmp
(
p
, "IPRD", 4) == 0)

179 
m
 = &(
ps⁄g
->
Æbum
);

180 if(
	`°∫cmp
(
p
, "IGRE", 4) == 0 ||

181 
	`°∫cmp
(
p
, "IGNR", 4) == 0)

182 
m
 = &(
ps⁄g
->
gíª
);

183 if(
	`°∫cmp
(
p
, "ICMT", 4) == 0)

184 
m
 = &(
ps⁄g
->
commít
);

185 if(
	`°∫cmp
(
p
, "IART", 4) == 0)

186 
m
 = &(
ps⁄g
->
c⁄åibut‹
[
ROLE_TRACKARTIST
]);

187 if(
	`°∫cmp
(
p
, "IAAR", 4) == 0)

188 
m
 = &(
ps⁄g
->
c⁄åibut‹
[
ROLE_ALBUMARTIST
]);

189 if(
	`°∫cmp
(
p
, "ICOM", 4) == 0 ||

190 
	`°∫cmp
(
p
, "IMUS", 4) == 0)

191 
m
 = &(
ps⁄g
->
c⁄åibut‹
[
ROLE_COMPOSER
]);

192 if(
	`°∫ˇ£cmp
(
p
, "ITRK", 4) == 0)

193 
ps⁄g
->
åack
 = 
	`©oi
(
p
 + 8);

194 if(
	`°∫cmp
(
p
, "ICRD", 4) == 0 ||

195 
	`°∫cmp
(
p
, "IYER", 4) == 0)

196 
ps⁄g
->
yór
 = 
	`©oi
(
p
 + 8);

197 if(
m
)

199 *
m
 = 
	`mÆloc
(
ègÀn
 + 1);

200 
	`°∫˝y
(*
m
, 
p
 + 8, 
ègÀn
);

201 (*
m
)[
ègÀn
] = '\0';

204 
p
 +
ègÀn
 + 8;

205 
off
 +
ègÀn
 + 8;

207 *
p
 ='\0' && 
off
 < 
Àn
) {

208 
p
++;

209 
off
++;

212 
	`‰ì
(
ègs
);

214 
√xt_block
:

215 
	`l£ek
(
fd
, 
cuºít_off£t
 + 
block_Àn
, 
SEEK_SET
);

216 
cuºít_off£t
 +
block_Àn
;

218 
	`˛o£
(
fd
);

220 if(((
f‹m©_d©a_Àngth
 != 16) && (format_data_length != 18)) ||

221 (
com¥essi⁄_code
 != 1) ||

222 (
ch™√l_cou¡
 < 1))

224 
	`DPRINTF
(
E_WARN
, 
L_SCANNER
, "InvÆid wav hódî i¿%s\n", 
fûíame
);

228 if–!
d©a_Àngth
 )

229 
d©a_Àngth
 = 
ps⁄g
->
fûe_size
 - 44;

231 
bô_øã
 = 
ßm∂e_øã
 * 
ch™√l_cou¡
 * ((
ßm∂e_bô_Àngth
 + 7) / 8) * 8;

232 
ps⁄g
->
bôøã
 = 
bô_øã
;

233 
ps⁄g
->
ßm∂î©e
 = 
ßm∂e_øã
;

234 
ps⁄g
->
ch™√ls
 = 
ch™√l_cou¡
;

236 
£c
 = 
d©a_Àngth
 / (
bô_øã
 / 8);

237 
ms
 = ((
d©a_Àngth
 % (
bô_øã
 / 8)) * 1000) / (bit_rate / 8);

238 
ps⁄g
->
s⁄g_Àngth
 = (
£c
 * 1000Ë+ 
ms
;

247 
	}
}

250 
	$_gë_wavfûeöfo
(*
fûíame
, 
s⁄g_mëad©a
 *
ps⁄g
)

252 
ps⁄g
->
los¶ess
 = 1;

258 
	}
}

	@tagutils/tagutils-wav.h

22 
_gë_wavfûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

23 
_gë_wavègs
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

	@tagutils/tagutils.c

24 
	~<˘y≥.h
>

25 
	~<î∫o.h
>

26 
	~<id3èg.h
>

27 
	~<°dlib.h
>

28 
	~<°ddef.h
>

29 
	~<°rög.h
>

30 
	~<f˙é.h
>

31 
	~<uni°d.h
>

32 
	~<time.h
>

33 
	~<sys/time.h
>

34 
	~<√töë/ö.h
>

35 
	~<ogg/ogg.h
>

36 
	~<v‹bis/codec.h
>

37 
	~<FLAC/mëad©a.h
>

39 
	~"c⁄fig.h
"

40 #ifde‡
HAVE_ICONV


41 
	~<ic⁄v.h
>

44 
	~<sqlôe3.h
>

45 
	~"ègutûs.h
"

46 
	~"misc.h
"

47 
	~"ãxtutûs.h
"

48 
	~"../mëad©a.h
"

49 
	~"../utûs.h
"

50 
	~"../log.h
"

52 
	sid3hódî
 {

53 
	mid
[3];

54 
	mvîsi⁄
[2];

55 
	mÊags
;

56 
	msize
[4];

57 } 
__©åibuã
((
∑cked
));

59 *
	gwöamp_gíª
[] = {

100 
	#WINAMP_GENRE_UNKNOWN
 (((
wöamp_gíª
Ë/ (wöamp_gíª[0])Ë- 1)

	)

106 
	~"ègutûs-mp3.h
"

107 
	~"ègutûs-Øc.h
"

108 
	~"ègutûs-ogg.h
"

109 
	~"ègutûs-Êc.h
"

110 
	~"ègutûs-asf.h
"

111 
	~"ègutûs-wav.h
"

112 
	~"ègutûs-pcm.h
"

114 
_gë_ègs
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

115 
_gë_fûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
);

123 * 
	mty≥
;

124 (*
	mgë_ègs
)(* 
	mfûe
, 
s⁄g_mëad©a
* 
	mps⁄g
);

125 (*
	mgë_fûeöfo
)(* 
	mfûe
, 
s⁄g_mëad©a
* 
	mps⁄g
);

126 } 
	tègh™dÀr
;

128 
ègh™dÀr
 
	gègh™dÀrs
[] = {

129 { "Øc", 
_gë_Ø˘ags
, 
_gë_Øcfûeöfo
 },

130 { "mp3", 
_gë_mp3ègs
, 
_gë_mp3fûeöfo
 },

131 { "Êc", 
_gë_Ê˘ags
, 
_gë_Êcfûeöfo
 },

132 { "ogg", 0, 
_gë_oggfûeöfo
 },

133 { "asf", 0, 
_gë_asffûeöfo
 },

134 { "wav", 
_gë_wavègs
, 
_gë_wavfûeöfo
 },

135 { "pcm", 0, 
_gë_pcmfûeöfo
 },

136 { 
NULL
, 0 }

142 
	~"ègutûs-misc.c
"

143 
	~"ègutûs-mp3.c
"

144 
	~"ègutûs-Øc.c
"

145 
	~"ègutûs-ogg.c
"

146 
	~"ègutûs-Êc.c
"

147 
	~"ègutûs-asf.c
"

148 
	~"ègutûs-wav.c
"

149 
	~"ègutûs-pcm.c
"

150 
	~"ègutûs-∂i°.c
"

154 
	#MAYBEFREE
(
a
Ë{ if(◊)Ë
	`‰ì
(◊)); };

	)

156 
	$‰ìègs
(
s⁄g_mëad©a
 *
ps⁄g
)

158 
rﬁe
;

160 
	`MAYBEFREE
(
ps⁄g
->
∑th
);

161 
	`MAYBEFREE
(
ps⁄g
->
image
);

162 
	`MAYBEFREE
(
ps⁄g
->
tôÀ
);

163 
	`MAYBEFREE
(
ps⁄g
->
Æbum
);

164 
	`MAYBEFREE
(
ps⁄g
->
gíª
);

165 
	`MAYBEFREE
(
ps⁄g
->
commít
);

166 
rﬁe
 = 
ROLE_START
;Ñﬁê<
ROLE_LAST
;Ñole++)

168 
	`MAYBEFREE
(
ps⁄g
->
c⁄åibut‹
[
rﬁe
]);

169 
	`MAYBEFREE
(
ps⁄g
->
c⁄åibut‹_s‹t
[
rﬁe
]);

171 
	`MAYBEFREE
(
ps⁄g
->
groupög
);

172 
	`MAYBEFREE
(
ps⁄g
->
mime
);

173 
	`MAYBEFREE
(
ps⁄g
->
d a_≤
);

174 
	`MAYBEFREE
(
ps⁄g
->
ègvîsi⁄
);

175 
	`MAYBEFREE
(
ps⁄g
->
musicbøöz_Æbumid
);

176 
	`MAYBEFREE
(
ps⁄g
->
musicbøöz_åackid
);

177 
	`MAYBEFREE
(
ps⁄g
->
musicbøöz_¨ti°id
);

178 
	`MAYBEFREE
(
ps⁄g
->
musicbøöz_Æbum¨ti°id
);

179 
	}
}

183 
	$_gë_fûeöfo
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

185 
ègh™dÀr
 *
hdl
;

188 
hdl
 = 
ègh™dÀrs
; hdl->
ty≥
; ++hdl)

189 if(!
	`°rcmp
(
hdl
->
ty≥
, 
ps⁄g
->type))

192 if(
hdl
->
gë_fûeöfo
)

193  
hdl
->
	`gë_fûeöfo
(
fûe
, 
ps⁄g
);

196 
	}
}

200 
	$_make_composôe_ègs
(
s⁄g_mëad©a
 *
ps⁄g
)

202 
Àn
;

204 
Àn
 = 1;

206 if(!
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
] &&

207 (
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
] ||Ös⁄g->c⁄åibut‹[
ROLE_CONDUCTOR
]))

209 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
])

210 
Àn
 +
	`°æí
(
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
]);

211 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
])

212 
Àn
 +
	`°æí
(
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
]);

214 
Àn
 += 3;

216 
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
] = (*)
	`ˇŒoc
(
Àn
, 1);

217 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
])

219 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
])

220 
	`°rˇt
(
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
],Ös⁄g->c⁄åibut‹[
ROLE_BAND
]);

222 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_BAND
] &&Ös⁄g->c⁄åibut‹[
ROLE_CONDUCTOR
])

223 
	`°rˇt
(
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
], " - ");

225 if(
ps⁄g
->
c⁄åibut‹
[
ROLE_CONDUCTOR
])

226 
	`°rˇt
(
ps⁄g
->
c⁄åibut‹
[
ROLE_ARTIST
],Ös⁄g->c⁄åibut‹[
ROLE_CONDUCTOR
]);

231 if(!
ps⁄g
->
tôÀ
)

233 *
suffix
;

234 
ps⁄g
->
tôÀ
 = 
	`°rdup
’s⁄g->
ba£«me
);

235 
suffix
 = 
	`°ºchr
(
ps⁄g
->
tôÀ
, '.');

236 if(
suffix
) *suffix = '\0';

239 
	}
}

245 
	$_gë_ègs
(*
fûe
, 
s⁄g_mëad©a
 *
ps⁄g
)

247 
ègh™dÀr
 *
hdl
;

250 
hdl
 = 
ègh™dÀrs
 ; hdl->
ty≥
 ; ++hdl)

251 if(!
	`°rˇ£cmp
(
hdl
->
ty≥
, 
ps⁄g
->type))

254 if(
hdl
->
gë_ègs
)

256  
hdl
->
	`gë_ègs
(
fûe
, 
ps⁄g
);

260 
	}
}

265 
	$ªadègs
(*
∑th
, 
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
)

267 *
‚ame
;

269 if(
œng_ödex
 == -1)

270 
œng_ödex
 = 
	`_œng2˝
(
œng
);

272 
	`mem£t
((*)
ps⁄g
, 0, (
s⁄g_mëad©a
));

273 
ps⁄g
->
∑th
 = 
	`°rdup
(path);

274 
ps⁄g
->
ty≥
 =Åype;

276 
‚ame
 = 
	`°ºchr
(
ps⁄g
->
∑th
, '/');

277 
ps⁄g
->
ba£«me
 = 
‚ame
 ? f«mê+ 1 :Ös⁄g->
∑th
;

279 if(
°©
)

281 if(!
ps⁄g
->
time_modifõd
)

282 
ps⁄g
->
time_modifõd
 = 
°©
->
°_mtime
;

283 
ps⁄g
->
fûe_size
 = 
°©
->
°_size
;

287 if–
	`_gë_ègs
(
∑th
, 
ps⁄g
) == 0 )

289 
	`_make_composôe_ègs
(
ps⁄g
);

293  
	`_gë_fûeöfo
(
∑th
, 
ps⁄g
);

294 
	}
}

	@tagutils/tagutils.h

27 #i‚de‡
_TAG_H_


28 
	#_TAG_H_


	)

30 
	~<°dio.h
>

31 
	~<sys/ty≥s.h
>

32 
	~<sys/°©.h
>

33 
	~<libgí.h
>

35 
	#ROLE_NOUSE
 0

	)

36 
	#ROLE_START
 1

	)

37 
	#ROLE_ARTIST
 1

	)

38 
	#ROLE_TRACKARTIST
 2

	)

39 
	#ROLE_ALBUMARTIST
 3

	)

40 
	#ROLE_BAND
 4

	)

41 
	#ROLE_CONDUCTOR
 5

	)

42 
	#ROLE_COMPOSER
 6

	)

43 
	#ROLE_LAST
 6

	)

44 
	#N_ROLE
 7

	)

46 
	ss⁄g_mëad©a
 {

47 
	mfûe_size
;

48 *
	mdú∑th
;

49 *
	m∑th
;

50 *
	mba£«me
;

51 *
	mty≥
;

52 
	mtime_modifõd
;

54 *
	mimage
;

55 
	mimage_size
;

57 *
	mtôÀ
;

58 *
	mÆbum
;

59 *
	mgíª
;

60 *
	mcommít
;

62 *
	mc⁄åibut‹
[
N_ROLE
];

66 *
	mc⁄åibut‹_s‹t
[
N_ROLE
];

69 *
	mgroupög
;

70 
	myór
;

71 
	måack
;

72 
	mtŸÆ_åacks
;

73 
	mdisc
;

74 
	mtŸÆ_discs
;

75 
	mbpm
;

76 
	mcompû©i⁄
;

78 
	mbôøã
;

79 
	mmax_bôøã
;

80 
	mßm∂î©e
;

81 
	mßm∂esize
;

82 
	mch™√ls
;

83 
	ms⁄g_Àngth
;

84 
	maudio_size
;

85 
	maudio_off£t
;

86 
	mvbr_sˇÀ
;

87 
	mlos¶ess
;

88 
	mblockÆignmít
;

90 *
	mmime
;

91 *
	md a_≤
;

93 *
	mègvîsi⁄
;

95 
	mÆbum_id
;

96 
	måack_id
;

97 
	mgíª_id
;

98 
	mc⁄åibut‹_id
[
N_ROLE
];

100 *
	mmusicbøöz_Æbumid
;

101 *
	mmusicbøöz_åackid
;

102 *
	mmusicbøöz_¨ti°id
;

103 *
	mmusicbøöz_Æbum¨ti°id
;

105 
	mis_∂i°
;

106 
	m∂i°_posôi⁄
;

107 
	m∂i°_id
;

110 
	#WMA
 0x161

	)

111 
	#WMAPRO
 0x162

	)

112 
	#WMALSL
 0x163

	)

114 
sˇn_öô
(*
∑th
);

115 
make_composôe_ègs
(
s⁄g_mëad©a
 *
ps⁄g
);

116 
ªadègs
(*
∑th
, 
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
);

117 
‰ìègs
(
s⁄g_mëad©a
 *
ps⁄g
);

119 
°¨t_∂i°
(c⁄° *
∑th
, 
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
);

120 
√xt_∂i°_åack
(
s⁄g_mëad©a
 *
ps⁄g
, 
°©
 *°©, *
œng
, *
ty≥
);

	@tagutils/textutils.c

23 
	~<°dlib.h
>

24 
	~<°dio.h
>

25 
	~<°rög.h
>

26 
	~<˘y≥.h
>

28 
	~"misc.h
"

29 
	~"ãxtutûs.h
"

30 
	~"../log.h
"

33 
	$_ch¨_htoi
(
h
)

35 i‡(
h
<'0')

37 i‡(
h
<='9')

38  
h
-'0';

39 i‡(
h
<'A')

41 i‡(
h
<='F')

42  
h
-'A'+10;

43 i‡(
h
<'a')

45 i‡(
h
<='f')

46  
h
-'a'+10;

48 
	}
}

51 
	$uædecode
(*
§c
)

53 
c
, *
s
, *
d
;

55 
d
=
s
=
§c
; *s; s++, d++) {

56 
c
 = *
s
;

57 i‡(
c
=='%') {

58 
c
 = *++
s
;

59 i‡(
c
=='%')

60 
c
 = '%';

62 
c
 = 
	`_ch¨_htoi
(c)<<4 | _ch¨_htoi(*++
s
);

64 *
d
 = 
c
;

67 *
d
 = 
c
;

70 *
d
 = '\0';

71 
	}
}

75 
	$is_ign‹edw‹d
(c⁄° *
°r
)

77 
i
;

79 i‡(!
¥efs
.
ign‹edw‹ds
)

82 
i
=0; 
¥efs
.
ign‹edw‹ds
[i].
n
; i++) {

83 i‡(!(
	`°∫ˇ£cmp
(
¥efs
.
ign‹edw‹ds
[
i
].
w‹d
, 
°r
,Öªfs.ign‹edw‹ds[i].
n
))) {

84 
√xt_ch¨
 = 
°r
[
¥efs
.
ign‹edw‹ds
[
i
].
n
];

85 i‡(
	`iß um
(
√xt_ch¨
))

87  
¥efs
.
ign‹edw‹ds
[
i
].
n
;

91 
	}
}

95 
	$skù•a˚s
(c⁄° *
°r
)

97 
	`is•a˚
(*
°r
)) str++;

98  (*Ë
°r
;

99 
	}
}

122 
	gUtoAscii
[] = {

144 
	gUtoUµî
[] = {

167 
	$ß„_©oi
(*
s
)

169 i‡(!
s
)

171 i‡((
s
[0]>='0' && s[0]<='9') || s[0]=='-' || s[0]=='+')

172  
	`©oi
(
s
);

174 
	}
}

178 
	$utf16À_to_utf8
(*
d°
, 
n
, 
__u16
 
utf16À
)

180 
__u16
 
wc
 = 
	`À16_to_˝u
(
utf16À
);

181 i‡(
wc
 < 0x80) {

182 i‡(
n
<1)  0;

183 *
d°
++ = 
wc
 & 0xff;

186 i‡(
wc
 < 0x800) {

187 i‡(
n
<2)  0;

188 *
d°
++ = 0xc0 | (
wc
>>6);

189 *
d°
++ = 0x80 | (
wc
 & 0x3f);

193 i‡(
n
<3)  0;

194 *
d°
++ = 0xe0 | (
wc
>>12);

195 *
d°
++ = 0x80 | ((
wc
>>6) & 0x3f);

196 *
d°
++ = 0x80 | (
wc
 & 0x3f);

199 
	}
}

202 
	$„tch_°rög_txt
(*
‚ame
, *
œng
, 
n
, ...)

204 
va_li°
 
¨gs
;

205 **
keys
;

206 ***
°rs
;

207 **
def°r
;

208 
i
;

209 
FILE
 *
Â
;

210 
buf
[4096];

211 
°©e
;

212 *
p
;

213 *
œngid
;

214 c⁄° *
œng_í
 = "EN";

216 i‡(!(
keys
 = 
	`mÆloc
((keysË* 
n
))) {

217 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
, "Out of memory\n");

219 i‡(!(
°rs
 = 
	`mÆloc
((°rsË* 
n
))) {

220 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
, "Out of memory\n");

222 i‡(!(
def°r
 = 
	`mÆloc
((def°rË* 
n
))) {

223 
	`DPRINTF
(
E_FATAL
, 
L_SCANNER
, "Out of memory\n");

226 
	`va_°¨t
(
¨gs
, 
n
);

227 
i
=0; i<
n
; i++) {

228 
keys
[
i
] = 
	`va_¨g
(
¨gs
, *);

229 
°rs
[
i
] = 
	`va_¨g
(
¨gs
, **);

230 
def°r
[
i
] = 
	`va_¨g
(
¨gs
, *);

232 
	`va_íd
(
¨gs
);

234 i‡(!(
Â
 = 
	`f›í
(
‚ame
, "rb"))) {

235 
	`DPRINTF
(
E_ERROR
, 
L_SCANNER
, "C™nŸ o≥¿<%s>\n", 
‚ame
);

236 
_exô
;

239 
°©e
 = -1;

240 
	`fgës
(
buf
, (buf), 
Â
)) {

241 
Àn
 = 
	`°æí
(
buf
);

243 i‡(
buf
[
Àn
-1]=='\n') buf[len-1] = '\0';

245 i‡(
°©e
<0) {

246 i‡(
	`ißÕha
(
buf
[0])) {

247 
i
=0; i<
n
; i++) {

248 i‡(!(
	`°rcmp
(
keys
[
i
], 
buf
))) {

249 
°©e
 = 
i
;

256 
found
 = 0;

258 i‡(
	`ißÕha
(
buf
[0]) || buf[0]=='\0') {

259 
°©e
 = -1;

263 
p
 = 
buf
;

264 
	`is•a˚
(*
p
))Ö++;

265 i‡(*
p
 == '\0') {

266 
°©e
 = -1;

269 
œngid
 = 
p
;

270 !
	`is•a˚
(*
p
))Ö++;

271 *
p
++ = '\0';

273 i‡(!
	`°rcmp
(
œng
, 
œngid
))

274 
found
 = 1;

275 i‡(
	`°rcmp
(
œng_í
, 
œngid
))

278 
	`is•a˚
(*
p
))Ö++;

279 i‡(*
°rs
[
°©e
])

280 
	`‰ì
(*
°rs
[
°©e
]);

281 *
°rs
[
°©e
] = 
	`°rdup
(
p
);

283 i‡(
found
)

284 
°©e
 = -1;

288 
i
=0; i<
n
; i++) {

289 i‡(!*
°rs
[
i
])

290 *
°rs
[
i
] = 
def°r
[i];

292 
	`f˛o£
(
Â
);

294 
_exô
:

295 
	`‰ì
(
keys
);

296 
	`‰ì
(
°rs
);

297 
	`‰ì
(
def°r
);

298 
	}
}

	@tagutils/textutils.h

22 
	~<°d¨g.h
>

24 
uædecode
(*
§c
);

25 * 
skù•a˚s
(c⁄° *
§c
);

26 
ß„_©oi
(*
s
);

27 
utf16À_to_utf8
(*
d°
, 
n
, 
__u16
 
utf16À
);

28 
„tch_°rög_txt
(*
‚ame
, *
œng
, 
n
, ...);

	@testupnpdescgen.c

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

33 
	~"c⁄fig.h
"

34 
	~"u≤pdescgí.h
"

36 
	guuidvÆue
[] = "uuid:12345678-0000-0000-0000-00000000abcd";

37 
	g‰õndly_«me
[] = "localhost: system_type";

38 
	g£rü umbî
[] = "12345678";

39 
	gmodñ«me
[] = "MiniDLNA";

40 
	gmodñnumbî
[] = "1";

41 
	g¥e£¡©i⁄uæ
[] = "http://192.168.0.1:8080/";

42 
	gupd©eID
 = 0;

43 #i‡
PNPX


44 
	g≤px_hwid
[] = "VEN_01F2&amp;DEV_0101&amp;REV_01 VEN_0033&amp;DEV_0001&amp;REV_01";

47 
	$gëiÁddr
(c⁄° * 
i‚ame
, * 
buf
, 
Àn
)

49 
	`°∫˝y
(
buf
, "1.2.3.4", 
Àn
);

51 
	}
}

53 
	$u≤p_gë_p‹tm≠pög_numbî_of_íåõs
()

56 
	}
}

60 
	$xml_¥ëty_¥öt
(c⁄° * 
s
, 
Àn
, 
FILE
 * 
f
)

62 
n
 = 0, 
i
;

63 
ñt_˛o£
 = 0;

64 
c
, 
ödít
 = 0;

65 
Àn
 > 0)

67 
c
 = *(
s
++); 
Àn
--;

68 
c
)

71 if(
Àn
>0 && *
s
 == '/')

72 
ñt_˛o£
++;

73 if(
Àn
>0 && *
s
 == '?')

74 
ñt_˛o£
 = 1;

76 
ñt_˛o£
 = 0;

77 if(
ñt_˛o£
!=1)

79 if(
ñt_˛o£
 > 1)

80 
ödít
--;

81 
	`Âutc
('\n', 
f
); 
n
++;

82 
i
=
ödít
; i>0; i--)

83 
	`Âutc
(' ', 
f
);

84 
n
 +
ödít
;

86 
	`Âutc
(
c
, 
f
); 
n
++;

89 
	`Âutc
(
c
, 
f
); 
n
++;

90 if(
ñt_˛o£
==1)

94 if(
ödít
 > 0)

95 
ödít
--;

97 if(
ñt_˛o£
 == 0)

98 
ödít
++;

101 
	`Âutc
(
c
, 
f
); 
n
++;

104  
n
;

105 
	}
}

108 c⁄° * 
	g°r1
 = "Prefix123String";

109 c⁄° * 
	g°r2
 = "123String";

111 
	$°upid_ã°
()

113 
	`¥ötf
("°r1:'%s' så2:'%s'\n", 
°r1
, 
°r2
);

114 
	`¥ötf
("°r1:%∞°r2:%∞°r2-°r1:%ld\n", 
°r1
, 
°r2
, ()(str2-str1));

115 
	}
}

120 
	$maö
(
¨gc
, * * 
¨gv
)

122 * 
roŸDesc
;

123 
roŸDescLí
;

124 * 
s
;

125 
l
;

126 
roŸDesc
 = 
	`gíRoŸDesc
(&
roŸDescLí
);

127 
	`xml_¥ëty_¥öt
(
roŸDesc
, 
roŸDescLí
, 
°dout
);

128 
	`‰ì
(
roŸDesc
);

129 
	`¥ötf
("\n----------------\n");

130 
	`¥ötf
("ContentDirectory\n");

131 
	`¥ötf
("----------------\n");

132 
s
 = 
	`gíC⁄ã¡Dúe˘‹y
(&
l
);

133 
	`xml_¥ëty_¥öt
(
s
, 
l
, 
°dout
);

134 
	`‰ì
(
s
);

135 
	`¥ötf
("\n----------------\n");

136 
	`¥ötf
("ConnectionManager\n");

137 
	`¥ötf
("----------------\n");

138 
s
 = 
	`gíC⁄√˘i⁄M™agî
(&
l
);

139 
	`xml_¥ëty_¥öt
(
s
, 
l
, 
°dout
);

140 
	`‰ì
(
s
);

141 
	`¥ötf
("\n----------------\n");

142 
	`¥ötf
("X_MS_MRR\n");

143 
	`¥ötf
("----------------\n");

144 
s
 = 
	`gíX_MS_MedüRe˚ivîRegi°ør
(&
l
);

145 
	`xml_¥ëty_¥öt
(
s
, 
l
, 
°dout
);

146 
	`‰ì
(
s
);

147 
	`¥ötf
("\n-------------\n");

152 
	}
}

	@tivo_beacon.c

29 
	~"c⁄fig.h
"

30 #ifde‡
TIVO_SUPPORT


31 
	~<°dlib.h
>

32 
	~<°dio.h
>

33 
	~<uni°d.h
>

34 
	~<°rög.h
>

35 
	~<sys/waô.h
>

36 
	~<sys/io˘l.h
>

37 
	~<sys/°©.h
>

38 
	~<f˙é.h
>

39 
	~<î∫o.h
>

40 
	~<time.h
>

42 
	~<sys/∑øm.h
>

43 
	~<sys/sockë.h
>

44 
	~<√töë/ö.h
>

45 
	~<¨∑/öë.h
>

46 
	~<√t/if.h
>

47 
	~<sys/pﬁl.h
>

48 
	~<√tdb.h
>

50 
	~"tivo_bóc⁄.h
"

51 
	~"u≤pglobÆv¨s.h
"

52 
	~"möid a.h
"

53 
	~"log.h
"

55 
	gsbóc⁄
 = -1;

60 
	$O≥nAndC⁄fTivoBóc⁄Sockë
()

62 
s
;

63 
i
 = 1;

64 
sockaddr_ö
 
bóc⁄
;

66 if–(
s
 = 
	`sockë
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_UDP
)) < 0)

68 
	`DPRINTF
(
E_ERROR
, 
L_TIVO
, "sockë(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

72 if(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
i
, (i)) < 0)

74 
	`DPRINTF
(
E_WARN
, 
L_TIVO
, "£tsock›t(hâp, SO_REUSEADDR): %s\n", 
	`°ªº‹
(
î∫o
));

77 
	`mem£t
(&
bóc⁄
, 0, (
sockaddr_ö
));

78 
bóc⁄
.
sö_Ámûy
 = 
AF_INET
;

79 
bóc⁄
.
sö_p‹t
 = 
	`ht⁄s
(2190);

80 
bóc⁄
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_ANY
);

82 if(
	`böd
(
s
, (
sockaddr
 *)&
bóc⁄
, (
sockaddr_ö
)) < 0)

84 
	`DPRINTF
(
E_ERROR
, 
L_TIVO
, "böd(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

85 
	`˛o£
(
s
);

88 
i
 = 1;

89 if(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_BROADCAST
, &
i
, (i)) < 0 )

91 
	`DPRINTF
(
E_WARN
, 
L_TIVO
, "£tsock›t(hâp, SO_BROADCAST): %s\n", 
	`°ªº‹
(
î∫o
));

92 
	`˛o£
(
s
);

96  
s
;

97 
	}
}

102 
uöt32_t


103 
	$gëBˇ°Addªss
()

105 
i
, 
rvÆ
;

106 
s
;

107 
sockaddr_ö
 
sö
;

108 
sockaddr_ö
 
addr
;

109 
i‰eq
 
i‰
[16];

110 
ifc⁄f
 
ifc
;

111 
cou¡
 = 0;

112 
uöt32_t
 
ªt
 = 
INADDR_BROADCAST
;

114 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

115 
	`mem£t
(&
ifc
, '\0', (ifc));

116 
ifc
.
ifc_Àn
 = (
i‰
);

117 
ifc
.
ifc_ªq
 = 
i‰
;

119 if(
	`io˘l
(
s
, 
SIOCGIFCONF
, &
ifc
) < 0) {

120 
	`DPRINTF
(
E_ERROR
, 
L_TIVO
, "Eº‹ gëtög i¡îÁ˚Üi° [%s]\n", 
	`°ªº‹
(
î∫o
));

121 
	`˛o£
(
s
);

122  
ªt
;

125 
cou¡
 = 
ifc
.
ifc_Àn
 / (
i‰eq
);

126 
i
 = 0; i < 
cou¡
; i++)

128 
	`mem˝y
(&
addr
, &
i‰
[
i
].
i‰_addr
, (addr));

129 if(
	`°rcmp
(
	`öë_¡ﬂ
(
addr
.
sö_addr
), 
œn_addr
[0].
°r
) == 0)

131 
rvÆ
 = 
	`io˘l
(
s
, 
SIOCGIFBRDADDR
, &
i‰
[
i
]);

132 if–
rvÆ
 < 0 )

134 
	`DPRINTF
(
E_ERROR
, 
L_TIVO
, "FaûedÅÿgë brﬂdˇ°ádd∏⁄ %†[%s]\n", 
i‰
[
i
].
i‰_«me
, 
	`°ªº‹
(
î∫o
));

137 
	`mem˝y
(&
sö
, &
i‰
[
i
].
i‰_brﬂdaddr
, (sin));

138 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "I¡îÁ˚: %†brﬂdˇ°ádd∏%s\n", 
i‰
[
i
].
i‰_«me
, 
	`öë_¡ﬂ
(
sö
.
sö_addr
));

139 
ªt
 = 
	`¡ohl
((
uöt32_t
)(
sö
.
sö_addr
.
s_addr
));

143 
	`˛o£
(
s
);

145  
ªt
;

146 
	}
}

153 
	$£ndBóc⁄Mesßge
(
sockaddr_ö
 * 
˛õ¡
, 
Àn
, 
brﬂdˇ°
)

155 * 
mesg
;

156 
mesg_Àn
;

158 
mesg_Àn
 = 
	`a•rötf
(&
mesg
, "TiVoConnect=1\n"

165 
brﬂdˇ°
 ? "broadcast" : "connected",

166 
uuidvÆue
, 
‰õndly_«me
, 
ru¡ime_v¨s
.
p‹t
);

167 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "Sídög TiVÿbóc⁄Åÿ%s\n", 
	`öë_¡ﬂ
(
˛õ¡
->
sö_addr
));

168 
	`£ndto
(
sbóc⁄
, 
mesg
, 
mesg_Àn
, 0, (
sockaddr
*)
˛õ¡
, 
Àn
);

169 
	`‰ì
(
mesg
);

170 
	}
}

179 
	$rcvBóc⁄Mesßge
(*
bóc⁄
)

181 *
tivoC⁄√˘
 = 
NULL
;

182 *
mëhod
 = 
NULL
;

183 *
idítôy
 = 
NULL
;

184 *
machöe
 = 
NULL
;

185 *
∂©f‹m
 = 
NULL
;

186 *
£rvi˚s
 = 
NULL
;

187 *
˝
;

188 *
s˝
;

189 *
tok±r
;

191 
˝
 = 
	`°πok_r
(
bóc⁄
, "=\r\n", &
tok±r
);

192  
˝
 !
NULL
 )

194 
s˝
 = 
˝
;

195 
˝
 = 
	`°πok_r
(
NULL
, "=\r\n", &
tok±r
);

196 if–
	`°rˇ£cmp
(
s˝
, "tivoconnect") == 0 )

197 
tivoC⁄√˘
 = 
˝
;

198 if–
	`°rˇ£cmp
(
s˝
, "method") == 0 )

199 
mëhod
 = 
˝
;

200 if–
	`°rˇ£cmp
(
s˝
, "identity") == 0 )

201 
idítôy
 = 
˝
;

202 if–
	`°rˇ£cmp
(
s˝
, "machine") == 0 )

203 
machöe
 = 
˝
;

204 if–
	`°rˇ£cmp
(
s˝
, "platform") == 0 )

205 
∂©f‹m
 = 
˝
;

206 if–
	`°rˇ£cmp
(
s˝
, "services") == 0 )

207 
£rvi˚s
 = 
˝
;

208 
˝
 = 
	`°πok_r
(
NULL
, "=\r\n", &
tok±r
);

211 if–!
tivoC⁄√˘
 || !
∂©f‹m
 || !
mëhod
 )

214 #ifde‡
DEBUG


215 
aBóc⁄
 *
t›Bóc⁄
 = 
NULL
;

216 
aBóc⁄
 *
b
;

217 
time_t
 
cuºít
;

218 
Àn
;

219 
buf
[32];

220 
time_t
 
œ°Summ¨y
 = 0;

222 
cuºít
 = 
	`time
(
NULL
);

223  
b
 = 
t›Bóc⁄
; b !
NULL
; b = b->
√xt
 )

225 if–
	`°rˇ£cmp
(
machöe
, 
b
->machine) == 0 ||

226 
	`°rˇ£cmp
(
idítôy
, 
b
->identity) == 0 )

229 if–
b
 =
NULL
 )

231 
b
 = 
	`ˇŒoc
(1, (*b));

233 if–
machöe
 )

234 
b
->
machöe
 = 
	`°rdup
(machine);

235 if–
idítôy
 )

236 
b
->
idítôy
 = 
	`°rdup
(identity);

238 
b
->
√xt
 = 
t›Bóc⁄
;

239 
t›Bóc⁄
 = 
b
;

241 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "ReceivedÇew beacon: machine(%s)Ölatform(%s) services(%s)\n",

242 
machöe
 ? machine : "-",

243 
∂©f‹m
 ?Ölatform : "-",

244 
£rvi˚s
 ? services : "-" );

247 
b
->
œ°Sìn
 = 
cuºít
;

248 if–!
œ°Summ¨y
 )

249 
œ°Summ¨y
 = 
cuºít
;

251 if–
œ°Summ¨y
 + 1800 < 
cuºít
 )

253 
Àn
 = 0;

254  
b
 = 
t›Bóc⁄
; b !
NULL
; b = b->
√xt
 )

256 
Àn
 +
	`°æí
(
b
->
machöe
) + 32;

258 
s˝
 = 
	`mÆloc
(
Àn
 + 128);

259 
	`°r˝y
–
s˝
, "Known servers: " );

260  
b
 = 
t›Bóc⁄
; b !
NULL
; b = b->
√xt
 )

262 
	`°rˇt
(
s˝
, 
b
->
machöe
);

263 
	`•rötf
(
buf
, "(%ld)", 
cuºít
 - 
b
->
œ°Sìn
);

264 
	`°rˇt
(
s˝
, 
buf
);

265 if–
b
->
√xt
 !
NULL
 )

266 
	`°rˇt
(
s˝
, ",");

268 
	`°rˇt
(
s˝
, "\n");

269 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "%s\n", 
s˝
);

270 
	`‰ì
(
s˝
);

271 
œ°Summ¨y
 = 
cuºít
;

275 if–
	`°∫cmp
(
∂©f‹m
, "tcd/", 4) != 0 )

278 if–
	`°rˇ£cmp
(
mëhod
, "broadcast") == 0 )

280 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "ReceivedÇew beacon: machine(%s/%s)Ölatform(%s) services(%s)\n",

281 
machöe
 ? machine : "-",

282 
idítôy
 ? identity : "-",

283 
∂©f‹m
 ?Ölatform : "-",

284 
£rvi˚s
 ? services : "-" );

288 
	}
}

290 
	$Pro˚ssTiVoBóc⁄
(*
s
)

292 
sock
 = *
s
;

293 
n
;

294 *
˝
;

295 
sockaddr_ö
 
£ndî«me
;

296 
sockÀn_t
 
Àn_r
;

297 
bu‰
[1500];

298 
Àn_r
 = (
sockaddr_ö
);

301 
n
 = 
	`ªcv‰om
(
sock
, 
bu‰
, (bufr), 0,

302 (
sockaddr
 *)&
£ndî«me
, &
Àn_r
);

303 if–
n
 > 0 )

304 
bu‰
[
n
] = '\0';

307 
n
 = 0;Ç<
n_œn_addr
;Ç++)

309 if–(
£ndî«me
.
sö_addr
.
s_addr
 & 
œn_addr
[
n
].
mask
.s_addr)

310 =(
œn_addr
[
n
].
addr
.
s_addr
 &Ü™_addr[n].
mask
.s_addr))

313 if–
n
 =
n_œn_addr
 )

315 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "Ignoring TiVo beacon on other interface [%s]\n",

316 
	`öë_¡ﬂ
(
£ndî«me
.
sö_addr
));

320  
˝
 = 
bu‰
; *cp; cp++ )

322 if–
˝
[-1] == '\r' || cp[-1] == '\n' )

323 *--
˝
 = '\0';

324 if–
˝
[-1] == '\r' || cp[-1] == '\n' )

325 *--
˝
 = '\0';

327 if–
	`rcvBóc⁄Mesßge
(
bu‰
) )

328 
	`£ndBóc⁄Mesßge
(
sock
, &
£ndî«me
, 
Àn_r
, 0);

329 
	}
}

331 
	$tivo_öô
()

333 
evít_°ru˘
 *
evt
;

334 
sbóc⁄
;

335 
ªt
;

337 
	`DPRINTF
(
E_WARN
, 
L_TIVO
, "TiVo support isÉnabled.\n");

339 
ªt
 = 
	`sqlôe3_¸óã_fun˘i⁄
(
db
, "tiv‹™dom", 1, 
SQLITE_UTF8
, 
NULL
, &
TiVoR™domSìdFunc
, NULL, NULL);

340 i‡(
ªt
 !
SQLITE_OK
)

342 
	`DPRINTF
(
E_ERROR
, 
L_TIVO
, "ERROR: FailedÅoádd sqliteÑandomize function for TiVo!\n");

345 
sbóc⁄
 = 
	`O≥nAndC⁄fTivoBóc⁄Sockë
();

346 if(
sbóc⁄
 < 0)

348 
	`DPRINTF
(
E_FATAL
, 
L_TIVO
, "FailedÅo open sockets for sending Tivo beaconÇotify "

352 
evt
 = 
	`evít_mÆloc
(
sbóc⁄
);

353 i‡(!
evt
)

355 
	`DPRINTF
(
E_FATAL
, 
L_TIVO
, "FailedÅo mallocÉvent_struct. EXITING\n");

357 
evt
->
ªad
.
d©a
 = &evt->
sock
;

358 
evt
->
ªad
.
h™dÀr
 = 
Pro˚ssTiVoBóc⁄
;

359 
ªt
 = 
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLIN
);

360 i‡(
ªt
 != 0)

362 
	`DPRINTF
(
E_FATAL
, 
L_TIVO
, "FailedÅoÉvent_ctl sbeacon. EXITING\n");

365  
ªt
;

366 
	}
}

368 
	$tivo_exô
()

370 i‡(
sbóc⁄
 >= 0)

372 
	`˛o£
(
sbóc⁄
);

373 
sbóc⁄
 = -1;

375 
	}
}

	@tivo_beacon.h

24 
	~"c⁄fig.h
"

25 #ifde‡
TIVO_SUPPORT


29 
	saBóc⁄


31 #ifde‡
DEBUG


32 
time_t
 
	mœ°Sìn
;

34 * 
	mmachöe
;

35 * 
	midítôy
;

36 
aBóc⁄
 *
	m√xt
;

39 
uöt32_t


40 
gëBˇ°Addªss
();

43 
O≥nAndC⁄fTivoBóc⁄Sockë
();

46 
£ndBóc⁄Mesßge
(
sockaddr_ö
 * 
˛õ¡
, 
Àn
, 
brﬂdˇ°
);

49 
Pro˚ssTiVoBóc⁄
(*
fd
);

51 
tôo_öô
();

52 
tivo_exô
();

	@tivo_commands.c

18 
	~"c⁄fig.h
"

19 #ifde‡
TIVO_SUPPORT


20 
	~<°dio.h
>

21 
	~<°dlib.h
>

22 
	~<°rög.h
>

23 
	~<libgí.h
>

24 
	~<time.h
>

25 
	~<sys/°©.h
>

27 
	~"tivo_utûs.h
"

28 
	~"u≤pglobÆv¨s.h
"

29 
	~"u≤phâp.h
"

30 
	~"u≤psﬂp.h
"

31 
	~"utûs.h
"

32 
	~"sql.h
"

33 
	~"log.h
"

36 
	$SídRoŸC⁄èöî
(
u≤phâp
 *
h
)

38 *
ª•
;

39 
Àn
;

41 
Àn
 = 
	`xa•rötf
(&
ª•
, "<?xml version='1.0'Éncoding='UTF-8' ?>\n"

90 
‰õndly_«me
, friendly_name, friendly_name, friendly_name);

91 
	`BuûdRe•_u≤phâp
(
h
, 
ª•
, 
Àn
);

92 
	`‰ì
(
ª•
);

93 
	`SídRe•_u≤phâp
(
h
);

94 
	}
}

97 
	$SídF‹m©s
(
u≤phâp
 *
h
, c⁄° *
sf‹m©
)

99 *
ª•
;

100 
Àn
;

102 
Àn
 = 
	`xa•rötf
(&
ª•
, "<?xml version=\"1.0\"Éncoding=\"utf-8\"?>"

112 "</TiVoF‹m©s>", 
sf‹m©
);

113 
	`BuûdRe•_u≤phâp
(
h
, 
ª•
, 
Àn
);

114 
	`‰ì
(
ª•
);

115 
	`SídRe•_u≤phâp
(
h
);

116 
	}
}

119 
	$tivo_u√sˇ≥_èg
(*
èg
)

121 
	`modifySåög
(
èg
, "&amp;amp;", "&amp;");

122 
	`modifySåög
(
èg
, "&amp;amp;lt;", "&lt;");

123 
	`modifySåög
(
èg
, "&amp;lt;", "&lt;");

124 
	`modifySåög
(
èg
, "&amp;amp;gt;", "&gt;");

125 
	`modifySåög
(
èg
, "&amp;gt;", "&gt;");

126  
èg
;

127 
	}
}

129 
	#FLAG_SEND_RESIZED
 0x01

	)

130 
	#FLAG_NO_PARAMS
 0x02

	)

131 
	#FLAG_VIDEO
 0x04

	)

133 
	$ˇŒback
(*
¨gs
, 
¨gc
, **
¨gv
, **
azCﬁName
)

135 
Re•⁄£
 *
∑s£d_¨gs
 = (Re•⁄£ *)
¨gs
;

136 *
id
 = 
¨gv
[0], *
˛ass
 =árgv[1], *
dëaûID
 =árgv[2], *
size
 =árgv[3], *
tôÀ
 =árgv[4], *
duøti⁄
 =árgv[5],

137 *
bôøã
 = 
¨gv
[6], *
ßm∂eFªquícy
 =árgv[7], *
¨ti°
 =árgv[8], *
Æbum
 =árgv[9], *
gíª
 =árgv[10],

138 *
commít
 = 
¨gv
[11], *
d©e
 =árgv[12], *
ªsﬁuti⁄
 =árgv[13], *
mime
 =árgv[14];

139 
°rög_s
 *
°r
 = 
∑s£d_¨gs
->str;

141 if–
	`°∫cmp
(
˛ass
, "item", 4) == 0 )

143 
Êags
 = 0;

144 
	`tivo_u√sˇ≥_èg
(
tôÀ
);

145 if–
	`°∫cmp
(
mime
, "audio", 5) == 0 )

147 
Êags
 |
FLAG_NO_PARAMS
;

148 
	`°rˇtf
(
°r
, "<Item><Details>"

152 "audio/*", 
mime
, 
size
);

153 
	`°rˇtf
(
°r
, "<S⁄gTôÀ>%s</S⁄gTôÀ>", 
tôÀ
);

154 if–
d©e
 )

155 
	`°rˇtf
(
°r
, "<AlbumYór>%.*s</AlbumYór>", 4, 
d©e
);

157 if–
	`°rcmp
(
mime
, "image/jpeg") == 0 )

159 
Êags
 |
FLAG_SEND_RESIZED
;

160 
	`°rˇtf
(
°r
, "<Item><Details>"

164 "image/*", 
mime
, 
size
);

165 if–
d©e
 )

167 
tm
Åm;

168 
	`mem£t
(&
tm
, 0, (tm));

169 
tm
.
tm_isd°
 = -1;

170 
	`°Ωtime
(
d©e
, "%Y-%m-%dT%H:%M:%S", &
tm
);

171 
	`°rˇtf
(
°r
, "<C≠tuªD©e>0x%X</C≠tuªD©e>", ()
	`mktime
(&
tm
));

173 if–
commít
 )

174 
	`°rˇtf
(
°r
, "<C≠ti⁄>%s</C≠ti⁄>", 
commít
);

176 if–
	`°∫cmp
(
mime
, "video", 5) == 0 )

178 *
ïisode
;

179 
Êags
 |
FLAG_VIDEO
;

180 
	`°rˇtf
(
°r
, "<Item><Details>"

184 
mime
, mime, 
size
);

185 
ïisode
 = 
	`°r°r
(
tôÀ
, " - ");

186 if–
ïisode
 )

188 
	`°rˇtf
(
°r
, "<Title>%.*s</Title>"

190 ()(
ïisode
-
tôÀ
),Åitle,Épisode+3);

194 
	`°rˇtf
(
°r
, "<TôÀ>%s</TôÀ>", 
tôÀ
);

196 if–
d©e
 )

198 
tm
Åm;

199 
	`mem£t
(&
tm
, 0, (tm));

200 
tm
.
tm_isd°
 = -1;

201 
	`°Ωtime
(
d©e
, "%Y-%m-%dT%H:%M:%S", &
tm
);

202 
	`°rˇtf
(
°r
, "<C≠tuªD©e>0x%X</C≠tuªD©e>", ()
	`mktime
(&
tm
));

204 if–
commít
 )

205 
	`°rˇtf
(
°r
, "<Des¸ùti⁄>%s</Des¸ùti⁄>", 
commít
);

211 
	`°rˇtf
(
°r
, "<TôÀ>%s</TôÀ>", 
	`tivo_u√sˇ≥_èg
(
tôÀ
));

212 if–
¨ti°
 ) {

213 
	`°rˇtf
(
°r
, "<Aπi°Name>%s</Aπi°Name>", 
	`tivo_u√sˇ≥_èg
(
¨ti°
));

215 if–
Æbum
 ) {

216 
	`°rˇtf
(
°r
, "<AlbumTôÀ>%s</AlbumTôÀ>", 
	`tivo_u√sˇ≥_èg
(
Æbum
));

218 if–
gíª
 ) {

219 
	`°rˇtf
(
°r
, "<MusicGíª>%s</MusicGíª>", 
	`tivo_u√sˇ≥_èg
(
gíª
));

221 if–
ªsﬁuti⁄
 ) {

222 *
width
 = 
	`°r£p
(&
ªsﬁuti⁄
, "x");

223 
	`°rˇtf
(
°r
, "<SourceWidth>%s</SourceWidth>"

225 
width
, 
ªsﬁuti⁄
);

227 if–
duøti⁄
 ) {

228 
	`°rˇtf
(
°r
, "<Duration>%d</Duration>",

229 
	`©oi
(
	`°ºchr
(
duøti⁄
, '.')+1) + (1000*atoi(strrchr(duration, ':')+1))

230 + (60000*
	`©oi
(
	`°ºchr
(
duøti⁄
, ':')-2)) + (3600000*atoi(duration)));

232 if–
bôøã
 ) {

233 
	`°rˇtf
(
°r
, "<Sour˚BôR©e>%s</Sour˚BôR©e>", 
bôøã
);

235 if–
ßm∂eFªquícy
 ) {

236 
	`°rˇtf
(
°r
, "<Sour˚Sam∂eR©e>%s</Sour˚Sam∂eR©e>", 
ßm∂eFªquícy
);

238 
	`°rˇtf
(
°r
, "</Details><Links>"

243 
mime
,

244 (
Êags
 & 
FLAG_SEND_RESIZED
) ? "Resized" : "MediaItems",

245 
dëaûID
, 
	`mime_to_ext
(
mime
),

246 (
Êags
 & 
FLAG_NO_PARAMS
) ? "<AcceptsParams>No</AcceptsParams>" : "");

247 if–
Êags
 & 
FLAG_VIDEO
 )

249 
	`°rˇtf
(
°r
, "<CustomIcon>"

254 
	`°rˇtf
(
°r
, "</Links>");

256 if–
	`°∫cmp
(
˛ass
, "container", 9) == 0 )

258 
cou¡
;

260 #ifde‡
__•¨c__


261 
cou¡
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêPARENT_ID = '%s'", 
id
);

263 
cou¡
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(*) from OBJECTS oÜeft join DETAILS d on (d.ID = o.DETAIL_ID) where PARENT_ID = '%s'ánd "

265 " o∏CLASS glob 'c⁄èöî*')", 
id
);

267 
	`°rˇtf
(
°r
, "<Item>"

280 
	`tivo_u√sˇ≥_èg
(
tôÀ
), 
cou¡
, 
id
);

282 
	`°rˇtf
(
°r
, "</Item>");

284 
∑s£d_¨gs
->
ªtu∫ed
++;

287 
	}
}

289 
	#SELECT_COLUMNS
 "SELECT o.OBJECT_ID, o.CLASS, o.DETAIL_ID, d.SIZE, d.TITLE," \

291 " d.COMMENT, d.DATE, d.RESOLUTION, d.MIME, d.DISC, d.TRACK "

	)

294 
	$SídIãmDëaûs
(
u≤phâp
 *
h
, 
öt64_t
 
ôem
)

296 *
sql
;

297 *
zEºMsg
 = 
NULL
;

298 
Re•⁄£
 
¨gs
;

299 
°rög_s
 
°r
;

300 
ªt
;

301 
	`mem£t
(&
¨gs
, 0, (args));

302 
	`mem£t
(&
°r
, 0, (str));

304 
°r
.
d©a
 = 
	`mÆloc
(32768);

305 
°r
.
size
 = 32768;

306 
°r
.
off
 = 
	`•rötf
(°r.
d©a
, "<?xml version='1.0'Éncoding='UTF-8' ?>\n<TiVoItem>");

307 
¨gs
.
°r
 = &str;

308 
¨gs
.
ªque°ed
 = 1;

309 
	`xa•rötf
(&
sql
, 
SELECT_COLUMNS


311 " whîêo.DETAIL_ID = %Œd grou∞by o.DETAIL_ID", 
ôem
);

312 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "%s\n", 
sql
);

313 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
ˇŒback
, (*Ë&
¨gs
, &
zEºMsg
);

314 
	`‰ì
(
sql
);

315 if–
ªt
 !
SQLITE_OK
 )

317 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "SQLÉº‹: %s\n", 
zEºMsg
);

318 
	`sqlôe3_‰ì
(
zEºMsg
);

320 
	`°rˇtf
(&
°r
, "</TiVoItem>");

322 
	`BuûdRe•_u≤phâp
(
h
, 
°r
.
d©a
, så.
off
);

323 
	`‰ì
(
°r
.
d©a
);

324 
	`SídRe•_u≤phâp
(
h
);

325 
	}
}

328 
	$SídC⁄èöî
(
u≤phâp
 *
h
, c⁄° *
obje˘ID
, 
ôemSèπ
, 
ôemCou¡
, *
™ch‹Iãm
,

329 
™ch‹Off£t
, 
ªcur£
, *
s‹tOrdî
, *
fûãr
, 
øndomSìd
)

331 *
ª•
 = 
	`mÆloc
(262144);

332 *
sql
, *
ôem
, *
ßvïå
;

333 *
zEºMsg
 = 
NULL
;

334 **
ªsu…
;

335 *
tôÀ
, *
which
;

336 
wh©
[10], 
‹dî
[96]={0}, 
‹dî2
[96]={0}, 
myfûãr
[256]={0};

337 
°r_buf
[1024];

338 
ty≥
[8];

339 
groupBy
[19] = {0};

340 
Re•⁄£
 
¨gs
;

341 
°rög_s
 
°r
;

342 
tŸÆM©ches
 = 0;

343 
i
, 
ªt
;

344 
	`mem£t
(&
¨gs
, 0, (args));

345 
	`mem£t
(&
°r
, 0, (str));

347 
¨gs
.
°r
 = &str;

348 
°r
.
d©a
 = 
ª•
+1024;

349 
°r
.
size
 = 262144-1024;

350 if–
ôemCou¡
 >= 0 )

352 
¨gs
.
ªque°ed
 = 
ôemCou¡
;

356 if–
ôemCou¡
 == -100 )

357 
ôemCou¡
 = 1;

358 
¨gs
.
ªque°ed
 = 
ôemCou¡
 * -1;

361  *
obje˘ID
 )

364 
	`°r˝y
(
ty≥
, "music");

367 
	`°r˝y
(
ty≥
, "videos");

370 
	`°r˝y
(
ty≥
, "photos");

373 
	`°r˝y
(
ty≥
, "server");

377 if–
	`°æí
(
obje˘ID
) == 1 )

379  *
obje˘ID
 )

382 
	`xa•rötf
(&
tôÀ
, "Musi¯⁄ %s", 
‰õndly_«me
);

385 
	`xa•rötf
(&
tôÀ
, "Video†⁄ %s", 
‰õndly_«me
);

388 
	`xa•rötf
(&
tôÀ
, "Pi˘uª†⁄ %s", 
‰õndly_«me
);

391 
	`xa•rötf
(&
tôÀ
, "Unknow¿⁄ %s", 
‰õndly_«me
);

397 
ôem
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT NAME from OBJECTS whîêOBJECT_ID = '%q'", 
obje˘ID
);

398 if–
ôem
 )

400 
tôÀ
 = 
	`esˇ≥_èg
(
ôem
, 1);

401 
	`sqlôe3_‰ì
(
ôem
);

404 
tôÀ
 = 
	`°rdup
("UNKNOWN");

407 if–
ªcur£
 )

409 
which
 = 
	`sqlôe3_m¥ötf
("OBJECT_ID glob '%q$*'", 
obje˘ID
);

410 
	`°r˝y
(
groupBy
, "group by DETAIL_ID");

414 
which
 = 
	`sqlôe3_m¥ötf
("PARENT_ID = '%q'", 
obje˘ID
);

417 if–
s‹tOrdî
 )

419 if–
	`°rˇ£°r
(
s‹tOrdî
, "Random") )

421 
	`•rötf
(
‹dî
, "tiv‹™dom(%lu)", 
øndomSìd
);

422 if–
ôemCou¡
 < 0 )

423 
	`•rötf
(
‹dî2
, "tiv‹™dom(%luËDESC", 
øndomSìd
);

425 
	`•rötf
(
‹dî2
, "tiv‹™dom(%lu)", 
øndomSìd
);

429 
tôÀ_°©e
 = 0;

430 
ôem
 = 
	`°πok_r
(
s‹tOrdî
, ",", &
ßvïå
);

431  
ôem
 !
NULL
 )

433 
ªvî£
=0;

434 if–*
ôem
 == '!' )

436 
ªvî£
 = 1;

437 
ôem
++;

439 if–
	`°rˇ£cmp
(
ôem
, "Type") == 0 )

441 
	`°rˇt
(
‹dî
, "CLASS");

442 
	`°rˇt
(
‹dî2
, "CLASS");

444 if–
	`°rˇ£cmp
(
ôem
, "Title") == 0 )

447 if–
tôÀ_°©e
 < 2 && *
obje˘ID
 == '1' )

449 if–!
tôÀ_°©e
 )

451 
	`°rˇt
(
‹dî
, "DISC");

452 
	`°rˇt
(
‹dî2
, "DISC");

453 
tôÀ_°©e
 = 1;

457 
	`°rˇt
(
‹dî
, "TRACK");

458 
	`°rˇt
(
‹dî2
, "TRACK");

459 
tôÀ_°©e
 = 2;

464 
	`°rˇt
(
‹dî
, "TITLE");

465 
	`°rˇt
(
‹dî2
, "TITLE");

466 
tôÀ_°©e
 = -1;

469 if–
	`°rˇ£cmp
(
ôem
, "CreationDate") == 0 ||

470 
	`°rˇ£cmp
(
ôem
, "CaptureDate") == 0 )

472 
	`°rˇt
(
‹dî
, "DATE");

473 
	`°rˇt
(
‹dî2
, "DATE");

477 
	`DPRINTF
(
E_INFO
, 
L_TIVO
, "Unh™dÀd S‹tOrdî [%s]\n", 
ôem
);

478 
unh™dÀd_‹dî
;

481 if–
ªvî£
 )

483 
	`°rˇt
(
‹dî
, " DESC");

484 if–
ôemCou¡
 >= 0 )

485 
	`°rˇt
(
‹dî2
, " DESC");

487 
	`°rˇt
(
‹dî2
, " ASC");

491 
	`°rˇt
(
‹dî
, " ASC");

492 if–
ôemCou¡
 >= 0 )

493 
	`°rˇt
(
‹dî2
, " ASC");

495 
	`°rˇt
(
‹dî2
, " DESC");

497 
	`°rˇt
(
‹dî
, ", ");

498 
	`°rˇt
(
‹dî2
, ", ");

499 
unh™dÀd_‹dî
:

500 if–
tôÀ_°©e
 <= 0 )

501 
ôem
 = 
	`°πok_r
(
NULL
, ",", &
ßvïå
);

503 if–
tôÀ_°©e
 != -1 )

505 
	`°rˇt
(
‹dî
, "TITLE ASC, ");

506 if–
ôemCou¡
 >= 0 )

507 
	`°rˇt
(
‹dî2
, "TITLE ASC, ");

509 
	`°rˇt
(
‹dî2
, "TITLE DESC, ");

511 
	`°rˇt
(
‹dî
, "DETAIL_ID ASC");

512 if–
ôemCou¡
 >= 0 )

513 
	`°rˇt
(
‹dî2
, "DETAIL_ID ASC");

515 
	`°rˇt
(
‹dî2
, "DETAIL_ID DESC");

520 
	`•rötf
(
‹dî
, "CLASS, NAME, DETAIL_ID");

521 if–
ôemCou¡
 < 0 )

522 
	`•rötf
(
‹dî2
, "CLASS DESC, NAME DESC, DETAIL_ID DESC");

524 
	`•rötf
(
‹dî2
, "CLASS, NAME, DETAIL_ID");

527 if–
fûãr
 )

529 
ôem
 = 
	`°πok_r
(
fûãr
, ",", &
ßvïå
);

530  
i
=0; 
ôem
 !
NULL
; i++ )

532 if–
i
 )

534 
	`°rˇt
(
myfûãr
, " or ");

536 if–(
	`°rˇ£cmp
(
ôem
, "x-container/folder") == 0) ||

537 (
	`°∫ˇ£cmp
(
ôem
, "x-tivo-container/", 17) == 0) )

539 
	`°rˇt
(
myfûãr
, "CLASS glob 'container*'");

541 if–
	`°∫ˇ£cmp
(
ôem
, "image", 5) == 0 )

543 
	`°rˇt
(
myfûãr
, "MIME = 'image/jpeg'");

545 if–
	`°∫ˇ£cmp
(
ôem
, "audio", 5) == 0 )

547 
	`°rˇt
(
myfûãr
, "MIME = 'audio/mpeg'");

549 if–
	`°∫ˇ£cmp
(
ôem
, "video", 5) == 0 )

551 
	`°rˇt
(
myfûãr
, "MIME in ('video/mpeg', 'video/x-tivo-mpeg', 'video/x-tivo-mpeg-ts')");

555 
	`DPRINTF
(
E_INFO
, 
L_TIVO
, "Unh™dÀd Fûã∏[%s]\n", 
ôem
);

556 if–
i
 )

558 
ªt
 = 
	`°æí
(
myfûãr
);

559 
myfûãr
[
ªt
-4] = '\0';

561 
i
--;

563 
ôem
 = 
	`°πok_r
(
NULL
, ",", &
ßvïå
);

568 
	`°r˝y
(
myfûãr
, "MIME in ('image/jpeg', 'audio/mpeg', 'video/mpeg', 'video/x-tivo-mpeg', 'video/x-tivo-mpeg-ts') or CLASS glob 'container*'");

571 if–
™ch‹Iãm
 )

573 if–
	`°r°r
(
™ch‹Iãm
, "QueryContainer") )

575 
	`°r˝y
(
wh©
, "OBJECT_ID");

576 
ßvïå
 = 
	`°ºchr
(
™ch‹Iãm
, '=');

577 if–
ßvïå
 )

578 
™ch‹Iãm
 = 
ßvïå
 + 1;

582 
	`°r˝y
(
wh©
, "DETAIL_ID");

584 
sqlôe3P∫g
.
isInô
 = 0;

585 
sql
 = 
	`sqlôe3_m¥ötf
("SELECT %s from OBJECTS oÜeft join DETAILS d on (o.DETAIL_ID = d.ID)"

588 " ordî by %s", 
wh©
, 
which
, 
myfûãr
, 
groupBy
, 
‹dî2
);

589 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "%s\n", 
sql
);

590 if–(
	`sql_gë_èbÀ
(
db
, 
sql
, &
ªsu…
, &
ªt
, 
NULL
Ë=
SQLITE_OK
) &&Ñet )

592  
i
=1; i<=
ªt
; i++ )

594 if–
	`°rcmp
(
™ch‹Iãm
, 
ªsu…
[
i
]) == 0 )

596 if–
ôemCou¡
 < 0 )

597 
ôemSèπ
 = 
ªt
 - 
i
 + 
ôemCou¡
;

599 
ôemSèπ
 +
i
;

603 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

605 
	`sqlôe3_‰ì
(
sql
);

607 
¨gs
.
°¨t
 = 
ôemSèπ
+
™ch‹Off£t
;

608 
sqlôe3P∫g
.
isInô
 = 0;

610 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(distinct DETAIL_ID) "

613 
which
, 
myfûãr
);

614 
tŸÆM©ches
 = (
ªt
 > 0) ?Ñet : 0;

615 if–
ôemCou¡
 < 0 && !
ôemSèπ
 && !
™ch‹Off£t
 )

617 
¨gs
.
°¨t
 = 
tŸÆM©ches
 + 
ôemCou¡
;

620 
sql
 = 
	`sqlôe3_m¥ötf
(
SELECT_COLUMNS


625 
which
, 
myfûãr
, 
groupBy
, 
‹dî
, 
¨gs
.
°¨t
,árgs.
ªque°ed
);

626 
	`DPRINTF
(
E_DEBUG
, 
L_TIVO
, "%s\n", 
sql
);

627 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
ˇŒback
, (*Ë&
¨gs
, &
zEºMsg
);

628 
	`sqlôe3_‰ì
(
sql
);

629 if–
ªt
 !
SQLITE_OK
 )

631 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "SQLÉº‹: %s\n", 
zEºMsg
);

632 
	`sqlôe3_‰ì
(
zEºMsg
);

633 
	`Síd500
(
h
);

634 
	`sqlôe3_‰ì
(
which
);

635 
	`‰ì
(
tôÀ
);

636 
	`‰ì
(
ª•
);

639 
	`°rˇtf
(&
°r
, "</TiVoContainer>");

641 
ªt
 = 
	`•rötf
(
°r_buf
, "<?xml version='1.0'Éncoding='UTF-8' ?>\n"

651 
ty≥
, 
tŸÆM©ches
, 
tôÀ
, 
¨gs
.
°¨t
,árgs.
ªtu∫ed
);

652 
°r
.
d©a
 -
ªt
;

653 
	`mem˝y
(
°r
.
d©a
, &
°r_buf
, 
ªt
);

654 
°r
.
size
 = så.
off
+
ªt
;

655 
	`‰ì
(
tôÀ
);

656 
	`sqlôe3_‰ì
(
which
);

657 
	`BuûdRe•_u≤phâp
(
h
, 
°r
.
d©a
, så.
size
);

658 
	`‰ì
(
ª•
);

659 
	`SídRe•_u≤phâp
(
h
);

660 
	}
}

663 
	$Pro˚ssTiVoComm™d
(
u≤phâp
 *
h
, c⁄° *
‹ig_∑th
)

665 *
∑th
;

666 *
key
, *
vÆ
;

667 *
ßvïå
 = 
NULL
, *
ôem
;

668 *
comm™d
 = 
NULL
, *
c⁄èöî
 = NULL, *
™ch‹Iãm
 = NULL;

669 *
s‹tOrdî
 = 
NULL
, *
fûãr
 = NULL, *
sf‹m©
 = NULL;

670 
öt64_t
 
dëaûIãm
=0;

671 
ôemSèπ
=0, 
ôemCou¡
=-100, 
™ch‹Off£t
=0, 
ªcur£
=0;

672 
øndomSìd
=0;

674 
∑th
 = 
	`°rdup
(
‹ig_∑th
);

675 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "Pro˚ssög TiVÿcomm™d %s\n", 
∑th
);

677 
ôem
 = 
	`°πok_r
–
∑th
, "&", &
ßvïå
 );

678  
ôem
 !
NULL
 )

680 if–*
ôem
 == '\0' )

682 
ôem
 = 
	`°πok_r
–
NULL
, "&", &
ßvïå
 );

685 
	`decodeSåög
(
ôem
, 1);

686 
vÆ
 = 
ôem
;

687 
key
 = 
	`°r£p
(&
vÆ
, "=");

688 
	`decodeSåög
(
vÆ
, 1);

689 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "%s: %s\n", 
key
, 
vÆ
);

690 if–
	`°rˇ£cmp
(
key
, "Command") == 0 )

692 
comm™d
 = 
vÆ
;

694 if–
	`°rˇ£cmp
(
key
, "Container") == 0 )

696 
c⁄èöî
 = 
vÆ
;

698 if–
	`°rˇ£cmp
(
key
, "ItemStart") == 0 )

700 
ôemSèπ
 = 
	`©oi
(
vÆ
);

702 if–
	`°rˇ£cmp
(
key
, "ItemCount") == 0 )

704 
ôemCou¡
 = 
	`©oi
(
vÆ
);

706 if–
	`°rˇ£cmp
(
key
, "AnchorItem") == 0 )

708 
™ch‹Iãm
 = 
	`ba£«me
(
vÆ
);

710 if–
	`°rˇ£cmp
(
key
, "AnchorOffset") == 0 )

712 
™ch‹Off£t
 = 
	`©oi
(
vÆ
);

714 if–
	`°rˇ£cmp
(
key
, "Recurse") == 0 )

716 
ªcur£
 = 
	`°rˇ£cmp
("yes", 
vÆ
) == 0 ? 1 : 0;

718 if–
	`°rˇ£cmp
(
key
, "SortOrder") == 0 )

720 
s‹tOrdî
 = 
vÆ
;

722 if–
	`°rˇ£cmp
(
key
, "Filter") == 0 )

724 
fûãr
 = 
vÆ
;

726 if–
	`°rˇ£cmp
(
key
, "RandomSeed") == 0 )

728 
øndomSìd
 = 
	`°πoul
(
vÆ
, 
NULL
, 10);

730 if–
	`°rˇ£cmp
(
key
, "Url") == 0 )

732 if–
vÆ
 )

733 
dëaûIãm
 = 
	`°πﬁl
(
	`ba£«me
(
vÆ
), 
NULL
, 10);

735 if–
	`°rˇ£cmp
(
key
, "SourceFormat") == 0 )

737 
sf‹m©
 = 
vÆ
;

739 if–
	`°rˇ£cmp
(
key
, "Format") == 0 ||

740 
	`°rˇ£cmp
(
key
, "SerialNum") == 0 ||

741 
	`°rˇ£cmp
(
key
, "DoGenres") == 0 )

747 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "Unh™dÀdÖ¨amëî [%s]\n", 
key
);

749 
ôem
 = 
	`°πok_r
–
NULL
, "&", &
ßvïå
 );

751 if–
™ch‹Iãm
 )

753 
	`°rù_ext
(
™ch‹Iãm
);

756 if–
comm™d
 )

758 if–
	`°rcmp
(
comm™d
, "QueryContainer") == 0 )

760 if–!
c⁄èöî
 || (
	`°rcmp
(container, "/") == 0) )

762 
	`SídRoŸC⁄èöî
(
h
);

766 
	`SídC⁄èöî
(
h
, 
c⁄èöî
, 
ôemSèπ
, 
ôemCou¡
, 
™ch‹Iãm
,

767 
™ch‹Off£t
, 
ªcur£
, 
s‹tOrdî
, 
fûãr
, 
øndomSìd
);

770 if–
	`°rcmp
(
comm™d
, "QueryItem") == 0 )

772 
	`SídIãmDëaûs
(
h
, 
dëaûIãm
);

774 if–
	`°rcmp
(
comm™d
, "QueryFormats") == 0 )

776 
	`SídF‹m©s
(
h
, 
sf‹m©
);

780 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "Unh™dÀd comm™d [%s]\n", 
comm™d
);

781 
	`Síd501
(
h
);

782 
	`‰ì
(
∑th
);

786 
	`‰ì
(
∑th
);

787 
	`Clo£Sockë_u≤phâp
(
h
);

788 
	}
}

	@tivo_commands.h

24 
	~"c⁄fig.h
"

25 #ifde‡
TIVO_SUPPORT


28 
Pro˚ssTiVoComm™d
(
u≤phâp
 *
h
, c⁄° *
‹ig_∑th
);

	@tivo_utils.c

18 
	~"c⁄fig.h
"

19 #ifde‡
TIVO_SUPPORT


20 
	~<°dlib.h
>

21 
	~<°döt.h
>

22 
	~<°rög.h
>

23 
	~<˘y≥.h
>

24 
	~<uni°d.h
>

25 
	~<f˙é.h
>

26 
	~<sys/ty≥s.h
>

27 
	~<sqlôe3.h
>

28 
	~"tivo_utûs.h
"

32 
	$decodeSåög
(*
°rög
, 
ö∂a˚
)

34 if–!
°rög
 )

35  
NULL
;

36 
Æloc
 = ()
	`°æí
(
°rög
)+1;

37 *
ns
 = 
NULL
;

38 
ö
;

39 
°rödex
=0;

40 
hex
;

42 if–!
ö∂a˚
 )

44 if–!(
ns
 = 
	`mÆloc
(
Æloc
)) )

45  
NULL
;

48 --
Æloc
 > 0)

50 
ö
 = *
°rög
;

51 if((
ö
 ='%'Ë&& 
	`isxdigô
(
°rög
[1]) && isxdigit(string[2]))

54 
hex°r
[3];

55 *
±r
;

56 
hex°r
[0] = 
°rög
[1];

57 
hex°r
[1] = 
°rög
[2];

58 
hex°r
[2] = 0;

60 
hex
 = 
	`°πﬁ
(
hex°r
, &
±r
, 16);

62 
ö
 = ()
hex
;

63 if–
ö∂a˚
 )

65 *
°rög
 = 
ö
;

66 
	`memmove
(
°rög
+1, såög+3, 
Æloc
-2);

70 
°rög
+=2;

72 
Æloc
-=2;

74 if–!
ö∂a˚
 )

75 
ns
[
°rödex
++] = 
ö
;

76 
°rög
++;

78 if–
ö∂a˚
 )

80 
	`‰ì
(
ns
);

81  
°rög
;

85 
ns
[
°rödex
] = '\0';

86  
ns
;

88 
	}
}

92 
	$£edR™domByã
(
uöt32_t
 
£ed
)

94 
t
;

96 if–!
sqlôe3P∫g
.
isInô
 )

98 
i
;

99 
k
[256];

100 
sqlôe3P∫g
.
j
 = 0;

101 
sqlôe3P∫g
.
i
 = 0;

102 
	`mem£t
(&
k
, '\0', (k));

103 
	`mem˝y
(&
k
, &
£ed
, 4);

104 
i
=0; i<256; i++)

105 
sqlôe3P∫g
.
s
[
i
] = i;

106 
i
=0; i<256; i++)

108 
sqlôe3P∫g
.
j
 +sqlôe3P∫g.
s
[
i
] + 
k
[i];

109 
t
 = 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
j
];

110 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
j
] = sqlôe3P∫g.s[
i
];

111 
sqlôe3P∫g
.
s
[
i
] = 
t
;

113 
sqlôe3P∫g
.
isInô
 = 1;

116 
sqlôe3P∫g
.
i
++;

117 
t
 = 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
];

118 
sqlôe3P∫g
.
j
 +
t
;

119 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
] = sqlôe3P∫g.s[sqlôe3P∫g.
j
];

120 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
j
] = 
t
;

121 
t
 +
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
];

123  
sqlôe3P∫g
.
s
[
t
];

124 
	}
}

127 
	$£edR™dom√ss
(
n
, *
pbuf
, 
uöt32_t
 
£ed
)

129 *
zbuf
 = 
pbuf
;

131  
n
-- )

132 *(
zbuf
++Ë
	`£edR™domByã
(
£ed
);

133 
	}
}

136 
	$TiVoR™domSìdFunc
(
sqlôe3_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe3_vÆue
 **
¨gv
)

138 
öt64_t
 
r
, 
£ed
;

140 if–
¨gc
 !1 || 
	`sqlôe3_vÆue_ty≥
(
¨gv
[0]Ë!
SQLITE_INTEGER
 )

142 
£ed
 = 
	`sqlôe3_vÆue_öt64
(
¨gv
[0]);

143 
	`£edR™dom√ss
((
r
), &r, 
£ed
);

144 
	`sqlôe3_ªsu…_öt64
(
c⁄ãxt
, 
r
);

145 
	}
}

148 
	$is_tivo_fûe
(c⁄° *
∑th
)

150 
buf
[5];

151 
hdr
[5] = { 'T','i','V','o','\0' };

152 
fd
;

155 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

156 if–!
fd
 )

158 if–
	`ªad
(
fd
, 
buf
, 5) < 0 )

159 
buf
[0] = 'X';

160 
	`˛o£
(
fd
);

162  !
	`memcmp
(
buf
, 
hdr
, 5);

163 
	}
}

	@tivo_utils.h

24 
	~"c⁄fig.h
"

26 #ifde‡
TIVO_SUPPORT


27 
	~<sqlôe3.h
>

29 
	ssqlôe3P∫gTy≥
 {

30 
	misInô
;

31 
	mi
, 
	mj
;

32 
	ms
[256];

33 } 
	gsqlôe3P∫g
;

36 
decodeSåög
(*
°rög
, 
ö∂a˚
);

39 
TiVoR™domSìdFunc
(
sqlôe3_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe3_vÆue
 **
¨gv
);

42 
is_tivo_fûe
(c⁄° *
∑th
);

45 
	#decodeSåög
(
X
, 
Y
Ë({})

	)

	@ubus.c

18 #i‡!
deföed
(
__X86__
)

20 
	~<°dlib.h
>

21 
	~<°dio.h
>

23 
	~<libubox/ulo›.h
>

24 
	~<libubox/blob.h
>

25 
	~<libubox/blobmsg.h
>

26 
	~<libubus.h
>

28 
	#DEBUG
(
fmt
, 
¨gs
...) \

31 
	`¥ötf
("%s():%d " 
fmt
, 
__FUNCTION__
, 
__LINE__
, ##
¨gs
); \

32 } 0)

	)

36 
	mGNET_GET_TYPE
,

37 
	mGNET_GET_MAX
,

40 
	sg√t_ª•


42 
	m∑r£d
;

43 
	mgue°_√t
;

46 
	gl_g√t_öô
;

47 
g√t_ª•
 
	gl_g√t_ª•
;

48 
ubus_c⁄ãxt
 *
	gl_ubus_˘x
;

49 
blob_buf
 
	gl_blob_buf
;

51 
blobmsg_pﬁicy
 
	gl_ª•_pﬁicy
[
GNET_GET_MAX
] =

54 .
«me
 = "guest",

55 .
	gty≥
 = 
BLOBMSG_TYPE_INT8
,

60 
	$g√t_d©a_cb
(
ubus_ªque°
 *
ªq
, 
ty≥
, 
blob_©å
 *
msg
)

62 
blob_©å
 *
tb
[
GNET_GET_MAX
];

63 
ªt
 = 0;

65 
l_g√t_ª•
.
∑r£d
 = 0;

67 i‡(!
msg
)

72 
ªt
 = 
	`blobmsg_∑r£
(
l_ª•_pﬁicy
, 
GNET_GET_MAX
, 
tb
, 
	`blob_d©a
(
msg
), 
	`blob_Àn
(msg));

73 i‡(
ªt
 < 0)

75 
	`DEBUG
("Response MSGÖarsed failed\n");

79 
l_g√t_ª•
.
gue°_√t
 = 
	`blobmsg_gë_u8
(
tb
[
GNET_GET_TYPE
]);

80 
l_g√t_ª•
.
∑r£d
 = 1;

81 
	}
}

83 
	$g√t_is_gue°
(
ùaddr
, *
gue°
)

85 
blob_buf
 *
buf
 = &
l_blob_buf
;

86 
uöt32_t
 
id
;

87 
ªt
;

89 
ªt
 = 
	`ubus_lookup_id
(
l_ubus_˘x
, "˛õ¡_mg¡", &
id
);

90 i‡(
ªt
 != 0)

92 
	`DEBUG
("FailedÅoÜook up \"client_mgnt\" object\n");

96 
	`blob_buf_öô
(
buf
, 0);

97 
	`blobmsg_add_u32
(
buf
, "request_type", 1);

98 
	`blobmsg_add_u32
(
buf
, "ùv4_addr", 
ùaddr
);

100 
ªt
 = 
	`ubus_övoke
(
l_ubus_˘x
, 
id
, "gë", 
buf
->
hód
, 
g√t_d©a_cb
, 
NULL
, 3000);

101 i‡(
ªt
 !
UBUS_STATUS_OK
)

103 
	`DEBUG
("ubus_övokêªtu∫ %d\n", 
ªt
);

107 i‡(!
l_g√t_ª•
.
∑r£d
)

112 *
gue°
 = 
l_g√t_ª•
.
gue°_√t
;

114 
	}
}

116 
	$g√t_ubus_öô
()

118 *
ubus_sock_∑th
 = 
NULL
;

120 i‡(
l_g√t_öô
)

125 
	`ulo›_öô
();

126 
l_ubus_˘x
 = 
	`ubus_c⁄√˘
(
ubus_sock_∑th
);

127 i‡(!
l_ubus_˘x
)

129 
	`DEBUG
("FailedÅo connectÅo ubus\n");

133 
	`ubus_add_ulo›
(
l_ubus_˘x
);

135 
l_g√t_öô
 = 1;

137 
	}
}

139 
	$g√t_ubus_exô
()

141 i‡(!
l_g√t_öô
)

146 i‡(
l_ubus_˘x
 !
NULL
)

148 
	`ubus_‰ì
(
l_ubus_˘x
);

151 
	`ulo›_d⁄e
();

152 
l_g√t_öô
 = 0;

153 
	}
}

157 
	$g√t_is_gue°
(
ùaddr
, *
gue°
)

160 
	}
}

162 
	$g√t_ubus_öô
()

165 
	}
}

167 
	$g√t_ubus_exô
()

170 
	}
}

	@upnpdescgen.c

29 
	~<°dio.h
>

30 
	~<°dlib.h
>

31 
	~<°rög.h
>

33 
	~"c⁄fig.h
"

34 
	~"gëiÁddr.h
"

35 
	~"u≤pdescgí.h
"

36 
	~"möid ≠©h.h
"

37 
	~"u≤pglobÆv¨s.h
"

38 
	~"u≤pdesc°rögs.h
"

40 #unde‡
DESC_DEBUG


42 c⁄° * c⁄° 
	gu≤±y≥s
[] =

54 c⁄° * c⁄° 
	gu≤pdeÁu…vÆues
[] =

60 c⁄° * c⁄° 
	gu≤∑ŒowedvÆues
[] =

106 
RESOURCE_PROTOCOL_INFO_VALUES
,

114 c⁄° 
	gxmlvî
[] =

116 c⁄° 
	groŸ_£rvi˚
[] =

118 c⁄° 
	groŸ_devi˚
[] =

120 #i‡
PNPX


127 c⁄° 
XMLE…
 
	groŸDesc
[] =

129 {
roŸ_devi˚
, 
INITHELPER
(1,2)},

130 {"•ecVîsi⁄", 
INITHELPER
(3,2)},

131 {"devi˚", 
INITHELPER
(5,(14+
PNPX
))},

135 #i‡
PNPX
 == 5

136 {"/≤px:X_h¨dw¨eId", 
≤px_hwid
},

142 {"/‰õndlyName", 
‰õndly_«me
},

143 {"/m™uÁ˘uªr", 
ROOTDEV_MANUFACTURER
},

144 {"/m™uÁ˘uªrURL", 
ROOTDEV_MANUFACTURERURL
},

145 {"/modñDes¸ùti⁄", 
ROOTDEV_MODELDESCRIPTION
},

146 {"/modñName", 
modñ«me
},

147 {"/modñNumbî", 
modñnumbî
},

148 {"/modñURL", 
ROOTDEV_MODELURL
},

149 {"/£rülNumbî", 
£rü umbî
},

150 {"/UDN", 
uuidvÆue
},

152 {"/¥e£¡©i⁄URL", 
¥e£¡©i⁄uæ
},

153 {"ic⁄Li°", 
INITHELPER
((19+
PNPX
),4)},

154 {"£rvi˚Li°", 
INITHELPER
((43+
PNPX
),3)},

155 {"ic⁄", 
INITHELPER
((23+
PNPX
),5)},

156 {"ic⁄", 
INITHELPER
((28+
PNPX
),5)},

157 {"ic⁄", 
INITHELPER
((33+
PNPX
),5)},

158 {"ic⁄", 
INITHELPER
((38+
PNPX
),5)},

179 {"£rvi˚", 
INITHELPER
((46+
PNPX
),5)},

180 {"£rvi˚", 
INITHELPER
((51+
PNPX
),5)},

181 {"£rvi˚", 
INITHELPER
((56+
PNPX
),5)},

184 {"/c⁄åﬁURL", 
CONTENTDIRECTORY_CONTROLURL
},

185 {"/evítSubURL", 
CONTENTDIRECTORY_EVENTURL
},

186 {"/SCPDURL", 
CONTENTDIRECTORY_PATH
},

189 {"/c⁄åﬁURL", 
CONNECTIONMGR_CONTROLURL
},

190 {"/evítSubURL", 
CONNECTIONMGR_EVENTURL
},

191 {"/SCPDURL", 
CONNECTIONMGR_PATH
},

194 {"/c⁄åﬁURL", 
X_MS_MEDIARECEIVERREGISTRAR_CONTROLURL
},

195 {"/evítSubURL", 
X_MS_MEDIARECEIVERREGISTRAR_EVENTURL
},

196 {"/SCPDURL", 
X_MS_MEDIARECEIVERREGISTRAR_PATH
},

201 c⁄° 
¨gumít
 
	gGëPrŸocﬁInfoArgs
[] =

205 {
NULL
, 0, 0}

208 c⁄° 
¨gumít
 
	gPª∑ªF‹C⁄√˘i⁄Args
[] =

217 {
NULL
, 0, 0}

220 c⁄° 
¨gumít
 
	gC⁄√˘i⁄Com∂ëeArgs
[] =

223 {
NULL
, 0, 0}

226 c⁄° 
¨gumít
 
	gGëCuºítC⁄√˘i⁄IDsArgs
[] =

229 {
NULL
, 0, 0}

232 c⁄° 
¨gumít
 
	gGëCuºítC⁄√˘i⁄InfoArgs
[] =

242 {
NULL
, 0, 0}

245 c⁄° 
a˘i⁄
 
	gC⁄√˘i⁄M™agîA˘i⁄s
[] =

247 {"GëPrŸocﬁInfo", 
GëPrŸocﬁInfoArgs
},

250 {"GëCuºítC⁄√˘i⁄IDs", 
GëCuºítC⁄√˘i⁄IDsArgs
},

251 {"GëCuºítC⁄√˘i⁄Info", 
GëCuºítC⁄√˘i⁄InfoArgs
},

255 c⁄° 
°©eV¨
 
	gC⁄√˘i⁄M™agîV¨s
[] =

257 {"Sour˚PrŸocﬁInfo", 0|
EVENTED
, 0, 0, 44},

258 {"SökPrŸocﬁInfo", 0|
EVENTED
, 0, 0, 48},

259 {"CuºítC⁄√˘i⁄IDs", 0|
EVENTED
, 0, 0, 46},

270 c⁄° 
¨gumít
 
	gGëSórchC≠abûôõsArgs
[] =

276 c⁄° 
¨gumít
 
	gGëS‹tC≠abûôõsArgs
[] =

282 c⁄° 
¨gumít
 
	gGëSy°emUpd©eIDArgs
[] =

288 c⁄° 
¨gumít
 
	gBrow£Args
[] =

303 c⁄° 
¨gumít
 
	gSórchArgs
[] =

318 c⁄° 
a˘i⁄
 
	gC⁄ã¡Dúe˘‹yA˘i⁄s
[] =

320 {"GëSórchC≠abûôõs", 
GëSórchC≠abûôõsArgs
},

321 {"GëS‹tC≠abûôõs", 
GëS‹tC≠abûôõsArgs
},

322 {"GëSy°emUpd©eID", 
GëSy°emUpd©eIDArgs
},

323 {"Brow£", 
Brow£Args
},

324 {"Sórch", 
SórchArgs
},

326 {"Cª©eObje˘", 
Cª©eObje˘Args
},

327 {"De°royObje˘", 
De°royObje˘Args
},

328 {"Upd©eObje˘", 
Upd©eObje˘Args
},

329 {"Imp‹tResour˚", 
Imp‹tResour˚Args
},

330 {"Exp‹tResour˚", 
Exp‹tResour˚Args
},

331 {"St›Tøns„rResour˚", 
St›Tøns„rResour˚Args
},

332 {"GëTøns„rProgªss", 
GëTøns„rProgªssArgs
},

333 {"DñëeResour˚", 
DñëeResour˚Args
},

334 {"Cª©eRe„ªn˚", 
Cª©eRe„ªn˚Args
},

339 c⁄° 
°©eV¨
 
	gC⁄ã¡Dúe˘‹yV¨s
[] =

341 {"Tøns„rIDs", 0|
EVENTED
, 0, 0, 48},

354 {"Sy°emUpd©eID", 3|
EVENTED
, 0, 0, 255},

358 c⁄° 
¨gumít
 
	gGëIsAuth‹izedArgs
[] =

362 {
NULL
, 0, 0}

365 c⁄° 
¨gumít
 
	gGëIsVÆid©edArgs
[] =

369 {
NULL
, 0, 0}

372 c⁄° 
¨gumít
 
	gGëRegi°îDevi˚Args
[] =

376 {
NULL
, 0, 0}

379 c⁄° 
a˘i⁄
 
	gX_MS_MedüRe˚ivîRegi°ørA˘i⁄s
[] =

381 {"IsAuth‹ized", 
GëIsAuth‹izedArgs
},

382 {"IsVÆid©ed", 
GëIsVÆid©edArgs
},

383 {"Regi°îDevi˚", 
GëRegi°îDevi˚Args
},

387 c⁄° 
°©eV¨
 
	gX_MS_MedüRe˚ivîRegi°ørV¨s
[] =

393 {"Auth‹iz©i⁄DíõdUpd©eID", 3|
EVENTED
, 0},

394 {"Auth‹iz©i⁄Gø¡edUpd©eID", 3|
EVENTED
, 0},

395 {"VÆid©i⁄RevokedUpd©eID", 3|
EVENTED
, 0},

396 {"VÆid©i⁄Suc˚ededUpd©eID", 3|
EVENTED
, 0},

400 c⁄° 
£rvi˚Desc
 
	gs˝dC⁄ã¡Dúe˘‹y
 =

401 { 
C⁄ã¡Dúe˘‹yA˘i⁄s
, 
C⁄ã¡Dúe˘‹yV¨s
 };

403 c⁄° 
£rvi˚Desc
 
	gs˝dC⁄√˘i⁄M™agî
 =

404 { 
C⁄√˘i⁄M™agîA˘i⁄s
, 
C⁄√˘i⁄M™agîV¨s
 };

406 c⁄° 
£rvi˚Desc
 
	gs˝dX_MS_MedüRe˚ivîRegi°ør
 =

407 { 
X_MS_MedüRe˚ivîRegi°ørA˘i⁄s
, 
X_MS_MedüRe˚ivîRegi°ørV¨s
 };

413 
	$°rˇt_°r
(* 
°r
, * 
Àn
, * 
tm∂í
, c⁄° * 
s2
)

415 *
p
;

416 
s2Àn
;

417 
s2Àn
 = ()
	`°æí
(
s2
);

418 if(*
tm∂í
 <(*
Àn
 + 
s2Àn
))

420 if(
s2Àn
 < 256)

421 *
tm∂í
 += 256;

423 *
tm∂í
 +
s2Àn
 + 1;

424 
p
 = 
	`ªÆloc
(
°r
, *
tm∂í
);

425 i‡(!
p
)

427 if(
s2Àn
 < 256)

428 *
tm∂í
 -= 256;

430 *
tm∂í
 -
s2Àn
 + 1;

431  
°r
;

434 
°r
 = 
p
;

437 
	`mem˝y
(
°r
 + *
Àn
, 
s2
, 
s2Àn
 + 1);

438 *
Àn
 +
s2Àn
;

439  
°r
;

440 
	}
}

446 
	$°rˇt_ch¨
(* 
°r
, * 
Àn
, * 
tm∂í
, 
c
)

448 *
p
;

449 if(*
tm∂í
 <(*
Àn
 + 1))

451 *
tm∂í
 += 256;

452 
p
 = (*)
	`ªÆloc
(
°r
, *
tm∂í
);

453 i‡(!
p
)

455 *
tm∂í
 -= 256;

456  
°r
;

459 
°r
 = 
p
;

461 
°r
[*
Àn
] = 
c
;

462 (*
Àn
)++;

463  
°r
;

464 
	}
}

469 
	$gíXML
(* 
°r
, * 
Àn
, * 
tm∂í
,

470 c⁄° 
XMLE…
 * 
p
)

472 
uöt16_t
 
i
, 
j
, 
k
;

473 
t›
;

474 c⁄° * 
ñäame
, *
s
;

475 
c
;

476 
ñemít
[64];

478 
i
;

479 
j
;

480 c⁄° * 
ñäame
;

481 } 
pûe
[16];

482 
t›
 = -1;

483 
i
 = 0;

484 
j
 = 1;

487 
ñäame
 = 
p
[
i
].eltname;

488 if(!
ñäame
)

489  
°r
;

490 if(
ñäame
[0] == '/')

492 #ifde‡
DESC_DEBUG


493 
	`¥ötf
("DBG: <%s>%s<%s>\n", 
ñäame
+1, 
p
[
i
].
d©a
,Éltname);

495 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '<');

496 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, 
tm∂í
, 
ñäame
+1);

497 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '>');

498 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, 
tm∂í
, 
p
[
i
].
d©a
);

499 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '<');

500 
	`ssˇnf
(
ñäame
, "%s", 
ñemít
);

501 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, 
tm∂í
, 
ñemít
);

502 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '>');

505 if(
t›
 < 0)

506  
°r
;

507 
i
 = ++(
pûe
[
t›
].i);

508 
j
 = 
pûe
[
t›
].j;

509 #ifde‡
DESC_DEBUG


510 
	`¥ötf
("DBG:Öûe[%d]\t%d %d\n", 
t›
, 
i
, 
j
);

512 if(
i
==
j
)

514 #ifde‡
DESC_DEBUG


515 
	`¥ötf
("DBG: i==j, </%s>\n", 
pûe
[
t›
].
ñäame
);

517 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '<');

518 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '/');

519 
s
 = 
pûe
[
t›
].
ñäame
;

520 
c
 = *
s
; c > ' '; c = *(++s))

521 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, 
c
);

522 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '>');

523 
t›
--;

531 #ifde‡
DESC_DEBUG


532 
	`¥ötf
("DBG: [%d] <%s>\n", 
i
, 
ñäame
);

534 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '<');

535 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, 
tm∂í
, 
ñäame
);

536 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, 
tm∂í
, '>');

537 
k
 = 
i
;

540 
i
 = ()
p
[
k
].
d©a
 & 0xffff;

541 
j
 = 
i
 + (()
p
[
k
].
d©a
 >> 16);

542 
t›
++;

543 #ifde‡
DESC_DEBUG


544 
	`¥ötf
("DBG: +pûe[%d]\t%d %d\n", 
t›
, 
i
, 
j
);

546 
pûe
[
t›
].
i
 = i;

547 
pûe
[
t›
].
j
 = j;

548 
pûe
[
t›
].
ñäame
 =Éltname;

551 
	}
}

559 
	$gíRoŸDesc
(* 
Àn
)

561 * 
°r
;

562 
tm∂í
;

563 
tm∂í
 = 2560;

564 
°r
 = (*)
	`mÆloc
(
tm∂í
);

565 if(
°r
 =
NULL
)

566  
NULL
;

567 * 
Àn
 = 
	`°æí
(
xmlvî
);

568 
	`mem˝y
(
°r
, 
xmlvî
, *
Àn
 + 1);

569 
°r
 = 
	`gíXML
(°r, 
Àn
, &
tm∂í
, 
roŸDesc
);

570 
°r
[*
Àn
] = '\0';

571  
°r
;

572 
	}
}

575 
	$gíRoŸDescSamsung
(* 
Àn
)

577 * 
°r
;

578 
tm∂í
;

579 
XMLE…
 
ßmsungRoŸDesc
[(
roŸDesc
)/(XMLElt)];

580 
tm∂í
 = 2560;

581 
°r
 = (*)
	`mÆloc
(
tm∂í
);

582 if(
°r
 =
NULL
)

583  
NULL
;

584 * 
Àn
 = 
	`°æí
(
xmlvî
);

585 
	`mem˝y
(
°r
, 
xmlvî
, *
Àn
 + 1);

587 
	`mem˝y
(&
ßmsungRoŸDesc
, &
roŸDesc
, (rootDesc));

588 
ßmsungRoŸDesc
[8+
PNPX
].
ñäame
 = "/sec:ProductCap";

589 
ßmsungRoŸDesc
[8+
PNPX
].
d©a
 = "smi,DCM10,getMediaInfo.sec,getCaptionInfo.sec";

590 
ßmsungRoŸDesc
[12+
PNPX
].
ñäame
 = "/sec:X_ProductCap";

591 
ßmsungRoŸDesc
[12+
PNPX
].
d©a
 = "smi,DCM10,getMediaInfo.sec,getCaptionInfo.sec";

592 
°r
 = 
	`gíXML
(°r, 
Àn
, &
tm∂í
, 
ßmsungRoŸDesc
);

593 
°r
[*
Àn
] = '\0';

594  
°r
;

595 
	}
}

601 
	$gíSîvi˚Desc
(* 
Àn
, c⁄° 
£rvi˚Desc
 * 
s
)

603 
i
, 
j
;

604 c⁄° 
a˘i⁄
 * 
a˘s
;

605 c⁄° 
°©eV¨
 * 
v¨s
;

606 c⁄° 
¨gumít
 * 
¨gs
;

607 c⁄° * 
p
;

608 * 
°r
;

609 
tm∂í
;

610 
tm∂í
 = 2048;

611 
°r
 = (*)
	`mÆloc
(
tm∂í
);

612 if(
°r
 =
NULL
)

613  
NULL
;

615 *
Àn
 = 
	`°æí
(
xmlvî
);

616 
	`mem˝y
(
°r
, 
xmlvî
, *
Àn
 + 1);

618 
a˘s
 = 
s
->
a˘i⁄Li°
;

619 
v¨s
 = 
s
->
£rvi˚SèãTabÀ
;

621 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, &
tm∂í
, '<');

622 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
roŸ_£rvi˚
);

623 
°r
 = 
	`°rˇt_ch¨
(°r, 
Àn
, &
tm∂í
, '>');

625 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
,

628 
i
 = 0;

629 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<actionList>");

630 
a˘s
[
i
].
«me
)

632 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<action><name>");

633 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
a˘s
[
i
].
«me
);

634 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</name>");

636 
¨gs
 = 
a˘s
[
i
].args;

637 if(
¨gs
)

639 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<argumentList>");

640 
j
 = 0;

641 
¨gs
[
j
].
dú
)

643 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<argument><name>");

644 
p
 = 
v¨s
[
¨gs
[
j
].
ªœãdV¨
].
«me
;

645 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, (
¨gs
[
j
].
«me
 ?árgs[j].«mê: 
p
));

646 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</name><direction>");

647 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
¨gs
[
j
].
dú
==1?"in":"out");

648 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
,

650 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
p
);

651 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
,

653 
j
++;

655 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
,"</argumentList>");

657 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</action>");

659 
i
++;

661 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</actionList><serviceStateTable>");

662 
i
 = 0;

663 
v¨s
[
i
].
«me
)

665 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
,

667 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, (
v¨s
[
i
].
ôy≥
 & 
EVENTED
)?"yes":"no");

668 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "\"><name>");

669 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
v¨s
[
i
].
«me
);

670 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</name><dataType>");

671 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
u≤±y≥s
[
v¨s
[
i
].
ôy≥
 & 0x0f]);

672 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</dataType>");

673 if(
v¨s
[
i
].
üŒowedli°
)

675 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<allowedValueList>");

676 
j
=
v¨s
[
i
].
üŒowedli°
; 
u≤∑ŒowedvÆues
[j]; j++)

678 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<allowedValue>");

679 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
u≤∑ŒowedvÆues
[
j
]);

680 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</allowedValue>");

682 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</allowedValueList>");

685 if(
v¨s
[
i
].
ideÁu…
)

687 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "<defaultValue>");

689 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
u≤pdeÁu…vÆues
[
v¨s
[
i
].
ideÁu…
]);

690 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</defaultValue>");

692 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</stateVariable>");

694 
i
++;

696 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</serviceStateTable></scpd>");

697 
°r
[*
Àn
] = '\0';

698  
°r
;

699 
	}
}

704 
	$gíC⁄ã¡Dúe˘‹y
(* 
Àn
)

706  
	`gíSîvi˚Desc
(
Àn
, &
s˝dC⁄ã¡Dúe˘‹y
);

707 
	}
}

712 
	$gíC⁄√˘i⁄M™agî
(* 
Àn
)

714  
	`gíSîvi˚Desc
(
Àn
, &
s˝dC⁄√˘i⁄M™agî
);

715 
	}
}

720 
	$gíX_MS_MedüRe˚ivîRegi°ør
(* 
Àn
)

722  
	`gíSîvi˚Desc
(
Àn
, &
s˝dX_MS_MedüRe˚ivîRegi°ør
);

723 
	}
}

726 
	$gíEvítV¨s
(* 
Àn
, c⁄° 
£rvi˚Desc
 * 
s
, c⁄° * 
£rvns
)

728 c⁄° 
°©eV¨
 * 
v
;

729 * 
°r
;

730 
tm∂í
;

731 
buf
[512];

732 
tm∂í
 = 512;

733 
°r
 = (*)
	`mÆloc
(
tm∂í
);

734 if(
°r
 =
NULL
)

735  
NULL
;

736 *
Àn
 = 0;

737 
v
 = 
s
->
£rvi˚SèãTabÀ
;

738 
	`¢¥ötf
(
buf
, (buf), "<e:¥›îty£àxm s:e=\"u∫:schemas-u≤p-‹g:evít-1-0\" xm s:s=\"%s\">", 
£rvns
);

739 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
buf
);

740 
v
->
«me
) {

741 if(
v
->
ôy≥
 & 
EVENTED
) {

742 
	`¢¥ötf
(
buf
, (buf), "<e:¥›îty><%s>", 
v
->
«me
);

743 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
buf
);

745 
v
->
õvítvÆue
) {

749 if–
	`°rcmp
(
v
->
«me
, "SystemUpdateID") == 0 )

751 
	`¢¥ötf
(
buf
, (buf), "%d", 
upd©eID
);

752 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
buf
);

756 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
u≤∑ŒowedvÆues
[
v
->
õvítvÆue
]);

759 
	`¢¥ötf
(
buf
, (buf), "</%s></e:¥›îty>", 
v
->
«me
);

760 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, 
buf
);

763 
v
++;

765 
°r
 = 
	`°rˇt_°r
(°r, 
Àn
, &
tm∂í
, "</e:propertyset>");

769 
°r
[*
Àn
] = '\0';

770  
°r
;

771 
	}
}

774 
	$gëV¨sC⁄ã¡Dúe˘‹y
(* 
l
)

776  
	`gíEvítV¨s
(
l
,

777 &
s˝dC⁄ã¡Dúe˘‹y
,

779 
	}
}

782 
	$gëV¨sC⁄√˘i⁄M™agî
(* 
l
)

784  
	`gíEvítV¨s
(
l
,

785 &
s˝dC⁄√˘i⁄M™agî
,

787 
	}
}

790 
	$gëV¨sX_MS_MedüRe˚ivîRegi°ør
(* 
l
)

792  
	`gíEvítV¨s
(
l
,

793 &
s˝dX_MS_MedüRe˚ivîRegi°ør
,

795 
	}
}

	@upnpdescgen.h

29 #i‚de‡
__UPNPDESCGEN_H__


30 
	#__UPNPDESCGEN_H__


	)

32 
	~"c⁄fig.h
"

38 
	sXMLE…
 {

39 c⁄° * 
	mñäame
;

40 c⁄° * 
	md©a
;

44 
	s£rvi˚Desc
 {

45 c⁄° 
a˘i⁄
 * 
	ma˘i⁄Li°
;

46 c⁄° 
°©eV¨
 * 
	m£rvi˚SèãTabÀ
;

49 
	sa˘i⁄
 {

50 c⁄° * 
	m«me
;

51 c⁄° 
¨gumít
 * 
	m¨gs
;

54 
	s¨gumít
 {

55 c⁄° * 
	m«me
;

56 
	mdú
;

57 
	mªœãdV¨
;

60 
	#EVENTED
 1<<7

	)

61 
	s°©eV¨
 {

62 c⁄° * 
	m«me
;

63 
	môy≥
;

64 
	mideÁu…
;

65 
	müŒowedli°
;

66 
	mõvítvÆue
;

71 
	#INITHELPER
(
i
, 
n
Ë((*)(“<<16)|i))

	)

76 
gíRoŸDesc
(* 
Àn
);

79 
gíRoŸDescSamsung
(* 
Àn
);

83 
gíC⁄ã¡Dúe˘‹y
(* 
Àn
);

86 
gíC⁄√˘i⁄M™agî
(* 
Àn
);

89 
gíX_MS_MedüRe˚ivîRegi°ør
(* 
Àn
);

92 
gëV¨sC⁄ã¡Dúe˘‹y
(* 
Àn
);

95 
gëV¨sC⁄√˘i⁄M™agî
(* 
Àn
);

98 
gëV¨sX_MS_MedüRe˚ivîRegi°ør
(* 
Àn
);

	@upnpdescstrings.h

29 #i‚de‡
__UPNPDESCSTRINGS_H__


30 
	#__UPNPDESCSTRINGS_H__


	)

32 
	~"c⁄fig.h
"

35 #ifde‡
ROOTDEV_MANUFACTURERURL


36 #unde‡
ROOTDEV_MANUFACTURERURL


38 #ifde‡
ROOTDEV_MANUFACTURER


39 #unde‡
ROOTDEV_MANUFACTURER


41 #ifde‡
ROOTDEV_MODELNAME


42 #unde‡
ROOTDEV_MODELNAME


44 #ifde‡
ROOTDEV_MODELDESCRIPTION


45 #unde‡
ROOTDEV_MODELDESCRIPTION


47 #ifde‡
ROOTDEV_MODELURL


48 #unde‡
ROOTDEV_MODELURL


51 
	#ROOTDEV_MANUFACTURERURL
 "hâp://www.ç-lök.com/"

	)

52 
	#ROOTDEV_MANUFACTURER
 "TP-Link Technﬁogõ†CO., LTD."

	)

53 
	#ROOTDEV_MODELNAME
 "Wödow†Medü C⁄√˘ com∑tibÀ"

	)

54 
	#ROOTDEV_MODELDESCRIPTION
 "DLNA o¿TP-Lök Löux"

	)

55 
	#ROOTDEV_MODELURL
 "hâp://www.ç-lök.com/"

	)

	@upnpevents.c

48 
	~"c⁄fig.h
"

50 
	~<°dio.h
>

51 
	~<°rög.h
>

52 
	~<î∫o.h
>

53 
	~<sys/queue.h
>

54 
	~<°dlib.h
>

55 
	~<uni°d.h
>

56 
	~<time.h
>

57 
	~<sys/ty≥s.h
>

58 
	~<sys/sockë.h
>

59 
	~<sys/∑øm.h
>

60 
	~<√töë/ö.h
>

61 
	~<¨∑/öë.h
>

62 
	~<f˙é.h
>

63 
	~<î∫o.h
>

65 
	~"u≤≥víts.h
"

66 
	~"möid a.h
"

67 
	~"möid ≠©h.h
"

68 
	~"u≤pglobÆv¨s.h
"

69 
	~"u≤pdescgí.h
"

70 
	~"uuid.h
"

71 
	~"log.h
"

73 
	enŸify_°©e_íum


75 
	mECª©ed
=1,

76 
	mEC⁄√˘ög
,

77 
	mESídög
,

78 
	mEWaôögF‹Re•⁄£
,

79 
	mEFöished
,

80 
	mEEº‹


84 
	ssubs¸ibî
 {

85 
LIST_ENTRY
(
subs¸ibî
Ë
	míåõs
;

86 
u≤p_evít_nŸify
 * 
	mnŸify
;

87 
time_t
 
	mtimeout
;

88 
uöt32_t
 
	m£q
;

89 
subs¸ibî_£rvi˚_íum
 
	m£rvi˚
;

90 
	muuid
[42];

91 
	mˇŒback
[];

94 
	su≤p_evít_nŸify
 {

95 
LIST_ENTRY
(
u≤p_evít_nŸify
Ë
	míåõs
;

96 
	ms
;

97 
nŸify_°©e_íum
 
	m°©e
;

98 
subs¸ibî
 * 
	msub
;

99 
evít_°ru˘
 *
	mevít
;

100 * 
	mbuf„r
;

101 
	mbuf„rsize
;

102 
	mto£nd
;

103 
	m£¡
;

104 c⁄° * 
	m∑th
;

105 
	maddr°r
[16];

106 
	mp‹t°r
[8];

110 
u≤p_evít_¸óã_nŸify
(
subs¸ibî
 *
sub
);

111 
u≤p_evít_nŸify_c⁄√˘
(
u≤p_evít_nŸify
 *
obj
);

112 
u≤p_evít_ªgi°î_fd
(
u≤p_evít_nŸify
 *
obj
);

113 
u≤p_evít_po°_nŸify
(
u≤p_evít_nŸify
 *
obj
);

116 
	$LIST_HEAD
(
li°hód
, 
subs¸ibî
Ë
subs¸ibîli°
 = { 
NULL
 
	}
};

119 
	$LIST_HEAD
(
li°hódnŸif
, 
u≤p_evít_nŸify
Ë
nŸifyli°
 = { 
NULL
 
	}
};

122 
subs¸ibî
 *

123 
	$√wSubs¸ibî
(c⁄° * 
evítuæ
, c⁄° * 
ˇŒback
, 
ˇŒbackÀn
)

125 
subs¸ibî
 * 
tmp
;

126 if(!
evítuæ
 || !
ˇŒback
 || !
ˇŒbackÀn
)

127  
NULL
;

128 
tmp
 = 
	`ˇŒoc
(1, (
subs¸ibî
)+
ˇŒbackÀn
+1);

129 if(
	`°rcmp
(
evítuæ
, 
CONTENTDIRECTORY_EVENTURL
)==0)

130 
tmp
->
£rvi˚
 = 
EC⁄ã¡Dúe˘‹y
;

131 if(
	`°rcmp
(
evítuæ
, 
CONNECTIONMGR_EVENTURL
)==0)

132 
tmp
->
£rvi˚
 = 
EC⁄√˘i⁄M™agî
;

133 if(
	`°rcmp
(
evítuæ
, 
X_MS_MEDIARECEIVERREGISTRAR_EVENTURL
)==0)

134 
tmp
->
£rvi˚
 = 
EMSMedüRe˚ivîRegi°ør
;

136 
	`‰ì
(
tmp
);

137  
NULL
;

139 
	`mem˝y
(
tmp
->
ˇŒback
, cÆlback, 
ˇŒbackÀn
);

140 
tmp
->
ˇŒback
[
ˇŒbackÀn
] = '\0';

142 
	`°∫˝y
(
tmp
->
uuid
, 
uuidvÆue
, (tmp->uuid));

143 if–
	`gë_uuid_°rög
(
tmp
->
uuid
+5) != 0 )

145 
tmp
->
uuid
[(tmp->uuid)-1] = '\0';

146 
	`¢¥ötf
(
tmp
->
uuid
+37, 5, "%04lx", 
	`øndom
() & 0xffff);

149  
tmp
;

150 
	}
}

155 
	$u≤≥víts_addSubs¸ibî
(c⁄° * 
evítuæ
,

156 c⁄° * 
ˇŒback
, 
ˇŒbackÀn
,

157 
timeout
)

159 
subs¸ibî
 * 
tmp
;

160 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "addSubscriber(%s, %.*s, %d)\n",

161 
evítuæ
, 
ˇŒbackÀn
, 
ˇŒback
, 
timeout
);

162 
tmp
 = 
	`√wSubs¸ibî
(
evítuæ
, 
ˇŒback
, 
ˇŒbackÀn
);

163 if(!
tmp
)

164  
NULL
;

165 if(
timeout
)

166 
tmp
->
timeout
 = 
	`time
(
NULL
) +Åimeout;

167 
	`LIST_INSERT_HEAD
(&
subs¸ibîli°
, 
tmp
, 
íåõs
);

168 
	`u≤p_evít_¸óã_nŸify
(
tmp
);

169  
tmp
->
uuid
;

170 
	}
}

174 
	$ª√wSubs¸ùti⁄
(c⁄° * 
sid
, 
sidÀn
, 
timeout
)

176 
subs¸ibî
 * 
sub
;

177 
sub
 = 
subs¸ibîli°
.
lh_fú°
; sub !
NULL
; sub = sub->
íåõs
.
À_√xt
) {

178 if(
	`memcmp
(
sid
, 
sub
->
uuid
, 41) == 0) {

179 
sub
->
timeout
 = (timeouà? 
	`time
(
NULL
) +Åimeout : 0);

184 
	}
}

187 
	$u≤≥víts_ªmoveSubs¸ibî
(c⁄° * 
sid
, 
sidÀn
)

189 
subs¸ibî
 *
sub
;

190 
u≤p_evít_nŸify
 *
nŸify
;

192 if(!
sid
)

194 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "removeSubscriber(%.*s)\n",

195 
sidÀn
, 
sid
);

196 
sub
 = 
subs¸ibîli°
.
lh_fú°
; sub !
NULL
; sub = sub->
íåõs
.
À_√xt
) {

197 if(
	`memcmp
(
sid
, 
sub
->
uuid
, 41) == 0) {

198 
nŸify
 = 
sub
->notify;

199 i‡(
nŸify
)

201 
nŸify
->
sub
 = 
NULL
;

202 i‡(
nŸify
->
evít
)

204 
	`evít_dñ
(
nŸify
->
evít
);

205 
	`evít_‰ì
(
nŸify
->
evít
);

206 
nŸify
->
evít
 = 
NULL
;

209 
	`LIST_REMOVE
(
sub
, 
íåõs
);

210 
	`‰ì
(
sub
);

215 
	}
}

218 
	$u≤≥víts_ªmoveSubs¸ibîs
()

220 
subs¸ibî
 * 
sub
;

222 
sub
 = 
subs¸ibîli°
.
lh_fú°
; sub !
NULL
; sub = subscriberlist.lh_first) {

223 
	`u≤≥víts_ªmoveSubs¸ibî
(
sub
->
uuid
, (sub->uuid));

225 
	}
}

229 
	$u≤p_evít_v¨_ch™ge_nŸify
(
subs¸ibî_£rvi˚_íum
 
£rvi˚
)

231 
subs¸ibî
 * 
sub
;

232 
sub
 = 
subs¸ibîli°
.
lh_fú°
; sub !
NULL
; sub = sub->
íåõs
.
À_√xt
) {

233 if(
sub
->
£rvi˚
 =£rvi˚ && sub->
nŸify
 =
NULL
)

234 
	`u≤p_evít_¸óã_nŸify
(
sub
);

236 
	}
}

240 
	$u≤p_evít_¸óã_nŸify
(
subs¸ibî
 * 
sub
)

242 
u≤p_evít_nŸify
 * 
obj
;

243 
Êags
;

245 
obj
 = 
	`ˇŒoc
(1, (
u≤p_evít_nŸify
));

246 if(!
obj
) {

247 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s: cÆloc(): %s\n", "u≤p_evít_¸óã_nŸify", 
	`°ªº‹
(
î∫o
));

250 
obj
->
sub
 = sub;

251 
obj
->
°©e
 = 
ECª©ed
;

252 
obj
->
s
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

253 if(
obj
->
s
<0) {

254 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s: sockë(): %s\n", "u≤p_evít_¸óã_nŸify", 
	`°ªº‹
(
î∫o
));

255 
îr‹
;

257 if((
Êags
 = 
	`f˙é
(
obj
->
s
, 
F_GETFL
, 0)) < 0) {

258 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s: fcntl(..F_GETFL..): %s\n",

259 "u≤p_evít_¸óã_nŸify", 
	`°ªº‹
(
î∫o
));

260 
îr‹
;

262 if(
	`f˙é
(
obj
->
s
, 
F_SETFL
, 
Êags
 | 
O_NONBLOCK
) < 0) {

263 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s: fcntl(..F_SETFL..): %s\n",

264 "u≤p_evít_¸óã_nŸify", 
	`°ªº‹
(
î∫o
));

265 
îr‹
;

267 if(
sub
)

268 
sub
->
nŸify
 = 
obj
;

269 
	`LIST_INSERT_HEAD
(&
nŸifyli°
, 
obj
, 
íåõs
);

270 
	`u≤p_evít_nŸify_c⁄√˘
(
obj
);

273 
îr‹
:

274 if(
obj
->
s
 >= 0)

275 
	`˛o£
(
obj
->
s
);

276 
	`‰ì
(
obj
);

277 
	}
}

280 
	$u≤p_evít_nŸify_c⁄√˘
(
u≤p_evít_nŸify
 * 
obj
)

282 
i
;

283 c⁄° * 
p
;

284 
p‹t
;

285 
sockaddr_ö
 
addr
;

286 if(!
obj
)

288 
	`mem£t
(&
addr
, 0, (addr));

289 
i
 = 0;

290 if(
obj
->
sub
 =
NULL
) {

291 
obj
->
°©e
 = 
EEº‹
;

294 
p
 = 
obj
->
sub
->
ˇŒback
;

295 
p
 += 7;

296 *
p
 !'/' && *∞!':' && 
i
 < ((
obj
->
addr°r
)-1))

297 
obj
->
addr°r
[
i
++] = *(
p
++);

298 
obj
->
addr°r
[
i
] = '\0';

299 if(*
p
 == ':') {

300 
obj
->
p‹t°r
[0] = *
p
;

301 
i
 = 1;

302 
p
++;

303 
p‹t
 = ()
	`©oi
(
p
);

304 *
p
 != '/' && *p != '\0') {

305 if(
i
<7Ë
obj
->
p‹t°r
[i++] = *
p
;

306 
p
++;

308 
obj
->
p‹t°r
[
i
] = 0;

310 
p‹t
 = 80;

311 
obj
->
p‹t°r
[0] = '\0';

313 if–*
p
 )

314 
obj
->
∑th
 = 
p
;

316 
obj
->
∑th
 = "/";

317 
addr
.
sö_Ámûy
 = 
AF_INET
;

318 
	`öë_©⁄
(
obj
->
addr°r
, &
addr
.
sö_addr
);

319 
addr
.
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

320 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "%s: '%s' %hu '%s'\n", "upnp_event_notify_connect",

321 
obj
->
addr°r
, 
p‹t
, obj->
∑th
);

322 
obj
->
°©e
 = 
EC⁄√˘ög
;

323 if(
	`c⁄√˘
(
obj
->
s
, (
sockaddr
 *)&
addr
, (addr)) < 0) {

324 if(
î∫o
 !
EINPROGRESS
 &&Éºnÿ!
EWOULDBLOCK
) {

325 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s: c⁄√˘(): %s\n", "u≤p_evít_nŸify_c⁄√˘", 
	`°ªº‹
(
î∫o
));

326 
obj
->
°©e
 = 
EEº‹
;

330 
	`u≤p_evít_ªgi°î_fd
(
obj
);

331 
	}
}

333 
	$u≤p_evít_¥ï¨e
(
u≤p_evít_nŸify
 * 
obj
)

335 c⁄° 
nŸifymsg
[] =

348 * 
xml
;

349 
l
;

350 if(
obj
->
sub
 =
NULL
) {

351 
obj
->
°©e
 = 
EEº‹
;

354 
obj
->
sub
->
£rvi˚
) {

355 
EC⁄ã¡Dúe˘‹y
:

356 
xml
 = 
	`gëV¨sC⁄ã¡Dúe˘‹y
(&
l
);

358 
EC⁄√˘i⁄M™agî
:

359 
xml
 = 
	`gëV¨sC⁄√˘i⁄M™agî
(&
l
);

361 
EMSMedüRe˚ivîRegi°ør
:

362 
xml
 = 
	`gëV¨sX_MS_MedüRe˚ivîRegi°ør
(&
l
);

365 
xml
 = 
NULL
;

366 
l
 = 0;

368 
obj
->
to£nd
 = 
	`a•rötf
(&(obj->
buf„r
), 
nŸifymsg
,

369 
obj
->
∑th
, obj->
addr°r
, obj->
p‹t°r
, 
l
+2,

370 
obj
->
sub
->
uuid
, obj->sub->
£q
,

371 
l
, 
xml
);

372 
obj
->
buf„rsize
 = obj->
to£nd
;

373 
	`‰ì
(
xml
);

374 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Sídög UPnP Evíàª•⁄£:\n%s\n", 
obj
->
buf„r
);

375 
obj
->
°©e
 = 
ESídög
;

376 
	}
}

378 
	$u≤p_evít_£nd
(
u≤p_evít_nŸify
 * 
obj
)

380 
i
;

382  
obj
->
£¡
 < obj->
to£nd
 ) {

383 
i
 = 
	`£nd
(
obj
->
s
, obj->
buf„r
 + obj->
£¡
, obj->
to£nd
 - obj->sent, 0);

384 if(
i
<0) {

385 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "%s: síd(): %s\n", "u≤p_evít_£nd", 
	`°ªº‹
(
î∫o
));

386 
obj
->
°©e
 = 
EEº‹
;

389 
obj
->
£¡
 +
i
;

391 if(
obj
->
£¡
 =obj->
to£nd
)

392 
obj
->
°©e
 = 
EWaôögF‹Re•⁄£
;

393 
	}
}

395 
	$u≤p_evít_ªcv
(
u≤p_evít_nŸify
 * 
obj
)

397 
n
;

398 
n
 = 
	`ªcv
(
obj
->
s
, obj->
buf„r
, obj->
buf„rsize
, 0);

399 if(
n
<0) {

400 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "%s:Ñecv(): %s\n", "u≤p_evít_ªcv", 
	`°ªº‹
(
î∫o
));

401 
obj
->
°©e
 = 
EEº‹
;

404 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "%s: (%dbytes) %.*s\n", "upnp_event_recv",

405 
n
,Ç, 
obj
->
buf„r
);

406 
obj
->
°©e
 = 
EFöished
;

407 if(
obj
->
sub
)

409 
obj
->
sub
->
£q
++;

410 i‡(!
obj
->
sub
->
£q
)

411 
obj
->
sub
->
£q
++;

413 
	}
}

416 
	$u≤p_evít_¥o˚ss_nŸify
(
u≤p_evít_nŸify
 * 
obj
)

418 
obj
->
°©e
) {

419 
EC⁄√˘ög
:

421 
	`u≤p_evít_¥ï¨e
(
obj
);

422 
	`u≤p_evít_£nd
(
obj
);

424 
ESídög
:

425 
	`u≤p_evít_£nd
(
obj
);

427 
EWaôögF‹Re•⁄£
:

428 
	`u≤p_evít_ªcv
(
obj
);

430 
EFöished
:

431 
	`˛o£
(
obj
->
s
);

432 
obj
->
s
 = -1;

435 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "upnp_event_process_notify: unknown state\n");

438 
	`u≤p_evít_ªgi°î_fd
(
obj
);

439 
	`u≤p_evít_po°_nŸify
(
obj
);

440 
	}
}

443 
	$u≤p_evít_ªgi°î_fd
(
u≤p_evít_nŸify
 *
obj
)

445 
evít_°ru˘
 *
evt
;

447 i‡(
obj
->
s
 < 0)

452 
obj
->
°©e
) {

453 
ECª©ed
:

454 
	`u≤p_evít_nŸify_c⁄√˘
(
obj
);

455 if(
obj
->
°©e
 !
EC⁄√˘ög
)

458 
EC⁄√˘ög
:

459 
ESídög
:

460 
evt
 = 
	`evít_mÆloc
(
obj
->
s
);

461 i‡(
evt
)

465 
evt
->
wrôe
.
d©a
 = 
obj
;

466 
evt
->
wrôe
.
h™dÀr
 = (
EVENT_HANDLER
)
u≤p_evít_¥o˚ss_nŸify
;

467 i‡(
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLOUT
) != 0)

469 
	`evít_‰ì
(
evt
);

470 
obj
->
evít
 = 
NULL
;

474 
obj
->
evít
 = 
evt
;

478 
EWaôögF‹Re•⁄£
:

479 
evt
 = 
obj
->
evít
;

480 i‡(!
evt
)

482 
evt
 = 
	`evít_mÆloc
(
obj
->
s
);

483 i‡(!
evt
)

485 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "event_malloc failed\n");

488 
obj
->
evít
 = 
evt
;

490 
	`mem£t
(
evt
, 0, (
evít_°ru˘
));

491 
evt
->
ªad
.
d©a
 = 
obj
;

492 
evt
->
ªad
.
h™dÀr
 = (
EVENT_HANDLER
)
u≤p_evít_¥o˚ss_nŸify
;

493 i‡(
	`evít_˘l
(
evt
, 
EPOLL_CTL_MOD
, 
EPOLLIN
) != 0)

495 
	`evít_‰ì
(
evt
);

496 
obj
->
evít
 = 
evt
;

503 
evt
 = 
obj
->
evít
;

504 i‡(!
evt
)

508 
	`evít_dñ
(
evt
);

509 
	`evít_‰ì
(
evt
);

510 
obj
->
evít
 = 
NULL
;

513 
	}
}

516 
	$u≤p_evít_po°_nŸify
(
u≤p_evít_nŸify
 *
obj
)

518 if(
obj
->
°©e
 =
EEº‹
 || obj->°©ê=
EFöished
)

520 if(
obj
->
s
 >= 0)

522 
	`˛o£
(
obj
->
s
);

524 if(
obj
->
sub
)

526 
obj
->
sub
->
nŸify
 = 
NULL
;

530 if(
obj
->
°©e
 =
EEº‹
 && obj->
sub
)

532 
	`LIST_REMOVE
(
obj
->
sub
, 
íåõs
);

533 
	`‰ì
(
obj
->
sub
);

536 
	`‰ì
(
obj
->
buf„r
);

537 
	`LIST_REMOVE
(
obj
, 
íåõs
);

538 
	`‰ì
(
obj
);

540 
	}
}

544 
	$u≤≥víts_exô
()

546 
u≤p_evít_nŸify
 * 
obj
;

547 
u≤p_evít_nŸify
 * 
√xt
;

548 
subs¸ibî
 * 
sub
;

549 
subs¸ibî
 * 
sub√xt
;

550 
time_t
 
cuπime
;

552 
obj
 = 
nŸifyli°
.
lh_fú°
;

553 
obj
 !
NULL
) {

554 
√xt
 = 
obj
->
íåõs
.
À_√xt
;

555 if(
obj
->
°©e
 =
EEº‹
 || obj->°©ê=
EFöished
) {

556 if(
obj
->
s
 >= 0) {

557 
	`˛o£
(
obj
->
s
);

559 if(
obj
->
sub
)

560 
obj
->
sub
->
nŸify
 = 
NULL
;

563 if(
obj
->
°©e
 =
EEº‹
 && obj->
sub
) {

564 
	`LIST_REMOVE
(
obj
->
sub
, 
íåõs
);

565 
	`‰ì
(
obj
->
sub
);

568 
	`‰ì
(
obj
->
buf„r
);

569 
	`LIST_REMOVE
(
obj
, 
íåõs
);

570 
	`‰ì
(
obj
);

572 
obj
 = 
√xt
;

576 
cuπime
 = 
	`time
(
NULL
);

577 
sub
 = 
subs¸ibîli°
.
lh_fú°
; sub !
NULL
; ) {

578 
sub√xt
 = 
sub
->
íåõs
.
À_√xt
;

579 if(
sub
->
timeout
 && 
cuπime
 > sub->timeouà&& sub->
nŸify
 =
NULL
) {

580 
	`LIST_REMOVE
(
sub
, 
íåõs
);

581 
	`‰ì
(
sub
);

583 
sub
 = 
sub√xt
;

585 
	}
}

	@upnpevents.h

48 #i‚de‡
__UPNPEVENTS_H__


49 
	#__UPNPEVENTS_H__


	)

51 
	esubs¸ibî_£rvi˚_íum


53 
	mEC⁄ã¡Dúe˘‹y
 = 1,

54 
	mEC⁄√˘i⁄M™agî
,

55 
	mEMSMedüRe˚ivîRegi°ør


59 
u≤p_evít_v¨_ch™ge_nŸify
(
subs¸ibî_£rvi˚_íum
 
£rvi˚
);

62 
u≤≥víts_addSubs¸ibî
(c⁄° * 
evítuæ
,

63 c⁄° * 
ˇŒback
, 
ˇŒbackÀn
,

64 
timeout
);

66 
u≤≥víts_ªmoveSubs¸ibî
(c⁄° * 
sid
, 
sidÀn
);

67 
u≤≥víts_ªmoveSubs¸ibîs
();

69 
ª√wSubs¸ùti⁄
(c⁄° * 
sid
, 
sidÀn
, 
timeout
);

71 #ifde‡
USE_MINIUPNPDCTL


72 
wrôe_evíts_dëaûs
(
s
);

	@upnpglobalvars.c

49 
	~<sys/ty≥s.h
>

50 
	~<√töë/ö.h
>

51 
	~<sys/∑øm.h
>

53 
	~"c⁄fig.h
"

54 
	~"u≤pglobÆv¨s.h
"

55 
	~"u≤pdesc°rögs.h
"

58 
time_t
 
	g°¨tup_time
 = 0;

60 
ru¡ime_v¨s_s
 
	gru¡ime_v¨s
;

61 
uöt32_t
 
	gru¡ime_Êags
 = 
INOTIFY_MASK
;

63 c⁄° *
	gpidfûíame
 = "/var/run/minidlna/minidlna.pid";

65 
	guuidvÆue
[] = "uuid:00000000-0000-0000-0000-000000000000";

66 
	gmodñ«me
[
MODELNAME_MAX_LEN
] = 
ROOTDEV_MODELNAME
;

67 
	gmodñnumbî
[
MODELNUMBER_MAX_LEN
] = 
MINIDLNA_VERSION
;

68 
	g£rü umbî
[
SERIALNUMBER_MAX_LEN
] = "00000000";

69 #i‡
PNPX


70 
	g≤px_hwid
[] = "VEN_0000&amp;DEV_0000&amp;REV_01 VEN_0033&amp;DEV_0001&amp;REV_01";

75 
	g¥e£¡©i⁄uæ
[
PRESENTATIONURL_MAX_LEN
];

77 
	gn_œn_addr
 = 0;

78 
œn_addr_s
 
	gœn_addr
[
MAX_LAN_ADDR
];

81 c⁄° * 
	gmöissdpdsockë∑th
 = "/var/run/minissdpd.sock";

84 
sqlôe3
 *
	gdb
;

85 
	g‰õndly_«me
[
FRIENDLYNAME_MAX_LEN
];

86 
	gdb_∑th
[
PATH_MAX
] = {'\0'};

87 
	glog_∑th
[
PATH_MAX
] = {'\0'};

88 
medü_dú_s
 * 
	gmedü_dús
 = 
NULL
;

89 
Æbum_¨t_«me_s
 * 
	gÆbum_¨t_«mes
 = 
NULL
;

90 
	gsˇ¬ög
 = 0;

91 vﬁ©ûê
	gquôtög
 = 0;

92 vﬁ©ûê
uöt32_t
 
	gupd©eID
 = 0;

93 c⁄° *
	gf‹˚_s‹t_¸ôîü
 = 
NULL
;

	@upnpglobalvars.h

49 #i‚de‡
__UPNPGLOBALVARS_H__


50 
	#__UPNPGLOBALVARS_H__


	)

52 
	~<time.h
>

54 
	~"möid ©y≥s.h
"

55 
	~"˛õ¡s.h
"

56 
	~"c⁄fig.h
"

58 
	~<sqlôe3.h
>

60 
	#MINIDLNA_VERSION
 "1.1.2"

	)

62 #ifde‡
NETGEAR


63 
	#SERVER_NAME
 "RódyDLNA"

	)

65 
	#SERVER_NAME
 "MöiDLNA"

	)

68 
	#USE_FORK
 1

	)

69 
	#DB_VERSION
 9

	)

71 #ifde‡
ENABLE_NLS


72 
	#_
(
°rög
Ë
	`gëãxt
(°rög)

	)

74 
	#_
(
°rög
Ë(°rög)

	)

77 #i‚de‡
PNPX


78 
	#PNPX
 0

	)

81 
	#RESOURCE_PROTOCOL_INFO_VALUES
 \

181 "hâp-gë:*:≠∂iˇti⁄/ogg:*"

	)

183 
	#DLNA_FLAG_DLNA_V1_5
 0x00100000

	)

184 
	#DLNA_FLAG_HTTP_STALLING
 0x00200000

	)

185 
	#DLNA_FLAG_TM_B
 0x00400000

	)

186 
	#DLNA_FLAG_TM_I
 0x00800000

	)

187 
	#DLNA_FLAG_TM_S
 0x01000000

	)

188 
	#DLNA_FLAG_LOP_BYTES
 0x20000000

	)

189 
	#DLNA_FLAG_LOP_NPT
 0x40000000

	)

192 
time_t
 
°¨tup_time
;

194 
ru¡ime_v¨s_s
 
ru¡ime_v¨s
;

196 
uöt32_t
 
ru¡ime_Êags
;

197 
	#INOTIFY_MASK
 0x0001

	)

198 
	#TIVO_MASK
 0x0002

	)

199 
	#DLNA_STRICT_MASK
 0x0004

	)

200 
	#NO_PLAYLIST_MASK
 0x0008

	)

201 
	#SYSTEMD_MASK
 0x0010

	)

203 
	#SETFLAG
(
mask
Ë
ru¡ime_Êags
 |
	)
mask

204 
	#GETFLAG
(
mask
Ë(
ru¡ime_Êags
 & mask)

	)

205 
	#CLEARFLAG
(
mask
Ë
ru¡ime_Êags
 &~
	)
mask

207 c⁄° *
pidfûíame
;

209 
uuidvÆue
[];

211 
	#MODELNAME_MAX_LEN
 64

	)

212 
modñ«me
[];

214 
	#MODELNUMBER_MAX_LEN
 16

	)

215 
modñnumbî
[];

217 
	#SERIALNUMBER_MAX_LEN
 16

	)

218 
£rü umbî
[];

220 
	#PRESENTATIONURL_MAX_LEN
 64

	)

221 
¥e£¡©i⁄uæ
[];

223 #i‡
PNPX


224 
≤px_hwid
[];

228 
n_œn_addr
;

229 
œn_addr_s
 
œn_addr
[];

231 c⁄° *
möissdpdsockë∑th
;

234 
sqlôe3
 *
db
;

235 
	#FRIENDLYNAME_MAX_LEN
 64

	)

236 
‰õndly_«me
[];

237 
db_∑th
[];

238 
log_∑th
[];

239 
medü_dú_s
 *
medü_dús
;

240 
Æbum_¨t_«me_s
 *
Æbum_¨t_«mes
;

241 
sˇ¬ög
;

242 vﬁ©ûê
quôtög
;

243 vﬁ©ûê
uöt32_t
 
upd©eID
;

244 c⁄° *
f‹˚_s‹t_¸ôîü
;

	@upnphttp.c

49 
	~<°dlib.h
>

50 
	~<uni°d.h
>

51 
	~<°dio.h
>

52 
	~<°rög.h
>

53 
	~<sys/ty≥s.h
>

54 
	~<sys/sockë.h
>

55 
	~<sys/∑øm.h
>

56 
	~<˘y≥.h
>

57 
	~<sys/ty≥s.h
>

58 
	~<sys/°©.h
>

59 
	~<f˙é.h
>

60 
	~<î∫o.h
>

61 
	~<¨∑/öë.h
>

62 
	~<sys/time.h
>

63 
	~<sys/ªsour˚.h
>

65 
	~"c⁄fig.h
"

66 
	~"u≤pglobÆv¨s.h
"

67 
	~"u≤phâp.h
"

68 
	~"u≤pdescgí.h
"

69 
	~"möid ≠©h.h
"

70 
	~"u≤psﬂp.h
"

71 
	~"u≤≥víts.h
"

72 
	~"utûs.h
"

73 
	~"gëiÁddr.h
"

74 
	~"image_utûs.h
"

75 
	~"log.h
"

76 
	~"sql.h
"

77 
	~<libexif/exif-lﬂdî.h
>

78 
	~"tivo_utûs.h
"

79 
	~"tivo_comm™ds.h
"

80 
	~"˛õ¡s.h
"

81 
	~"¥o˚ss.h
"

83 
	~"£ndfûe.h
"

84 
	~"möid a.h
"

87 
	#MAX_BUFFER_SIZE
 4194304

88 
	#MAX_BUFFER_SIZE
 2147483647

90 
	#MAX_BUFFER_SIZE
 1048576

91 
	#MIN_BUFFER_SIZE
 65536

	)

93 #unde‡
USE_FORK


94 
	#USE_FORK
 0

	)

96 
	~"ic⁄s.c
"

98 
	eevít_ty≥
 {

99 
	mE_INVALID
,

100 
	mE_SUBSCRIBE
,

101 
	mE_RENEW


104 
	s£nd_chaö


106 
u≤phâp
 *
	muhâp
;

107 
	mfd
;

108 
off_t
 
	moff£t
;

109 
off_t
 
	msize
;

112 
£nd_d©a
(
u≤phâp
 * 
h
, * 
hódî
, 
size_t
 
size
, 
Êags
);

113 
u≤phâp_£ndQueue
(
u≤phâp
 *
h
, 
fd
, 
off_t
 
off£t
, off_à
size
);

116 
	$LIST_HEAD
(
hâ∂i°hód
, 
u≤phâp
Ë
u≤phâphód
 = { 
NULL
 
	}
};

117 
	gshâ∂
 = -1;

119 
u≤phâp
 *

120 
	$New_u≤phâp
(
s
)

122 
u≤phâp
 * 
ªt
;

123 if(
s
<0)

124  
NULL
;

125 
ªt
 = (
u≤phâp
 *)
	`mÆloc
((upnphttp));

126 if(
ªt
 =
NULL
)

127  
NULL
;

128 
	`mem£t
(
ªt
, 0, (
u≤phâp
));

129 
ªt
->
sockë
 = 
s
;

130  
ªt
;

131 
	}
}

134 
	$Clo£Sockë_u≤phâp
(
u≤phâp
 * 
h
)

136 
evít_°ru˘
 *
evt
;

137 
£nd_chaö
 *
chaö
;

139 
evt
 = 
h
->
evít
;

140 i‡(
evt
)

142 
chaö
 = (
£nd_chaö
 *)
evt
->
wrôe
.
d©a
;

143 i‡(
chaö
)

145 
	`˛o£
(
chaö
->
fd
);

146 
	`‰ì
(
chaö
);

147 
evt
->
wrôe
.
d©a
 = 
NULL
;

148 
evt
->
wrôe
.
h™dÀr
 = 
NULL
;

151 
	`evít_dñ
(
evt
);

152 
	`evít_‰ì
(
evt
);

153 
h
->
evít
 = 
NULL
;

156 i‡(
h
->
sockë
 > -1)

158 if(
	`˛o£
(
h
->
sockë
) < 0)

160 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "CloseSocket_upnphttp: close(%d): %s\n",

161 
h
->
sockë
, 
	`°ªº‹
(
î∫o
));

163 
h
->
sockë
 = -1;

165 
h
->
°©e
 = 100;

166 
	}
}

169 
	$Ac˚±Sockë_u≤phâp
(*
sock
)

171 
£rv_sock
 = *
sock
;

172 
˛¡_sock
;

173 
sockÀn_t
 
addæí
;

174 
sockaddr_ö
 
addr
;

175 
u≤phâp
 *
uhâp
 = 
NULL
;

176 
evít_°ru˘
 *
evt
 = 
NULL
;

178 
addæí
 = (
sockaddr_ö
);

179 
˛¡_sock
 = 
	`ac˚±
(
£rv_sock
, (
sockaddr
 *)&
addr
, &
addæí
);

180 i‡(
˛¡_sock
 < 0)

182 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "ac˚±(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

186 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "HTTP connection from %s:%d\n",

187 
	`öë_¡ﬂ
(
addr
.
sö_addr
),

188 
	`¡ohs
(
addr
.
sö_p‹t
));

191 i‡(
	`f˙é
(
˛¡_sock
, 
F_SETFL
, 
O_NONBLOCK
) < 0)

193 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "fcntl F_SETFL, O_NONBLOCK\n");

199 
uhâp
 = 
	`New_u≤phâp
(
˛¡_sock
);

200 i‡(!
uhâp
)

202 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "New_upnphttp() failed\n");

203 
	`˛o£
(
˛¡_sock
);

207 
uhâp
->
˛õ¡addr
 = 
addr
.
sö_addr
;

208 
	`LIST_INSERT_HEAD
(&
u≤phâphód
, 
uhâp
, 
íåõs
);

210 
evt
 = 
	`evít_mÆloc
(
˛¡_sock
);

211 i‡(!
evt
)

213 
out
;

215 
evt
->
ªad
.
d©a
 = 
uhâp
;

216 
evt
->
ªad
.
h™dÀr
 = (
EVENT_HANDLER
)
Pro˚ss_u≤phâp
;

218 i‡(
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLIN
) == -1)

220 
out
;

223 
uhâp
->
evít
 = 
evt
;

226 
out
:

227 i‡(
uhâp
)

229 
	`LIST_REMOVE
(
uhâp
, 
íåõs
);

230 
	`‰ì
(
uhâp
);

232 i‡(
evt
)

234 
	`evít_‰ì
(
evt
);

236 
	}
}

239 
	$Dñëe_u≤phâp
(
u≤phâp
 * 
h
)

241 if(
h
)

243 if(
h
->
sockë
 >= 0)

244 
	`Clo£Sockë_u≤phâp
(
h
);

245 
	`‰ì
(
h
->
ªq_buf
);

246 
	`‰ì
(
h
->
ªs_buf
);

247 
	`‰ì
(
h
);

249 
	}
}

253 
	$P¨£HâpHódîs
(
u≤phâp
 * 
h
)

255 * 
löe
;

256 * 
cﬁ⁄
;

257 * 
p
;

258 
n
;

259 
löe
 = 
h
->
ªq_buf
;

261 
löe
 < (
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
))

263 
cﬁ⁄
 = 
	`°rchr
(
löe
, ':');

264 if(
cﬁ⁄
)

266 if(
	`°∫ˇ£cmp
(
löe
, "Content-Length", 14)==0)

268 
p
 = 
cﬁ⁄
;

269 *
p
 < '0' || *p > '9')

270 
p
++;

271 
h
->
ªq_c⁄ã¡Àn
 = 
	`©oi
(
p
);

273 if(
	`°∫ˇ£cmp
(
löe
, "SOAPAction", 10)==0)

275 
p
 = 
cﬁ⁄
;

276 
n
 = 0;

277 *
p
 == ':' || *p == ' ' || *p == '\t')

278 
p
++;

279 
p
[
n
]>=' ')

281 
n
++;

283 if((
p
[0] ='"' &&Ö[
n
-1] == '"')

284 || (
p
[0] ='\'' &&Ö[
n
-1] == '\''))

286 
p
++; 
n
 -= 2;

288 
h
->
ªq_sﬂpA˘i⁄
 = 
p
;

289 
h
->
ªq_sﬂpA˘i⁄Lí
 = 
n
;

291 if(
	`°∫ˇ£cmp
(
löe
, "Callback", 8)==0)

293 
p
 = 
cﬁ⁄
;

294 *
p
 != '<' && *p != '\r' )

295 
p
++;

296 
n
 = 0;

297 
p
[
n
] != '>' &&Ö[n] != '\r' )

298 
n
++;

299 
h
->
ªq_CÆlback
 = 
p
 + 1;

300 
h
->
ªq_CÆlbackLí
 = 
	`MAX
(0, 
n
 - 1);

302 if(
	`°∫ˇ£cmp
(
löe
, "SID", 3)==0)

306 
p
=
löe
+3;p<
cﬁ⁄
;p++)

308 if(!
	`is•a˚
(*
p
))

310 
p
 = 
NULL
;

314 if(
p
) {

315 
p
 = 
cﬁ⁄
 + 1;

316 
	`is•a˚
(*
p
))

317 
p
++;

318 
n
 = 0;

319 !
	`is•a˚
(
p
[
n
]))

320 
n
++;

321 
h
->
ªq_SID
 = 
p
;

322 
h
->
ªq_SIDLí
 = 
n
;

325 if(
	`°∫ˇ£cmp
(
löe
, "NT", 2)==0)

327 
p
 = 
cﬁ⁄
 + 1;

328 
	`is•a˚
(*
p
))

329 
p
++;

330 
n
 = 0;

331 !
	`is•a˚
(
p
[
n
]))

332 
n
++;

333 
h
->
ªq_NT
 = 
p
;

334 
h
->
ªq_NTLí
 = 
n
;

343 if(
	`°∫ˇ£cmp
(
löe
, "Timeout", 7)==0)

345 
p
 = 
cﬁ⁄
 + 1;

346 
	`is•a˚
(*
p
))

347 
p
++;

348 if(
	`°∫ˇ£cmp
(
p
, "Second-", 7)==0) {

349 
h
->
ªq_Timeout
 = 
	`©oi
(
p
+7);

353 if(
	`°∫ˇ£cmp
(
löe
, "Range", 5)==0)

355 
p
 = 
cﬁ⁄
 + 1;

356 
	`is•a˚
(*
p
))

357 
p
++;

358 if(
	`°∫ˇ£cmp
(
p
, "bytes=", 6)==0) {

359 
h
->
ªqÊags
 |
FLAG_RANGE
;

360 
h
->
ªq_R™geSèπ
 = 
	`°πﬁl
(
p
+6, &
cﬁ⁄
, 10);

361 
h
->
ªq_R™geEnd
 = 
cﬁ⁄
 ? 
	`©ﬁl
(colon+1) : 0;

362 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Range Start-End: %lld - %lld\n",

363 
h
->
ªq_R™geSèπ
, h->
ªq_R™geEnd
?h->req_RangeEnd:-1);

366 if(
	`°∫ˇ£cmp
(
löe
, "Host", 4)==0)

368 
i
;

369 
h
->
ªqÊags
 |
FLAG_HOST
;

370 
p
 = 
cﬁ⁄
 + 1;

371 
	`is•a˚
(*
p
))

372 
p
++;

373 
n
 = 0;Ç<
n_œn_addr
;Ç++)

375 
i
=0; 
œn_addr
[
n
].
°r
[i]; i++)

377 if(
œn_addr
[
n
].
°r
[
i
] !
p
[i])

380 if(!
œn_addr
[
n
].
°r
[
i
])

382 
h
->
iÁ˚
 = 
n
;

387 if(
	`°∫ˇ£cmp
(
löe
, "User-Agent", 10)==0)

389 
i
;

391 if–
h
->
ªq_˛õ¡
 )

392 
√xt_hódî
;

393 
p
 = 
cﬁ⁄
 + 1;

394 
	`is•a˚
(*
p
))

395 
p
++;

396 
i
 = 0; 
˛õ¡_ty≥s
[i].
«me
; i++)

398 i‡(
˛õ¡_ty≥s
[
i
].
m©ch_ty≥
 !
EU£rAgít
)

400 i‡(
	`°r°rc
(
p
, 
˛õ¡_ty≥s
[
i
].
m©ch
, '\r'Ë!
NULL
)

402 
h
->
ªq_˛õ¡
 = 
i
;

407 if(
	`°∫ˇ£cmp
(
löe
, "X-AV-Client-Info", 16)==0)

409 
i
;

411 if–
h
->
ªq_˛õ¡
 && 
˛õ¡_ty≥s
[h->ªq_˛õ¡].
ty≥
 < 
ESènd¨dDLNA150
 )

412 
√xt_hódî
;

413 
p
 = 
cﬁ⁄
 + 1;

414 
	`is•a˚
(*
p
))

415 
p
++;

416 
i
 = 0; 
˛õ¡_ty≥s
[i].
«me
; i++)

418 i‡(
˛õ¡_ty≥s
[
i
].
m©ch_ty≥
 !
EXAVClõ¡Info
)

420 i‡(
	`°r°rc
(
p
, 
˛õ¡_ty≥s
[
i
].
m©ch
, '\r'Ë!
NULL
)

422 
h
->
ªq_˛õ¡
 = 
i
;

427 if(
	`°∫ˇ£cmp
(
löe
, "Transfer-Encoding", 17)==0)

429 
p
 = 
cﬁ⁄
 + 1;

430 
	`is•a˚
(*
p
))

431 
p
++;

432 if(
	`°∫ˇ£cmp
(
p
, "chunked", 7)==0)

434 
h
->
ªqÊags
 |
FLAG_CHUNKED
;

437 if(
	`°∫ˇ£cmp
(
löe
, "Accept-Language", 15)==0)

439 
h
->
ªqÊags
 |
FLAG_LANGUAGE
;

441 if(
	`°∫ˇ£cmp
(
löe
, "getcontentFeatures.dlna.org", 27)==0)

443 
p
 = 
cﬁ⁄
 + 1;

444 
	`is•a˚
(*
p
))

445 
p
++;

446 if–(*
p
 !'1'Ë|| !
	`is•a˚
(p[1]) )

447 
h
->
ªqÊags
 |
FLAG_INVALID_REQ
;

449 if(
	`°∫ˇ£cmp
(
löe
, "TimeSeekRange.dlna.org", 22)==0)

451 
h
->
ªqÊags
 |
FLAG_TIMESEEK
;

453 if(
	`°∫ˇ£cmp
(
löe
, "PlaySpeed.dlna.org", 18)==0)

455 
h
->
ªqÊags
 |
FLAG_PLAYSPEED
;

457 if(
	`°∫ˇ£cmp
(
löe
, "realTimeInfo.dlna.org", 21)==0)

459 
h
->
ªqÊags
 |
FLAG_REALTIMEINFO
;

461 if(
	`°∫ˇ£cmp
(
löe
, "getAvailableSeekRange.dlna.org", 21)==0)

463 
p
 = 
cﬁ⁄
 + 1;

464 
	`is•a˚
(*
p
))

465 
p
++;

466 if–(*
p
 !'1'Ë|| !
	`is•a˚
(p[1]) )

467 
h
->
ªqÊags
 |
FLAG_INVALID_REQ
;

469 if(
	`°∫ˇ£cmp
(
löe
, "transferMode.dlna.org", 21)==0)

471 
p
 = 
cﬁ⁄
 + 1;

472 
	`is•a˚
(*
p
))

473 
p
++;

474 if(
	`°∫ˇ£cmp
(
p
, "Streaming", 9)==0)

476 
h
->
ªqÊags
 |
FLAG_XFERSTREAMING
;

478 if(
	`°∫ˇ£cmp
(
p
, "Interactive", 11)==0)

480 
h
->
ªqÊags
 |
FLAG_XFERINTERACTIVE
;

482 if(
	`°∫ˇ£cmp
(
p
, "Background", 10)==0)

484 
h
->
ªqÊags
 |
FLAG_XFERBACKGROUND
;

487 if(
	`°∫ˇ£cmp
(
löe
, "getCaptionInfo.sec", 18)==0)

489 
h
->
ªqÊags
 |
FLAG_CAPTION
;

491 if(
	`°∫ˇ£cmp
(
löe
, "FriendlyName", 12)==0)

493 
i
;

494 
p
 = 
cﬁ⁄
 + 1;

495 
	`is•a˚
(*
p
))

496 
p
++;

497 
i
 = 0; 
˛õ¡_ty≥s
[i].
«me
; i++)

499 i‡(
˛õ¡_ty≥s
[
i
].
m©ch_ty≥
 !
EFrõndlyName
)

501 i‡(
	`°r°rc
(
p
, 
˛õ¡_ty≥s
[
i
].
m©ch
, '\r'Ë!
NULL
)

503 
h
->
ªq_˛õ¡
 = 
i
;

508 if(
	`°∫ˇ£cmp
(
löe
, "uctt.upnp.org:", 14)==0)

511 
	`SETFLAG
(
DLNA_STRICT_MASK
);

514 
√xt_hódî
:

515 !(
löe
[0] == '\r' &&Üine[1] == '\n'))

516 
löe
++;

517 
löe
 += 2;

519 if–
h
->
ªqÊags
 & 
FLAG_CHUNKED
 )

521 *
íd±r
;

522 
h
->
ªq_chunkÀn
 = -1;

523 if–
h
->
ªq_buÊí
 <h->
ªq_c⁄ã¡off
 )

525  (
löe
 < (
h
->
ªq_buf
 + h->
ªq_buÊí
)) &&

526 (
h
->
ªq_chunkÀn
 = 
	`°πﬁ
(
löe
, &
íd±r
, 16)) &&

527 (
íd±r
 !
löe
) )

529 !(
íd±r
[0] == '\r' &&Éndptr[1] == '\n'))

531 
íd±r
++;

533 
löe
 = 
íd±r
+
h
->
ªq_chunkÀn
+2;

536 if–
íd±r
 =
löe
 )

538 
h
->
ªq_chunkÀn
 = -1;

545 
n
 = 
	`SórchClõ¡Cache
(
h
->
˛õ¡addr
, 0);

547 if–
n
 < 0 )

549 
	`AddClõ¡Cache
(
h
->
˛õ¡addr
, h->
ªq_˛õ¡
);

551 i‡(
h
->
ªq_˛õ¡
)

553 
˛õ¡_ty≥s
 
ty≥
 = clõ¡_ty≥s[
h
->
ªq_˛õ¡
].type;

554 
˛õ¡_ty≥s
 
˘y≥
 = clõ¡_ty≥s[
˛õ¡s
[
n
].
ty≥
].type;

557 i‡((
˘y≥
 && cty≥ < 
ESènd¨dDLNA150
 && 
ty≥
 >= EStandardDLNA150) ||

558 (
˘y≥
 =
ESamsungSîõsB
 && 
ty≥
 =
ESamsungSîõsA
))

560 
h
->
ªq_˛õ¡
 = 
˛õ¡s
[
n
].
ty≥
;

563 
˛õ¡s
[
n
].
ty≥
 = 
h
->
ªq_˛õ¡
;

564 
˛õ¡s
[
n
].
age
 = 
	`time
(
NULL
);

567 
h
->
ªq_˛õ¡
 = 
˛õ¡s
[
n
].
ty≥
;

568 
	}
}

572 
	$Síd400
(
u≤phâp
 * 
h
)

574 c⁄° 
body400
[] =

578 
h
->
ª•Êags
 = 
FLAG_HTML
;

579 
	`BuûdRe•2_u≤phâp
(
h
, 400, "Bad Request",

580 
body400
, (body400) - 1);

581 
	`SídRe•_u≤phâp
(
h
);

582 
	`Clo£Sockë_u≤phâp
(
h
);

583 
	}
}

587 
	$Síd404
(
u≤phâp
 * 
h
)

589 c⁄° 
body404
[] =

593 
h
->
ª•Êags
 = 
FLAG_HTML
;

594 
	`BuûdRe•2_u≤phâp
(
h
, 404, "Not Found",

595 
body404
, (body404) - 1);

596 
	`SídRe•_u≤phâp
(
h
);

597 
	`Clo£Sockë_u≤phâp
(
h
);

598 
	}
}

602 
	$Síd406
(
u≤phâp
 * 
h
)

604 c⁄° 
body406
[] =

608 
h
->
ª•Êags
 = 
FLAG_HTML
;

609 
	`BuûdRe•2_u≤phâp
(
h
, 406, "Not Acceptable",

610 
body406
, (body406) - 1);

611 
	`SídRe•_u≤phâp
(
h
);

612 
	`Clo£Sockë_u≤phâp
(
h
);

613 
	}
}

617 
	$Síd416
(
u≤phâp
 * 
h
)

619 c⁄° 
body416
[] =

623 
h
->
ª•Êags
 = 
FLAG_HTML
;

624 
	`BuûdRe•2_u≤phâp
(
h
, 416, "Requested Range Not Satisfiable",

625 
body416
, (body416) - 1);

626 
	`SídRe•_u≤phâp
(
h
);

627 
	`Clo£Sockë_u≤phâp
(
h
);

628 
	}
}

632 
	$Síd500
(
u≤phâp
 * 
h
)

634 c⁄° 
body500
[] =

638 
h
->
ª•Êags
 = 
FLAG_HTML
;

639 
	`BuûdRe•2_u≤phâp
(
h
, 500, "Internal Server Errror",

640 
body500
, (body500) - 1);

641 
	`SídRe•_u≤phâp
(
h
);

642 
	`Clo£Sockë_u≤phâp
(
h
);

643 
	}
}

647 
	$Síd501
(
u≤phâp
 * 
h
)

649 c⁄° 
body501
[] =

653 
h
->
ª•Êags
 = 
FLAG_HTML
;

654 
	`BuûdRe•2_u≤phâp
(
h
, 501, "Not Implemented",

655 
body501
, (body501) - 1);

656 
	`SídRe•_u≤phâp
(
h
);

657 
	`Clo£Sockë_u≤phâp
(
h
);

658 
	}
}

661 
	$födídhódîs
(c⁄° * 
s
, 
Àn
)

663 
Àn
-- > 0)

665 if(
s
[0]=='\r' && s[1]=='\n' && s[2]=='\r' && s[3]=='\n')

666  
s
;

667 
s
++;

669  
NULL
;

670 
	}
}

674 
£ndXMLdesc
(
u≤phâp
 * 
h
, * (
f
)(*))

676 * 
	gdesc
;

677 
	gÀn
;

678 
	gdesc
 = 
f
(&
Àn
);

679 if(!
	gdesc
)

681 
DPRINTF
(
E_ERROR
, 
L_HTTP
, "FailedÅo generate XML description\n");

682 
Síd500
(
h
);

685 
BuûdRe•_u≤phâp
(
h
, 
desc
, 
Àn
);

686 
SídRe•_u≤phâp
(
h
);

687 
Clo£Sockë_u≤phâp
(
h
);

688 
‰ì
(
desc
);

691 #ifde‡
READYNAS


693 
	$SídRe•_ªady«s_admö
(
u≤phâp
 * 
h
)

695 
body
[128];

696 
l
;

698 
h
->
ª•Êags
 = 
FLAG_HTML
;

699 
l
 = 
	`¢¥ötf
(
body
, (body), "<meta http-equiv=\"refresh\" content=\"0; url=https://%s/admin/\">",

700 
œn_addr
[
h
->
iÁ˚
].
°r
);

702 
	`BuûdRe•_u≤phâp
(
h
, 
body
, 
l
);

703 
	`SídRe•_u≤phâp
(
h
);

704 
	`Clo£Sockë_u≤phâp
(
h
);

705 
	}
}

709 
	$SídRe•_¥e£¡©i⁄
(
u≤phâp
 * 
h
)

711 
°rög_s
 
°r
;

712 
body
[4096];

713 
a
, 
v
, 
p
, 
i
;

715 
°r
.
d©a
 = 
body
;

716 
°r
.
size
 = (
body
);

717 
°r
.
off
 = 0;

719 
h
->
ª•Êags
 = 
FLAG_HTML
;

721 
a
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(*) from DETAILS where MIME glob 'a*'");

722 
v
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(*) from DETAILS where MIME glob 'v*'");

723 
p
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(*) from DETAILS where MIME glob 'i*'");

724 
	`°rˇtf
(&
°r
,

725 "<HTML><HEAD><TITLE>" 
SERVER_NAME
 " " 
MINIDLNA_VERSION
 "</TITLE></HEAD>"

727 "<h2>" 
SERVER_NAME
 " status</h2></div>");

729 
	`°rˇtf
(&
°r
,

735 "</èbÀ>", 
a
, 
v
, 
p
);

737 
	`°rˇtf
(&
°r
,

741 
i
 = 0; i < 
CLIENT_CACHE_SLOTS
; i++)

743 i‡(!
˛õ¡s
[
i
].
addr
.
s_addr
)

745 
	`°rˇtf
(&
°r
, "<tr><td>%d</td><td>%s</td><td>%s</td><td>%02X:%02X:%02X:%02X:%02X:%02X</td></tr>",

746 
i
, 
˛õ¡_ty≥s
[
˛õ¡s
[i].
ty≥
].
«me
, 
	`öë_¡ﬂ
(˛õ¡s[i].
addr
),

747 
˛õ¡s
[
i
].
mac
[0], clients[i].mac[1], clients[i].mac[2],

748 
˛õ¡s
[
i
].
mac
[3], clients[i].mac[4], clients[i].mac[5]);

750 
	`°rˇtf
(&
°r
, "</table></BODY></HTML>\r\n");

752 
	`BuûdRe•_u≤phâp
(
h
, 
°r
.
d©a
, så.
off
);

753 
	`SídRe•_u≤phâp
(
h
);

754 
	`Clo£Sockë_u≤phâp
(
h
);

755 
	}
}

760 
	$Pro˚ssHTTPPOST_u≤phâp
(
u≤phâp
 * 
h
)

762 if((
h
->
ªq_buÊí
 - h->
ªq_c⁄ã¡off
Ë>h->
ªq_c⁄ã¡Àn
)

764 if(
h
->
ªq_sﬂpA˘i⁄
)

767 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SOAPA˘i⁄: %.*s\n", 
h
->
ªq_sﬂpA˘i⁄Lí
, h->
ªq_sﬂpA˘i⁄
);

768 
	`ExecuãSﬂpA˘i⁄
(
h
,

769 
h
->
ªq_sﬂpA˘i⁄
,

770 
h
->
ªq_sﬂpA˘i⁄Lí
);

774 c⁄° 
îr400°r
[] =

776 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "No SOAPAction in HTTP headers\n");

777 
h
->
ª•Êags
 = 
FLAG_HTML
;

778 
	`BuûdRe•2_u≤phâp
(
h
, 400, "Bad Request",

779 
îr400°r
, (err400str) - 1);

780 
	`SídRe•_u≤phâp
(
h
);

781 
	`Clo£Sockë_u≤phâp
(
h
);

787 
h
->
°©e
 = 1;

789 
	}
}

792 
	$check_evít
(
u≤phâp
 *
h
)

794 
evít_ty≥
 
ty≥
;

796 i‡(
h
->
ªq_CÆlback
)

798 i‡(
h
->
ªq_SID
 || !h->
ªq_NT
)

800 
	`BuûdRe•2_u≤phâp
(
h
, 400, "Bad Request",

802 
ty≥
 = 
E_INVALID
;

804 i‡(
	`°∫cmp
(
h
->
ªq_CÆlback
, "http://", 7) != 0 ||

805 
	`°∫cmp
(
h
->
ªq_NT
, "u≤p:evít", h->
ªq_NTLí
) != 0)

810 
	`BuûdRe•2_u≤phâp
(
h
, 412, "Precondition Failed", 0, 0);

811 
ty≥
 = 
E_INVALID
;

814 
ty≥
 = 
E_SUBSCRIBE
;

816 i‡(
h
->
ªq_SID
)

819 i‡(
h
->
ªq_NT
)

821 
	`BuûdRe•2_u≤phâp
(
h
, 400, "Bad Request",

823 
ty≥
 = 
E_INVALID
;

826 
ty≥
 = 
E_RENEW
;

830 
	`BuûdRe•2_u≤phâp
(
h
, 412, "Precondition Failed", 0, 0);

831 
ty≥
 = 
E_INVALID
;

834  
ty≥
;

835 
	}
}

838 
	$Pro˚ssHTTPSubs¸ibe_u≤phâp
(
u≤phâp
 * 
h
, c⁄° * 
∑th
)

840 c⁄° * 
sid
;

841 
evít_ty≥
 
ty≥
;

842 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Pro˚ssHTTPSubs¸ibê%s\n", 
∑th
);

843 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Callback '%.*s' Timeout=%d\n",

844 
h
->
ªq_CÆlbackLí
, h->
ªq_CÆlback
, h->
ªq_Timeout
);

845 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SID '%.*s'\n", 
h
->
ªq_SIDLí
, h->
ªq_SID
);

847 
ty≥
 = 
	`check_evít
(
h
);

848 i‡(
ty≥
 =
E_SUBSCRIBE
)

854 
sid
 = 
	`u≤≥víts_addSubs¸ibî
(
∑th
, 
h
->
ªq_CÆlback
,

855 
h
->
ªq_CÆlbackLí
, h->
ªq_Timeout
);

856 
h
->
ª•Êags
 = 
FLAG_TIMEOUT
;

857 i‡(
sid
)

859 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "gíî©ed sid=%s\n", 
sid
);

860 
h
->
ª•Êags
 |
FLAG_SID
;

861 
h
->
ªq_SID
 = 
sid
;

862 
h
->
ªq_SIDLí
 = 
	`°æí
(
sid
);

864 
	`BuûdRe•_u≤phâp
(
h
, 0, 0);

866 i‡(
ty≥
 =
E_RENEW
)

869 i‡(
	`ª√wSubs¸ùti⁄
(
h
->
ªq_SID
, h->
ªq_SIDLí
, h->
ªq_Timeout
) < 0)

875 
	`BuûdRe•2_u≤phâp
(
h
, 412, "Precondition Failed", 0, 0);

880 
h
->
ª•Êags
 = 
FLAG_TIMEOUT
;

881 
h
->
ªq_Timeout
 = 300;

882 
h
->
ª•Êags
 |
FLAG_SID
;

883 
	`BuûdRe•_u≤phâp
(
h
, 0, 0);

886 
	`SídRe•_u≤phâp
(
h
);

887 
	`Clo£Sockë_u≤phâp
(
h
);

888 
	}
}

891 
	$Pro˚ssHTTPUnSubs¸ibe_u≤phâp
(
u≤phâp
 * 
h
, c⁄° * 
∑th
)

893 
evít_ty≥
 
ty≥
;

894 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Pro˚ssHTTPUnSubs¸ibê%s\n", 
∑th
);

895 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SID '%.*s'\n", 
h
->
ªq_SIDLí
, h->
ªq_SID
);

897 
ty≥
 = 
	`check_evít
(
h
);

898 i‡(
ty≥
 !
E_INVALID
)

900 if(
	`u≤≥víts_ªmoveSubs¸ibî
(
h
->
ªq_SID
, h->
ªq_SIDLí
) < 0)

901 
	`BuûdRe•2_u≤phâp
(
h
, 412, "Precondition Failed", 0, 0);

903 
	`BuûdRe•_u≤phâp
(
h
, 0, 0);

905 
	`SídRe•_u≤phâp
(
h
);

906 
	`Clo£Sockë_u≤phâp
(
h
);

907 
	}
}

912 
	$Pro˚ssHâpQuîy_u≤phâp
(
u≤phâp
 * 
h
)

914 
HâpComm™d
[16];

915 
HâpUæ
[512];

916 * 
HâpVî
;

917 * 
p
;

918 
i
;

919 
p
 = 
h
->
ªq_buf
;

920 if(!
p
)

922 
i
 = 0; i<15 && *
p
 != ' ' && *p != '\r'; i++)

923 
HâpComm™d
[
i
] = *(
p
++);

924 
HâpComm™d
[
i
] = '\0';

925 *
p
==' ')

926 
p
++;

927 if(
	`°∫cmp
(
p
, "http://", 7) == 0)

929 
p
 =Ö+7;

930 *
p
!='/')

931 
p
++;

933 
i
 = 0; i<511 && *
p
 != ' ' && *p != '\r'; i++)

934 
HâpUæ
[
i
] = *(
p
++);

935 
HâpUæ
[
i
] = '\0';

936 *
p
==' ')

937 
p
++;

938 
HâpVî
 = 
h
->HttpVer;

939 
i
 = 0; i<15 && *
p
 != '\r'; i++)

940 
HâpVî
[
i
] = *(
p
++);

941 
HâpVî
[
i
] = '\0';

946 
i
 = 0; i<
n_œn_addr
; i++)

948 if–(
h
->
˛õ¡addr
.
s_addr
 & 
œn_addr
[
i
].
mask
.s_addr)

949 =(
œn_addr
[
i
].
addr
.
s_addr
 &Ü™_addr[i].
mask
.s_addr))

951 
h
->
iÁ˚
 = 
i
;

956 
	`P¨£HâpHódîs
(
h
);

959 if–(
h
->
ªqÊags
 & 
FLAG_CHUNKED
) )

961 if–
h
->
ªq_chunkÀn
 )

963 
h
->
°©e
 = 2;

966 *
chunk°¨t
, *
chunk
, *
íd±r
, *
ídbuf
;

967 
chunk
 = 
ídbuf
 = 
chunk°¨t
 = 
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
;

969  (
h
->
ªq_chunkÀn
 = 
	`°πﬁ
(
chunk
, &
íd±r
, 16)) && (endptr != chunk) )

971 !(
íd±r
[0] == '\r' &&Éndptr[1] == '\n'))

973 
íd±r
++;

975 
íd±r
 += 2;

977 
	`memmove
(
ídbuf
, 
íd±r
, 
h
->
ªq_chunkÀn
);

979 
ídbuf
 +
h
->
ªq_chunkÀn
;

980 
chunk
 = 
íd±r
 + 
h
->
ªq_chunkÀn
;

982 
h
->
ªq_c⁄ã¡Àn
 = 
ídbuf
 - 
chunk°¨t
;

983 
h
->
ªq_buÊí
 = 
ídbuf
 - h->
ªq_buf
;

984 
h
->
°©e
 = 100;

987 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "HTTP REQUEST: %.*s\n", 
h
->
ªq_buÊí
, h->
ªq_buf
);

988 if(
	`°rcmp
("POST", 
HâpComm™d
) == 0)

990 
h
->
ªq_comm™d
 = 
EPo°
;

991 
	`Pro˚ssHTTPPOST_u≤phâp
(
h
);

993 if((
	`°rcmp
("GET", 
HâpComm™d
) == 0) || (strcmp("HEAD", HttpCommand) == 0))

995 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "HâpComm™d: %s, HâpUæ: %s\n", 
HâpComm™d
, 
HâpUæ
);

996 if–((
	`°rcmp
(
h
->
HâpVî
, "HTTP/1.1")==0Ë&& !(h->
ªqÊags
 & 
FLAG_HOST
)Ë|| (h->ªqÊag†& 
FLAG_INVALID_REQ
) )

998 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "InvalidÑequest,Ñesponding ERROR 400. (No Host specified in HTTP headers?)\n");

999 
	`Síd400
(
h
);

1003 if–(
h
->
ªqÊags
 & (
FLAG_TIMESEEK
|
FLAG_PLAYSPEED
)) &&

1004 !(
h
->
ªqÊags
 & 
FLAG_RANGE
) )

1006 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "DLNA %sÑequested,Ñesponding ERROR 406\n",

1007 
h
->
ªqÊags
&
FLAG_TIMESEEK
 ? "TimeSeek" : "PlaySpeed");

1008 
	`Síd406
(
h
);

1011 if(
	`°rcmp
("GET", 
HâpComm™d
) == 0)

1013 
h
->
ªq_comm™d
 = 
EGë
;

1017 
h
->
ªq_comm™d
 = 
EHód
;

1019 if(
	`°rcmp
(
ROOTDESC_PATH
, 
HâpUæ
) == 0)

1022 if–
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
ty≥
 =
EXbox
 )

1024 
modñ_ßv
[2];

1025 
i
 = 0;

1026 
	`mem˝y
(
modñ_ßv
, 
modñnumbî
, 2);

1027 
	`°r˝y
(
modñnumbî
, "1");

1028 if–!
	`°rchr
(
‰õndly_«me
, ':') )

1030 
i
 = 
	`°æí
(
‰õndly_«me
);

1031 
	`¢¥ötf
(
‰õndly_«me
+
i
, 
FRIENDLYNAME_MAX_LEN
-i, ": 1");

1033 
	`£ndXMLdesc
(
h
, 
gíRoŸDesc
);

1034 if–
i
 )

1035 
‰õndly_«me
[
i
] = '\0';

1036 
	`mem˝y
(
modñnumbî
, 
modñ_ßv
, 2);

1038 if–
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
Êags
 & 
FLAG_SAMSUNG_TV
 )

1040 
	`£ndXMLdesc
(
h
, 
gíRoŸDescSamsung
);

1044 
	`£ndXMLdesc
(
h
, 
gíRoŸDesc
);

1047 if(
	`°rcmp
(
CONTENTDIRECTORY_PATH
, 
HâpUæ
) == 0)

1049 
	`£ndXMLdesc
(
h
, 
gíC⁄ã¡Dúe˘‹y
);

1051 if(
	`°rcmp
(
CONNECTIONMGR_PATH
, 
HâpUæ
) == 0)

1053 
	`£ndXMLdesc
(
h
, 
gíC⁄√˘i⁄M™agî
);

1055 if(
	`°rcmp
(
X_MS_MEDIARECEIVERREGISTRAR_PATH
, 
HâpUæ
) == 0)

1057 
	`£ndXMLdesc
(
h
, 
gíX_MS_MedüRe˚ivîRegi°ør
);

1059 if(
	`°∫cmp
(
HâpUæ
, "/MediaItems/", 12) == 0)

1061 
	`SídRe•_d afûe
(
h
, 
HâpUæ
+12);

1063 if(
	`°∫cmp
(
HâpUæ
, "/Thumbnails/", 12) == 0)

1065 
	`SídRe•_thumb«û
(
h
, 
HâpUæ
+12);

1067 if(
	`°∫cmp
(
HâpUæ
, "/AlbumArt/", 10) == 0)

1069 
	`SídRe•_ÆbumAπ
(
h
, 
HâpUæ
+10);

1071 #ifde‡
TIVO_SUPPORT


1072 if(
	`°∫cmp
(
HâpUæ
, "/TiVoConnect", 12) == 0)

1074 if–
	`GETFLAG
(
TIVO_MASK
) )

1076 if–*(
HâpUæ
+12) == '?' )

1078 
	`Pro˚ssTiVoComm™d
(
h
, 
HâpUæ
+13);

1082 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "InvÆid TiVÿªque°! %s\n", 
HâpUæ
+12);

1083 
	`Síd404
(
h
);

1088 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "TiVoÑequest with out TiVo supportÉnabled! %s\n",

1089 
HâpUæ
+12);

1090 
	`Síd404
(
h
);

1094 if(
	`°∫cmp
(
HâpUæ
, "/Resized/", 9) == 0)

1096 
	`SídRe•_ªsizedimg
(
h
, 
HâpUæ
+9);

1098 if(
	`°∫cmp
(
HâpUæ
, "/icons/", 7) == 0)

1100 
	`SídRe•_ic⁄
(
h
, 
HâpUæ
+7);

1102 if(
	`°∫cmp
(
HâpUæ
, "/Captions/", 10) == 0)

1104 
	`SídRe•_ˇ±i⁄
(
h
, 
HâpUæ
+10);

1106 if(
	`°∫cmp
(
HâpUæ
, "/status", 7) == 0)

1108 
	`SídRe•_¥e£¡©i⁄
(
h
);

1110 if(
	`°rcmp
(
HâpUæ
, "/") == 0)

1112 #ifde‡
READYNAS


1113 
	`SídRe•_ªady«s_admö
(
h
);

1115 
	`SídRe•_¥e£¡©i⁄
(
h
);

1120 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "%†nŸ found,Ñe•⁄dög ERROR 404\n", 
HâpUæ
);

1121 
	`Síd404
(
h
);

1124 if(
	`°rcmp
("SUBSCRIBE", 
HâpComm™d
) == 0)

1126 
h
->
ªq_comm™d
 = 
ESubs¸ibe
;

1127 
	`Pro˚ssHTTPSubs¸ibe_u≤phâp
(
h
, 
HâpUæ
);

1129 if(
	`°rcmp
("UNSUBSCRIBE", 
HâpComm™d
) == 0)

1131 
h
->
ªq_comm™d
 = 
EUnSubs¸ibe
;

1132 
	`Pro˚ssHTTPUnSubs¸ibe_u≤phâp
(
h
, 
HâpUæ
);

1136 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "Unsuµ‹ãd HTTP Comm™d %s\n", 
HâpComm™d
);

1137 
	`Síd501
(
h
);

1139 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "end\n");

1140 
	}
}

1144 
	$Pro˚ss_u≤phâp
(
u≤phâp
 * 
h
)

1146 
buf
[2048];

1147 
n
;

1149 i‡(!
h
)

1154 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "°©ê%d\n", 
h
->
°©e
);

1156 
h
->
°©e
)

1159 
n
 = 
	`ªcv
(
h
->
sockë
, 
buf
, 2048, 0);

1160 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "¿%d\n", 
n
);

1161 if(
n
<0)

1163 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "ªcv (°©e0): %s\n", 
	`°ªº‹
(
î∫o
));

1164 
h
->
°©e
 = 100;

1166 if(
n
==0)

1168 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "HTTP Connection closed unexpectedly\n");

1169 
h
->
°©e
 = 100;

1170 
	`Clo£Sockë_u≤phâp
(
h
);

1174 c⁄° * 
ídhódîs
;

1177 
h
->
ªq_buf
 = (*)
	`ªÆloc
(h->ªq_buf, 
n
 + h->
ªq_buÊí
 + 1);

1178 
	`mem˝y
(
h
->
ªq_buf
 + h->
ªq_buÊí
, 
buf
, 
n
);

1179 
h
->
ªq_buÊí
 +
n
;

1180 
h
->
ªq_buf
[h->
ªq_buÊí
] = '\0';

1182 
ídhódîs
 = 
	`födídhódîs
(
h
->
ªq_buf
, h->
ªq_buÊí
);

1183 if(
ídhódîs
)

1185 
h
->
ªq_c⁄ã¡off
 = 
ídhódîs
 - h->
ªq_buf
 + 4;

1186 
h
->
ªq_c⁄ã¡Àn
 = h->
ªq_buÊí
 - h->
ªq_c⁄ã¡off
;

1187 
	`Pro˚ssHâpQuîy_u≤phâp
(
h
);

1193 
n
 = 
	`ªcv
(
h
->
sockë
, 
buf
, 2048, 0);

1194 if(
n
 < 0)

1196 i‡(
î∫o
 =
EINVAL
 ||Éºnÿ=
EAGAIN
)

1200 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "ªcv (°©e%d): %s\n", 
h
->
°©e
, 
	`°ªº‹
(
î∫o
));

1201 
h
->
°©e
 = 100;

1203 if(
n
==0)

1205 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "HTTP Connection closed unexpectedly\n");

1206 
h
->
°©e
 = 100;

1211 
h
->
ªq_buf
 = (*)
	`ªÆloc
(h->ªq_buf, 
n
 + h->
ªq_buÊí
);

1212 
	`mem˝y
(
h
->
ªq_buf
 + h->
ªq_buÊí
, 
buf
, 
n
);

1213 
h
->
ªq_buÊí
 +
n
;

1214 if((
h
->
ªq_buÊí
 - h->
ªq_c⁄ã¡off
Ë>h->
ªq_c⁄ã¡Àn
)

1217 if–
h
->
°©e
 == 1 )

1219 
	`P¨£HâpHódîs
(
h
);

1220 
	`Pro˚ssHTTPPOST_u≤phâp
(
h
);

1222 if–
h
->
°©e
 == 2 )

1224 
	`Pro˚ssHâpQuîy_u≤phâp
(
h
);

1230 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "U√x≥˘ed sèã: %d\n", 
h
->
°©e
);

1231 
	`LIST_REMOVE
(
h
, 
íåõs
);

1232 
	`Dñëe_u≤phâp
(
h
);

1235 
	}
}

1241 
	$BuûdHódî_u≤phâp
(
u≤phâp
 * 
h
, 
ª•code
,

1242 c⁄° * 
ª•msg
,

1243 
bodyÀn
)

1245 c⁄° 
hâ¥e•hód
[] =

1250 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n";

1251 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1252 
d©e
[30];

1253 
ãm∂í
;

1254 if(!
h
->
ªs_buf
)

1256 
ãm∂í
 = (
hâ¥e•hód
Ë+ 256 + 
bodyÀn
;

1257 
h
->
ªs_buf
 = (*)
	`mÆloc
(
ãm∂í
);

1258 
h
->
ªs_buf_Ælo˛í
 = 
ãm∂í
;

1260 
h
->
ªs_buÊí
 = 
	`¢¥ötf
(h->
ªs_buf
, h->
ªs_buf_Ælo˛í
,

1261 
hâ¥e•hód
, "HTTP/1.1",

1262 
ª•code
, 
ª•msg
,

1263 (
h
->
ª•Êags
&
FLAG_HTML
)?"text/html":"text/xml; charset=\"utf-8\"",

1264 
bodyÀn
);

1266 if(
h
->
ª•Êags
 & 
FLAG_TIMEOUT
) {

1267 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1268 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1270 if(
h
->
ªq_Timeout
) {

1271 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1272 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1273 "%d\r\n", 
h
->
ªq_Timeout
);

1275 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1276 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1280 if(
h
->
ª•Êags
 & 
FLAG_SID
) {

1281 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1282 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1283 "SID: %.*s\r\n", 
h
->
ªq_SIDLí
, h->
ªq_SID
);

1285 if(
h
->
ªqÊags
 & 
FLAG_LANGUAGE
) {

1286 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1287 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1290 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1291 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1292 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1293 "D©e: %s\r\n", 
d©e
);

1294 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1295 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1298 
h
->
ªs_buÊí
 +
	`¢¥ötf
(h->
ªs_buf
 + h->res_buflen,

1299 
h
->
ªs_buf_Ælo˛í
 - h->
ªs_buÊí
,

1302 
h
->
ªs_buf
[h->
ªs_buÊí
++] = '\r';

1303 
h
->
ªs_buf
[h->
ªs_buÊí
++] = '\n';

1304 if(
h
->
ªs_buf_Ælo˛í
 < (h->
ªs_buÊí
 + 
bodyÀn
))

1306 
h
->
ªs_buf
 = (*)
	`ªÆloc
(h->ªs_buf, (h->
ªs_buÊí
 + 
bodyÀn
));

1307 
h
->
ªs_buf_Ælo˛í
 = h->
ªs_buÊí
 + 
bodyÀn
;

1309 
	}
}

1312 
	$BuûdRe•2_u≤phâp
(
u≤phâp
 * 
h
, 
ª•code
,

1313 c⁄° * 
ª•msg
,

1314 c⁄° * 
body
, 
bodyÀn
)

1316 
	`BuûdHódî_u≤phâp
(
h
, 
ª•code
, 
ª•msg
, 
bodyÀn
);

1317 if–
h
->
ªq_comm™d
 =
EHód
 )

1319 if(
body
)

1320 
	`mem˝y
(
h
->
ªs_buf
 + h->
ªs_buÊí
, 
body
, 
bodyÀn
);

1321 
h
->
ªs_buÊí
 +
bodyÀn
;

1322 
	}
}

1326 
	$BuûdRe•_u≤phâp
(
u≤phâp
 *
h
, c⁄° *
body
, 
bodyÀn
)

1328 
	`BuûdRe•2_u≤phâp
(
h
, 200, "OK", 
body
, 
bodyÀn
);

1329 
	}
}

1332 
	$SídRe•_u≤phâp
(
u≤phâp
 * 
h
)

1334 
sum
 = 0;

1335 
n
 = 0;

1337 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "HTTP RESPONSE: %d, %.*s\n", 
h
->
ªs_buÊí
, h->ªs_buÊí, h->
ªs_buf
);

1338 
sum
 < 
h
->
ªs_buÊí
)

1340 
n
 = 
	`£nd
(
h
->
sockë
, h->
ªs_buf
 + 
sum
, h->
ªs_buÊí
 - sum, 0);

1341 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "£ndÑëu∫ %d\n", 
n
);

1342 if(
n
 < 0)

1344 i‡(
î∫o
 =
EINVAL
 ||Éºnÿ=
EAGAIN
)

1349 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "£nd‘es_buf): %s\n", 
	`°ªº‹
(
î∫o
));

1353 
sum
 +
n
;

1356 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "£ndÑëu∫ %d\n", 
sum
);

1358 if(
sum
 < 
h
->
ªs_buÊí
)

1361 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "£nd‘es_buf): %d byã†£¡ (ouào‡%d)\n", 
n
, 
h
->
ªs_buÊí
);

1363 
	}
}

1366 
	$£nd_d©a
(
u≤phâp
 * 
h
, * 
hódî
, 
size_t
 
size
, 
Êags
)

1368 
sum
 = 0;

1369 
ªt
 = 0;

1371 
sum
 < 
size
)

1373 
ªt
 = 
	`£nd
(
h
->
sockë
, 
hódî
 + 
sum
, 
size
 - sum, 
Êags
);

1374 i‡(
ªt
 < 0)

1376 i‡(
î∫o
 =
EINVAL
)

1382 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "£nd‘es_buf): %s\n", 
	`°ªº‹
(
î∫o
));

1383 
out
;

1387 
sum
 +
ªt
;

1390 
ªt
 = 0;

1392 
out
:

1393  
ªt
;

1394 
	}
}

1397 
	$£nd_fûe
(
u≤phâp
 * 
h
, 
£ndfd
, 
off_t
 
off£t
, off_à
íd_off£t
)

1399 
off_t
 
£nd_size
;

1400 
off_t
 
ªt
;

1401 *
buf
 = 
NULL
;

1402 #i‡
HAVE_SENDFILE


1403 
åy_£ndfûe
 = 1;

1406  
off£t
 <
íd_off£t
 )

1408 #i‡
HAVE_SENDFILE


1409 if–
åy_£ndfûe
 )

1411 
£nd_size
 = ( ((
íd_off£t
 - 
off£t
Ë< 
MAX_BUFFER_SIZE
) ? (end_offset - offset + 1) : MAX_BUFFER_SIZE);

1412 
ªt
 = 
	`sys_£ndfûe
(
h
->
sockë
, 
£ndfd
, &
off£t
, 
£nd_size
);

1413 if–
ªt
 == -1 )

1415 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "£ndfûêîr‹ ::Éº‹Ço. %d [%s]\n", 
î∫o
, 
	`°ªº‹
(errno));

1417 if–
î∫o
 =
EOVERFLOW
 ||Éºnÿ=
EINVAL
 )

1418 
åy_£ndfûe
 = 0;

1419 if–
î∫o
 !
EAGAIN
 )

1430 if–!
buf
 )

1431 
buf
 = 
	`mÆloc
(
MIN_BUFFER_SIZE
);

1432 
£nd_size
 = ( ((
íd_off£t
 - 
off£t
Ë< 
MIN_BUFFER_SIZE
) ? (end_offset - offset + 1) : MIN_BUFFER_SIZE);

1433 
	`l£ek
(
£ndfd
, 
off£t
, 
SEEK_SET
);

1434 
ªt
 = 
	`ªad
(
£ndfd
, 
buf
, 
£nd_size
);

1435 if–
ªt
 == -1 ) {

1436 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "ªadÉº‹ ::Éº‹Ço. %d [%s]\n", 
î∫o
, 
	`°ªº‹
(errno));

1437 if–
î∫o
 !
EAGAIN
 )

1440 
ªt
 = 
	`wrôe
(
h
->
sockë
, 
buf
,Ñet);

1441 if–
ªt
 == -1 ) {

1442 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "wrôêîr‹ ::Éº‹Ço. %d [%s]\n", 
î∫o
, 
	`°ªº‹
(errno));

1443 if–
î∫o
 !
EAGAIN
 )

1446 
off£t
+=
ªt
;

1449 i‡(
buf
 !
NULL
)

1451 
	`‰ì
(
buf
);

1453 
	}
}

1456 
	$£nd_chaö_cb
(
£nd_chaö
 *
chaö
)

1458 
u≤phâp
 *
h
 = 
chaö
->
uhâp
;

1459 
off_t
 
£nd_size
;

1460 
ªt
;

1462 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "send_chain_cb: socket = %d, fd = %d, offset = %ld, size = %ld\n",

1463 
h
->
sockë
, 
chaö
->
fd
, chaö->
off£t
, chaö->
size
);

1465 
£nd_size
 = 
chaö
->
size
 - chaö->
off£t
;

1466 i‡(
chaö
->
off£t
 < 0 || 
£nd_size
 <= 0)

1468 
ídfûe
;

1471 
£nd_size
 > 0)

1473 
£nd_size
 = síd_sizê< 
MAX_BUFFER_SIZE
 ? send_size : MAX_BUFFER_SIZE;

1474 
ªt
 = 
	`sys_£ndfûe
(
h
->
sockë
, 
chaö
->
fd
, &chaö->
off£t
, 
£nd_size
);

1475 i‡(
ªt
 == -1)

1477 i‡(
î∫o
 =
EINVAL
)

1481 i‡(
î∫o
 =
EAGAIN
)

1487 
ídfûe
;

1491 
£nd_size
 = 
chaö
->
size
 - chaö->
off£t
;

1494 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "send_chain_cb:Ñeturn\n");

1497 
ídfûe
:

1498 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "send_chain_cb: EOF\n");

1499 
	`˛o£
(
chaö
->
fd
);

1500 
	`‰ì
(
chaö
);

1501 
h
->
evít
->
wrôe
.
d©a
 = 
NULL
;

1502 
h
->
evít
->
wrôe
.
h™dÀr
 = 
NULL
;

1503 
	`evít_dñ
(
h
->
evít
);

1504 
	`evít_‰ì
(
h
->
evít
);

1505 
h
->
evít
 = 
NULL
;

1506 
	`Clo£Sockë_u≤phâp
(
h
);

1507 
	}
}

1510 
	$SídRe•_ic⁄
(
u≤phâp
 * 
h
, * 
ic⁄
)

1512 
hódî
[512];

1513 
mime
[12] = "image/";

1514 
d©e
[30];

1515 *
d©a
;

1516 
size
, 
ªt
;

1517 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1519 if–
	`°rcmp
(
ic⁄
, "sm.png") == 0 )

1521 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Sending small PNG icon\n");

1522 
d©a
 = (*)
≤g_sm
;

1523 
size
 = (
≤g_sm
)-1;

1524 
	`°r˝y
(
mime
+6, "png");

1526 if–
	`°rcmp
(
ic⁄
, "lrg.png") == 0 )

1528 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SendingÜarge PNG icon\n");

1529 
d©a
 = (*)
≤g_Ãg
;

1530 
size
 = (
≤g_Ãg
)-1;

1531 
	`°r˝y
(
mime
+6, "png");

1533 if–
	`°rcmp
(
ic⁄
, "sm.jpg") == 0 )

1535 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Sending small JPEG icon\n");

1536 
d©a
 = (*)
j≥g_sm
;

1537 
size
 = (
j≥g_sm
)-1;

1538 
	`°r˝y
(
mime
+6, "jpeg");

1540 if–
	`°rcmp
(
ic⁄
, "lrg.jpg") == 0 )

1542 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SendingÜarge JPEG icon\n");

1543 
d©a
 = (*)
j≥g_Ãg
;

1544 
size
 = (
j≥g_Ãg
)-1;

1545 
	`°r˝y
(
mime
+6, "jpeg");

1549 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "InvÆid ic⁄Ñeque°: %s\n", 
ic⁄
);

1550 
	`Síd404
(
h
);

1554 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1555 
ªt
 = 
	`¢¥ötf
(
hódî
, (header), "HTTP/1.1 200 OK\r\n"

1560 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n\r\n",

1561 
mime
, 
size
, 
d©e
);

1563 if–
	`£nd_d©a
(
h
, 
hódî
, 
ªt
, 
MSG_MORE
) == 0 )

1565 if–
h
->
ªq_comm™d
 !
EHód
 )

1566 
	`£nd_d©a
(
h
, 
d©a
, 
size
, 0);

1568 
	`Clo£Sockë_u≤phâp
(
h
);

1569 
	}
}

1572 
	$SídRe•_ÆbumAπ
(
u≤phâp
 * 
h
, * 
obje˘
)

1574 
hódî
[512];

1575 *
∑th
;

1576 
d©e
[30];

1577 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1578 
off_t
 
size
;

1579 
id
;

1580 
fd
, 
ªt
;

1582 if–
h
->
ªqÊags
 & (
FLAG_XFERSTREAMING
|
FLAG_RANGE
) )

1584 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ClientÅriedÅo specifyÅransferModeás Streaming withán image!\n");

1585 
	`Síd406
(
h
);

1589 
id
 = 
	`°πﬁl
(
obje˘
, 
NULL
, 10);

1591 
∑th
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT PATH from ALBUM_ART whîêID = '%Œd'", 
id
);

1592 if–!
∑th
 )

1594 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ALBUM_ART ID %†nŸ found,Ñe•⁄dög ERROR 404\n", 
obje˘
);

1595 
	`Síd404
(
h
);

1598 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "Sîvögálbumáπ ID: %Œd [%s]\n", 
id
, 
∑th
);

1600 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

1601 if–
fd
 < 0 ) {

1602 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Eº‹ o≥nög %s\n", 
∑th
);

1603 
	`sqlôe3_‰ì
(
∑th
);

1604 
	`Síd404
(
h
);

1607 
	`sqlôe3_‰ì
(
∑th
);

1608 
size
 = 
	`l£ek
(
fd
, 0, 
SEEK_END
);

1609 
	`l£ek
(
fd
, 0, 
SEEK_SET
);

1611 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1612 
ªt
 = 
	`¢¥ötf
(
hódî
, (header), "HTTP/1.1 200 OK\r\n"

1620 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n"

1622 (
ötmax_t
)
size
, 
d©e
);

1624 if–
	`£nd_d©a
(
h
, 
hódî
, 
ªt
, 
MSG_MORE
) == 0 )

1626 if–
h
->
ªq_comm™d
 !
EHód
 )

1627 
	`£nd_fûe
(
h
, 
fd
, 0, 
size
-1);

1629 
	`˛o£
(
fd
);

1630 
	`Clo£Sockë_u≤phâp
(
h
);

1631 
	}
}

1634 
	$SídRe•_ˇ±i⁄
(
u≤phâp
 * 
h
, * 
obje˘
)

1636 
hódî
[512];

1637 *
∑th
;

1638 
d©e
[30];

1639 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1640 
off_t
 
size
;

1641 
id
;

1642 
fd
, 
ªt
;

1644 
id
 = 
	`°πﬁl
(
obje˘
, 
NULL
, 10);

1646 
∑th
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT PATH from CAPTIONS whîêID = %Œd", 
id
);

1647 if–!
∑th
 )

1649 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "CAPTION ID %†nŸ found,Ñe•⁄dög ERROR 404\n", 
obje˘
);

1650 
	`Síd404
(
h
);

1653 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "Sîvög c≠ti⁄ ID: %Œd [%s]\n", 
id
, 
∑th
);

1655 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

1656 if–
fd
 < 0 ) {

1657 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Eº‹ o≥nög %s\n", 
∑th
);

1658 
	`sqlôe3_‰ì
(
∑th
);

1659 
	`Síd404
(
h
);

1662 
	`sqlôe3_‰ì
(
∑th
);

1663 
size
 = 
	`l£ek
(
fd
, 0, 
SEEK_END
);

1664 
	`l£ek
(
fd
, 0, 
SEEK_SET
);

1666 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1667 
ªt
 = 
	`¢¥ötf
(
hódî
, (header), "HTTP/1.1 200 OK\r\n"

1673 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n\r\n",

1674 (
ötmax_t
)
size
, 
d©e
);

1676 if–
	`£nd_d©a
(
h
, 
hódî
, 
ªt
, 
MSG_MORE
) == 0 )

1678 if–
h
->
ªq_comm™d
 !
EHód
 )

1679 
	`£nd_fûe
(
h
, 
fd
, 0, 
size
-1);

1681 
	`˛o£
(
fd
);

1682 
	`Clo£Sockë_u≤phâp
(
h
);

1683 
	}
}

1686 
	$SídRe•_thumb«û
(
u≤phâp
 * 
h
, * 
obje˘
)

1688 
hódî
[512];

1689 *
∑th
;

1690 
d©e
[30];

1691 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1692 
id
;

1693 
ªt
;

1694 
ExifD©a
 *
ed
;

1695 
ExifLﬂdî
 *
l
;

1697 if–
h
->
ªqÊags
 & (
FLAG_XFERSTREAMING
|
FLAG_RANGE
) )

1699 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ClientÅriedÅo specifyÅransferModeás Streaming withán image!\n");

1700 
	`Síd406
(
h
);

1704 
id
 = 
	`°πﬁl
(
obje˘
, 
NULL
, 10);

1705 
∑th
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT PATH from DETAILS whîêID = '%Œd'", 
id
);

1706 if–!
∑th
 )

1708 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "DETAIL ID %†nŸ found,Ñe•⁄dög ERROR 404\n", 
obje˘
);

1709 
	`Síd404
(
h
);

1712 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "SîvögÅhumb«û f‹ Obje˘Id: %Œd [%s]\n", 
id
, 
∑th
);

1714 if–
	`ac˚ss
(
∑th
, 
F_OK
) != 0 )

1716 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Eº‹ác˚ssög %s\n", 
∑th
);

1717 
	`sqlôe3_‰ì
(
∑th
);

1721 
l
 = 
	`exif_lﬂdî_√w
();

1722 
	`exif_lﬂdî_wrôe_fûe
(
l
, 
∑th
);

1723 
ed
 = 
	`exif_lﬂdî_gë_d©a
(
l
);

1724 
	`exif_lﬂdî_uƒef
(
l
);

1725 
	`sqlôe3_‰ì
(
∑th
);

1727 if–!
ed
 || !ed->
size
 )

1729 
	`Síd404
(
h
);

1730 if–
ed
 )

1731 
	`exif_d©a_uƒef
(
ed
);

1734 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1735 
ªt
 = 
	`¢¥ötf
(
hódî
, (header), "HTTP/1.1 200 OK\r\n"

1743 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n"

1745 (
ötmax_t
)
ed
->
size
, 
d©e
);

1747 if–
	`£nd_d©a
(
h
, 
hódî
, 
ªt
, 
MSG_MORE
) == 0 )

1749 if–
h
->
ªq_comm™d
 !
EHód
 )

1750 
	`£nd_d©a
(
h
, (*)
ed
->
d©a
,Éd->
size
, 0);

1752 
	`exif_d©a_uƒef
(
ed
);

1753 
	`Clo£Sockë_u≤phâp
(
h
);

1754 
	}
}

1757 
	$SídRe•_ªsizedimg
(
u≤phâp
 * 
h
, * 
obje˘
)

1759 
hódî
[512];

1760 
buf
[128];

1761 
°rög_s
 
°r
;

1762 **
ªsu…
;

1763 
d©e
[30];

1764 *
d a_≤
 = 
NULL
;

1765 
uöt32_t
 
d a_Êags
 = 
DLNA_FLAG_DLNA_V1_5
|
DLNA_FLAG_HTTP_STALLING
|
DLNA_FLAG_TM_B
|
DLNA_FLAG_TM_I
;

1766 
time_t
 
cuπime
 = 
	`time
(
NULL
);

1767 
width
=640, 
height
=480, 
d°w
, 
d°h
, 
size
;

1768 
§cw
, 
§ch
;

1769 * 
d©a
 = 
NULL
;

1770 *
∑th
, *
fûe_∑th
 = 
NULL
;

1771 *
ªsﬁuti⁄
 = 
NULL
;

1772 *
mime
 = 
NULL
;

1773 *
key
, *
vÆ
;

1774 *
ßvïå
, *
ôem
 = 
NULL
;

1775 
rŸ©e
 = 0;

1778 
id
;

1779 
rows
=0, 
chunked
, 
ªt
;

1780 
image_s
 *
im§c
 = 
NULL
, *
imd°
 = NULL;

1781 
sˇÀ
 = 1;

1783 
id
 = 
	`°πﬁl
(
obje˘
, &
ßvïå
, 10);

1784 
	`¢¥ötf
(
buf
, (buf), "SELECT PATH, RESOLUTION, ROTATION, MIME, DLNA_PN from DETAILS whîêID = '%Œd'", ()
id
);

1785 
ªt
 = 
	`sql_gë_èbÀ
(
db
, 
buf
, &
ªsu…
, &
rows
, 
NULL
);

1786 if–
ªt
 !
SQLITE_OK
 )

1788 
	`Síd500
(
h
);

1791 if–
rows
 )

1793 
fûe_∑th
 = 
ªsu…
[5];

1794 
ªsﬁuti⁄
 = 
ªsu…
[6];

1795 
rŸ©e
 = 
ªsu…
[7] ? 
	`©oi
(result[7]) : 0;

1796 
mime
 = 
ªsu…
[8];

1797 
d a_≤
 = 
ªsu…
[9];

1799 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "file_path: %s,Ñesolution: %s,Ñotate: %d, mime: %s\n",

1800 
fûe_∑th
, 
ªsﬁuti⁄
, 
rŸ©e
, 
mime
);

1801 if–!
fûe_∑th
 || !
ªsﬁuti⁄
 || (
	`ac˚ss
(fûe_∑th, 
F_OK
Ë!0Ë|| !
mime
)

1803 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "%†nŸ found,Ñe•⁄dög ERROR 404\n", 
obje˘
);

1804 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

1805 
	`Síd404
(
h
);

1809 if–
ßvïå
 )

1810 
ßvïå
 = 
	`°rchr
(saveptr, '?');

1811 
∑th
 = 
ßvïå
 ? savïå + 1 : 
obje˘
;

1812  
ôem
 = 
	`°πok_r
(
∑th
, "&,", &
ßvïå
); iãm !
NULL
; item = strtok_r(NULL, "&,", &saveptr) )

1814 
	`decodeSåög
(
ôem
, 1);

1815 
vÆ
 = 
ôem
;

1816 
key
 = 
	`°r£p
(&
vÆ
, "=");

1817 if–!
vÆ
 )

1819 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "%s: %s\n", 
key
, 
vÆ
);

1820 if–
	`°rˇ£cmp
(
key
, "width") == 0 )

1822 
width
 = 
	`©oi
(
vÆ
);

1824 if–
	`°rˇ£cmp
(
key
, "height") == 0 )

1826 
height
 = 
	`©oi
(
vÆ
);

1828 if–
	`°rˇ£cmp
(
key
, "rotation") == 0 )

1830 
rŸ©e
 = (rŸ©ê+ 
	`©oi
(
vÆ
)) % 360;

1831 
	`sql_exec
(
db
, "UPDATE DETAILS së ROTATION = %d whîêID = %Œd", 
rŸ©e
, 
id
);

1840 #i‡
USE_FORK


1841 
pid_t
 
√wpid
 = 0;

1842 
√wpid
 = 
	`¥o˚ss_f‹k
();

1843 if–
√wpid
 > 0 )

1845 
	`Clo£Sockë_u≤phâp
(
h
);

1846 
ªsized_îr‹
;

1849 if–
h
->
ªqÊags
 & (
FLAG_XFERSTREAMING
|
FLAG_RANGE
) )

1851 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ClientÅriedÅo specifyÅransferModeás Streaming withán image!\n");

1852 
	`Síd406
(
h
);

1853 
ªsized_îr‹
;

1856 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "SîvögÑesized imagêf‹ Obje˘Id: %Œd [%s]\n", 
id
, 
fûe_∑th
);

1857  
rŸ©e
 )

1860 
ªt
 = 
	`ssˇnf
(
ªsﬁuti⁄
, "%dx%d", &
§ch
, &
§cw
);

1861 
rŸ©e
 = 
ROTATE_90
;

1864 
ªt
 = 
	`ssˇnf
(
ªsﬁuti⁄
, "%dx%d", &
§ch
, &
§cw
);

1865 
rŸ©e
 = 
ROTATE_270
;

1868 
ªt
 = 
	`ssˇnf
(
ªsﬁuti⁄
, "%dx%d", &
§cw
, &
§ch
);

1869 
rŸ©e
 = 
ROTATE_180
;

1872 
ªt
 = 
	`ssˇnf
(
ªsﬁuti⁄
, "%dx%d", &
§cw
, &
§ch
);

1873 
rŸ©e
 = 
ROTATE_NONE
;

1876 if–
ªt
 != 2 )

1878 
	`Síd500
(
h
);

1882 
d°w
 = 
width
;

1883 
d°h
 = ((((
width
<<10)/
§cw
)*
§ch
)>>10);

1884 if–
d°h
 > 
height
 )

1886 
d°h
 = 
height
;

1887 
d°w
 = (((
height
<<10)/
§ch
Ë* 
§cw
>>10);

1891 if–
d°w
 <160 && 
d°h
 <= 160 )

1892 
	`°r˝y
(
d a_≤
, "DLNA.ORG_PN=JPEG_TN;");

1893 if–
d°w
 <640 && 
d°h
 <= 480 )

1894 
	`°r˝y
(
d a_≤
, "DLNA.ORG_PN=JPEG_SM;");

1895 if–
d°w
 <1024 && 
d°h
 <= 768 )

1896 
	`°r˝y
(
d a_≤
, "DLNA.ORG_PN=JPEG_MED;");

1898 
	`°r˝y
(
d a_≤
, "DLNA.ORG_PN=JPEG_LRG;");

1901 if–
§cw
>>4 >
d°w
 && 
§ch
>>4 >
d°h
)

1902 
sˇÀ
 = 8;

1903 if–
§cw
>>3 >
d°w
 && 
§ch
>>3 >
d°h
 )

1904 
sˇÀ
 = 4;

1905 if–
§cw
>>2 >
d°w
 && 
§ch
>>2 >
d°h
 )

1906 
sˇÀ
 = 2;

1908 
°r
.
d©a
 = 
hódî
;

1909 
°r
.
size
 = (
hódî
);

1910 
°r
.
off
 = 0;

1912 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

1913 
	`°rˇtf
(&
°r
, "HTTP/1.1 200 OK\r\n"

1920 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n",

1921 
mime
, 
d©e
, 
d a_≤
, 1, 
d a_Êags
, 0);

1922 #i‡
USE_FORK


1923 if–(
h
->
ªqÊags
 & 
FLAG_XFERBACKGROUND
Ë&& (
	`£çri‹ôy
(
PRIO_PROCESS
, 0, 19) == 0) )

1924 
	`°rˇtf
(&
°r
, "transferMode.dlna.org: Background\r\n");

1927 
	`°rˇtf
(&
°r
, "transferMode.dlna.org: Interactive\r\n");

1929 if–
	`°rcmp
(
h
->
HâpVî
, "HTTP/1.0") == 0 )

1931 
chunked
 = 0;

1932 
im§c
 = 
	`image_√w_‰om_j≥g
(
fûe_∑th
, 1, 
NULL
, 0, 
sˇÀ
, 
rŸ©e
);

1936 
chunked
 = 1;

1937 
	`°rˇtf
(&
°r
, "Transfer-Encoding: chunked\r\n\r\n");

1940 if–!
chunked
 )

1942 if–!
im§c
 )

1944 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "U«bÀÅÿ›í imagê%s!\n", 
fûe_∑th
);

1945 
	`Síd500
(
h
);

1946 
ªsized_îr‹
;

1949 
imd°
 = 
	`image_ªsize
(
im§c
, 
d°w
, 
d°h
);

1950 
d©a
 = 
	`image_ßve_to_j≥g_buf
(
imd°
, &
size
);

1952 
	`°rˇtf
(&
°r
, "C⁄ã¡-Lígth: %d\r\n\r\n", 
size
);

1955 if–(
	`£nd_d©a
(
h
, 
°r
.
d©a
, så.
off
, 0Ë=0Ë&& (h->
ªq_comm™d
 !
EHód
) )

1957 if–
chunked
 )

1959 
im§c
 = 
	`image_√w_‰om_j≥g
(
fûe_∑th
, 1, 
NULL
, 0, 
sˇÀ
, 
rŸ©e
);

1960 if–!
im§c
 )

1962 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "U«bÀÅÿ›í imagê%s!\n", 
fûe_∑th
);

1963 
	`Síd500
(
h
);

1964 
ªsized_îr‹
;

1966 
imd°
 = 
	`image_ªsize
(
im§c
, 
d°w
, 
d°h
);

1967 
d©a
 = 
	`image_ßve_to_j≥g_buf
(
imd°
, &
size
);

1969 
ªt
 = 
	`•rötf
(
buf
, "%x\r\n", 
size
);

1970 
	`£nd_d©a
(
h
, 
buf
, 
ªt
, 
MSG_MORE
);

1971 
	`£nd_d©a
(
h
, (*)
d©a
, 
size
, 
MSG_MORE
);

1972 
	`£nd_d©a
(
h
, "\r\n0\r\n\r\n", 7, 0);

1976 
	`£nd_d©a
(
h
, (*)
d©a
, 
size
, 0);

1979 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "D⁄ê£rvög %s\n", 
fûe_∑th
);

1980 if–
im§c
 )

1981 
	`image_‰ì
(
im§c
);

1982 if–
imd°
 )

1983 
	`image_‰ì
(
imd°
);

1984 i‡(
d©a
)

1986 
	`‰ì
(
d©a
);

1988 
	`Clo£Sockë_u≤phâp
(
h
);

1989 
ªsized_îr‹
:

1990 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

1991 #i‡
USE_FORK


1992 if–
√wpid
 == 0 )

1993 
	`_exô
(0);

1995 
	}
}

1998 
	$SídRe•_d afûe
(
u≤phâp
 *
h
, *
obje˘
)

2000 
hódî
[1024];

2001 
°rög_s
 
°r
;

2002 
buf
[128];

2003 **
ªsu…
;

2004 
rows
, 
ªt
;

2005 
d©e
[30];

2006 
time_t
 
cuπime
 = 
	`time
(
NULL
);

2007 
off_t
 
tŸÆ
, 
off£t
, 
size
;

2008 
öt64_t
 
id
;

2009 
£ndfh
 = -1;

2010 
uöt32_t
 
d a_Êags
 = 
DLNA_FLAG_DLNA_V1_5
|
DLNA_FLAG_HTTP_STALLING
|
DLNA_FLAG_TM_B
;

2011 
uöt32_t
 
cÊags
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
Êags
;

2013 
öt64_t
 
id
;

2014 
˛õ¡_ty≥s
 
˛õ¡
;

2015 
∑th
[
PATH_MAX
];

2016 
mime
[32];

2017 
d a
[96];

2018 } 
œ°_fûe
 = { 0, 0 };

2020 
id
 = 
	`°πﬁl
(
obje˘
, 
NULL
, 10);

2021 if–
cÊags
 & 
FLAG_MS_PFS
 )

2023 if–
	`°r°r
(
obje˘
, "?albumArt=true") )

2025 *
¨t
;

2026 
¨t
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT ALBUM_ART from DETAILS whîêID = '%Œd'", 
id
);

2027 
	`SídRe•_ÆbumAπ
(
h
, 
¨t
);

2028 
	`sqlôe3_‰ì
(
¨t
);

2032 if–
id
 !
œ°_fûe
.id || 
h
->
ªq_˛õ¡
 !œ°_fûe.
˛õ¡
 )

2034 
	`¢¥ötf
(
buf
, (buf), "SELECT PATH, MIME, DLNA_PN from DETAILS whîêID = '%Œd'", ()
id
);

2035 
ªt
 = 
	`sql_gë_èbÀ
(
db
, 
buf
, &
ªsu…
, &
rows
, 
NULL
);

2036 if–(
ªt
 !
SQLITE_OK
) )

2038 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Didn'àföd vÆid fûêf‹ %Œd!\n", 
id
);

2039 
	`Síd500
(
h
);

2042 if–!
rows
 || !
ªsu…
[3] || !result[4] )

2044 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "%†nŸ found,Ñe•⁄dög ERROR 404\n", 
obje˘
);

2045 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

2046 
	`Síd404
(
h
);

2050 
œ°_fûe
.
id
 = id;

2051 
œ°_fûe
.
˛õ¡
 = 
h
->
ªq_˛õ¡
;

2052 
	`°∫˝y
(
œ°_fûe
.
∑th
, 
ªsu…
[3], (last_file.path)-1);

2053 if–
ªsu…
[4] )

2055 
	`°∫˝y
(
œ°_fûe
.
mime
, 
ªsu…
[4], (last_file.mime)-1);

2057 if–
cÊags
 & 
FLAG_SAMSUNG
 )

2059 if–
	`°rcmp
(
œ°_fûe
.
mime
+6, "x-matroska") == 0 )

2060 
	`°r˝y
(
œ°_fûe
.
mime
+8, "mkv");

2064 if–
h
->
ªq_˛õ¡
 =
ESamsungSîõsA
 &&

2065 
	`°rcmp
(
œ°_fûe
.
mime
+6, "x-msvideo") == 0 )

2066 
	`°r˝y
(
œ°_fûe
.
mime
+6, "mpeg");

2069 if–
h
->
ªq_˛õ¡
 =
ES⁄yBDP
 )

2071 if–
	`°rcmp
(
œ°_fûe
.
mime
+6, "x-matroska") == 0 ||

2072 
	`°rcmp
(
œ°_fûe
.
mime
+6, "mpeg") == 0 )

2073 
	`°r˝y
(
œ°_fûe
.
mime
+6, "divx");

2076 if–
ªsu…
[5] )

2077 
	`¢¥ötf
(
œ°_fûe
.
d a
, ÷a°_fûe.d a), "DLNA.ORG_PN=%s;", 
ªsu…
[5]);

2079 
œ°_fûe
.
d a
[0] = '\0';

2080 
	`sqlôe3_‰ì_èbÀ
(
ªsu…
);

2083 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "Sîvög DëaûID: %Œd [%s]\n", 
id
, 
œ°_fûe
.
∑th
);

2085 if–
h
->
ªqÊags
 & 
FLAG_XFERSTREAMING
 )

2087 if–
	`°∫cmp
(
œ°_fûe
.
mime
, "image", 5) == 0 )

2089 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ClientÅriedÅo specifyÅransferModeás Streaming withán image!\n");

2090 
	`Síd406
(
h
);

2091 
out
;

2094 if–
h
->
ªqÊags
 & 
FLAG_XFERINTERACTIVE
 )

2096 if–
h
->
ªqÊags
 & 
FLAG_REALTIMEINFO
 )

2098 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "BadÑealTimeInfo flag with InteractiveÑequest!\n");

2099 
	`Síd400
(
h
);

2100 
out
;

2102 if–
	`°∫cmp
(
œ°_fûe
.
mime
, "image", 5) != 0 )

2104 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ClientÅriedÅo specifyÅransferModeás Interactive withoután image!\n");

2107 if–!(
cÊags
 & 
FLAG_SAMSUNG
Ë|| 
	`GETFLAG
(
DLNA_STRICT_MASK
) )

2109 
	`Síd406
(
h
);

2110 
out
;

2115 
off£t
 = 
h
->
ªq_R™geSèπ
;

2116 
£ndfh
 = 
	`›í
(
œ°_fûe
.
∑th
, 
O_RDONLY
);

2117 if–
£ndfh
 < 0 )

2119 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Eº‹ o≥nög %s: %s\n", 
œ°_fûe
.
∑th
, 
	`°ªº‹
(
î∫o
));

2120 
	`Síd404
(
h
);

2121 
out
;

2123 
size
 = 
	`l£ek
(
£ndfh
, 0, 
SEEK_END
);

2124 
	`l£ek
(
£ndfh
, 0, 
SEEK_SET
);

2126 
°r
.
d©a
 = 
hódî
;

2127 
°r
.
size
 = (
hódî
);

2128 
°r
.
off
 = 0;

2130 
	`°rˇtf
(&
°r
, "HTTP/1.1 20%c OK\r\n"

2132 (
h
->
ªqÊags
 & 
FLAG_RANGE
 ? '6' : '0'),

2133 
œ°_fûe
.
mime
);

2134 if–
h
->
ªqÊags
 & 
FLAG_RANGE
 )

2136 if–!
h
->
ªq_R™geEnd
 || h->ªq_R™geEnd =
size
 )

2138 
h
->
ªq_R™geEnd
 = 
size
 - 1;

2140 if–(
h
->
ªq_R™geSèπ
 > h->
ªq_R™geEnd
) || (h->req_RangeStart < 0) )

2142 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "SpecifiedÑange was invalid!\n");

2143 
	`Síd400
(
h
);

2144 
out
;

2146 if–
h
->
ªq_R™geEnd
 >
size
 )

2148 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "SpecifiedÑange was outside file boundaries!\n");

2149 
	`Síd416
(
h
);

2150 
out
;

2153 
tŸÆ
 = 
h
->
ªq_R™geEnd
 - h->
ªq_R™geSèπ
 + 1;

2154 
	`°rˇtf
(&
°r
, "Content-Length: %jd\r\n"

2156 (
ötmax_t
)
tŸÆ
, (ötmax_t)
h
->
ªq_R™geSèπ
,

2157 (
ötmax_t
)
h
->
ªq_R™geEnd
, (ötmax_t)
size
);

2161 
h
->
ªq_R™geEnd
 = 
size
 - 1;

2162 
tŸÆ
 = 
size
;

2163 
	`°rˇtf
(&
°r
, "C⁄ã¡-Lígth: %jd\r\n", (
ötmax_t
)
tŸÆ
);

2167 if–(
h
->
ªqÊags
 & 
FLAG_XFERBACKGROUND
Ë&& (
	`£çri‹ôy
(
PRIO_PROCESS
, 0, 19) == 0) )

2168 
	`°rˇtf
(&
°r
, "transferMode.dlna.org: Background\r\n");

2171 if–
	`°∫cmp
(
œ°_fûe
.
mime
, "image", 5) == 0 )

2172 
	`°rˇtf
(&
°r
, "transferMode.dlna.org: Interactive\r\n");

2174 
	`°rˇtf
(&
°r
, "transferMode.dlna.org: Streaming\r\n");

2176  *
œ°_fûe
.
mime
 )

2179 
d a_Êags
 |
DLNA_FLAG_TM_I
;

2184 
d a_Êags
 |
DLNA_FLAG_TM_S
;

2188 if–
h
->
ªqÊags
 & 
FLAG_CAPTION
 )

2190 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from CAPTIONS whîêID = '%Œd'", 
id
) > 0 )

2191 
	`°rˇtf
(&
°r
, "CaptionInfo.sec: http://%s:%d/Captions/%lld.srt\r\n",

2192 
œn_addr
[
h
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
id
);

2195 
	`°r·ime
(
d©e
, 30,"%a, %d %b %Y %H:%M:%S GMT" , 
	`gmtime
(&
cuπime
));

2196 
	`°rˇtf
(&
°r
, "Accept-Ranges: bytes\r\n"

2202 "Sîvî: " 
MINIDLNA_SERVER_STRING
 "\r\n\r\n",

2203 
d©e
, 
œ°_fûe
.
d a
, 1, 0, 
d a_Êags
, 0);

2206 
ªt
 = 
	`£nd_d©a
(
h
, 
°r
.
d©a
, så.
off
, 
MSG_MORE
);

2207 i‡(
ªt
 != 0)

2209 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "send_data failed\n");

2210 
out
;

2213 i‡(
h
->
ªq_comm™d
 =
EHód
)

2216 
out
;

2220 
ªt
 = 
	`u≤phâp_£ndQueue
(
h
, 
£ndfh
, 
off£t
, h->
ªq_R™geEnd
 + 1);

2221 i‡(
ªt
 != 0)

2223 
out
;

2228 
out
:

2229 i‡(
£ndfh
 > -1)

2231 
	`˛o£
(
£ndfh
);

2233 
	`Clo£Sockë_u≤phâp
(
h
);

2235 
	}
}

2241 
	$u≤phâp_›íSockë
(
p‹t
)

2243 
s
;

2244 
i
 = 1;

2245 
sockaddr_ö
 
li°í«me
;

2248 
	`mem£t
(&
˛õ¡s
, 0, (
˛õ¡_ˇche_s
));

2250 
s
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

2251 i‡(
s
 < 0)

2253 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "sockë(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

2257 i‡(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
i
, (i)) < 0)

2259 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "£tsock›t(hâp, SO_REUSEADDR): %s\n", 
	`°ªº‹
(
î∫o
));

2262 
	`mem£t
(&
li°í«me
, 0, (
sockaddr_ö
));

2263 
li°í«me
.
sö_Ámûy
 = 
AF_INET
;

2264 
li°í«me
.
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

2265 
li°í«me
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_ANY
);

2267 i‡(
	`böd
(
s
, (
sockaddr
 *)&
li°í«me
, (
sockaddr_ö
)) < 0)

2269 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "böd(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

2270 
	`˛o£
(
s
);

2274 i‡(
	`li°í
(
s
, 6) < 0)

2276 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "li°í(hâp): %s\n", 
	`°ªº‹
(
î∫o
));

2277 
	`˛o£
(
s
);

2281  
s
;

2282 
	}
}

2285 
	$u≤phâp_£ndQueue
(
u≤phâp
 *
h
, 
fd
, 
off_t
 
off£t
, off_à
size
)

2287 
£nd_chaö
 *
chaö
 = 
NULL
;

2288 
evít_°ru˘
 *
evt
 = 
NULL
;

2289 
ªt
 = 0;

2291 i‡(
	`f˙é
(
h
->
sockë
, 
F_SETFL
, 
O_NONBLOCK
) < 0)

2293 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "fcntl F_SETFL, O_NONBLOCK\n");

2294 
out
;

2297 
chaö
 = 
	`ˇŒoc
(1, (
£nd_chaö
));

2298 i‡(!
chaö
)

2300 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "ˇŒo¯Áûed: %d, %s\n", 
î∫o
, 
	`°ªº‹
(errno));

2301 
out
;

2304 
evt
 = 
h
->
evít
;

2305 
evt
->
ªad
.
d©a
 = 
NULL
;

2306 
evt
->
ªad
.
h™dÀr
 = 
NULL
;

2307 
evt
->
wrôe
.
d©a
 = 
chaö
;

2308 
evt
->
wrôe
.
h™dÀr
 = (
EVENT_HANDLER
)
£nd_chaö_cb
;

2310 
chaö
->
uhâp
 = 
h
;

2311 
chaö
->
fd
 = fd;

2312 
chaö
->
off£t
 = offset;

2313 
chaö
->
size
 = 
h
->
ªq_R™geEnd
 + 1;

2315 
ªt
 = 
	`evít_˘l
(
evt
, 
EPOLL_CTL_MOD
, 
EPOLLOUT
 | 
EPOLLET
);

2316 i‡(
ªt
 != 0)

2318 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "event_ctl(%d) failed: %d, %s\n",

2319 
evt
->
sock
, 
î∫o
, 
	`°ªº‹
(errno));

2320 
out
;

2325 
out
:

2326 i‡(
chaö
)

2328 
	`‰ì
(
chaö
);

2330 i‡(
evt
)

2332 
	`evít_dñ
(
evt
);

2333 
	`mem£t
(
evt
, 0, (
evít_°ru˘
));

2336 
	}
}

2338 
	$u≤phâp_c⁄nCou¡
()

2340 
u≤phâp
 *
e
;

2341 
cou¡
 = 0;

2343 
e
 = 
u≤phâphód
.
lh_fú°
;É !
NULL
;É =É->
íåõs
.
À_√xt
)

2345 i‡((
e
->
sockë
 >0Ë&& (e->
°©e
 <= 2))

2347 
cou¡
++;

2351  
cou¡
;

2352 
	}
}

2354 
	$u≤phâp_öô
(
p‹t
)

2356 
evít_°ru˘
 *
evt
;

2357 
ªt
;

2360 
shâ∂
 = 
	`u≤phâp_›íSockë
(
p‹t
);

2361 i‡(
shâ∂
 < 0)

2363 
	`DPRINTF
(
E_FATAL
, 
L_HTTP
, "FailedÅo open socket for HTTP. EXITING\n");

2365 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "HTTPÜi°íög o¿p‹à%d\n", 
ru¡ime_v¨s
.
p‹t
);

2367 
evt
 = 
	`evít_mÆloc
(
shâ∂
);

2368 i‡(!
evt
)

2370 
	`DPRINTF
(
E_FATAL
, 
L_HTTP
, "FailedÅo mallocÉvent_struct. EXITING\n");

2372 
evt
->
ªad
.
d©a
 = &evt->
sock
;

2373 
evt
->
ªad
.
h™dÀr
 = (
EVENT_HANDLER
)
Ac˚±Sockë_u≤phâp
;

2374 
ªt
 = 
	`evít_˘l
(
evt
, 
EPOLL_CTL_ADD
, 
EPOLLIN
);

2375 i‡(
ªt
 != 0)

2377 
	`DPRINTF
(
E_FATAL
, 
L_HTTP
, "FailedÅoÉvent_ctl smonitor. EXITING\n");

2380  
ªt
;

2381 
	}
}

2383 
	$u≤phâp_exô
()

2385 
u≤phâp
 *
e
;

2388 
u≤phâphód
.
lh_fú°
 !
NULL
)

2390 
e
 = 
u≤phâphód
.
lh_fú°
;

2391 
	`LIST_REMOVE
(
e
, 
íåõs
);

2392 
	`Dñëe_u≤phâp
(
e
);

2395 i‡(
shâ∂
 >= 0)

2397 
	`˛o£
(
shâ∂
);

2398 
shâ∂
 = -1;

2400 
	}
}

	@upnphttp.h

49 #i‚de‡
__UPNPHTTP_H__


50 
	#__UPNPHTTP_H__


	)

52 
	~<√töë/ö.h
>

53 
	~<sys/queue.h
>

55 
	~"möid ©y≥s.h
"

56 
	~"c⁄fig.h
"

59 
	#MINIDLNA_SERVER_STRING
 
OS_VERSION
 " DLNADOC/1.50 UPnP/1.0 " 
SERVER_NAME
 "/" 
MINIDLNA_VERSION


	)

68 
	ehâpComm™ds
 {

69 
	mEUnknown
 = 0,

70 
	mEGë
,

71 
	mEPo°
,

72 
	mEHód
,

73 
	mESubs¸ibe
,

74 
	mEUnSubs¸ibe


77 
	su≤phâp
 {

78 
	msockë
;

79 
ö_addr
 
	m˛õ¡addr
;

80 
	miÁ˚
;

81 
	m°©e
;

82 
	mHâpVî
[16];

84 * 
	mªq_buf
;

85 
	mªq_buÊí
;

86 
	mªq_c⁄ã¡Àn
;

87 
	mªq_c⁄ã¡off
;

88 
hâpComm™ds
 
	mªq_comm™d
;

89 
˛õ¡_ty≥s
 
	mªq_˛õ¡
;

90 c⁄° * 
	mªq_sﬂpA˘i⁄
;

91 
	mªq_sﬂpA˘i⁄Lí
;

92 c⁄° * 
	mªq_CÆlback
;

93 
	mªq_CÆlbackLí
;

94 c⁄° * 
	mªq_NT
;

95 
	mªq_NTLí
;

96 
	mªq_Timeout
;

97 c⁄° * 
	mªq_SID
;

98 
	mªq_SIDLí
;

99 
off_t
 
	mªq_R™geSèπ
;

100 
off_t
 
	mªq_R™geEnd
;

101 
	mªq_chunkÀn
;

102 
uöt32_t
 
	mªqÊags
;

104 * 
	mªs_buf
;

105 
	mªs_buÊí
;

106 
	mªs_buf_Ælo˛í
;

107 
uöt32_t
 
	mª•Êags
;

110 
evít_°ru˘
 *
	mevít
;

111 
LIST_ENTRY
(
u≤phâp
Ë
	míåõs
;

114 
	#FLAG_TIMEOUT
 0x00000001

	)

115 
	#FLAG_SID
 0x00000002

	)

116 
	#FLAG_RANGE
 0x00000004

	)

117 
	#FLAG_HOST
 0x00000008

	)

118 
	#FLAG_LANGUAGE
 0x00000010

	)

120 
	#FLAG_INVALID_REQ
 0x00000040

	)

121 
	#FLAG_HTML
 0x00000080

	)

123 
	#FLAG_CHUNKED
 0x00000100

	)

124 
	#FLAG_TIMESEEK
 0x00000200

	)

125 
	#FLAG_REALTIMEINFO
 0x00000400

	)

126 
	#FLAG_PLAYSPEED
 0x00000800

	)

127 
	#FLAG_XFERSTREAMING
 0x00001000

	)

128 
	#FLAG_XFERINTERACTIVE
 0x00002000

	)

129 
	#FLAG_XFERBACKGROUND
 0x00004000

	)

130 
	#FLAG_CAPTION
 0x00008000

	)

132 #i‚de‡
MSG_MORE


133 
	#MSG_MORE
 0

	)

137 
u≤phâp
 *

138 
New_u≤phâp
();

142 
Clo£Sockë_u≤phâp
(
u≤phâp
 *);

146 
Ac˚±Sockë_u≤phâp
(*
sock
);

150 
Dñëe_u≤phâp
(
u≤phâp
 *);

154 
Pro˚ss_u≤phâp
(
u≤phâp
 *);

160 
BuûdHódî_u≤phâp
(
u≤phâp
 * 
h
, 
ª•code
,

161 c⁄° * 
ª•msg
,

162 
bodyÀn
);

168 
BuûdRe•_u≤phâp
(
u≤phâp
 *, const *, );

173 
BuûdRe•2_u≤phâp
(
u≤phâp
 * 
h
, 
ª•code
,

174 c⁄° * 
ª•msg
,

175 c⁄° * 
body
, 
bodyÀn
);

179 
Síd500
(
u≤phâp
 *);

181 
Síd501
(
u≤phâp
 *);

185 
SídRe•_u≤phâp
(
u≤phâp
 *);

188 
SídRe•_ic⁄
(
u≤phâp
 *, * 
uæ
);

190 
SídRe•_ÆbumAπ
(
u≤phâp
 *, * 
uæ
);

192 
SídRe•_ˇ±i⁄
(
u≤phâp
 *, * 
uæ
);

194 
SídRe•_ªsizedimg
(
u≤phâp
 *, * 
uæ
);

196 
SídRe•_thumb«û
(
u≤phâp
 *, * 
uæ
);

200 
SídRe•_d afûe
(
u≤phâp
 *, * 
uæ
);

202 
u≤phâp_c⁄nCou¡
();

203 
u≤phâp_öô
(
p‹t
);

204 
u≤phâp_exô
();

	@upnpreplyparse.c

29 
	~<°dlib.h
>

30 
	~<°rög.h
>

31 
	~<°dio.h
>

33 
	~"u≤¥ïly∑r£.h
"

34 
	~"möixml.h
"

37 
	$NameVÆueP¨£rSèπE…
(* 
d
, c⁄° * 
«me
, 
l
)

39 
NameVÆueP¨£rD©a
 * 
d©a
 = (NameVÆueP¨£rD©®*)
d
;

40 if(
l
>63)

41 
l
 = 63;

42 
	`mem˝y
(
d©a
->
cuª…
, 
«me
, 
l
);

43 
d©a
->
cuª…
[
l
] = '\0';

46 if(!
d©a
->
hód
.
lh_fú°
)

48 
NameVÆue
 * 
nv
;

49 
nv
 = 
	`mÆloc
((
NameVÆue
)+
l
+1);

50 
	`°r˝y
(
nv
->
«me
, "rootElement");

51 
	`mem˝y
(
nv
->
vÆue
, 
«me
, 
l
);

52 
nv
->
vÆue
[
l
] = '\0';

53 
	`LIST_INSERT_HEAD
(&(
d©a
->
hód
), 
nv
, 
íåõs
);

55 
	}
}

58 
	$NameVÆueP¨£rGëD©a
(* 
d
, c⁄° * 
d©as
, 
l
)

60 
NameVÆueP¨£rD©a
 * 
d©a
 = (NameVÆueP¨£rD©®*)
d
;

61 
NameVÆue
 * 
nv
;

62 if(
l
>1975)

63 
l
 = 1975;

64 
nv
 = 
	`mÆloc
((
NameVÆue
)+
l
+1);

65 
	`°∫˝y
(
nv
->
«me
, 
d©a
->
cuª…
, 64);

66 
nv
->
«me
[63] = '\0';

67 
	`mem˝y
(
nv
->
vÆue
, 
d©as
, 
l
);

68 
nv
->
vÆue
[
l
] = '\0';

69 
	`LIST_INSERT_HEAD
(&(
d©a
->
hód
), 
nv
, 
íåõs
);

70 
	}
}

73 
	$P¨£NameVÆue
(c⁄° * 
buf„r
, 
bufsize
,

74 
NameVÆueP¨£rD©a
 * 
d©a
, 
uöt32_t
 
Êags
)

76 
xmÕ¨£r
 
∑r£r
;

77 
	`LIST_INIT
(&(
d©a
->
hód
));

79 
∑r£r
.
xml°¨t
 = 
buf„r
;

80 
∑r£r
.
xmlsize
 = 
bufsize
;

81 
∑r£r
.
d©a
 = data;

82 
∑r£r
.
°¨ã…func
 = 
NameVÆueP¨£rSèπE…
;

83 
∑r£r
.
ídñtfunc
 = 0;

84 
∑r£r
.
d©afunc
 = 
NameVÆueP¨£rGëD©a
;

85 
∑r£r
.
©tfunc
 = 0;

86 
∑r£r
.
Êags
 = flags;

87 
	`∑r£xml
(&
∑r£r
);

88 
	}
}

91 
	$CÀ¨NameVÆueLi°
(
NameVÆueP¨£rD©a
 * 
pd©a
)

93 
NameVÆue
 * 
nv
;

94 (
nv
 = 
pd©a
->
hód
.
lh_fú°
Ë!
NULL
)

96 
	`LIST_REMOVE
(
nv
, 
íåõs
);

97 
	`‰ì
(
nv
);

99 
	}
}

102 
	$GëVÆueFromNameVÆueLi°
(
NameVÆueP¨£rD©a
 * 
pd©a
,

103 c⁄° * 
Name
)

105 
NameVÆue
 * 
nv
;

106 * 
p
 = 
NULL
;

107 
nv
 = 
pd©a
->
hód
.
lh_fú°
;

108 (
nv
 !
NULL
Ë&& (
p
 == NULL);

109 
nv
 =Çv->
íåõs
.
À_√xt
)

111 if(
	`°rcmp
(
nv
->
«me
, 
Name
) == 0)

112 
p
 = 
nv
->
vÆue
;

114  
p
;

115 
	}
}

119 #ifde‡
DEBUG


121 
	$Di•œyNameVÆueLi°
(* 
buf„r
, 
bufsize
)

123 
NameVÆueP¨£rD©a
 
pd©a
;

124 
NameVÆue
 * 
nv
;

125 
	`P¨£NameVÆue
(
buf„r
, 
bufsize
, &
pd©a
);

126 
nv
 = 
pd©a
.
hód
.
lh_fú°
;

127 
nv
 !
NULL
;

128 
nv
 =Çv->
íåõs
.
À_√xt
)

130 
	`¥ötf
("%†%s\n", 
nv
->
«me
,Çv->
vÆue
);

132 
	`CÀ¨NameVÆueLi°
(&
pd©a
);

133 
	}
}

	@upnpreplyparse.h

29 #i‚de‡
__UPNPREPLYPARSE_H__


30 
	#__UPNPREPLYPARSE_H__


	)

32 
	~<°döt.h
>

33 
	~<sys/queue.h
>

35 #ifde‡
__˝lu•lus


39 
	sNameVÆue
 {

40 
LIST_ENTRY
(
NameVÆue
Ë
íåõs
;

41 
«me
[64];

42 
vÆue
[];

45 
	sNameVÆueP¨£rD©a
 {

46 
LIST_HEAD
(
li°hód
, 
NameVÆue
Ë
hód
;

47 
cuª…
[64];

50 
	#XML_STORE_EMPTY_FL
 0x01

	)

54 
P¨£NameVÆue
(c⁄° * 
buf„r
, 
bufsize
,

55 
NameVÆueP¨£rD©a
 * 
d©a
, 
uöt32_t
 
Êags
);

59 
CÀ¨NameVÆueLi°
(
NameVÆueP¨£rD©a
 * 
pd©a
);

63 
GëVÆueFromNameVÆueLi°
(
NameVÆueP¨£rD©a
 * 
pd©a
,

64 c⁄° * 
Name
);

68 
GëVÆueFromNameVÆueLi°Ign‹eNS
(
NameVÆueP¨£rD©a
 * 
pd©a
,

69 c⁄° * 
Name
);

72 #ifde‡
DEBUG


74 
Di•œyNameVÆueLi°
(* 
buf„r
, 
bufsize
);

77 #ifde‡
__˝lu•lus


	@upnpsoap.c

49 
	~"c⁄fig.h
"

51 
	~<°dio.h
>

52 
	~<°dlib.h
>

53 
	~<°rög.h
>

54 
	~<sys/sockë.h
>

55 
	~<uni°d.h
>

56 
	~<dúít.h
>

57 
	~<sys/°©.h
>

58 
	~<sys/ty≥s.h
>

59 
	~<¨∑/öë.h
>

60 
	~<√töë/ö.h
>

61 
	~<√tdb.h
>

62 
	~<˘y≥.h
>

64 
	~"u≤pglobÆv¨s.h
"

65 
	~"utûs.h
"

66 
	~"u≤phâp.h
"

67 
	~"u≤psﬂp.h
"

68 
	~"u≤¥ïly∑r£.h
"

69 
	~"gëiÁddr.h
"

70 
	~"sˇ¬î.h
"

71 
	~"sql.h
"

72 
	~"log.h
"

74 
g√t_is_gue°
(
ùaddr
, *
gue°
);

77 
	$BuûdSídAndClo£SﬂpRe•
(
u≤phâp
 * 
h
,

78 c⁄° * 
body
, 
bodyÀn
)

80 c⁄° 
bef‹ebody
[] =

86 c⁄° 
a·îbody
[] =

90 i‡(!
body
 || 
bodyÀn
 < 0)

92 
	`Síd500
(
h
);

96 
	`BuûdHódî_u≤phâp
(
h
, 200, "OK", (
bef‹ebody
) - 1

97 + (
a·îbody
Ë- 1 + 
bodyÀn
 );

99 
	`mem˝y
(
h
->
ªs_buf
 + h->
ªs_buÊí
, 
bef‹ebody
, (beforebody) - 1);

100 
h
->
ªs_buÊí
 +(
bef‹ebody
) - 1;

102 
	`mem˝y
(
h
->
ªs_buf
 + h->
ªs_buÊí
, 
body
, 
bodyÀn
);

103 
h
->
ªs_buÊí
 +
bodyÀn
;

105 
	`mem˝y
(
h
->
ªs_buf
 + h->
ªs_buÊí
, 
a·îbody
, (afterbody) - 1);

106 
h
->
ªs_buÊí
 +(
a·îbody
) - 1;

108 
	`SídRe•_u≤phâp
(
h
);

109 
	`Clo£Sockë_u≤phâp
(
h
);

110 
	}
}

113 
	$GëSy°emUpd©eID
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

115 c⁄° 
ª•
[] =

121 
body
[512];

122 
bodyÀn
;

124 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

125 
a˘i⁄
, "urn:schemas-upnp-org:service:ContentDirectory:1",

126 
upd©eID
, 
a˘i⁄
);

127 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

128 
	}
}

131 
	$IsAuth‹izedVÆid©ed
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

133 c⁄° 
ª•
[] =

139 
body
[512];

140 
NameVÆueP¨£rD©a
 
d©a
;

141 c⁄° * 
id
;

143 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 
XML_STORE_EMPTY_FL
);

144 
id
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "DeviceID");

145 if(
id
)

147 
bodyÀn
;

148 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

149 
a˘i⁄
, "urn:microsoft.com:service:X_MS_MediaReceiverRegistrar:1",

150 1, 
a˘i⁄
);

151 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

154 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

156 
	`CÀ¨NameVÆueLi°
(&
d©a
);

157 
	}
}

160 
	$Regi°îDevi˚
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

162 c⁄° 
ª•
[] =

168 
body
[512];

169 
bodyÀn
;

171 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

172 
a˘i⁄
, "urn:microsoft.com:service:X_MS_MediaReceiverRegistrar:1",

173 
uuidvÆue
, 
a˘i⁄
);

174 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

175 
	}
}

178 
	$GëPrŸocﬁInfo
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

180 c⁄° 
ª•
[] =

184 
RESOURCE_PROTOCOL_INFO_VALUES


189 * 
body
;

190 
bodyÀn
;

192 
bodyÀn
 = 
	`a•rötf
(&
body
, 
ª•
,

193 
a˘i⁄
, "urn:schemas-upnp-org:service:ConnectionManager:1",

194 
a˘i⁄
);

195 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

196 
	`‰ì
(
body
);

197 
	}
}

200 
	$GëS‹tC≠abûôõs
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

202 c⁄° 
ª•
[] =

214 
body
[512];

215 
bodyÀn
;

217 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

218 
a˘i⁄
, "urn:schemas-upnp-org:service:ContentDirectory:1",

219 
a˘i⁄
);

220 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

221 
	}
}

224 
	$GëSórchC≠abûôõs
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

226 c⁄° 
ª•
[] =

243 
body
[512];

244 
bodyÀn
;

246 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

247 
a˘i⁄
, "urn:schemas-upnp-org:service:ContentDirectory:1",

248 
a˘i⁄
);

249 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

250 
	}
}

253 
	$GëCuºítC⁄√˘i⁄IDs
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

256 c⁄° 
ª•
[] =

262 
body
[512];

263 
bodyÀn
;

265 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

266 
a˘i⁄
, "urn:schemas-upnp-org:service:ConnectionManager:1",

267 
a˘i⁄
);

268 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

269 
	}
}

272 
	$GëCuºítC⁄√˘i⁄Info
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

275 c⁄° 
ª•
[] =

287 
body
[(
ª•
)+128];

288 
NameVÆueP¨£rD©a
 
d©a
;

289 c⁄° *
id_°r
;

290 
id
;

291 *
íd±r
 = 
NULL
;

293 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 
XML_STORE_EMPTY_FL
);

294 
id_°r
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ConnectionID");

295 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "GëCuºítC⁄√˘i⁄Info(%s)\n", 
id_°r
);

296 if(
id_°r
)

297 
id
 = 
	`°πﬁ
(
id_°r
, &
íd±r
, 10);

298 i‡(!
id_°r
 || 
íd±r
 == id_str)

300 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

302 if(
id
 != 0)

304 
	`SﬂpEº‹
(
h
, 701, "No such objectÉrror");

308 
bodyÀn
;

309 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

310 
a˘i⁄
, "urn:schemas-upnp-org:service:ConnectionManager:1",

311 
a˘i⁄
);

312 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

314 
	`CÀ¨NameVÆueLi°
(&
d©a
);

315 
	}
}

318 
	#FILTER_CHILDCOUNT
 0x00000001

	)

319 
	#FILTER_DC_CREATOR
 0x00000002

	)

320 
	#FILTER_DC_DATE
 0x00000004

	)

321 
	#FILTER_DC_DESCRIPTION
 0x00000008

	)

322 
	#FILTER_DLNA_NAMESPACE
 0x00000010

	)

323 
	#FILTER_REFID
 0x00000020

	)

324 
	#FILTER_RES
 0x00000040

	)

325 
	#FILTER_RES_BITRATE
 0x00000080

	)

326 
	#FILTER_RES_DURATION
 0x00000100

	)

327 
	#FILTER_RES_NRAUDIOCHANNELS
 0x00000200

	)

328 
	#FILTER_RES_RESOLUTION
 0x00000400

	)

329 
	#FILTER_RES_SAMPLEFREQUENCY
 0x00000800

	)

330 
	#FILTER_RES_SIZE
 0x00001000

	)

331 
	#FILTER_SEARCHABLE
 0x00002000

	)

332 
	#FILTER_UPNP_ACTOR
 0x00004000

	)

333 
	#FILTER_UPNP_ALBUM
 0x00008000

	)

334 
	#FILTER_UPNP_ALBUMARTURI
 0x00010000

	)

335 
	#FILTER_UPNP_ALBUMARTURI_DLNA_PROFILEID
 0x00020000

	)

336 
	#FILTER_UPNP_ARTIST
 0x00040000

	)

337 
	#FILTER_UPNP_GENRE
 0x00080000

	)

338 
	#FILTER_UPNP_ORIGINALTRACKNUMBER
 0x00100000

	)

339 
	#FILTER_UPNP_SEARCHCLASS
 0x00200000

	)

340 
	#FILTER_UPNP_STORAGEUSED
 0x00400000

	)

342 
	#FILTER_SEC_CAPTION_INFO_EX
 0x01000000

	)

343 
	#FILTER_SEC_DCM_INFO
 0x02000000

	)

344 
	#FILTER_PV_SUBTITLE_FILE_TYPE
 0x04000000

	)

345 
	#FILTER_PV_SUBTITLE_FILE_URI
 0x08000000

	)

346 
	#FILTER_AV_MEDIA_CLASS
 0x10000000

	)

348 
uöt32_t


349 
	$£t_fûãr_Êags
(*
fûãr
, 
u≤phâp
 *
h
)

351 *
ôem
, *
ßvïå
 = 
NULL
;

352 
uöt32_t
 
Êags
 = 0;

353 
ßmsung
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
Êags
 & 
FLAG_SAMSUNG
;

355 if–!
fûãr
 || (
	`°æí
(filter) <= 1) ) {

356 i‡(
fûãr
 && 
	`°rcmp
(fûãr, "*"Ë=0 && 
ßmsung
) {

364 if–
ßmsung
 )

365 
Êags
 |
FILTER_DLNA_NAMESPACE
;

366 
ôem
 = 
	`°πok_r
(
fûãr
, ",", &
ßvïå
);

367  
ôem
 !
NULL
 )

369 if–
ßvïå
 )

370 *(
ôem
-1) = ',';

371  
	`is•a˚
(*
ôem
) )

372 
ôem
++;

373 if–
	`°rcmp
(
ôem
, "@childCount") == 0 )

375 
Êags
 |
FILTER_CHILDCOUNT
;

377 if–
	`°rcmp
(
ôem
, "@searchable") == 0 )

379 
Êags
 |
FILTER_SEARCHABLE
;

381 if–
	`°rcmp
(
ôem
, "dc:creator") == 0 )

383 
Êags
 |
FILTER_DC_CREATOR
;

385 if–
	`°rcmp
(
ôem
, "dc:date") == 0 )

387 
Êags
 |
FILTER_DC_DATE
;

389 if–
	`°rcmp
(
ôem
, "dc:description") == 0 )

391 
Êags
 |
FILTER_DC_DESCRIPTION
;

393 if–
	`°rcmp
(
ôem
, "dlna") == 0 )

395 
Êags
 |
FILTER_DLNA_NAMESPACE
;

397 if–
	`°rcmp
(
ôem
, "@refID") == 0 )

399 
Êags
 |
FILTER_REFID
;

401 if–
	`°rcmp
(
ôem
, "upnp:album") == 0 )

403 
Êags
 |
FILTER_UPNP_ALBUM
;

405 if–
	`°rcmp
(
ôem
, "upnp:albumArtURI") == 0 )

407 
Êags
 |
FILTER_UPNP_ALBUMARTURI
;

408 if–
ßmsung
 )

409 
Êags
 |
FILTER_UPNP_ALBUMARTURI_DLNA_PROFILEID
;

411 if–
	`°rcmp
(
ôem
, "upnp:albumArtURI@dlna:profileID") == 0 )

413 
Êags
 |
FILTER_UPNP_ALBUMARTURI
;

414 
Êags
 |
FILTER_UPNP_ALBUMARTURI_DLNA_PROFILEID
;

416 if–
	`°rcmp
(
ôem
, "upnp:artist") == 0 )

418 
Êags
 |
FILTER_UPNP_ARTIST
;

420 if–
	`°rcmp
(
ôem
, "upnp:actor") == 0 )

422 
Êags
 |
FILTER_UPNP_ACTOR
;

424 if–
	`°rcmp
(
ôem
, "upnp:genre") == 0 )

426 
Êags
 |
FILTER_UPNP_GENRE
;

428 if–
	`°rcmp
(
ôem
, "upnp:originalTrackNumber") == 0 )

430 
Êags
 |
FILTER_UPNP_ORIGINALTRACKNUMBER
;

432 if–
	`°rcmp
(
ôem
, "upnp:searchClass") == 0 )

434 
Êags
 |
FILTER_UPNP_SEARCHCLASS
;

436 if–
	`°rcmp
(
ôem
, "upnp:storageUsed") == 0 )

438 
Êags
 |
FILTER_UPNP_STORAGEUSED
;

440 if–
	`°rcmp
(
ôem
, "res") == 0 )

442 
Êags
 |
FILTER_RES
;

444 if–(
	`°rcmp
(
ôem
, "res@bitrate") == 0) ||

445 (
	`°rcmp
(
ôem
, "@bitrate") == 0) ||

446 ((
	`°rcmp
(
ôem
, "bôøã"Ë=0Ë&& (
Êags
 & 
FILTER_RES
)) )

448 
Êags
 |
FILTER_RES
;

449 
Êags
 |
FILTER_RES_BITRATE
;

451 if–(
	`°rcmp
(
ôem
, "res@duration") == 0) ||

452 (
	`°rcmp
(
ôem
, "@duration") == 0) ||

453 ((
	`°rcmp
(
ôem
, "duøti⁄"Ë=0Ë&& (
Êags
 & 
FILTER_RES
)) )

455 
Êags
 |
FILTER_RES
;

456 
Êags
 |
FILTER_RES_DURATION
;

458 if–(
	`°rcmp
(
ôem
, "res@nrAudioChannels") == 0) ||

459 (
	`°rcmp
(
ôem
, "@nrAudioChannels") == 0) ||

460 ((
	`°rcmp
(
ôem
, "ƒAudioCh™√ls"Ë=0Ë&& (
Êags
 & 
FILTER_RES
)) )

462 
Êags
 |
FILTER_RES
;

463 
Êags
 |
FILTER_RES_NRAUDIOCHANNELS
;

465 if–(
	`°rcmp
(
ôem
, "res@resolution") == 0) ||

466 (
	`°rcmp
(
ôem
, "@resolution") == 0) ||

467 ((
	`°rcmp
(
ôem
, "ªsﬁuti⁄"Ë=0Ë&& (
Êags
 & 
FILTER_RES
)) )

469 
Êags
 |
FILTER_RES
;

470 
Êags
 |
FILTER_RES_RESOLUTION
;

472 if–(
	`°rcmp
(
ôem
, "res@sampleFrequency") == 0) ||

473 (
	`°rcmp
(
ôem
, "@sampleFrequency") == 0) ||

474 ((
	`°rcmp
(
ôem
, "ßm∂eFªquícy"Ë=0Ë&& (
Êags
 & 
FILTER_RES
)) )

476 
Êags
 |
FILTER_RES
;

477 
Êags
 |
FILTER_RES_SAMPLEFREQUENCY
;

479 if–(
	`°rcmp
(
ôem
, "res@size") == 0) ||

480 (
	`°rcmp
(
ôem
, "@size") == 0) ||

481 (
	`°rcmp
(
ôem
, "size") == 0) )

483 
Êags
 |
FILTER_RES
;

484 
Êags
 |
FILTER_RES_SIZE
;

486 if–
	`°rcmp
(
ôem
, "sec:CaptionInfoEx") == 0 )

488 
Êags
 |
FILTER_SEC_CAPTION_INFO_EX
;

490 if–
	`°rcmp
(
ôem
, "sec:dcmInfo") == 0 )

492 
Êags
 |
FILTER_SEC_DCM_INFO
;

494 if–
	`°rcmp
(
ôem
, "res@pv:subtitleFileType") == 0 )

496 
Êags
 |
FILTER_PV_SUBTITLE_FILE_TYPE
;

498 if–
	`°rcmp
(
ôem
, "res@pv:subtitleFileUri") == 0 )

500 
Êags
 |
FILTER_PV_SUBTITLE_FILE_URI
;

502 if–
	`°rcmp
(
ôem
, "av:mediaClass") == 0 )

504 
Êags
 |
FILTER_AV_MEDIA_CLASS
;

506 
ôem
 = 
	`°πok_r
(
NULL
, ",", &
ßvïå
);

509  
Êags
;

510 
	}
}

513 
	$∑r£_s‹t_¸ôîü
(*
s‹tCrôîü
, *
îr‹
)

515 *
‹dî
 = 
NULL
;

516 *
ôem
, *
ßvïå
;

517 
i
, 
ªt
, 
ªvî£
, 
tôÀ_s‹ãd
 = 0;

518 
°rög_s
 
°r
;

519 *
îr‹
 = 0;

521 if–
f‹˚_s‹t_¸ôîü
 )

522 
s‹tCrôîü
 = 
	`°rdup
(
f‹˚_s‹t_¸ôîü
);

523 if–!
s‹tCrôîü
 )

524  
NULL
;

526 if–(
ôem
 = 
	`°πok_r
(
s‹tCrôîü
, ",", &
ßvïå
)) )

528 
‹dî
 = 
	`mÆloc
(4096);

529 
°r
.
d©a
 = 
‹dî
;

530 
°r
.
size
 = 4096;

531 
°r
.
off
 = 0;

532 
	`°rˇtf
(&
°r
, "order by ");

534  
i
=0; 
ôem
 !
NULL
; i++ )

536 
ªvî£
=0;

537 if–
i
 )

538 
	`°rˇtf
(&
°r
, ", ");

539 if–*
ôem
 == '+' )

541 
ôem
++;

543 if–*
ôem
 == '-' )

545 
ªvî£
 = 1;

546 
ôem
++;

550 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Nÿ‹dî s≥cifõd [%s]\n", 
ôem
);

551 
bad_dúe˘i⁄
;

553 if–
	`°rˇ£cmp
(
ôem
, "upnp:class") == 0 )

555 
	`°rˇtf
(&
°r
, "o.CLASS");

557 if–
	`°rˇ£cmp
(
ôem
, "dc:title") == 0 )

559 
	`°rˇtf
(&
°r
, "d.TITLE");

560 
tôÀ_s‹ãd
 = 1;

562 if–
	`°rˇ£cmp
(
ôem
, "dc:date") == 0 )

564 
	`°rˇtf
(&
°r
, "d.DATE");

566 if–
	`°rˇ£cmp
(
ôem
, "upnp:originalTrackNumber") == 0 )

568 
	`°rˇtf
(&
°r
, "d.DISC, d.TRACK");

570 if–
	`°rˇ£cmp
(
ôem
, "upnp:album") == 0 )

572 
	`°rˇtf
(&
°r
, "d.ALBUM");

576 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "Unh™dÀd S‹tCrôîü [%s]\n", 
ôem
);

577 
bad_dúe˘i⁄
:

578 *
îr‹
 = -1;

579 if–
i
 )

581 
ªt
 = 
	`°æí
(
‹dî
);

582 
‹dî
[
ªt
-2] = '\0';

584 
i
--;

585 
unh™dÀd_‹dî
;

588 if–
ªvî£
 )

589 
	`°rˇtf
(&
°r
, " DESC");

590 
unh™dÀd_‹dî
:

591 
ôem
 = 
	`°πok_r
(
NULL
, ",", &
ßvïå
);

593 if–
i
 <= 0 )

595 
	`‰ì
(
‹dî
);

596 if–
f‹˚_s‹t_¸ôîü
 )

597 
	`‰ì
(
s‹tCrôîü
);

598  
NULL
;

601 if–!
tôÀ_s‹ãd
 )

602 
	`°rˇtf
(&
°r
, ", TITLE ASC");

604 if–
f‹˚_s‹t_¸ôîü
 )

605 
	`‰ì
(
s‹tCrôîü
);

607  
‹dî
;

608 
	}
}

610 
ölöe
 

611 
	$add_ªsized_ªs
(
§cw
, 
§ch
, 
ªqw
, 
ªqh
, *
d a_≤
,

612 *
dëaûID
, 
Re•⁄£
 *
¨gs
)

614 
d°w
 = 
ªqw
;

615 
d°h
 = 
ªqh
;

617 if–
¨gs
->
Êags
 & 
FLAG_NO_RESIZE
 )

620 
	`°rˇtf
(
¨gs
->
°r
, "&lt;res ");

621 if–
¨gs
->
fûãr
 & 
FILTER_RES_RESOLUTION
 )

623 
d°w
 = 
ªqw
;

624 
d°h
 = ((((
ªqw
<<10)/
§cw
)*
§ch
)>>10);

625 if–
d°h
 > 
ªqh
 ) {

626 
d°h
 = 
ªqh
;

627 
d°w
 = (((
ªqh
<<10)/
§ch
Ë* 
§cw
>>10);

629 
	`°rˇtf
(
¨gs
->
°r
, "ªsﬁuti⁄=\"%dx%d\" ", 
d°w
, 
d°h
);

631 
	`°rˇtf
(
¨gs
->
°r
, "protocolInfo=\"http-get:*:image/jpeg:"

635 
d a_≤
, 
DLNA_FLAG_DLNA_V1_5
|
DLNA_FLAG_HTTP_STALLING
|
DLNA_FLAG_TM_B
|
DLNA_FLAG_TM_I
, 0,

636 
œn_addr
[
¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
,

637 
dëaûID
, 
d°w
, 
d°h
);

638 
	}
}

640 
ölöe
 

641 
	$add_ªs
(*
size
, *
duøti⁄
, *
bôøã
, *
ßm∂eFªquícy
,

642 *
ƒAudioCh™√ls
, *
ªsﬁuti⁄
, *
d a_≤
, *
mime
,

643 *
dëaûID
, c⁄° *
ext
, 
Re•⁄£
 *
¨gs
)

645 
	`°rˇtf
(
¨gs
->
°r
, "&lt;res ");

646 if–
size
 && (
¨gs
->
fûãr
 & 
FILTER_RES_SIZE
) ) {

647 
	`°rˇtf
(
¨gs
->
°r
, "size=\"%s\" ", 
size
);

649 if–
duøti⁄
 && (
¨gs
->
fûãr
 & 
FILTER_RES_DURATION
) ) {

650 
	`°rˇtf
(
¨gs
->
°r
, "duøti⁄=\"%s\" ", 
duøti⁄
);

652 if–
bôøã
 && (
¨gs
->
fûãr
 & 
FILTER_RES_BITRATE
) ) {

653 
br
 = 
	`©oi
(
bôøã
);

654 if(
¨gs
->
Êags
 & 
FLAG_MS_PFS
)

655 
br
 /= 8;

656 
	`°rˇtf
(
¨gs
->
°r
, "bôøã=\"%d\" ", 
br
);

658 if–
ßm∂eFªquícy
 && (
¨gs
->
fûãr
 & 
FILTER_RES_SAMPLEFREQUENCY
) ) {

659 
	`°rˇtf
(
¨gs
->
°r
, "ßm∂eFªquícy=\"%s\" ", 
ßm∂eFªquícy
);

661 if–
ƒAudioCh™√ls
 && (
¨gs
->
fûãr
 & 
FILTER_RES_NRAUDIOCHANNELS
) ) {

662 
	`°rˇtf
(
¨gs
->
°r
, "ƒAudioCh™√ls=\"%s\" ", 
ƒAudioCh™√ls
);

664 if–
ªsﬁuti⁄
 && (
¨gs
->
fûãr
 & 
FILTER_RES_RESOLUTION
) ) {

665 
	`°rˇtf
(
¨gs
->
°r
, "ªsﬁuti⁄=\"%s\" ", 
ªsﬁuti⁄
);

667 if–
¨gs
->
fûãr
 & (
FILTER_PV_SUBTITLE_FILE_TYPE
|
FILTER_PV_SUBTITLE_FILE_URI
) )

669 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from CAPTIONS whîêID = '%s'", 
dëaûID
) > 0 )

671 if–
¨gs
->
fûãr
 & 
FILTER_PV_SUBTITLE_FILE_TYPE
 )

672 
	`°rˇtf
(
¨gs
->
°r
, "pv:subtitleFileType=\"SRT\" ");

673 if–
¨gs
->
fûãr
 & 
FILTER_PV_SUBTITLE_FILE_URI
 )

674 
	`°rˇtf
(
¨gs
->
°r
, "pv:subtitleFileUri=\"http://%s:%d/Captions/%s.srt\" ",

675 
œn_addr
[
¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

678 
	`°rˇtf
(
¨gs
->
°r
, "protocolInfo=\"http-get:*:%s:%s\"&gt;"

681 
mime
, 
d a_≤
, 
œn_addr
[
¨gs
->
iÁ˚
].
°r
,

682 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
, 
ext
);

683 
	}
}

685 
	#COLUMNS
 "o.REF_ID, o.DETAIL_ID, o.CLASS," \

688 " d.THUMBNAIL, d.CREATOR, d.DLNA_PN, d.MIME, d.ALBUM_ART, d.DISC, d.PATH "

	)

689 
	#SELECT_COLUMNS
 "SELECT o.OBJECT_ID, o.PARENT_ID, " 
COLUMNS


	)

692 
	$gue°_√tw‹k_íabÀ
(
u≤phâp
 *
ªq
, c⁄° *
∑th
)

694 
medü_dú_s
 *
dú
 = 
medü_dús
;

695 
is_gue°_√tw‹k
 = 0;

696 
ªt
 = 0;

698 i‡(!
∑th
)

703 
dú
)

705 i‡(
	`°∫cmp
(
dú
->
∑th
,Ö©h, 
	`°æí
(dir->path)) == 0)

710 
dú
 = dú->
√xt
;

713 i‡(
dú
 =
NULL
)

716 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "∑th: %†övÆid\n", 
∑th
);

720 
ªt
 = 
	`g√t_is_gue°
(
ªq
->
˛õ¡addr
.
s_addr
, &
is_gue°_√tw‹k
);

721 i‡(
ªt
 != 0)

723 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "FailedÅo determine Guest Network\n");

729 i‡(
is_gue°_√tw‹k
 && !
dú
->
gíabÀ
)

735 
	}
}

738 
	$ˇŒback
(*
¨gs
, 
¨gc
, **
¨gv
, **
azCﬁName
)

740 
Re•⁄£
 *
∑s£d_¨gs
 = (Re•⁄£ *)
¨gs
;

741 
u≤phâp
 *
ªq
 = 
∑s£d_¨gs
->req;

742 *
id
 = 
¨gv
[0], *
∑ª¡
 =árgv[1], *
ªfID
 =árgv[2], *
dëaûID
 =árgv[3], *
˛ass
 =árgv[4], *
size
 =árgv[5], *
tôÀ
 =árgv[6],

743 *
duøti⁄
 = 
¨gv
[7], *
bôøã
 =árgv[8], *
ßm∂eFªquícy
 =árgv[9], *
¨ti°
 =árgv[10], *
Æbum
 =árgv[11],

744 *
gíª
 = 
¨gv
[12], *
commít
 =árgv[13], *
ƒAudioCh™√ls
 =árgv[14], *
åack
 =árgv[15], *
d©e
 =árgv[16], *
ªsﬁuti⁄
 =árgv[17],

745 *
ä
 = 
¨gv
[18], *
¸ót‹
 =árgv[19], *
d a_≤
 =árgv[20], *
mime
 =árgv[21], *
Æbum_¨t
 =árgv[22], *
∑th
 =árgv[24];

746 
d a_buf
[128];

747 c⁄° *
ext
;

748 
°rög_s
 *
°r
 = 
∑s£d_¨gs
->str;

749 
ªt
 = 0;

751 
ªt
 = 
	`gue°_√tw‹k_íabÀ
(
ªq
, 
∑th
);

752 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "∑th: %s,É«bÀ: %d\n", 
∑th
, 
ªt
);

753 i‡(!
ªt
)

760 if–
°r
->
off
 > (°r->
size
 - 8192) )

762 #i‡
MAX_RESPONSE_SIZE
 > 0

763 if–(
°r
->
size
+
DEFAULT_RESP_SIZE
Ë<
MAX_RESPONSE_SIZE
 )

766 
°r
->
d©a
 = 
	`ªÆloc
(°r->d©a, (°r->
size
+
DEFAULT_RESP_SIZE
));

767 if–
°r
->
d©a
 )

769 
°r
->
size
 +
DEFAULT_RESP_SIZE
;

770 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "UPnP SOAPÑesponseÉnlargedÅo %d. [%dÑesults so far]\n",

771 
°r
->
size
, 
∑s£d_¨gs
->
ªtu∫ed
);

775 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "UPnP SOAPÑesponse wasÅoo big,ándÑealloc failed!\n");

778 #i‡
MAX_RESPONSE_SIZE
 > 0

782 
	`DPRINTF
(
E_ERROR
, 
L_HTTP
, "UPnP SOAPÑe•⁄£ cuàsh‹t,ÅÿnŸÉx˚edÅhêmaxÑe•⁄£ sizê[%Œd]!\n", ()
MAX_RESPONSE_SIZE
);

787 
∑s£d_¨gs
->
ªtu∫ed
++;

789 if–
ru¡ime_v¨s
.
roŸ_c⁄èöî
 && 
	`°rcmp
(
∑ª¡
,Ñuntime_vars.root_container) == 0 )

790 
∑ª¡
 = "0";

792 if–
	`°∫cmp
(
˛ass
, "item", 4) == 0 )

794 
uöt32_t
 
d a_Êags
 = 
DLNA_FLAG_DLNA_V1_5
|
DLNA_FLAG_HTTP_STALLING
|
DLNA_FLAG_TM_B
;

795 *
Æt_tôÀ
 = 
NULL
;

797 if–*
mime
 == 'v' )

799 
d a_Êags
 |
DLNA_FLAG_TM_S
;

800 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_MIME_AVI_DIVX
 )

802 if–
	`°rcmp
(
mime
, "video/x-msvideo") == 0 )

804 if–
¸ót‹
 )

805 
	`°r˝y
(
mime
+6, "divx");

807 
	`°r˝y
(
mime
+6, "avi");

810 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_MIME_AVI_AVI
 )

812 if–
	`°rcmp
(
mime
, "video/x-msvideo") == 0 )

814 
	`°r˝y
(
mime
+6, "avi");

817 if–
∑s£d_¨gs
->
˛õ¡
 =
EFªeBox
 && 
d a_≤
 )

819 if–
	`°∫cmp
(
d a_≤
, "AVC_TS", 6) == 0 ||

820 
	`°∫cmp
(
d a_≤
, "MPEG_TS", 7) == 0 )

822 
	`°r˝y
(
mime
+6, "mp2t");

825 if–!(
∑s£d_¨gs
->
Êags
 & 
FLAG_DLNA
) )

827 if–
	`°rcmp
(
mime
+6, "vnd.dlna.mpeg-tts") == 0 )

829 
	`°r˝y
(
mime
+6, "mpeg");

833 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_SAMSUNG
 )

835 if–
	`°rcmp
(
mime
+6, "x-matroska") == 0 )

837 
	`°r˝y
(
mime
+8, "mkv");

841 if–
∑s£d_¨gs
->
˛õ¡
 =
ELGDevi˚
 && (∑s£d_¨gs->
fûãr
 & 
FILTER_RES
) )

843 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from CAPTIONS whîêID = '%s'", 
dëaûID
) > 0 )

845 
ªt
 = 
	`a•rötf
(&
Æt_tôÀ
, "%s.", 
tôÀ
);

846 if–
ªt
 > 0 )

847 
tôÀ
 = 
Æt_tôÀ
;

849 
Æt_tôÀ
 = 
NULL
;

853 if–*
mime
 == 'a' )

855 
d a_Êags
 |
DLNA_FLAG_TM_S
;

856 if–
	`°rcmp
(
mime
+6, "x-flac") == 0 )

858 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_MIME_FLAC_FLAC
 )

860 
	`°r˝y
(
mime
+6, "flac");

863 if–
	`°rcmp
(
mime
+6, "x-wav") == 0 )

865 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_MIME_WAV_WAV
 )

867 
	`°r˝y
(
mime
+6, "wav");

872 
d a_Êags
 |
DLNA_FLAG_TM_I
;

874 if–
d a_≤
 )

875 
	`¢¥ötf
(
d a_buf
, (dlna_buf), "DLNA.ORG_PN=%s;"

879 
d a_≤
, 
d a_Êags
, 0);

880 if–
∑s£d_¨gs
->
Êags
 & 
FLAG_DLNA
 )

881 
	`¢¥ötf
(
d a_buf
, (dlna_buf), "DLNA.ORG_OP=01;"

884 
d a_Êags
, 0);

886 
	`°r˝y
(
d a_buf
, "*");

888 
ªt
 = 
	`°rˇtf
(
°r
, "&…;ôem id=\"%s\"Ö¨ítID=\"%s\"Ñe°ri˘ed=\"1\"", 
id
, 
∑ª¡
);

889 if–
ªfID
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_REFID
) ) {

890 
ªt
 = 
	`°rˇtf
(
°r
, "ÑefID=\"%s\"", 
ªfID
);

892 
ªt
 = 
	`°rˇtf
(
°r
, "&gt;"

895 
tôÀ
, 
˛ass
);

896 if–
commít
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_DC_DESCRIPTION
) ) {

897 
ªt
 = 
	`°rˇtf
(
°r
, "&…;dc:des¸ùti⁄&gt;%.384s&…;/dc:des¸ùti⁄&gt;", 
commít
);

899 if–
¸ót‹
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_DC_CREATOR
) ) {

900 
ªt
 = 
	`°rˇtf
(
°r
, "&…;dc:¸ót‹&gt;%s&…;/dc:¸ót‹&gt;", 
¸ót‹
);

902 if–
d©e
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_DC_DATE
) ) {

903 
ªt
 = 
	`°rˇtf
(
°r
, "&…;dc:d©e&gt;%s&…;/dc:d©e&gt;", 
d©e
);

905 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_SEC_DCM_INFO
 ) {

907 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;sec:dcmInfo&gt;CREATIONDATE=0,FOLDER=%s,BM=%d&lt;/sec:dcmInfo&gt;",

908 
tôÀ
, 
	`sql_gë_öt_fõld
(
db
, "SELECT SEC from BOOKMARKS whîêID = '%s'", 
dëaûID
));

910 if–
¨ti°
 ) {

911 if–(*
mime
 ='v'Ë&& (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ACTOR
) ) {

912 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:a˘‹&gt;%s&…;/u≤p:a˘‹&gt;", 
¨ti°
);

914 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ARTIST
 ) {

915 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:¨ti°&gt;%s&…;/u≤p:¨ti°&gt;", 
¨ti°
);

918 if–
Æbum
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ALBUM
) ) {

919 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:Æbum&gt;%s&…;/u≤p:Æbum&gt;", 
Æbum
);

921 if–
gíª
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_GENRE
) ) {

922 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:gíª&gt;%s&…;/u≤p:gíª&gt;", 
gíª
);

924 if–
	`°∫cmp
(
id
, 
MUSIC_PLIST_ID
, 
	`°æí
(MUSIC_PLIST_ID)) == 0 ) {

925 
åack
 = 
	`°ºchr
(
id
, '$')+1;

927 if–
åack
 && 
	`©oi
—øckË&& (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ORIGINALTRACKNUMBER
) ) {

928 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:‹igöÆTøckNumbî&gt;%s&…;/u≤p:‹igöÆTøckNumbî&gt;", 
åack
);

930 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_RES
 )

932 
ext
 = 
	`mime_to_ext
(
mime
);

933 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

934 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

935 if–*
mime
 == 'i' )

937 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "ext: %s, d a_≤: %s\n", 
ext
, 
d a_≤
);

939 i‡(
	`°rcmp
(
ext
, "jpg") == 0)

941 
§cw
, 
§ch
;

942 if–
ªsﬁuti⁄
 && (
	`ssˇnf
‘esﬁuti⁄, "%6dx%6d", &
§cw
, &
§ch
) == 2) )

944 if–
§cw
 > 4096 || 
§ch
 > 4096 )

945 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 4096, 4096, "JPEG_LRG", 
dëaûID
, 
∑s£d_¨gs
);

946 if–
§cw
 > 1024 || 
§ch
 > 768 )

947 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 1024, 768, "JPEG_MED", 
dëaûID
, 
∑s£d_¨gs
);

948 if–
§cw
 > 640 || 
§ch
 > 480 )

949 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 640, 480, "JPEG_SM", 
dëaûID
, 
∑s£d_¨gs
);

950 i‡(
§cw
 > 160 || 
§ch
 > 160)

951 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 160, 160, "JPEG_TN", 
dëaûID
, 
∑s£d_¨gs
);

952 i‡(
§cw
 > 120 || 
§ch
 > 120)

953 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 120, 120, "JPEG_LRG_ICO", 
dëaûID
, 
∑s£d_¨gs
);

954 i‡(
§cw
 > 48 || 
§ch
 > 48)

955 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 48, 48, "JPEG_SM_ICO", 
dëaûID
, 
∑s£d_¨gs
);

957 if–!(
∑s£d_¨gs
->
Êags
 & 
FLAG_RESIZE_THUMBS
Ë&& 
ä
 && 
	`©oi
(tn) ) {

958 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;resÖrotocolInfo=\"http-get:*:%s:%s\"&gt;"

961 
mime
, "DLNA.ORG_PN=JPEG_TN;DLNA.ORG_CI=1", 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
,

962 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

966 
	`add_ªsized_ªs
(
§cw
, 
§ch
, 160, 160, "JPEG_TN", 
dëaûID
, 
∑s£d_¨gs
);

970 if–*
mime
 == 'v' )

972  
∑s£d_¨gs
->
˛õ¡
 ) {

973 
EToshibaTV
:

974 if–
d a_≤
 &&

975 (
	`°∫cmp
(
d a_≤
, "MPEG_TS_HD_NA", 13) == 0 ||

976 
	`°∫cmp
(
d a_≤
, "MPEG_TS_SD_NA", 13) == 0 ||

977 
	`°∫cmp
(
d a_≤
, "AVC_TS_MP_HD_AC3", 16) == 0 ||

978 
	`°∫cmp
(
d a_≤
, "AVC_TS_HP_HD_AC3", 16) == 0))

980 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=%s;DLNA.ORG_OP=01;DLNA.ORG_CI=1", "MPEG_PS_NTSC");

981 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

982 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

985 
ES⁄yBDP
:

986 if–
d a_≤
 &&

987 (
	`°∫cmp
(
d a_≤
, "AVC_TS", 6) == 0 ||

988 
	`°∫cmp
(
d a_≤
, "MPEG_TS", 7) == 0) )

990 if–
	`°∫cmp
(
d a_≤
, "MPEG_TS_SD_NA", 13) != 0 )

992 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=%s;DLNA.ORG_OP=01;DLNA.ORG_CI=1", "MPEG_TS_SD_NA");

993 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

994 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

996 if–
	`°∫cmp
(
d a_≤
, "MPEG_TS_SD_EU", 13) != 0 )

998 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=%s;DLNA.ORG_OP=01;DLNA.ORG_CI=1", "MPEG_TS_SD_EU");

999 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

1000 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

1003 if–(
d a_≤
 &&

1004 (
	`°∫cmp
(
d a_≤
, "AVC_MP4", 7) == 0 ||

1005 
	`°∫cmp
(
d a_≤
, "MPEG4_P2_MP4", 12) == 0)) ||

1006 
	`°rcmp
(
mime
+6, "x-matroska") == 0 ||

1007 
	`°rcmp
(
mime
+6, "x-msvideo") == 0 ||

1008 
	`°rcmp
(
mime
+6, "mpeg") == 0 )

1010 
	`°r˝y
(
mime
+6, "avi");

1011 if–!
d a_≤
 || 
	`°∫cmp
(dlna_pn, "MPEG_PS_NTSC", 12) != 0 )

1013 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=%s;DLNA.ORG_OP=01;DLNA.ORG_CI=1", "MPEG_PS_NTSC");

1014 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

1015 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

1017 if–!
d a_≤
 || 
	`°∫cmp
(dlna_pn, "MPEG_PS_PAL", 11) != 0 )

1019 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=%s;DLNA.ORG_OP=01;DLNA.ORG_CI=1", "MPEG_PS_PAL");

1020 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

1021 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

1025 
ES⁄yBøvü
:

1028 if–
d a_≤
 &&

1029 (
	`°∫cmp
(
d a_≤
, "AVC_TS_MP_SD_AC3", 16) == 0 ||

1030 
	`°∫cmp
(
d a_≤
, "AVC_TS_MP_HD_AC3", 16) == 0 ||

1031 
	`°∫cmp
(
d a_≤
, "AVC_TS_HP_HD_AC3", 16) == 0))

1033 
	`•rötf
(
d a_buf
, "DLNA.ORG_PN=AVC_TS_HD_50_AC3%s", 
d a_≤
 + 16);

1034 
	`add_ªs
(
size
, 
duøti⁄
, 
bôøã
, 
ßm∂eFªquícy
, 
ƒAudioCh™√ls
,

1035 
ªsﬁuti⁄
, 
d a_buf
, 
mime
, 
dëaûID
, 
ext
, 
∑s£d_¨gs
);

1038 
ELGDevi˚
:

1039 if–
Æt_tôÀ
 )

1041 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;resÖrotocolInfo=\"http-get:*:text/srt:*\"&gt;"

1044 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

1045 
	`‰ì
(
Æt_tôÀ
);

1048 
ESamsungSîõsCDE
:

1050 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_SEC_CAPTION_INFO_EX
 )

1052 if–
	`sql_gë_öt_fõld
(
db
, "SELECT ID from CAPTIONS whîêID = '%s'", 
dëaûID
) > 0 )

1054 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;sec:CaptionInfoEx sec:type=\"srt\"&gt;"

1057 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

1064 if–
Æbum_¨t
 && 
	`©oi
(album_art) )

1067 if–*
mime
 ='v' && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_RES
Ë&& !’as£d_¨gs->
Êags
 & 
FLAG_MS_PFS
) ) {

1068 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;resÖrotocolInfo=\"http-get:*:image/jpeg:DLNA.ORG_PN=JPEG_TN\"&gt;"

1071 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
Æbum_¨t
, 
dëaûID
);

1072 } if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ALBUMARTURI
 ) {

1073 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;upnp:albumArtURI");

1074 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ALBUMARTURI_DLNA_PROFILEID
 ) {

1075 
ªt
 = 
	`°rˇtf
(
°r
, " dlna:profileID=\"JPEG_TN\" xmlns:dlna=\"urn:schemas-dlna-org:metadata-1-0/\"");

1077 
ªt
 = 
	`°rˇtf
(
°r
, "&gt;http://%s:%d/AlbumArt/%s-%s.jpg&lt;/upnp:albumArtURI&gt;",

1078 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
Æbum_¨t
, 
dëaûID
);

1081 if–(
∑s£d_¨gs
->
Êags
 & 
FLAG_MS_PFS
Ë&& *
mime
 == 'i' ) {

1082 if–
∑s£d_¨gs
->
˛õ¡
 =
EMedüRoom
 && !
Æbum
 )

1083 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;upnp:album&gt;%s&lt;/upnp:album&gt;", "[No Keywords]");

1086 if–!(
∑s£d_¨gs
->
Êags
 & 
FLAG_RESIZE_THUMBS
Ë&& 
ä
 && 
	`©oi
(tn) ) {

1087 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;upnp:albumArtURI&gt;"

1090 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

1092 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;upnp:albumArtURI&gt;"

1095 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
dëaûID
);

1098 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;/item&gt;");

1100 if–
	`°∫cmp
(
˛ass
, "container", 9) == 0 )

1102 
ªt
 = 
	`°rˇtf
(
°r
, "&…;c⁄èöî id=\"%s\"Ö¨ítID=\"%s\"Ñe°ri˘ed=\"1\" ", 
id
, 
∑ª¡
);

1103 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_SEARCHABLE
 ) {

1104 
ªt
 = 
	`°rˇtf
(
°r
, "searchable=\"1\" ");

1106 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_CHILDCOUNT
 ) {

1107 
chûdªn
;

1108 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêPARENT_ID = '%s';", 
id
);

1109 
chûdªn
 = (
ªt
 > 0) ?Ñet : 0;

1110 
ªt
 = 
	`°rˇtf
(
°r
, "chûdCou¡=\"%d\"", 
chûdªn
);

1113 if–
∑s£d_¨gs
->
ªque°ed
 =1 && 
	`°rcmp
(
id
, "0"Ë=0 && (∑s£d_¨gs->
fûãr
 & 
FILTER_UPNP_SEARCHCLASS
) ) {

1114 
ªt
 = 
	`°rˇtf
(
°r
, "&gt;"

1119 
ªt
 = 
	`°rˇtf
(
°r
, "&gt;"

1122 
tôÀ
, 
˛ass
);

1123 if–(
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_STORAGEUSED
Ë|| 
	`°rcmp
(
˛ass
+10, "storageFolder") == 0 ) {

1125 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:°‹ageU£d&gt;%s&…;/u≤p:°‹ageU£d&gt;", (
size
 ? size : "-1"));

1127 if–
¸ót‹
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_DC_CREATOR
) ) {

1128 
ªt
 = 
	`°rˇtf
(
°r
, "&…;dc:¸ót‹&gt;%s&…;/dc:¸ót‹&gt;", 
¸ót‹
);

1130 if–
gíª
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_GENRE
) ) {

1131 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:gíª&gt;%s&…;/u≤p:gíª&gt;", 
gíª
);

1133 if–
¨ti°
 && (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ARTIST
) ) {

1134 
ªt
 = 
	`°rˇtf
(
°r
, "&…;u≤p:¨ti°&gt;%s&…;/u≤p:¨ti°&gt;", 
¨ti°
);

1136 if–
Æbum_¨t
 && 
	`©oi
◊lbum_¨tË&& (
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ALBUMARTURI
) ) {

1137 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;upnp:albumArtURI ");

1138 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_UPNP_ALBUMARTURI_DLNA_PROFILEID
 ) {

1139 
ªt
 = 
	`°rˇtf
(
°r
, "dlna:profileID=\"JPEG_TN\" xmlns:dlna=\"urn:schemas-dlna-org:metadata-1-0/\"");

1141 
ªt
 = 
	`°rˇtf
(
°r
, "&gt;http://%s:%d/AlbumArt/%s-%s.jpg&lt;/upnp:albumArtURI&gt;",

1142 
œn_addr
[
∑s£d_¨gs
->
iÁ˚
].
°r
, 
ru¡ime_v¨s
.
p‹t
, 
Æbum_¨t
, 
dëaûID
);

1144 if–
∑s£d_¨gs
->
fûãr
 & 
FILTER_AV_MEDIA_CLASS
 ) {

1145 
˛ass
;

1146 if–
	`°∫cmp
(
id
, 
MUSIC_ID
, (MUSIC_ID)) == 0 )

1147 
˛ass
 = 'M';

1148 if–
	`°∫cmp
(
id
, 
VIDEO_ID
, (VIDEO_ID)) == 0 )

1149 
˛ass
 = 'V';

1150 if–
	`°∫cmp
(
id
, 
IMAGE_ID
, (IMAGE_ID)) == 0 )

1151 
˛ass
 = 'P';

1153 
˛ass
 = 0;

1154 if–
˛ass
 )

1155 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;av:mediaClass xmlns:av=\"urn:schemas-sony-com:av\"&gt;"

1156 "%c&…;/av:medüCœss&gt;", 
˛ass
);

1158 
ªt
 = 
	`°rˇtf
(
°r
, "&lt;/container&gt;");

1162 
	}
}

1165 
	$Brow£C⁄ã¡Dúe˘‹y
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

1167 c⁄° 
ª•0
[] =

1172 
CONTENT_DIRECTORY_SCHEMAS
;

1173 *
zEºMsg
 = 
NULL
;

1174 *
sql
, *
±r
;

1175 
Re•⁄£
 
¨gs
;

1176 
°rög_s
 
°r
;

1177 
tŸÆM©ches
;

1178 
ªt
;

1179 *
Obje˘ID
, *
Fûãr
, *
Brow£Fœg
, *
S‹tCrôîü
;

1180 *
‹dîBy
 = 
NULL
;

1181 
NameVÆueP¨£rD©a
 
d©a
;

1182 
Reque°edCou¡
 = 0;

1183 
SèπögIndex
 = 0;

1185 
	`mem£t
(&
¨gs
, 0, (args));

1186 
	`mem£t
(&
°r
, 0, (str));

1188 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 0);

1190 
Obje˘ID
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ObjectID");

1191 
Fûãr
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "Filter");

1192 
Brow£Fœg
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "BrowseFlag");

1193 
S‹tCrôîü
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "SortCriteria");

1195 if–(
±r
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "RequestedCount")) )

1196 
Reque°edCou¡
 = 
	`©oi
(
±r
);

1197 if–
Reque°edCou¡
 < 0 )

1199 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1200 
brow£_îr‹
;

1202 if–!
Reque°edCou¡
 )

1203 
Reque°edCou¡
 = -1;

1204 if–(
±r
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "StartingIndex")) )

1205 
SèπögIndex
 = 
	`©oi
(
±r
);

1206 if–
SèπögIndex
 < 0 )

1208 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1209 
brow£_îr‹
;

1211 if–!
Brow£Fœg
 || (
	`°rcmp
(BrowseFlag, "BrowseDirectChildren") && strcmp(BrowseFlag, "BrowseMetadata")) )

1213 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1214 
brow£_îr‹
;

1216 if–!
Obje˘ID
 && !(Obje˘ID = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ContainerID")) )

1218 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1219 
brow£_îr‹
;

1221 i‡(!
Fûãr
)

1227 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1228 
brow£_îr‹
;

1231 
°r
.
d©a
 = 
	`mÆloc
(
DEFAULT_RESP_SIZE
);

1232 
°r
.
size
 = 
DEFAULT_RESP_SIZE
;

1233 
°r
.
off
 = 
	`•rötf
(°r.
d©a
, "%s", 
ª•0
);

1235 
¨gs
.
iÁ˚
 = 
h
->iface;

1236 
¨gs
.
fûãr
 = 
	`£t_fûãr_Êags
(
Fûãr
, 
h
);

1237 if–
¨gs
.
fûãr
 & 
FILTER_DLNA_NAMESPACE
 )

1238 
ªt
 = 
	`°rˇtf
(&
°r
, 
DLNA_NAMESPACE
);

1239 if–
¨gs
.
fûãr
 & (
FILTER_PV_SUBTITLE_FILE_TYPE
|
FILTER_PV_SUBTITLE_FILE_URI
) )

1240 
ªt
 = 
	`°rˇtf
(&
°r
, 
PV_NAMESPACE
);

1241 
	`°rˇtf
(&
°r
, "&gt;\n");

1243 
¨gs
.
ªq
 = 
h
;

1244 
¨gs
.
ªtu∫ed
 = 0;

1245 
¨gs
.
ªque°ed
 = 
Reque°edCou¡
;

1246 
¨gs
.
˛õ¡
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
ty≥
;

1247 
¨gs
.
Êags
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].flags;

1248 
¨gs
.
°r
 = &str;

1249 if–
¨gs
.
Êags
 & 
FLAG_MS_PFS
 )

1251 if–!
	`°rchr
(
Obje˘ID
, '$'Ë&& (
	`°rcmp
(ObjectID, "0") != 0) )

1253 
±r
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from OBJECTS"

1255 "('"
MUSIC_ID
"$%q', '"
VIDEO_ID
"$%q', '"
IMAGE_ID
"$%q')",

1256 
Obje˘ID
, ObjectID, ObjectID);

1257 if–
±r
 )

1259 
Obje˘ID
 = 
±r
;

1260 
¨gs
.
Êags
 |
FLAG_FREE_OBJECT_ID
;

1264 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Browsing ContentDirectory:\n"

1271 
Obje˘ID
, 
Reque°edCou¡
, 
SèπögIndex
,

1272 
Brow£Fœg
, 
Fûãr
, 
S‹tCrôîü
);

1274 if–
	`°rcmp
(
Obje˘ID
, "0") == 0 )

1276 
¨gs
.
Êags
 |
FLAG_ROOT_CONTAINER
;

1277 if–
ru¡ime_v¨s
.
roŸ_c⁄èöî
 )

1279 if–(
¨gs
.
Êags
 & 
FLAG_AUDIO_ONLY
Ë&& (
	`°rcmp
(
ru¡ime_v¨s
.
roŸ_c⁄èöî
, 
BROWSEDIR_ID
) == 0) )

1280 
Obje˘ID
 = 
MUSIC_DIR_ID
;

1282 
Obje˘ID
 = 
ru¡ime_v¨s
.
roŸ_c⁄èöî
;

1286 if–
¨gs
.
Êags
 & 
FLAG_AUDIO_ONLY
 )

1287 
Obje˘ID
 = 
MUSIC_ID
;

1291 if–
	`°rcmp
(
Brow£Fœg
+6, "Metadata") == 0 )

1293 
¨gs
.
ªque°ed
 = 1;

1294 
sql
 = 
	`sqlôe3_m¥ötf
("SELECT %s, " 
COLUMNS


1297 (
¨gs
.
Êags
 & 
FLAG_ROOT_CONTAINER
) ? "0, -1" : "o.OBJECT_ID, o.PARENT_ID",

1298 
Obje˘ID
);

1299 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
ˇŒback
, (*Ë&
¨gs
, &
zEºMsg
);

1300 
tŸÆM©ches
 = 
¨gs
.
ªtu∫ed
;

1304 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêPARENT_ID = '%q'", 
Obje˘ID
);

1305 
tŸÆM©ches
 = (
ªt
 > 0) ?Ñet : 0;

1306 
ªt
 = 0;

1307 if–
S‹tCrôîü
 )

1309 #ifde‡
__•¨c__


1310 if–
tŸÆM©ches
 < 10000 )

1312 
‹dîBy
 = 
	`∑r£_s‹t_¸ôîü
(
S‹tCrôîü
, &
ªt
);

1316 if–
	`°∫cmp
(
Obje˘ID
, 
MUSIC_PLIST_ID
, 
	`°æí
(MUSIC_PLIST_ID)) == 0 )

1318 if–
	`°rcmp
(
Obje˘ID
, 
MUSIC_PLIST_ID
) == 0 )

1319 
ªt
 = 
	`a•rötf
(&
‹dîBy
, "order by d.TITLE");

1321 
ªt
 = 
	`a•rötf
(&
‹dîBy
, "order byÜength(OBJECT_ID), OBJECT_ID");

1323 if–
¨gs
.
Êags
 & 
FLAG_FORCE_SORT
 )

1325 #ifde‡
__•¨c__


1326 if–
tŸÆM©ches
 < 10000 )

1328 
ªt
 = 
	`a•rötf
(&
‹dîBy
, "order by o.CLASS, d.DISC, d.TRACK, d.TITLE");

1331 
‹dîBy
 = 
	`∑r£_s‹t_¸ôîü
(
S‹tCrôîü
, &
ªt
);

1332 if–
ªt
 == -1 )

1334 
‹dîBy
 = 
NULL
;

1335 
ªt
 = 0;

1339 if–
ªt
 < 0 && ((
¨gs
.
Êags
 & 
FLAG_DLNA
Ë|| 
	`GETFLAG
(
DLNA_STRICT_MASK
)) )

1341 
	`SﬂpEº‹
(
h
, 709, "Unsupported or invalid sort criteria");

1342 
brow£_îr‹
;

1345 
sql
 = 
	`sqlôe3_m¥ötf
–
SELECT_COLUMNS


1348 
Obje˘ID
, 
‹dîBy
, 
SèπögIndex
, 
Reque°edCou¡
);

1349 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Brow£ SQL: %s\n", 
sql
);

1350 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
ˇŒback
, (*Ë&
¨gs
, &
zEºMsg
);

1352 if–(
ªt
 !
SQLITE_OK
Ë&& (
zEºMsg
 !
NULL
) )

1354 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "SQLÉº‹: %s\nBAD SQL: %s\n", 
zEºMsg
, 
sql
);

1355 
	`sqlôe3_‰ì
(
zEºMsg
);

1356 
	`SﬂpEº‹
(
h
, 709, "Unsupported or invalid sort criteria");

1357 
brow£_îr‹
;

1359 
	`sqlôe3_‰ì
(
sql
);

1361 if–!
tŸÆM©ches
 )

1363 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT cou¡(*Ë‰om OBJECTS whîêOBJECT_ID = '%q'", 
Obje˘ID
);

1364 if–
ªt
 <= 0 )

1366 
	`SﬂpEº‹
(
h
, 701, "No such objectÉrror");

1367 
brow£_îr‹
;

1370 
ªt
 = 
	`°rˇtf
(&
°r
, "&lt;/DIDL-Lite&gt;</Result>\n"

1375 
¨gs
.
ªtu∫ed
, 
tŸÆM©ches
, 
upd©eID
);

1376 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
°r
.
d©a
, så.
off
);

1378 
brow£_îr‹
:

1379 
	`CÀ¨NameVÆueLi°
(&
d©a
);

1381 if–
¨gs
.
Êags
 & 
FLAG_FREE_OBJECT_ID
 )

1382 
	`sqlôe3_‰ì
(
Obje˘ID
);

1384 if–
‹dîBy
 )

1385 
	`‰ì
(
‹dîBy
);

1387 if–
°r
.
d©a
 )

1388 
	`‰ì
(
°r
.
d©a
);

1389 
	}
}

1391 
ölöe
 

1392 
	$ch¨ˇt
(
°rög_s
 *
°r
, 
c
)

1394 i‡(
°r
->
size
 <°r->
off
)

1396 
°r
->
d©a
[°r->
size
-1] = '\0';

1399 
°r
->
d©a
[°r->
off
] = 
c
;

1400 
°r
->
off
 += 1;

1401 
	}
}

1403 
ölöe
 *

1404 
	$∑r£_£¨ch_¸ôîü
(c⁄° *
°r
, *
£p
)

1406 
°rög_s
 
¸ôîü
;

1407 
Àn
;

1408 
lôîÆ
 = 0, 
like
 = 0;

1409 c⁄° *
s
;

1411 i‡(!
°r
)

1412  
	`°rdup
("1 = 1");

1414 
Àn
 = 
	`°æí
(
°r
) + 32;

1415 
¸ôîü
.
d©a
 = 
	`mÆloc
(
Àn
);

1416 
¸ôîü
.
size
 = 
Àn
;

1417 
¸ôîü
.
off
 = 0;

1419 
s
 = 
°r
;

1421 
	`is•a˚
(*
s
))

1422 
s
++;

1424 *
s
)

1426 i‡(
lôîÆ
)

1428 *
s
) {

1430 i‡(
	`°∫cmp
(
s
, "&quot;", 6) == 0)

1431 
s
 += 5;

1432 i‡(
	`°∫cmp
(
s
, "&apos;", 6) == 0)

1434 
	`°rˇtf
(&
¸ôîü
, "'");

1435 
s
 += 6;

1441 
lôîÆ
 = 0;

1442 i‡(
like
)

1444 
	`ch¨ˇt
(&
¸ôîü
, '%');

1445 
like
--;

1447 
	`ch¨ˇt
(&
¸ôîü
, '"');

1450 i‡(
	`°∫cmp
(
s
, "\\&quot;", 7) == 0)

1452 
	`°rˇtf
(&
¸ôîü
, "&amp;quot;");

1453 
s
 += 7;

1458 i‡(
	`°∫cmp
(
s
, "object.", 7) == 0)

1459 
s
 += 7;

1460 i‡(
	`°∫cmp
(
s
, "object\"", 7) == 0 ||

1461 
	`°∫cmp
(
s
, "object&quot;", 12) == 0)

1463 
s
 += 6;

1467 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1473 *
s
) {

1475 i‡(
	`°∫cmp
(
s
, "\\&quot;", 7) == 0)

1477 
	`°rˇtf
(&
¸ôîü
, "&amp;quot;");

1478 
s
 += 7;

1482 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1485 
lôîÆ
 = 1;

1486 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1487 i‡(
like
 == 2)

1489 
	`ch¨ˇt
(&
¸ôîü
, '%');

1490 
like
--;

1494 i‡(
	`°∫cmp
(
s
, "&quot;", 6) == 0)

1496 
lôîÆ
 = 1;

1497 
	`°rˇtf
(&
¸ôîü
, "\"");

1498 i‡(
like
 == 2)

1500 
	`ch¨ˇt
(&
¸ôîü
, '%');

1501 
like
--;

1503 
s
 += 5;

1505 i‡(
	`°∫cmp
(
s
, "&apos;", 6) == 0)

1507 
	`°rˇtf
(&
¸ôîü
, "'");

1508 
s
 += 5;

1510 i‡(
	`°∫cmp
(
s
, "&lt;", 4) == 0)

1512 
	`°rˇtf
(&
¸ôîü
, "<");

1513 
s
 += 3;

1515 i‡(
	`°∫cmp
(
s
, "&gt;", 4) == 0)

1517 
	`°rˇtf
(&
¸ôîü
, ">");

1518 
s
 += 3;

1521 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1524 i‡(
	`°∫cmp
(
s
, "@refID", 6) == 0)

1526 
	`°rˇtf
(&
¸ôîü
, "REF_ID");

1527 
s
 += 6;

1530 i‡(
	`°∫cmp
(
s
, "@id", 3) == 0)

1532 
	`°rˇtf
(&
¸ôîü
, "OBJECT_ID");

1533 
s
 += 3;

1536 i‡(
	`°∫cmp
(
s
, "@parentID", 9) == 0)

1538 
	`°rˇtf
(&
¸ôîü
, "PARENT_ID");

1539 
s
 += 9;

1540 
	`°r˝y
(
£p
, "*");

1544 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1547 i‡(
	`°∫cmp
(
s
, "contains", 8) == 0)

1549 
	`°rˇtf
(&
¸ôîü
, "like");

1550 
s
 += 8;

1551 
like
 = 2;

1555 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1558 i‡(
	`°∫cmp
(
s
, "derivedfrom", 11) == 0)

1560 
	`°rˇtf
(&
¸ôîü
, "like");

1561 
s
 += 11;

1562 
like
 = 1;

1565 i‡(
	`°∫cmp
(
s
, "dc:date", 7) == 0)

1567 
	`°rˇtf
(&
¸ôîü
, "d.DATE");

1568 
s
 += 7;

1571 i‡(
	`°∫cmp
(
s
, "dc:title", 8) == 0)

1573 
	`°rˇtf
(&
¸ôîü
, "d.TITLE");

1574 
s
 += 8;

1577 i‡(
	`°∫cmp
(
s
, "dc:creator", 10) == 0)

1579 
	`°rˇtf
(&
¸ôîü
, "d.CREATOR");

1580 
s
 += 10;

1584 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1587 i‡(
	`°∫cmp
(
s
, "exists", 6) == 0)

1589 
s
 += 6;

1590 
	`is•a˚
(*
s
))

1591 
s
++;

1592 i‡(
	`°∫cmp
(
s
, "true", 4) == 0)

1594 
	`°rˇtf
(&
¸ôîü
, "isÇot NULL");

1595 
s
 += 3;

1597 i‡(
	`°∫cmp
(
s
, "false", 5) == 0)

1599 
	`°rˇtf
(&
¸ôîü
, "is NULL");

1600 
s
 += 4;

1604 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1607 i‡(
	`°∫cmp
(
s
, "upnp:class", 10) == 0)

1609 
	`°rˇtf
(&
¸ôîü
, "o.CLASS");

1610 
s
 += 10;

1613 i‡(
	`°∫cmp
(
s
, "upnp:actor", 10) == 0)

1615 
	`°rˇtf
(&
¸ôîü
, "d.ARTIST");

1616 
s
 += 10;

1619 i‡(
	`°∫cmp
(
s
, "upnp:artist", 11) == 0)

1621 
	`°rˇtf
(&
¸ôîü
, "d.ARTIST");

1622 
s
 += 11;

1625 i‡(
	`°∫cmp
(
s
, "upnp:album", 10) == 0)

1627 
	`°rˇtf
(&
¸ôîü
, "d.ALBUM");

1628 
s
 += 10;

1631 i‡(
	`°∫cmp
(
s
, "upnp:genre", 10) == 0)

1633 
	`°rˇtf
(&
¸ôîü
, "d.GENRE");

1634 
s
 += 10;

1638 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1641 i‡(
s
 > 
°r
 && !
	`is•a˚
(s[-1]))

1642 
	`ch¨ˇt
(&
¸ôîü
, ' ');

1643 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1646 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1647 i‡(!
	`is•a˚
(
s
[1]))

1648 
	`ch¨ˇt
(&
¸ôîü
, ' ');

1651 
	`ch¨ˇt
(&
¸ôîü
, *
s
);

1655 
s
++;

1657 
	`ch¨ˇt
(&
¸ôîü
, '\0');

1659  
¸ôîü
.
d©a
;

1660 
	}
}

1663 
	$SórchC⁄ã¡Dúe˘‹y
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

1665 c⁄° 
ª•0
[] =

1670 
CONTENT_DIRECTORY_SCHEMAS
;

1671 *
zEºMsg
 = 
NULL
;

1672 *
sql
, *
±r
;

1673 
Re•⁄£
 
¨gs
;

1674 
°rög_s
 
°r
;

1675 
tŸÆM©ches
;

1676 
ªt
;

1677 *
C⁄èöîID
, *
Fûãr
, *
SórchCrôîü
, *
S‹tCrôîü
;

1678 *
‹dîBy
 = 
NULL
, *
whîe
 = NULL, 
£p
[] = "$*";

1679 
groupBy
[] = "group by DETAIL_ID";

1680 
NameVÆueP¨£rD©a
 
d©a
;

1681 
Reque°edCou¡
 = 0;

1682 
SèπögIndex
 = 0;

1684 
	`mem£t
(&
¨gs
, 0, (args));

1685 
	`mem£t
(&
°r
, 0, (str));

1687 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 0);

1689 
C⁄èöîID
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ContainerID");

1690 
Fûãr
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "Filter");

1691 
SórchCrôîü
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "SearchCriteria");

1692 
S‹tCrôîü
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "SortCriteria");

1694 if–(
±r
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "RequestedCount")) )

1695 
Reque°edCou¡
 = 
	`©oi
(
±r
);

1696 if–!
Reque°edCou¡
 )

1697 
Reque°edCou¡
 = -1;

1698 if–(
±r
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "StartingIndex")) )

1699 
SèπögIndex
 = 
	`©oi
(
±r
);

1700 if–!
C⁄èöîID
 )

1702 if–!(
C⁄èöîID
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ObjectID")) )

1704 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1705 
£¨ch_îr‹
;

1709 
°r
.
d©a
 = 
	`mÆloc
(
DEFAULT_RESP_SIZE
);

1710 
°r
.
size
 = 
DEFAULT_RESP_SIZE
;

1711 
°r
.
off
 = 
	`•rötf
(°r.
d©a
, "%s", 
ª•0
);

1713 
¨gs
.
iÁ˚
 = 
h
->iface;

1714 
¨gs
.
fûãr
 = 
	`£t_fûãr_Êags
(
Fûãr
, 
h
);

1715 if–
¨gs
.
fûãr
 & 
FILTER_DLNA_NAMESPACE
 )

1717 
ªt
 = 
	`°rˇtf
(&
°r
, 
DLNA_NAMESPACE
);

1719 
	`°rˇtf
(&
°r
, "&gt;\n");

1721 
¨gs
.
ªq
 = 
h
;

1722 
¨gs
.
ªtu∫ed
 = 0;

1723 
¨gs
.
ªque°ed
 = 
Reque°edCou¡
;

1724 
¨gs
.
˛õ¡
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].
ty≥
;

1725 
¨gs
.
Êags
 = 
˛õ¡_ty≥s
[
h
->
ªq_˛õ¡
].flags;

1726 
¨gs
.
°r
 = &str;

1727 if–
¨gs
.
Êags
 & 
FLAG_MS_PFS
 )

1729 if–!
	`°rchr
(
C⁄èöîID
, '$'Ë&& (
	`°rcmp
(ContainerID, "0") != 0) )

1731 
±r
 = 
	`sql_gë_ãxt_fõld
(
db
, "SELECT OBJECT_ID from OBJECTS"

1733 "('"
MUSIC_ID
"$%q', '"
VIDEO_ID
"$%q', '"
IMAGE_ID
"$%q')",

1734 
C⁄èöîID
, ContainerID, ContainerID);

1735 if–
±r
 )

1737 
C⁄èöîID
 = 
±r
;

1738 
¨gs
.
Êags
 |
FLAG_FREE_OBJECT_ID
;

1742 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Searching ContentDirectory:\n"

1749 
C⁄èöîID
, 
Reque°edCou¡
, 
SèπögIndex
,

1750 
SórchCrôîü
, 
Fûãr
, 
S‹tCrôîü
);

1752 if–
	`°rcmp
(
C⁄èöîID
, "0") == 0 )

1753 
C⁄èöîID
[0] = '*';

1755 if–
	`°rcmp
(
C⁄èöîID
, 
MUSIC_ALL_ID
) == 0 ||

1756 
	`GETFLAG
(
DLNA_STRICT_MASK
) )

1757 
groupBy
[0] = '\0';

1759 
whîe
 = 
	`∑r£_£¨ch_¸ôîü
(
SórchCrôîü
, 
£p
);

1760 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Tøn¶©ed SórchCrôîü: %s\n", 
whîe
);

1762 
tŸÆM©ches
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT (select count(distinct DETAIL_ID)"

1768 
C⁄èöîID
, 
£p
, 
whîe
, ContainerID, where);

1769 if–
tŸÆM©ches
 < 0 )

1772 
	`SﬂpEº‹
(
h
, 708, "Unsupported or invalid search criteria");

1773 
£¨ch_îr‹
;

1776 if–!
tŸÆM©ches
 )

1778 
ªt
 = 
	`sql_gë_öt_fõld
(
db
, "SELECT count(*) from OBJECTS where OBJECT_ID = '%q'",

1779 !
	`°rcmp
(
C⁄èöîID
, "*")?"0":ContainerID);

1780 if–
ªt
 <= 0 )

1782 
	`SﬂpEº‹
(
h
, 710, "No such container");

1783 
£¨ch_îr‹
;

1786 #ifde‡
__•¨c__


1787 
ªt
 = 0;

1788 if–
tŸÆM©ches
 < 10000 )

1790 
‹dîBy
 = 
	`∑r£_s‹t_¸ôîü
(
S‹tCrôîü
, &
ªt
);

1792 if–
ªt
 < 0 && ((
¨gs
.
Êags
 & 
FLAG_DLNA
Ë|| 
	`GETFLAG
(
DLNA_STRICT_MASK
)) )

1794 
	`SﬂpEº‹
(
h
, 709, "Unsupported or invalid sort criteria");

1795 
£¨ch_îr‹
;

1798 
sql
 = 
	`sqlôe3_m¥ötf
–
SELECT_COLUMNS


1803 
C⁄èöîID
, 
£p
, 
whîe
, 
groupBy
,

1804 (*
C⁄èöîID
 ='*'Ë? 
NULL
 :

1805 
	`sqlôe3_m¥ötf
("UNION ALL " 
SELECT_COLUMNS


1807 " whîêOBJECT_ID = '%q'ánd (%sË", 
C⁄èöîID
, 
whîe
),

1808 
‹dîBy
, 
SèπögIndex
, 
Reque°edCou¡
);

1809 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "Sórch SQL: %s\n", 
sql
);

1810 
ªt
 = 
	`sqlôe3_exec
(
db
, 
sql
, 
ˇŒback
, (*Ë&
¨gs
, &
zEºMsg
);

1811 if–(
ªt
 !
SQLITE_OK
Ë&& (
zEºMsg
 !
NULL
) )

1813 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "SQLÉº‹: %s\nBAD SQL: %s\n", 
zEºMsg
, 
sql
);

1814 
	`sqlôe3_‰ì
(
zEºMsg
);

1816 
	`sqlôe3_‰ì
(
sql
);

1817 
ªt
 = 
	`°rˇtf
(&
°r
, "&lt;/DIDL-Lite&gt;</Result>\n"

1822 
¨gs
.
ªtu∫ed
, 
tŸÆM©ches
, 
upd©eID
);

1823 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
°r
.
d©a
, så.
off
);

1824 
£¨ch_îr‹
:

1825 
	`CÀ¨NameVÆueLi°
(&
d©a
);

1826 if–
¨gs
.
Êags
 & 
FLAG_FREE_OBJECT_ID
 )

1827 
	`sqlôe3_‰ì
(
C⁄èöîID
);

1828 
	`‰ì
(
‹dîBy
);

1829 
	`‰ì
(
whîe
);

1830 
	`‰ì
(
°r
.
d©a
);

1831 
	}
}

1842 
	$QuîySèãV¨übÀ
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

1844 c⁄° 
ª•
[] =

1850 
body
[512];

1851 
NameVÆueP¨£rD©a
 
d©a
;

1852 c⁄° * 
v¨_«me
;

1854 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 0);

1857 
v¨_«me
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "varName");

1859 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "QuîySèãV¨übÀ(%.40s)\n", 
v¨_«me
);

1861 if(!
v¨_«me
)

1863 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1865 if(
	`°rcmp
(
v¨_«me
, "ConnectionStatus") == 0)

1867 
bodyÀn
;

1868 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
,

1869 
a˘i⁄
, "urn:schemas-upnp-org:control-1-0",

1870 "C⁄√˘ed", 
a˘i⁄
);

1871 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
body
, 
bodyÀn
);

1875 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "%s: Unknown: %s\n", 
a˘i⁄
, 
v¨_«me
?var_name:"");

1876 
	`SﬂpEº‹
(
h
, 404, "Invalid Var");

1879 
	`CÀ¨NameVÆueLi°
(&
d©a
);

1880 
	}
}

1883 
	$SamsungGëFótuªLi°
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

1885 c⁄° 
ª•
[] =

1900 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
ª•
, (resp)-1);

1901 
	}
}

1904 
	$SamsungSëBookm¨k
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
)

1906 c⁄° 
ª•
[] =

1911 
NameVÆueP¨£rD©a
 
d©a
;

1912 *
Obje˘ID
, *
PosSec⁄d
;

1914 
	`P¨£NameVÆue
(
h
->
ªq_buf
 + h->
ªq_c⁄ã¡off
, h->
ªq_c⁄ã¡Àn
, &
d©a
, 0);

1915 
Obje˘ID
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "ObjectID");

1916 
PosSec⁄d
 = 
	`GëVÆueFromNameVÆueLi°
(&
d©a
, "PosSecond");

1917 if–
Obje˘ID
 && 
PosSec⁄d
 )

1919 
ªt
;

1920 
ªt
 = 
	`sql_exec
(
db
, "INSERT OR REPLACE into BOOKMARKS"

1922 "((£À˘ DETAIL_ID from OBJECTS whîêOBJECT_ID = '%q'), %q)", 
Obje˘ID
, 
PosSec⁄d
);

1923 if–
ªt
 !
SQLITE_OK
 )

1924 
	`DPRINTF
(
E_WARN
, 
L_METADATA
, "Eº‹ sëtög bookm¨k %†⁄ Obje˘ID='%s'\n", 
PosSec⁄d
, 
Obje˘ID
);

1925 
	`BuûdSídAndClo£SﬂpRe•
(
h
, 
ª•
, (resp)-1);

1928 
	`SﬂpEº‹
(
h
, 402, "Invalid Args");

1930 
	`CÀ¨NameVÆueLi°
(&
d©a
);

1931 
	}
}

1935 c⁄° * 
	mmëhodName
;

1936 (*
	mmëhodIm∂
)(
	mu≤phâp
 *, const *);

1938 
	gsﬂpMëhods
[] =

1940 { "QuîySèãV¨übÀ", 
QuîySèãV¨übÀ
},

1941 { "Brow£", 
Brow£C⁄ã¡Dúe˘‹y
},

1942 { "Sórch", 
SórchC⁄ã¡Dúe˘‹y
},

1943 { "GëSórchC≠abûôõs", 
GëSórchC≠abûôõs
},

1944 { "GëS‹tC≠abûôõs", 
GëS‹tC≠abûôõs
},

1945 { "GëSy°emUpd©eID", 
GëSy°emUpd©eID
},

1946 { "GëPrŸocﬁInfo", 
GëPrŸocﬁInfo
},

1947 { "GëCuºítC⁄√˘i⁄IDs", 
GëCuºítC⁄√˘i⁄IDs
},

1948 { "GëCuºítC⁄√˘i⁄Info", 
GëCuºítC⁄√˘i⁄Info
},

1949 { "IsAuth‹ized", 
IsAuth‹izedVÆid©ed
},

1950 { "IsVÆid©ed", 
IsAuth‹izedVÆid©ed
},

1951 { "Regi°îDevi˚", 
Regi°îDevi˚
},

1952 { "X_GëFótuªLi°", 
SamsungGëFótuªLi°
},

1953 { "X_SëBookm¨k", 
SamsungSëBookm¨k
},

1958 
	$ExecuãSﬂpA˘i⁄
(
u≤phâp
 * 
h
, c⁄° * 
a˘i⁄
, 
n
)

1960 * 
p
;

1962 
p
 = 
	`°rchr
(
a˘i⁄
, '#');

1963 if(
p
)

1965 
i
 = 0;

1966 
Àn
;

1967 
mëhodÀn
;

1968 * 
p2
;

1969 
p
++;

1970 
p2
 = 
	`°rchr
(
p
, '"');

1971 if(
p2
)

1972 
mëhodÀn
 = 
p2
 - 
p
;

1974 
mëhodÀn
 = 
n
 - (
p
 - 
a˘i⁄
);

1975 
	`DPRINTF
(
E_DEBUG
, 
L_HTTP
, "SﬂpMëhod: %.*s\n", 
mëhodÀn
, 
p
);

1976 
sﬂpMëhods
[
i
].
mëhodName
)

1978 
Àn
 = 
	`°æí
(
sﬂpMëhods
[
i
].
mëhodName
);

1979 if(
	`°∫cmp
(
p
, 
sﬂpMëhods
[
i
].
mëhodName
, 
Àn
) == 0)

1981 
sﬂpMëhods
[
i
].
	`mëhodIm∂
(
h
, sﬂpMëhods[i].
mëhodName
);

1984 
i
++;

1987 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "SﬂpMëhod: Unknown: %.*s\n", 
mëhodÀn
, 
p
);

1990 
	`SﬂpEº‹
(
h
, 401, "Invalid Action");

1991 
	}
}

2012 
	$SﬂpEº‹
(
u≤phâp
 * 
h
, 
îrCode
, c⁄° * 
îrDesc
)

2014 c⁄° 
ª•
[] =

2032 
body
[2048];

2033 
bodyÀn
;

2035 
	`DPRINTF
(
E_WARN
, 
L_HTTP
, "Rëu∫ög UPnPEº‹ %d: %s\n", 
îrCode
, 
îrDesc
);

2036 
bodyÀn
 = 
	`¢¥ötf
(
body
, (body), 
ª•
, 
îrCode
, 
îrDesc
);

2037 
	`BuûdRe•2_u≤phâp
(
h
, 500, "I¡î«»Sîvî Eº‹", 
body
, 
bodyÀn
);

2038 
	`SídRe•_u≤phâp
(
h
);

2039 
	`Clo£Sockë_u≤phâp
(
h
);

2040 
	}
}

	@upnpsoap.h

21 #i‚de‡
__UPNPSOAP_H__


22 
	#__UPNPSOAP_H__


	)

24 
	#DEFAULT_RESP_SIZE
 131072

	)

25 
	#MAX_RESPONSE_SIZE
 2097152

	)

27 
	#CONTENT_DIRECTORY_SCHEMAS
 \

30 " xm s=\"u∫:schemas-u≤p-‹g:mëad©a-1-0/DIDL-Lôe/\""

	)

31 
	#DLNA_NAMESPACE
 \

32 " xm s:d a=\"u∫:schemas-d a-‹g:mëad©a-1-0/\""

	)

33 
	#PV_NAMESPACE
 \

34 " xm s:pv=\"hâp://www.pv.com/pvns/\""

	)

36 
	#FLAG_FREE_OBJECT_ID
 0x40000000

	)

37 
	#FLAG_ROOT_CONTAINER
 0x80000000

	)

39 
	sRe•⁄£


41 
u≤phâp
 *
	mªq
;

42 
°rög_s
 *
	m°r
;

43 
	m°¨t
;

44 
	mªtu∫ed
;

45 
	mªque°ed
;

46 
	miÁ˚
;

47 
uöt32_t
 
	mfûãr
;

48 
uöt32_t
 
	mÊags
;

49 
˛õ¡_ty≥s
 
	m˛õ¡
;

55 
ExecuãSﬂpA˘i⁄
(
u≤phâp
 *, const *, );

61 
SﬂpEº‹
(
u≤phâp
 * 
h
, 
îrCode
, c⁄° * 
îrDesc
);

	@utils.c

18 
	~"c⁄fig.h
"

20 
	~<°dio.h
>

21 
	~<˘y≥.h
>

22 
	~<°rög.h
>

23 
	~<°dlib.h
>

24 
	~<sys/∑øm.h
>

25 
	~<sys/°©.h
>

26 
	~<uni°d.h
>

27 
	~<sys/ty≥s.h
>

28 
	~<sys/°©.h
>

29 
	~<f˙é.h
>

30 
	~<î∫o.h
>

32 
	~"möid ©y≥s.h
"

33 
	~"u≤pglobÆv¨s.h
"

34 
	~"log.h
"

36 
ölöe
 

37 
	$°rˇtf
(
°rög_s
 *
°r
, c⁄° *
fmt
, ...)

39 
ªt
;

40 
size
;

41 
va_li°
 
≠
;

43 i‡(
°r
->
off
 >°r->
size
)

46 
	`va_°¨t
(
≠
, 
fmt
);

47 
size
 = 
°r
->sizê- så->
off
;

48 
ªt
 = 
	`v¢¥ötf
(
°r
->
d©a
 + så->
off
, 
size
, 
fmt
, 
≠
);

49 
°r
->
off
 +
	`MIN
(
ªt
, 
size
);

50 
	`va_íd
(
≠
);

52  
ªt
;

53 
	}
}

55 
ölöe
 

56 
	$°∫˝yt
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
)

58 
	`°∫˝y
(
d°
, 
§c
, 
Àn
);

59 
d°
[
Àn
-1] = '\0';

60 
	}
}

62 
ölöe
 

63 
	$xa•rötf
(**
°Ω
, *
fmt
, ...)

65 
va_li°
 
¨gs
;

66 
ªt
;

68 
	`va_°¨t
(
¨gs
, 
fmt
);

69 
ªt
 = 
	`va•rötf
(
°Ω
, 
fmt
, 
¨gs
);

70 
	`va_íd
(
¨gs
);

71 if–
ªt
 < 0 )

73 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "xasprintf:állocation failed\n");

74 *
°Ω
 = 
NULL
;

76  
ªt
;

77 
	}
}

80 
	$íds_wôh
(c⁄° * 
hay°ack
, c⁄° * 
√edÀ
)

82 c⁄° * 
íd
;

83 
∆í
 = 
	`°æí
(
√edÀ
);

84 
hÀn
 = 
	`°æí
(
hay°ack
);

86 if–
∆í
 > 
hÀn
 )

88 
íd
 = 
hay°ack
 + 
hÀn
 - 
∆í
;

90  (
	`°rˇ£cmp
(
íd
, 
√edÀ
) ? 0 : 1);

91 
	}
}

94 
	$åim
(*
°r
)

96 
i
;

97 
Àn
;

99 i‡(!
°r
)

100 (
NULL
);

102 
Àn
 = 
	`°æí
(
°r
);

103 
i
=
Àn
-1; i >0 && 
	`is•a˚
(
°r
[i]); i--)

105 
°r
[
i
] = '\0';

106 
Àn
--;

108 
	`is•a˚
(*
°r
))

110 
°r
++;

111 
Àn
--;

114 i‡(
°r
[0] ='"' && så[
Àn
-1] == '"')

116 
°r
[0] = '\0';

117 
°r
[
Àn
-1] = '\0';

118 
°r
++;

121  
°r
;

122 
	}
}

126 
	$°r°rc
(c⁄° *
s
, c⁄° *
p
, c⁄° 
t
)

128 *
íd±r
;

129 
size_t
 
¶í
, 
∂í
;

131 
íd±r
 = 
	`°rchr
(
s
, 
t
);

132 i‡(!
íd±r
)

133  
	`°r°r
(
s
, 
p
);

135 
∂í
 = 
	`°æí
(
p
);

136 
¶í
 = 
íd±r
 - 
s
;

137 
¶í
 >
∂í
)

139 i‡(*
s
 =*
p
 && 
	`°∫cmp
(s+1,Ö+1, 
∂í
-1) == 0)

140  (*)
s
;

141 
s
++;

142 
¶í
--;

145  
NULL
;

146 
	}
}

149 
	$°rˇ£°rc
(c⁄° *
s
, c⁄° *
p
, c⁄° 
t
)

151 *
íd±r
;

152 
size_t
 
¶í
, 
∂í
;

154 
íd±r
 = 
	`°rchr
(
s
, 
t
);

155 i‡(!
íd±r
)

156  
	`°rˇ£°r
(
s
, 
p
);

158 
∂í
 = 
	`°æí
(
p
);

159 
¶í
 = 
íd±r
 - 
s
;

160 
¶í
 >
∂í
)

162 i‡(*
s
 =*
p
 && 
	`°∫ˇ£cmp
(s+1,Ö+1, 
∂í
-1) == 0)

163  (*)
s
;

164 
s
++;

165 
¶í
--;

168  
NULL
;

169 
	}
}

172 
	$modifySåög
(* 
°rög
, c⁄° * 
bef‹e
, c⁄° * 
a·î
)

174 
ﬁdÀn
, 
√wÀn
, 
chg˙t
 = 0;

175 *
s
, *
p
;

177 
ﬁdÀn
 = 
	`°æí
(
bef‹e
);

178 
√wÀn
 = 
	`°æí
(
a·î
);

179 if–
√wÀn
 > 
ﬁdÀn
 )

181 
s
 = 
°rög
;

182  (
p
 = 
	`°r°r
(
s
, 
bef‹e
)) )

184 
chg˙t
++;

185 
s
 = 
p
+
ﬁdÀn
;

187 
s
 = 
	`ªÆloc
(
°rög
, 
	`°æí
(°rög)+((
√wÀn
-
ﬁdÀn
)*
chg˙t
)+1);

189 if–
s
 )

190 
°rög
 = 
s
;

192  
°rög
;

195 
s
 = 
°rög
;

196  
s
 )

198 
p
 = 
	`°rˇ£°r
(
s
, 
bef‹e
);

199 if–!
p
 )

200  
°rög
;

201 
	`memmove
(
p
 + 
√wÀn
,Ö + 
ﬁdÀn
, 
	`°æí
(p + oldlen) + 1);

202 
	`mem˝y
(
p
, 
a·î
, 
√wÀn
);

203 
s
 = 
p
 + 
√wÀn
;

206  
°rög
;

207 
	}
}

210 
	$u√sˇ≥_èg
(c⁄° *
èg
, 
f‹˚_Æloc
)

212 *
esc_èg
 = 
NULL
;

214 if–
	`°r°r
(
èg
, "&amp;") || strstr(tag, "&lt;") || strstr(tag, "&gt;")

215 || 
	`°r°r
(
èg
, "&quot;") )

217 
esc_èg
 = 
	`°rdup
(
èg
);

218 
esc_èg
 = 
	`modifySåög
(esc_tag, "&amp;", "&");

219 
esc_èg
 = 
	`modifySåög
(esc_tag, "&lt;", "<");

220 
esc_èg
 = 
	`modifySåög
(esc_tag, "&gt;", ">");

221 
esc_èg
 = 
	`modifySåög
(esc_tag, "&quot;", "\"");

223 if–
f‹˚_Æloc
 )

224 
esc_èg
 = 
	`°rdup
(
èg
);

226  
esc_èg
;

227 
	}
}

230 
	$esˇ≥_èg
(c⁄° *
èg
, 
f‹˚_Æloc
)

232 *
esc_èg
 = 
NULL
;

234 if–
	`°rchr
(
èg
, '&') || strchr(tag, '<') || strchr(tag, '>') || strchr(tag, '"') )

236 
esc_èg
 = 
	`°rdup
(
èg
);

237 
esc_èg
 = 
	`modifySåög
(esc_tag, "&", "&amp;amp;");

238 
esc_èg
 = 
	`modifySåög
(esc_tag, "<", "&amp;lt;");

239 
esc_èg
 = 
	`modifySåög
(esc_tag, ">", "&amp;gt;");

240 
esc_èg
 = 
	`modifySåög
(esc_tag, "\"", "&amp;quot;");

242 if–
f‹˚_Æloc
 )

243 
esc_èg
 = 
	`°rdup
(
èg
);

245  
esc_èg
;

246 
	}
}

249 
	$°rù_ext
(* 
«me
)

251 * 
≥riod
;

253 
≥riod
 = 
	`°ºchr
(
«me
, '.');

254 if–
≥riod
 )

255 *
≥riod
 = '\0';

256 
	}
}

260 
	$make_dú
(* 
∑th
, 
mode_t
 
mode
)

262 * 
s
 = 
∑th
;

263 
c
;

264 
°©
 
°
;

267 
c
 = '\0';

271 *
s
 == '/')

272 ++
s
;

275 *
s
) {

276 i‡(*
s
 == '/') {

278 ++
s
;

279 } *
s
 == '/');

280 
c
 = *
s
;

281 *
s
 = '\0';

284 ++
s
;

287 i‡(
	`mkdú
(
∑th
, 
mode
) < 0) {

290 i‡((
î∫o
 !
EEXIST
 &&Éºnÿ!
EISDIR
)

291 || (
	`°©
(
∑th
, &
°
Ë< 0 || !
	`S_ISDIR
(°.
°_mode
))) {

292 
	`DPRINTF
(
E_WARN
, 
L_GENERAL
, "make_dú: c™nŸ cª©êdúe˘‹y '%s'\n", 
∑th
);

293 i‡(
c
)

294 *
s
 = 
c
;

298 i‡(!
c
)

302 *
s
 = 
c
;

305 
	}
}

309 
	$DJBHash
(c⁄° *
°r
, 
Àn
)

311 
hash
 = 5381;

312 
i
 = 0;

314 
i
 = 0; i < 
Àn
; 
°r
++, i++)

316 
hash
 = ((hash << 5Ë+ hashË+ (*
°r
);

319  
hash
;

320 
	}
}

323 
	$mime_to_ext
(c⁄° * 
mime
)

325  *
mime
 )

329 if–
	`°rcmp
(
mime
+6, "mpeg") == 0 )

331 if–
	`°rcmp
(
mime
+6, "mp4") == 0 )

333 if–
	`°rcmp
(
mime
+6, "x-ms-wma") == 0 )

335 if–
	`°rcmp
(
mime
+6, "x-flac") == 0 )

337 if–
	`°rcmp
(
mime
+6, "flac") == 0 )

339 if–
	`°rcmp
(
mime
+6, "x-wav") == 0 )

341 if–
	`°∫cmp
(
mime
+6, "L16", 3) == 0 )

343 if–
	`°rcmp
(
mime
+6, "3gpp") == 0 )

345 if–
	`°rcmp
(
mime
, "application/ogg") == 0 )

349 if–
	`°rcmp
(
mime
+6, "avi") == 0 )

351 if–
	`°rcmp
(
mime
+6, "divx") == 0 )

353 if–
	`°rcmp
(
mime
+6, "x-msvideo") == 0 )

355 if–
	`°rcmp
(
mime
+6, "mpeg") == 0 )

357 if–
	`°rcmp
(
mime
+6, "mp4") == 0 )

359 if–
	`°rcmp
(
mime
+6, "x-ms-wmv") == 0 )

361 if–
	`°rcmp
(
mime
+6, "x-matroska") == 0 )

363 if–
	`°rcmp
(
mime
+6, "x-mkv") == 0 )

365 if–
	`°rcmp
(
mime
+6, "x-flv") == 0 )

367 if–
	`°rcmp
(
mime
+6, "vnd.dlna.mpeg-tts") == 0 )

369 if–
	`°rcmp
(
mime
+6, "quicktime") == 0 )

371 if–
	`°rcmp
(
mime
+6, "3gpp") == 0 )

373 if–
	`°rcmp
(
mime
+6, "x-rmvb") == 0 )

375 if–
	`°∫cmp
(
mime
+6, "x-tivo-mpeg", 11) == 0 )

379 if–
	`°rcmp
(
mime
+6, "jpeg") == 0 )

381 if–
	`°rcmp
(
mime
+6, "png") == 0 )

383 if–
	`°rcmp
(
mime
+6, "gif") == 0 )

385 if–
	`°rcmp
(
mime
+6, "tif") == 0 )

387 if–
	`°rcmp
(
mime
+6, "bmp") == 0 )

394 
	}
}

397 
	$is_video
(c⁄° * 
fûe
)

399  (
	`íds_wôh
(
fûe
, ".mpg") ||Énds_with(file, ".mpeg") ||

400 
	`íds_wôh
(
fûe
, ".avi") ||Énds_with(file, ".divx") ||

401 
	`íds_wôh
(
fûe
, ".asf") ||Énds_with(file, ".wmv") ||

402 
	`íds_wôh
(
fûe
, ".mp4") ||Énds_with(file, ".m4v") ||

403 
	`íds_wôh
(
fûe
, ".mts") ||Énds_with(file, ".m2ts") ||

404 
	`íds_wôh
(
fûe
, ".m2t") ||Énds_with(file, ".mkv") ||

405 
	`íds_wôh
(
fûe
, ".vob") ||Énds_with(file, ".ts") ||

406 
	`íds_wôh
(
fûe
, ".flv") ||Énds_with(file, ".xvid") ||

407 #ifde‡
TIVO_SUPPORT


408 
	`íds_wôh
(
fûe
, ".TiVo") ||

410 
	`íds_wôh
(
fûe
, ".mov") ||Énds_with(file, ".3gp") ||

411 
	`íds_wôh
(
fûe
, ".rmvb") ||Énds_with(file,".rm"));

412 
	}
}

415 
	$is_audio
(c⁄° * 
fûe
)

417  (
	`íds_wôh
(
fûe
, ".mp3") ||Énds_with(file, ".flac") ||

418 
	`íds_wôh
(
fûe
, ".wma") ||Énds_with(file, ".asf") ||

419 
	`íds_wôh
(
fûe
, ".fla") ||Énds_with(file, ".flc") ||

420 
	`íds_wôh
(
fûe
, ".m4a") ||Énds_with(file, ".aac") ||

421 
	`íds_wôh
(
fûe
, ".mp4") ||Énds_with(file, ".m4p") ||

422 
	`íds_wôh
(
fûe
, ".wav") ||Énds_with(file, ".ogg") ||

423 
	`íds_wôh
(
fûe
, ".pcm") ||Énds_with(file, ".3gp"));

424 
	}
}

427 
	$is_image
(c⁄° * 
fûe
)

429  (
	`íds_wôh
(
fûe
, ".jpg") ||Énds_with(file, ".jpeg") ||

430 
	`íds_wôh
(
fûe
, ".png") ||Énds_with(file, ".bmp") ||

431 
	`íds_wôh
(
fûe
, ".gif") ||Énds_with(file, ".tiff") ||

432 
	`íds_wôh
(
fûe
, ".tif"));

433 
	}
}

436 
	$is_∂ayli°
(c⁄° * 
fûe
)

438  (
	`íds_wôh
(
fûe
, ".m3u") ||Énds_with(file, ".pls"));

439 
	}
}

442 
	$is_Æbum_¨t
(c⁄° * 
«me
)

444 
Æbum_¨t_«me_s
 * 
Æbum_¨t_«me
;

447  
Æbum_¨t_«me
 = 
Æbum_¨t_«mes
;álbum_¨t_«me;álbum_¨t_«mêÆbum_¨t_«me->
√xt
 )

449 if–
Æbum_¨t_«me
->
wûdˇrd
 )

451 if–
	`°∫cmp
(
Æbum_¨t_«me
->
«me
,Çame, 
	`°æí
(album_art_name->name)) == 0 )

456 if–
	`°rcmp
(
Æbum_¨t_«me
->
«me
,Çame) == 0 )

461  (
Æbum_¨t_«me
 ? 1 : 0);

462 
	}
}

465 
	$ªsﬁve_unknown_ty≥
(c⁄° * 
∑th
, 
medü_ty≥s
 
dú_ty≥
)

467 
°©
 
íåy
;

468 
ty≥
 = 
TYPE_UNKNOWN
;

469 
°r_buf
[
PATH_MAX
];

470 
ssize_t
 
Àn
;

472 if–
	`l°©
(
∑th
, &
íåy
) == 0 )

474 if–
	`S_ISLNK
(
íåy
.
°_mode
) )

476 if–(
Àn
 = 
	`ªadlök
(
∑th
, 
°r_buf
, 
PATH_MAX
-1)) > 0 )

478 
°r_buf
[
Àn
] = '\0';

480 if–
	`°∫cmp
(
∑th
, 
°r_buf
, 
	`°æí
(str_buf)) == 0 )

482 
	`DPRINTF
(
E_DEBUG
, 
L_GENERAL
, "Ign‹ögÑecursivêsymbﬁi¯lök: %†(%s)\n", 
∑th
, 
°r_buf
);

483  
ty≥
;

486 
	`°©
(
∑th
, &
íåy
);

489 if–
	`S_ISDIR
(
íåy
.
°_mode
) )

491 
ty≥
 = 
TYPE_DIR
;

493 if–
	`S_ISREG
(
íåy
.
°_mode
) )

495  
dú_ty≥
 )

497 
ALL_MEDIA
:

498 if–
	`is_image
(
∑th
) ||

499 
	`is_audio
(
∑th
) ||

500 
	`is_video
(
∑th
) ||

501 
	`is_∂ayli°
(
∑th
) )

502 
ty≥
 = 
TYPE_FILE
;

504 
TYPE_AUDIO
:

505 if–
	`is_audio
(
∑th
) ||

506 
	`is_∂ayli°
(
∑th
) )

507 
ty≥
 = 
TYPE_FILE
;

509 
TYPE_VIDEO
:

510 if–
	`is_video
(
∑th
) )

511 
ty≥
 = 
TYPE_FILE
;

513 
TYPE_IMAGES
:

514 if–
	`is_image
(
∑th
) )

515 
ty≥
 = 
TYPE_FILE
;

522  
ty≥
;

523 
	}
}

	@utils.h

24 #i‚de‡
__UTILS_H__


25 
	#__UTILS_H__


	)

27 
	~"möid ©y≥s.h
"

30 
°rˇtf
(
°rög_s
 *
°r
, *
fmt
, ...);

31 
°∫˝yt
(*
d°
, c⁄° *
§c
, 
size_t
 
Àn
);

32 
ölöe
 
xa•rötf
(**
°Ω
, *
fmt
, ...);

33 
íds_wôh
(c⁄° * 
hay°ack
, c⁄° * 
√edÀ
);

34 *
åim
(*
°r
);

35 *
°r°rc
(c⁄° *
s
, c⁄° *
p
, c⁄° 
t
);

36 *
°rˇ£°rc
(c⁄° *
s
, c⁄° *
p
, c⁄° 
t
);

37 *
modifySåög
(* 
°rög
, c⁄° * 
bef‹e
, c⁄° * 
a·î
);

38 *
esˇ≥_èg
(c⁄° *
èg
, 
f‹˚_Æloc
);

39 *
u√sˇ≥_èg
(c⁄° *
èg
, 
f‹˚_Æloc
);

40 
°rù_ext
(* 
«me
);

43 
is_video
(c⁄° * 
fûe
);

44 
is_audio
(c⁄° * 
fûe
);

45 
is_image
(c⁄° * 
fûe
);

46 
is_∂ayli°
(c⁄° * 
fûe
);

47 
is_Æbum_¨t
(c⁄° * 
«me
);

48 
ªsﬁve_unknown_ty≥
(c⁄° * 
∑th
, 
medü_ty≥s
 
dú_ty≥
);

49 c⁄° *
mime_to_ext
(c⁄° * 
mime
);

52 
make_dú
(* 
∑th
, 
mode_t
 
mode
);

53 
DJBHash
(c⁄° *
°r
, 
Àn
);

	@uuid.c

26 
	~"c⁄fig.h
"

27 
	~<°dio.h
>

28 
	~<°dlib.h
>

29 
	~<time.h
>

30 
	~<f˙é.h
>

31 
	~<uni°d.h
>

32 
	~<°rög.h
>

33 
	~<sys/io˘l.h
>

34 
	~<sys/time.h
>

35 
	~<î∫o.h
>

36 #i‡
HAVE_MACH_MACH_TIME_H


37 
	~<mach/mach_time.h
>

38 #ñi‡
HAVE_CLOCK_GETTIME_SYSCALL


39 
	~<sys/sysˇŒ.h
>

42 
	~"uuid.h
"

43 
	~"gëiÁddr.h
"

44 
	~"log.h
"

46 
uöt32_t
 
	g˛ock_£q
;

47 c⁄° 
uöt32_t
 
	g˛ock_£q_max
 = 0x3fff;

48 
	g˛ock_£q_öôülized
;

50 #i‚de‡
CLOCK_MONOTONIC


51 
	#CLOCK_MONOTONIC
 
CLOCK_REALTIME


	)

55 
	$m⁄Ÿ⁄ic_us
()

57 
time•ec
 
ts
;

59 #i‡
HAVE_CLOCK_GETTIME


60 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ts
);

61 #ñi‡
HAVE_CLOCK_GETTIME_SYSCALL


62 
	`sysˇŒ
(
__NR_˛ock_gëtime
, 
CLOCK_MONOTONIC
, &
ts
);

63 #ñi‡
HAVE_MACH_MACH_TIME_H


64  
	`mach_absﬁuã_time
();

66 
timevÆ
 
tv
;

67 
	`gëtimeofday
(&
tv
, 0);

68 
	`TIMEVAL_TO_TIMESPEC
(&
tv
, &
ts
);

70  
ts
.
tv_£c
 * 1000000ULL +Ås.
tv_n£c
 / 1000;

71 
	}
}

74 
	$ªad_boŸid_node
(*
buf
, 
size_t
 
size
)

76 
FILE
 *
boŸ_id
;

78 if(
size
 != 6)

81 
boŸ_id
 = 
	`f›í
("/proc/sys/kernel/random/boot_id", "r");

82 if(!
boŸ_id
)

84 if((
	`f£ek
(
boŸ_id
, 24, 
SEEK_SET
) < 0) ||

85 (
	`fsˇnf
(
boŸ_id
, "%02hhx%02hhx%02hhx%02hhx%02hhx%02hhx",

86 &
buf
[0], &buf[1], &buf[2], &buf[3], &buf[4], &buf[5]) != 6))

88 
	`f˛o£
(
boŸ_id
);

92 
	`f˛o£
(
boŸ_id
);

94 
	}
}

97 
	$ªad_øndom_byãs
(*
buf
, 
size_t
 
size
)

99 
i
;

100 
pid_t
 
pid
;

102 
i
 = 
	`›í
("/dev/uøndom", 
O_RDONLY
);

103 if(
i
 >= 0)

105 if(
	`ªad
(
i
, 
buf
, 
size
));

106 
	`˛o£
(
i
);

111 
	`§™d
(
	`m⁄Ÿ⁄ic_us
());

112 
pid
 = 
	`gëpid
();

115 
i
 = 0; i < 
size
; i++)

116 
buf
[
i
] ^
	`ønd
() >> 5;

117 if(
pid
 == 0)

119 
	`§™d
(
pid
);

120 
pid
 = 0;

122 
	}
}

125 
	$öô_˛ock£q
()

127 
buf
[4];

129 
	`ªad_øndom_byãs
(
buf
, 4);

130 
	`mem˝y
(&
˛ock_£q
, &
buf
, (clock_seq));

131 
˛ock_£q
 &
˛ock_£q_max
;

132 
˛ock_£q_öôülized
 = 1;

133 
	}
}

136 
	$gíî©e_uuid
(
uuid_out
[16])

138 
uöt64_t
 
œ°_time_Æl
;

139 
˛ock_£q_°¨ãd
;

140 
œ°_node
[6] = { 0, 0, 0, 0, 0, 0 };

142 
time•ec
 
ts
;

143 
uöt64_t
 
time_Æl
;

144 
öc_˛ock_£q
 = 0;

146 
mac
[6];

147 
mac_îr‹
;

149 
	`mem£t
(&
mac
, '\0', (mac));

152 
mac_îr‹
 = 
	`gësyshwaddr
((*)
mac
, (mac));

154 if(!
mac_îr‹
)

156 
	`mem˝y
(&
uuid_out
[10], 
mac
, 
ETH_ALEN
);

161 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "CouldÇot find MAC. Use bootid'sÇodeID.\n");

162 if–
	`ªad_boŸid_node
(&
uuid_out
[10], 6) != 0)

164 
	`DPRINTF
(
E_INFO
, 
L_HTTP
, "bootidÇodeÇot successfullyÑead.\n");

165 
	`ªad_øndom_byãs
(&
uuid_out
[10], 6);

169 if(
	`memcmp
(
œ°_node
, 
uuid_out
+10, 6) != 0)

171 
öc_˛ock_£q
 = 1;

172 
	`mem˝y
(
œ°_node
, 
uuid_out
+10, 6);

180 #i‡
HAVE_CLOCK_GETTIME


181 
	`˛ock_gëtime
(
CLOCK_REALTIME
, &
ts
);

182 #ñi‡
HAVE_CLOCK_GETTIME_SYSCALL


183 
	`sysˇŒ
(
__NR_˛ock_gëtime
, 
CLOCK_REALTIME
, &
ts
);

185 
timevÆ
 
tv
;

186 
	`gëtimeofday
(&
tv
, 0);

187 
	`TIMEVAL_TO_TIMESPEC
(&
tv
, &
ts
);

189 
time_Æl
 = ((
uöt64_t
)
ts
.
tv_£c
Ë* (
NSEC_PER_SEC
 / 100);

190 
time_Æl
 +
ts
.
tv_n£c
 / 100;

193 
time_Æl
 +12219292800000ULL * (
NSEC_PER_MSEC
 / 100);

194 
time_Æl
 &= 0x0fffffffffffffffULL;

197 if(!
˛ock_£q_öôülized
)

199 
	`öô_˛ock£q
();

200 
˛ock_£q_°¨ãd
 = 
˛ock_£q
;

204 if(
öc_˛ock_£q
 || 
time_Æl
 <
œ°_time_Æl
)

206 
˛ock_£q
 = (˛ock_£q + 1Ë& 
˛ock_£q_max
;

207 if(
˛ock_£q
 =
˛ock_£q_°¨ãd
)

209 
˛ock_£q
 = (˛ock_£q - 1Ë& 
˛ock_£q_max
;

213 
˛ock_£q_°¨ãd
 = 
˛ock_£q
;

215 
œ°_time_Æl
 = 
time_Æl
;

218 
uuid_out
[3] = (
uöt8_t
)
time_Æl
;

219 
uuid_out
[2] = (
uöt8_t
)(
time_Æl
 >> 8);

220 
uuid_out
[1] = (
uöt8_t
)(
time_Æl
 >> 16);

221 
uuid_out
[0] = (
uöt8_t
)(
time_Æl
 >> 24);

222 
uuid_out
[5] = (
uöt8_t
)(
time_Æl
 >> 32);

223 
uuid_out
[4] = (
uöt8_t
)(
time_Æl
 >> 40);

224 
uuid_out
[7] = (
uöt8_t
)(
time_Æl
 >> 48);

225 
uuid_out
[6] = (
uöt8_t
)(
time_Æl
 >> 56);

227 
uuid_out
[8] = 
˛ock_£q
 >> 8;

228 
uuid_out
[9] = 
˛ock_£q
 & 0xff;

231 
uuid_out
[6] = (uuid_out[6] & 0x0F) | 0x10;

233 
uuid_out
[8] = (uuid_out[8] & 0x3F) | 0x80;

236 
	}
}

241 
	$gë_uuid_°rög
(*
buf
)

243 
uuid
[16];

245 if–
	`gíî©e_uuid
(
uuid
) != 0 )

248 
	`•rötf
(
buf
, "%02x%02x%02x%02x-%02x%02x-%02x%02x-%02x%02x-%02x%02x%02x%02x%02x%02x",

249 
uuid
[0], uuid[1], uuid[2], uuid[3], uuid[4], uuid[5], uuid[6], uuid[7], uuid[8],

250 
uuid
[9], uuid[10], uuid[11], uuid[12], uuid[13], uuid[14], uuid[15]);

251 
buf
[36] = '\0';

254 
	}
}

	@uuid.h

24 #i‚de‡
__UUID_H__


25 
	#__UUID_H__


	)

27 
	#ETH_ALEN
 6

	)

28 #i‚de‡
NSEC_PER_SEC


29 
	#NSEC_PER_SEC
 1000000000L

	)

31 #i‚de‡
NSEC_PER_MSEC


32 
	#NSEC_PER_MSEC
 1000000L

	)

36 
gë_uuid_°rög
(*
buf
);

	@
1
.
0
86
1261
albumart.c
albumart.h
clients.c
clients.h
codelength.h
getifaddr.c
getifaddr.h
icons.c
image_utils.c
image_utils.h
inotify.c
inotify.h
libav.h
linux/inotify-syscalls.h
linux/inotify.h
log.c
log.h
metadata.c
metadata.h
minidlna.c
minidlna.h
minidlnapath.h
minidlnatypes.h
minissdp.c
minissdp.h
minixml.c
minixml.h
options.c
options.h
playlist.c
playlist.h
process.c
process.h
scanner.c
scanner.h
scanner_sqlite.h
sendfile.h
sql.c
sql.h
tagutils/misc.c
tagutils/misc.h
tagutils/tagutils-aac.c
tagutils/tagutils-aac.h
tagutils/tagutils-asf.c
tagutils/tagutils-asf.h
tagutils/tagutils-flc.c
tagutils/tagutils-flc.h
tagutils/tagutils-misc.c
tagutils/tagutils-mp3.c
tagutils/tagutils-mp3.h
tagutils/tagutils-ogg.c
tagutils/tagutils-ogg.h
tagutils/tagutils-pcm.c
tagutils/tagutils-pcm.h
tagutils/tagutils-plist.c
tagutils/tagutils-wav.c
tagutils/tagutils-wav.h
tagutils/tagutils.c
tagutils/tagutils.h
tagutils/textutils.c
tagutils/textutils.h
testupnpdescgen.c
tivo_beacon.c
tivo_beacon.h
tivo_commands.c
tivo_commands.h
tivo_utils.c
tivo_utils.h
ubus.c
upnpdescgen.c
upnpdescgen.h
upnpdescstrings.h
upnpevents.c
upnpevents.h
upnpglobalvars.c
upnpglobalvars.h
upnphttp.c
upnphttp.h
upnpreplyparse.c
upnpreplyparse.h
upnpsoap.c
upnpsoap.h
utils.c
utils.h
uuid.c
uuid.h
